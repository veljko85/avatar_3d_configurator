(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();class Er{constructor(){this.rootNodes=new Array,this.cameras=new Array,this.lights=new Array,this.meshes=new Array,this.skeletons=new Array,this.particleSystems=new Array,this.animations=[],this.animationGroups=new Array,this.multiMaterials=new Array,this.materials=new Array,this.morphTargetManagers=new Array,this.geometries=new Array,this.transformNodes=new Array,this.actionManagers=new Array,this.textures=new Array,this._environmentTexture=null,this.postProcesses=new Array}static AddParser(e,t){this._BabylonFileParsers[e]=t}static GetParser(e){return this._BabylonFileParsers[e]?this._BabylonFileParsers[e]:null}static AddIndividualParser(e,t){this._IndividualBabylonFileParsers[e]=t}static GetIndividualParser(e){return this._IndividualBabylonFileParsers[e]?this._IndividualBabylonFileParsers[e]:null}static Parse(e,t,i,r){for(const s in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,s)&&this._BabylonFileParsers[s](e,t,i,r)}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=new Array;return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(t=>e=e.concat(t.bones)),e}}Er._BabylonFileParsers={};Er._IndividualBabylonFileParsers={};class jn{constructor(){this.hoverCursor="",this.actions=new Array,this.isRecursive=!1}static get HasTriggers(){for(const e in jn.Triggers)if(Object.prototype.hasOwnProperty.call(jn.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(const e in jn.Triggers)if(Object.prototype.hasOwnProperty.call(jn.Triggers,e)){const t=parseInt(e);if(t>=1&&t<=7)return!0}return!1}static HasSpecificTrigger(e){for(const t in jn.Triggers)if(Object.prototype.hasOwnProperty.call(jn.Triggers,t)&&parseInt(t)===e)return!0;return!1}}jn.Triggers={};class $x{constructor(e,t=!1,i,r){this.initialize(e,t,i,r)}initialize(e,t=!1,i,r){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=r,this}}class hb{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1}}class Q{static FromPromise(e,t){const i=new Q;return e.then(r=>{i.notifyObservers(r)}).catch(r=>{if(t)t.notifyObservers(r);else throw r}),i}get observers(){return this._observers}constructor(e){this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._eventState=new $x(0),e&&(this._onObserverAdded=e)}add(e,t=-1,i=!1,r=null,s=!1){if(!e)return null;const n=new hb(e,t,r);return n.unregisterOnNextCall=s,i?this._observers.unshift(n):this._observers.push(n),this._onObserverAdded&&this._onObserverAdded(n),n}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return e&&this._observers.indexOf(e)!==-1?(this._deferUnregister(e),!0):!1}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){const r=this._observers[i];if(!r._willBeUnregistered&&r.callback===e&&(!t||t===r.scope))return this._deferUnregister(r),!0}return!1}_deferUnregister(e){this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(()=>{this._remove(e)},0)}_remove(e,t=!0){if(!e)return!1;const i=this._observers.indexOf(e);return i!==-1?(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(i,1),!0):!1}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,i,r,s){if(!this._observers.length)return!0;const n=this._eventState;n.mask=t,n.target=i,n.currentTarget=r,n.skipNextObservers=!1,n.lastReturnValue=e,n.userInfo=s;for(const a of this._observers)if(!a._willBeUnregistered&&(a.mask&t&&(a.unregisterOnNextCall&&this._deferUnregister(a),a.scope?n.lastReturnValue=a.callback.apply(a.scope,[e,n]):n.lastReturnValue=a.callback(e,n)),n.skipNextObservers))return!1;return!0}notifyObserver(e,t,i=-1){if(e._willBeUnregistered)return;const r=this._eventState;r.mask=i,r.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,r)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){this._observers=new Array,this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0}clone(){const e=new Q;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}class Ee{static WithinEpsilon(e,t,i=1401298e-51){return Math.abs(e-t)<=i}static ToHex(e){const t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()}static Sign(e){return e=+e,e===0||isNaN(e)?e:e>0?1:-1}static Clamp(e,t=0,i=1){return Math.min(i,Math.max(t,e))}static Log2(e){return Math.log(e)*Math.LOG2E}static ILog2(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(e===0)return-1/0;let t=0;if(e<1){for(;e<1;)t++,e=e*2;t=-t}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t}static Repeat(e,t){return e-Math.floor(e/t)*t}static Normalize(e,t,i){return(e-t)/(i-t)}static Denormalize(e,t,i){return e*(i-t)+t}static DeltaAngle(e,t){let i=Ee.Repeat(t-e,360);return i>180&&(i-=360),i}static PingPong(e,t){const i=Ee.Repeat(e,t*2);return t-Math.abs(i-t)}static SmoothStep(e,t,i){let r=Ee.Clamp(i);return r=-2*r*r*r+3*r*r,t*r+e*(1-r)}static MoveTowards(e,t,i){let r=0;return Math.abs(t-e)<=i?r=t:r=e+Ee.Sign(t-e)*i,r}static MoveTowardsAngle(e,t,i){const r=Ee.DeltaAngle(e,t);let s=0;return-i<r&&r<i?s=t:(t=e+r,s=Ee.MoveTowards(e,t,i)),s}static Lerp(e,t,i){return e+(t-e)*i}static LerpAngle(e,t,i){let r=Ee.Repeat(t-e,360);return r>180&&(r-=360),e+r*Ee.Clamp(i)}static InverseLerp(e,t,i){let r=0;return e!=t?r=Ee.Clamp((i-e)/(t-e)):r=0,r}static Hermite(e,t,i,r,s){const n=s*s,a=s*n,l=2*a-3*n+1,c=-2*a+3*n,h=a-2*n+s,u=a-n;return e*l+i*c+t*h+r*u}static Hermite1stDerivative(e,t,i,r,s){const n=s*s;return(n-s)*6*e+(3*n-4*s+1)*t+(-n+s)*6*i+(3*n-2*s)*r}static RandomRange(e,t){return e===t?e:Math.random()*(t-e)+e}static RangeToPercent(e,t,i){return(e-t)/(i-t)}static PercentToRange(e,t,i){return(i-t)*e+t}static NormalizeRadians(e){return e-=Ee.TwoPi*Math.floor((e+Math.PI)/Ee.TwoPi),e}static HCF(e,t){const i=e%t;return i===0?t:Ee.HCF(t,i)}}Ee.TwoPi=Math.PI*2;const mo=1/2.2,Ho=2.2,Fr=(1+Math.sqrt(5))/2,kt=.001;class Br{static BuildArray(e,t){const i=[];for(let r=0;r<e;++r)i.push(t());return i}static BuildTuple(e,t){return Br.BuildArray(e,t)}}function ub(o,e,t){const i=o[e];if(typeof i!="function")return null;const r=function(){const s=o.length,n=r.previous.apply(o,arguments);return t(e,s),n};return i.next=r,r.previous=i,o[e]=r,()=>{const s=r.previous;if(!s)return;const n=r.next;n?(s.next=n,n.previous=s):(s.next=void 0,o[e]=s),r.next=void 0,r.previous=void 0}}const db=["push","splice","pop","shift","unshift"];function Yx(o,e){const t=db.map(i=>ub(o,i,e));return()=>{t.forEach(i=>{i==null||i()})}}const jx={};function ye(o,e){jx[o]=e}function Xr(o){return jx[o]}class ms{static SetMatrixPrecision(e){if(ms.MatrixTrackPrecisionChange=!1,e&&!ms.MatrixUse64Bits&&ms.MatrixTrackedMatrices)for(let t=0;t<ms.MatrixTrackedMatrices.length;++t){const i=ms.MatrixTrackedMatrices[t],r=i._m;i._m=new Array(16);for(let s=0;s<16;++s)i._m[s]=r[s]}ms.MatrixUse64Bits=e,ms.MatrixCurrentType=ms.MatrixUse64Bits?Array:Float32Array,ms.MatrixTrackedMatrices=null}}ms.MatrixUse64Bits=!1;ms.MatrixTrackPrecisionChange=!0;ms.MatrixCurrentType=Float32Array;ms.MatrixTrackedMatrices=[];class qe{static get LastCreatedEngine(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}qe.Instances=new Array;qe._LastCreatedScene=null;qe.UseFallbackTexture=!0;qe.FallbackTexture="";const On=o=>parseInt(o.toString().replace(/\W/g,""));class Ie{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){const e=On(this.x),t=On(this.y);let i=e;return i=i*397^t,i}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return Ie.FromArrayToRef(e,t,this),this}asArray(){const e=new Array;return this.toArray(e,0),e}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}add(e){return new this.constructor(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addVector3(e){return new this.constructor(this.x+e.x,this.y+e.y)}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new this.constructor(this.x*e,this.y*t)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.divideToRef(e,this)}negate(){return new this.constructor(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.copyFromFloats(this.x*-1,this.y*-1)}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){const t=new this.constructor(0,0);return this.scaleToRef(e,t),t}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=kt){return e&&Ee.WithinEpsilon(this.x,e.x,t)&&Ee.WithinEpsilon(this.y,e.y,t)}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}rotateToRef(e,t){const i=Math.cos(e),r=Math.sin(e);return t.x=i*this.x-r*this.y,t.y=r*this.x+i*this.y,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return Ie.NormalizeToRef(this,this),this}clone(){return new this.constructor(this.x,this.y)}static Zero(){return new Ie(0,0)}static One(){return new Ie(1,1)}static Random(e=0,t=1){return new Ie(Ee.RandomRange(e,t),Ee.RandomRange(e,t))}static get ZeroReadOnly(){return Ie._ZeroReadOnly}static FromArray(e,t=0){return new Ie(e[t],e[t+1])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i}static CatmullRom(e,t,i,r,s){const n=s*s,a=s*n,l=.5*(2*t.x+(-e.x+i.x)*s+(2*e.x-5*t.x+4*i.x-r.x)*n+(-e.x+3*t.x-3*i.x+r.x)*a),c=.5*(2*t.y+(-e.y+i.y)*s+(2*e.y-5*t.y+4*i.y-r.y)*n+(-e.y+3*t.y-3*i.y+r.y)*a);return new e.constructor(l,c)}static Clamp(e,t,i){let r=e.x;r=r>i.x?i.x:r,r=r<t.x?t.x:r;let s=e.y;return s=s>i.y?i.y:s,s=s<t.y?t.y:s,new e.constructor(r,s)}static Hermite(e,t,i,r,s){const n=s*s,a=s*n,l=2*a-3*n+1,c=-2*a+3*n,h=a-2*n+s,u=a-n,d=e.x*l+i.x*c+t.x*h+r.x*u,f=e.y*l+i.y*c+t.y*h+r.y*u;return new e.constructor(d,f)}static Hermite1stDerivative(e,t,i,r,s){const n=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const a=s*s;return n.x=(a-s)*6*e.x+(3*a-4*s+1)*t.x+(-a+s)*6*i.x+(3*a-2*s)*r.x,n.y=(a-s)*6*e.y+(3*a-4*s+1)*t.y+(-a+s)*6*i.y+(3*a-2*s)*r.y,n}static Lerp(e,t,i){const r=e.x+(t.x-e.x)*i,s=e.y+(t.y-e.y)*i;return new e.constructor(r,s)}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){const t=new e.constructor;return this.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){const i=e.length();return i===0||(t.x=e.x/i,t.y=e.y/i),t}static Minimize(e,t){const i=e.x<t.x?e.x:t.x,r=e.y<t.y?e.y:t.y;return new e.constructor(i,r)}static Maximize(e,t){const i=e.x>t.x?e.x:t.x,r=e.y>t.y?e.y:t.y;return new e.constructor(i,r)}static Transform(e,t){const i=new e.constructor;return Ie.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){const r=t.m,s=e.x*r[0]+e.y*r[4]+r[12],n=e.x*r[1]+e.y*r[5]+r[13];return i.x=s,i.y=n,i}static PointInTriangle(e,t,i,r){const s=.5*(-i.y*r.x+t.y*(-i.x+r.x)+t.x*(i.y-r.y)+i.x*r.y),n=s<0?-1:1,a=(t.y*r.x-t.x*r.y+(r.y-t.y)*e.x+(t.x-r.x)*e.y)*n,l=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*n;return a>0&&l>0&&a+l<2*s*n}static Distance(e,t){return Math.sqrt(Ie.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,r=e.y-t.y;return i*i+r*r}static Center(e,t){const i=new e.constructor;return Ie.CenterToRef(e,t,i)}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,i){const r=Ie.DistanceSquared(t,i);if(r===0)return Ie.Distance(e,t);const s=i.subtract(t),n=Math.max(0,Math.min(1,Ie.Dot(e.subtract(t),s)/r)),a=t.add(s.multiplyByFloats(n,n));return Ie.Distance(e,a)}}Ie._ZeroReadOnly=Ie.Zero();class x{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,t=0,i=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){const e=On(this._x),t=On(this._y),i=On(this._z);let r=e;return r=r*397^t,r=r*397^i,r}asArray(){const e=[];return this.toArray(e,0),e}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return x.FromArrayToRef(e,t,this),this}toQuaternion(){return oe.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this.addInPlaceFromFloats(e._x,e._y,e._z)}addInPlaceFromFloats(e,t,i){return this._x+=e,this._y+=t,this._z+=i,this._isDirty=!0,this}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,i){return new this.constructor(this._x-e,this._y-t,this._z-i)}subtractFromFloatsToRef(e,t,i,r){return r.copyFromFloats(this._x-e,this._y-t,this._z-i)}negate(){return new this.constructor(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e.copyFromFloats(this._x*-1,this._y*-1,this._z*-1)}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t.copyFromFloats(this._x*e,this._y*e,this._z*e)}getNormalToRef(e){const t=this.length();let i=Math.acos(this.y/t);const r=Math.atan2(this.z,this.x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;const s=t*Math.sin(i)*Math.cos(r),n=t*Math.cos(i),a=t*Math.sin(i)*Math.sin(r);return e.set(s,n,a),e}applyRotationQuaternionToRef(e,t){const i=e._w*this._x+e._y*this._z-e._z*this._y,r=e._w*this._y+e._z*this._x-e._x*this._z,s=e._w*this._z+e._x*this._y-e._y*this._x,n=-e._x*this._x-e._y*this._y-e._z*this._z;return t._x=i*e._w+n*-e._x+r*-e._z-s*-e._y,t._y=r*e._w+n*-e._y+s*-e._x-i*-e._z,t._z=s*e._w+n*-e._z+i*-e._y-r*-e._x,t._isDirty=!0,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new this.constructor)}scaleAndAddToRef(e,t){return t.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)}projectOnPlane(e,t){const i=new this.constructor;return this.projectOnPlaneToRef(e,t,i),i}projectOnPlaneToRef(e,t,i){const r=e.normal,s=e.d,n=dt.Vector3[0];this.subtractToRef(t,n),n.normalize();const a=x.Dot(n,r);if(Math.abs(a)<Math.pow(10,-10))i.setAll(1/0);else{const l=-(x.Dot(t,r)+s)/a,c=n.scaleInPlace(l);t.addToRef(c,i)}return i}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=kt){return e&&Ee.WithinEpsilon(this._x,e._x,t)&&Ee.WithinEpsilon(this._y,e._y,t)&&Ee.WithinEpsilon(this._z,e._z,t)}equalsToFloats(e,t,i){return this._x===e&&this._y===t&&this._z===i}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)}multiplyByFloats(e,t,i){return new this.constructor(this._x*e,this._y*t,this._z*i)}divide(e){return new this.constructor(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(e){const t=Math.abs(this._x),i=Math.abs(this._y);if(!Ee.WithinEpsilon(t,i,e))return!0;const r=Math.abs(this._z);return!Ee.WithinEpsilon(t,r,e)||!Ee.WithinEpsilon(i,r,e)}get isNonUniform(){const e=Math.abs(this._x),t=Math.abs(this._y);if(e!==t)return!0;const i=Math.abs(this._z);return e!==i}floor(){return new this.constructor(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}fract(){return new this.constructor(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z===0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){return e=e.toLowerCase(),e==="xyz"?this:(dt.Vector3[0].copyFrom(this),["x","y","z"].forEach((t,i)=>{this[t]=dt.Vector3[0][e[i]]}),this)}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(dt.Matrix[0]),x.TransformCoordinatesToRef(this,dt.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,i){return this.subtractToRef(t,dt.Vector3[0]),dt.Vector3[0].rotateByQuaternionToRef(e,dt.Vector3[0]),t.addToRef(dt.Vector3[0],i),i}cross(e){const t=new this.constructor;return x.CrossToRef(this,e,t)}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return t===0||t===1?e.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/t,e)}clone(){return new this.constructor(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,i){return this._x=e,this._y=t,this._z=i,this._isDirty=!0,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(e,t,i,r){const s=x.Dot(e,i)-r,n=x.Dot(t,i)-r;return s/(s-n)}static GetAngleBetweenVectors(e,t,i){const r=e.normalizeToRef(dt.Vector3[1]),s=t.normalizeToRef(dt.Vector3[2]);let n=x.Dot(r,s);n=Ee.Clamp(n,-1,1);const a=Math.acos(n),l=dt.Vector3[3];return x.CrossToRef(r,s,l),x.Dot(l,i)>0?isNaN(a)?0:a:isNaN(a)?-Math.PI:-Math.acos(n)}static GetAngleBetweenVectorsOnPlane(e,t,i){dt.Vector3[0].copyFrom(e);const r=dt.Vector3[0];dt.Vector3[1].copyFrom(t);const s=dt.Vector3[1];dt.Vector3[2].copyFrom(i);const n=dt.Vector3[2],a=dt.Vector3[3],l=dt.Vector3[4];r.normalize(),s.normalize(),n.normalize(),x.CrossToRef(n,r,a),x.CrossToRef(a,n,l);const c=Math.atan2(x.Dot(s,a),x.Dot(s,l));return Ee.NormalizeRadians(c)}static PitchYawRollToMoveBetweenPointsToRef(e,t,i){const r=j.Vector3[0];return t.subtractToRef(e,r),i._y=Math.atan2(r.x,r.z)||0,i._x=Math.atan2(Math.sqrt(r.x**2+r.z**2),r.y)||0,i._z=0,i._isDirty=!0,i}static PitchYawRollToMoveBetweenPoints(e,t){const i=x.Zero();return x.PitchYawRollToMoveBetweenPointsToRef(e,t,i)}static SlerpToRef(e,t,i,r){i=Ee.Clamp(i,0,1);const s=dt.Vector3[0],n=dt.Vector3[1];s.copyFrom(e);const a=s.length();s.normalizeFromLength(a),n.copyFrom(t);const l=n.length();n.normalizeFromLength(l);const c=x.Dot(s,n);let h,u;if(c<1-kt){const d=Math.acos(c),f=1/Math.sin(d);h=Math.sin((1-i)*d)*f,u=Math.sin(i*d)*f}else h=1-i,u=i;return s.scaleInPlace(h),n.scaleInPlace(u),r.copyFrom(s).addInPlace(n),r.scaleInPlace(Ee.Lerp(a,l,i)),r}static SmoothToRef(e,t,i,r,s){return x.SlerpToRef(e,t,r===0?1:i/r,s),s}static FromArray(e,t=0){return new x(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return x.FromArray(e,t)}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._isDirty=!0,i}static FromFloatArrayToRef(e,t,i){return x.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,r){return r.copyFromFloats(e,t,i),r}static Zero(){return new x(0,0,0)}static One(){return new x(1,1,1)}static Up(){return new x(0,1,0)}static get UpReadOnly(){return x._UpReadOnly}static get DownReadOnly(){return x._DownReadOnly}static get RightReadOnly(){return x._RightReadOnly}static get LeftReadOnly(){return x._LeftReadOnly}static get LeftHandedForwardReadOnly(){return x._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return x._RightHandedForwardReadOnly}static get ZeroReadOnly(){return x._ZeroReadOnly}static Down(){return new x(0,-1,0)}static Forward(e=!1){return new x(0,0,e?-1:1)}static Backward(e=!1){return new x(0,0,e?1:-1)}static Right(){return new x(1,0,0)}static Left(){return new x(-1,0,0)}static Random(e=0,t=1){return new x(Ee.RandomRange(e,t),Ee.RandomRange(e,t),Ee.RandomRange(e,t))}static TransformCoordinates(e,t){const i=x.Zero();return x.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return x.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,r,s){const n=r.m,a=e*n[0]+t*n[4]+i*n[8]+n[12],l=e*n[1]+t*n[5]+i*n[9]+n[13],c=e*n[2]+t*n[6]+i*n[10]+n[14],h=1/(e*n[3]+t*n[7]+i*n[11]+n[15]);return s._x=a*h,s._y=l*h,s._z=c*h,s._isDirty=!0,s}static TransformNormal(e,t){const i=x.Zero();return x.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformNormalFromFloatsToRef(e,t,i,r,s){const n=r.m;return s._x=e*n[0]+t*n[4]+i*n[8],s._y=e*n[1]+t*n[5]+i*n[9],s._z=e*n[2]+t*n[6]+i*n[10],s._isDirty=!0,s}static CatmullRom(e,t,i,r,s){const n=s*s,a=s*n,l=.5*(2*t._x+(-e._x+i._x)*s+(2*e._x-5*t._x+4*i._x-r._x)*n+(-e._x+3*t._x-3*i._x+r._x)*a),c=.5*(2*t._y+(-e._y+i._y)*s+(2*e._y-5*t._y+4*i._y-r._y)*n+(-e._y+3*t._y-3*i._y+r._y)*a),h=.5*(2*t._z+(-e._z+i._z)*s+(2*e._z-5*t._z+4*i._z-r._z)*n+(-e._z+3*t._z-3*i._z+r._z)*a);return new e.constructor(l,c,h)}static Clamp(e,t,i){const r=new e.constructor;return x.ClampToRef(e,t,i,r),r}static ClampToRef(e,t,i,r){let s=e._x;s=s>i._x?i._x:s,s=s<t._x?t._x:s;let n=e._y;n=n>i._y?i._y:n,n=n<t._y?t._y:n;let a=e._z;return a=a>i._z?i._z:a,a=a<t._z?t._z:a,r.copyFromFloats(s,n,a),r}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static Hermite(e,t,i,r,s){const n=s*s,a=s*n,l=2*a-3*n+1,c=-2*a+3*n,h=a-2*n+s,u=a-n,d=e._x*l+i._x*c+t._x*h+r._x*u,f=e._y*l+i._y*c+t._y*h+r._y*u,_=e._z*l+i._z*c+t._z*h+r._z*u;return new e.constructor(d,f,_)}static Hermite1stDerivative(e,t,i,r,s){const n=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const a=s*s;return n._x=(a-s)*6*e._x+(3*a-4*s+1)*t._x+(-a+s)*6*i._x+(3*a-2*s)*r._x,n._y=(a-s)*6*e._y+(3*a-4*s+1)*t._y+(-a+s)*6*i._y+(3*a-2*s)*r._y,n._z=(a-s)*6*e._z+(3*a-4*s+1)*t._z+(-a+s)*6*i._z+(3*a-2*s)*r._z,n._isDirty=!0,n}static Lerp(e,t,i){const r=new e.constructor(0,0,0);return x.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){return r._x=e._x+(t._x-e._x)*i,r._y=e._y+(t._y-e._y)*i,r._z=e._z+(t._z-e._z)*i,r._isDirty=!0,r}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}static Cross(e,t){const i=new e.constructor;return x.CrossToRef(e,t,i),i}static CrossToRef(e,t,i){const r=e._y*t._z-e._z*t._y,s=e._z*t._x-e._x*t._z,n=e._x*t._y-e._y*t._x;return i.copyFromFloats(r,s,n),i}static Normalize(e){const t=x.Zero();return x.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(e,t,i,r){const s=new e.constructor;return x.ProjectToRef(e,t,i,r,s),s}static ProjectToRef(e,t,i,r,s){const n=r.width,a=r.height,l=r.x,c=r.y,h=dt.Matrix[1];H.FromValuesToRef(n/2,0,0,0,0,-a/2,0,0,0,0,.5,0,l+n/2,a/2+c,.5,1,h);const u=dt.Matrix[0];return t.multiplyToRef(i,u),u.multiplyToRef(h,u),x.TransformCoordinatesToRef(e,u,s),s}static Reflect(e,t){return this.ReflectToRef(e,t,new x)}static ReflectToRef(e,t,i){const r=j.Vector3[0];return r.copyFrom(t).scaleInPlace(2*x.Dot(e,t)),i.copyFrom(e).subtractInPlace(r)}static _UnprojectFromInvertedMatrixToRef(e,t,i){x.TransformCoordinatesToRef(e,t,i);const r=t.m,s=e._x*r[3]+e._y*r[7]+e._z*r[11]+r[15];return Ee.WithinEpsilon(s,1)&&i.scaleInPlace(1/s),i}static UnprojectFromTransform(e,t,i,r,s){return this.Unproject(e,t,i,r,s,H.IdentityReadOnly)}static Unproject(e,t,i,r,s,n){const a=new e.constructor;return x.UnprojectToRef(e,t,i,r,s,n,a),a}static UnprojectToRef(e,t,i,r,s,n,a){return x.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,r,s,n,a),a}static UnprojectFloatsToRef(e,t,i,r,s,n,a,l,c){var h;const u=dt.Matrix[0];n.multiplyToRef(a,u),u.multiplyToRef(l,u),u.invert();const d=dt.Vector3[0];return d.x=e/r*2-1,d.y=-(t/s*2-1),!((h=qe.LastCreatedEngine)===null||h===void 0)&&h.isNDCHalfZRange?d.z=i:d.z=2*i-1,x._UnprojectFromInvertedMatrixToRef(d,u,c),c}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(x.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e._x-t._x,r=e._y-t._y,s=e._z-t._z;return i*i+r*r+s*s}static ProjectOnTriangleToRef(e,t,i,r,s){const n=dt.Vector3[0],a=dt.Vector3[1],l=dt.Vector3[2],c=dt.Vector3[3],h=dt.Vector3[4];i.subtractToRef(t,n),r.subtractToRef(t,a),r.subtractToRef(i,l);const u=n.length(),d=a.length(),f=l.length();if(u<kt||d<kt||f<kt)return s.copyFrom(t),x.Distance(e,t);e.subtractToRef(t,h),x.CrossToRef(n,a,c);const _=c.length();if(_<kt)return s.copyFrom(t),x.Distance(e,t);c.normalizeFromLength(_);let p=h.length();if(p<kt)return s.copyFrom(t),0;h.normalizeFromLength(p);const m=x.Dot(c,h),T=dt.Vector3[5],b=dt.Vector3[6];T.copyFrom(c).scaleInPlace(-p*m),b.copyFrom(e).addInPlace(T);const y=dt.Vector3[4],S=dt.Vector3[5],C=dt.Vector3[7],I=dt.Vector3[8];y.copyFrom(n).scaleInPlace(1/u),I.copyFrom(a).scaleInPlace(1/d),y.addInPlace(I).scaleInPlace(-1),S.copyFrom(n).scaleInPlace(-1/u),I.copyFrom(l).scaleInPlace(1/f),S.addInPlace(I).scaleInPlace(-1),C.copyFrom(l).scaleInPlace(-1/f),I.copyFrom(a).scaleInPlace(-1/d),C.addInPlace(I).scaleInPlace(-1);const P=dt.Vector3[9];let D;P.copyFrom(b).subtractInPlace(t),x.CrossToRef(y,P,I),D=x.Dot(I,c);const w=D;P.copyFrom(b).subtractInPlace(i),x.CrossToRef(S,P,I),D=x.Dot(I,c);const L=D;P.copyFrom(b).subtractInPlace(r),x.CrossToRef(C,P,I),D=x.Dot(I,c);const U=D,G=dt.Vector3[10];let Z,he;w>0&&L<0?(G.copyFrom(n),Z=t,he=i):L>0&&U<0?(G.copyFrom(l),Z=i,he=r):(G.copyFrom(a).scaleInPlace(-1),Z=r,he=t);const _e=dt.Vector3[9],ne=dt.Vector3[4];if(Z.subtractToRef(b,I),he.subtractToRef(b,_e),x.CrossToRef(I,_e,ne),!(x.Dot(ne,c)<0))return s.copyFrom(b),Math.abs(p*m);const Se=dt.Vector3[5];x.CrossToRef(G,ne,Se),Se.normalize();const ce=dt.Vector3[9];ce.copyFrom(Z).subtractInPlace(b);const de=ce.length();if(de<kt)return s.copyFrom(Z),x.Distance(e,Z);ce.normalizeFromLength(de);const k=x.Dot(Se,ce),se=dt.Vector3[7];se.copyFrom(b).addInPlace(Se.scaleInPlace(de*k)),I.copyFrom(se).subtractInPlace(Z),p=G.length(),G.normalizeFromLength(p);let xe=x.Dot(I,G)/Math.max(p,kt);return xe=Ee.Clamp(xe,0,1),se.copyFrom(Z).addInPlace(G.scaleInPlace(xe*p)),s.copyFrom(se),x.Distance(e,se)}static Center(e,t){return x.CenterToRef(e,t,x.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,i){const r=new e.constructor;return x.RotationFromAxisToRef(e,t,i,r),r}static RotationFromAxisToRef(e,t,i,r){const s=dt.Quaternion[0];return oe.RotationQuaternionFromAxisToRef(e,t,i,s),s.toEulerAnglesToRef(r),r}}x._UpReadOnly=x.Up();x._DownReadOnly=x.Down();x._LeftHandedForwardReadOnly=x.Forward(!1);x._RightHandedForwardReadOnly=x.Forward(!0);x._RightReadOnly=x.Right();x._LeftReadOnly=x.Left();x._ZeroReadOnly=x.Zero();class Tt{constructor(e=0,t=0,i=0,r=0){this.x=e,this.y=t,this.z=i,this.w=r}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){const e=On(this.x),t=On(this.y),i=On(this.z),r=On(this.w);let s=e;return s=s*397^t,s=s*397^i,s=s*397^r,s}asArray(){const e=new Array;return this.toArray(e,0),e}toArray(e,t){return t===void 0&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}fromArray(e,t=0){return Tt.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add(e){return new this.constructor(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,t}subtractFromFloats(e,t,i,r){return new this.constructor(this.x-e,this.y-t,this.z-i,this.w-r)}subtractFromFloatsToRef(e,t,i,r,s){return s.x=this.x-e,s.y=this.y-t,s.z=this.z-i,s.w=this.w-r,s}negate(){return new this.constructor(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.copyFromFloats(this.x*-1,this.y*-1,this.z*-1,this.w*-1)}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new this.constructor(this.x*e,this.y*e,this.z*e,this.w*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsWithEpsilon(e,t=kt){return e&&Ee.WithinEpsilon(this.x,e.x,t)&&Ee.WithinEpsilon(this.y,e.y,t)&&Ee.WithinEpsilon(this.z,e.z,t)&&Ee.WithinEpsilon(this.w,e.w,t)}equalsToFloats(e,t,i,r){return this.x===e&&this.y===t&&this.z===i&&this.w===r}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,t}multiplyByFloats(e,t,i,r){return new this.constructor(this.x*e,this.y*t,this.z*i,this.w*r)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){const e=this.length();return e===0?this:this.scaleInPlace(1/e)}toVector3(){return new x(this.x,this.y,this.z)}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}setAll(e){return this.x=this.y=this.z=this.w=e,this}static FromArray(e,t){return t||(t=0),new Tt(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}static FromFloatArrayToRef(e,t,i){return Tt.FromArrayToRef(e,t,i),i}static FromFloatsToRef(e,t,i,r,s){return s.x=e,s.y=t,s.z=i,s.w=r,s}static Zero(){return new Tt(0,0,0,0)}static One(){return new Tt(1,1,1,1)}static Random(e=0,t=1){return new Tt(Ee.RandomRange(e,t),Ee.RandomRange(e,t),Ee.RandomRange(e,t),Ee.RandomRange(e,t))}static get ZeroReadOnly(){return Tt._ZeroReadOnly}static Normalize(e){const t=Tt.Zero();return Tt.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return t.copyFrom(e),t.normalize(),t}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(Tt.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,r=e.y-t.y,s=e.z-t.z,n=e.w-t.w;return i*i+r*r+s*s+n*n}static Center(e,t){return Tt.CenterToRef(e,t,Tt.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}static TransformCoordinates(e,t){const i=Tt.Zero();return Tt.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return Tt.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,r,s){const n=r.m,a=e*n[0]+t*n[4]+i*n[8]+n[12],l=e*n[1]+t*n[5]+i*n[9]+n[13],c=e*n[2]+t*n[6]+i*n[10]+n[14],h=e*n[3]+t*n[7]+i*n[11]+n[15];return s.x=a,s.y=l,s.z=c,s.w=h,s}static TransformNormal(e,t){const i=new e.constructor;return Tt.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){const r=t.m,s=e.x*r[0]+e.y*r[4]+e.z*r[8],n=e.x*r[1]+e.y*r[5]+e.z*r[9],a=e.x*r[2]+e.y*r[6]+e.z*r[10];return i.x=s,i.y=n,i.z=a,i.w=e.w,i}static TransformNormalFromFloatsToRef(e,t,i,r,s,n){const a=s.m;return n.x=e*a[0]+t*a[4]+i*a[8],n.y=e*a[1]+t*a[5]+i*a[9],n.z=e*a[2]+t*a[6]+i*a[10],n.w=r,n}static FromVector3(e,t=0){return new Tt(e._x,e._y,e._z,t)}}Tt._ZeroReadOnly=Tt.Zero();class oe{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,i=0,r=1){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=r}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){const e=On(this._x),t=On(this._y),i=On(this._z),r=On(this._w);let s=e;return s=s*397^t,s=s*397^i,s=s*397^r,s}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=kt){return e&&Ee.WithinEpsilon(this._x,e._x,t)&&Ee.WithinEpsilon(this._y,e._y,t)&&Ee.WithinEpsilon(this._z,e._z,t)&&Ee.WithinEpsilon(this._w,e._w,t)}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,t,i,r){return this._x=e,this._y=t,this._z=i,this._w=r,this._isDirty=!0,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=!0,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=!0,t}multiply(e){const t=new this.constructor(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){const i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,r=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,s=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,n=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,r,s,n),t}multiplyInPlace(e){return this.multiplyToRef(e,this),this}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new this.constructor(-this._x,-this._y,-this._z,this._w)}invert(){const e=this.conjugate(),t=this.lengthSquared();return t==0||t==1||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();const e=this.lengthSquared();return e==0||e==1?this:(this.scaleInPlace(1/e),this)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){const e=this.length();if(e===0)return this;const t=1/e;return this.scaleInPlace(t),this}normalizeToNew(){const e=this.length();if(e===0)return this.clone();const t=1/e;return this.scale(t)}toEulerAngles(){const e=x.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){const t=this._z,i=this._x,r=this._y,s=this._w,n=r*t-i*s,a=.4999999;if(n<-a)e._y=2*Math.atan2(r,s),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(n>a)e._y=2*Math.atan2(r,s),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{const l=s*s,c=t*t,h=i*i,u=r*r;e._z=Math.atan2(2*(i*r+t*s),-c-h+u+l),e._x=Math.asin(-2*n),e._y=Math.atan2(2*(t*i+r*s),c-h-u+l),e._isDirty=!0}return e}toRotationMatrix(e){return H.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return oe.FromRotationMatrixToRef(e,this),this}static FromRotationMatrix(e){const t=new oe;return oe.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){const i=e.m,r=i[0],s=i[4],n=i[8],a=i[1],l=i[5],c=i[9],h=i[2],u=i[6],d=i[10],f=r+l+d;let _;return f>0?(_=.5/Math.sqrt(f+1),t._w=.25/_,t._x=(u-c)*_,t._y=(n-h)*_,t._z=(a-s)*_,t._isDirty=!0):r>l&&r>d?(_=2*Math.sqrt(1+r-l-d),t._w=(u-c)/_,t._x=.25*_,t._y=(s+a)/_,t._z=(n+h)/_,t._isDirty=!0):l>d?(_=2*Math.sqrt(1+l-r-d),t._w=(n-h)/_,t._x=(s+a)/_,t._y=.25*_,t._z=(c+u)/_,t._isDirty=!0):(_=2*Math.sqrt(1+d-r-l),t._w=(a-s)/_,t._x=(n+h)/_,t._y=(c+u)/_,t._z=.25*_,t._isDirty=!0),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,i=.1){const r=oe.Dot(e,t);return 1-r*r<=i}static SmoothToRef(e,t,i,r,s){let n=r===0?1:i/r;return n=Ee.Clamp(n,0,1),oe.SlerpToRef(e,t,n,s),s}static Zero(){return new oe(0,0,0,0)}static Inverse(e){return new e.constructor(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new oe(0,0,0,1)}static IsIdentity(e){return e&&e._x===0&&e._y===0&&e._z===0&&e._w===1}static RotationAxis(e,t){return oe.RotationAxisToRef(e,t,new oe)}static RotationAxisToRef(e,t,i){const r=Math.sin(t/2);return e.normalize(),i._w=Math.cos(t/2),i._x=e._x*r,i._y=e._y*r,i._z=e._z*r,i._isDirty=!0,i}static FromArray(e,t){return t||(t=0),new oe(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._w=e[t+3],i._isDirty=!0,i}static FromEulerAngles(e,t,i){const r=new oe;return oe.RotationYawPitchRollToRef(t,e,i,r),r}static FromEulerAnglesToRef(e,t,i,r){return oe.RotationYawPitchRollToRef(t,e,i,r),r}static FromEulerVector(e){const t=new oe;return oe.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return oe.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,i){const r=x.Dot(e,t)+1;return r<kt?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(x.CrossToRef(e,t,j.Vector3[0]),i.set(j.Vector3[0].x,j.Vector3[0].y,j.Vector3[0].z,r)),i.normalize()}static RotationYawPitchRoll(e,t,i){const r=new oe;return oe.RotationYawPitchRollToRef(e,t,i,r),r}static RotationYawPitchRollToRef(e,t,i,r){const s=i*.5,n=t*.5,a=e*.5,l=Math.sin(s),c=Math.cos(s),h=Math.sin(n),u=Math.cos(n),d=Math.sin(a),f=Math.cos(a);return r._x=f*h*c+d*u*l,r._y=d*u*c-f*h*l,r._z=f*u*l-d*h*c,r._w=f*u*c+d*h*l,r._isDirty=!0,r}static RotationAlphaBetaGamma(e,t,i){const r=new oe;return oe.RotationAlphaBetaGammaToRef(e,t,i,r),r}static RotationAlphaBetaGammaToRef(e,t,i,r){const s=(i+e)*.5,n=(i-e)*.5,a=t*.5;return r._x=Math.cos(n)*Math.sin(a),r._y=Math.sin(n)*Math.sin(a),r._z=Math.sin(s)*Math.cos(a),r._w=Math.cos(s)*Math.cos(a),r._isDirty=!0,r}static RotationQuaternionFromAxis(e,t,i){const r=new oe(0,0,0,0);return oe.RotationQuaternionFromAxisToRef(e,t,i,r),r}static RotationQuaternionFromAxisToRef(e,t,i,r){const s=dt.Matrix[0];return H.FromXYZAxesToRef(e.normalize(),t.normalize(),i.normalize(),s),oe.FromRotationMatrixToRef(s,r),r}static FromLookDirectionLH(e,t){const i=new oe;return oe.FromLookDirectionLHToRef(e,t,i),i}static FromLookDirectionLHToRef(e,t,i){const r=dt.Matrix[0];return H.LookDirectionLHToRef(e,t,r),oe.FromRotationMatrixToRef(r,i),i}static FromLookDirectionRH(e,t){const i=new oe;return oe.FromLookDirectionRHToRef(e,t,i),i}static FromLookDirectionRHToRef(e,t,i){const r=dt.Matrix[0];return H.LookDirectionRHToRef(e,t,r),oe.FromRotationMatrixToRef(r,i)}static Slerp(e,t,i){const r=oe.Identity();return oe.SlerpToRef(e,t,i,r),r}static SlerpToRef(e,t,i,r){let s,n,a=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,l=!1;if(a<0&&(l=!0,a=-a),a>.999999)n=1-i,s=l?-i:i;else{const c=Math.acos(a),h=1/Math.sin(c);n=Math.sin((1-i)*c)*h,s=l?-Math.sin(i*c)*h:Math.sin(i*c)*h}return r._x=n*e._x+s*t._x,r._y=n*e._y+s*t._y,r._z=n*e._z+s*t._z,r._w=n*e._w+s*t._w,r._isDirty=!0,r}static Hermite(e,t,i,r,s){const n=s*s,a=s*n,l=2*a-3*n+1,c=-2*a+3*n,h=a-2*n+s,u=a-n,d=e._x*l+i._x*c+t._x*h+r._x*u,f=e._y*l+i._y*c+t._y*h+r._y*u,_=e._z*l+i._z*c+t._z*h+r._z*u,p=e._w*l+i._w*c+t._w*h+r._w*u;return new e.constructor(d,f,_,p)}static Hermite1stDerivative(e,t,i,r,s){const n=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const a=s*s;return n._x=(a-s)*6*e._x+(3*a-4*s+1)*t._x+(-a+s)*6*i._x+(3*a-2*s)*r._x,n._y=(a-s)*6*e._y+(3*a-4*s+1)*t._y+(-a+s)*6*i._y+(3*a-2*s)*r._y,n._z=(a-s)*6*e._z+(3*a-4*s+1)*t._z+(-a+s)*6*i._z+(3*a-2*s)*r._z,n._w=(a-s)*6*e._w+(3*a-4*s+1)*t._w+(-a+s)*6*i._w+(3*a-2*s)*r._w,n._isDirty=!0,n}}class H{static get Use64Bits(){return ms.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=H._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,i=!1,r=!0){this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=this._isIdentity?!1:t,this._isIdentity3x2Dirty=this._isIdentity3x2?!1:r}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,ms.MatrixTrackPrecisionChange&&ms.MatrixTrackedMatrices.push(this),this._m=new ms.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;const e=this._m;this._isIdentity=e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._m[0]!==1||this._m[5]!==1||this._m[15]!==1?this._isIdentity3x2=!1:this._m[1]!==0||this._m[2]!==0||this._m[3]!==0||this._m[4]!==0||this._m[6]!==0||this._m[7]!==0||this._m[8]!==0||this._m[9]!==0||this._m[10]!==0||this._m[11]!==0||this._m[12]!==0||this._m[13]!==0||this._m[14]!==0?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(this._isIdentity===!0)return 1;const e=this._m,t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],a=e[5],l=e[6],c=e[7],h=e[8],u=e[9],d=e[10],f=e[11],_=e[12],p=e[13],m=e[14],T=e[15],b=d*T-m*f,y=u*T-p*f,S=u*m-p*d,C=h*T-_*f,I=h*m-d*_,P=h*p-_*u,D=+(a*b-l*y+c*S),w=-(n*b-l*C+c*I),L=+(n*y-a*C+c*P),U=-(n*S-a*I+l*P);return t*D+i*w+r*L+s*U}toArray(){return this._m}asArray(){return this._m}invert(){return this.invertToRef(this),this}reset(){return H.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){const t=new this.constructor;return this.addToRef(e,t),t}addToRef(e,t){const i=this._m,r=t._m,s=e.m;for(let n=0;n<16;n++)r[n]=i[n]+s[n];return t.markAsUpdated(),t}addToSelf(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]+=i[r];return this.markAsUpdated(),this}invertToRef(e){if(this._isIdentity===!0)return H.IdentityToRef(e),e;const t=this._m,i=t[0],r=t[1],s=t[2],n=t[3],a=t[4],l=t[5],c=t[6],h=t[7],u=t[8],d=t[9],f=t[10],_=t[11],p=t[12],m=t[13],T=t[14],b=t[15],y=f*b-T*_,S=d*b-m*_,C=d*T-m*f,I=u*b-p*_,P=u*T-f*p,D=u*m-p*d,w=+(l*y-c*S+h*C),L=-(a*y-c*I+h*P),U=+(a*S-l*I+h*D),G=-(a*C-l*P+c*D),Z=i*w+r*L+s*U+n*G;if(Z===0)return e.copyFrom(this),e;const he=1/Z,_e=c*b-T*h,ne=l*b-m*h,Pe=l*T-m*c,Se=a*b-p*h,ce=a*T-p*c,de=a*m-p*l,k=c*_-f*h,se=l*_-d*h,xe=l*f-d*c,le=a*_-u*h,je=a*f-u*c,st=a*d-u*l,be=-(r*y-s*S+n*C),We=+(i*y-s*I+n*P),Ct=-(i*S-r*I+n*D),_t=+(i*C-r*P+s*D),mt=+(r*_e-s*ne+n*Pe),Ge=-(i*_e-s*Se+n*ce),Ut=+(i*ne-r*Se+n*de),Ft=-(i*Pe-r*ce+s*de),Zt=-(r*k-s*se+n*xe),$t=+(i*k-s*le+n*je),Di=-(i*se-r*le+n*st),Ui=+(i*xe-r*je+s*st);return H.FromValuesToRef(w*he,be*he,mt*he,Zt*he,L*he,We*he,Ge*he,$t*he,U*he,Ct*he,Ut*he,Di*he,G*he,_t*he,Ft*he,Ui*he,e),e}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new x(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){const e=this.m;return H.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1),this}multiply(e){const t=new this.constructor;return this.multiplyToRef(e,t),t}copyFrom(e){e.copyToArray(this._m);const t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){const i=this._m;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],this}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,i){const r=this._m,s=e.m,n=r[0],a=r[1],l=r[2],c=r[3],h=r[4],u=r[5],d=r[6],f=r[7],_=r[8],p=r[9],m=r[10],T=r[11],b=r[12],y=r[13],S=r[14],C=r[15],I=s[0],P=s[1],D=s[2],w=s[3],L=s[4],U=s[5],G=s[6],Z=s[7],he=s[8],_e=s[9],ne=s[10],Pe=s[11],Se=s[12],ce=s[13],de=s[14],k=s[15];return t[i]=n*I+a*L+l*he+c*Se,t[i+1]=n*P+a*U+l*_e+c*ce,t[i+2]=n*D+a*G+l*ne+c*de,t[i+3]=n*w+a*Z+l*Pe+c*k,t[i+4]=h*I+u*L+d*he+f*Se,t[i+5]=h*P+u*U+d*_e+f*ce,t[i+6]=h*D+u*G+d*ne+f*de,t[i+7]=h*w+u*Z+d*Pe+f*k,t[i+8]=_*I+p*L+m*he+T*Se,t[i+9]=_*P+p*U+m*_e+T*ce,t[i+10]=_*D+p*G+m*ne+T*de,t[i+11]=_*w+p*Z+m*Pe+T*k,t[i+12]=b*I+y*L+S*he+C*Se,t[i+13]=b*P+y*U+S*_e+C*ce,t[i+14]=b*D+y*G+S*ne+C*de,t[i+15]=b*w+y*Z+S*Pe+C*k,this}equals(e){const t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;const i=this.m,r=t.m;return i[0]===r[0]&&i[1]===r[1]&&i[2]===r[2]&&i[3]===r[3]&&i[4]===r[4]&&i[5]===r[5]&&i[6]===r[6]&&i[7]===r[7]&&i[8]===r[8]&&i[9]===r[9]&&i[10]===r[10]&&i[11]===r[11]&&i[12]===r[12]&&i[13]===r[13]&&i[14]===r[14]&&i[15]===r[15]}clone(){const e=new this.constructor;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=On(this._m[0]);for(let t=1;t<16;t++)e=e*397^On(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new oe,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,i,r){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;const s=this._m;if(i&&i.copyFromFloats(s[12],s[13],s[14]),e=e||dt.Vector3[0],e.x=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),e.y=Math.sqrt(s[4]*s[4]+s[5]*s[5]+s[6]*s[6]),e.z=Math.sqrt(s[8]*s[8]+s[9]*s[9]+s[10]*s[10]),r){const n=r.scaling.x<0?-1:1,a=r.scaling.y<0?-1:1,l=r.scaling.z<0?-1:1;e.x*=n,e.y*=a,e.z*=l}else this.determinant()<=0&&(e.y*=-1);if(e._x===0||e._y===0||e._z===0)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){const n=1/e._x,a=1/e._y,l=1/e._z;H.FromValuesToRef(s[0]*n,s[1]*n,s[2]*n,0,s[4]*a,s[5]*a,s[6]*a,0,s[8]*l,s[9]*l,s[10]*l,0,0,0,0,1,dt.Matrix[0]),oe.FromRotationMatrixToRef(dt.Matrix[0],t)}return!0}getRow(e){if(e<0||e>3)return null;const t=e*4;return new Tt(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<3){const i=e*4;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3]}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){const e=new this.constructor;return H.TransposeToRef(this,e),e}transposeToRef(e){return H.TransposeToRef(this,e),e}setRowFromFloats(e,t,i,r,s){if(e<0||e>3)return this;const n=e*4;return this._m[n+0]=t,this._m[n+1]=i,this._m[n+2]=r,this._m[n+3]=s,this.markAsUpdated(),this}scale(e){const t=new this.constructor;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),t}toNormalMatrix(e){const t=dt.Matrix[0];this.invertToRef(t),t.transposeToRef(e);const i=e._m;return H.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e),e}getRotationMatrix(){const e=new this.constructor;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){const t=dt.Vector3[0];if(!this.decompose(t))return H.IdentityToRef(e),e;const i=this._m,r=1/t._x,s=1/t._y,n=1/t._z;return H.FromValuesToRef(i[0]*r,i[1]*r,i[2]*r,0,i[4]*s,i[5]*s,i[6]*s,0,i[8]*n,i[9]*n,i[10]*n,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){const e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){const e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,t=0){const i=new H;return H.FromArrayToRef(e,t,i),i}static FromArrayToRef(e,t,i){for(let r=0;r<16;r++)i._m[r]=e[r+t];return i.markAsUpdated(),i}static FromFloat32ArrayToRefScaled(e,t,i,r){for(let s=0;s<16;s++)r._m[s]=e[s+t]*i;return r.markAsUpdated(),r}static get IdentityReadOnly(){return H._IdentityReadOnly}static FromValuesToRef(e,t,i,r,s,n,a,l,c,h,u,d,f,_,p,m,T){const b=T._m;b[0]=e,b[1]=t,b[2]=i,b[3]=r,b[4]=s,b[5]=n,b[6]=a,b[7]=l,b[8]=c,b[9]=h,b[10]=u,b[11]=d,b[12]=f,b[13]=_,b[14]=p,b[15]=m,T.markAsUpdated()}static FromValues(e,t,i,r,s,n,a,l,c,h,u,d,f,_,p,m){const T=new H,b=T._m;return b[0]=e,b[1]=t,b[2]=i,b[3]=r,b[4]=s,b[5]=n,b[6]=a,b[7]=l,b[8]=c,b[9]=h,b[10]=u,b[11]=d,b[12]=f,b[13]=_,b[14]=p,b[15]=m,T.markAsUpdated(),T}static Compose(e,t,i){const r=new H;return H.ComposeToRef(e,t,i,r),r}static ComposeToRef(e,t,i,r){const s=r._m,n=t._x,a=t._y,l=t._z,c=t._w,h=n+n,u=a+a,d=l+l,f=n*h,_=n*u,p=n*d,m=a*u,T=a*d,b=l*d,y=c*h,S=c*u,C=c*d,I=e._x,P=e._y,D=e._z;return s[0]=(1-(m+b))*I,s[1]=(_+C)*I,s[2]=(p-S)*I,s[3]=0,s[4]=(_-C)*P,s[5]=(1-(f+b))*P,s[6]=(T+y)*P,s[7]=0,s[8]=(p+S)*D,s[9]=(T-y)*D,s[10]=(1-(f+m))*D,s[11]=0,s[12]=i._x,s[13]=i._y,s[14]=i._z,s[15]=1,r.markAsUpdated(),r}static Identity(){const e=H.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){return H.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0),e}static Zero(){const e=H.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){const t=new H;return H.RotationXToRef(e,t),t}static Invert(e){const t=new e.constructor;return e.invertToRef(t),t}static RotationXToRef(e,t){const i=Math.sin(e),r=Math.cos(e);return H.FromValuesToRef(1,0,0,0,0,r,i,0,0,-i,r,0,0,0,0,1,t),t._updateIdentityStatus(r===1&&i===0),t}static RotationY(e){const t=new H;return H.RotationYToRef(e,t),t}static RotationYToRef(e,t){const i=Math.sin(e),r=Math.cos(e);return H.FromValuesToRef(r,0,-i,0,0,1,0,0,i,0,r,0,0,0,0,1,t),t._updateIdentityStatus(r===1&&i===0),t}static RotationZ(e){const t=new H;return H.RotationZToRef(e,t),t}static RotationZToRef(e,t){const i=Math.sin(e),r=Math.cos(e);return H.FromValuesToRef(r,i,0,0,-i,r,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(r===1&&i===0),t}static RotationAxis(e,t){const i=new H;return H.RotationAxisToRef(e,t,i),i}static RotationAxisToRef(e,t,i){const r=Math.sin(-t),s=Math.cos(-t),n=1-s;e.normalize();const a=i._m;return a[0]=e._x*e._x*n+s,a[1]=e._x*e._y*n-e._z*r,a[2]=e._x*e._z*n+e._y*r,a[3]=0,a[4]=e._y*e._x*n+e._z*r,a[5]=e._y*e._y*n+s,a[6]=e._y*e._z*n-e._x*r,a[7]=0,a[8]=e._z*e._x*n-e._y*r,a[9]=e._z*e._y*n+e._x*r,a[10]=e._z*e._z*n+s,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,i.markAsUpdated(),i}static RotationAlignToRef(e,t,i){const r=x.Dot(t,e),s=i._m;if(r<-1+kt)s[0]=-1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0;else{const n=x.Cross(t,e),a=1/(1+r);s[0]=n._x*n._x*a+r,s[1]=n._y*n._x*a-n._z,s[2]=n._z*n._x*a+n._y,s[3]=0,s[4]=n._x*n._y*a+n._z,s[5]=n._y*n._y*a+r,s[6]=n._z*n._y*a-n._x,s[7]=0,s[8]=n._x*n._z*a-n._y,s[9]=n._y*n._z*a+n._x,s[10]=n._z*n._z*a+r,s[11]=0}return s[12]=0,s[13]=0,s[14]=0,s[15]=1,i.markAsUpdated(),i}static RotationYawPitchRoll(e,t,i){const r=new H;return H.RotationYawPitchRollToRef(e,t,i,r),r}static RotationYawPitchRollToRef(e,t,i,r){return oe.RotationYawPitchRollToRef(e,t,i,dt.Quaternion[0]),dt.Quaternion[0].toRotationMatrix(r),r}static Scaling(e,t,i){const r=new H;return H.ScalingToRef(e,t,i,r),r}static ScalingToRef(e,t,i,r){return H.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,r),r._updateIdentityStatus(e===1&&t===1&&i===1),r}static Translation(e,t,i){const r=new H;return H.TranslationToRef(e,t,i,r),r}static TranslationToRef(e,t,i,r){return H.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,r),r._updateIdentityStatus(e===0&&t===0&&i===0),r}static Lerp(e,t,i){const r=new e.constructor;return H.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){const s=r._m,n=e.m,a=t.m;for(let l=0;l<16;l++)s[l]=n[l]*(1-i)+a[l]*i;return r.markAsUpdated(),r}static DecomposeLerp(e,t,i){const r=new e.constructor;return H.DecomposeLerpToRef(e,t,i,r),r}static DecomposeLerpToRef(e,t,i,r){const s=dt.Vector3[0],n=dt.Quaternion[0],a=dt.Vector3[1];e.decompose(s,n,a);const l=dt.Vector3[2],c=dt.Quaternion[1],h=dt.Vector3[3];t.decompose(l,c,h);const u=dt.Vector3[4];x.LerpToRef(s,l,i,u);const d=dt.Quaternion[2];oe.SlerpToRef(n,c,i,d);const f=dt.Vector3[5];return x.LerpToRef(a,h,i,f),H.ComposeToRef(u,d,f,r),r}static LookAtLH(e,t,i){const r=new H;return H.LookAtLHToRef(e,t,i,r),r}static LookAtLHToRef(e,t,i,r){const s=dt.Vector3[0],n=dt.Vector3[1],a=dt.Vector3[2];t.subtractToRef(e,a),a.normalize(),x.CrossToRef(i,a,s);const l=s.lengthSquared();l===0?s.x=1:s.normalizeFromLength(Math.sqrt(l)),x.CrossToRef(a,s,n),n.normalize();const c=-x.Dot(s,e),h=-x.Dot(n,e),u=-x.Dot(a,e);H.FromValuesToRef(s._x,n._x,a._x,0,s._y,n._y,a._y,0,s._z,n._z,a._z,0,c,h,u,1,r)}static LookAtRH(e,t,i){const r=new H;return H.LookAtRHToRef(e,t,i,r),r}static LookAtRHToRef(e,t,i,r){const s=dt.Vector3[0],n=dt.Vector3[1],a=dt.Vector3[2];e.subtractToRef(t,a),a.normalize(),x.CrossToRef(i,a,s);const l=s.lengthSquared();l===0?s.x=1:s.normalizeFromLength(Math.sqrt(l)),x.CrossToRef(a,s,n),n.normalize();const c=-x.Dot(s,e),h=-x.Dot(n,e),u=-x.Dot(a,e);return H.FromValuesToRef(s._x,n._x,a._x,0,s._y,n._y,a._y,0,s._z,n._z,a._z,0,c,h,u,1,r),r}static LookDirectionLH(e,t){const i=new H;return H.LookDirectionLHToRef(e,t,i),i}static LookDirectionLHToRef(e,t,i){const r=dt.Vector3[0];r.copyFrom(e),r.scaleInPlace(-1);const s=dt.Vector3[1];return x.CrossToRef(t,r,s),H.FromValuesToRef(s._x,s._y,s._z,0,t._x,t._y,t._z,0,r._x,r._y,r._z,0,0,0,0,1,i),i}static LookDirectionRH(e,t){const i=new H;return H.LookDirectionRHToRef(e,t,i),i}static LookDirectionRHToRef(e,t,i){const r=dt.Vector3[2];return x.CrossToRef(t,e,r),H.FromValuesToRef(r._x,r._y,r._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i),i}static OrthoLH(e,t,i,r,s){const n=new H;return H.OrthoLHToRef(e,t,i,r,n,s),n}static OrthoLHToRef(e,t,i,r,s,n){const a=i,l=r,c=2/e,h=2/t,u=2/(l-a),d=-(l+a)/(l-a);return H.FromValuesToRef(c,0,0,0,0,h,0,0,0,0,u,0,0,0,d,1,s),n&&s.multiplyToRef(al,s),s._updateIdentityStatus(c===1&&h===1&&u===1&&d===0),s}static OrthoOffCenterLH(e,t,i,r,s,n,a){const l=new H;return H.OrthoOffCenterLHToRef(e,t,i,r,s,n,l,a),l}static OrthoOffCenterLHToRef(e,t,i,r,s,n,a,l){const c=s,h=n,u=2/(t-e),d=2/(r-i),f=2/(h-c),_=-(h+c)/(h-c),p=(e+t)/(e-t),m=(r+i)/(i-r);return H.FromValuesToRef(u,0,0,0,0,d,0,0,0,0,f,0,p,m,_,1,a),l&&a.multiplyToRef(al,a),a.markAsUpdated(),a}static OrthoOffCenterRH(e,t,i,r,s,n,a){const l=new H;return H.OrthoOffCenterRHToRef(e,t,i,r,s,n,l,a),l}static OrthoOffCenterRHToRef(e,t,i,r,s,n,a,l){return H.OrthoOffCenterLHToRef(e,t,i,r,s,n,a,l),a._m[10]*=-1,a}static PerspectiveLH(e,t,i,r,s,n=0){const a=new H,l=i,c=r,h=2*l/e,u=2*l/t,d=(c+l)/(c-l),f=-2*c*l/(c-l),_=Math.tan(n);return H.FromValuesToRef(h,0,0,0,0,u,0,_,0,0,d,1,0,0,f,0,a),s&&a.multiplyToRef(al,a),a._updateIdentityStatus(!1),a}static PerspectiveFovLH(e,t,i,r,s,n=0,a=!1){const l=new H;return H.PerspectiveFovLHToRef(e,t,i,r,l,!0,s,n,a),l}static PerspectiveFovLHToRef(e,t,i,r,s,n=!0,a,l=0,c=!1){const h=i,u=r,d=1/Math.tan(e*.5),f=n?d/t:d,_=n?d:d*t,p=c&&h===0?-1:u!==0?(u+h)/(u-h):1,m=c&&h===0?2*u:u!==0?-2*u*h/(u-h):-2*h,T=Math.tan(l);return H.FromValuesToRef(f,0,0,0,0,_,0,T,0,0,p,1,0,0,m,0,s),a&&s.multiplyToRef(al,s),s._updateIdentityStatus(!1),s}static PerspectiveFovReverseLHToRef(e,t,i,r,s,n=!0,a,l=0){const c=1/Math.tan(e*.5),h=n?c/t:c,u=n?c:c*t,d=Math.tan(l);return H.FromValuesToRef(h,0,0,0,0,u,0,d,0,0,-i,1,0,0,1,0,s),a&&s.multiplyToRef(al,s),s._updateIdentityStatus(!1),s}static PerspectiveFovRH(e,t,i,r,s,n=0,a=!1){const l=new H;return H.PerspectiveFovRHToRef(e,t,i,r,l,!0,s,n,a),l}static PerspectiveFovRHToRef(e,t,i,r,s,n=!0,a,l=0,c=!1){const h=i,u=r,d=1/Math.tan(e*.5),f=n?d/t:d,_=n?d:d*t,p=c&&h===0?1:u!==0?-(u+h)/(u-h):-1,m=c&&h===0?2*u:u!==0?-2*u*h/(u-h):-2*h,T=Math.tan(l);return H.FromValuesToRef(f,0,0,0,0,_,0,T,0,0,p,-1,0,0,m,0,s),a&&s.multiplyToRef(al,s),s._updateIdentityStatus(!1),s}static PerspectiveFovReverseRHToRef(e,t,i,r,s,n=!0,a,l=0){const c=1/Math.tan(e*.5),h=n?c/t:c,u=n?c:c*t,d=Math.tan(l);return H.FromValuesToRef(h,0,0,0,0,u,0,d,0,0,-i,-1,0,0,-1,0,s),a&&s.multiplyToRef(al,s),s._updateIdentityStatus(!1),s}static PerspectiveFovWebVRToRef(e,t,i,r,s=!1,n,a=0){const l=s?-1:1,c=Math.tan(e.upDegrees*Math.PI/180),h=Math.tan(e.downDegrees*Math.PI/180),u=Math.tan(e.leftDegrees*Math.PI/180),d=Math.tan(e.rightDegrees*Math.PI/180),f=2/(u+d),_=2/(c+h),p=Math.tan(a),m=r._m;return m[0]=f,m[1]=m[2]=m[3]=m[4]=0,m[5]=_,m[6]=0,m[7]=p,m[8]=(u-d)*f*.5,m[9]=-((c-h)*_*.5),m[10]=-i/(t-i),m[11]=1*l,m[12]=m[13]=m[15]=0,m[14]=-(2*i*t)/(i-t),n&&r.multiplyToRef(al,r),r.markAsUpdated(),r}static GetFinalMatrix(e,t,i,r,s,n){const a=e.width,l=e.height,c=e.x,h=e.y,u=H.FromValues(a/2,0,0,0,0,-l/2,0,0,0,0,n-s,0,c+a/2,l/2+h,s,1),d=new t.constructor;return t.multiplyToRef(i,d),d.multiplyToRef(r,d),d.multiplyToRef(u,d)}static GetAsMatrix2x2(e){const t=e.m,i=[t[0],t[1],t[4],t[5]];return ms.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(e){const t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return ms.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(e){const t=new e.constructor;return H.TransposeToRef(e,t),t}static TransposeToRef(e,t){const i=t._m,r=e.m;return i[0]=r[0],i[1]=r[4],i[2]=r[8],i[3]=r[12],i[4]=r[1],i[5]=r[5],i[6]=r[9],i[7]=r[13],i[8]=r[2],i[9]=r[6],i[10]=r[10],i[11]=r[14],i[12]=r[3],i[13]=r[7],i[14]=r[11],i[15]=r[15],t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(e){const t=new H;return H.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();const i=e.normal.x,r=e.normal.y,s=e.normal.z,n=-2*i,a=-2*r,l=-2*s;return H.FromValuesToRef(n*i+1,a*i,l*i,0,n*r,a*r+1,l*r,0,n*s,a*s,l*s+1,0,n*e.d,a*e.d,l*e.d,1,t),t}static FromXYZAxesToRef(e,t,i,r){return H.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,r),r}static FromQuaternionToRef(e,t){const i=e._x*e._x,r=e._y*e._y,s=e._z*e._z,n=e._x*e._y,a=e._z*e._w,l=e._z*e._x,c=e._y*e._w,h=e._y*e._z,u=e._x*e._w;return t._m[0]=1-2*(r+s),t._m[1]=2*(n+a),t._m[2]=2*(l-c),t._m[3]=0,t._m[4]=2*(n-a),t._m[5]=1-2*(s+i),t._m[6]=2*(h+u),t._m[7]=0,t._m[8]=2*(l+c),t._m[9]=2*(h-u),t._m[10]=1-2*(r+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}}H._UpdateFlagSeed=0;H._IdentityReadOnly=H.Identity();class dt{}dt.Vector3=Br.BuildTuple(11,x.Zero);dt.Matrix=Br.BuildTuple(2,H.Identity);dt.Quaternion=Br.BuildTuple(3,oe.Zero);class j{}j.Vector2=Br.BuildTuple(3,Ie.Zero);j.Vector3=Br.BuildTuple(13,x.Zero);j.Vector4=Br.BuildTuple(3,Tt.Zero);j.Quaternion=Br.BuildTuple(2,oe.Zero);j.Matrix=Br.BuildTuple(8,H.Identity);ye("BABYLON.Vector2",Ie);ye("BABYLON.Vector3",x);ye("BABYLON.Vector4",Tt);ye("BABYLON.Matrix",H);const al=H.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);class ge{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return ge.FromArrayToRef(e,t,this),this}toColor4(e=1){return new Ye(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return this.r*.3+this.g*.59+this.b*.11}multiply(e){return new ge(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}scale(e){return new ge(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,this}clampToRef(e=0,t=1,i){return i.r=Ee.Clamp(this.r,e,t),i.g=Ee.Clamp(this.g,e,t),i.b=Ee.Clamp(this.b,e,t),this}add(e){return new ge(this.r+e.r,this.g+e.g,this.b+e.b)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,this}subtract(e){return new ge(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,this}clone(){return new ge(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}toHexString(){const e=Math.round(this.r*255),t=Math.round(this.g*255),i=Math.round(this.b*255);return"#"+Ee.ToHex(e)+Ee.ToHex(t)+Ee.ToHex(i)}toLinearSpace(){const e=new ge;return this.toLinearSpaceToRef(e),e}toHSV(){const e=new ge;return this.toHSVToRef(e),e}toHSVToRef(e){const t=this.r,i=this.g,r=this.b,s=Math.max(t,i,r),n=Math.min(t,i,r);let a=0,l=0;const c=s,h=s-n;s!==0&&(l=h/s),s!=n&&(s==t?(a=(i-r)/h,i<r&&(a+=6)):s==i?a=(r-t)/h+2:s==r&&(a=(t-i)/h+4),a*=60),e.r=a,e.g=l,e.b=c}toLinearSpaceToRef(e){return e.r=Math.pow(this.r,Ho),e.g=Math.pow(this.g,Ho),e.b=Math.pow(this.b,Ho),this}toGammaSpace(){const e=new ge;return this.toGammaSpaceToRef(e),e}toGammaSpaceToRef(e){return e.r=Math.pow(this.r,mo),e.g=Math.pow(this.g,mo),e.b=Math.pow(this.b,mo),this}static HSVtoRGBToRef(e,t,i,r){const s=i*t,n=e/60,a=s*(1-Math.abs(n%2-1));let l=0,c=0,h=0;n>=0&&n<=1?(l=s,c=a):n>=1&&n<=2?(l=a,c=s):n>=2&&n<=3?(c=s,h=a):n>=3&&n<=4?(c=a,h=s):n>=4&&n<=5?(l=a,h=s):n>=5&&n<=6&&(l=s,h=a);const u=i-s;r.set(l+u,c+u,h+u)}static FromHSV(e,t,i){const r=new ge(0,0,0);return ge.HSVtoRGBToRef(e,t,i,r),r}static FromHexString(e){if(e.substring(0,1)!=="#"||e.length!==7)return new ge(0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),r=parseInt(e.substring(5,7),16);return ge.FromInts(t,i,r)}static FromArray(e,t=0){return new ge(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2]}static FromInts(e,t,i){return new ge(e/255,t/255,i/255)}static Lerp(e,t,i){const r=new ge(0,0,0);return ge.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i}static Hermite(e,t,i,r,s){const n=s*s,a=s*n,l=2*a-3*n+1,c=-2*a+3*n,h=a-2*n+s,u=a-n,d=e.r*l+i.r*c+t.r*h+r.r*u,f=e.g*l+i.g*c+t.g*h+r.g*u,_=e.b*l+i.b*c+t.b*h+r.b*u;return new ge(d,f,_)}static Hermite1stDerivative(e,t,i,r,s){const n=ge.Black();return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const a=s*s;n.r=(a-s)*6*e.r+(3*a-4*s+1)*t.r+(-a+s)*6*i.r+(3*a-2*s)*r.r,n.g=(a-s)*6*e.g+(3*a-4*s+1)*t.g+(-a+s)*6*i.g+(3*a-2*s)*r.g,n.b=(a-s)*6*e.b+(3*a-4*s+1)*t.b+(-a+s)*6*i.b+(3*a-2*s)*r.b}static Red(){return new ge(1,0,0)}static Green(){return new ge(0,1,0)}static Blue(){return new ge(0,0,1)}static Black(){return new ge(0,0,0)}static get BlackReadOnly(){return ge._BlackReadOnly}static White(){return new ge(1,1,1)}static Purple(){return new ge(.5,0,.5)}static Magenta(){return new ge(1,0,1)}static Yellow(){return new ge(1,1,0)}static Gray(){return new ge(.5,.5,.5)}static Teal(){return new ge(0,1,1)}static Random(){return new ge(Math.random(),Math.random(),Math.random())}}ge._BlackReadOnly=ge.Black();class Ye{constructor(e=0,t=0,i=0,r=1){this.r=e,this.g=t,this.b=i,this.a=r}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return Ye.FromArrayToRef(e,t,this),this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new Ye(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new Ye(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,this}scale(e){return new Ye(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,this}clampToRef(e=0,t=1,i){return i.r=Ee.Clamp(this.r,e,t),i.g=Ee.Clamp(this.g,e,t),i.b=Ee.Clamp(this.b,e,t),i.a=Ee.Clamp(this.a,e,t),this}multiply(e){return new Ye(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e=e*397^(this.a*255|0),e}clone(){return new Ye(this.r,this.g,this.b,this.a)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,r){return this.r=e,this.g=t,this.b=i,this.a=r,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}toHexString(e=!1){const t=Math.round(this.r*255),i=Math.round(this.g*255),r=Math.round(this.b*255);if(e)return"#"+Ee.ToHex(t)+Ee.ToHex(i)+Ee.ToHex(r);const s=Math.round(this.a*255);return"#"+Ee.ToHex(t)+Ee.ToHex(i)+Ee.ToHex(r)+Ee.ToHex(s)}toLinearSpace(){const e=new Ye;return this.toLinearSpaceToRef(e),e}toLinearSpaceToRef(e){return e.r=Math.pow(this.r,Ho),e.g=Math.pow(this.g,Ho),e.b=Math.pow(this.b,Ho),e.a=this.a,this}toGammaSpace(){const e=new Ye;return this.toGammaSpaceToRef(e),e}toGammaSpaceToRef(e){return e.r=Math.pow(this.r,mo),e.g=Math.pow(this.g,mo),e.b=Math.pow(this.b,mo),e.a=this.a,this}static FromHexString(e){if(e.substring(0,1)!=="#"||e.length!==9&&e.length!==7)return new Ye(0,0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),r=parseInt(e.substring(5,7),16),s=e.length===9?parseInt(e.substring(7,9),16):255;return Ye.FromInts(t,i,r,s)}static Lerp(e,t,i){const r=new Ye(0,0,0,0);return Ye.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i,r.a=e.a+(t.a-e.a)*i}static Hermite(e,t,i,r,s){const n=s*s,a=s*n,l=2*a-3*n+1,c=-2*a+3*n,h=a-2*n+s,u=a-n,d=e.r*l+i.r*c+t.r*h+r.r*u,f=e.g*l+i.g*c+t.g*h+r.g*u,_=e.b*l+i.b*c+t.b*h+r.b*u,p=e.a*l+i.a*c+t.a*h+r.a*u;return new Ye(d,f,_,p)}static Hermite1stDerivative(e,t,i,r,s){const n=new Ye;return this.Hermite1stDerivativeToRef(e,t,i,r,s,n),n}static Hermite1stDerivativeToRef(e,t,i,r,s,n){const a=s*s;n.r=(a-s)*6*e.r+(3*a-4*s+1)*t.r+(-a+s)*6*i.r+(3*a-2*s)*r.r,n.g=(a-s)*6*e.g+(3*a-4*s+1)*t.g+(-a+s)*6*i.g+(3*a-2*s)*r.g,n.b=(a-s)*6*e.b+(3*a-4*s+1)*t.b+(-a+s)*6*i.b+(3*a-2*s)*r.b,n.a=(a-s)*6*e.a+(3*a-4*s+1)*t.a+(-a+s)*6*i.a+(3*a-2*s)*r.a}static FromColor3(e,t=1){return new Ye(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new Ye(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}static FromInts(e,t,i,r){return new Ye(e/255,t/255,i/255,r/255)}static CheckColors4(e,t){if(e.length===t*3){const i=[];for(let r=0;r<e.length;r+=3){const s=r/3*4;i[s]=e[r],i[s+1]=e[r+1],i[s+2]=e[r+2],i[s+3]=1}return i}return e}}class Jt{}Jt.Color3=Br.BuildArray(3,ge.Black);Jt.Color4=Br.BuildArray(3,()=>new Ye(0,0,0,0));ye("BABYLON.Color3",ge);ye("BABYLON.Color4",Ye);class Ri{constructor(e,t){this.triggerOptions=e,this.onBeforeExecuteObservable=new Q,e.parameter?(this.trigger=e.trigger,this._triggerParameter=e.parameter):e.trigger?this.trigger=e.trigger:this.trigger=e,this._nextActiveAction=this,this._condition=t}_prepare(){}getTriggerParameter(){return this._triggerParameter}setTriggerParameter(e){this._triggerParameter=e}_evaluateConditionForCurrentFrame(){const e=this._condition;if(!e)return!0;const t=this._actionManager.getScene().getRenderId();return e._evaluationId!==t&&(e._evaluationId=t,e._currentResult=e.isValid()),e._currentResult}_executeCurrent(e){this._evaluateConditionForCurrentFrame()&&(this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(e),this.skipToNextActiveAction())}execute(e){}skipToNextActiveAction(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this}then(e){return this._child=e,e._actionManager=this._actionManager,e._prepare(),e}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(e){}_serialize(e,t){const i={type:1,children:[],name:e.name,properties:e.properties||[]};if(this._child&&this._child.serialize(i),this._condition){const r=this._condition.serialize();return r.children.push(i),t&&t.children.push(r),r}return t&&t.children.push(i),i}}Ri._SerializeValueAsString=o=>typeof o=="number"?o.toString():typeof o=="boolean"?o?"true":"false":o instanceof Ie?o.x+", "+o.y:o instanceof x?o.x+", "+o.y+", "+o.z:o instanceof ge?o.r+", "+o.g+", "+o.b:o instanceof Ye?o.r+", "+o.g+", "+o.b+", "+o.a:o;Ri._GetTargetProperty=o=>({name:"target",targetType:o._isMesh?"MeshProperties":o._isLight?"LightProperties":o._isCamera?"CameraProperties":o._isMaterial?"MaterialProperties":"SceneProperties",value:o._isScene?"Scene":o.name});ye("BABYLON.Action",Ri);class is{constructor(e,t,i,r,s,n){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=r,this.sourceEvent=s,this.additionalData=n}static CreateNew(e,t,i){const r=e.getScene();return new is(e,r.pointerX,r.pointerY,r.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,r){return new is(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,r)}static CreateNewFromScene(e,t){return new is(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,r){return new is(e,t.x,t.y,null,i,r)}}class du{constructor(e){this._actionManager=e}isValid(){return!0}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(){}_serialize(e){return{type:2,children:[],name:e.name,properties:e.properties}}}class ts extends du{static get IsEqual(){return ts._IsEqual}static get IsDifferent(){return ts._IsDifferent}static get IsGreater(){return ts._IsGreater}static get IsLesser(){return ts._IsLesser}constructor(e,t,i,r,s=ts.IsEqual){super(e),this.propertyPath=i,this.value=r,this.operator=s,this._target=t,this._effectiveTarget=this._getEffectiveTarget(t,this.propertyPath),this._property=this._getProperty(this.propertyPath)}isValid(){switch(this.operator){case ts.IsGreater:return this._effectiveTarget[this._property]>this.value;case ts.IsLesser:return this._effectiveTarget[this._property]<this.value;case ts.IsEqual:case ts.IsDifferent:{let e;return this.value.equals?e=this.value.equals(this._effectiveTarget[this._property]):e=this.value===this._effectiveTarget[this._property],this.operator===ts.IsEqual?e:!e}}return!1}serialize(){return this._serialize({name:"ValueCondition",properties:[Ri._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:Ri._SerializeValueAsString(this.value)},{name:"operator",value:ts.GetOperatorName(this.operator)}]})}static GetOperatorName(e){switch(e){case ts._IsEqual:return"IsEqual";case ts._IsDifferent:return"IsDifferent";case ts._IsGreater:return"IsGreater";case ts._IsLesser:return"IsLesser";default:return""}}}ts._IsEqual=0;ts._IsDifferent=1;ts._IsGreater=2;ts._IsLesser=3;class fb extends du{constructor(e,t){super(e),this.predicate=t}isValid(){return this.predicate()}}class _b extends du{constructor(e,t,i){super(e),this.value=i,this._target=t}isValid(){return this._target.state===this.value}serialize(){return this._serialize({name:"StateCondition",properties:[Ri._GetTargetProperty(this._target),{name:"value",value:this.value}]})}}ye("BABYLON.ValueCondition",ts);ye("BABYLON.PredicateCondition",fb);ye("BABYLON.StateCondition",_b);class X{static _CheckLimit(e,t){let i=X._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},X._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){var i;const r=X._LogLimitOutputs[e];if(!r||!X.MessageLimitReached)return;const s=this._Levels[t];r.current===r.limit&&X[s.name](X.MessageLimitReached.replace(/%LIMIT%/g,""+r.limit).replace(/%TYPE%/g,(i=s.name)!==null&&i!==void 0?i:""))}static _AddLogEntry(e){X._LogCache=e+X._LogCache,X.OnNewCacheEntry&&X.OnNewCacheEntry(e)}static _FormatMessage(e){const t=r=>r<10?"0"+r:""+r,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){if(i!==void 0&&!X._CheckLimit(t,i))return;const r=X._FormatMessage(t),s=this._Levels[e];s.logFunc&&s.logFunc("BJS - "+r);const n=`<div style='color:${s.color}'>${r}</div><br>`;X._AddLogEntry(n),X._GenerateLimitMessage(t,e)}static get LogCache(){return X._LogCache}static ClearLogCache(){X._LogCache="",X._LogLimitOutputs={},X.errorsCount=0}static set LogLevels(e){X.Log=X._LogDisabled,X.Warn=X._LogDisabled,X.Error=X._LogDisabled,[X.MessageLogLevel,X.WarningLogLevel,X.ErrorLogLevel].forEach(t=>{if((e&t)===t){const i=this._Levels[t];X[i.name]=X._LogEnabled.bind(X,t)}})}}X.NoneLogLevel=0;X.MessageLogLevel=1;X.WarningLogLevel=2;X.ErrorLogLevel=4;X.AllLogLevel=7;X.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.";X._LogCache="";X._LogLimitOutputs={};X._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}];X.errorsCount=0;X.Log=X._LogEnabled.bind(X,X.MessageLogLevel);X.Warn=X._LogEnabled.bind(X,X.WarningLogLevel);X.Error=X._LogEnabled.bind(X,X.ErrorLogLevel);class pb extends Ri{constructor(e,t,i,r){super(e,r),this.propertyPath=i,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]}serialize(e){return super._serialize({name:"SwitchBooleanAction",properties:[Ri._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},e)}}class mb extends Ri{constructor(e,t,i,r){super(e,r),this.value=i,this._target=t}execute(){this._target.state=this.value}serialize(e){return super._serialize({name:"SetStateAction",properties:[Ri._GetTargetProperty(this._target),{name:"value",value:this.value}]},e)}}class gb extends Ri{constructor(e,t,i,r,s){super(e,s),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"SetValueAction",properties:[Ri._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:Ri._SerializeValueAsString(this.value)}]},e)}}class vb extends Ri{constructor(e,t,i,r,s){super(e,s),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),typeof this._effectiveTarget[this._property]!="number"&&X.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"IncrementValueAction",properties:[Ri._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:Ri._SerializeValueAsString(this.value)}]},e)}}class xb extends Ri{constructor(e,t,i,r,s,n){super(e,n),this.from=i,this.to=r,this.loop=s,this._target=t}_prepare(){}execute(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)}serialize(e){return super._serialize({name:"PlayAnimationAction",properties:[Ri._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:Ri._SerializeValueAsString(this.loop)||!1}]},e)}}class Tb extends Ri{constructor(e,t,i){super(e,i),this._target=t}_prepare(){}execute(){this._actionManager.getScene().stopAnimation(this._target)}serialize(e){return super._serialize({name:"StopAnimationAction",properties:[Ri._GetTargetProperty(this._target)]},e)}}class Kx extends Ri{constructor(e=0,t){super(e,t)}execute(){}serialize(e){return super._serialize({name:"DoNothingAction",properties:[]},e)}}class Eb extends Ri{constructor(e,t,i,r=!0){super(e,i),this.children=t,this.enableChildrenConditions=r}_prepare(){for(let e=0;e<this.children.length;e++)this.children[e]._actionManager=this._actionManager,this.children[e]._prepare()}execute(e){for(const t of this.children)(!this.enableChildrenConditions||t._evaluateConditionForCurrentFrame())&&t.execute(e)}serialize(e){const t=super._serialize({name:"CombineAction",properties:[],combine:[]},e);for(let i=0;i<this.children.length;i++)t.combine.push(this.children[i].serialize(null));return t}}class bb extends Ri{constructor(e,t,i){super(e,i),this.func=t}execute(e){this.func(e)}}class qx extends Ri{constructor(e,t,i,r){super(e,r),this._target=t,this._parent=i}_prepare(){}execute(){if(this._target.parent===this._parent)return;const e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=x.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}serialize(e){return super._serialize({name:"SetParentAction",properties:[Ri._GetTargetProperty(this._target),Ri._GetTargetProperty(this._parent)]},e)}}ye("BABYLON.SetParentAction",qx);ye("BABYLON.ExecuteCodeAction",bb);ye("BABYLON.DoNothingAction",Kx);ye("BABYLON.StopAnimationAction",Tb);ye("BABYLON.PlayAnimationAction",xb);ye("BABYLON.IncrementValueAction",vb);ye("BABYLON.SetValueAction",gb);ye("BABYLON.SetStateAction",mb);ye("BABYLON.SetParentAction",qx);ye("BABYLON.SwitchBooleanAction",pb);ye("BABYLON.CombineAction",Eb);const Wg=(o,e)=>!o||o.getClassName&&o.getClassName()==="Mesh"?null:o.getClassName&&o.getClassName()==="SubMesh"?o.clone(e):o.clone?o.clone():null;function Sb(o){const e=[];do Object.getOwnPropertyNames(o).forEach(function(t){e.indexOf(t)===-1&&e.push(t)});while(o=Object.getPrototypeOf(o));return e}class Sn{static DeepCopy(e,t,i,r){const s=Sb(e);for(const n of s){if(n[0]==="_"&&(!r||r.indexOf(n)===-1)||n.endsWith("Observable")||i&&i.indexOf(n)!==-1)continue;const a=e[n],l=typeof a;if(l!=="function")try{if(l==="object")if(a instanceof Array){if(t[n]=[],a.length>0)if(typeof a[0]=="object")for(let c=0;c<a.length;c++){const h=Wg(a[c],t);t[n].indexOf(h)===-1&&t[n].push(h)}else t[n]=a.slice(0)}else t[n]=Wg(a,t);else t[n]=a}catch(c){X.Warn(c.message)}}}}class li extends jn{constructor(e){super(),e=e||qe.LastCreatedScene,e&&(this._scene=e,e.actionManagers.push(this))}dispose(){const e=this._scene.actionManagers.indexOf(this);for(let t=0;t<this.actions.length;t++){const i=this.actions[t];li.Triggers[i.trigger]--,li.Triggers[i.trigger]===0&&delete li.Triggers[i.trigger]}e>-1&&this._scene.actionManagers.splice(e,1)}getScene(){return this._scene}hasSpecificTriggers(e){for(let t=0;t<this.actions.length;t++){const i=this.actions[t];if(e.indexOf(i.trigger)>-1)return!0}return!1}hasSpecificTriggers2(e,t){for(let i=0;i<this.actions.length;i++){const r=this.actions[i];if(e==r.trigger||t==r.trigger)return!0}return!1}hasSpecificTrigger(e,t){for(let i=0;i<this.actions.length;i++){const r=this.actions[i];if(r.trigger===e)if(t){if(t(r.getTriggerParameter()))return!0}else return!0}return!1}get hasPointerTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=li.OnPickTrigger&&t.trigger<=li.OnPointerOutTrigger)return!0}return!1}get hasPickTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=li.OnPickTrigger&&t.trigger<=li.OnPickUpTrigger)return!0}return!1}registerAction(e){return e.trigger===li.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(X.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(e),this.getScene()._registeredActions++,li.Triggers[e.trigger]?li.Triggers[e.trigger]++:li.Triggers[e.trigger]=1,e._actionManager=this,e._prepare(),e)}unregisterAction(e){const t=this.actions.indexOf(e);return t!==-1?(this.actions.splice(t,1),li.Triggers[e.trigger]-=1,li.Triggers[e.trigger]===0&&delete li.Triggers[e.trigger],e._actionManager=null,this.getScene()._registeredActions--,!0):!1}processTrigger(e,t){for(let i=0;i<this.actions.length;i++){const r=this.actions[i];if(r.trigger===e){if(t&&(e===li.OnKeyUpTrigger||e===li.OnKeyDownTrigger)){const s=r.getTriggerParameter();if(typeof s=="function"){if(!s(t))continue}else if(s&&s!==t.sourceEvent.keyCode){if(!s.toLowerCase)continue;const n=s.toLowerCase();if(n!==t.sourceEvent.key){const a=t.sourceEvent.charCode?t.sourceEvent.charCode:t.sourceEvent.keyCode;if(String.fromCharCode(a).toLowerCase()!==n)continue}}}r._executeCurrent(t)}}}_getEffectiveTarget(e,t){const i=t.split(".");for(let r=0;r<i.length-1;r++)e=e[i[r]];return e}_getProperty(e){const t=e.split(".");return t[t.length-1]}serialize(e){const t={children:new Array,name:e,type:3,properties:new Array};for(let i=0;i<this.actions.length;i++){const r={type:0,children:new Array,name:li.GetTriggerName(this.actions[i].trigger),properties:new Array},s=this.actions[i].triggerOptions;if(s&&typeof s!="number")if(s.parameter instanceof Node)r.properties.push(Ri._GetTargetProperty(s.parameter));else if(typeof s.parameter=="object"){const n={};Sn.DeepCopy(s.parameter,n,["mesh"]),s.parameter&&s.parameter.mesh&&(n._meshId=s.parameter.mesh.id),r.properties.push({name:"parameter",targetType:null,value:n})}else r.properties.push({name:"parameter",targetType:null,value:s.parameter});this.actions[i].serialize(r),t.children.push(r)}return t}static Parse(e,t,i){const r=new li(i);t===null?i.actionManager=r:t.actionManager=r;const s=(l,c)=>{const h=Xr("BABYLON."+l);return h&&new h(...c)},n=(l,c,h,u)=>{if(u===null){const p=parseFloat(c);return c==="true"||c==="false"?c==="true":isNaN(p)?c:p}const d=u.split("."),f=c.split(",");for(let p=0;p<d.length;p++)h=h[d[p]];if(typeof h=="boolean")return f[0]==="true";if(typeof h=="string")return f[0];const _=new Array;for(let p=0;p<f.length;p++)_.push(parseFloat(f[p]));return h instanceof x?x.FromArray(_):h instanceof Tt?Tt.FromArray(_):h instanceof ge?ge.FromArray(_):h instanceof Ye?Ye.FromArray(_):parseFloat(f[0])},a=(l,c,h,u,d=null)=>{if(l.detached)return;const f=new Array;let _=null,p=null;const m=l.combine&&l.combine.length>0;if(l.type===2?f.push(r):f.push(c),m){const b=new Array;for(let y=0;y<l.combine.length;y++)a(l.combine[y],li.NothingTrigger,h,u,b);f.push(b)}else for(let b=0;b<l.properties.length;b++){let y=l.properties[b].value;const S=l.properties[b].name,C=l.properties[b].targetType;S==="target"?C==="SceneProperties"?y=_=i:C==="MaterialProperties"?y=_=i.getMaterialByName(y):y=_=i.getNodeByName(y):S==="parent"?y=i.getNodeByName(y):S==="sound"?i.getSoundByName&&(y=i.getSoundByName(y)):S!=="propertyPath"?l.type===2&&S==="operator"?y=ts[y]:y=n(S,y,_,S==="value"?p:null):p=y,f.push(y)}if(d===null?f.push(h):f.push(null),l.name==="InterpolateValueAction"){const b=f[f.length-2];f[f.length-1]=b,f[f.length-2]=h}let T=s(l.name,f);if(T instanceof du&&h!==null){const b=new Kx(c,h);u?u.then(b):r.registerAction(b),u=b}d===null?T instanceof du?(h=T,T=u):(h=null,u?u.then(T):r.registerAction(T)):d.push(T);for(let b=0;b<l.children.length;b++)a(l.children[b],c,h,T,null)};for(let l=0;l<e.children.length;l++){let c;const h=e.children[l];if(h.properties.length>0){const u=h.properties[0].value,d=h.properties[0].targetType===null?u:i.getMeshByName(u);d._meshId&&(d.mesh=i.getMeshById(d._meshId)),c={trigger:li[h.name],parameter:d}}else c=li[h.name];for(let u=0;u<h.children.length;u++)h.detached||a(h.children[u],c,null,null)}}static GetTriggerName(e){switch(e){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnDoublePickTrigger";case 7:return"OnPickUpTrigger";case 8:return"OnLongPressTrigger";case 9:return"OnPointerOverTrigger";case 10:return"OnPointerOutTrigger";case 11:return"OnEveryFrameTrigger";case 12:return"OnIntersectionEnterTrigger";case 13:return"OnIntersectionExitTrigger";case 14:return"OnKeyDownTrigger";case 15:return"OnKeyUpTrigger";case 16:return"OnPickOutTrigger";default:return""}}}li.NothingTrigger=0;li.OnPickTrigger=1;li.OnLeftPickTrigger=2;li.OnRightPickTrigger=3;li.OnCenterPickTrigger=4;li.OnPickDownTrigger=5;li.OnDoublePickTrigger=6;li.OnPickUpTrigger=7;li.OnPickOutTrigger=16;li.OnLongPressTrigger=8;li.OnPointerOverTrigger=9;li.OnPointerOutTrigger=10;li.OnEveryFrameTrigger=11;li.OnIntersectionEnterTrigger=12;li.OnIntersectionExitTrigger=13;li.OnKeyDownTrigger=14;li.OnKeyUpTrigger=15;class yb extends Ri{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){this._sound!==void 0&&this._sound.play()}serialize(e){return super._serialize({name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}class Cb extends Ri{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){this._sound!==void 0&&this._sound.stop()}serialize(e){return super._serialize({name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}ye("BABYLON.PlaySoundAction",yb);ye("BABYLON.StopSoundAction",Cb);class Ql{static Eval(e,t){return e.match(/\([^()]*\)/g)?e=e.replace(/\([^()]*\)/g,i=>(i=i.slice(1,i.length-1),Ql._HandleParenthesisContent(i,t))):e=Ql._HandleParenthesisContent(e,t),e==="true"?!0:e==="false"?!1:Ql.Eval(e,t)}static _HandleParenthesisContent(e,t){t=t||(s=>s==="true");let i;const r=e.split("||");for(const s in r)if(Object.prototype.hasOwnProperty.call(r,s)){let n=Ql._SimplifyNegation(r[s].trim());const a=n.split("&&");if(a.length>1)for(let l=0;l<a.length;++l){const c=Ql._SimplifyNegation(a[l].trim());if(c!=="true"&&c!=="false"?c[0]==="!"?i=!t(c.substring(1)):i=t(c):i=c==="true",!i){n="false";break}}if(i||n==="true"){i=!0;break}n!=="true"&&n!=="false"?n[0]==="!"?i=!t(n.substring(1)):i=t(n):i=n==="true"}return i?"true":"false"}static _SimplifyNegation(e){return e=e.replace(/^[\s!]+/,t=>(t=t.replace(/[\s]/g,()=>""),t.length%2?"!":"")),e=e.trim(),e==="!true"?e="false":e==="!false"&&(e="true"),e}}class qt{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>qt.HasTags(e),e.addTags=t=>qt.AddTagsTo(e,t),e.removeTags=t=>qt.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>qt.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const t=e._tags;for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){const i=[];for(const r in e._tags)Object.prototype.hasOwnProperty.call(e._tags,r)&&e._tags[r]===!0&&i.push(r);return i.join(" ")}else return e._tags}static AddTagsTo(e,t){if(!t||typeof t!="string")return;t.split(" ").forEach(function(r){qt._AddTagTo(e,r)})}static _AddTagTo(e,t){t=t.trim(),!(t===""||t==="true"||t==="false")&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(qt.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!qt.HasTags(e))return;const i=t.split(" ");for(const r in i)qt._RemoveTagFrom(e,i[r])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return t===void 0?!0:t===""?qt.HasTags(e):Ql.Eval(t,i=>qt.HasTags(e)&&e._tags[i])}}function pt(o){return`${o} needs to be imported before as it contains a side-effect required by your code.`}const Nd={},Ed={},Xg=function(o,e,t){const i=o();qt&&qt.AddTagsTo(i,e.tags);const r=V_(i);for(const s in r){const n=r[s],a=e[s],l=n.type;if(a!=null&&(s!=="uniqueId"||ke.AllowLoadingUniqueId))switch(l){case 0:case 6:case 11:i[s]=a;break;case 1:i[s]=t||a.isRenderTarget?a:a.clone();break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:i[s]=t?a:a.clone();break}}return i};function Ab(o){const e=o.getClassName();return Nd[e]||(Nd[e]={}),Nd[e]}function V_(o){const e=o.getClassName();if(Ed[e])return Ed[e];Ed[e]={};const t=Ed[e];let i=o,r=e;for(;r;){const s=Nd[r];for(const l in s)t[l]=s[l];let n,a=!1;do{if(n=Object.getPrototypeOf(i),!n.getClassName){a=!0;break}if(n.getClassName()!==r)break;i=n}while(n);if(a)break;r=n.getClassName(),i=n}return t}function fa(o,e){return(t,i)=>{const r=Ab(t);r[i]||(r[i]={type:o,sourceName:e})}}function Rb(o,e=null){return(t,i)=>{const r=e||"_"+i;Object.defineProperty(t,i,{get:function(){return this[r]},set:function(s){typeof this.equals=="function"&&this.equals(s)||this[r]!==s&&(this[r]=s,t[o].apply(this))},enumerable:!0,configurable:!0})}}function Te(o,e=null){return Rb(o,e)}function F(o){return fa(0,o)}function Bt(o){return fa(1,o)}function Kr(o){return fa(2,o)}function Ou(o){return fa(3,o)}function Zp(o){return fa(4,o)}function Zs(o){return fa(5,o)}function Du(o){return fa(6,o)}function Ib(o){return fa(7,o)}function Jp(o){return fa(8,o)}function Qx(o){return fa(9,o)}function Pb(o){return fa(10,o)}function Zx(o){return fa(12,o)}function Mb(o){return fa(11,o)}class ke{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let i=0;i<e.animations.length;i++){const r=e.animations[i];t.animations.push(r.serialize())}}}static Serialize(e,t){t||(t={}),qt&&(t.tags=qt.GetTags(e));const i=V_(e);for(const r in i){const s=i[r],n=s.sourceName||r,a=s.type,l=e[r];if(l!=null&&(r!=="uniqueId"||ke.AllowLoadingUniqueId))switch(a){case 0:t[n]=l;break;case 1:t[n]=l.serialize();break;case 2:t[n]=l.asArray();break;case 3:t[n]=l.serialize();break;case 4:t[n]=l.asArray();break;case 5:t[n]=l.asArray();break;case 6:t[n]=l.id;break;case 7:t[n]=l.serialize();break;case 8:t[n]=l.asArray();break;case 9:t[n]=l.serialize();break;case 10:t[n]=l.asArray();break;case 11:t[n]=l.id;break;case 12:t[n]=l.asArray();break}}return t}static Parse(e,t,i,r=null){const s=e();r||(r=""),qt&&qt.AddTagsTo(s,t.tags);const n=V_(s);for(const a in n){const l=n[a],c=t[l.sourceName||a],h=l.type;if(c!=null&&(a!=="uniqueId"||ke.AllowLoadingUniqueId)){const u=s;switch(h){case 0:u[a]=c;break;case 1:i&&(u[a]=ke._TextureParser(c,i,r));break;case 2:u[a]=ge.FromArray(c);break;case 3:u[a]=ke._FresnelParametersParser(c);break;case 4:u[a]=Ie.FromArray(c);break;case 5:u[a]=x.FromArray(c);break;case 6:i&&(u[a]=i.getLastMeshById(c));break;case 7:u[a]=ke._ColorCurvesParser(c);break;case 8:u[a]=Ye.FromArray(c);break;case 9:u[a]=ke._ImageProcessingConfigurationParser(c);break;case 10:u[a]=oe.FromArray(c);break;case 11:i&&(u[a]=i.getCameraById(c));break;case 12:u[a]=H.FromArray(c);break}}}return s}static Clone(e,t){return Xg(e,t,!1)}static Instanciate(e,t){return Xg(e,t,!0)}}ke.AllowLoadingUniqueId=!1;ke._ImageProcessingConfigurationParser=o=>{throw pt("ImageProcessingConfiguration")};ke._FresnelParametersParser=o=>{throw pt("FresnelParameters")};ke._ColorCurvesParser=o=>{throw pt("ColorCurves")};ke._TextureParser=(o,e,t)=>{throw pt("Texture")};function Il(o,e,t,i){const r=t.value;t.value=(...s)=>{let n=r;if(typeof _native<"u"&&_native[e]){const a=_native[e];i?n=(...l)=>i(...l)?a(...l):r(...l):n=a}return o[e]=n,n(...s)}}Il.filter=function(o){return(e,t,i)=>Il(e,t,i,o)};var th;(function(o){o[o.NONE=0]="NONE",o[o.STEP=1]="STEP"})(th||(th={}));class ih{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new ih(this.name,this.from,this.to)}}function M(o,e,t,i){var r=arguments.length,s=r<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,n;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(n=o[a])&&(s=(r<3?n(s):r>3?n(e,t,s):n(e,t))||s);return r>3&&s&&Object.defineProperty(e,t,s),s}class Ob{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new Q,this._onClonedObservable=new Q}}let ii=class Jx{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,r){const s=this._NodeConstructors[e];return s?s(t,i,r):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return this._nodeDataStorage._doNotSerialize?!0:this._parentNode?this._parentNode.doNotSerialize:!1}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const t=this._parentNode;if(this._parentNode&&this._parentNode._children!==void 0&&this._parentNode._children!==null){const i=this._parentNode._children.indexOf(this);i!==-1&&this._parentNode._children.splice(i,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._parentNode&&((this._parentNode._children===void 0||this._parentNode._children===null)&&(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){this._nodeDataStorage._sceneRootNodesIndex===-1&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(this._nodeDataStorage._sceneRootNodesIndex!==-1){const e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null){this._isDirty=!1,this._nodeDataStorage=new Ob,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new Q,this._parentContainer=null,this.animations=new Array,this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=H.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new Q,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||qe.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return this._behaviors.indexOf(e)!==-1?this:(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(()=>{e.attach(this)}):e.attach(this),this._behaviors.push(e),this)}removeBehavior(e){const t=this._behaviors.indexOf(e);return t===-1?this:(this._behaviors[t].detach(),this._behaviors.splice(t,1),this)}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={},this._cache.parent=void 0}updateCache(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return this._parentNode?this._parentNode._isDirty||this._parentUpdateId!==this._parentNode._childUpdateId?!1:this._parentNode.isSynchronized():!0}isSynchronized(){return this._cache.parent!==this._parentNode?(this._cache.parent=this._parentNode,!1):this._parentNode&&!this.isSynchronizedWithParent()?!1:this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return e===!1?this._nodeDataStorage._isEnabled:this._nodeDataStorage._isEnabled?this._nodeDataStorage._isParentEnabled:!1}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=this._parentNode?this._parentNode.isEnabled():!0,this._children&&this._children.forEach(e=>{e._syncParentEnabledState()})}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1}_getDescendants(e,t=!1,i){if(this._children)for(let r=0;r<this._children.length;r++){const s=this._children[r];(!i||i(s))&&e.push(s),t||s._getDescendants(e,!1,i)}}getDescendants(e,t){const i=new Array;return this._getDescendants(i,e,t),i}getChildMeshes(e,t){const i=[];return this._getDescendants(i,e,r=>(!t||t(r))&&r.cullingStrategy!==void 0),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){if(e!==this._nodeDataStorage._isReady){if(!e){this._nodeDataStorage._isReady=!1;return}this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){const i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=Jx._AnimationRangeFactory(e,t,i);for(let r=0,s=this.animations.length;r<s;r++)this.animations[r]&&this.animations[r].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.animations.length;i<r;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,r){const s=this.getAnimationRange(e);return s?this._scene.beginAnimation(this,s.from,s.to,t,i,r):null}serializeAnimationRanges(){const e=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const r={};r.name=t,r.from=i.from,r.to=i.to,e.push(r)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=H.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){const i=this.getDescendants(!0);for(const r of i)r.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const i of this._behaviors)i.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let r=0;r<t.ranges.length;r++){const s=t.ranges[r];e.createAnimationRange(s.name,s.from,s.to)}}getHierarchyBoundingVectors(e=!0,t=null){this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);let i,r;const s=this;if(s.getBoundingInfo&&s.subMeshes){const n=s.getBoundingInfo();i=n.boundingBox.minimumWorld.clone(),r=n.boundingBox.maximumWorld.clone()}else i=new x(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new x(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const n=this.getDescendants(!1);for(const a of n){const l=a;if(l.computeWorldMatrix(!0),t&&!t(l)||!l.getBoundingInfo||l.getTotalVertices()===0)continue;const h=l.getBoundingInfo().boundingBox,u=h.minimumWorld,d=h.maximumWorld;x.CheckExtends(u,i,r),x.CheckExtends(d,i,r)}}return{min:i,max:r}}};ii._AnimationRangeFactory=(o,e,t)=>{throw pt("AnimationRange")};ii._NodeConstructors={};M([F()],ii.prototype,"name",void 0);M([F()],ii.prototype,"id",void 0);M([F()],ii.prototype,"uniqueId",void 0);M([F()],ii.prototype,"state",void 0);M([F()],ii.prototype,"metadata",void 0);class oa{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=this.width|0;return e=e*397^(this.height|0),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new oa(this.width*e,this.height*t)}clone(){return new oa(this.width,this.height)}equals(e){return e?this.width===e.width&&this.height===e.height:!1}get surface(){return this.width*this.height}static Zero(){return new oa(0,0)}add(e){return new oa(this.width+e.width,this.height+e.height)}subtract(e){return new oa(this.width-e.width,this.height-e.height)}static Lerp(e,t,i){const r=e.width+(t.width-e.width)*i,s=e.height+(t.height-e.height)*i;return new oa(r,s)}}function Db(){return typeof _native<"u"&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}class gs{constructor(){this._xhr=Db(),this._requestURL=""}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in gs.CustomRequestHeaders){const t=gs.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return gs.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,i){this._xhr.addEventListener(e,t,i)}removeEventListener(e,t,i){this._xhr.removeEventListener(e,t,i)}abort(){this._xhr.abort()}send(e){gs.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(const i of gs.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;i(this._xhr,t)}return t=t.replace("file:http:","http:"),t=t.replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}}gs.CustomRequestHeaders={};gs.CustomRequestModifiers=new Array;gs.SkipRequestModificationForBabylonCDN=!0;class ae{static _PrepareAnimation(e,t,i,r,s,n,a,l){let c;if(!isNaN(parseFloat(s))&&isFinite(s)?c=ae.ANIMATIONTYPE_FLOAT:s instanceof oe?c=ae.ANIMATIONTYPE_QUATERNION:s instanceof x?c=ae.ANIMATIONTYPE_VECTOR3:s instanceof Ie?c=ae.ANIMATIONTYPE_VECTOR2:s instanceof ge?c=ae.ANIMATIONTYPE_COLOR3:s instanceof Ye?c=ae.ANIMATIONTYPE_COLOR4:s instanceof oa&&(c=ae.ANIMATIONTYPE_SIZE),c==null)return null;const h=new ae(e,t,i,c,a),u=[{frame:0,value:s},{frame:r,value:n}];return h.setKeys(u),l!==void 0&&h.setEasingFunction(l),h}static CreateAnimation(e,t,i,r){const s=new ae(e+"Animation",e,i,t,ae.ANIMATIONLOOPMODE_CONSTANT);return s.setEasingFunction(r),s}static CreateAndStartAnimation(e,t,i,r,s,n,a,l,c,h,u){const d=ae._PrepareAnimation(e,i,r,s,n,a,l,c);return!d||(t.getScene&&(u=t.getScene()),!u)?null:u.beginDirectAnimation(t,[d],0,s,d.loopMode===1,1,h)}static CreateAndStartHierarchyAnimation(e,t,i,r,s,n,a,l,c,h,u){const d=ae._PrepareAnimation(e,r,s,n,a,l,c,h);return d?t.getScene().beginDirectHierarchyAnimation(t,i,[d],0,n,d.loopMode===1,1,u):null}static CreateMergeAndStartAnimation(e,t,i,r,s,n,a,l,c,h){const u=ae._PrepareAnimation(e,i,r,s,n,a,l,c);return u?(t.animations.push(u),t.getScene().beginAnimation(t,0,s,u.loopMode===1,1,h)):null}static MakeAnimationAdditive(e,t=0,i,r=!1,s){let n=e;if(r&&(n=e.clone(),n.name=s||n.name),!n._keys.length)return n;t=t>=0?t:0;let a=0;const l=n._keys[0];let c=n._keys.length-1;const h=n._keys[c],u={referenceValue:l.value,referencePosition:j.Vector3[0],referenceQuaternion:j.Quaternion[0],referenceScaling:j.Vector3[1],keyPosition:j.Vector3[2],keyQuaternion:j.Quaternion[1],keyScaling:j.Vector3[3]};let d=!1,f=l.frame,_=h.frame;if(i){const b=n.getRange(i);b&&(f=b.from,_=b.to)}let p=l.frame===f,m=h.frame===_;if(n._keys.length===1){const b=n._getKeyValue(n._keys[0]);u.referenceValue=b.clone?b.clone():b,d=!0}else if(t<=l.frame){const b=n._getKeyValue(l.value);u.referenceValue=b.clone?b.clone():b,d=!0}else if(t>=h.frame){const b=n._getKeyValue(h.value);u.referenceValue=b.clone?b.clone():b,d=!0}let T=0;for(;!d||!p||!m&&T<n._keys.length-1;){const b=n._keys[T],y=n._keys[T+1];if(!d&&t>=b.frame&&t<=y.frame){let S;if(t===b.frame)S=n._getKeyValue(b.value);else if(t===y.frame)S=n._getKeyValue(y.value);else{const C={key:T,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT};S=n._interpolate(t,C)}u.referenceValue=S.clone?S.clone():S,d=!0}if(!p&&f>=b.frame&&f<=y.frame){if(f===b.frame)a=T;else if(f===y.frame)a=T+1;else{const S={key:T,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT},C=n._interpolate(f,S),I={frame:f,value:C.clone?C.clone():C};n._keys.splice(T+1,0,I),a=T+1}p=!0}if(!m&&_>=b.frame&&_<=y.frame){if(_===b.frame)c=T;else if(_===y.frame)c=T+1;else{const S={key:T,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT},C=n._interpolate(_,S),I={frame:_,value:C.clone?C.clone():C};n._keys.splice(T+1,0,I),c=T+1}m=!0}T++}for(n.dataType===ae.ANIMATIONTYPE_QUATERNION?u.referenceValue.normalize().conjugateInPlace():n.dataType===ae.ANIMATIONTYPE_MATRIX&&(u.referenceValue.decompose(u.referenceScaling,u.referenceQuaternion,u.referencePosition),u.referenceQuaternion.normalize().conjugateInPlace()),T=a;T<=c;T++){const b=n._keys[T];if(!(T&&n.dataType!==ae.ANIMATIONTYPE_FLOAT&&b.value===l.value))switch(n.dataType){case ae.ANIMATIONTYPE_MATRIX:b.value.decompose(u.keyScaling,u.keyQuaternion,u.keyPosition),u.keyPosition.subtractInPlace(u.referencePosition),u.keyScaling.divideInPlace(u.referenceScaling),u.referenceQuaternion.multiplyToRef(u.keyQuaternion,u.keyQuaternion),H.ComposeToRef(u.keyScaling,u.keyQuaternion,u.keyPosition,b.value);break;case ae.ANIMATIONTYPE_QUATERNION:u.referenceValue.multiplyToRef(b.value,b.value);break;case ae.ANIMATIONTYPE_VECTOR2:case ae.ANIMATIONTYPE_VECTOR3:case ae.ANIMATIONTYPE_COLOR3:case ae.ANIMATIONTYPE_COLOR4:b.value.subtractToRef(u.referenceValue,b.value);break;case ae.ANIMATIONTYPE_SIZE:b.value.width-=u.referenceValue.width,b.value.height-=u.referenceValue.height;break;default:b.value-=u.referenceValue}}return n}static TransitionTo(e,t,i,r,s,n,a,l=null){if(a<=0)return i[e]=t,l&&l(),null;const c=s*(a/1e3);n.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:c,value:t}]),i.animations||(i.animations=[]),i.animations.push(n);const h=r.beginAnimation(i,0,c,!1);return h.onAnimationEnd=l,h}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,t,i,r,s,n){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=r,this.loopMode=s,this.enableBlending=n,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=r,this.loopMode=s===void 0?ae.ANIMATIONLOOPMODE_CYCLE:s,this.uniqueId=ae._UniqueIdGenerator++}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let i=!0;for(const r in this._ranges)i&&(t+=", ",i=!1),t+=r;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort((t,i)=>t.frame-i.frame)}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new ih(e,t,i))}deleteRange(e,t=!0){const i=this._ranges[e];if(i){if(t){const r=i.from,s=i.to;for(let n=this._keys.length-1;n>=0;n--)this._keys[n].frame>=r&&this._keys[n].frame<=s&&this._keys.splice(n,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return Ee.Lerp(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,r,s){return Ee.Hermite(e,t,i,r,s)}quaternionInterpolateFunction(e,t,i){return oe.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,r,s){return oe.Hermite(e,t,i,r,s).normalize()}vector3InterpolateFunction(e,t,i){return x.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,r,s){return x.Hermite(e,t,i,r,s)}vector2InterpolateFunction(e,t,i){return Ie.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,r,s){return Ie.Hermite(e,t,i,r,s)}sizeInterpolateFunction(e,t,i){return oa.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return ge.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,r,s){return ge.Hermite(e,t,i,r,s)}color4InterpolateFunction(e,t,i){return Ye.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,r,s){return Ye.Hermite(e,t,i,r,s)}_getKeyValue(e){return typeof e=="function"?e():e}evaluate(e){return this._interpolate(e,{key:0,repeatCount:0,loopMode:ae.ANIMATIONLOOPMODE_CONSTANT})}_interpolate(e,t){if(t.loopMode===ae.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const i=this._keys,r=i.length;let s=t.key;for(;s>=0&&e<i[s].frame;)--s;for(;s+1<=r-1&&e>=i[s+1].frame;)++s;if(t.key=s,s<0)return this._getKeyValue(i[0].value);if(s+1>r-1)return this._getKeyValue(i[r-1].value);const n=i[s],a=i[s+1],l=this._getKeyValue(n.value),c=this._getKeyValue(a.value);if(n.interpolation===th.STEP)return a.frame>e?l:c;const h=n.outTangent!==void 0&&a.inTangent!==void 0,u=a.frame-n.frame;let d=(e-n.frame)/u;const f=this.getEasingFunction();switch(f!==null&&(d=f.ease(d)),this.dataType){case ae.ANIMATIONTYPE_FLOAT:{const _=h?this.floatInterpolateFunctionWithTangents(l,n.outTangent*u,c,a.inTangent*u,d):this.floatInterpolateFunction(l,c,d);switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return _;case ae.ANIMATIONLOOPMODE_RELATIVE:return t.offsetValue*t.repeatCount+_}break}case ae.ANIMATIONTYPE_QUATERNION:{const _=h?this.quaternionInterpolateFunctionWithTangents(l,n.outTangent.scale(u),c,a.inTangent.scale(u),d):this.quaternionInterpolateFunction(l,c,d);switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return _;case ae.ANIMATIONLOOPMODE_RELATIVE:return _.addInPlace(t.offsetValue.scale(t.repeatCount))}return _}case ae.ANIMATIONTYPE_VECTOR3:{const _=h?this.vector3InterpolateFunctionWithTangents(l,n.outTangent.scale(u),c,a.inTangent.scale(u),d):this.vector3InterpolateFunction(l,c,d);switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return _;case ae.ANIMATIONLOOPMODE_RELATIVE:return _.add(t.offsetValue.scale(t.repeatCount))}break}case ae.ANIMATIONTYPE_VECTOR2:{const _=h?this.vector2InterpolateFunctionWithTangents(l,n.outTangent.scale(u),c,a.inTangent.scale(u),d):this.vector2InterpolateFunction(l,c,d);switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return _;case ae.ANIMATIONLOOPMODE_RELATIVE:return _.add(t.offsetValue.scale(t.repeatCount))}break}case ae.ANIMATIONTYPE_SIZE:{switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return this.sizeInterpolateFunction(l,c,d);case ae.ANIMATIONLOOPMODE_RELATIVE:return this.sizeInterpolateFunction(l,c,d).add(t.offsetValue.scale(t.repeatCount))}break}case ae.ANIMATIONTYPE_COLOR3:{const _=h?this.color3InterpolateFunctionWithTangents(l,n.outTangent.scale(u),c,a.inTangent.scale(u),d):this.color3InterpolateFunction(l,c,d);switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return _;case ae.ANIMATIONLOOPMODE_RELATIVE:return _.add(t.offsetValue.scale(t.repeatCount))}break}case ae.ANIMATIONTYPE_COLOR4:{const _=h?this.color4InterpolateFunctionWithTangents(l,n.outTangent.scale(u),c,a.inTangent.scale(u),d):this.color4InterpolateFunction(l,c,d);switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return _;case ae.ANIMATIONLOOPMODE_RELATIVE:return _.add(t.offsetValue.scale(t.repeatCount))}break}case ae.ANIMATIONTYPE_MATRIX:{switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return ae.AllowMatricesInterpolation?this.matrixInterpolateFunction(l,c,d,t.workValue):l;case ae.ANIMATIONLOOPMODE_RELATIVE:return l}break}}return 0}matrixInterpolateFunction(e,t,i,r){return ae.AllowMatrixDecomposeForInterpolation?r?(H.DecomposeLerpToRef(e,t,i,r),r):H.DecomposeLerp(e,t,i):r?(H.LerpToRef(e,t,i,r),r):H.Lerp(e,t,i)}clone(){const e=new ae(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const i=this._ranges[t];i&&(e._ranges[t]=i.clone())}}return e}setKeys(e){this._keys=e.slice(0)}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const t=this.dataType;e.keys=[];const i=this.getKeys();for(let r=0;r<i.length;r++){const s=i[r],n={};switch(n.frame=s.frame,t){case ae.ANIMATIONTYPE_FLOAT:n.values=[s.value],s.inTangent!==void 0&&n.values.push(s.inTangent),s.outTangent!==void 0&&(s.inTangent===void 0&&n.values.push(void 0),n.values.push(s.outTangent)),s.interpolation!==void 0&&(s.inTangent===void 0&&n.values.push(void 0),s.outTangent===void 0&&n.values.push(void 0),n.values.push(s.interpolation));break;case ae.ANIMATIONTYPE_QUATERNION:case ae.ANIMATIONTYPE_MATRIX:case ae.ANIMATIONTYPE_VECTOR3:case ae.ANIMATIONTYPE_COLOR3:case ae.ANIMATIONTYPE_COLOR4:n.values=s.value.asArray(),s.inTangent!=null&&n.values.push(s.inTangent.asArray()),s.outTangent!=null&&(s.inTangent===void 0&&n.values.push(void 0),n.values.push(s.outTangent.asArray())),s.interpolation!==void 0&&(s.inTangent===void 0&&n.values.push(void 0),s.outTangent===void 0&&n.values.push(void 0),n.values.push(s.interpolation));break}e.keys.push(n)}e.ranges=[];for(const r in this._ranges){const s=this._ranges[r];if(!s)continue;const n={};n.name=r,n.from=s.from,n.to=s.to,e.ranges.push(n)}return e}static _UniversalLerp(e,t,i){const r=e.constructor;return r.Lerp?r.Lerp(e,t,i):r.Slerp?r.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){const t=new ae(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,r=[];let s,n;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),n=0;n<e.keys.length;n++){const a=e.keys[n];let l,c,h;switch(i){case ae.ANIMATIONTYPE_FLOAT:s=a.values[0],a.values.length>=2&&(l=a.values[1]),a.values.length>=3&&(c=a.values[2]),a.values.length>=4&&(h=a.values[3]);break;case ae.ANIMATIONTYPE_QUATERNION:if(s=oe.FromArray(a.values),a.values.length>=8){const d=oe.FromArray(a.values.slice(4,8));d.equals(oe.Zero())||(l=d)}if(a.values.length>=12){const d=oe.FromArray(a.values.slice(8,12));d.equals(oe.Zero())||(c=d)}a.values.length>=13&&(h=a.values[12]);break;case ae.ANIMATIONTYPE_MATRIX:s=H.FromArray(a.values),a.values.length>=17&&(h=a.values[16]);break;case ae.ANIMATIONTYPE_COLOR3:s=ge.FromArray(a.values),a.values[3]&&(l=ge.FromArray(a.values[3])),a.values[4]&&(c=ge.FromArray(a.values[4])),a.values[5]&&(h=a.values[5]);break;case ae.ANIMATIONTYPE_COLOR4:s=Ye.FromArray(a.values),a.values[4]&&(l=Ye.FromArray(a.values[4])),a.values[5]&&(c=Ye.FromArray(a.values[5])),a.values[6]&&(h=Ye.FromArray(a.values[6]));break;case ae.ANIMATIONTYPE_VECTOR3:default:s=x.FromArray(a.values),a.values[3]&&(l=x.FromArray(a.values[3])),a.values[4]&&(c=x.FromArray(a.values[4])),a.values[5]&&(h=a.values[5]);break}const u={};u.frame=a.frame,u.value=s,l!=null&&(u.inTangent=l),c!=null&&(u.outTangent=c),h!=null&&(u.interpolation=h),r.push(u)}if(t.setKeys(r),e.ranges)for(n=0;n<e.ranges.length;n++)s=e.ranges[n],t.createRange(s.name,s.from,s.to);return t}static AppendSerializedAnimations(e,t){ke.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise((i,r)=>{const s=new gs;s.addEventListener("readystatechange",()=>{if(s.readyState==4)if(s.status==200){let n=JSON.parse(s.responseText);if(n.animations&&(n=n.animations),n.length){const a=new Array;for(const l of n)a.push(this.Parse(l));i(a)}else{const a=this.Parse(n);e&&(a.name=e),i(a)}}else r("Unable to load the animation")}),s.open("GET",t),s.send()})}static ParseFromSnippetAsync(e){return new Promise((t,i)=>{const r=new gs;r.addEventListener("readystatechange",()=>{if(r.readyState==4)if(r.status==200){const s=JSON.parse(JSON.parse(r.responseText).jsonPayload);if(s.animations){const n=JSON.parse(s.animations),a=new Array;for(const l of n.animations){const c=this.Parse(l);c.snippetId=e,a.push(c)}t(a)}else{const n=JSON.parse(s.animation),a=this.Parse(n);a.snippetId=e,t(a)}}else i("Unable to load the snippet "+e)}),r.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),r.send()})}}ae._UniqueIdGenerator=0;ae.AllowMatricesInterpolation=!1;ae.AllowMatrixDecomposeForInterpolation=!0;ae.SnippetUrl="https://snippet.babylonjs.com";ae.ANIMATIONTYPE_FLOAT=0;ae.ANIMATIONTYPE_VECTOR3=1;ae.ANIMATIONTYPE_QUATERNION=2;ae.ANIMATIONTYPE_MATRIX=3;ae.ANIMATIONTYPE_COLOR3=4;ae.ANIMATIONTYPE_COLOR4=7;ae.ANIMATIONTYPE_VECTOR2=5;ae.ANIMATIONTYPE_SIZE=6;ae.ANIMATIONLOOPMODE_RELATIVE=0;ae.ANIMATIONLOOPMODE_CYCLE=1;ae.ANIMATIONLOOPMODE_CONSTANT=2;ae.CreateFromSnippetAsync=ae.ParseFromSnippetAsync;ye("BABYLON.Animation",ae);ii._AnimationRangeFactory=(o,e,t)=>new ih(o,e,t);class Nb extends Ri{constructor(e,t,i,r,s=1e3,n,a,l){super(e,n),this.duration=1e3,this.onInterpolationDoneObservable=new Q,this.propertyPath=i,this.value=r,this.duration=s,this.stopOtherAnimations=a,this.onInterpolationDone=l,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){const e=this._actionManager.getScene(),t=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}];let i;if(typeof this.value=="number")i=ae.ANIMATIONTYPE_FLOAT;else if(this.value instanceof ge)i=ae.ANIMATIONTYPE_COLOR3;else if(this.value instanceof x)i=ae.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof H)i=ae.ANIMATIONTYPE_MATRIX;else if(this.value instanceof oe)i=ae.ANIMATIONTYPE_QUATERNION;else{X.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");return}const r=new ae("InterpolateValueAction",this._property,100*(1e3/this.duration),i,ae.ANIMATIONLOOPMODE_CONSTANT);r.setKeys(t),this.stopOtherAnimations&&e.stopAnimation(this._effectiveTarget);const s=()=>{this.onInterpolationDoneObservable.notifyObservers(this),this.onInterpolationDone&&this.onInterpolationDone()};e.beginDirectAnimation(this._effectiveTarget,[r],0,100,!1,1,s)}serialize(e){return super._serialize({name:"InterpolateValueAction",properties:[Ri._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:Ri._SerializeValueAsString(this.value)},{name:"duration",value:Ri._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:Ri._SerializeValueAsString(this.stopOtherAnimations)||!1}]},e)}}ye("BABYLON.InterpolateValueAction",Nb);const wb=Object.freeze(new oe(0,0,0,0)),Fb=Object.freeze(x.Zero()),Lb=Object.freeze(Ie.Zero()),Bb=Object.freeze(oa.Zero()),Ub=Object.freeze(ge.Black());class Vb{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,r){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._ratioOffset=0,this._previousDelay=0,this._previousRatio=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=r,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===ae.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=H.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){const n={frame:0,value:this._minValue};this._keys.splice(0,0,n)}if(this._target instanceof Array){let n=0;for(const a of this._target)this._preparePath(a,n),this._getOriginalValues(n),n++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const s=t.getEvents();s&&s.length>0&&s.forEach(n=>{this._events.push(n._clone())}),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){const i=this._animation.targetPropertyPath;if(i.length>1){let r=e[i[0]];for(let s=1;s<i.length-1;s++)r=r[i[s]];this._targetPath=i[i.length-1],this._activeTargets[t]=r}else this._targetPath=i[0],this._activeTargets[t]=e}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let t=0;for(const i of this._target)this._originalValue[t]!==void 0&&this._setValue(i,this._activeTargets[t],this._originalValue[t],-1,t),t++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let t=0;t<this._events.length;t++)this._events[t].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray){for(let i=0;i<this._target.length;i++){const r=this._target[i];this._setValue(r,this._activeTargets[i],e,t,i)}return}this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const i=this._activeTargets[e];i.getRestPose&&this._targetPath==="_matrix"?t=i.getRestPose():t=i[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_setValue(e,t,i,r,s){if(this._currentActiveTarget=t,this._weight=r,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const a=t[this._targetPath];a.clone?this._originalBlendValue=a.clone():this._originalBlendValue=a}this._originalBlendValue.m?ae.AllowMatrixDecomposeForInterpolation?this._currentValue?H.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=H.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?H.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=H.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=ae._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);const n=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=n}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:i!=null&&i.clone?this._currentValue=i.clone():this._currentValue=i;r!==-1?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[s]):t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e){const t=this._animation.getKeys();e<t[0].frame?e=t[0].frame:e>t[t.length-1].frame&&(e=t[t.length-1].frame);const i=this._events;if(i.length)for(let s=0;s<i.length;s++)i[s].onlyOnce||(i[s].isDone=i[s].frame<e);this._currentFrame=e;const r=this._animation._interpolate(e,this._animationState);this.setValue(r,-1)}_prepareForSpeedRatioChange(e){const t=this._previousDelay*(this._animation.framePerSecond*e)/1e3;this._ratioOffset=this._previousRatio-t}animate(e,t,i,r,s,n=-1){const a=this._animation,l=a.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let c=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);const h=i-t;let u;const d=e*(a.framePerSecond*s)/1e3+this._ratioOffset;let f=0;if(this._previousDelay=e,this._previousRatio=d,!r&&i>=t&&d>=h)c=!1,f=a._getKeyValue(this._maxValue);else if(!r&&t>=i&&d<=h)c=!1,f=a._getKeyValue(this._minValue);else if(this._animationState.loopMode!==ae.ANIMATIONLOOPMODE_CYCLE){const T=i.toString()+t.toString();if(!this._offsetsCache[T]){this._animationState.repeatCount=0,this._animationState.loopMode=ae.ANIMATIONLOOPMODE_CYCLE;const b=a._interpolate(t,this._animationState),y=a._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),a.dataType){case ae.ANIMATIONTYPE_FLOAT:this._offsetsCache[T]=y-b;break;case ae.ANIMATIONTYPE_QUATERNION:this._offsetsCache[T]=y.subtract(b);break;case ae.ANIMATIONTYPE_VECTOR3:this._offsetsCache[T]=y.subtract(b);break;case ae.ANIMATIONTYPE_VECTOR2:this._offsetsCache[T]=y.subtract(b);break;case ae.ANIMATIONTYPE_SIZE:this._offsetsCache[T]=y.subtract(b);break;case ae.ANIMATIONTYPE_COLOR3:this._offsetsCache[T]=y.subtract(b);break}this._highLimitsCache[T]=y}f=this._highLimitsCache[T],u=this._offsetsCache[T]}if(u===void 0)switch(a.dataType){case ae.ANIMATIONTYPE_FLOAT:u=0;break;case ae.ANIMATIONTYPE_QUATERNION:u=wb;break;case ae.ANIMATIONTYPE_VECTOR3:u=Fb;break;case ae.ANIMATIONTYPE_VECTOR2:u=Lb;break;case ae.ANIMATIONTYPE_SIZE:u=Bb;break;case ae.ANIMATIONTYPE_COLOR3:u=Ub}let _;if(this._host&&this._host.syncRoot){const T=this._host.syncRoot,b=(T.masterFrame-T.fromFrame)/(T.toFrame-T.fromFrame);_=t+(i-t)*b}else d>0&&t>i||d<0&&t<i?_=c&&h!==0?i+d%h:t:_=c&&h!==0?t+d%h:i;const p=this._events;if(s>0&&this.currentFrame>_||s<0&&this.currentFrame<_){this._onLoop();for(let T=0;T<p.length;T++)p[T].onlyOnce||(p[T].isDone=!1);this._animationState.key=s>0?0:a.getKeys().length-1}this._currentFrame=_,this._animationState.repeatCount=h===0?0:d/h>>0,this._animationState.highLimitValue=f,this._animationState.offsetValue=u;const m=a._interpolate(_,this._animationState);if(this.setValue(m,n),p.length){for(let T=0;T<p.length;T++)if(h>0&&_>=p[T].frame&&p[T].frame>=t||h<0&&_<=p[T].frame&&p[T].frame<=t){const b=p[T];b.isDone||(b.onlyOnce&&(p.splice(T,1),T--),b.isDone=!0,b.action(_))}}return c||(this._stopped=!0),c}}function Ar(){return typeof window<"u"}function eT(){return typeof navigator<"u"}function fu(){return typeof document<"u"}function cf(o){let e="",t=o.firstChild;for(;t;)t.nodeType===3&&(e+=t.textContent),t=t.nextSibling;return e}const k_={IsWindowObjectExist:Ar,IsNavigatorAvailable:eT,IsDocumentAvailable:fu,GetDOMTextContent:cf};class Us{static get Now(){return k_.IsWindowObjectExist()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}class Hh{}Hh.FilesToLoad={};class kb{static ExponentialBackoff(e=3,t=500){return(i,r,s)=>r.status!==0||s>=e||i.indexOf("file:")!==-1?-1:Math.pow(2,s)*t}}class rh extends Error{}rh._setPrototypeOf=Object.setPrototypeOf||((o,e)=>(o.__proto__=e,o));const Wo={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002};class Wa extends rh{constructor(e,t,i){super(e),this.errorCode=t,this.innerError=i,this.name="RuntimeError",rh._setPrototypeOf(this,Wa.prototype)}}const Gb=o=>{if(typeof TextDecoder<"u")return new TextDecoder().decode(o);let e="";for(let t=0;t<o.byteLength;t++)e+=String.fromCharCode(o[t]);return e},tT=o=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let t="",i,r,s,n,a,l,c,h=0;const u=ArrayBuffer.isView(o)?new Uint8Array(o.buffer,o.byteOffset,o.byteLength):new Uint8Array(o);for(;h<u.length;)i=u[h++],r=h<u.length?u[h++]:Number.NaN,s=h<u.length?u[h++]:Number.NaN,n=i>>2,a=(i&3)<<4|r>>4,l=(r&15)<<2|s>>6,c=s&63,isNaN(r)?l=c=64:isNaN(s)&&(c=64),t+=e.charAt(n)+e.charAt(a)+e.charAt(l)+e.charAt(c);return t},iT=o=>atob(o),zb=o=>{const e=iT(o),t=e.length,i=new Uint8Array(new ArrayBuffer(t));for(let r=0;r<t;r++)i[r]=e.charCodeAt(r);return i.buffer},Hb="attribute",Wb="varying";class Wh{constructor(){this.children=[]}isValid(e){return!0}process(e,t){var i,r,s,n,a,l;let c="";if(this.line){let h=this.line;const u=t.processor;if(u){u.lineProcessor&&(h=u.lineProcessor(h,t.isFragment,t.processingContext));const d=(r=(i=t.processor)===null||i===void 0?void 0:i.attributeKeywordName)!==null&&r!==void 0?r:Hb,f=t.isFragment&&(!((s=t.processor)===null||s===void 0)&&s.varyingFragmentKeywordName)?(n=t.processor)===null||n===void 0?void 0:n.varyingFragmentKeywordName:!t.isFragment&&(!((a=t.processor)===null||a===void 0)&&a.varyingVertexKeywordName)?(l=t.processor)===null||l===void 0?void 0:l.varyingVertexKeywordName:Wb;!t.isFragment&&u.attributeProcessor&&this.line.startsWith(d)?h=u.attributeProcessor(this.line,e,t.processingContext):u.varyingProcessor&&this.line.startsWith(f)?h=u.varyingProcessor(this.line,t.isFragment,e,t.processingContext):u.uniformProcessor&&u.uniformRegexp&&u.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(h=u.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):u.uniformBufferProcessor&&u.uniformBufferRegexp&&u.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(h=u.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):u.textureProcessor&&u.textureRegexp&&u.textureRegexp.test(this.line)?h=u.textureProcessor(this.line,t.isFragment,e,t.processingContext):(u.uniformProcessor||u.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?u.uniformProcessor&&(h=u.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):u.uniformBufferProcessor&&(h=u.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(t.lookForClosingBracketForUniformBuffer=!1,u.endOfUniformBufferProcessor&&(h=u.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}c+=h+`\r
`}return this.children.forEach(h=>{c+=h.process(e,t)}),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),c}}class Xb{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if(t[0]==="#"){this._lines.push(t);continue}if(t.trim().startsWith("//")){this._lines.push(t);continue}const i=t.split(";");for(let r=0;r<i.length;r++){let s=i[r];s=s.trim(),s&&this._lines.push(s+(r!==i.length-1?";":""))}}}}class f_ extends Wh{process(e,t){for(let i=0;i<this.children.length;i++){const r=this.children[i];if(r.isValid(e))return r.process(e,t)}return""}}class Yb extends Wh{isValid(e){return this.testExpression.isTrue(e)}}class xn{isTrue(e){return!0}static postfixToInfix(e){const t=[];for(const i of e)if(xn._OperatorPriority[i]===void 0)t.push(i);else{const r=t[t.length-1],s=t[t.length-2];t.length-=2,t.push(`(${s}${i}${r})`)}return t[t.length-1]}static infixToPostfix(e){const t=[];let i=-1;const r=()=>{c=c.trim(),c!==""&&(t.push(c),c="")},s=h=>{i<xn._Stack.length-1&&(xn._Stack[++i]=h)},n=()=>xn._Stack[i],a=()=>i===-1?"!!INVALID EXPRESSION!!":xn._Stack[i--];let l=0,c="";for(;l<e.length;){const h=e.charAt(l),u=l<e.length-1?e.substr(l,2):"";if(h==="(")c="",s(h);else if(h===")"){for(r();i!==-1&&n()!=="(";)t.push(a());a()}else if(xn._OperatorPriority[u]>1){for(r();i!==-1&&xn._OperatorPriority[n()]>=xn._OperatorPriority[u];)t.push(a());s(u),l++}else c+=h;l++}for(r();i!==-1;)n()==="("?a():t.push(a());return t}}xn._OperatorPriority={")":0,"(":1,"||":2,"&&":3};xn._Stack=["","","","","","","","","","","","","","","","","","","",""];class bd extends xn{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=e[this.define]!==void 0;return this.not&&(t=!t),t}}class jb extends xn{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class Kb extends xn{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class qb extends xn{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}isTrue(e){let t=e[this.define];t===void 0&&(t=this.define);let i=!1;const r=parseInt(t),s=parseInt(this.testValue);switch(this.operand){case">":i=r>s;break;case"<":i=r<s;break;case"<=":i=r<=s;break;case">=":i=r>=s;break;case"==":i=r===s;break}return i}}var Gi;(function(o){o[o.GLSL=0]="GLSL",o[o.WGSL=1]="WGSL"})(Gi||(Gi={}));const Qb=/defined\s*?\((.+?)\)/g,__=/defined\s*?\[(.+?)\]/g,Yg=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g;class uo{static Initialize(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)}static Process(e,t,i,r){var s;!((s=t.processor)===null||s===void 0)&&s.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,n=>{t.processCodeAfterIncludes&&(n=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",n));const a=this._ProcessShaderConversion(n,t,r);i(a,n)})}static PreProcess(e,t,i,r){var s;!((s=t.processor)===null||s===void 0)&&s.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,n=>{t.processCodeAfterIncludes&&(n=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",n));const a=this._ApplyPreProcessing(n,t,r);i(a,n)})}static Finalize(e,t,i){return!i.processor||!i.processor.finalizeShaders?{vertexCode:e,fragmentCode:t}:i.processor.finalizeShaders(e,t,i.processingContext)}static _ProcessPrecision(e,t){var i;if(!((i=t.processor)===null||i===void 0)&&i.noPrecision)return e;const r=t.shouldUseHighPrecisionShader;return e.indexOf("precision highp float")===-1?r?e=`precision highp float;
`+e:e=`precision mediump float;
`+e:r||(e=e.replace("precision highp float","precision mediump float")),e}static _ExtractOperation(e){const i=/defined\((.+)\)/.exec(e);if(i&&i.length)return new bd(i[1].trim(),e[0]==="!");const r=["==",">=","<=","<",">"];let s="",n=0;for(s of r)if(n=e.indexOf(s),n>-1)break;if(n===-1)return new bd(e);const a=e.substring(0,n).trim(),l=e.substring(n+s.length).trim();return new qb(a,s,l)}static _BuildSubExpression(e){e=e.replace(Qb,"defined[$1]");const t=xn.infixToPostfix(e),i=[];for(const s of t)if(s!=="||"&&s!=="&&")i.push(s);else if(i.length>=2){let n=i[i.length-1],a=i[i.length-2];i.length-=2;const l=s=="&&"?new Kb:new jb;typeof n=="string"&&(n=n.replace(__,"defined($1)")),typeof a=="string"&&(a=a.replace(__,"defined($1)")),l.leftOperand=typeof a=="string"?this._ExtractOperation(a):a,l.rightOperand=typeof n=="string"?this._ExtractOperation(n):n,i.push(l)}let r=i[i.length-1];return typeof r=="string"&&(r=r.replace(__,"defined($1)")),typeof r=="string"?this._ExtractOperation(r):r}static _BuildExpression(e,t){const i=new Yb,r=e.substring(0,t);let s=e.substring(t);return s=s.substring(0,(s.indexOf("//")+1||s.length+1)-1).trim(),r==="#ifdef"?i.testExpression=new bd(s):r==="#ifndef"?i.testExpression=new bd(s,!0):i.testExpression=this._BuildSubExpression(s),i}static _MoveCursorWithinIf(e,t,i){let r=e.currentLine;for(;this._MoveCursor(e,i);){r=e.currentLine;const s=r.substring(0,5).toLowerCase();if(s==="#else"){const n=new Wh;t.children.push(n),this._MoveCursor(e,n);return}else if(s==="#elif"){const n=this._BuildExpression(r,5);t.children.push(n),i=n}}}static _MoveCursor(e,t){for(;e.canRead;){e.lineIndex++;const i=e.currentLine,s=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/.exec(i);if(s&&s.length)switch(s[0]){case"#ifdef":{const a=new f_;t.children.push(a);const l=this._BuildExpression(i,6);a.children.push(l),this._MoveCursorWithinIf(e,a,l);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const a=new f_;t.children.push(a);const l=this._BuildExpression(i,7);a.children.push(l),this._MoveCursorWithinIf(e,a,l);break}case"#if":{const a=new f_,l=this._BuildExpression(i,3);t.children.push(a),a.children.push(l),this._MoveCursorWithinIf(e,a,l);break}}else{const n=new Wh;if(n.line=i,t.children.push(n),i[0]==="#"&&i[1]==="d"){const a=i.replace(";","").split(" ");n.additionalDefineKey=a[1],a.length===3&&(n.additionalDefineValue=a[2])}}}return!1}static _EvaluatePreProcessors(e,t,i){const r=new Wh,s=new Xb;return s.lineIndex=-1,s.lines=e.split(`
`),this._MoveCursor(s,r),r.process(t,i)}static _PreparePreProcessors(e,t){var i;const r=e.defines,s={};for(const n of r){const l=n.replace("#define","").replace(";","").trim().split(" ");s[l[0]]=l.length>1?l[1]:""}return((i=e.processor)===null||i===void 0?void 0:i.shaderLanguage)===Gi.GLSL&&(s.GL_ES="true"),s.__VERSION__=e.version,s[e.platformName]="true",t._getGlobalDefines(s),s}static _ProcessShaderConversion(e,t,i){let r=this._ProcessPrecision(e,t);if(!t.processor||t.processor.shaderLanguage===Gi.GLSL&&r.indexOf("#version 3")!==-1&&(r=r.replace("#version 300 es",""),!t.processor.parseGLES3))return r;const s=t.defines,n=this._PreparePreProcessors(t,i);return t.processor.preProcessor&&(r=t.processor.preProcessor(r,s,t.isFragment,t.processingContext)),r=this._EvaluatePreProcessors(r,n,t),t.processor.postProcessor&&(r=t.processor.postProcessor(r,s,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(r=i.inlineShaderCode(r)),r}static _ApplyPreProcessing(e,t,i){var r,s;let n=e;const a=t.defines,l=this._PreparePreProcessors(t,i);return!((r=t.processor)===null||r===void 0)&&r.preProcessor&&(n=t.processor.preProcessor(n,a,t.isFragment,t.processingContext)),n=this._EvaluatePreProcessors(n,l,t),!((s=t.processor)===null||s===void 0)&&s.postProcessor&&(n=t.processor.postProcessor(n,a,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(n=i.inlineShaderCode(n)),n}static _ProcessIncludes(e,t,i){let r=Yg.exec(e),s=new String(e),n=!1;for(;r!=null;){let a=r[1];if(a.indexOf("__decl__")!==-1&&(a=a.replace(/__decl__/,""),t.supportsUniformBuffers&&(a=a.replace(/Vertex/,"Ubo"),a=a.replace(/Fragment/,"Ubo")),a=a+"Declaration"),t.includesShadersStore[a]){let l=t.includesShadersStore[a];if(r[2]){const c=r[3].split(",");for(let h=0;h<c.length;h+=2){const u=new RegExp(c[h],"g"),d=c[h+1];l=l.replace(u,d)}}if(r[4]){const c=r[5];if(c.indexOf("..")!==-1){const h=c.split(".."),u=parseInt(h[0]);let d=parseInt(h[1]),f=l.slice(0);l="",isNaN(d)&&(d=t.indexParameters[h[1]]);for(let _=u;_<d;_++)t.supportsUniformBuffers||(f=f.replace(/light\{X\}.(\w*)/g,(p,m)=>m+"{X}")),l+=f.replace(/\{X\}/g,_.toString())+`
`}else t.supportsUniformBuffers||(l=l.replace(/light\{X\}.(\w*)/g,(h,u)=>u+"{X}")),l=l.replace(/\{X\}/g,c)}s=s.replace(r[0],l),n=n||l.indexOf("#include<")>=0||l.indexOf("#include <")>=0}else{const l=t.shadersRepository+"ShadersInclude/"+a+".fx";uo._FileToolsLoadFile(l,c=>{t.includesShadersStore[a]=c,this._ProcessIncludes(s,t,i)});return}r=Yg.exec(e)}n?this._ProcessIncludes(s.toString(),t,i):i(s)}static _FileToolsLoadFile(e,t,i,r,s,n){throw pt("FileTools")}}class te{static GetShadersRepository(e=Gi.GLSL){return e===Gi.GLSL?te.ShadersRepository:te.ShadersRepositoryWGSL}static GetShadersStore(e=Gi.GLSL){return e===Gi.GLSL?te.ShadersStore:te.ShadersStoreWGSL}static GetIncludesShadersStore(e=Gi.GLSL){return e===Gi.GLSL?te.IncludesShadersStore:te.IncludesShadersStoreWGSL}}te.ShadersRepository="src/Shaders/";te.ShadersStore={};te.IncludesShadersStore={};te.ShadersRepositoryWGSL="src/ShadersWGSL/";te.ShadersStoreWGSL={};te.IncludesShadersStoreWGSL={};class ri{static get ShadersRepository(){return te.ShadersRepository}static set ShadersRepository(e){te.ShadersRepository=e}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new Q),this._onBindObservable}constructor(e,t,i,r=null,s,n=null,a=null,l=null,c=null,h,u="",d=Gi.GLSL){var f,_,p;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new Q,this.onErrorObservable=new Q,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!1,this._wasPreviouslyUsingInstances=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this.name=e,this._key=u;let m,T=null;if(t.attributes){const w=t;if(this._engine=i,this._attributesNames=w.attributes,this._uniformsNames=w.uniformsNames.concat(w.samplers),this._samplerList=w.samplers.slice(),this.defines=w.defines,this.onError=w.onError,this.onCompiled=w.onCompiled,this._fallbacks=w.fallbacks,this._indexParameters=w.indexParameters,this._transformFeedbackVaryings=w.transformFeedbackVaryings||null,this._multiTarget=!!w.multiTarget,this._shaderLanguage=(f=w.shaderLanguage)!==null&&f!==void 0?f:Gi.GLSL,w.uniformBuffersNames){this._uniformBuffersNamesList=w.uniformBuffersNames.slice();for(let L=0;L<w.uniformBuffersNames.length;L++)this._uniformBuffersNames[w.uniformBuffersNames[L]]=L}T=(_=w.processFinalCode)!==null&&_!==void 0?_:null,m=(p=w.processCodeAfterIncludes)!==null&&p!==void 0?p:void 0}else this._engine=s,this.defines=n??"",this._uniformsNames=i.concat(r),this._samplerList=r?r.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=d,this.onError=c,this.onCompiled=l,this._indexParameters=h,this._fallbacks=a;this._attributeLocationByName={},this.uniqueId=ri._UniqueIdSeed++;let b,y;const S=Ar()?this._engine.getHostDocument():null;e.vertexSource?b="source:"+e.vertexSource:e.vertexElement?(b=S?S.getElementById(e.vertexElement):null,b||(b=e.vertexElement)):b=e.vertex||e,e.fragmentSource?y="source:"+e.fragmentSource:e.fragmentElement?(y=S?S.getElementById(e.fragmentElement):null,y||(y=e.fragmentElement)):y=e.fragment||e,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);let C={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:te.GetShadersRepository(this._shaderLanguage),includesShadersStore:te.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:m};const I=[void 0,void 0],P=()=>{if(I[0]&&I[1]){C.isFragment=!0;const[w,L]=I;uo.Process(L,C,(U,G)=>{this._fragmentSourceCodeBeforeMigration=G,T&&(U=T("fragment",U));const Z=uo.Finalize(w,U,C);C=null,this._useFinalCode(Z.vertexCode,Z.fragmentCode,e)},this._engine)}};this._loadShader(b,"Vertex","",w=>{uo.Initialize(C),uo.Process(w,C,(L,U)=>{this._rawVertexSourceCode=w,this._vertexSourceCodeBeforeMigration=U,T&&(L=T("vertex",L)),I[0]=L,P()},this._engine)}),this._loadShader(y,"Fragment","Pixel",w=>{this._rawFragmentSourceCode=w,I[1]=w,P()});const D=function(w){return function(){return this._pipelineContext&&this._pipelineContext[w].apply(this._pipelineContext,arguments),this}};["Int?","UInt?","IntArray?","UIntArray?","Array?","Color?","Vector?","Float?","Matrices","Matrix","Matrix3x3","Matrix2x2","Quaternion","DirectColor4"].forEach(w=>{const L=`set${w}`;L.endsWith("?")?["",2,3,4].forEach(U=>{this[L.slice(0,-1)+U]=this[L.slice(0,-1)+U]||D(L.slice(0,-1)+U).bind(this)}):this[L]=this[L]||D(L).bind(this)})}_useFinalCode(e,t,i){if(i){const r=i.vertexElement||i.vertex||i.spectorName||i,s=i.fragmentElement||i.fragment||i.spectorName||i;this._vertexSourceCode=(this._shaderLanguage===Gi.WGSL?"//":"")+"#define SHADER_NAME vertex:"+r+`
`+e,this._fragmentSourceCode=(this._shaderLanguage===Gi.WGSL?"//":"")+"#define SHADER_NAME fragment:"+s+`
`+t}else this._vertexSourceCode=e,this._fragmentSourceCode=t;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16)}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){this._processCompilationErrors(t,e);return}this._isDisposed||setTimeout(()=>{this._checkIsReady(e)},16)}_loadShader(e,t,i,r){if(typeof HTMLElement<"u"&&e instanceof HTMLElement){const a=cf(e);r(a);return}if(e.substr(0,7)==="source:"){r(e.substr(7));return}if(e.substr(0,7)==="base64:"){const a=window.atob(e.substr(7));r(a);return}const s=te.GetShadersStore(this._shaderLanguage);if(s[e+t+"Shader"]){r(s[e+t+"Shader"]);return}if(i&&s[e+i+"Shader"]){r(s[e+i+"Shader"]);return}let n;e[0]==="."||e[0]==="/"||e.indexOf("http")>-1?n=e:n=te.GetShadersRepository(this._shaderLanguage)+e,this._engine._loadFile(n+"."+t.toLowerCase()+".fx",r)}get vertexSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getVertexShaderCode())!==null&&t!==void 0?t:this._vertexSourceCode}get fragmentSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getFragmentShaderCode())!==null&&t!==void 0?t:this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}_rebuildProgram(e,t,i,r){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(s,n)=>{r&&r(n)},this.onCompiled=()=>{const s=this.getEngine().scenes;if(s)for(let n=0;n<s.length;n++)s[n].markAllMaterialsAsDirty(63);this._pipelineContext._handlesSpectorRebuildCallback(i)},this._fallbacks=null,this._prepareEffect()}_prepareEffect(){const e=this._attributesNames,t=this.defines,i=this._pipelineContext;this._isReady=!1;try{const r=this._engine;this._pipelineContext=r.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key;const s=this._rebuildProgram.bind(this);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?r._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,s,null,this._transformFeedbackVaryings,this._key):r._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,s,t,this._transformFeedbackVaryings,this._key),r._executeWhenRenderingStateIsCompiled(this._pipelineContext,()=>{if(this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,e,this._attributes),e)for(let n=0;n<e.length;n++){const a=e[n];this._attributeLocationByName[a]=this._attributes[n]}r.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),i&&this.getEngine()._deletePipelineContext(i)}),this._pipelineContext.isAsync&&this._checkIsReady(i)}catch(r){this._processCompilationErrors(r,i)}}_getShaderCodeAndErrorLine(e,t,i){const r=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let s=null;if(t&&e){const n=t.match(r);if(n&&n.length===2){const a=parseInt(n[1]),l=e.split(`
`,-1);l.length>=a&&(s=`Offending line [${a}] in ${i?"fragment":"vertex"} code: ${l[a-1]}`)}}return[e,s]}_processCompilationErrors(e,t=null){var i,r,s;this._compilationError=e.message;const n=this._attributesNames,a=this._fallbacks;if(X.Error("Unable to compile effect:"),X.Error("Uniforms: "+this._uniformsNames.map(function(c){return" "+c})),X.Error("Attributes: "+n.map(function(c){return" "+c})),X.Error(`Defines:\r
`+this.defines),ri.LogShaderCodeOnCompilationError){let c=null,h=null,u=null;!((i=this._pipelineContext)===null||i===void 0)&&i._getVertexShaderCode()&&([u,c]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),u&&(X.Error("Vertex code:"),X.Error(u))),!((r=this._pipelineContext)===null||r===void 0)&&r._getFragmentShaderCode()&&([u,h]=this._getShaderCodeAndErrorLine((s=this._pipelineContext)===null||s===void 0?void 0:s._getFragmentShaderCode(),this._compilationError,!0),u&&(X.Error("Fragment code:"),X.Error(u))),c&&X.Error(c),h&&X.Error(h)}X.Error("Error: "+this._compilationError);const l=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)};t&&(this._pipelineContext=t,this._isReady=!0,l()),a?(this._pipelineContext=null,a.hasMoreFallbacks?(this._allFallbacksProcessed=!1,X.Error("Trying next fallback."),this.defines=a.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,l(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||l())}get isSupported(){return this._compilationError===""}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setDepthStencilTexture(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){const i=e+"Ex";if(this._samplerList.indexOf(i+"0")===-1){const r=this._samplerList.indexOf(e);for(let n=1;n<t.length;n++){const a=i+(n-1).toString();this._samplerList.splice(r+n,0,a)}let s=0;for(const n of this._samplerList)this._samplers[n]=s,s+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}setTextureFromPostProcess(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)}setTextureFromPostProcessOutput(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)}bindUniformBuffer(e,t){const i=this._uniformBuffersNames[t];i===void 0||ri._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(ri._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}dispose(){var e;(e=this._pipelineContext)===null||e===void 0||e.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0}static RegisterShader(e,t,i,r=Gi.GLSL){t&&(te.GetShadersStore(r)[`${e}PixelShader`]=t),i&&(te.GetShadersStore(r)[`${e}VertexShader`]=i)}static ResetCache(){ri._BaseCache={}}}ri.LogShaderCodeOnCompilationError=!0;ri._UniqueIdSeed=0;ri._BaseCache={};ri.ShadersStore=te.ShadersStore;ri.IncludesShadersStore=te.IncludesShadersStore;class rT{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}class Go{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=Go.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=Go.KEEP,this.opDepthFail=Go.KEEP,this.opStencilDepthPass=Go.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}Go.ALWAYS=519;Go.KEEP=7680;Go.REPLACE=7681;class Zb{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,i,r){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===r||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=r,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,i,r){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===r||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=r,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}}class sT{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,i=1,r=1,s=2,n=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=r,this.samplingMode=s,this._comparisonFunction=n,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}var bt;(function(o){o[o.Unknown=0]="Unknown",o[o.Url=1]="Url",o[o.Temp=2]="Temp",o[o.Raw=3]="Raw",o[o.Dynamic=4]="Dynamic",o[o.RenderTarget=5]="RenderTarget",o[o.MultiRenderTarget=6]="MultiRenderTarget",o[o.Cube=7]="Cube",o[o.CubeRaw=8]="CubeRaw",o[o.CubePrefiltered=9]="CubePrefiltered",o[o.Raw3D=10]="Raw3D",o[o.Raw2DArray=11]="Raw2DArray",o[o.DepthStencil=12]="DepthStencil",o[o.CubeRawRGBD=13]="CubeRawRGBD",o[o.Depth=14]="Depth"})(bt||(bt={}));class hi extends sT{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(e,t,i=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new Q,this.onErrorObservable=new Q,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=bt.Unknown,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._engine=e,this._source=t,this._uniqueId=hi._Counter++,i||(this._hardwareTexture=e._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,t,i=1){this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i}_rebuild(){var e;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const i=this.onRebuildCallback(this),r=s=>{s._swapAndDie(this,!1),this.isReady=i.isReady};i.isAsync?i.proxy.then(r):r(i.proxy);return}let t;switch(this.source){case bt.Temp:break;case bt.Url:t=this._engine.createTexture((e=this._originalUrl)!==null&&e!==void 0?e:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,i=>{i._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case bt.Raw:t=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer),t._swapAndDie(this,!1),this.isReady=!0;break;case bt.Raw3D:t=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case bt.Raw2DArray:t=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case bt.Dynamic:t=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),t._swapAndDie(this,!1),this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);break;case bt.Cube:t=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{t._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer);return;case bt.CubeRaw:t=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),t._swapAndDie(this,!1),this.isReady=!0;break;case bt.CubeRawRGBD:return;case bt.CubePrefiltered:t=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,i=>{i&&i._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),t._sphericalPolynomial=this._sphericalPolynomial;return}}_swapAndDie(e,t=!0){var i;(i=this._hardwareTexture)===null||i===void 0||i.setUsage(e._source,this.generateMipMaps,this.isCube,this.width,this.height),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);const r=this._engine.getLoadedTexturesCache();let s=r.indexOf(this);s!==-1&&r.splice(s,1),s=r.indexOf(e),s===-1&&r.push(e)}dispose(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._references===0&&(this._engine._releaseTexture(this),this._hardwareTexture=null)}}hi._Counter=0;class Jb{constructor(){this.shaderLanguage=Gi.GLSL}postProcessor(e,t,i,r,s){if(!s.getCaps().drawBuffersExtension){const n=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(n,"")}return e}}class nT{constructor(){this.shaderLanguage=Gi.GLSL}attributeProcessor(e){return e.replace("attribute","in")}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const r=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,s=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(s,""),e=e.replace(/texture2D\s*\(/g,"texture("),i)e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(r?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(");else if(t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}}class _c{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=_c._Counter++}}_c._Counter=0;class _u extends _c{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}const eS=["Int","Int2","Int3","Int4","UInt","UInt2","UInt3","UInt4","Vector2","Vector3","Vector4","Float2","Float","Float3","Float4","Quaternion","Color3","Color4","DirectColor4"];class tS{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null;const e=[],t=function(){e.length=0,Array.prototype.push.apply(e,arguments),e[0]=this._uniforms[e[0]]},i=r=>{const s=eS.includes(r.substring(3))&&"FloatN";if(s){const n=this[`_cache${s}`];return function(){const a=this.engine[r];t.apply(this,arguments),n.apply(this,arguments)&&(a.apply(this.engine,e)||(this._valueCache[arguments[0]]=null))}}else return function(){const n=this.engine[r];t.apply(this,arguments),arguments[1]!==void 0&&(this._valueCache[arguments[0]]=null,n.apply(this.engine,e))}};["Int?","UInt?","IntArray?","UIntArray?","Array?","Float?","Matrices","Matrix3x3","Matrix2x2"].forEach(r=>{const s=`set${r}`;this[s]||(s.endsWith("?")?["",2,3,4].forEach(n=>{this[s.slice(0,-1)+n]=this[s.slice(0,-1)+n]||i(s.slice(0,-1)+n).bind(this)}):this[s]=this[s]||i(s).bind(this))})}get isAsync(){return this.isParallelCompiled}get isReady(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}_fillEffectInformation(e,t,i,r,s,n,a,l){const c=this.engine;if(c.supportsUniformBuffers)for(const d in t)e.bindUniformBlock(d,t[d]);this.engine.getUniforms(this,i).forEach((d,f)=>{r[i[f]]=d}),this._uniforms=r;let u;for(u=0;u<s.length;u++)e.getUniform(s[u])==null&&(s.splice(u,1),u--);s.forEach((d,f)=>{n[d]=f});for(const d of c.getAttributes(this,a))l.push(d)}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],r=t.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[e]=r,!0)}_cacheFloatN(e,t,i,r,s){let n=this._valueCache[arguments[0]];if(!n||n.length!==arguments.length-1)return n=Array.prototype.slice.call(arguments,1),this._valueCache[arguments[0]]=n,!0;let a=!1;for(let l=0;l<n.length;++l)n[l]!==arguments[l+1]&&(n[l]=arguments[l+1],a=!0);return a}_cacheFloat2(e,t,i){return this._cacheFloatN(e,t,i)}_cacheFloat3(e,t,i,r){return this._cacheFloatN(e,t,i,r)}_cacheFloat4(e,t,i,r,s){return this._cacheFloatN(e,t,i,r,s)}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}class hf{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffer=null,this._context=t,!e&&(e=t.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffer=null}release(){this._MSAARenderBuffer&&(this._context.deleteRenderbuffer(this._MSAARenderBuffer),this._MSAARenderBuffer=null),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}class vs{static IsWrapper(e){return e.getPipelineContext===void 0}static GetEffect(e){return e.getPipelineContext===void 0?e.effect:e}constructor(e,t=!0){this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,i=!0){var r;this.effect=e,t!==void 0&&(this.defines=t),i&&((r=this.drawContext)===null||r===void 0||r.reset())}dispose(){var e;(e=this.drawContext)===null||e===void 0||e.dispose()}}class aT{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){var e;this.stencilMaterial=void 0,(e=this.stencilGlobal)===null||e===void 0||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){var t;if(!e)return;const i=!this.useStencilGlobalOnly&&!!(!((t=this.stencilMaterial)===null||t===void 0)&&t.enabled);this.enabled=i?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=i?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=i?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=i?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=i?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=i?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=i?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=i?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}}class iS{}class ze{static get NpmPackage(){return"babylonjs@5.48.0"}static get Version(){return"5.48.0"}get description(){let e=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}static get ShadersRepository(){return ri.ShadersRepository}static set ShadersRepository(e){ri.ShadersRepository=e}_getShaderProcessor(e){return this._shaderProcessor}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)}get frameId(){return this._frameId}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}getCreationOptions(){return this._creationOptions}get _shouldUseHighPrecisionShader(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get activeRenderLoops(){return this._activeRenderLoops}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}get currentViewport(){return this._cachedViewport}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get isWebGPU(){return this._isWebGPU}get shaderPlatformName(){return this._shaderPlatformName}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return this._snapshotRenderingMode}set snapshotRenderingMode(e){this._snapshotRenderingMode=e}get useExactSrgbConversions(){return this._useExactSrgbConversions}snapshotRenderingReset(){this.snapshotRendering=!1}static _CreateCanvas(e,t){if(typeof document>"u")return new OffscreenCanvas(e,t);const i=document.createElement("canvas");return i.width=e,i.height=t,i}createCanvas(e,t){return ze._CreateCanvas(e,t)}createCanvasImage(){return document.createElement("img")}constructor(e,t,i,r){var s,n,a,l,c,h,u,d,f,_,p;this._name="WebGL",this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new Q,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new Q,this.onContextRestoredObservable=new Q,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new rT,this._stencilStateComposer=new aT,this._stencilState=new Go,this._alphaState=new Zb,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=new Array,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new Q,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._useExactSrgbConversions=!1,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},this.startTime=Us.Now;let m=null;i=i||{},this._creationOptions=i,this.adaptToDeviceRatio=r??!1,this._stencilStateComposer.stencilGlobal=this._stencilState,ms.SetMatrixPrecision(!!i.useHighPrecisionMatrix),i.antialias=t??i.antialias,i.deterministicLockstep=(s=i.deterministicLockstep)!==null&&s!==void 0?s:!1,i.lockstepMaxSteps=(n=i.lockstepMaxSteps)!==null&&n!==void 0?n:4,i.timeStep=(a=i.timeStep)!==null&&a!==void 0?a:1/60,i.audioEngine=(l=i.audioEngine)!==null&&l!==void 0?l:!0,i.stencil=(c=i.stencil)!==null&&c!==void 0?c:!0,this._audioContext=(u=(h=i.audioEngineOptions)===null||h===void 0?void 0:h.audioContext)!==null&&u!==void 0?u:null,this._audioDestination=(f=(d=i.audioEngineOptions)===null||d===void 0?void 0:d.audioDestination)!==null&&f!==void 0?f:null,this.premultipliedAlpha=(_=i.premultipliedAlpha)!==null&&_!==void 0?_:!0,this._useExactSrgbConversions=(p=i.useExactSrgbConversions)!==null&&p!==void 0?p:!1,this._doNotHandleContextLost=!!i.doNotHandleContextLost,this._isStencilEnable=!!i.stencil,r=r||i.adaptToDeviceRatio||!1;const T=Ar()&&window.devicePixelRatio||1,b=i.limitDeviceRatio||T;if(this._hardwareScalingLevel=r?1/Math.min(b,T):1,this._lastDevicePixelRatio=T,!e)return;if(e.getContext){if(m=e,this._renderingCanvas=m,i.preserveDrawingBuffer===void 0&&(i.preserveDrawingBuffer=!1),i.xrCompatible===void 0&&(i.xrCompatible=!0),navigator&&navigator.userAgent){this._setupMobileChecks();const S=navigator.userAgent;for(const C of ze.ExceptionList){const I=C.key,P=C.targets;if(new RegExp(I).test(S)){if(C.capture&&C.captureConstraint){const w=C.capture,L=C.captureConstraint,G=new RegExp(w).exec(S);if(G&&G.length>0&&parseInt(G[G.length-1])>=L)continue}for(const w of P)switch(w){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":i.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost||(this._onContextLost=S=>{S.preventDefault(),this._contextWasLost=!0,X.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(this._initGLContext.bind(this))},m.addEventListener("webglcontextlost",this._onContextLost,!1),m.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference="high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=m.getContext("webgl2",i)||m.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!m)throw new Error("The provided canvas is null or undefined.");try{this._gl=m.getContext("webgl",i)||m.getContext("experimental-webgl",i)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const S=this._gl.getContextAttributes();S&&(i.stencil=S.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),i.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let S=0;S<this._caps.maxVertexAttribs;S++)this._currentBufferPointers[S]=new iS;this._shaderProcessor=this.webGLVersion>1?new nT:new Jb,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);const y=`Babylon.js v${ze.Version}`;console.log(y+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",y)}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{const e=navigator.userAgent;this.hostInformation.isMobile=e.indexOf("Mobile")!==-1||e.indexOf("Mac")!==-1&&fu()&&"ontouchend"in document},this._checkForMobile(),Ar()&&window.addEventListener("resize",this._checkForMobile))}_restoreEngineAfterContextLost(e){setTimeout(async()=>{var t;this._dummyFramebuffer=null;const i=this._depthCullingState.depthTest,r=this._depthCullingState.depthFunc,s=this._depthCullingState.depthMask,n=this._stencilState.stencilTest;await e(),this.wipeCaches(!0),this._rebuildEffects(),(t=this._rebuildComputeEffects)===null||t===void 0||t.call(this),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0),this._depthCullingState.depthTest=i,this._depthCullingState.depthFunc=r,this._depthCullingState.depthMask=s,this._stencilState.stencilTest=n,X.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1},0)}_sharedInit(e){this._renderingCanvas=e}_getShaderProcessingContext(e){return null}_rebuildInternalTextures(){const e=this._internalTexturesCache.slice();for(const t of e)t._rebuild()}_rebuildRenderTargetWrappers(){const e=this._renderTargetWrapperCache.slice();for(const t of e)t._rebuild()}_rebuildEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}ri.ResetCache()}areAllEffectsReady(){for(const e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_rebuildBuffers(){for(const e of this._uniformBuffers)e._rebuild();for(const e of this._storageBuffers)e._rebuild()}_initGLContext(){var e;this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128},this._glVersion=this._gl.getParameter(this._gl.VERSION);const t=this._gl.getExtension("WEBGL_debug_renderer_info");if(t!=null&&(this._glRenderer=this._gl.getParameter(t.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(t.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=((e=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))!==null&&e!==void 0?e:0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{const i=this._gl.getExtension("WEBGL_draw_buffers");if(i!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=i.drawBuffersWEBGL.bind(i),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let r=0;r<16;r++)this._gl["COLOR_ATTACHMENT"+r+"_WEBGL"]=i["COLOR_ATTACHMENT"+r+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const i=this._gl.getExtension("WEBGL_depth_texture");i!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=i.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const i=this._gl.getExtension("OES_vertex_array_object");i!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=i.createVertexArrayOES.bind(i),this._gl.bindVertexArray=i.bindVertexArrayOES.bind(i),this._gl.deleteVertexArray=i.deleteVertexArrayOES.bind(i))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const i=this._gl.getExtension("ANGLE_instanced_arrays");i!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=i.drawArraysInstancedANGLE.bind(i),this._gl.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i),this._gl.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const i=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),r=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);i&&r&&(this._caps.highPrecisionShaderSupported=i.precision!==0&&r.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const i=this._gl.getExtension("EXT_blend_minmax");i!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=i.MAX_EXT,this._gl.MIN=i.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0;else{const i=this._gl.getExtension("EXT_sRGB");i!=null&&(this._caps.supportSRGBBuffers=!0,this._gl.SRGB=i.SRGB_EXT,this._gl.SRGB8=i.SRGB_ALPHA_EXT,this._gl.SRGB8_ALPHA8=i.SRGB_ALPHA_EXT)}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!!(this._creationOptions&&this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let i=0;i<this._maxSimultaneousTextures;i++)this._nextFreeTextureSlots.push(i)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}get isStencilEnable(){return this._isStencilEnable}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}resetTextureCache(){for(const e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}getLoadedTexturesCache(){return this._internalTexturesCache}getCaps(){return this._caps}stopRenderLoop(e){if(!e){this._activeRenderLoops=[];return}const t=this._activeRenderLoops.indexOf(e);t>=0&&this._activeRenderLoops.splice(t,1)}_renderLoop(){if(!this._contextWasLost){let e=!0;if(!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e){this.beginFrame();for(let t=0;t<this._activeRenderLoops.length;t++){const i=this._activeRenderLoops[t];i()}this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}getHostWindow(){return Ar()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}_queueNewFrame(e,t){return ze.QueueNewFrame(e,t)}runRenderLoop(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}clear(e,t,i,r=!1){const s=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=s;let n=0;t&&e&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),n|=this._gl.COLOR_BUFFER_BIT),i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),n|=this._gl.DEPTH_BUFFER_BIT),r&&(this._gl.clearStencil(0),n|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(n)}_viewport(e,t,i,r){(e!==this._viewportCached.x||t!==this._viewportCached.y||i!==this._viewportCached.z||r!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=r,this._gl.viewport(e,t,i,r))}setViewport(e,t,i){const r=t||this.getRenderWidth(),s=i||this.getRenderHeight(),n=e.x||0,a=e.y||0;this._cachedViewport=e,this._viewport(n*r,a*s,r*e.width,s*e.height)}beginFrame(){}endFrame(){this._badOS&&this.flushFramebuffer(),this._frameId++}resize(e=!1){let t,i;if(this.adaptToDeviceRatio){const r=Ar()&&window.devicePixelRatio||1,s=this._lastDevicePixelRatio/r;this._lastDevicePixelRatio=r,this._hardwareScalingLevel*=s}Ar()?(t=this._renderingCanvas?this._renderingCanvas.clientWidth||this._renderingCanvas.width:window.innerWidth,i=this._renderingCanvas?this._renderingCanvas.clientHeight||this._renderingCanvas.height:window.innerHeight):(t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100),this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e)}setSize(e,t,i=!1){return!this._renderingCanvas||(e=e|0,t=t|0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t)?!1:(this._renderingCanvas.width=e,this._renderingCanvas.height=t,!0)}bindFramebuffer(e,t=0,i,r,s,n=0,a=0){var l,c,h,u,d;const f=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(f._MSAAFramebuffer?f._MSAAFramebuffer:f._framebuffer);const _=this._gl;e.is2DArray?_.framebufferTextureLayer(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,(l=e.texture._hardwareTexture)===null||l===void 0?void 0:l.underlyingResource,n,a):e.isCube&&_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+t,(c=e.texture._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource,n);const p=e._depthStencilTexture;if(p){const m=e._depthStencilTextureWithStencil?_.DEPTH_STENCIL_ATTACHMENT:_.DEPTH_ATTACHMENT;e.is2DArray?_.framebufferTextureLayer(_.FRAMEBUFFER,m,(h=p._hardwareTexture)===null||h===void 0?void 0:h.underlyingResource,n,a):e.isCube?_.framebufferTexture2D(_.FRAMEBUFFER,m,_.TEXTURE_CUBE_MAP_POSITIVE_X+t,(u=p._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,n):_.framebufferTexture2D(_.FRAMEBUFFER,m,_.TEXTURE_2D,(d=p._hardwareTexture)===null||d===void 0?void 0:d.underlyingResource,n)}this._cachedViewport&&!s?this.setViewport(this._cachedViewport,i,r):(i||(i=e.width,n&&(i=i/Math.pow(2,n))),r||(r=e.height,n&&(r=r/Math.pow(2,n))),this._viewport(0,0,i,r)),this.wipeCaches()}setState(e,t=0,i,r=!1,s,n,a=0){var l,c;(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);const h=!((c=(l=this.cullBackFaces)!==null&&l!==void 0?l:s)!==null&&c!==void 0)||c?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==h||i)&&(this._depthCullingState.cullFace=h),this.setZOffset(t),this.setZOffsetUnits(a);const u=r?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==u||i)&&(this._depthCullingState.frontFace=u),this._stencilStateComposer.stencilMaterial=n}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){const e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){const e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}unBindFramebuffer(e,t=!1,i){var r;const s=e;this._currentRenderTarget=null;const n=this._gl;if(s._MSAAFramebuffer){if(e.isMulti){this.unBindMultiColorAttachmentFramebuffer(e,t,i);return}n.bindFramebuffer(n.READ_FRAMEBUFFER,s._MSAAFramebuffer),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,s._framebuffer),n.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,n.COLOR_BUFFER_BIT,n.NEAREST)}!((r=e.texture)===null||r===void 0)&&r.generateMipMaps&&!t&&!e.isCube&&this.generateMipmaps(e.texture),i&&(s._MSAAFramebuffer&&this._bindUnboundFramebuffer(s._framebuffer),i()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");const r=new _u(i);return this.bindArrayBuffer(r),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),this._resetVertexBufferBinding(),r.references=1,r}createDynamicVertexBuffer(e){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t){const i=this._gl.createBuffer(),r=new _u(i);if(!i)throw new Error("Unable to create index buffer");this.bindIndexBuffer(r);const s=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,s,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),r.references=1,r.is32Bits=s.BYTES_PER_ELEMENT===4,r}_normalizeIndexData(e){if(e.BYTES_PER_ELEMENT===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let i=0;i<e.length;i++)if(e[i]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,i){const r=e.program,s=this._gl.getUniformBlockIndex(r,t);this._gl.uniformBlockBinding(r,s,i)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,i,r,s,n,a){const l=this._currentBufferPointers[t];if(!l)return;let c=!1;l.active?(l.buffer!==e&&(l.buffer=e,c=!0),l.size!==i&&(l.size=i,c=!0),l.type!==r&&(l.type=r,c=!0),l.normalized!==s&&(l.normalized=s,c=!0),l.stride!==n&&(l.stride=n,c=!0),l.offset!==a&&(l.offset=a,c=!0)):(c=!0,l.active=!0,l.index=t,l.size=i,l.type=r,l.normalized=s,l.stride=n,l.offset=a,l.buffer=e),(c||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),r===this._gl.UNSIGNED_INT||r===this._gl.INT?this._gl.vertexAttribIPointer(t,i,r,n,a):this._gl.vertexAttribPointer(t,i,r,s,n,a))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,i){const r=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let s=0;s<r.length;s++){const n=t.getAttributeLocation(s);if(n>=0){const a=r[s];let l=null;if(i&&(l=i[a]),l||(l=e[a]),!l)continue;this._gl.enableVertexAttribArray(n),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[n]=!0);const c=l.getBuffer();c&&(this._vertexAttribPointer(c,n,l.getSize(),l.type,l.normalized,l.byteStride,l.byteOffset),l.getIsInstanced()&&(this._gl.vertexAttribDivisor(n,l.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(c))))}}}recordVertexArrayObject(e,t,i,r){const s=this._gl.createVertexArray();if(!s)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(s),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,r),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),s}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,i,r,s){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==s){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=s;const n=s.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let a=0;for(let l=0;l<n;l++)if(l<i.length){const c=s.getAttributeLocation(l);c>=0&&(this._gl.enableVertexAttribArray(c),this._vertexAttribArraysEnabled[c]=!0,this._vertexAttribPointer(e,c,i[l],this._gl.FLOAT,!1,r,a)),a+=i[l]*4}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,i,r){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,r)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,i=this._currentInstanceLocations.length;t<i;t++){const r=this._currentInstanceBuffers[t];e!=r&&r.references&&(e=r,this.bindArrayBuffer(r));const s=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(s,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),i[0].index!==void 0)this.bindInstancesBuffer(e,i,!0);else for(let r=0;r<4;r++){const s=i[r];this._vertexAttribArraysEnabled[s]||(this._gl.enableVertexAttribArray(s),this._vertexAttribArraysEnabled[s]=!0),this._vertexAttribPointer(e,s,4,this._gl.FLOAT,!1,64,r*16),this._gl.vertexAttribDivisor(s,1),this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,i=!0){this.bindArrayBuffer(e);let r=0;if(i)for(let s=0;s<t.length;s++){const n=t[s];r+=n.attributeSize*4}for(let s=0;s<t.length;s++){const n=t[s];n.index===void 0&&(n.index=this._currentEffect.getAttributeLocationByName(n.attributeName)),!(n.index<0)&&(this._vertexAttribArraysEnabled[n.index]||(this._gl.enableVertexAttribArray(n.index),this._vertexAttribArraysEnabled[n.index]=!0),this._vertexAttribPointer(e,n.index,n.attributeSize,n.attributeType||this._gl.FLOAT,n.normalized||!1,r,n.offset),this._gl.vertexAttribDivisor(n.index,n.divisor===void 0?1:n.divisor),this._currentInstanceLocations.push(n.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t=!1,i;for(;(i=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(i,1),this._currentInstanceBuffers.splice(i,1),t=!0,i=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,i,r){this.drawElementsType(e?0:1,t,i,r)}drawPointClouds(e,t,i){this.drawArraysType(2,e,t,i)}drawUnIndexed(e,t,i,r){this.drawArraysType(e?0:1,t,i,r)}drawElementsType(e,t,i,r){this.applyStates(),this._reportDrawCall();const s=this._drawMode(e),n=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,a=this._uintIndicesCurrentlySet?4:2;r?this._gl.drawElementsInstanced(s,i,n,t*a,r):this._gl.drawElements(s,i,n,t*a)}drawArraysType(e,t,i,r){this.applyStates(),this._reportDrawCall();const s=this._drawMode(e);r?this._gl.drawArraysInstanced(s,t,i,r):this._gl.drawArrays(s,t,i)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_reportDrawCall(){}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){const t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(t.program))}_getGlobalDefines(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{let t="";return this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+=`
`),t+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(t&&(t+=`
`),t+="#define USE_EXACT_SRGB_CONVERSIONS"),t}}createEffect(e,t,i,r,s,n,a,l,c,h=Gi.GLSL){var u;const d=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,f=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,_=this._getGlobalDefines();let p=(u=s??t.defines)!==null&&u!==void 0?u:"";_&&(p+=_);const m=d+"+"+f+"@"+p;if(this._compiledEffects[m]){const b=this._compiledEffects[m];return a&&b.isReady()&&a(b),b}const T=new ri(e,t,i,r,this,s,n,a,l,c,m,h);return this._compiledEffects[m]=T,T}static _ConcatenateShader(e,t,i=""){return i+(t?t+`
`:"")+e}_compileShader(e,t,i,r){return this._compileRawShader(ze._ConcatenateShader(e,i,r),t)}_compileRawShader(e,t){const i=this._gl,r=i.createShader(t==="vertex"?i.VERTEX_SHADER:i.FRAGMENT_SHADER);if(!r){let s=i.NO_ERROR,n=i.NO_ERROR;for(;(n=i.getError())!==i.NO_ERROR;)s=n;throw new Error(`Something went wrong while creating a gl ${t} shader object. gl error=${s}, gl isContextLost=${i.isContextLost()}, _contextWasLost=${this._contextWasLost}`)}return i.shaderSource(r,e),i.compileShader(r),r}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,i,r,s=null){r=r||this._gl;const n=this._compileRawShader(t,"vertex"),a=this._compileRawShader(i,"fragment");return this._createShaderProgram(e,n,a,r,s)}createShaderProgram(e,t,i,r,s,n=null){s=s||this._gl;const a=this._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",l=this._compileShader(t,"vertex",r,a),c=this._compileShader(i,"fragment",r,a);return this._createShaderProgram(e,l,c,s,n)}inlineShaderCode(e){return e}createPipelineContext(e){const t=new tS;return t.engine=this,this._caps.parallelShaderCompile&&(t.isParallelCompiled=!0),t}createMaterialContext(){}createDrawContext(){}_createShaderProgram(e,t,i,r,s=null){const n=r.createProgram();if(e.program=n,!n)throw new Error("Unable to create program");return r.attachShader(n,t),r.attachShader(n,i),r.linkProgram(n),e.context=r,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),n}_finalizePipelineContext(e){const t=e.context,i=e.vertexShader,r=e.fragmentShader,s=e.program;if(!t.getProgramParameter(s,t.LINK_STATUS)){if(!this._gl.getShaderParameter(i,this._gl.COMPILE_STATUS)){const l=this._gl.getShaderInfoLog(i);if(l)throw e.vertexCompilationError=l,new Error("VERTEX SHADER "+l)}if(!this._gl.getShaderParameter(r,this._gl.COMPILE_STATUS)){const l=this._gl.getShaderInfoLog(r);if(l)throw e.fragmentCompilationError=l,new Error("FRAGMENT SHADER "+l)}const a=t.getProgramInfoLog(s);if(a)throw e.programLinkError=a,new Error(a)}if(this.validateShaderPrograms&&(t.validateProgram(s),!t.getProgramParameter(s,t.VALIDATE_STATUS))){const l=t.getProgramInfoLog(s);if(l)throw e.programValidationError=l,new Error(l)}t.deleteShader(i),t.deleteShader(r),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)}_preparePipelineContext(e,t,i,r,s,n,a,l,c,h){const u=e;r?u.program=this.createRawShaderProgram(u,t,i,void 0,c):u.program=this.createShaderProgram(u,t,i,l,void 0,c),u.program.__SPECTOR_rebuildProgram=a}_isRenderingStateCompiled(e){const t=e;return this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)?(this._finalizePipelineContext(t),!0):!1}_executeWhenRenderingStateIsCompiled(e,t){const i=e;if(!i.isParallelCompiled){t();return}const r=i.onCompiled;r?i.onCompiled=()=>{r(),t()}:i.onCompiled=t}getUniforms(e,t){const i=new Array,r=e;for(let s=0;s<t.length;s++)i.push(this._gl.getUniformLocation(r.program,t[s]));return i}getAttributes(e,t){const i=[],r=e;for(let s=0;s<t.length;s++)try{i.push(this._gl.getAttribLocation(r.program,t[s]))}catch{i.push(-1)}return i}enableEffect(e){e=e!==null&&vs.IsWrapper(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,e=e,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return e?(this._gl.uniform1i(e,t),!0):!1}setInt2(e,t,i){return e?(this._gl.uniform2i(e,t,i),!0):!1}setInt3(e,t,i,r){return e?(this._gl.uniform3i(e,t,i,r),!0):!1}setInt4(e,t,i,r,s){return e?(this._gl.uniform4i(e,t,i,r,s),!0):!1}setIntArray(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1}setIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2iv(e,t),!0)}setIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3iv(e,t),!0)}setIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4iv(e,t),!0)}setUInt(e,t){return e?(this._gl.uniform1ui(e,t),!0):!1}setUInt2(e,t,i){return e?(this._gl.uniform2ui(e,t,i),!0):!1}setUInt3(e,t,i,r){return e?(this._gl.uniform3ui(e,t,i,r),!0):!1}setUInt4(e,t,i,r,s){return e?(this._gl.uniform4ui(e,t,i,r,s),!0):!1}setUIntArray(e,t){return e?(this._gl.uniform1uiv(e,t),!0):!1}setUIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2uiv(e,t),!0)}setUIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3uiv(e,t),!0)}setUIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4uiv(e,t),!0)}setArray(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)}setArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2fv(e,t),!0)}setArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3fv(e,t),!0)}setArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4fv(e,t),!0)}setMatrices(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1}setMatrix3x3(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1}setMatrix2x2(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1}setFloat(e,t){return e?(this._gl.uniform1f(e,t),!0):!1}setFloat2(e,t,i){return e?(this._gl.uniform2f(e,t,i),!0):!1}setFloat3(e,t,i,r){return e?(this._gl.uniform3f(e,t,i,r),!0):!1}setFloat4(e,t,i,r,s){return e?(this._gl.uniform4f(e,t,i,r,s),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}clearInternalTexturesCache(){this._internalTexturesCache.length=0}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){const i=this._gl;let r=i.NEAREST,s=i.NEAREST;switch(e){case 11:r=i.LINEAR,t?s=i.LINEAR_MIPMAP_NEAREST:s=i.LINEAR;break;case 3:r=i.LINEAR,t?s=i.LINEAR_MIPMAP_LINEAR:s=i.LINEAR;break;case 8:r=i.NEAREST,t?s=i.NEAREST_MIPMAP_LINEAR:s=i.NEAREST;break;case 4:r=i.NEAREST,t?s=i.NEAREST_MIPMAP_NEAREST:s=i.NEAREST;break;case 5:r=i.NEAREST,t?s=i.LINEAR_MIPMAP_NEAREST:s=i.LINEAR;break;case 6:r=i.NEAREST,t?s=i.LINEAR_MIPMAP_LINEAR:s=i.LINEAR;break;case 7:r=i.NEAREST,s=i.LINEAR;break;case 1:r=i.NEAREST,s=i.NEAREST;break;case 9:r=i.LINEAR,t?s=i.NEAREST_MIPMAP_NEAREST:s=i.NEAREST;break;case 10:r=i.LINEAR,t?s=i.NEAREST_MIPMAP_LINEAR:s=i.NEAREST;break;case 2:r=i.LINEAR,s=i.LINEAR;break;case 12:r=i.LINEAR,s=i.NEAREST;break}return{min:s,mag:r}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new hf(this._createTexture(),this._gl)}_createInternalTexture(e,t,i=!0,r=bt.Unknown){var s;let n=!1,a=0,l=3,c=5,h=!1,u=1;t!==void 0&&typeof t=="object"?(n=!!t.generateMipMaps,a=t.type===void 0?0:t.type,l=t.samplingMode===void 0?3:t.samplingMode,c=t.format===void 0?5:t.format,h=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer,u=(s=t.samples)!==null&&s!==void 0?s:1):n=!!t,h&&(h=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(a===1&&!this._caps.textureFloatLinearFiltering||a===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l=1),a===1&&!this._caps.textureFloat&&(a=0,X.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const d=this._gl,f=new hi(this,r),_=e.width||e,p=e.height||e,m=e.layers||0,T=this._getSamplingParameters(l,n),b=m!==0?d.TEXTURE_2D_ARRAY:d.TEXTURE_2D,y=this._getRGBABufferInternalSizedFormat(a,c,h),S=this._getInternalFormat(c),C=this._getWebGLTextureType(a);return this._bindTextureDirectly(b,f),m!==0?(f.is2DArray=!0,d.texImage3D(b,0,y,_,p,m,0,S,C,null)):d.texImage2D(b,0,y,_,p,0,S,C,null),d.texParameteri(b,d.TEXTURE_MAG_FILTER,T.mag),d.texParameteri(b,d.TEXTURE_MIN_FILTER,T.min),d.texParameteri(b,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(b,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),n&&this._gl.generateMipmap(b),this._bindTextureDirectly(b,null),f._useSRGBBuffer=h,f.baseWidth=_,f.baseHeight=p,f.width=_,f.height=p,f.depth=m,f.isReady=!0,f.samples=u,f.generateMipMaps=n,f.samplingMode=l,f.type=a,f.format=c,this._internalTexturesCache.push(f),f}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||t)}_createTextureBase(e,t,i,r,s=3,n=null,a=null,l,c,h=null,u=null,d=null,f=null,_,p,m){e=e||"";const T=e.substr(0,5)==="data:",b=e.substr(0,5)==="blob:",y=T&&e.indexOf(";base64,")!==-1,S=u||new hi(this,bt.Url),C=e;this._transformTextureUrl&&!y&&!u&&!h&&(e=this._transformTextureUrl(e)),C!==e&&(S._originalUrl=C);const I=e.lastIndexOf(".");let P=f||(I>-1?e.substring(I).toLowerCase():""),D=null;P.indexOf("?")>-1&&(P=P.split("?")[0]);for(const G of ze._TextureLoaders)if(G.canLoad(P,_)){D=G;break}r&&r.addPendingData(S),S.url=e,S.generateMipMaps=!t,S.samplingMode=s,S.invertY=i,S._useSRGBBuffer=this._getUseSRGBBuffer(!!m,t),this._doNotHandleContextLost||(S._buffer=h);let L=null;n&&!u&&(L=S.onLoadedObservable.add(n)),u||this._internalTexturesCache.push(S);const U=(G,Z)=>{r&&r.removePendingData(S),e===C?(L&&S.onLoadedObservable.remove(L),qe.UseFallbackTexture&&this._createTextureBase(qe.FallbackTexture,t,S.invertY,r,s,null,a,l,c,h,S),G=(G||"Unknown error")+(qe.UseFallbackTexture?" - Fallback texture was used":""),S.onErrorObservable.notifyObservers({message:G,exception:Z}),a&&a(G,Z)):(X.Warn(`Failed to load ${e}, falling back to ${C}`),this._createTextureBase(C,t,S.invertY,r,s,n,a,l,c,h,S,d,f,_,p,m))};if(D){const G=Z=>{D.loadData(Z,S,(he,_e,ne,Pe,Se,ce)=>{ce?U("TextureLoader failed to load data"):l(S,P,r,{width:he,height:_e},S.invertY,!ne,Pe,()=>(Se(),!1),s)},p)};h?h instanceof ArrayBuffer?G(new Uint8Array(h)):ArrayBuffer.isView(h)?G(h):a&&a("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,Z=>G(new Uint8Array(Z)),void 0,r?r.offlineProvider:void 0,!0,(Z,he)=>{U("Unable to load "+(Z&&Z.responseURL,he))})}else{const G=Z=>{b&&!this._doNotHandleContextLost&&(S._buffer=Z),l(S,P,r,Z,S.invertY,t,!1,c,s)};!T||y?h&&(typeof h.decoding=="string"||h.close)?G(h):ze._FileToolsLoadImage(e,G,U,r?r.offlineProvider:null,_,S.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):typeof h=="string"||h instanceof ArrayBuffer||ArrayBuffer.isView(h)||h instanceof Blob?ze._FileToolsLoadImage(h,G,U,r?r.offlineProvider:null,_,S.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):h&&G(h)}return S}createTexture(e,t,i,r,s=3,n=null,a=null,l=null,c=null,h=null,u=null,d,f,_,p){return this._createTextureBase(e,t,i,r,s,n,a,this._prepareWebGLTexture.bind(this),(m,T,b,y,S,C)=>{const I=this._gl,P=b.width===m&&b.height===T,D=h?this._getInternalFormat(h,S._useSRGBBuffer):y===".jpg"&&!S._useSRGBBuffer?I.RGB:S._useSRGBBuffer?I.SRGB8_ALPHA8:I.RGBA;let w=h?this._getInternalFormat(h):y===".jpg"&&!S._useSRGBBuffer?I.RGB:I.RGBA;if(S._useSRGBBuffer&&this.webGLVersion===1&&(w=D),P)return I.texImage2D(I.TEXTURE_2D,0,D,w,I.UNSIGNED_BYTE,b),!1;const L=this._caps.maxTextureSize;if(b.width>L||b.height>L||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=m,this._workingCanvas.height=T,this._workingContext.drawImage(b,0,0,b.width,b.height,0,0,m,T),I.texImage2D(I.TEXTURE_2D,0,D,w,I.UNSIGNED_BYTE,this._workingCanvas),S.width=m,S.height=T),!1;{const U=new hi(this,bt.Temp);this._bindTextureDirectly(I.TEXTURE_2D,U,!0),I.texImage2D(I.TEXTURE_2D,0,D,w,I.UNSIGNED_BYTE,b),this._rescaleTexture(U,S,r,D,()=>{this._releaseTexture(U),this._bindTextureDirectly(I.TEXTURE_2D,S,!0),C()})}return!0},l,c,h,u,d,f,p)}static _FileToolsLoadImage(e,t,i,r,s,n){throw pt("FileTools")}_rescaleTexture(e,t,i,r,s){}createRawTexture(e,t,i,r,s,n,a,l=null,c=0,h=0,u=!1){throw pt("Engine.RawTexture")}createRawCubeTexture(e,t,i,r,s,n,a,l=null){throw pt("Engine.RawTexture")}createRawTexture3D(e,t,i,r,s,n,a,l,c=null,h=0){throw pt("Engine.RawTexture")}createRawTexture2DArray(e,t,i,r,s,n,a,l,c=null,h=0){throw pt("Engine.RawTexture")}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,i=!1){const r=this._getTextureTarget(t),s=this._getSamplingParameters(e,t.generateMipMaps||i);this._setTextureParameterInteger(r,this._gl.TEXTURE_MAG_FILTER,s.mag,t),this._setTextureParameterInteger(r,this._gl.TEXTURE_MIN_FILTER,s.min),i&&(t.generateMipMaps=!0,this._gl.generateMipmap(r)),this._bindTextureDirectly(r,null),t.samplingMode=e}updateTextureDimensions(e,t,i,r=1){}updateTextureWrappingMode(e,t,i=null,r=null){const s=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),i!==null&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&r!==null&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(r),e),e._cachedWrapR=r),this._bindTextureDirectly(s,null)}_setupDepthStencilTexture(e,t,i,r,s,n=1){const a=t.width||t,l=t.height||t,c=t.layers||0;e.baseWidth=a,e.baseHeight=l,e.width=a,e.height=l,e.is2DArray=c>0,e.depth=c,e.isReady=!0,e.samples=n,e.generateMipMaps=!1,e.samplingMode=r?2:1,e.type=0,e._comparisonFunction=s;const h=this._gl,u=this._getTextureTarget(e),d=this._getSamplingParameters(e.samplingMode,!1);h.texParameteri(u,h.TEXTURE_MAG_FILTER,d.mag),h.texParameteri(u,h.TEXTURE_MIN_FILTER,d.min),h.texParameteri(u,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(u,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),this.webGLVersion>1&&(s===0?(h.texParameteri(u,h.TEXTURE_COMPARE_FUNC,515),h.texParameteri(u,h.TEXTURE_COMPARE_MODE,h.NONE)):(h.texParameteri(u,h.TEXTURE_COMPARE_FUNC,s),h.texParameteri(u,h.TEXTURE_COMPARE_MODE,h.COMPARE_REF_TO_TEXTURE)))}_uploadCompressedDataToTextureDirectly(e,t,i,r,s,n=0,a=0){const l=this._gl;let c=l.TEXTURE_2D;if(e.isCube&&(c=l.TEXTURE_CUBE_MAP_POSITIVE_X+n),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=l.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=l.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=l.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=l.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(c,a,t,i,r,0,s)}_uploadDataToTextureDirectly(e,t,i=0,r=0,s,n=!1){const a=this._gl,l=this._getWebGLTextureType(e.type),c=this._getInternalFormat(e.format),h=s===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(s,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let u=a.TEXTURE_2D;e.isCube&&(u=a.TEXTURE_CUBE_MAP_POSITIVE_X+i);const d=Math.round(Math.log(e.width)*Math.LOG2E),f=Math.round(Math.log(e.height)*Math.LOG2E),_=n?e.width:Math.pow(2,Math.max(d-r,0)),p=n?e.height:Math.pow(2,Math.max(f-r,0));a.texImage2D(u,r,h,_,p,0,c,l,t)}updateTextureData(e,t,i,r,s,n,a=0,l=0,c=!1){const h=this._gl,u=this._getWebGLTextureType(e.type),d=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let f=h.TEXTURE_2D,_=h.TEXTURE_2D;e.isCube&&(_=h.TEXTURE_CUBE_MAP_POSITIVE_X+a,f=h.TEXTURE_CUBE_MAP),this._bindTextureDirectly(f,e,!0),h.texSubImage2D(_,l,i,r,s,n,d,u,t),c&&this._gl.generateMipmap(_),this._bindTextureDirectly(f,null)}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){const s=this._gl,n=e.isCube?s.TEXTURE_CUBE_MAP:s.TEXTURE_2D;this._bindTextureDirectly(n,e,!0),this._uploadDataToTextureDirectly(e,t,i,r),this._bindTextureDirectly(n,null,!0)}_prepareWebGLTextureContinuation(e,t,i,r,s){const n=this._gl;if(!n)return;const a=this._getSamplingParameters(s,!i);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,a.mag),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,a.min),!i&&!r&&n.generateMipmap(n.TEXTURE_2D),this._bindTextureDirectly(n.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,i,r,s,n,a,l,c=3){const h=this.getCaps().maxTextureSize,u=Math.min(h,this.needPOTTextures?ze.GetExponentOfTwo(r.width,h):r.width),d=Math.min(h,this.needPOTTextures?ze.GetExponentOfTwo(r.height,h):r.height),f=this._gl;if(f){if(!e._hardwareTexture){i&&i.removePendingData(e);return}this._bindTextureDirectly(f.TEXTURE_2D,e,!0),this._unpackFlipY(s===void 0?!0:!!s),e.baseWidth=r.width,e.baseHeight=r.height,e.width=u,e.height=d,e.isReady=!0,!l(u,d,r,t,e,()=>{this._prepareWebGLTextureContinuation(e,i,n,a,c)})&&this._prepareWebGLTextureContinuation(e,i,n,a,c)}}_setupFramebufferDepthAttachments(e,t,i,r,s=1){const n=this._gl;if(e&&t)return this._createRenderBuffer(i,r,s,n.DEPTH_STENCIL,n.DEPTH24_STENCIL8,n.DEPTH_STENCIL_ATTACHMENT);if(t){let a=n.DEPTH_COMPONENT16;return this._webGLVersion>1&&(a=n.DEPTH_COMPONENT32F),this._createRenderBuffer(i,r,s,a,a,n.DEPTH_ATTACHMENT)}return e?this._createRenderBuffer(i,r,s,n.STENCIL_INDEX8,n.STENCIL_INDEX8,n.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,i,r,s,n,a=!0){const c=this._gl.createRenderbuffer();return this._updateRenderBuffer(c,e,t,i,r,s,n,a)}_updateRenderBuffer(e,t,i,r,s,n,a,l=!0){const c=this._gl;return c.bindRenderbuffer(c.RENDERBUFFER,e),r>1&&c.renderbufferStorageMultisample?c.renderbufferStorageMultisample(c.RENDERBUFFER,r,n,t,i):c.renderbufferStorage(c.RENDERBUFFER,s,t,i),c.framebufferRenderbuffer(c.FRAMEBUFFER,a,c.RENDERBUFFER,e),l&&c.bindRenderbuffer(c.RENDERBUFFER,null),e}_releaseTexture(e){var t;this._deleteTexture((t=e._hardwareTexture)===null||t===void 0?void 0:t.underlyingResource),this.unbindAllTextures();const i=this._internalTexturesCache.indexOf(e);i!==-1&&this._internalTexturesCache.splice(i,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_releaseRenderTargetWrapper(e){const t=this._renderTargetWrapperCache.indexOf(e);t!==-1&&this._renderTargetWrapperCache.splice(t,1)}_deleteTexture(e){e&&this._gl.deleteTexture(e)}_setProgram(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let r=0;r<i.length;r++){const s=e.getUniform(i[r]);s&&(this._boundUniforms[r]=s)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,i=!1,r=!1){var s,n;let a=!1;const l=t&&t._associatedChannel>-1;if(i&&l&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||r){if(this._activateCurrentTexture(),t&&t.isMultiview)throw console.error(e,t),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,(n=(s=t==null?void 0:t._hardwareTexture)===null||s===void 0?void 0:s.underlyingResource)!==null&&n!==void 0?n:null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else i&&(a=!0,this._activateCurrentTexture());return l&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),a}_bindTexture(e,t,i){if(e===void 0)return;t&&(t._associatedChannel=e),this._activeChannel=e;const r=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(r,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,i,r){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))}_bindSamplerUniformToChannel(e,t){const i=this._boundUniforms[e];!i||i._currentState===t||(this._gl.uniform1i(i,t),i._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,i=!1,r=!1,s=""){if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video)this._activeChannel=e,t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;let n;r?n=t.depthStencilTexture:t.isReady()?n=t.getInternalTexture():t.isCube?n=this.emptyCubeTexture:t.is3D?n=this.emptyTexture3D:t.is2DArray?n=this.emptyTexture2DArray:n=this.emptyTexture,!i&&n&&(n._associatedChannel=e);let a=!0;this._boundTexturesCache[e]===n&&(i||this._bindSamplerUniformToChannel(n._associatedChannel,e),a=!1),this._activeChannel=e;const l=this._getTextureTarget(n);if(a&&this._bindTextureDirectly(l,n,i),n&&!n.isMultiview){if(n.isCube&&n._cachedCoordinatesMode!==t.coordinatesMode){n._cachedCoordinatesMode=t.coordinatesMode;const c=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=c,t.wrapV=c}n._cachedWrapU!==t.wrapU&&(n._cachedWrapU=t.wrapU,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),n)),n._cachedWrapV!==t.wrapV&&(n._cachedWrapV=t.wrapV,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),n)),n.is3D&&n._cachedWrapR!==t.wrapR&&(n._cachedWrapR=t.wrapR,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),n)),this._setAnisotropicLevel(l,n,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,i,r){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==i.length)&&(this._textureUnits=new Int32Array(i.length));for(let s=0;s<i.length;s++){const n=i[s].getInternalTexture();n?(this._textureUnits[s]=e+s,n._associatedChannel=e+s):this._textureUnits[s]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let s=0;s<i.length;s++)this._setTexture(this._textureUnits[s],i[s],!0)}}_setAnisotropicLevel(e,t,i){const r=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(i=1),r&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)}_setTextureParameterFloat(e,t,i,r){this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameterf(e,t,i)}_setTextureParameterInteger(e,t,i,r){r&&this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameteri(e,t,i)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}dispose(){var e;this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),(e=this.releaseComputeEffects)===null||e===void 0||e.call(this),this.unbindAllAttributes(),this._boundUniforms={},Ar()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,ri.ResetCache();for(const t of this._activeRequests)t.abort();this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){const t=this._gl;for(;t.getError()!==t.NO_ERROR;);let i=!0;const r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const s=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,s),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0);const n=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&n===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);const a=t.RGBA,l=t.UNSIGNED_BYTE,c=new Uint8Array(4);t.readPixels(0,0,1,1,a,l,c),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(r),t.deleteFramebuffer(s),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let i=t?this._gl.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:i=this._gl.RED;break;case 7:i=this._gl.RG;break;case 4:i=t?this._gl.SRGB:this._gl.RGB;break;case 5:i=t?this._gl.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER;break}return i}_getRGBABufferInternalSizedFormat(e,t,i=!1){if(this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._gl.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._gl.SRGB8:this._gl.RGB8;case 5:return i?this._gl.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return i?this._gl.SRGB8_ALPHA8:this._gl.RGBA8}_getRGBAMultiSampleBufferFormat(e){return e===1?this._gl.RGBA32F:e===2?this._gl.RGBA16F:this._gl.RGBA8}_loadFile(e,t,i,r,s,n){const a=ze._FileToolsLoadFile(e,t,i,r,s,n);return this._activeRequests.push(a),a.onCompleteObservable.add(l=>{this._activeRequests.splice(this._activeRequests.indexOf(l),1)}),a}static _FileToolsLoadFile(e,t,i,r,s,n){throw pt("FileTools")}readPixels(e,t,i,r,s=!0,n=!0){const a=s?4:3,l=s?this._gl.RGBA:this._gl.RGB,c=new Uint8Array(r*i*a);return n&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,r,l,this._gl.UNSIGNED_BYTE,c),Promise.resolve(c)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{const e=this._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{const e=this._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}static CeilingPOT(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e}static FloorPOT(e){return e=e|e>>1,e=e|e>>2,e=e|e>>4,e=e|e>>8,e=e|e>>16,e-(e>>1)}static NearestPOT(e){const t=ze.CeilingPOT(e),i=ze.FloorPOT(e);return t-e>e-i?i:t}static GetExponentOfTwo(e,t,i=2){let r;switch(i){case 1:r=ze.FloorPOT(e);break;case 2:r=ze.NearestPOT(e);break;case 3:default:r=ze.CeilingPOT(e);break}return Math.min(r,t)}static QueueNewFrame(e,t){if(Ar()){const{requestPostAnimationFrame:i,requestAnimationFrame:r}=t||window;if(typeof i=="function")return i(e);if(typeof r=="function")return r(e)}else if(typeof requestAnimationFrame=="function")return requestAnimationFrame(e);return setTimeout(e,16)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:fu()?document:null}}ze.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}];ze._TextureLoaders=[];ze.CollisionsEpsilon=.001;ze._IsSupported=null;ze._HasMajorPerformanceCaveat=null;class sh{static SetImmediate(e){Ar()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)}}const oT=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class pu extends Wa{constructor(e,t){super(e,Wo.LoadFileError),this.name="LoadFileError",rh._setPrototypeOf(this,pu.prototype),t instanceof gs?this.request=t:this.file=t}}class Gd extends Wa{constructor(e,t){super(e,Wo.RequestFileError),this.request=t,this.name="RequestFileError",rh._setPrototypeOf(this,Gd.prototype)}}class em extends Wa{constructor(e,t){super(e,Wo.ReadFileError),this.file=t,this.name="ReadFileError",rh._setPrototypeOf(this,em.prototype)}}const Ls={DefaultRetryStrategy:kb.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:o=>o},lT=o=>(o=o.replace(/#/gm,"%23"),o),tm=(o,e)=>{if(!(o&&o.indexOf("data:")===0)&&Ls.CorsBehavior)if(typeof Ls.CorsBehavior=="string"||Ls.CorsBehavior instanceof String)e.crossOrigin=Ls.CorsBehavior;else{const t=Ls.CorsBehavior(o);t&&(e.crossOrigin=t)}},Nu=(o,e,t,i,r="",s)=>{var n;let a,l=!1;o instanceof ArrayBuffer||ArrayBuffer.isView(o)?typeof Blob<"u"&&typeof URL<"u"?(a=URL.createObjectURL(new Blob([o],{type:r})),l=!0):a=`data:${r};base64,`+tT(o):o instanceof Blob?(a=URL.createObjectURL(o),l=!0):(a=lT(o),a=Ls.PreprocessUrl(o));const c=qe.LastCreatedEngine,h=I=>{if(t){const P=a||o.toString();t(`Error while trying to load image: ${P.indexOf("http")===0||P.length<=128?P:P.slice(0,128)+"..."}`,I)}};if(typeof Image>"u"||(n=c==null?void 0:c._features.forceBitmapOverHTMLImageElement)!==null&&n!==void 0&&n)return Pl(a,I=>{c.createImageBitmap(new Blob([I],{type:r}),{premultiplyAlpha:"none",...s}).then(P=>{e(P),l&&URL.revokeObjectURL(a)}).catch(P=>{t&&t("Error while trying to load image: "+o,P)})},void 0,i||void 0,!0,(I,P)=>{h(P)}),null;const u=new Image;tm(a,u);const d=[],f=()=>{d.forEach(I=>{I.target.addEventListener(I.name,I.handler)})},_=()=>{d.forEach(I=>{I.target.removeEventListener(I.name,I.handler)}),d.length=0},p=()=>{_(),e(u),l&&u.src&&URL.revokeObjectURL(u.src)},m=I=>{_(),h(I),l&&u.src&&URL.revokeObjectURL(u.src)},T=I=>{_();const P=new Error(`CSP violation of policy ${I.effectiveDirective} ${I.blockedURI}. Current policy is ${I.originalPolicy}`);qe.UseFallbackTexture=!1,h(P),l&&u.src&&URL.revokeObjectURL(u.src),u.src=""};d.push({target:u,name:"load",handler:p}),d.push({target:u,name:"error",handler:m}),d.push({target:document,name:"securitypolicyviolation",handler:T}),f();const b=a.substring(0,5)==="blob:",y=a.substring(0,5)==="data:",S=()=>{b||y?u.src=a:Pl(a,(I,P,D)=>{const w=!r&&D?D:r,L=new Blob([I],{type:w}),U=URL.createObjectURL(L);l=!0,u.src=U},void 0,i||void 0,!0,(I,P)=>{h(P)})},C=()=>{i&&i.loadImage(a,u)};if(!b&&!y&&i&&i.enableTexturesOffline)i.open(C,S);else{if(a.indexOf("file:")!==-1){const I=decodeURIComponent(a.substring(5).toLowerCase());if(Hh.FilesToLoad[I]&&typeof URL<"u"){try{let P;try{P=URL.createObjectURL(Hh.FilesToLoad[I])}catch{P=URL.createObjectURL(Hh.FilesToLoad[I])}u.src=P,l=!0}catch{u.src=""}return u}}S()}return u},mu=(o,e,t,i,r)=>{const s=new FileReader,n={onCompleteObservable:new Q,abort:()=>s.abort()};return s.onloadend=()=>n.onCompleteObservable.notifyObservers(n),r&&(s.onerror=()=>{r(new em(`Unable to read ${o.name}`,o))}),s.onload=a=>{e(a.target.result)},t&&(s.onprogress=t),i?s.readAsArrayBuffer(o):s.readAsText(o),n},Pl=(o,e,t,i,r,s,n)=>{if(o.name)return mu(o,e,t,r,s?h=>{s(void 0,h)}:void 0);const a=o;if(a.indexOf("file:")!==-1){let h=decodeURIComponent(a.substring(5).toLowerCase());h.indexOf("./")===0&&(h=h.substring(2));const u=Hh.FilesToLoad[h];if(u)return mu(u,e,t,r,s?d=>s(void 0,new pu(d.message,d.file)):void 0)}const{match:l,type:c}=rS(a);if(l){const h={onCompleteObservable:new Q,abort:()=>()=>{}};try{const u=r?wu(a):hT(a);e(u,void 0,c)}catch(u){s?s(void 0,u):X.Error(u.message||"Failed to parse the Data URL")}return sh.SetImmediate(()=>{h.onCompleteObservable.notifyObservers(h)}),h}return im(a,(h,u)=>{e(h,u==null?void 0:u.responseURL,u==null?void 0:u.getResponseHeader("content-type"))},t,i,r,s?h=>{s(h.request,new pu(h.message,h.request))}:void 0,n)},im=(o,e,t,i,r,s,n)=>{o=lT(o),o=Ls.PreprocessUrl(o);const a=Ls.BaseUrl+o;let l=!1;const c={onCompleteObservable:new Q,abort:()=>l=!0},h=()=>{let u=new gs,d=null,f;const _=()=>{u&&(t&&u.removeEventListener("progress",t),f&&u.removeEventListener("readystatechange",f),u.removeEventListener("loadend",p))};let p=()=>{_(),c.onCompleteObservable.notifyObservers(c),c.onCompleteObservable.clear(),t=void 0,f=null,p=null,s=void 0,n=void 0,e=void 0};c.abort=()=>{l=!0,p&&p(),u&&u.readyState!==(XMLHttpRequest.DONE||4)&&u.abort(),d!==null&&(clearTimeout(d),d=null),u=null};const m=b=>{const y=b.message||"Unknown error";s&&u?s(new Gd(y,u)):X.Error(y)},T=b=>{if(u){if(u.open("GET",a),n)try{n(u)}catch(y){m(y);return}r&&(u.responseType="arraybuffer"),t&&u.addEventListener("progress",t),p&&u.addEventListener("loadend",p),f=()=>{if(!(l||!u)&&u.readyState===(XMLHttpRequest.DONE||4)){if(f&&u.removeEventListener("readystatechange",f),u.status>=200&&u.status<300||u.status===0&&(!Ar()||cT())){try{e&&e(r?u.response:u.responseText,u)}catch(C){m(C)}return}const y=Ls.DefaultRetryStrategy;if(y){const C=y(a,u,b);if(C!==-1){_(),u=new gs,d=setTimeout(()=>T(b+1),C);return}}const S=new Gd("Error status: "+u.status+" "+u.statusText+" - Unable to load "+a,u);s&&s(S)}},u.addEventListener("readystatechange",f),u.send()}};T(0)};if(i&&i.enableSceneOffline){const u=f=>{f&&f.status>400?s&&s(f):h()},d=()=>{i&&i.loadFile(Ls.BaseUrl+o,f=>{!l&&e&&e(f),c.onCompleteObservable.notifyObservers(c)},t?f=>{!l&&t&&t(f)}:void 0,u,r)};i.open(d,u)}else h();return c},cT=()=>typeof location<"u"&&location.protocol==="file:",uf=o=>oT.test(o),rS=o=>{const e=oT.exec(o);return e===null||e.length===0?{match:!1,type:""}:{match:!0,type:e[0].replace("data:","").replace("base64,","")}};function wu(o){return zb(o.split(",")[1])}const hT=o=>iT(o.split(",")[1]),sS=()=>{ze._FileToolsLoadImage=Nu,ze._FileToolsLoadFile=Pl,uo._FileToolsLoadFile=Pl};sS();let Uh;const nS=(o,e,t,i,r,s,n,a,l,c)=>{Uh={DecodeBase64UrlToBinary:o,DecodeBase64UrlToString:e,DefaultRetryStrategy:t.DefaultRetryStrategy,BaseUrl:t.BaseUrl,CorsBehavior:t.CorsBehavior,PreprocessUrl:t.PreprocessUrl,IsBase64DataUrl:i,IsFileURL:r,LoadFile:s,LoadImage:n,ReadFile:a,RequestFile:l,SetCorsBehavior:c},Object.defineProperty(Uh,"DefaultRetryStrategy",{get:function(){return t.DefaultRetryStrategy},set:function(h){t.DefaultRetryStrategy=h}}),Object.defineProperty(Uh,"BaseUrl",{get:function(){return t.BaseUrl},set:function(h){t.BaseUrl=h}}),Object.defineProperty(Uh,"PreprocessUrl",{get:function(){return t.PreprocessUrl},set:function(h){t.PreprocessUrl=h}}),Object.defineProperty(Uh,"CorsBehavior",{get:function(){return t.CorsBehavior},set:function(h){t.CorsBehavior=h}})};nS(wu,hT,Ls,uf,cT,Pl,Nu,mu,im,tm);class Xh{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];const t=Xr(e);if(t)return t;X.Warn(e+" not found, you may have missed an import.");const i=e.split(".");let r=window||this;for(let s=0,n=i.length;s<n;s++)r=r[i[s]];return typeof r!="function"?null:r}}Xh.RegisteredExternalClasses={};function rm(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,o=>{const e=Math.random()*16|0;return(o==="x"?e:e&3|8).toString(16)})}class J{static get BaseUrl(){return Ls.BaseUrl}static set BaseUrl(e){Ls.BaseUrl=e}static get DefaultRetryStrategy(){return Ls.DefaultRetryStrategy}static set DefaultRetryStrategy(e){Ls.DefaultRetryStrategy=e}static get CorsBehavior(){return Ls.CorsBehavior}static set CorsBehavior(e){Ls.CorsBehavior=e}static get UseFallbackTexture(){return qe.UseFallbackTexture}static set UseFallbackTexture(e){qe.UseFallbackTexture=e}static get RegisteredExternalClasses(){return Xh.RegisteredExternalClasses}static set RegisteredExternalClasses(e){Xh.RegisteredExternalClasses=e}static get fallbackTexture(){return qe.FallbackTexture}static set fallbackTexture(e){qe.FallbackTexture=e}static FetchToRef(e,t,i,r,s,n){const a=Math.abs(e)*i%i|0,l=Math.abs(t)*r%r|0,c=(a+l*i)*4;n.r=s[c]/255,n.g=s[c+1]/255,n.b=s[c+2]/255,n.a=s[c+3]/255}static Mix(e,t,i){return e*(1-i)+t*i}static Instantiate(e){return Xh.Instantiate(e)}static SetImmediate(e){sh.SetImmediate(e)}static IsExponentOfTwo(e){let t=1;do t*=2;while(t<e);return t===e}static FloatRound(e){return Math.fround?Math.fround(e):(J._TmpFloatArray[0]=e,J._TmpFloatArray[0])}static GetFilename(e){const t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){const i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}static ToDegrees(e){return e*180/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,i=.9){const r=this.ToRadians(e),s=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(s)+i*Math.sin(r),(1-i)*Math.cos(s)+i*Math.cos(r)))}static MakeArray(e,t){return t!==!0&&(e===void 0||e==null)?null:Array.isArray(e)?e:[e]}static GetPointerPrefix(e){let t="pointer";return Ar()&&!window.PointerEvent&&(t="mouse"),e._badDesktopOS&&!e._badOS&&!(document&&"ontouchend"in document)&&(t="mouse"),t}static SetCorsBehavior(e,t){tm(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static CleanUrl(e){return e=e.replace(/#/gm,"%23"),e}static get PreprocessUrl(){return Ls.PreprocessUrl}static set PreprocessUrl(e){Ls.PreprocessUrl=e}static LoadImage(e,t,i,r,s,n){return Nu(e,t,i,r,s,n)}static LoadFile(e,t,i,r,s,n){return Pl(e,t,i,r,s,n)}static LoadFileAsync(e,t=!0){return new Promise((i,r)=>{Pl(e,s=>{i(s)},void 0,void 0,t,(s,n)=>{r(n)})})}static LoadScript(e,t,i,r){if(typeof importScripts=="function"){try{importScripts(e),t()}catch(a){i==null||i(`Unable to load script '${e}' in worker`,a)}return}else if(!Ar()){i==null||i(`Cannot load script '${e}' outside of a window or a worker`);return}const s=document.getElementsByTagName("head")[0],n=document.createElement("script");n.setAttribute("type","text/javascript"),n.setAttribute("src",e),r&&(n.id=r),n.onload=()=>{t&&t()},n.onerror=a=>{i&&i(`Unable to load script '${e}'`,a)},s.appendChild(n)}static LoadScriptAsync(e){return new Promise((t,i)=>{this.LoadScript(e,()=>{t()},(r,s)=>{i(s||new Error(r))})})}static ReadFileAsDataURL(e,t,i){const r=new FileReader,s={onCompleteObservable:new Q,abort:()=>r.abort()};return r.onloadend=()=>{s.onCompleteObservable.notifyObservers(s)},r.onload=n=>{t(n.target.result)},r.onprogress=i,r.readAsDataURL(e),s}static ReadFile(e,t,i,r,s){return mu(e,t,i,r,s)}static FileAsURL(e){const t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,i,r){Sn.DeepCopy(e,t,i,r)}static IsEmpty(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const r=t[i];e.addEventListener(r.name,r.handler,!1);try{window.parent&&window.parent.addEventListener(r.name,r.handler,!1)}catch{}}}static UnregisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const r=t[i];e.removeEventListener(r.name,r.handler);try{e.parent&&e.parent.removeEventListener(r.name,r.handler)}catch{}}}static async DumpFramebuffer(e,t,i,r,s="image/png",n){throw pt("DumpTools")}static DumpData(e,t,i,r,s="image/png",n,a=!1,l=!1,c){throw pt("DumpTools")}static DumpDataAsync(e,t,i,r="image/png",s,n=!1,a=!1,l){throw pt("DumpTools")}static ToBlob(e,t,i="image/png",r){e.toBlob||(e.toBlob=function(s,n,a){setTimeout(()=>{const l=atob(this.toDataURL(n,a).split(",")[1]),c=l.length,h=new Uint8Array(c);for(let u=0;u<c;u++)h[u]=l.charCodeAt(u);s(new Blob([h]))})}),e.toBlob(function(s){t(s)},i,r)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){const i=new Date;t="screenshot_"+((i.getFullYear()+"-"+(i.getMonth()+1)).slice(2)+"-"+i.getDate()+"_"+i.getHours()+"-"+("0"+i.getMinutes()).slice(-2))+".png"}J.Download(e,t)}else if(e&&typeof URL<"u"){const i=URL.createObjectURL(e),r=window.open("");if(!r)return;const s=r.document.createElement("img");s.onload=function(){URL.revokeObjectURL(i)},s.src=i,r.document.body.appendChild(s)}}static EncodeScreenshotCanvasData(e,t,i="image/png",r,s){if(t){const n=e.toDataURL(i,s);t(n)}else this.ToBlob(e,function(n){n&&J.DownloadBlob(n,r)},i,s)}static Download(e,t){if(typeof URL>"u")return;const i=window.URL.createObjectURL(e),r=document.createElement("a");document.body.appendChild(r),r.style.display="none",r.href=i,r.download=t,r.addEventListener("click",()=>{r.parentElement&&r.parentElement.removeChild(r)}),r.click(),window.URL.revokeObjectURL(i)}static BackCompatCameraNoPreventDefault(e){return typeof e[0]=="boolean"?e[0]:typeof e[1]=="boolean"?e[1]:!1}static CreateScreenshot(e,t,i,r,s="image/png"){throw pt("ScreenshotTools")}static CreateScreenshotAsync(e,t,i,r="image/png"){throw pt("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,i,r,s="image/png",n=1,a=!1,l){throw pt("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(e,t,i,r="image/png",s=1,n=!1,a){throw pt("ScreenshotTools")}static RandomId(){return rm()}static IsBase64(e){return uf(e)}static DecodeBase64(e){return wu(e)}static get errorsCount(){return X.errorsCount}static Log(e){X.Log(e)}static Warn(e){X.Warn(e)}static Error(e){X.Error(e)}static get LogCache(){return X.LogCache}static ClearLogCache(){X.ClearLogCache()}static set LogLevels(e){X.LogLevels=e}static set PerformanceLogLevel(e){if((e&J.PerformanceUserMarkLogLevel)===J.PerformanceUserMarkLogLevel){J.StartPerformanceCounter=J._StartUserMark,J.EndPerformanceCounter=J._EndUserMark;return}if((e&J.PerformanceConsoleLogLevel)===J.PerformanceConsoleLogLevel){J.StartPerformanceCounter=J._StartPerformanceConsole,J.EndPerformanceCounter=J._EndPerformanceConsole;return}J.StartPerformanceCounter=J._StartPerformanceCounterDisabled,J.EndPerformanceCounter=J._EndPerformanceCounterDisabled}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!J._Performance){if(!Ar())return;J._Performance=window.performance}!t||!J._Performance.mark||J._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){!t||!J._Performance.mark||(J._Performance.mark(e+"-End"),J._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){t&&(J._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){t&&(J._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return Us.Now}static GetClassName(e,t=!1){let i=null;return!t&&e.getClassName?i=e.getClassName():(e instanceof Object&&(i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),i||(i=typeof e)),i}static First(e,t){for(const i of e)if(t(i))return i;return null}static getFullClassName(e,t=!1){let i=null,r=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){const s=t?e:Object.getPrototypeOf(e);i=s.constructor.__bjsclassName__,r=s.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(r!=null?r+".":"")+i:null}static DelayAsync(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}static IsSafari(){return eT()?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1}}J.UseCustomRequestHeaders=!1;J.CustomRequestHeaders=gs.CustomRequestHeaders;J._TmpFloatArray=new Float32Array(1);J.GetDOMTextContent=cf;J.GetAbsoluteUrl=typeof document=="object"?o=>{const e=document.createElement("a");return e.href=o,e.href}:typeof URL=="function"&&typeof location=="object"?o=>new URL(o,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")};J.NoneLogLevel=X.NoneLogLevel;J.MessageLogLevel=X.MessageLogLevel;J.WarningLogLevel=X.WarningLogLevel;J.ErrorLogLevel=X.ErrorLogLevel;J.AllLogLevel=X.AllLogLevel;J.IsWindowObjectExist=Ar;J.PerformanceNoneLogLevel=0;J.PerformanceUserMarkLogLevel=1;J.PerformanceConsoleLogLevel=2;J.StartPerformanceCounter=J._StartPerformanceCounterDisabled;J.EndPerformanceCounter=J._EndPerformanceCounterDisabled;class ba{constructor(e,t,i,r=0){this.iterations=e,this.index=r-1,this._done=!1,this._fn=t,this._successCallback=i}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,t,i,r=0){const s=new ba(e,t,i,r);return s.executeNext(),s}static SyncAsyncForLoop(e,t,i,r,s,n=0){return ba.Run(Math.ceil(e/t),a=>{s&&s()?a.breakLoop():setTimeout(()=>{for(let l=0;l<t;++l){const c=a.index*t+l;if(c>=e)break;if(i(c),s&&s()){a.breakLoop();break}}a.executeNext()},n)},r)}}qe.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";class Lr{constructor(e){this.length=0,this.data=new Array(e),this._id=Lr._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){const t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return this.indexOf(e)!==-1}}Lr._GlobalId=0;class hl extends Lr{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(e),!0)}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++){const i=(e.data||e)[t];this.pushNoDuplicate(i)}}}}class G_{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach((t,i)=>this.add(t,i))}get(e){const t=this._data[e];if(t!==void 0)return t}getOrAddWithFactory(e,t){let i=this.get(e);return i!==void 0||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){const i=this.get(e);return i!==void 0?i:(this.add(e,t),t)}contains(e){return this._data[e]!==void 0}add(e,t){return this._data[e]!==void 0?!1:(this._data[e]=t,++this._count,!0)}set(e,t){return this._data[e]===void 0?!1:(this._data[e]=t,!0)}getAndRemove(e){const t=this.get(e);return t!==void 0?(delete this._data[e],--this._count,t):null}remove(e){return this.contains(e)?(delete this._data[e],--this._count,!0):!1}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(const t in this._data){const i=this._data[t];e(t,i)}}first(e){for(const t in this._data){const i=this._data[t],r=e(t,i);if(r)return r}return null}}class Aa{constructor(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(const e of Object.keys(this))e[0]!=="_"&&this._keys.push(e);if(this._externalProperties)for(const e in this._externalProperties)this._keys.indexOf(e)===-1&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];if(this[i]!==e[i])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){const i=this._keys[t];e[i]=this[i]}}reset(){this._keys.forEach(e=>this._setDefaultValue(e))}_setDefaultValue(e){var t,i,r,s,n;const a=(r=(i=(t=this._externalProperties)===null||t===void 0?void 0:t[e])===null||i===void 0?void 0:i.type)!==null&&r!==void 0?r:typeof this[e],l=(n=(s=this._externalProperties)===null||s===void 0?void 0:s[e])===null||n===void 0?void 0:n.default;switch(a){case"number":this[e]=l??0;break;case"string":this[e]=l??"";break;default:this[e]=l??!1;break}}toString(){let e="";for(let t=0;t<this._keys.length;t++){const i=this._keys[t],r=this[i];switch(typeof r){case"number":case"string":e+="#define "+i+" "+r+`
`;break;default:r&&(e+="#define "+i+`
`);break}}return e}}class qi{constructor(){this._dirty=!0,this._tempColor=new Ye(0,0,0,0),this._globalCurve=new Ye(0,0,0,0),this._highlightsCurve=new Ye(0,0,0,0),this._midtonesCurve=new Ye(0,0,0,0),this._shadowsCurve=new Ye(0,0,0,0),this._positiveCurve=new Ye(0,0,0,0),this._negativeCurve=new Ye(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",r="vCameraColorCurveNeutral",s="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(r,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(s,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}static PrepareUniforms(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}_getColorGradingDataToRef(e,t,i,r,s){e!=null&&(e=qi._Clamp(e,0,360),t=qi._Clamp(t,-100,100),i=qi._Clamp(i,-100,100),r=qi._Clamp(r,-100,100),t=qi._ApplyColorGradingSliderNonlinear(t),t*=.5,r=qi._ApplyColorGradingSliderNonlinear(r),t<0&&(t*=-1,e=(e+180)%360),qi._FromHSBToRef(e,t,50+.25*r,s),s.scaleToRef(2,s),s.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,r){let s=qi._Clamp(e,0,360);const n=qi._Clamp(t/100,0,1),a=qi._Clamp(i/100,0,1);if(n===0)r.r=a,r.g=a,r.b=a;else{s/=60;const l=Math.floor(s),c=s-l,h=a*(1-n),u=a*(1-n*c),d=a*(1-n*(1-c));switch(l){case 0:r.r=a,r.g=d,r.b=h;break;case 1:r.r=u,r.g=a,r.b=h;break;case 2:r.r=h,r.g=a,r.b=d;break;case 3:r.r=h,r.g=u,r.b=a;break;case 4:r.r=d,r.g=h,r.b=a;break;default:r.r=a,r.g=h,r.b=u;break}}r.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return ke.Clone(()=>new qi,this)}serialize(){return ke.Serialize(this)}static Parse(e){return ke.Parse(()=>new qi,e,null,null)}}M([F()],qi.prototype,"_globalHue",void 0);M([F()],qi.prototype,"_globalDensity",void 0);M([F()],qi.prototype,"_globalSaturation",void 0);M([F()],qi.prototype,"_globalExposure",void 0);M([F()],qi.prototype,"_highlightsHue",void 0);M([F()],qi.prototype,"_highlightsDensity",void 0);M([F()],qi.prototype,"_highlightsSaturation",void 0);M([F()],qi.prototype,"_highlightsExposure",void 0);M([F()],qi.prototype,"_midtonesHue",void 0);M([F()],qi.prototype,"_midtonesDensity",void 0);M([F()],qi.prototype,"_midtonesSaturation",void 0);M([F()],qi.prototype,"_midtonesExposure",void 0);ke._ColorCurvesParser=qi.Parse;class aS extends Aa{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class wt{constructor(){this.colorCurves=new qi,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=wt.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new Ye(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=wt.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new Q}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}static PrepareUniforms(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),(t.VIGNETTE||t.DITHER)&&e.push("vInverseScreenSize"),t.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&qi.PrepareUniforms(e),t.DITHER&&e.push("ditherIntensity")}static PrepareSamplers(e,t){t.COLORGRADING&&e.push("txColorTransform")}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}switch(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===wt._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,e.TONEMAPPING=this.toneMappingEnabled,this._toneMappingType){case wt.TONEMAPPING_ACES:e.TONEMAPPING_ACES=!0;break;default:e.TONEMAPPING_ACES=!1;break}e.CONTRAST=this.contrast!==1,e.EXPOSURE=this.exposure!==1,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&qi.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const i=1/e.getEngine().getRenderWidth(),r=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",i,r),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const s=t??r/i;let n=Math.tan(this.vignetteCameraFov*.5),a=n*s;const l=Math.sqrt(a*n);a=J.Mix(a,l,this.vignetteStretch),n=J.Mix(n,l,this.vignetteStretch),e.setFloat4("vignetteSettings1",a,n,-a*this.vignetteCenterX,-n*this.vignetteCenterY);const c=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,c)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const i=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(i-1)/i,.5/i,i,this.colorGradingTexture.level)}}clone(){return ke.Clone(()=>new wt,this)}serialize(){return ke.Serialize(this)}static Parse(e){const t=ke.Parse(()=>new wt,e,null,null);return e.vignetteCentreX!==void 0&&(t.vignetteCenterX=e.vignetteCentreX),e.vignetteCentreY!==void 0&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}wt.TONEMAPPING_STANDARD=0;wt.TONEMAPPING_ACES=1;wt._VIGNETTEMODE_MULTIPLY=0;wt._VIGNETTEMODE_OPAQUE=1;M([Ib()],wt.prototype,"colorCurves",void 0);M([F()],wt.prototype,"_colorCurvesEnabled",void 0);M([Bt("colorGradingTexture")],wt.prototype,"_colorGradingTexture",void 0);M([F()],wt.prototype,"_colorGradingEnabled",void 0);M([F()],wt.prototype,"_colorGradingWithGreenDepth",void 0);M([F()],wt.prototype,"_colorGradingBGR",void 0);M([F()],wt.prototype,"_exposure",void 0);M([F()],wt.prototype,"_toneMappingEnabled",void 0);M([F()],wt.prototype,"_toneMappingType",void 0);M([F()],wt.prototype,"_contrast",void 0);M([F()],wt.prototype,"vignetteStretch",void 0);M([F()],wt.prototype,"vignetteCenterX",void 0);M([F()],wt.prototype,"vignetteCenterY",void 0);M([F()],wt.prototype,"vignetteWeight",void 0);M([Jp()],wt.prototype,"vignetteColor",void 0);M([F()],wt.prototype,"vignetteCameraFov",void 0);M([F()],wt.prototype,"_vignetteBlendMode",void 0);M([F()],wt.prototype,"_vignetteEnabled",void 0);M([F()],wt.prototype,"_ditheringEnabled",void 0);M([F()],wt.prototype,"_ditheringIntensity",void 0);M([F()],wt.prototype,"_skipFinalColorClamp",void 0);M([F()],wt.prototype,"_applyByPostProcess",void 0);M([F()],wt.prototype,"_isEnabled",void 0);ke._ImageProcessingConfigurationParser=wt.Parse;ze.prototype.createUniformBuffer=function(o){const e=this._gl.createBuffer();if(!e)throw new Error("Unable to create uniform buffer");const t=new _u(e);return this.bindUniformBuffer(t),o instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,o,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(o),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};ze.prototype.createDynamicUniformBuffer=function(o){const e=this._gl.createBuffer();if(!e)throw new Error("Unable to create dynamic uniform buffer");const t=new _u(e);return this.bindUniformBuffer(t),o instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,o,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(o),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};ze.prototype.updateUniformBuffer=function(o,e,t,i){this.bindUniformBuffer(o),t===void 0&&(t=0),i===void 0?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+i)),this.bindUniformBuffer(null)};ze.prototype.bindUniformBuffer=function(o){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,o?o.underlyingResource:null)};ze.prototype.bindUniformBufferBase=function(o,e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,o?o.underlyingResource:null)};ze.prototype.bindUniformBlock=function(o,e,t){const i=o.program,r=this._gl.getUniformBlockIndex(i,e);r!==4294967295&&this._gl.uniformBlockBinding(i,r,t)};class $e{constructor(e,t,i,r,s=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||s,this._dynamic=i,this._name=r??"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic!==void 0}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(e<=2?t=e:t=4,this._uniformLocationPointer%t!==0){const i=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const r=this._uniformLocationPointer-i;for(let s=0;s<r;s++)this._data.push(0)}}addUniform(e,t,i=0){if(this._noUBO||this._uniformLocations[e]!==void 0)return;let r;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},t==16)t=t*i;else{const n=(4-t)*i;t=t*i+n}r=[];for(let s=0;s<t;s++)r.push(0)}else{if(t instanceof Array)r=t,t=r.length;else{t=t,r=[];for(let s=0;s<t;s++)r.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let s=0;s<t;s++)this._data.push(r[s]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))}addFloat2(e,t,i){const r=[t,i];this.addUniform(e,r)}addFloat3(e,t,i,r){const s=[t,i,r];this.addUniform(e,s)}addColor3(e,t){const i=[t.r,t.g,t.b];this.addUniform(e,i)}addColor4(e,t,i){const r=[t.r,t.g,t.b,i];this.addUniform(e,r)}addVector3(e,t){const i=[t.x,t.y,t.z];this.addUniform(e,i)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_rebuild(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData):this._buffer=this._engine.createUniformBuffer(this._bufferData),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&($e._UpdatedUbosInFrame[this._name]||($e._UpdatedUbosInFrame[this._name]=0),$e._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let r=this._uniformLocations[e];if(r===void 0){if(this._buffer){X.Error("Cannot add an uniform after UBO has been created.");return}this.addUniform(e,i),r=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let s=0;s<i;s++)this._bufferData[r+s]=t[s];else{let s=!1;for(let n=0;n<i;n++)(i===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[r+n]!==J.FloatRound(t[n]))&&(s=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+n]=t[n]);this._needSync=this._needSync||s}}updateUniformArray(e,t,i){this._checkNewFrame();const r=this._uniformLocations[e];if(r===void 0){X.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");return}this._buffer||this.create();const s=this._uniformArraySizes[e];if(this._dynamic)for(let n=0;n<i;n++)this._bufferData[r+n]=t[n];else{let n=!1,a=0,l=0;for(let c=0;c<i;c++)if(this._bufferData[r+l*4+a]!==J.FloatRound(t[c])&&(n=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+l*4+a]=t[c]),a++,a===s.strideSize){for(;a<4;a++)this._bufferData[r+l*4+a]=0;a=0,l++}this._needSync=this._needSync||n}}_cacheMatrix(e,t){this._checkNewFrame();const i=this._valueCache[e],r=t.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[e]=r,!0)}_updateMatrix3x3ForUniform(e,t){for(let i=0;i<3;i++)$e._TempBuffer[i*4]=t[i*3],$e._TempBuffer[i*4+1]=t[i*3+1],$e._TempBuffer[i*4+2]=t[i*3+2],$e._TempBuffer[i*4+3]=0;this.updateUniform(e,$e._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let i=0;i<2;i++)$e._TempBuffer[i*4]=t[i*2],$e._TempBuffer[i*4+1]=t[i*2+1],$e._TempBuffer[i*4+2]=0,$e._TempBuffer[i*4+3]=0;this.updateUniform(e,$e._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){$e._TempBuffer[0]=t,this.updateUniform(e,$e._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,r=""){this._currentEffect.setFloat2(e+r,t,i)}_updateFloat2ForUniform(e,t,i){$e._TempBuffer[0]=t,$e._TempBuffer[1]=i,this.updateUniform(e,$e._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,r,s=""){this._currentEffect.setFloat3(e+s,t,i,r)}_updateFloat3ForUniform(e,t,i,r){$e._TempBuffer[0]=t,$e._TempBuffer[1]=i,$e._TempBuffer[2]=r,this.updateUniform(e,$e._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,r,s,n=""){this._currentEffect.setFloat4(e+n,t,i,r,s)}_updateFloat4ForUniform(e,t,i,r,s){$e._TempBuffer[0]=t,$e._TempBuffer[1]=i,$e._TempBuffer[2]=r,$e._TempBuffer[3]=s,this.updateUniform(e,$e._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){$e._TempBufferInt32View.set(t),this.updateUniformArray(e,$e._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){$e._TempBufferUInt32View.set(t),this.updateUniformArray(e,$e._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.toArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){$e._TempBuffer[0]=t.x,$e._TempBuffer[1]=t.y,$e._TempBuffer[2]=t.z,this.updateUniform(e,$e._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){$e._TempBuffer[0]=t.x,$e._TempBuffer[1]=t.y,$e._TempBuffer[2]=t.z,$e._TempBuffer[3]=t.w,this.updateUniform(e,$e._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){$e._TempBuffer[0]=t.r,$e._TempBuffer[1]=t.g,$e._TempBuffer[2]=t.b,this.updateUniform(e,$e._TempBuffer,3)}_updateColor4ForEffect(e,t,i,r=""){this._currentEffect.setColor4(e+r,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){$e._TempBuffer[0]=t.r,$e._TempBuffer[1]=t.g,$e._TempBuffer[2]=t.b,$e._TempBuffer[3]=i,this.updateUniform(e,$e._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){$e._TempBuffer[0]=t.r,$e._TempBuffer[1]=t.g,$e._TempBuffer[2]=t.b,$e._TempBuffer[3]=t.a,this.updateUniform(e,$e._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){$e._TempBufferInt32View[0]=t,this.updateUniform(e,$e._TempBuffer,1)}_updateInt2ForEffect(e,t,i,r=""){this._currentEffect.setInt2(e+r,t,i)}_updateInt2ForUniform(e,t,i){$e._TempBufferInt32View[0]=t,$e._TempBufferInt32View[1]=i,this.updateUniform(e,$e._TempBuffer,2)}_updateInt3ForEffect(e,t,i,r,s=""){this._currentEffect.setInt3(e+s,t,i,r)}_updateInt3ForUniform(e,t,i,r){$e._TempBufferInt32View[0]=t,$e._TempBufferInt32View[1]=i,$e._TempBufferInt32View[2]=r,this.updateUniform(e,$e._TempBuffer,3)}_updateInt4ForEffect(e,t,i,r,s,n=""){this._currentEffect.setInt4(e+n,t,i,r,s)}_updateInt4ForUniform(e,t,i,r,s){$e._TempBufferInt32View[0]=t,$e._TempBufferInt32View[1]=i,$e._TempBufferInt32View[2]=r,$e._TempBufferInt32View[3]=s,this.updateUniform(e,$e._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){$e._TempBufferUInt32View[0]=t,this.updateUniform(e,$e._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,r=""){this._currentEffect.setUInt2(e+r,t,i)}_updateUInt2ForUniform(e,t,i){$e._TempBufferUInt32View[0]=t,$e._TempBufferUInt32View[1]=i,this.updateUniform(e,$e._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,r,s=""){this._currentEffect.setUInt3(e+s,t,i,r)}_updateUInt3ForUniform(e,t,i,r){$e._TempBufferUInt32View[0]=t,$e._TempBufferUInt32View[1]=i,$e._TempBufferUInt32View[2]=r,this.updateUniform(e,$e._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,r,s,n=""){this._currentEffect.setUInt4(e+n,t,i,r,s)}_updateUInt4ForUniform(e,t,i,r,s){$e._TempBufferUInt32View[0]=t,$e._TempBufferUInt32View[1]=i,$e._TempBufferUInt32View[2]=r,$e._TempBufferUInt32View[3]=s,this.updateUniform(e,$e._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let i=0;i<this._buffers.length;++i){const r=this._buffers[i][0];this._engine._releaseBuffer(r)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}$e._UpdatedUbosInFrame={};$e._MAX_UNIFORM_SIZE=256;$e._TempBuffer=new Float32Array($e._MAX_UNIFORM_SIZE);$e._TempBufferInt32View=new Int32Array($e._TempBuffer.buffer);$e._TempBufferUInt32View=new Uint32Array($e._TempBuffer.buffer);class Xa{constructor(e,t,i,r=0,s=!1,n=!1,a=!1,l){this._isAlreadyOwned=!1,e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=n,this._divisor=l||1,t instanceof _c?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=a?r:r*Float32Array.BYTES_PER_ELEMENT,s||this.create()}createVertexBuffer(e,t,i,r,s,n=!1,a){const l=n?t:t*Float32Array.BYTES_PER_ELEMENT,c=r?n?r:r*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new O(this._engine,this,e,this._updatable,!0,c,s===void 0?this._instanced:s,l,i,void 0,void 0,!0,this._divisor||a)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e),this._data=e):this._buffer=this._engine.createVertexBuffer(e)))}_rebuild(){this._buffer=null,this.create(this._data)}update(e){this.create(e)}updateDirectly(e,t,i,r=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,r?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),t===0&&i===void 0?this._data=e:this._data=null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null,this._data=null)}}class O{get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=e!=0;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}constructor(e,t,i,r,s,n,a,l,c,h,u=!1,d=!1,f=1,_=!1){if(t instanceof Xa?(this._buffer=t,this._ownsBuffer=_):(this._buffer=new Xa(e,t,r,n,s,a,d),this._ownsBuffer=!0),this.uniqueId=O._Counter++,this._kind=i,h==null){const m=this.getData();this.type=O.FLOAT,m instanceof Int8Array?this.type=O.BYTE:m instanceof Uint8Array?this.type=O.UNSIGNED_BYTE:m instanceof Int16Array?this.type=O.SHORT:m instanceof Uint16Array?this.type=O.UNSIGNED_SHORT:m instanceof Int32Array?this.type=O.INT:m instanceof Uint32Array&&(this.type=O.UNSIGNED_INT)}else this.type=h;const p=O.GetTypeByteLength(this.type);d?(this._size=c||(n?n/p:O.DeduceStride(i)),this.byteStride=n||this._buffer.byteStride||this._size*p,this.byteOffset=l||0):(this._size=c||n||O.DeduceStride(i),this.byteStride=n?n*p:this._buffer.byteStride||this._size*p,this.byteOffset=(l||0)*p),this.normalized=u,this._instanced=a!==void 0?a:!1,this._instanceDivisor=a?f:0,this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){this._buffer&&this._buffer._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const i=this.getData();if(!i)return null;const r=this.getSize()*O.GetTypeByteLength(this.type),s=e*this.getSize();if(this.type!==O.FLOAT||this.byteStride!==r){const n=new Float32Array(s);return this.forEach(s,(a,l)=>n[l]=a),n}if(!(i instanceof Array||i instanceof Float32Array)||this.byteOffset!==0||i.length!==s)if(i instanceof Array){const n=this.byteOffset/4;return i.slice(n,n+s)}else{if(i instanceof ArrayBuffer)return new Float32Array(i,this.byteOffset,s);{let n=i.byteOffset+this.byteOffset;if(t){const l=new Float32Array(s),c=new Float32Array(i.buffer,n,s);return l.set(c),l}const a=n%4;return a&&(n=Math.max(0,n-a)),new Float32Array(i.buffer,n,s)}}return t?i.slice():i}getBuffer(){return this._buffer.getBuffer()}getStrideSize(){return this.byteStride/O.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/O.GetTypeByteLength(this.type)}getSize(e=!1){return e?this._size*O.GetTypeByteLength(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e)}update(e){this._buffer.update(e)}updateDirectly(e,t,i=!1){this._buffer.updateDirectly(e,t,void 0,i)}dispose(){this._ownsBuffer&&this._buffer.dispose()}forEach(e,t){O.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,t)}static DeduceStride(e){switch(e){case O.UVKind:case O.UV2Kind:case O.UV3Kind:case O.UV4Kind:case O.UV5Kind:case O.UV6Kind:return 2;case O.NormalKind:case O.PositionKind:return 3;case O.ColorKind:case O.MatricesIndicesKind:case O.MatricesIndicesExtraKind:case O.MatricesWeightsKind:case O.MatricesWeightsExtraKind:case O.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetTypeByteLength(e){switch(e){case O.BYTE:case O.UNSIGNED_BYTE:return 1;case O.SHORT:case O.UNSIGNED_SHORT:return 2;case O.INT:case O.UNSIGNED_INT:case O.FLOAT:return 4;default:throw new Error(`Invalid type '${e}'`)}}static ForEach(e,t,i,r,s,n,a,l){if(e instanceof Array){let c=t/4;const h=i/4;for(let u=0;u<n;u+=r){for(let d=0;d<r;d++)l(e[c+d],u+d);c+=h}}else{const c=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),h=O.GetTypeByteLength(s);for(let u=0;u<n;u+=r){let d=t;for(let f=0;f<r;f++){const _=O._GetFloatValue(c,s,d,a);l(_,u+f),d+=h}t+=i}}}static _GetFloatValue(e,t,i,r){switch(t){case O.BYTE:{let s=e.getInt8(i);return r&&(s=Math.max(s/127,-1)),s}case O.UNSIGNED_BYTE:{let s=e.getUint8(i);return r&&(s=s/255),s}case O.SHORT:{let s=e.getInt16(i,!0);return r&&(s=Math.max(s/32767,-1)),s}case O.UNSIGNED_SHORT:{let s=e.getUint16(i,!0);return r&&(s=s/65535),s}case O.INT:return e.getInt32(i,!0);case O.UNSIGNED_INT:return e.getUint32(i,!0);case O.FLOAT:return e.getFloat32(i,!0);default:throw new Error(`Invalid component type ${t}`)}}}O._Counter=0;O.BYTE=5120;O.UNSIGNED_BYTE=5121;O.SHORT=5122;O.UNSIGNED_SHORT=5123;O.INT=5124;O.UNSIGNED_INT=5125;O.FLOAT=5126;O.PositionKind="position";O.NormalKind="normal";O.TangentKind="tangent";O.UVKind="uv";O.UV2Kind="uv2";O.UV3Kind="uv3";O.UV4Kind="uv4";O.UV5Kind="uv5";O.UV6Kind="uv6";O.ColorKind="color";O.ColorInstanceKind="instanceColor";O.MatricesIndicesKind="matricesIndices";O.MatricesWeightsKind="matricesWeights";O.MatricesIndicesExtraKind="matricesIndicesExtra";O.MatricesWeightsExtraKind="matricesWeightsExtra";class Vs{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(O.NormalKind))return null;const i=this.pickedMesh.getIndices();if(!i)return null;let r;if(t){const n=this.pickedMesh.getVerticesData(O.NormalKind);let a=x.FromArray(n,i[this.faceId*3]*3),l=x.FromArray(n,i[this.faceId*3+1]*3),c=x.FromArray(n,i[this.faceId*3+2]*3);a=a.scale(this.bu),l=l.scale(this.bv),c=c.scale(1-this.bu-this.bv),r=new x(a.x+l.x+c.x,a.y+l.y+c.y,a.z+l.z+c.z)}else{const n=this.pickedMesh.getVerticesData(O.PositionKind),a=x.FromArray(n,i[this.faceId*3]*3),l=x.FromArray(n,i[this.faceId*3+1]*3),c=x.FromArray(n,i[this.faceId*3+2]*3),h=a.subtract(l),u=c.subtract(l);r=x.Cross(h,u)}const s=(n,a)=>{let l=n.getWorldMatrix();n.nonUniformScaling&&(j.Matrix[0].copyFrom(l),l=j.Matrix[0],l.setTranslationFromFloats(0,0,0),l.invert(),l.transposeToRef(j.Matrix[1]),l=j.Matrix[1]),x.TransformNormalToRef(a,l,a)};if(e&&s(this.pickedMesh,r),this.ray){const n=j.Vector3[0].copyFrom(r);e||s(this.pickedMesh,n),x.Dot(n,this.ray.direction)>0&&r.negateInPlace()}return r.normalize(),r}getTextureCoordinates(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(O.UVKind))return null;const e=this.pickedMesh.getIndices();if(!e)return null;const t=this.pickedMesh.getVerticesData(O.UVKind);if(!t)return null;let i=Ie.FromArray(t,e[this.faceId*3]*2),r=Ie.FromArray(t,e[this.faceId*3+1]*2),s=Ie.FromArray(t,e[this.faceId*3+2]*2);return i=i.scale(this.bu),r=r.scale(this.bv),s=s.scale(1-this.bu-this.bv),new Ie(i.x+r.x+s.x,i.y+r.y+s.y)}}class zd{constructor(e){this._vertexBuffers={},this._scene=e}_prepareBuffers(){if(this._vertexBuffers[O.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[O.PositionKind]=new O(this._scene.getEngine(),e,O.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[O.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const i=this._scene.activeCamera;return!i||(t=t||i._postProcesses.filter(r=>r!=null),!t||t.length===0||!this._scene.postProcessesEnabled)?!1:(t[0].activate(i,e,t!=null),!0)}directRender(e,t=null,i=!1,r=0,s=0,n=!1){var a;const l=this._scene.getEngine();for(let c=0;c<e.length;c++){c<e.length-1?e[c+1].activate(this._scene.activeCamera,t==null?void 0:t.texture):(t?l.bindFramebuffer(t,r,void 0,void 0,i,s):n||l.restoreDefaultFramebuffer(),(a=l._debugInsertMarker)===null||a===void 0||a.call(l,`post process ${e[c].name} output`));const h=e[c],u=h.apply();u&&(h.onBeforeRenderObservable.notifyObservers(u),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,u),l.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(u))}l.setDepthBuffer(!0),l.setDepthWrite(!0)}_finalizeFrame(e,t,i,r,s=!1){var n;const a=this._scene.activeCamera;if(!a||(r=r||a._postProcesses.filter(c=>c!=null),r.length===0||!this._scene.postProcessesEnabled))return;const l=this._scene.getEngine();for(let c=0,h=r.length;c<h;c++){const u=r[c];if(c<h-1?u._outputTexture=r[c+1].activate(a,t==null?void 0:t.texture):(t?(l.bindFramebuffer(t,i,void 0,void 0,s),u._outputTexture=t):(l.restoreDefaultFramebuffer(),u._outputTexture=null),(n=l._debugInsertMarker)===null||n===void 0||n.call(l,`post process ${r[c].name} output`)),e)break;const d=u.apply();d&&(u.onBeforeRenderObservable.notifyObservers(d),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,d),l.drawElementsType(0,0,6),u.onAfterRenderObservable.notifyObservers(d))}l.setDepthBuffer(!0),l.setDepthWrite(!0),l.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[O.PositionKind];e&&(e.dispose(),this._vertexBuffers[O.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}class Ua{set opaqueSortCompareFn(e){e?this._opaqueSortCompareFn=e:this._opaqueSortCompareFn=Ua.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){e?this._alphaTestSortCompareFn=e:this._alphaTestSortCompareFn=Ua.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){e?this._transparentSortCompareFn=e:this._transparentSortCompareFn=Ua.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,i=null,r=null,s=null){this.index=e,this._opaqueSubMeshes=new Lr(256),this._transparentSubMeshes=new Lr(256),this._alphaTestSubMeshes=new Lr(256),this._depthOnlySubMeshes=new Lr(256),this._particleSystems=new Lr(256),this._spriteManagers=new Lr(256),this._empty=!0,this._edgesRenderers=new hl(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=r,this.transparentSortCompareFn=s}render(e,t,i,r){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}const s=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(s.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),s.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);const n=s.getStencilBuffer();if(s.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(r),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(s.setStencilBuffer(n),this._scene.useOrderIndependentTransparency){const a=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);a.length&&this._renderTransparent(a)}else this._renderTransparent(this._transparentSubMeshes);s.setAlphaMode(0)}if(s.setStencilBuffer(!1),this._edgesRenderers.length){for(let a=0;a<this._edgesRenderers.length;a++)this._edgesRenderers.data[a].render();s.setAlphaMode(0)}s.setStencilBuffer(n)}_renderOpaqueSorted(e){return Ua._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){return Ua._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){return Ua._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,i,r){let s=0,n;const a=i?i.globalPosition:Ua._ZeroVector;if(r)for(;s<e.length;s++)n=e.data[s],n._alphaIndex=n.getMesh().alphaIndex,n._distanceToCamera=x.Distance(n.getBoundingInfo().boundingSphere.centerWorld,a);const l=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&l.sort(t);const c=l[0].getMesh().getScene();for(s=0;s<l.length;s++)if(n=l[s],!(c._activeMeshesFrozenButKeepClipping&&!n.isInFrustum(c._frustumPlanes))){if(r){const h=n.getMaterial();if(h&&h.needDepthPrePass){const u=h.getScene().getEngine();u.setColorWrite(!1),u.setAlphaMode(0),n.render(!1),u.setColorWrite(!0)}}n.render(r)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:Ua.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const i=e.getMesh(),r=t.getMesh();return i.material&&r.material?i.material.uniqueId-r.material.uniqueId:i.uniqueId-r.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),i===void 0&&(i=e.getMaterial()),i!=null&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(this._particleSystems.length===0)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){const r=this._particleSystems.data[i];if((t&&t.layerMask&r.layerMask)===0)continue;const s=r.emitter;(!s.position||!e||e.indexOf(s)!==-1)&&this._scene._activeParticles.addCount(r.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const i=this._spriteManagers.data[t];(e&&e.layerMask&i.layerMask)!==0&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}Ua._ZeroVector=x.Zero();class oS{}class ys{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){if(e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,!this._maintainStateBetweenFrames)){for(const t of this._scene.meshes)if(t.subMeshes)for(const i of t.subMeshes)i._wasDispatched=!1;for(const t of this._scene.spriteManagers)t._wasDispatched=!1;for(const t of this._scene.particleSystems)t._wasDispatched=!1}}constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new oS,this._maintainStateBetweenFrames=!1,this._scene=e;for(let t=ys.MIN_RENDERINGGROUPS;t<ys.MAX_RENDERINGGROUPS;t++)this._autoClearDepthStencil[t]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){const t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,i,r){const s=this._renderingGroupInfo;if(s.scene=this._scene,s.camera=this._scene.activeCamera,this._scene.spriteManagers&&r)for(let n=0;n<this._scene.spriteManagers.length;n++){const a=this._scene.spriteManagers[n];this.dispatchSprites(a)}for(let n=ys.MIN_RENDERINGGROUPS;n<ys.MAX_RENDERINGGROUPS;n++){this._depthStencilBufferAlreadyCleaned=n===ys.MIN_RENDERINGGROUPS;const a=this._renderingGroups[n];if(!a||a._empty)continue;const l=Math.pow(2,n);if(s.renderingGroupId=n,this._scene.onBeforeRenderingGroupObservable.notifyObservers(s,l),ys.AUTOCLEAR){const c=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(n):this._autoClearDepthStencil[n];c&&c.autoClear&&this._clearDepthStencilBuffer(c.depth,c.stencil)}for(const c of this._scene._beforeRenderingGroupDrawStage)c.action(n);a.render(e,r,i,t);for(const c of this._scene._afterRenderingGroupDrawStage)c.action(n);this._scene.onAfterRenderingGroupObservable.notifyObservers(s,l)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=ys.MIN_RENDERINGGROUPS;e<ys.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=ys.MIN_RENDERINGGROUPS;e<ys.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=ys.MIN_RENDERINGGROUPS;e<ys.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new Ua(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),!(this.maintainStateBetweenFrames&&e._wasDispatched)&&(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,i))}setRenderingOrder(e,t=null,i=null,r=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=r,this._renderingGroups[e]){const s=this._renderingGroups[e];s.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],s.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],s.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,i=!0,r=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:r}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}ys.MAX_RENDERINGGROUPS=4;ys.MIN_RENDERINGGROUPS=0;ys.AUTOCLEAR=!0;class Re{}Re.NAME_EFFECTLAYER="EffectLayer";Re.NAME_LAYER="Layer";Re.NAME_LENSFLARESYSTEM="LensFlareSystem";Re.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer";Re.NAME_PARTICLESYSTEM="ParticleSystem";Re.NAME_GAMEPAD="Gamepad";Re.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue";Re.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer";Re.NAME_PREPASSRENDERER="PrePassRenderer";Re.NAME_DEPTHRENDERER="DepthRenderer";Re.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer";Re.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager";Re.NAME_SPRITE="Sprite";Re.NAME_SUBSURFACE="SubSurface";Re.NAME_OUTLINERENDERER="Outline";Re.NAME_PROCEDURALTEXTURE="ProceduralTexture";Re.NAME_SHADOWGENERATOR="ShadowGenerator";Re.NAME_OCTREE="Octree";Re.NAME_PHYSICSENGINE="PhysicsEngine";Re.NAME_AUDIO="Audio";Re.NAME_FLUIDRENDERER="FluidRenderer";Re.STEP_ISREADYFORMESH_EFFECTLAYER=0;Re.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0;Re.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0;Re.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0;Re.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1;Re.STEP_BEFORECAMERADRAW_PREPASS=0;Re.STEP_BEFORECAMERADRAW_EFFECTLAYER=1;Re.STEP_BEFORECAMERADRAW_LAYER=2;Re.STEP_BEFORERENDERTARGETDRAW_PREPASS=0;Re.STEP_BEFORERENDERTARGETDRAW_LAYER=1;Re.STEP_BEFORERENDERINGMESH_PREPASS=0;Re.STEP_BEFORERENDERINGMESH_OUTLINE=1;Re.STEP_AFTERRENDERINGMESH_PREPASS=0;Re.STEP_AFTERRENDERINGMESH_OUTLINE=1;Re.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0;Re.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1;Re.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0;Re.STEP_BEFORECAMERAUPDATE_GAMEPAD=1;Re.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0;Re.STEP_BEFORECLEAR_PREPASS=1;Re.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0;Re.STEP_AFTERRENDERTARGETDRAW_PREPASS=0;Re.STEP_AFTERRENDERTARGETDRAW_LAYER=1;Re.STEP_AFTERCAMERADRAW_PREPASS=0;Re.STEP_AFTERCAMERADRAW_EFFECTLAYER=1;Re.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2;Re.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3;Re.STEP_AFTERCAMERADRAW_LAYER=4;Re.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5;Re.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0;Re.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0;Re.STEP_AFTERRENDER_AUDIO=0;Re.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0;Re.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1;Re.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2;Re.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3;Re.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0;Re.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1;Re.STEP_POINTERMOVE_SPRITE=0;Re.STEP_POINTERDOWN_SPRITE=0;Re.STEP_POINTERUP_SPRITE=0;class pr extends Array{constructor(e){super(...e)}static Create(){return Object.create(pr.prototype)}registerStep(e,t,i){let r=0,s=Number.MAX_VALUE;for(;r<this.length&&(s=this[r].index,!(e<s));r++);this.splice(r,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}class Qe{}Qe.POINTERDOWN=1;Qe.POINTERUP=2;Qe.POINTERMOVE=4;Qe.POINTERWHEEL=8;Qe.POINTERPICK=16;Qe.POINTERTAP=32;Qe.POINTERDOUBLETAP=64;class uT{constructor(e,t){this.type=e,this.event=t}}class lS extends uT{constructor(e,t,i,r){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new Ie(i,r)}}class ao extends uT{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,r=null){super(e,t),this._pickInfo=i,this._inputManager=r}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}class Ml{}Ml.KEYDOWN=1;Ml.KEYUP=2;class z_{constructor(e,t){this.type=e,this.event=t}}class jg extends z_{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}var nt;(function(o){o[o.Generic=0]="Generic",o[o.Keyboard=1]="Keyboard",o[o.Mouse=2]="Mouse",o[o.Touch=3]="Touch",o[o.DualShock=4]="DualShock",o[o.Xbox=5]="Xbox",o[o.Switch=6]="Switch",o[o.DualSense=7]="DualSense"})(nt||(nt={}));var Et;(function(o){o[o.Horizontal=0]="Horizontal",o[o.Vertical=1]="Vertical",o[o.LeftClick=2]="LeftClick",o[o.MiddleClick=3]="MiddleClick",o[o.RightClick=4]="RightClick",o[o.BrowserBack=5]="BrowserBack",o[o.BrowserForward=6]="BrowserForward",o[o.MouseWheelX=7]="MouseWheelX",o[o.MouseWheelY=8]="MouseWheelY",o[o.MouseWheelZ=9]="MouseWheelZ",o[o.Move=12]="Move"})(Et||(Et={}));var Hd;(function(o){o[o.Horizontal=0]="Horizontal",o[o.Vertical=1]="Vertical",o[o.LeftClick=2]="LeftClick",o[o.MiddleClick=3]="MiddleClick",o[o.RightClick=4]="RightClick",o[o.BrowserBack=5]="BrowserBack",o[o.BrowserForward=6]="BrowserForward",o[o.MouseWheelX=7]="MouseWheelX",o[o.MouseWheelY=8]="MouseWheelY",o[o.MouseWheelZ=9]="MouseWheelZ",o[o.DeltaHorizontal=10]="DeltaHorizontal",o[o.DeltaVertical=11]="DeltaVertical"})(Hd||(Hd={}));var Kg;(function(o){o[o.Cross=0]="Cross",o[o.Circle=1]="Circle",o[o.Square=2]="Square",o[o.Triangle=3]="Triangle",o[o.L1=4]="L1",o[o.R1=5]="R1",o[o.L2=6]="L2",o[o.R2=7]="R2",o[o.Share=8]="Share",o[o.Options=9]="Options",o[o.L3=10]="L3",o[o.R3=11]="R3",o[o.DPadUp=12]="DPadUp",o[o.DPadDown=13]="DPadDown",o[o.DPadLeft=14]="DPadLeft",o[o.DPadRight=15]="DPadRight",o[o.Home=16]="Home",o[o.TouchPad=17]="TouchPad",o[o.LStickXAxis=18]="LStickXAxis",o[o.LStickYAxis=19]="LStickYAxis",o[o.RStickXAxis=20]="RStickXAxis",o[o.RStickYAxis=21]="RStickYAxis"})(Kg||(Kg={}));var qg;(function(o){o[o.Cross=0]="Cross",o[o.Circle=1]="Circle",o[o.Square=2]="Square",o[o.Triangle=3]="Triangle",o[o.L1=4]="L1",o[o.R1=5]="R1",o[o.L2=6]="L2",o[o.R2=7]="R2",o[o.Create=8]="Create",o[o.Options=9]="Options",o[o.L3=10]="L3",o[o.R3=11]="R3",o[o.DPadUp=12]="DPadUp",o[o.DPadDown=13]="DPadDown",o[o.DPadLeft=14]="DPadLeft",o[o.DPadRight=15]="DPadRight",o[o.Home=16]="Home",o[o.TouchPad=17]="TouchPad",o[o.LStickXAxis=18]="LStickXAxis",o[o.LStickYAxis=19]="LStickYAxis",o[o.RStickXAxis=20]="RStickXAxis",o[o.RStickYAxis=21]="RStickYAxis"})(qg||(qg={}));var Qg;(function(o){o[o.A=0]="A",o[o.B=1]="B",o[o.X=2]="X",o[o.Y=3]="Y",o[o.LB=4]="LB",o[o.RB=5]="RB",o[o.LT=6]="LT",o[o.RT=7]="RT",o[o.Back=8]="Back",o[o.Start=9]="Start",o[o.LS=10]="LS",o[o.RS=11]="RS",o[o.DPadUp=12]="DPadUp",o[o.DPadDown=13]="DPadDown",o[o.DPadLeft=14]="DPadLeft",o[o.DPadRight=15]="DPadRight",o[o.Home=16]="Home",o[o.LStickXAxis=17]="LStickXAxis",o[o.LStickYAxis=18]="LStickYAxis",o[o.RStickXAxis=19]="RStickXAxis",o[o.RStickYAxis=20]="RStickYAxis"})(Qg||(Qg={}));var Zg;(function(o){o[o.B=0]="B",o[o.A=1]="A",o[o.Y=2]="Y",o[o.X=3]="X",o[o.L=4]="L",o[o.R=5]="R",o[o.ZL=6]="ZL",o[o.ZR=7]="ZR",o[o.Minus=8]="Minus",o[o.Plus=9]="Plus",o[o.LS=10]="LS",o[o.RS=11]="RS",o[o.DPadUp=12]="DPadUp",o[o.DPadDown=13]="DPadDown",o[o.DPadLeft=14]="DPadLeft",o[o.DPadRight=15]="DPadRight",o[o.Home=16]="Home",o[o.Capture=17]="Capture",o[o.LStickXAxis=18]="LStickXAxis",o[o.LStickYAxis=19]="LStickYAxis",o[o.RStickXAxis=20]="RStickXAxis",o[o.RStickYAxis=21]="RStickYAxis"})(Zg||(Zg={}));var Jg;(function(o){o[o.PointerMove=0]="PointerMove",o[o.PointerDown=1]="PointerDown",o[o.PointerUp=2]="PointerUp"})(Jg||(Jg={}));class vh{}vh.DOM_DELTA_PIXEL=0;vh.DOM_DELTA_LINE=1;vh.DOM_DELTA_PAGE=2;class Kl{static CreateDeviceEvent(e,t,i,r,s,n,a){switch(e){case nt.Keyboard:return this._CreateKeyboardEvent(i,r,s,n);case nt.Mouse:if(i===Et.MouseWheelX||i===Et.MouseWheelY||i===Et.MouseWheelZ)return this._CreateWheelEvent(e,t,i,r,s,n);case nt.Touch:return this._CreatePointerEvent(e,t,i,r,s,n,a);default:throw`Unable to generate event for device ${nt[e]}`}}static _CreatePointerEvent(e,t,i,r,s,n,a){const l=this._CreateMouseEvent(e,t,i,r,s,n);return e===nt.Mouse?(l.deviceType=nt.Mouse,l.pointerId=1,l.pointerType="mouse"):(l.deviceType=nt.Touch,l.pointerId=a??t,l.pointerType="touch"),i===Et.Move?l.type="pointermove":i>=Et.LeftClick&&i<=Et.RightClick&&(l.type=r===1?"pointerdown":"pointerup",l.button=i-2),l}static _CreateWheelEvent(e,t,i,r,s,n){const a=this._CreateMouseEvent(e,t,i,r,s,n);switch(a.type="wheel",a.deltaMode=vh.DOM_DELTA_PIXEL,a.deltaX=0,a.deltaY=0,a.deltaZ=0,i){case Et.MouseWheelX:a.deltaX=r;break;case Et.MouseWheelY:a.deltaY=r;break;case Et.MouseWheelZ:a.deltaZ=r;break}return a}static _CreateMouseEvent(e,t,i,r,s,n){const a=this._CreateEvent(n),l=s.pollInput(e,t,Et.Horizontal),c=s.pollInput(e,t,Et.Vertical);return n?(a.movementX=0,a.movementY=0,a.offsetX=a.movementX-n.getBoundingClientRect().x,a.offsetY=a.movementY-n.getBoundingClientRect().y):(a.movementX=s.pollInput(e,t,Hd.DeltaHorizontal),a.movementY=s.pollInput(e,t,Hd.DeltaVertical),a.offsetX=0,a.offsetY=0),this._CheckNonCharacterKeys(a,s),a.clientX=l,a.clientY=c,a.x=l,a.y=c,a.deviceType=e,a.deviceSlot=t,a.inputIndex=i,a}static _CreateKeyboardEvent(e,t,i,r){const s=this._CreateEvent(r);return this._CheckNonCharacterKeys(s,i),s.deviceType=nt.Keyboard,s.deviceSlot=0,s.inputIndex=e,s.type=t===1?"keydown":"keyup",s.key=String.fromCharCode(e),s.keyCode=e,s}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(nt.Keyboard),r=i&&t.pollInput(nt.Keyboard,0,18)===1,s=i&&t.pollInput(nt.Keyboard,0,17)===1,n=i&&(t.pollInput(nt.Keyboard,0,91)===1||t.pollInput(nt.Keyboard,0,92)===1||t.pollInput(nt.Keyboard,0,93)===1),a=i&&t.pollInput(nt.Keyboard,0,16)===1;e.altKey=r,e.ctrlKey=s,e.metaKey=n,e.shiftKey=a}static _CreateEvent(e){const t={};return t.preventDefault=()=>{},t.target=e,t}}class cS{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(r,s,n,a)=>{const l=Kl.CreateDeviceEvent(r,s,n,a,this);i(r,s,l)}):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===nt.Mouse||e===nt.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}const ev=255,tv=Object.keys(Et).length/2;class hS{constructor(e,t,i,r){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=J.IsSafari(),this._usingMacOS=/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=s=>{},this._keyboardUpEvent=s=>{},this._keyboardBlurEvent=s=>{},this._pointerMoveEvent=s=>{},this._pointerDownEvent=s=>{},this._pointerUpEvent=s=>{},this._pointerCancelEvent=s=>{},this._pointerWheelEvent=s=>{},this._pointerBlurEvent=s=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=k_.IsNavigatorAvailable()&&navigator.userAgent&&navigator.userAgent.indexOf("Firefox")!==-1,this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=s=>{},this._gamepadDisconnectedEvent=s=>{},this._eventPrefix=J.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=r,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){const r=this._inputs[e][t];if(!r)throw`Unable to find device ${nt[e]}`;e>=nt.DualShock&&e<=nt.DualSense&&this._updateDevice(e,t,i);const s=r[i];if(s===void 0)throw`Unable to find input ${i} for device ${nt[e]} in slot ${t}`;return i===Et.Move&&J.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),s}isDeviceAvailable(e){return this._inputs[e]!==void 0}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=this===null||this===void 0?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs){for(const t of this._inputs)if(t)for(const i in t){const r=+i,s=t[r];if(s)for(let n=0;n<s.length;n++)s[n]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=this._elementToAttachTo.tabIndex!==-1?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}typeof matchMedia=="function"&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(nt.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,r){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,tv);const s=this._inputs[e][t];s[0]=i,s[1]=r}_registerDevice(e,t,i){if(t===void 0)throw`Unable to register device ${nt[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const r=new Array(i);r.fill(0),this._inputs[e][t]=r,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(nt.Keyboard,0,ev));const t=this._inputs[nt.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&e.key!=="Meta"&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(nt.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(nt.Keyboard,0,ev));const t=this._inputs[nt.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOS&&e.key==="Meta"&&this._metaKeys.length>0){for(const r of this._metaKeys){const s=Kl.CreateDeviceEvent(nt.Keyboard,0,r,0,this,this._elementToAttachTo);t[r]=0,this._onInputChanged(nt.Keyboard,0,s)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(nt.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[nt.Keyboard][0];for(let t=0;t<e.length;t++)if(e[t]!==0){e[t]=0;const i=Kl.CreateDeviceEvent(nt.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(nt.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=k_.IsNavigatorAvailable()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let i=0;i<this._maxTouchPoints;i++)this._activeTouchIds[i]=-1;this._pointerMoveEvent=i=>{const r=this._getPointerType(i),s=r===nt.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);this._inputs[r]||(this._inputs[r]={}),this._inputs[r][s]||this._addPointerDevice(r,s,i.clientX,i.clientY);const n=this._inputs[r][s];if(n){const a=i;a.inputIndex=Et.Move,n[Et.Horizontal]=i.clientX,n[Et.Vertical]=i.clientY,this._onInputChanged(r,s,a),!this._usingSafari&&i.button!==-1&&(a.inputIndex=i.button+2,n[i.button+2]=n[i.button+2]?0:1,this._onInputChanged(r,s,a))}},this._pointerDownEvent=i=>{const r=this._getPointerType(i);let s=r===nt.Mouse?0:i.pointerId;if(r===nt.Touch){const a=this._activeTouchIds.indexOf(-1);if(a>=0)s=a,this._activeTouchIds[a]=i.pointerId;else{J.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[r]||(this._inputs[r]={}),this._inputs[r][s]?r===nt.Touch&&this._onDeviceConnected(r,s):this._addPointerDevice(r,s,i.clientX,i.clientY);const n=this._inputs[r][s];if(n){const a=n[Et.Horizontal],l=n[Et.Vertical];if(r===nt.Mouse){if(this._mouseId===-1&&(i.pointerId===void 0?this._mouseId=this._isUsingFirefox?0:1:this._mouseId=i.pointerId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch{}}else if(i.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(i.pointerId)}catch{}n[Et.Horizontal]=i.clientX,n[Et.Vertical]=i.clientY,n[i.button+2]=1;const c=i;c.inputIndex=i.button+2,this._onInputChanged(r,s,c),(a!==i.clientX||l!==i.clientY)&&(c.inputIndex=Et.Move,this._onInputChanged(r,s,c))}},this._pointerUpEvent=i=>{var r,s,n,a,l;const c=this._getPointerType(i),h=c===nt.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(c===nt.Touch){if(h===-1)return;this._activeTouchIds[h]=-1}const u=(r=this._inputs[c])===null||r===void 0?void 0:r[h];if(u&&u[i.button+2]!==0){const d=u[Et.Horizontal],f=u[Et.Vertical];u[Et.Horizontal]=i.clientX,u[Et.Vertical]=i.clientY,u[i.button+2]=0;const _=i;(d!==i.clientX||f!==i.clientY)&&(_.inputIndex=Et.Move,this._onInputChanged(c,h,_)),_.inputIndex=i.button+2,c===nt.Mouse&&this._mouseId>=0&&(!((n=(s=this._elementToAttachTo).hasPointerCapture)===null||n===void 0)&&n.call(s,this._mouseId))?this._elementToAttachTo.releasePointerCapture(this._mouseId):i.pointerId&&(!((l=(a=this._elementToAttachTo).hasPointerCapture)===null||l===void 0)&&l.call(a,i.pointerId))&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._onInputChanged(c,h,_),c===nt.Touch&&this._onDeviceDisconnected(c,h)}},this._pointerCancelEvent=i=>{var r,s,n,a;if(i.pointerType==="mouse"){const l=this._inputs[nt.Mouse][0];this._mouseId>=0&&(!((s=(r=this._elementToAttachTo).hasPointerCapture)===null||s===void 0)&&s.call(r,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let c=Et.LeftClick;c<=Et.BrowserForward;c++)if(l[c]===1){l[c]=0;const h=Kl.CreateDeviceEvent(nt.Mouse,0,c,0,this,this._elementToAttachTo);this._onInputChanged(nt.Mouse,0,h)}}else{const l=this._activeTouchIds.indexOf(i.pointerId);!((a=(n=this._elementToAttachTo).hasPointerCapture)===null||a===void 0)&&a.call(n,i.pointerId)&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._inputs[nt.Touch][l][Et.LeftClick]=0;const c=Kl.CreateDeviceEvent(nt.Touch,l,Et.LeftClick,0,this,this._elementToAttachTo,i.pointerId);this._onInputChanged(nt.Touch,l,c),this._activeTouchIds[l]=-1,this._onDeviceDisconnected(nt.Touch,l)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch{}this._pointerBlurEvent=()=>{var i,r,s,n,a;if(this.isDeviceAvailable(nt.Mouse)){const l=this._inputs[nt.Mouse][0];this._mouseId>=0&&(!((r=(i=this._elementToAttachTo).hasPointerCapture)===null||r===void 0)&&r.call(i,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let c=Et.LeftClick;c<=Et.BrowserForward;c++)if(l[c]===1){l[c]=0;const h=Kl.CreateDeviceEvent(nt.Mouse,0,c,0,this,this._elementToAttachTo);this._onInputChanged(nt.Mouse,0,h)}}if(this.isDeviceAvailable(nt.Touch)){const l=this._inputs[nt.Touch];for(let c=0;c<this._activeTouchIds.length;c++){const h=this._activeTouchIds[c];if(!((n=(s=this._elementToAttachTo).hasPointerCapture)===null||n===void 0)&&n.call(s,h)&&this._elementToAttachTo.releasePointerCapture(h),h!==-1&&((a=l[c])===null||a===void 0?void 0:a[Et.LeftClick])===1){l[c][Et.LeftClick]=0;const u=Kl.CreateDeviceEvent(nt.Touch,c,Et.LeftClick,0,this,this._elementToAttachTo,h);this._onInputChanged(nt.Touch,c,u),this._activeTouchIds[c]=-1,this._onDeviceDisconnected(nt.Touch,c)}}}},this._pointerWheelEvent=i=>{const r=nt.Mouse,s=0;this._inputs[r]||(this._inputs[r]=[]),this._inputs[r][s]||(this._pointerActive=!0,this._registerDevice(r,s,tv));const n=this._inputs[r][s];if(n){n[Et.MouseWheelX]=i.deltaX||0,n[Et.MouseWheelY]=i.deltaY||i.wheelDelta||0,n[Et.MouseWheelZ]=i.deltaZ||0;const a=i;n[Et.MouseWheelX]!==0&&(a.inputIndex=Et.MouseWheelX,this._onInputChanged(r,s,a)),n[Et.MouseWheelY]!==0&&(a.inputIndex=Et.MouseWheelY,this._onInputChanged(r,s,a)),n[Et.MouseWheelZ]!==0&&(a.inputIndex=Et.MouseWheelZ,this._onInputChanged(r,s,a))}},this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,e?{passive:!1}:!1),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(nt.Mouse)){const i=this._inputs[nt.Mouse][0];i[Et.MouseWheelX]=0,i[Et.MouseWheelY]=0,i[Et.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){const r=navigator.getGamepads()[t];if(r&&e===this._gamepads[t]){const s=this._inputs[e][t];i>=r.buttons.length?s[i]=r.axes[i-r.buttons.length].valueOf():s[i]=r.buttons[i].value}}_getGamepadDeviceType(e){return e.indexOf("054c")!==-1?e.indexOf("0ce6")!==-1?nt.DualSense:nt.DualShock:e.indexOf("Xbox One")!==-1||e.search("Xbox 360")!==-1||e.search("xinput")!==-1?nt.Xbox:e.indexOf("057e")!==-1?nt.Switch:nt.Generic}_getPointerType(e){let t=nt.Mouse;return(e.pointerType==="touch"||e.pointerType==="pen"||e.touches)&&(t=nt.Touch),t}}class iv{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new Q,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}class uS{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=n=>{for(let a=0;a<this._devices.length;a++){const l=this._devices[a];for(const c in l){const h=+c;n._addDevice(new iv(this._deviceInputSystem,a,h))}}this._registeredManagers.push(n)},this.unregisterManager=n=>{const a=this._registeredManagers.indexOf(n);a>-1&&this._registeredManagers.splice(a,1)};const t=Object.keys(nt).length/2;this._devices=new Array(t);const i=(n,a)=>{this._devices[n]||(this._devices[n]=new Array),this._devices[n][a]||(this._devices[n][a]=a);for(const l of this._registeredManagers){const c=new iv(this._deviceInputSystem,n,a);l._addDevice(c)}},r=(n,a)=>{var l;!((l=this._devices[n])===null||l===void 0)&&l[a]&&delete this._devices[n][a];for(const c of this._registeredManagers)c._removeDevice(n,a)},s=(n,a,l)=>{if(l)for(const c of this._registeredManagers)c._onInputChanged(n,a,l)};typeof _native<"u"?this._deviceInputSystem=new cS(i,r,s):this._deviceInputSystem=new hS(e,i,r,s)}dispose(){this._deviceInputSystem.dispose()}}class dS{getDeviceSource(e,t){if(t===void 0){if(this._firstDevice[e]===void 0)return null;t=this._firstDevice[e]}return!this._devices[e]||this._devices[e][t]===void 0?null:this._devices[e][t]}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(t=>!!t):[]}constructor(e){const t=Object.keys(nt).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new uS(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new Q(i=>{for(const r of this._devices)if(r)for(const s of r)s&&this.onDeviceConnectedObservable.notifyObserver(i,s)}),this.onDeviceDisconnectedObservable=new Q,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){var i,r;const s=(i=this._devices[e])===null||i===void 0?void 0:i[t];this.onDeviceDisconnectedObservable.notifyObservers(s),!((r=this._devices[e])===null||r===void 0)&&r[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){var r,s;(s=(r=this._devices[e])===null||r===void 0?void 0:r[t])===null||s===void 0||s.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case nt.Keyboard:case nt.Mouse:this._firstDevice[e]=0;break;case nt.Touch:case nt.DualSense:case nt.DualShock:case nt.Xbox:case nt.Switch:case nt.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t){for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}}break}}}}class rv{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}}class Cr{constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new Ie(0,0),this._previousStartingPointerPosition=new Ie(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._deviceSourceManager=null,this._scene=e||qe.LastCreatedScene,this._scene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new Ie(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){const t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,t){const i=this._scene,r=i.getEngine(),s=r.getInputElement();s&&(s.tabIndex=r.canvasTabIndex,i.doNotHandleCursors||(s.style.cursor=i.defaultCursor)),this._setCursorAndPointerOverMesh(e,t,i);for(const l of i._pointerMoveStage){const c=!!(e!=null&&e.pickedMesh);e=l.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,c,s)}const n=t.inputIndex>=Et.MouseWheelX&&t.inputIndex<=Et.MouseWheelZ?Qe.POINTERWHEEL:Qe.POINTERMOVE;i.onPointerMove&&(e=e||this._pickMove(t),i.onPointerMove(t,e,n));let a;e?(a=new ao(n,t,e),this._setRayOnPointerInfo(e,t)):(a=new ao(n,t,null,this),this._movePointerInfo=a),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(a,n)}_setRayOnPointerInfo(e,t){const i=this._scene;e&&i._pickingAvailable&&(e.ray||(e.ray=i.createPickingRay(t.offsetX,t.offsetY,H.Identity(),i.activeCamera)))}_addCameraPointerObserver(e,t){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,t)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,t,i){const r=this._scene,s=new lS(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(s.originalPickingInfo=e,s.ray=e.ray,e.originMesh&&(s.nearInteractionPickingInfo=e)),r.onPrePointerObservable.notifyObservers(s,i),!!s.skipOnPointerObservable}_pickMove(e){const t=this._scene,i=t.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,t.pointerMovePredicate,!1,t.cameraToUseForPointers,t.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(i,e,t),i}_setCursorAndPointerOverMesh(e,t,i){const s=i.getEngine().getInputElement();if(e!=null&&e.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,t.pointerId,e,t),!i.doNotHandleCursors&&s&&this._pointerOverMesh){const n=this._pointerOverMesh._getActionManagerForTrigger();n&&n.hasPointerTriggers&&(s.style.cursor=n.hoverCursor||i.hoverCursor)}}else this.setPointerOverMesh(null,t.pointerId,e,t)}simulatePointerMove(e,t){const i=new PointerEvent("pointermove",t);i.inputIndex=Et.Move,!this._checkPrePointerObservable(e,i,Qe.POINTERMOVE)&&this._processPointerMove(e,i)}simulatePointerDown(e,t){const i=new PointerEvent("pointerdown",t);i.inputIndex=i.button+2,!this._checkPrePointerObservable(e,i,Qe.POINTERDOWN)&&this._processPointerDown(e,i)}_processPointerDown(e,t){const i=this._scene;if(e!=null&&e.pickedMesh){this._pickedDownMesh=e.pickedMesh;const n=e.pickedMesh._getActionManagerForTrigger();if(n){if(n.hasPickTriggers)switch(n.processTrigger(5,is.CreateNew(e.pickedMesh,t)),t.button){case 0:n.processTrigger(2,is.CreateNew(e.pickedMesh,t));break;case 1:n.processTrigger(4,is.CreateNew(e.pickedMesh,t));break;case 2:n.processTrigger(3,is.CreateNew(e.pickedMesh,t));break}n.hasSpecificTrigger(8)&&window.setTimeout(()=>{const a=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,l=>l.isPickable&&l.isVisible&&l.isReady()&&l.actionManager&&l.actionManager.hasSpecificTrigger(8)&&l===this._pickedDownMesh,!1,i.cameraToUseForPointers);a!=null&&a.pickedMesh&&n&&this._totalPointersPressed!==0&&Date.now()-this._startingPointerTime>Cr.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,n.processTrigger(8,is.CreateNew(a.pickedMesh,t)))},Cr.LongPressDelay)}}else for(const n of i._pointerDownStage)e=n.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,!1);let r;const s=Qe.POINTERDOWN;e?(i.onPointerDown&&i.onPointerDown(t,e,s),r=new ao(s,t,e),this._setRayOnPointerInfo(e,t)):r=new ao(s,t,null,this),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(r,s)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,t,i){const r=new PointerEvent("pointerup",t);r.inputIndex=Et.Move;const s=new rv;i?s.doubleClick=!0:s.singleClick=!0,!this._checkPrePointerObservable(e,r,Qe.POINTERUP)&&this._processPointerUp(e,r,s)}_processPointerUp(e,t,i){const r=this._scene;if(e!=null&&e.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(r.onPointerPick&&r.onPointerPick(t,e),i.singleClick&&!i.ignore&&r.onPointerObservable.observers.length>this._cameraObserverCount)){const n=Qe.POINTERPICK,a=new ao(n,t,e);this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(a,n)}const s=e.pickedMesh._getActionManagerForTrigger();if(s&&!i.ignore){s.processTrigger(7,is.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&s.processTrigger(1,is.CreateNew(e.pickedMesh,t,e));const n=e.pickedMesh._getActionManagerForTrigger(6);i.doubleClick&&n&&n.processTrigger(6,is.CreateNew(e.pickedMesh,t,e))}}else if(!i.ignore)for(const s of r._pointerUpStage)e=s.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,i.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const s=this._pickedDownMesh._getActionManagerForTrigger(16);s&&s.processTrigger(16,is.CreateNew(this._pickedDownMesh,t))}if(!i.ignore){const s=new ao(Qe.POINTERUP,t,e);if(this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(s,Qe.POINTERUP),r.onPointerUp&&r.onPointerUp(t,e,Qe.POINTERUP),!i.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let n=0;if(i.singleClick?n=Qe.POINTERTAP:i.doubleClick&&(n=Qe.POINTERDOUBLETAP),n){const a=new ao(n,t,e);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(n)&&r.onPointerObservable.notifyObservers(a,n)}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=!0,t=!0,i=!0,r=null){const s=this._scene,n=s.getEngine();r||(r=n.getInputElement()),this._alreadyAttached&&this.detachControl(),r&&(this._alreadyAttachedTo=r),this._deviceSourceManager=new dS(n),this._initActionManager=a=>{if(!this._meshPickProceed){const l=s.skipPointerUpPicking||s._registeredActions===0&&!this._checkForPicking()&&!s.onPointerUp?null:s.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,s.pointerUpPredicate,!1,s.cameraToUseForPointers);this._currentPickResult=l,l&&(a=l.hit&&l.pickedMesh?l.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return a},this._delayedSimpleClick=(a,l,c)=>{(Date.now()-this._previousStartingPointerTime>Cr.DoubleClickDelay&&!this._doubleClickOccured||a!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,l.singleClick=!0,l.ignore=!1,c(l,this._currentPickResult))},this._initClickEvent=(a,l,c,h)=>{const u=new rv;this._currentPickResult=null;let d=null,f=a.hasSpecificMask(Qe.POINTERPICK)||l.hasSpecificMask(Qe.POINTERPICK)||a.hasSpecificMask(Qe.POINTERTAP)||l.hasSpecificMask(Qe.POINTERTAP)||a.hasSpecificMask(Qe.POINTERDOUBLETAP)||l.hasSpecificMask(Qe.POINTERDOUBLETAP);!f&&jn&&(d=this._initActionManager(d,u),d&&(f=d.hasPickTriggers));let _=!1;if(f){const p=c.button;if(u.hasSwiped=this._isPointerSwiping(),!u.hasSwiped){let m=!Cr.ExclusiveDoubleClickMode;m||(m=!a.hasSpecificMask(Qe.POINTERDOUBLETAP)&&!l.hasSpecificMask(Qe.POINTERDOUBLETAP),m&&!jn.HasSpecificTrigger(6)&&(d=this._initActionManager(d,u),d&&(m=!d.hasSpecificTrigger(6)))),m?(Date.now()-this._previousStartingPointerTime>Cr.DoubleClickDelay||p!==this._previousButtonPressed)&&(u.singleClick=!0,h(u,this._currentPickResult),_=!0):(this._previousDelayedSimpleClickTimeout=this._delayedSimpleClickTimeout,this._delayedSimpleClickTimeout=window.setTimeout(this._delayedSimpleClick.bind(this,p,u,h),Cr.DoubleClickDelay));let T=a.hasSpecificMask(Qe.POINTERDOUBLETAP)||l.hasSpecificMask(Qe.POINTERDOUBLETAP);!T&&jn.HasSpecificTrigger(6)&&(d=this._initActionManager(d,u),d&&(T=d.hasSpecificTrigger(6))),T&&(p===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<Cr.DoubleClickDelay&&!this._doubleClickOccured?(!u.hasSwiped&&!this._isPointerSwiping()?(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,u.doubleClick=!0,u.ignore=!1,Cr.ExclusiveDoubleClickMode&&this._previousDelayedSimpleClickTimeout&&clearTimeout(this._previousDelayedSimpleClickTimeout),this._previousDelayedSimpleClickTimeout=this._delayedSimpleClickTimeout,h(u,this._currentPickResult)):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=p,Cr.ExclusiveDoubleClickMode?(this._previousDelayedSimpleClickTimeout&&clearTimeout(this._previousDelayedSimpleClickTimeout),this._previousDelayedSimpleClickTimeout=this._delayedSimpleClickTimeout,h(u,this._previousPickResult)):h(u,this._currentPickResult)),_=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=p))}}_||h(u,this._currentPickResult)},this._onPointerMove=a=>{if(a.pointerId===void 0&&(a.pointerId=0),this._updatePointerPosition(a),!this._isSwiping&&this._swipeButtonPressed!==-1&&(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>Cr.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>Cr.DragMovementThreshold),this._checkPrePointerObservable(null,a,a.inputIndex>=Et.MouseWheelX&&a.inputIndex<=Et.MouseWheelZ?Qe.POINTERWHEEL:Qe.POINTERMOVE)||!s.cameraToUseForPointers&&!s.activeCamera)return;if(s.skipPointerMovePicking){this._processPointerMove(new Vs,a);return}s.pointerMovePredicate||(s.pointerMovePredicate=c=>c.isPickable&&c.isVisible&&c.isReady()&&c.isEnabled()&&(c.enablePointerMoveEvents||s.constantlyUpdateMeshUnderPointer||c._getActionManagerForTrigger()!==null)&&(!s.cameraToUseForPointers||(s.cameraToUseForPointers.layerMask&c.layerMask)!==0));const l=s._registeredActions>0?this._pickMove(a):null;this._processPointerMove(l,a)},this._onPointerDown=a=>{if(this._totalPointersPressed++,this._pickedDownMesh=null,this._meshPickProceed=!1,a.pointerId===void 0&&(a.pointerId=0),this._updatePointerPosition(a),this._swipeButtonPressed===-1&&(this._swipeButtonPressed=a.button),s.preventDefaultOnPointerDown&&r&&(a.preventDefault(),r.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,a,Qe.POINTERDOWN)||!s.cameraToUseForPointers&&!s.activeCamera)return;this._pointerCaptures[a.pointerId]=!0,s.pointerDownPredicate||(s.pointerDownPredicate=c=>c.isPickable&&c.isVisible&&c.isReady()&&c.isEnabled()&&(!s.cameraToUseForPointers||(s.cameraToUseForPointers.layerMask&c.layerMask)!==0)),this._pickedDownMesh=null;let l;s.skipPointerDownPicking||s._registeredActions===0&&!this._checkForPicking()&&!s.onPointerDown?l=new Vs:l=s.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,s.pointerDownPredicate,!1,s.cameraToUseForPointers),this._processPointerDown(l,a)},this._onPointerUp=a=>{this._totalPointersPressed!==0&&(this._totalPointersPressed--,this._pickedUpMesh=null,this._meshPickProceed=!1,a.pointerId===void 0&&(a.pointerId=0),this._updatePointerPosition(a),s.preventDefaultOnPointerUp&&r&&(a.preventDefault(),r.focus()),this._initClickEvent(s.onPrePointerObservable,s.onPointerObservable,a,(l,c)=>{if(s.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!l.ignore)){if(this._checkPrePointerObservable(null,a,Qe.POINTERUP)){this._swipeButtonPressed===a.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1);return}l.hasSwiped||(l.singleClick&&s.onPrePointerObservable.hasSpecificMask(Qe.POINTERTAP)&&this._checkPrePointerObservable(null,a,Qe.POINTERTAP)&&(this._skipPointerTap=!0),l.doubleClick&&s.onPrePointerObservable.hasSpecificMask(Qe.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,a,Qe.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}if(!this._pointerCaptures[a.pointerId]){this._swipeButtonPressed===a.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1);return}a.buttons===0&&(this._pointerCaptures[a.pointerId]=!1),!(!s.cameraToUseForPointers&&!s.activeCamera)&&(s.pointerUpPredicate||(s.pointerUpPredicate=h=>h.isPickable&&h.isVisible&&h.isReady()&&h.isEnabled()&&(!s.cameraToUseForPointers||(s.cameraToUseForPointers.layerMask&h.layerMask)!==0)),!this._meshPickProceed&&(jn&&jn.HasTriggers||this._checkForPicking()||s.onPointerUp)&&this._initActionManager(null,l),c||(c=this._currentPickResult),this._processPointerUp(c,a,l),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===a.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))}))},this._onKeyDown=a=>{const l=Ml.KEYDOWN;if(s.onPreKeyboardObservable.hasObservers()){const c=new jg(l,a);if(s.onPreKeyboardObservable.notifyObservers(c,l),c.skipOnKeyboardObservable)return}if(s.onKeyboardObservable.hasObservers()){const c=new z_(l,a);s.onKeyboardObservable.notifyObservers(c,l)}s.actionManager&&s.actionManager.processTrigger(14,is.CreateNewFromScene(s,a))},this._onKeyUp=a=>{const l=Ml.KEYUP;if(s.onPreKeyboardObservable.hasObservers()){const c=new jg(l,a);if(s.onPreKeyboardObservable.notifyObservers(c,l),c.skipOnKeyboardObservable)return}if(s.onKeyboardObservable.hasObservers()){const c=new z_(l,a);s.onKeyboardObservable.notifyObservers(c,l)}s.actionManager&&s.actionManager.processTrigger(15,is.CreateNewFromScene(s,a))},this._deviceSourceManager.onDeviceConnectedObservable.add(a=>{a.deviceType===nt.Mouse?a.onInputChangedObservable.add(l=>{l.inputIndex===Et.LeftClick||l.inputIndex===Et.MiddleClick||l.inputIndex===Et.RightClick||l.inputIndex===Et.BrowserBack||l.inputIndex===Et.BrowserForward?t&&a.getInput(l.inputIndex)===1?this._onPointerDown(l):e&&a.getInput(l.inputIndex)===0&&this._onPointerUp(l):i&&(l.inputIndex===Et.Move?this._onPointerMove(l):(l.inputIndex===Et.MouseWheelX||l.inputIndex===Et.MouseWheelY||l.inputIndex===Et.MouseWheelZ)&&this._onPointerMove(l))}):a.deviceType===nt.Touch?a.onInputChangedObservable.add(l=>{l.inputIndex===Et.LeftClick&&(t&&a.getInput(l.inputIndex)===1?(this._onPointerDown(l),this._totalPointersPressed>1&&(this._isMultiTouchGesture=!0)):e&&a.getInput(l.inputIndex)===0&&(this._onPointerUp(l),this._totalPointersPressed===0&&(this._isMultiTouchGesture=!1))),i&&l.inputIndex===Et.Move&&this._onPointerMove(l)}):a.deviceType===nt.Keyboard&&a.onInputChangedObservable.add(l=>{l.type==="keydown"?this._onKeyDown(l):l.type==="keyup"&&this._onKeyUp(l)})}),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,t=0,i,r){if(this._meshUnderPointerId[t]===e&&(!e||!e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const s=this._meshUnderPointerId[t];let n;s&&(n=s._getActionManagerForTrigger(10),n&&n.processTrigger(10,is.CreateNew(s,r,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,n=e._getActionManagerForTrigger(9),n&&n.processTrigger(9,is.CreateNew(e,r,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null)}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(const t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]}}Cr.DragMovementThreshold=10;Cr.LongPressDelay=500;Cr.DoubleClickDelay=300;Cr.ExclusiveDoubleClickMode=!1;class ya{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,t){ya.Enabled&&(this._current+=e,t&&this._fetchResult())}beginMonitoring(){ya.Enabled&&(this._startMonitoringTime=Us.Now)}endMonitoring(e=!0){if(!ya.Enabled)return;e&&this.fetchNewFrame();const t=Us.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const e=Us.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}ya.Enabled=!0;class Tn{constructor(e,t,i,r){this.normal=new x(e,t,i),this.d=r}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new Tn(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=e*397^(this.d|0),e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return e!==0&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=Tn._TmpMatrix;e.invertToRef(t);const i=t.m,r=this.normal.x,s=this.normal.y,n=this.normal.z,a=this.d,l=r*i[0]+s*i[1]+n*i[2]+a*i[3],c=r*i[4]+s*i[5]+n*i[6]+a*i[7],h=r*i[8]+s*i[9]+n*i[10]+a*i[11],u=r*i[12]+s*i[13]+n*i[14]+a*i[15];return new Tn(l,c,h,u)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){const r=t.x-e.x,s=t.y-e.y,n=t.z-e.z,a=i.x-e.x,l=i.y-e.y,c=i.z-e.z,h=s*c-n*l,u=n*a-r*c,d=r*l-s*a,f=Math.sqrt(h*h+u*u+d*d);let _;return f!==0?_=1/f:_=0,this.normal.x=h*_,this.normal.y=u*_,this.normal.z=d*_,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return x.Dot(this.normal,e)<=t}signedDistanceTo(e){return x.Dot(e,this.normal)+this.d}static FromArray(e){return new Tn(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){const r=new Tn(0,0,0,0);return r.copyFromPoints(e,t,i),r}static FromPositionAndNormal(e,t){const i=new Tn(0,0,0,0);return t.normalize(),i.normal=t,i.d=-(t.x*e.x+t.y*e.y+t.z*e.z),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){const r=-(t.x*e.x+t.y*e.y+t.z*e.z);return x.Dot(i,t)+r}}Tn._TmpMatrix=H.Identity();class aa{static GetPlanes(e){const t=[];for(let i=0;i<6;i++)t.push(new Tn(0,0,0,0));return aa.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}static GetFarPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}static GetLeftPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}static GetRightPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}static GetTopPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}static GetBottomPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}static GetPlanesToRef(e,t){aa.GetNearPlaneToRef(e,t[0]),aa.GetFarPlaneToRef(e,t[1]),aa.GetLeftPlaneToRef(e,t[2]),aa.GetRightPlaneToRef(e,t[3]),aa.GetTopPlaneToRef(e,t[4]),aa.GetBottomPlaneToRef(e,t[5])}}class df{static get UniqueId(){const e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}df._UniqueIdCounter=1;class fi{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}fi.FALLOFF_DEFAULT=0;fi.FALLOFF_PHYSICAL=1;fi.FALLOFF_GLTF=2;fi.FALLOFF_STANDARD=3;fi.LIGHTMAP_DEFAULT=0;fi.LIGHTMAP_SPECULAR=1;fi.LIGHTMAP_SHADOWSONLY=2;fi.INTENSITYMODE_AUTOMATIC=0;fi.INTENSITYMODE_LUMINOUSPOWER=1;fi.INTENSITYMODE_LUMINOUSINTENSITY=2;fi.INTENSITYMODE_ILLUMINANCE=3;fi.INTENSITYMODE_LUMINANCE=4;fi.LIGHTTYPEID_POINTLIGHT=0;fi.LIGHTTYPEID_DIRECTIONALLIGHT=1;fi.LIGHTTYPEID_SPOTLIGHT=2;fi.LIGHTTYPEID_HEMISPHERICLIGHT=3;var la;(function(o){o[o.BackwardCompatible=0]="BackwardCompatible",o[o.Intermediate=1]="Intermediate",o[o.Aggressive=2]="Aggressive"})(la||(la={}));class Ne extends Er{static DefaultMaterialFactory(e){throw pt("StandardMaterial")}static CollisionCoordinatorFactory(){throw pt("DefaultCollisionCoordinator")}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.markAllMaterialsAsDirty(1))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority)switch(this._performancePriority=e,e){case la.BackwardCompatible:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case la.Intermediate:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case la.Aggressive:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1;break}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return Cr.DragMovementThreshold}static set DragMovementThreshold(e){Cr.DragMovementThreshold=e}static get LongPressDelay(){return Cr.LongPressDelay}static set LongPressDelay(e){Cr.LongPressDelay=e}static get DoubleClickDelay(){return Cr.DoubleClickDelay}static set DoubleClickDelay(e){Cr.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return Cr.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){Cr.ExclusiveDoubleClickMode=e}bindEyePosition(e,t="vEyePosition",i=!1){var r;const s=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:(r=this.activeCamera.globalPosition)!==null&&r!==void 0?r:this.activeCamera.devicePosition,n=this.useRightHandedSystem===(this._mirroredCameraPosition!=null);return j.Vector4[0].set(s.x,s.y,s.z,n?-1:1),e&&(i?e.setFloat3(t,j.Vector4[0].x,j.Vector4[0].y,j.Vector4[0].z):e.setVector4(t,j.Vector4[0])),j.Vector4[0]}finalizeSceneUbo(){const e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",t.x,t.y,t.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=Yx(e,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=Ne.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=Ne.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);const t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(e){for(const t of this._components)if(t.name===e)return t;return null}constructor(e,t){super(),this._inputManager=new Cr(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new Ye(.2,.2,.3,1),this.ambientColor=new ge(0,0,0),this.environmentIntensity=1,this._performancePriority=la.BackwardCompatible,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=new Array,this.onDisposeObservable=new Q,this._onDisposeObserver=null,this.onBeforeRenderObservable=new Q,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new Q,this.onAfterRenderCameraObservable=new Q,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new Q,this.onAfterAnimationsObservable=new Q,this.onBeforeDrawPhaseObservable=new Q,this.onAfterDrawPhaseObservable=new Q,this.onReadyObservable=new Q,this.onBeforeCameraRenderObservable=new Q,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new Q,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new Q,this.onAfterActiveMeshesEvaluationObservable=new Q,this.onBeforeParticlesRenderingObservable=new Q,this.onAfterParticlesRenderingObservable=new Q,this.onDataLoadedObservable=new Q,this.onNewCameraAddedObservable=new Q,this.onCameraRemovedObservable=new Q,this.onNewLightAddedObservable=new Q,this.onLightRemovedObservable=new Q,this.onNewGeometryAddedObservable=new Q,this.onGeometryRemovedObservable=new Q,this.onNewTransformNodeAddedObservable=new Q,this.onTransformNodeRemovedObservable=new Q,this.onNewMeshAddedObservable=new Q,this.onMeshRemovedObservable=new Q,this.onNewSkeletonAddedObservable=new Q,this.onSkeletonRemovedObservable=new Q,this.onNewMaterialAddedObservable=new Q,this.onNewMultiMaterialAddedObservable=new Q,this.onMaterialRemovedObservable=new Q,this.onMultiMaterialRemovedObservable=new Q,this.onNewTextureAddedObservable=new Q,this.onTextureRemovedObservable=new Q,this.onBeforeRenderTargetsRenderObservable=new Q,this.onAfterRenderTargetsRenderObservable=new Q,this.onBeforeStepObservable=new Q,this.onAfterStepObservable=new Q,this.onActiveCameraChanged=new Q,this.onActiveCamerasChanged=new Q,this.onBeforeRenderingGroupObservable=new Q,this.onAfterRenderingGroupObservable=new Q,this.onMeshImportedObservable=new Q,this.onAnimationFileImportedObservable=new Q,this._registeredForLateAnimationBindings=new hl(256),this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1,this.onPrePointerObservable=new Q,this.onPointerObservable=new Q,this.onPreKeyboardObservable=new Q,this.onKeyboardObservable=new Q,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=Ne.FOGMODE_NONE,this.fogColor=new ge(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new x(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=new Array,this.importedMeshesFiles=new Array,this.probesEnabled=!0,this._meshesForIntersections=new hl(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new ya,this._activeIndices=new ya,this._activeParticles=new ya,this._activeBones=new ya,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new Lr(256),this._processedMaterials=new Lr(256),this._renderTargets=new hl(256),this._materialsRenderTargets=new hl(256),this._activeParticleSystems=new Lr(256),this._activeSkeletons=new hl(32),this._softwareSkinnedMeshes=new hl(32),this._activeAnimatables=new Array,this._transformMatrix=H.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=pr.Create(),this._beforeClearStage=pr.Create(),this._beforeRenderTargetClearStage=pr.Create(),this._gatherRenderTargetsStage=pr.Create(),this._gatherActiveCameraRenderTargetsStage=pr.Create(),this._isReadyForMeshStage=pr.Create(),this._beforeEvaluateActiveMeshStage=pr.Create(),this._evaluateSubMeshStage=pr.Create(),this._preActiveMeshStage=pr.Create(),this._cameraDrawRenderTargetStage=pr.Create(),this._beforeCameraDrawStage=pr.Create(),this._beforeRenderTargetDrawStage=pr.Create(),this._beforeRenderingGroupDrawStage=pr.Create(),this._beforeRenderingMeshStage=pr.Create(),this._afterRenderingMeshStage=pr.Create(),this._afterRenderingGroupDrawStage=pr.Create(),this._afterCameraDrawStage=pr.Create(),this._afterCameraPostProcessStage=pr.Create(),this._afterRenderTargetDrawStage=pr.Create(),this._afterRenderTargetPostProcessStage=pr.Create(),this._afterRenderStage=pr.Create(),this._pointerMoveStage=pr.Create(),this._pointerDownStage=pr.Create(),this._pointerUpStage=pr.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=new Array;const i={useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1,...t};this._engine=e||qe.LastCreatedEngine,i.virtual?this._engine._virtualScenes.push(this):(qe._LastCreatedScene=this,this._engine.scenes.push(this)),this._uid=null,this._renderingManager=new ys(this),zd&&(this.postProcessManager=new zd(this)),Ar()&&this.attachControl(),this._createUbo(),wt&&(this._imageProcessingConfiguration=new wt),this.setDefaultCandidateProviders(),i.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=i.useMaterialMeshMap,this.useClonedMeshMap=i.useClonedMeshMap,(!t||!t.virtual)&&this._engine.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=this._getDefaultMeshCandidates.bind(this),this.getActiveSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getIntersectingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getCollidingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,i=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return this._animationRatio!==void 0?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,i=!0){this._inputManager.attachControl(e,t,i)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){if(this._isDisposed)return!1;let t;const i=this.getEngine();let r=!0;for(this._pendingData.length>0&&(r=!1),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),t=0;t<this.meshes.length;t++){const s=this.meshes[t];if(!s.subMeshes||s.subMeshes.length===0)continue;if(!s.isReady(!0)){r=!1;continue}const n=s.hasThinInstances||s.getClassName()==="InstancedMesh"||s.getClassName()==="InstancedLinesMesh"||i.getCaps().instancedArrays&&s.instances.length>0;for(const l of this._isReadyForMeshStage)l.action(s,n)||(r=!1);if(!e)continue;const a=s.material||this.defaultMaterial;if(a)if(a._storeEffectOnSubMeshes)for(const l of s.subMeshes){const c=l.getMaterial();c&&c.hasRenderTargetTextures&&c.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(c)===-1&&(this._processedMaterials.push(c),this._materialsRenderTargets.concatWithNoDuplicate(c.getRenderTargetTextures()))}else a.hasRenderTargetTextures&&a.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(a)===-1&&(this._processedMaterials.push(a),this._materialsRenderTargets.concatWithNoDuplicate(a.getRenderTargetTextures()))}if(!r||!i.areAllEffectsReady())return!1;if(e){for(t=0;t<this._materialsRenderTargets.length;++t)if(!this._materialsRenderTargets.data[t].isReadyForRendering())return!1}for(t=0;t<this.geometries.length;t++)if(this.geometries[t].delayLoadState===2)return!1;if(this.activeCameras&&this.activeCameras.length>0){for(const s of this.activeCameras)if(!s.isReady(!0))return!1}else if(this.activeCamera&&!this.activeCamera.isReady(!0))return!1;for(const s of this.particleSystems)if(!s.isReady())return!1;return!0}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){const t=()=>{e(),setTimeout(()=>{this.unregisterBeforeRender(t)})};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){t!==void 0?setTimeout(()=>{this._executeOnceBeforeRender(e)},t):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){const t=this.isLoading,i=this._pendingData.indexOf(e);i!==-1&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.addOnce(e),this._executeWhenReadyTimeoutId===null&&this._checkIsReady(t)}whenReadyAsync(e=!1){return new Promise(t=>{this.executeWhenReady(()=>{t()},e)})}_checkIsReady(e=!1){if(this._registerTransientComponents(),this.isReady(e)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(e)},100)}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=Us.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,i,r){!i&&!r&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),!(this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag)&&(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?aa.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=aa.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,r):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e){const t=new $e(this._engine,void 0,!1,e??"scene");return t.addUniform("viewProjection",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return df.UniqueId}addMesh(e,t=!1){this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(i=>{this.addMesh(i)}))}removeMesh(e,t=!1){const i=this.meshes.indexOf(e);return i!==-1&&(this.meshes[i]=this.meshes[this.meshes.length-1],this.meshes.pop(),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(r=>{this.removeMesh(r)}),i}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneTransformNodesArray!==-1||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){const t=e._indexInSceneTransformNodesArray;if(t!==-1){if(t!==this.transformNodes.length-1){const i=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=i,i._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){const t=this.skeletons.indexOf(e);return t!==-1&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){const t=this.morphTargetManagers.indexOf(e);return t!==-1&&this.morphTargetManagers.splice(t,1),t}removeLight(e){const t=this.lights.indexOf(e);if(t!==-1){for(const i of this.meshes)i._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){const t=this.cameras.indexOf(e);if(t!==-1&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){const i=this.activeCameras.indexOf(e);i!==-1&&this.activeCameras.splice(i,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){const t=this.particleSystems.indexOf(e);return t!==-1&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),t}removeAnimation(e){const t=this.animations.indexOf(e);return t!==-1&&this.animations.splice(t,1),t}stopAnimation(e,t,i){}removeAnimationGroup(e){const t=this.animationGroups.indexOf(e);return t!==-1&&this.animationGroups.splice(t,1),t}removeMultiMaterial(e){const t=this.multiMaterials.indexOf(e);return t!==-1&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){const t=e._indexInSceneMaterialArray;if(t!==-1&&t<this.materials.length){if(t!==this.materials.length-1){const i=this.materials[this.materials.length-1];this.materials[t]=i,i._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){const t=this.actionManagers.indexOf(e);return t!==-1&&this.actionManagers.splice(t,1),t}removeTexture(e){const t=this.textures.indexOf(e);return t!==-1&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(const t of this.meshes)t.lightSources.indexOf(e)===-1&&(t.lightSources.push(e),t._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(e)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(fi.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),this.onNewCameraAddedObservable.notifyObservers(e),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),this.onNewSkeletonAddedObservable.notifyObservers(e))}addParticleSystem(e){this._blockEntityCollection||this.particleSystems.push(e)}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||this.animationGroups.push(e)}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),this.onNewMultiMaterialAddedObservable.notifyObservers(e))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneMaterialArray!==-1||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),this.onNewMaterialAddedObservable.notifyObservers(e))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}switchActiveCamera(e,t=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){const t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){const t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let i=0;i<this.materials.length;i++){const r=this.materials[i];if(t(r))return r}if(e)for(let i=0;i<this.multiMaterials.length;i++){const r=this.multiMaterials[i];if(t(r))return r}return null}getMaterialByUniqueID(e,t=!1){return this._getMaterial(t,i=>i.uniqueId===e)}getMaterialById(e,t=!1){return this._getMaterial(t,i=>i.id===e)}getMaterialByName(e,t=!1){return this._getMaterial(t,i=>i.name===e)}getLastMaterialById(e,t=!1){for(let i=this.materials.length-1;i>=0;i--)if(this.materials[i].id===e)return this.materials[i];if(t){for(let i=this.multiMaterials.length-1;i>=0;i--)if(this.multiMaterials[i].id===e)return this.multiMaterials[i]}return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let r=0;r<i.bones.length;r++)if(i.bones[r].id===e)return i.bones[r]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let r=0;r<i.bones.length;r++)if(i.bones[r].name===e)return i.bones[r]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){const t=this._geometriesByUniqueId[e];if(t!==void 0)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}pushGeometry(e,t){return!t&&this._getGeometryByUniqueId(e.uniqueId)?!1:(this.addGeometry(e),this.onNewGeometryAddedObservable.notifyObservers(e),!0)}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(t=this._geometriesByUniqueId[e.uniqueId],t===void 0)return!1}else if(t=this.geometries.indexOf(e),t<0)return!1;if(t!==this.geometries.length-1){const i=this.geometries[this.geometries.length-1];i&&(this.geometries[t]=i,this._geometriesByUniqueId&&(this._geometriesByUniqueId[i.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter(function(t){return t.id===e})}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter(function(t){return t.id===e})}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){const t=this.getMeshById(e);if(t)return t;const i=this.getTransformNodeById(e);if(i)return i;const r=this.getLightById(e);if(r)return r;const s=this.getCameraById(e);if(s)return s;const n=this.getBoneById(e);return n||null}getNodeByName(e){const t=this.getMeshByName(e);if(t)return t;const i=this.getTransformNodeByName(e);if(i)return i;const r=this.getLightByName(e);if(r)return r;const s=this.getCameraByName(e);if(s)return s;const n=this.getBoneByName(e);return n||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let r=0;r<i.numTargets;++r){const s=i.getTarget(r);if(s.id===e)return s}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let r=0;r<i.numTargets;++r){const s=i.getTarget(r);if(s.name===e)return s}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){const i=this.postProcesses[t];if(i.name===e)return i}return null}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}get uid(){return this._uid||(this._uid=J.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new G_),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new G_),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,i,r){if(r||e.isInFrustum(this._frustumPlanes)){for(const n of this._evaluateSubMeshStage)n.action(t,e);const s=e.getMaterial();s!=null&&(s.hasRenderTargetTextures&&s.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(s)===-1&&(this._processedMaterials.push(s),this._materialsRenderTargets.concatWithNoDuplicate(s.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,s))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){const t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,i,r=!0,s=!1){return this.executeWhenReady(()=>{if(!this.activeCamera){i&&i("No active camera found");return}if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=s,this._skipEvaluateActiveMeshesCompletely=e,r)for(let n=0;n<this._activeMeshes.length;n++)this._activeMeshes.data[n]._freeze();t&&t()}),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){!(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>e.dispose())}_evaluateActiveMeshes(){var e;if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1){this._activeMeshes.length>0&&((e=this.activeCamera)===null||e===void 0||e._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const r=this._activeMeshes.length;for(let s=0;s<r;s++)this._activeMeshes.data[s].computeWorldMatrix()}if(this._activeParticleSystems){const r=this._activeParticleSystems.length;for(let s=0;s<r;s++)this._activeParticleSystems.data[s].animate()}this._renderingManager.resetSprites();return}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const r of this._beforeEvaluateActiveMeshStage)r.action();const t=this.getActiveMeshCandidates(),i=t.length;for(let r=0;r<i;r++){const s=t.data[r];if(s._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,s.isBlocked||(this._totalVertices.addCount(s.getTotalVertices(),!1),!s.isReady()||!s.isEnabled()||s.scaling.hasAZeroComponent))continue;s.computeWorldMatrix(),s.actionManager&&s.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(s);let n=this.customLODSelector?this.customLODSelector(s,this.activeCamera):s.getLOD(this.activeCamera);if(s._internalAbstractMeshDataInfo._currentLOD=n,s._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,n!=null&&(n!==s&&n.billboardMode!==0&&n.computeWorldMatrix(),s._preActivate(),s.isVisible&&s.visibility>0&&s.layerMask&this.activeCamera.layerMask&&(this._skipFrustumClipping||s.alwaysSelectAsActiveMesh||s.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(s),this.activeCamera._activeMeshes.push(s),n!==s&&n._activate(this._renderId,!1);for(const a of this._preActiveMeshStage)a.action(s);s._activate(this._renderId,!1)&&(s.isAnInstance?s._internalAbstractMeshDataInfo._actAsRegularMesh&&(n=s):n._internalAbstractMeshDataInfo._onlyForInstances=!1,n._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(s,n)),s._postActivate()}}if(this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let r=0;r<this.particleSystems.length;r++){const s=this.particleSystems[r];if(!s.isStarted()||!s.emitter)continue;const n=s.emitter;(!n.position||n.isEnabled())&&(this._activeParticleSystems.push(s),s.animate(),this._renderingManager.dispatchParticles(s))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_activeMesh(e,t){this._skeletonsEnabled&&t.skeleton!==null&&t.skeleton!==void 0&&(this._activeSkeletons.pushNoDuplicate(t.skeleton)&&(t.skeleton.prepare(),this._activeBones.addCount(t.skeleton.bones.length,!1)),t.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(t));let i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){const r=this.getActiveSubMeshCandidates(t),s=r.length;i=i||s===1;for(let n=0;n<s;n++){const a=r.data[n];this._evaluateSubMesh(a,t,e,i)}}}updateTransformMatrix(e){if(this.activeCamera)if(this.activeCamera._renderingMultiview){const t=this.activeCamera._rigCameras[0],i=this.activeCamera._rigCameras[1];this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e),i.getViewMatrix(),i.getProjectionMatrix(e))}else this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(!(e&&e._multiviewTexture))if(e&&e.outputRenderTarget&&!e._renderingMultiview){const t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):t.skipInitialClear||(this.autoClear&&this._engine.clear(t.clearColor||this.clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,i=!0){var r,s,n;if(e&&e._skipRendering)return;const a=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(a.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i){let c=!0;e._renderingMultiview&&e.outputRenderTarget&&(c=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=c)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let c=0;c<this._softwareSkinnedMeshes.length;c++){const h=this._softwareSkinnedMeshes.data[c];h.applySkeleton(h.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const c of this._gatherActiveCameraRenderTargetsStage)c.action(this._renderTargets);let l=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){J.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let c=0;c<this._renderTargets.length;c++){const h=this._renderTargets.data[c];if(h._shouldRender()){this._renderId++;const u=h.activeCamera&&h.activeCamera!==this.activeCamera;h.render(u,this.dumpNextRenderTargets),l=!0}}J.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(const c of this._cameraDrawRenderTargetStage)l=c.action(this.activeCamera)||l;this._intermediateRendering=!1}this._engine.currentRenderPassId=(n=(s=(r=e.outputRenderTarget)===null||r===void 0?void 0:r.renderPassId)!==null&&s!==void 0?s:e.renderPassId)!==null&&n!==void 0?n:0,l&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!e._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(const c of this._beforeCameraDrawStage)c.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),a.snapshotRendering&&a.snapshotRenderingMode===1&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const c of this._afterCameraDrawStage)c.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){const c=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,c)}for(const c of this._afterCameraPostProcessStage)c.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(e.cameraRigMode===0||e._renderingMultiview){e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),this.onAfterRenderCameraObservable.notifyObservers(e);return}if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let i=0;i<e._rigCameras.length;i++)this._renderForCamera(e._rigCameras[i],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){const t=this._meshesForIntersections.data[e];if(t.actionManager)for(let i=0;t.actionManager&&i<t.actionManager.actions.length;i++){const r=t.actionManager.actions[i];if(r.trigger===12||r.trigger===13){const s=r.getTriggerParameter(),n=s.mesh?s.mesh:s,a=n.intersectsMesh(t,s.usePreciseIntersection),l=t._intersectionsInProgress.indexOf(n);a&&l===-1?r.trigger===12?(r._executeCurrent(is.CreateNew(t,void 0,n)),t._intersectionsInProgress.push(n)):r.trigger===13&&t._intersectionsInProgress.push(n):!a&&l>-1&&(r.trigger===13&&r._executeCurrent(is.CreateNew(t,void 0,n)),(!t.actionManager.hasSpecificTrigger(13,c=>{const h=c.mesh?c.mesh:c;return n===h})||r.trigger===13)&&t._intersectionsInProgress.splice(l,1))}}}}_advancePhysicsEngineStep(e){}_animate(){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(Ne.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Ne.MaxDeltaTime))+this._timeAccumulator;const t=this._engine.getTimeStep(),i=1e3/t/1e3;let r=0;const s=this._engine.getLockstepMaxSteps();let n=Math.floor(e/t);for(n=Math.min(n,s);e>0&&r<n;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*i,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,r++,e-=t;this._timeAccumulator=e<0?0:e}else{const e=this.useConstantAnimationDeltaTime?16:Math.max(Ne.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Ne.MaxDeltaTime));this._animationRatio=e*(60/1e3),this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){var t;if(e!=null&&e.outputRenderTarget&&!(e!=null&&e.isRigCamera)&&(e.outputRenderTarget._cleared=!1),!((t=e==null?void 0:e.rigCameras)===null||t===void 0)&&t.length)for(let i=0;i<e.rigCameras.length;++i){const r=e.rigCameras[i].outputRenderTarget;r&&(r._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(const t of this.meshes)t.resetDrawCache(e)}render(e=!0,t=!1){var i,r,s;if(this.isDisposed)return;this.onReadyObservable.hasObservers()&&this._executeWhenReadyTimeoutId===null&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),!((i=this.activeCameras)===null||i===void 0)&&i.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate();for(const l of this._beforeCameraUpdateStage)l.action();if(e){if(this.activeCameras&&this.activeCameras.length>0)for(let l=0;l<this.activeCameras.length;l++){const c=this.activeCameras[l];if(c.update(),c.cameraRigMode!==0)for(let h=0;h<c._rigCameras.length;h++)c._rigCameras[h].update()}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==0))for(let l=0;l<this.activeCamera._rigCameras.length;l++)this.activeCamera._rigCameras[l].update()}this.onBeforeRenderObservable.notifyObservers(this);const n=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const a=!((r=this.activeCameras)===null||r===void 0)&&r.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){J.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let l=0;l<this.customRenderTargets.length;l++){const c=this.customRenderTargets[l];if(c._shouldRender()){if(this._renderId++,this.activeCamera=c.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");n.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),c.render(a!==this.activeCamera,this.dumpNextRenderTargets)}}J.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=(s=a==null?void 0:a.renderPassId)!==null&&s!==void 0?s:0,this.activeCamera=a,this._activeCamera&&this._activeCamera.cameraRigMode!==22&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const l of this._beforeClearStage)l.action();this._clearFrameBuffer(this.activeCamera);for(const l of this._gatherRenderTargetsStage)l.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let l=0;l<this.activeCameras.length;l++)this._processSubCameras(this.activeCameras[l],l>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._checkIntersections();for(const l of this._afterRenderStage)l.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let l=0;l<this._toBeDisposed.length;l++){const c=this._toBeDisposed[l];c&&c.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=new Array,this.stopAllAnimations&&this.stopAllAnimations(),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const e=this._activeRequests.slice();for(const s of e)s.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(s){console.error("An error occurred while calling onDisposeObservable!",s)}if(this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.detachControl(),this._engine.getInputElement())for(let s=0;s<this.cameras.length;s++)this.cameras[s].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,s=>s.dispose(!0)),this._disposeList(this.transformNodes,s=>s.dispose(!0));const i=this.cameras;this._disposeList(i),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let r=this._engine.scenes.indexOf(this);r>-1&&this._engine.scenes.splice(r,1),qe._LastCreatedScene===this&&(this._engine.scenes.length>0?qe._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:qe._LastCreatedScene=null),r=this._engine._virtualScenes.indexOf(this),r>-1&&this._engine._virtualScenes.splice(r,1),this._engine.wipeCaches(!0),this._isDisposed=!0}_disposeList(e,t){const i=e.slice(0);t=t??(r=>r.dispose());for(const r of i)t(r);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){const i=this.meshes[e].geometry;i&&i.clearCachedData()}}cleanCachedTextureBuffer(){for(const e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){const t=new x(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new x(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return e=e||(()=>!0),this.meshes.filter(e).forEach(r=>{if(r.computeWorldMatrix(!0),!r.subMeshes||r.subMeshes.length===0||r.infiniteDistance)return;const s=r.getBoundingInfo(),n=s.boundingBox.minimumWorld,a=s.boundingBox.maximumWorld;x.CheckExtends(n,t,i),x.CheckExtends(a,t,i)}),{min:t,max:i}}createPickingRay(e,t,i,r,s=!1){throw pt("Ray")}createPickingRayToRef(e,t,i,r,s,n=!1,a=!1){throw pt("Ray")}createPickingRayInCameraSpace(e,t,i){throw pt("Ray")}createPickingRayInCameraSpaceToRef(e,t,i,r){throw pt("Ray")}get _pickingAvailable(){return!1}pick(e,t,i,r,s,n){return new Vs}pickWithBoundingInfo(e,t,i,r,s){return new Vs}pickWithRay(e,t,i,r){throw pt("Ray")}multiPick(e,t,i,r,s){throw pt("Ray")}multiPickWithRay(e,t,i){throw pt("Ray")}setPointerOverMesh(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const e of this._components)e.rebuild();for(const e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(const e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(const e of this.textures)e._rebuild();this.markAllMaterialsAsDirty(1)}_getByTags(e,t,i){if(t===void 0)return e;const r=[];i=i||(s=>{});for(const s in e){const n=e[s];qt&&qt.MatchesQuery(n,t)&&(r.push(n),i(n))}return r}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,i=null,r=null){this._renderingManager.setRenderingOrder(e,t,i,r)}setRenderingAutoClearDepthStencil(e,t,i=!0,r=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,r)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(const i of this.materials)t&&!t(i)||i.markAsDirty(e)}_loadFile(e,t,i,r,s,n,a){const l=Pl(e,t,i,r?this.offlineProvider:void 0,s,n,a);return this._activeRequests.push(l),l.onCompleteObservable.add(c=>{this._activeRequests.splice(this._activeRequests.indexOf(c),1)}),l}_loadFileAsync(e,t,i,r,s){return new Promise((n,a)=>{this._loadFile(e,l=>{n(l)},t,i,r,(l,c)=>{a(c)},s)})}_requestFile(e,t,i,r,s,n,a){const l=im(e,t,i,r?this.offlineProvider:void 0,s,n,a);return this._activeRequests.push(l),l.onCompleteObservable.add(c=>{this._activeRequests.splice(this._activeRequests.indexOf(c),1)}),l}_requestFileAsync(e,t,i,r,s){return new Promise((n,a)=>{this._requestFile(e,l=>{n(l)},t,i,r,l=>{a(l)},s)})}_readFile(e,t,i,r,s){const n=mu(e,t,i,r,s);return this._activeRequests.push(n),n.onCompleteObservable.add(a=>{this._activeRequests.splice(this._activeRequests.indexOf(a),1)}),n}_readFileAsync(e,t,i){return new Promise((r,s)=>{this._readFile(e,n=>{r(n)},t,i,n=>{s(n)})})}getPerfCollector(){throw pt("performanceViewerSceneExtension")}}Ne.FOGMODE_NONE=0;Ne.FOGMODE_EXP=1;Ne.FOGMODE_EXP2=2;Ne.FOGMODE_LINEAR=3;Ne.MinDeltaTime=1;Ne.MaxDeltaTime=1e3;Ne.prototype.setActiveCameraByID=function(o){return this.setActiveCameraById(o)};Ne.prototype.getLastMaterialByID=function(o){return this.getLastMaterialById(o)};Ne.prototype.getMaterialByID=function(o){return this.getMaterialById(o)};Ne.prototype.getTextureByUniqueID=function(o){return this.getTextureByUniqueId(o)};Ne.prototype.getCameraByID=function(o){return this.getCameraById(o)};Ne.prototype.getCameraByUniqueID=function(o){return this.getCameraByUniqueId(o)};Ne.prototype.getBoneByID=function(o){return this.getBoneById(o)};Ne.prototype.getLightByID=function(o){return this.getLightById(o)};Ne.prototype.getLightByUniqueID=function(o){return this.getLightByUniqueId(o)};Ne.prototype.getParticleSystemByID=function(o){return this.getParticleSystemById(o)};Ne.prototype.getGeometryByID=function(o){return this.getGeometryById(o)};Ne.prototype.getMeshByID=function(o){return this.getMeshById(o)};Ne.prototype.getMeshesByID=function(o){return this.getMeshesById(o)};Ne.prototype.getTransformNodeByID=function(o){return this.getTransformNodeById(o)};Ne.prototype.getTransformNodeByUniqueID=function(o){return this.getTransformNodeByUniqueId(o)};Ne.prototype.getTransformNodesByID=function(o){return this.getTransformNodesById(o)};Ne.prototype.getMeshByUniqueID=function(o){return this.getMeshByUniqueId(o)};Ne.prototype.getLastMeshByID=function(o){return this.getLastMeshById(o)};Ne.prototype.getLastEntryByID=function(o){return this.getLastEntryById(o)};Ne.prototype.getNodeByID=function(o){return this.getNodeById(o)};Ne.prototype.getLastSkeletonByID=function(o){return this.getLastSkeletonById(o)};var Kt;(function(o){o[o.LOCAL=0]="LOCAL",o[o.WORLD=1]="WORLD",o[o.BONE=2]="BONE"})(Kt||(Kt={}));class As{}As.X=new x(1,0,0);As.Y=new x(0,1,0);As.Z=new x(0,0,1);var Zl;(function(o){o[o.X=0]="X",o[o.Y=1]="Y",o[o.Z=2]="Z"})(Zl||(Zl={}));class di extends ii{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){this._needToCompose=!1,e.updateFlag!==this._localMatrix.updateFlag&&(this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,r=null,s=null,n=null,a=null){super(e,t.getScene()),this.name=e,this.children=new Array,this.animations=new Array,this._index=null,this._absoluteTransform=new H,this._invertedAbsoluteTransform=new H,this._scalingDeterminant=1,this._worldTransform=new H,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=r?r.clone():H.Identity(),this._restPose=s||this._localMatrix.clone(),this._baseMatrix=n||this._localMatrix.clone(),this._index=a,t.bones.push(this),this.setParent(i,!1),(n||r)&&this._updateDifferenceMatrix()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const i=this.parent.children.indexOf(this);i!==-1&&this.parent.children.splice(i,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateDifferenceMatrix(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBaseMatrix(){return this._baseMatrix}getRestPose(){return this._restPose}setRestPose(e){this._restPose.copyFrom(e)}getBindPose(){return this._baseMatrix}setBindPose(e){this.updateMatrix(e)}getWorldMatrix(){return this._worldTransform}returnToRest(){var e;if(this._linkedTransformNode){const t=j.Vector3[0],i=j.Quaternion[0],r=j.Vector3[1];this.getRestPose().decompose(t,i,r),this._linkedTransformNode.position.copyFrom(r),this._linkedTransformNode.rotationQuaternion=(e=this._linkedTransformNode.rotationQuaternion)!==null&&e!==void 0?e:oe.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(i),this._linkedTransformNode.scaling.copyFrom(t)}else this._matrix=this._restPose}getInvertedAbsoluteTransform(){return this._invertedAbsoluteTransform}getAbsoluteTransform(){return this._absoluteTransform}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=x.Zero(),this._localRotation=oe.Zero(),this._localPosition=x.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,H.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(e,t=!0,i=!0){this._baseMatrix.copyFrom(e),t&&this._updateDifferenceMatrix(),i?this._matrix=e:this.markAsDirty()}_updateDifferenceMatrix(e,t=!0){if(e||(e=this._baseMatrix),this.parent?e.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(e),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform),t)for(let i=0;i<this.children.length;i++)this.children[i]._updateDifferenceMatrix();this._scalingDeterminant=this._absoluteTransform.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}translate(e,t=Kt.LOCAL,i){const r=this.getLocalMatrix();if(t==Kt.LOCAL)r.addAtIndex(12,e.x),r.addAtIndex(13,e.y),r.addAtIndex(14,e.z);else{let s=null;i&&(s=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const n=di._TmpMats[0],a=di._TmpVecs[0];this.parent?i&&s?(n.copyFrom(this.parent.getAbsoluteTransform()),n.multiplyToRef(s,n)):n.copyFrom(this.parent.getAbsoluteTransform()):H.IdentityToRef(n),n.setTranslationFromFloats(0,0,0),n.invert(),x.TransformCoordinatesToRef(e,n,a),r.addAtIndex(12,a.x),r.addAtIndex(13,a.y),r.addAtIndex(14,a.z)}this._markAsDirtyAndDecompose()}setPosition(e,t=Kt.LOCAL,i){const r=this.getLocalMatrix();if(t==Kt.LOCAL)r.setTranslationFromFloats(e.x,e.y,e.z);else{let s=null;i&&(s=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const n=di._TmpMats[0],a=di._TmpVecs[0];this.parent?(i&&s?(n.copyFrom(this.parent.getAbsoluteTransform()),n.multiplyToRef(s,n)):n.copyFrom(this.parent.getAbsoluteTransform()),n.invert()):H.IdentityToRef(n),x.TransformCoordinatesToRef(e,n,a),r.setTranslationFromFloats(a.x,a.y,a.z)}this._markAsDirtyAndDecompose()}setAbsolutePosition(e,t){this.setPosition(e,Kt.WORLD,t)}scale(e,t,i,r=!1){const s=this.getLocalMatrix(),n=di._TmpMats[0];H.ScalingToRef(e,t,i,n),n.multiplyToRef(s,s),n.invert();for(const a of this.children){const l=a.getLocalMatrix();l.multiplyToRef(n,l),l.multiplyAtIndex(12,e),l.multiplyAtIndex(13,t),l.multiplyAtIndex(14,i),a._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),r)for(const a of this.children)a.scale(e,t,i,r)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,r=Kt.LOCAL,s){if(r===Kt.LOCAL){const l=di._TmpQuat;oe.RotationYawPitchRollToRef(e,t,i,l),this.setRotationQuaternion(l,r,s);return}const n=di._TmpMats[0];if(!this._getNegativeRotationToRef(n,s))return;const a=di._TmpMats[1];H.RotationYawPitchRollToRef(e,t,i,a),n.multiplyToRef(a,a),this._rotateWithMatrix(a,r,s)}rotate(e,t,i=Kt.LOCAL,r){const s=di._TmpMats[0];s.setTranslationFromFloats(0,0,0),H.RotationAxisToRef(e,t,s),this._rotateWithMatrix(s,i,r)}setAxisAngle(e,t,i=Kt.LOCAL,r){if(i===Kt.LOCAL){const a=di._TmpQuat;oe.RotationAxisToRef(e,t,a),this.setRotationQuaternion(a,i,r);return}const s=di._TmpMats[0];if(!this._getNegativeRotationToRef(s,r))return;const n=di._TmpMats[1];H.RotationAxisToRef(e,t,n),s.multiplyToRef(n,n),this._rotateWithMatrix(n,i,r)}setRotation(e,t=Kt.LOCAL,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=Kt.LOCAL,i){if(t===Kt.LOCAL){this._decompose(),this._localRotation.copyFrom(e),this._markAsDirtyAndCompose();return}const r=di._TmpMats[0];if(!this._getNegativeRotationToRef(r,i))return;const s=di._TmpMats[1];H.FromQuaternionToRef(e,s),r.multiplyToRef(s,s),this._rotateWithMatrix(s,t,i)}setRotationMatrix(e,t=Kt.LOCAL,i){if(t===Kt.LOCAL){const n=di._TmpQuat;oe.FromRotationMatrixToRef(e,n),this.setRotationQuaternion(n,t,i);return}const r=di._TmpMats[0];if(!this._getNegativeRotationToRef(r,i))return;const s=di._TmpMats[1];s.copyFrom(e),r.multiplyToRef(e,s),this._rotateWithMatrix(s,t,i)}_rotateWithMatrix(e,t=Kt.LOCAL,i){const r=this.getLocalMatrix(),s=r.m[12],n=r.m[13],a=r.m[14],l=this.getParent(),c=di._TmpMats[3],h=di._TmpMats[4];l&&t==Kt.WORLD?(i?(c.copyFrom(i.getWorldMatrix()),l.getAbsoluteTransform().multiplyToRef(c,c)):c.copyFrom(l.getAbsoluteTransform()),h.copyFrom(c),h.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(h,r)):t==Kt.WORLD&&i?(c.copyFrom(i.getWorldMatrix()),h.copyFrom(c),h.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(h,r)):r.multiplyToRef(e,r),r.setTranslationFromFloats(s,n,a),this.computeAbsoluteTransforms(),this._markAsDirtyAndDecompose()}_getNegativeRotationToRef(e,t){const i=di._TmpMats[2];return e.copyFrom(this.getAbsoluteTransform()),t?(e.multiplyToRef(t.getWorldMatrix(),e),H.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):H.IdentityToRef(i),e.invert(),isNaN(e.m[0])?!1:(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=Kt.LOCAL,t=null){const i=x.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=Kt.LOCAL,t,i){if(e==Kt.LOCAL){const r=this.getLocalMatrix();i.x=r.m[12],i.y=r.m[13],i.z=r.m[14]}else{let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();let s=di._TmpMats[0];t&&r?(s.copyFrom(this.getAbsoluteTransform()),s.multiplyToRef(r,s)):s=this.getAbsoluteTransform(),i.x=s.m[12],i.y=s.m[13],i.z=s.m[14]}}getAbsolutePosition(e=null){const t=x.Zero();return this.getPositionToRef(Kt.WORLD,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(Kt.WORLD,e,t)}computeAbsoluteTransforms(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform);else{this._absoluteTransform.copyFrom(this._localMatrix);const i=this._skeleton.getPoseMatrix();i&&this._absoluteTransform.multiplyToRef(i,this._absoluteTransform)}const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteTransforms()}getDirection(e,t=null){const i=x.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const s=di._TmpMats[0];s.copyFrom(this.getAbsoluteTransform()),t&&r&&s.multiplyToRef(r,s),x.TransformNormalToRef(e,s,i),i.normalize()}getRotation(e=Kt.LOCAL,t=null){const i=x.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=Kt.LOCAL,t=null,i){const r=di._TmpQuat;this.getRotationQuaternionToRef(e,t,r),r.toEulerAnglesToRef(i)}getRotationQuaternion(e=Kt.LOCAL,t=null){const i=oe.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=Kt.LOCAL,t=null,i){if(e==Kt.LOCAL)this._decompose(),i.copyFrom(this._localRotation);else{const r=di._TmpMats[0],s=this.getAbsoluteTransform();t?s.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(s),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.decompose(void 0,i,void 0)}}getRotationMatrix(e=Kt.LOCAL,t){const i=H.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=Kt.LOCAL,t,i){if(e==Kt.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(i);else{const r=di._TmpMats[0],s=this.getAbsoluteTransform();t?s.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(s),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){const i=x.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();let s=di._TmpMats[0];t&&r?(s.copyFrom(this.getAbsoluteTransform()),s.multiplyToRef(r,s)):s=this.getAbsoluteTransform(),x.TransformCoordinatesToRef(e,s,i)}getLocalPositionFromAbsolute(e,t=null){const i=x.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const s=di._TmpMats[0];s.copyFrom(this.getAbsoluteTransform()),t&&r&&s.multiplyToRef(r,s),s.invert(),x.TransformCoordinatesToRef(e,s,i)}setCurrentPoseAsRest(){this.setRestPose(this.getLocalMatrix())}}di._TmpVecs=Br.BuildArray(2,x.Zero);di._TmpQuat=oe.Identity();di._TmpMats=Br.BuildArray(5,H.Identity);class dT{get syncRoot(){return this._syncRoot}get masterFrame(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){if(e===-1){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,this._goToFrame!==null&&this.goToFrame(this._goToFrame)}constructor(e,t,i=0,r=100,s=!1,n=1,a,l,c,h=!1){this.target=t,this.fromFrame=i,this.toFrame=r,this.loopAnimation=s,this.onAnimationEnd=a,this.onAnimationLoop=c,this.isAdditive=h,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new Q,this.onAnimationLoopObservable=new Q,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=n,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const t=this._scene._activeAnimatables.indexOf(this);t>-1&&(this._scene._activeAnimatables.splice(t,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const r=t[i],s=new Vb(e,r,this._scene,this);s._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(s)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e){var t;const i=this._runtimeAnimations;if(i[0]){const r=i[0].animation.framePerSecond;this._frameToSyncFromJump=(t=this._frameToSyncFromJump)!==null&&t!==void 0?t:i[0].currentFrame;const s=this.speedRatio===0?0:(e-this._frameToSyncFromJump)/r*1e3/this.speedRatio;this._manualJumpDelay=-s}for(let r=0;r<i.length;r++)i[r].goToFrame(e);this._goToFrame=e}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t){if(e||t){const i=this._scene._activeAnimatables.indexOf(this);if(i>-1){const r=this._runtimeAnimations;for(let s=r.length-1;s>=0;s--){const n=r[s];e&&n.animation.name!=e||t&&!t(n.target)||(n.dispose(),r.splice(s,1))}r.length==0&&(this._scene._activeAnimatables.splice(i,1),this._raiseOnAnimationEnd())}}else{const i=this._scene._activeAnimatables.indexOf(this);if(i>-1){this._scene._activeAnimatables.splice(i,1);const r=this._runtimeAnimations;for(let s=0;s<r.length;s++)r[s].dispose();this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=e),!0;if(this._localDelayOffset===null?(this._localDelayOffset=e,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),this._manualJumpDelay!==null&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,this._weight===0)return!0;let t=!1;const i=this._runtimeAnimations;let r;for(r=0;r<i.length;r++){const n=i[r].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||n}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(r=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(r,1),r=0;r<i.length;r++)i[r].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}Ne.prototype._animate=function(){if(!this.animationsEnabled)return;const o=Us.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=o}this.deltaTime=this.useConstantAnimationDeltaTime?16:(o-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=o;const e=this._activeAnimatables;if(e.length===0)return;this._animationTime+=this.deltaTime;const t=this._animationTime;for(let i=0;i<e.length;i++){const r=e[i];!r._animate(t)&&r.disposeOnEnd&&i--}this._processLateAnimationBindings()};Ne.prototype.beginWeightedAnimation=function(o,e,t,i=1,r,s=1,n,a,l,c,h=!1){const u=this.beginAnimation(o,e,t,r,s,n,a,!1,l,c,h);return u.weight=i,u};Ne.prototype.beginAnimation=function(o,e,t,i,r=1,s,n,a=!0,l,c,h=!1){e>t&&r>0&&(r*=-1),a&&this.stopAnimation(o,void 0,l),n||(n=new dT(this,o,e,t,i,r,s,void 0,c,h));const u=l?l(o):!0;if(o.animations&&u&&n.appendAnimations(o,o.animations),o.getAnimatables){const d=o.getAnimatables();for(let f=0;f<d.length;f++)this.beginAnimation(d[f],e,t,i,r,s,n,a,l,c)}return n.reset(),n};Ne.prototype.beginHierarchyAnimation=function(o,e,t,i,r,s=1,n,a,l=!0,c,h,u=!1){const d=o.getDescendants(e),f=[];f.push(this.beginAnimation(o,t,i,r,s,n,a,l,c,void 0,u));for(const _ of d)f.push(this.beginAnimation(_,t,i,r,s,n,a,l,c,void 0,u));return f};Ne.prototype.beginDirectAnimation=function(o,e,t,i,r,s,n,a,l=!1){if(s===void 0&&(s=1),t>i&&s>0)s*=-1;else if(i>t&&s<0){const h=i;i=t,t=h}return new dT(this,o,t,i,r,s,n,e,a,l)};Ne.prototype.beginDirectHierarchyAnimation=function(o,e,t,i,r,s,n,a,l,c=!1){const h=o.getDescendants(e),u=[];u.push(this.beginDirectAnimation(o,t,i,r,s,n,a,l,c));for(const d of h)u.push(this.beginDirectAnimation(d,t,i,r,s,n,a,l,c));return u};Ne.prototype.getAnimatableByTarget=function(o){for(let e=0;e<this._activeAnimatables.length;e++)if(this._activeAnimatables[e].target===o)return this._activeAnimatables[e];return null};Ne.prototype.getAllAnimatablesByTarget=function(o){const e=[];for(let t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].target===o&&e.push(this._activeAnimatables[t]);return e};Ne.prototype.stopAnimation=function(o,e,t){const i=this.getAllAnimatablesByTarget(o);for(const r of i)r.stop(e,t)};Ne.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let o=0;o<this._activeAnimatables.length;o++)this._activeAnimatables[o].stop();this._activeAnimatables.length=0}for(const o of this.animationGroups)o.stop()};Ne.prototype._registerTargetForLateAnimationBinding=function(o,e){const t=o.target;this._registeredForLateAnimationBindings.pushNoDuplicate(t),t._lateAnimationHolders||(t._lateAnimationHolders={}),t._lateAnimationHolders[o.targetPath]||(t._lateAnimationHolders[o.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:e}),o.isAdditive?(t._lateAnimationHolders[o.targetPath].additiveAnimations.push(o),t._lateAnimationHolders[o.targetPath].totalAdditiveWeight+=o.weight):(t._lateAnimationHolders[o.targetPath].animations.push(o),t._lateAnimationHolders[o.targetPath].totalWeight+=o.weight)};Ne.prototype._processLateAnimationBindingsForMatrices=function(o){if(o.totalWeight===0&&o.totalAdditiveWeight===0)return o.originalValue;let e=1;const t=j.Vector3[0],i=j.Vector3[1],r=j.Quaternion[0];let s=0;const n=o.animations[0],a=o.originalValue;let l=1,c=!1;if(o.totalWeight<1)l=1-o.totalWeight,a.decompose(i,r,t);else{if(s=1,e=o.totalWeight,l=n.weight/e,l==1)if(o.totalAdditiveWeight)c=!0;else return n.currentValue;n.currentValue.decompose(i,r,t)}if(!c){i.scaleInPlace(l),t.scaleInPlace(l),r.scaleInPlace(l);for(let u=s;u<o.animations.length;u++){const d=o.animations[u];if(d.weight===0)continue;l=d.weight/e;const f=j.Vector3[2],_=j.Vector3[3],p=j.Quaternion[1];d.currentValue.decompose(_,p,f),_.scaleAndAddToRef(l,i),p.scaleAndAddToRef(oe.Dot(r,p)>0?l:-l,r),f.scaleAndAddToRef(l,t)}r.normalize()}for(let u=0;u<o.additiveAnimations.length;u++){const d=o.additiveAnimations[u];if(d.weight===0)continue;const f=j.Vector3[2],_=j.Vector3[3],p=j.Quaternion[1];d.currentValue.decompose(_,p,f),_.multiplyToRef(i,_),x.LerpToRef(i,_,d.weight,i),r.multiplyToRef(p,p),oe.SlerpToRef(r,p,d.weight,r),f.scaleAndAddToRef(d.weight,t)}const h=n?n._animationState.workValue:j.Matrix[0].clone();return H.ComposeToRef(i,r,t,h),h};Ne.prototype._processLateAnimationBindingsForQuaternions=function(o,e){if(o.totalWeight===0&&o.totalAdditiveWeight===0)return e;const t=o.animations[0],i=o.originalValue;let r=e;if(o.totalWeight===0&&o.totalAdditiveWeight>0)r.copyFrom(i);else if(o.animations.length===1){if(oe.SlerpToRef(i,t.currentValue,Math.min(1,o.totalWeight),r),o.totalAdditiveWeight===0)return r}else if(o.animations.length>1){let s=1,n,a;if(o.totalWeight<1){const c=1-o.totalWeight;n=[],a=[],n.push(i),a.push(c)}else{if(o.animations.length===2&&(oe.SlerpToRef(o.animations[0].currentValue,o.animations[1].currentValue,o.animations[1].weight/o.totalWeight,e),o.totalAdditiveWeight===0))return e;n=[],a=[],s=o.totalWeight}for(let c=0;c<o.animations.length;c++){const h=o.animations[c];n.push(h.currentValue),a.push(h.weight/s)}let l=0;for(let c=0;c<n.length;){if(!c){oe.SlerpToRef(n[c],n[c+1],a[c+1]/(a[c]+a[c+1]),e),r=e,l=a[c]+a[c+1],c+=2;continue}l+=a[c],oe.SlerpToRef(r,n[c],a[c]/l,r),c++}}for(let s=0;s<o.additiveAnimations.length;s++){const n=o.additiveAnimations[s];n.weight!==0&&(r.multiplyToRef(n.currentValue,j.Quaternion[0]),oe.SlerpToRef(r,j.Quaternion[0],n.weight,r))}return r};Ne.prototype._processLateAnimationBindings=function(){if(this._registeredForLateAnimationBindings.length){for(let o=0;o<this._registeredForLateAnimationBindings.length;o++){const e=this._registeredForLateAnimationBindings.data[o];for(const t in e._lateAnimationHolders){const i=e._lateAnimationHolders[t],r=i.animations[0],s=i.originalValue;if(s==null)continue;const n=ae.AllowMatrixDecomposeForInterpolation&&s.m;let a=e[t];if(n)a=this._processLateAnimationBindingsForMatrices(i);else if(s.w!==void 0)a=this._processLateAnimationBindingsForQuaternions(i,a||oe.Identity());else{let c=0,h=1;if(i.totalWeight<1)r&&s.scale?a=s.scale(1-i.totalWeight):r?a=s*(1-i.totalWeight):s.clone?a=s.clone():a=s;else if(r){h=i.totalWeight;const u=r.weight/h;u!==1?r.currentValue.scale?a=r.currentValue.scale(u):a=r.currentValue*u:a=r.currentValue,c=1}for(let u=c;u<i.animations.length;u++){const d=i.animations[u],f=d.weight/h;if(f)d.currentValue.scaleAndAddToRef?d.currentValue.scaleAndAddToRef(f,a):a+=d.currentValue*f;else continue}for(let u=0;u<i.additiveAnimations.length;u++){const d=i.additiveAnimations[u],f=d.weight;if(f)d.currentValue.scaleAndAddToRef?d.currentValue.scaleAndAddToRef(f,a):a+=d.currentValue*f;else continue}}e[t]=a}e._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}};di.prototype.copyAnimationRange=function(o,e,t,i=!1,r=null){this.animations.length===0&&(this.animations.push(new ae(this.name,"_matrix",o.animations[0].framePerSecond,ae.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const s=o.animations[0].getRange(e);if(!s)return!1;const n=s.from,a=s.to,l=o.animations[0].getKeys(),c=o.length,h=o.getParent(),u=this.getParent(),d=i&&h&&c&&this.length&&c!==this.length,f=d&&u&&h?u.length/h.length:1,_=i&&!u&&r&&(r.x!==1||r.y!==1||r.z!==1),p=this.animations[0].getKeys();let m,T,b;for(let y=0,S=l.length;y<S;y++)m=l[y],m.frame>=n&&m.frame<=a&&(i?(b=m.value.clone(),d?(T=b.getTranslation(),b.setTranslation(T.scaleInPlace(f))):_&&r?(T=b.getTranslation(),b.setTranslation(T.multiplyInPlace(r))):b=m.value):b=m.value,p.push({frame:m.frame+t,value:b}));return this.animations[0].createRange(e,n+t,a+t),!0};var Xc;(function(o){o[o.CW=0]="CW",o[o.CCW=1]="CCW"})(Xc||(Xc={}));class gl{constructor(e){this._radians=e,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return this._radians*180/Math.PI}radians(){return this._radians}static BetweenTwoPoints(e,t){const i=t.subtract(e),r=Math.atan2(i.y,i.x);return new gl(r)}static FromRadians(e){return new gl(e)}static FromDegrees(e){return new gl(e*Math.PI/180)}}class fS{constructor(e,t,i){this.startPoint=e,this.midPoint=t,this.endPoint=i;const r=Math.pow(t.x,2)+Math.pow(t.y,2),s=(Math.pow(e.x,2)+Math.pow(e.y,2)-r)/2,n=(r-Math.pow(i.x,2)-Math.pow(i.y,2))/2,a=(e.x-t.x)*(t.y-i.y)-(t.x-i.x)*(e.y-t.y);this.centerPoint=new Ie((s*(t.y-i.y)-n*(e.y-t.y))/a,((e.x-t.x)*n-(t.x-i.x)*s)/a),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=gl.BetweenTwoPoints(this.centerPoint,this.startPoint);const l=this.startAngle.degrees();let c=gl.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),h=gl.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();c-l>180&&(c-=360),c-l<-180&&(c+=360),h-c>180&&(h-=360),h-c<-180&&(h+=360),this.orientation=c-l<0?Xc.CW:Xc.CCW,this.angle=gl.FromDegrees(this.orientation===Xc.CW?l-h:h-l)}}class sm{constructor(e,t){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new Ie(e,t))}addLineTo(e,t){if(this.closed)return this;const i=new Ie(e,t),r=this._points[this._points.length-1];return this._points.push(i),this._length+=i.subtract(r).length(),this}addArcTo(e,t,i,r,s=36){if(this.closed)return this;const n=this._points[this._points.length-1],a=new Ie(e,t),l=new Ie(i,r),c=new fS(n,a,l);let h=c.angle.radians()/s;c.orientation===Xc.CW&&(h*=-1);let u=c.startAngle.radians()+h;for(let d=0;d<s;d++){const f=Math.cos(u)*c.radius+c.centerPoint.x,_=Math.sin(u)*c.radius+c.centerPoint.y;this.addLineTo(f,_),u+=h}return this}close(){return this.closed=!0,this}length(){let e=this._length;if(this.closed){const t=this._points[this._points.length-1],i=this._points[0];e+=i.subtract(t).length()}return e}getPoints(){return this._points}getPointAtLengthPosition(e){if(e<0||e>1)return Ie.Zero();const t=e*this.length();let i=0;for(let r=0;r<this._points.length;r++){const s=(r+1)%this._points.length,n=this._points[r],l=this._points[s].subtract(n),c=l.length()+i;if(t>=i&&t<=c){const h=l.normalize(),u=t-i;return new Ie(n.x+h.x*u,n.y+h.y*u)}i=c}return Ie.Zero()}static StartingAt(e,t){return new sm(e,t)}}class gu{constructor(e,t=null,i,r=!1){this.path=e,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:x.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:H.Identity()};for(let s=0;s<e.length;s++)this._curve[s]=e[s].clone();this._raw=i||!1,this._alignTangentsWithPath=r,this._compute(t,r)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(e){return this._updatePointAtData(e).point}getTangentAt(e,t=!1){return this._updatePointAtData(e,t),t?x.TransformCoordinates(x.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(e,t=!1){return this._updatePointAtData(e,t),t?x.TransformCoordinates(x.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(e,t=!1){return this._updatePointAtData(e,t),t?x.TransformCoordinates(x.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(e){return this.length()*e}getPreviousPointIndexAt(e){return this._updatePointAtData(e),this._pointAtData.previousPointArrayIndex}getSubPositionAt(e){return this._updatePointAtData(e),this._pointAtData.subPosition}getClosestPositionTo(e){let t=Number.MAX_VALUE,i=0;for(let r=0;r<this._curve.length-1;r++){const s=this._curve[r+0],n=this._curve[r+1].subtract(s).normalize(),a=this._distances[r+1]-this._distances[r+0],l=Math.min(Math.max(x.Dot(n,e.subtract(s).normalize()),0)*x.Distance(s,e)/a,1),c=x.Distance(s.add(n.scale(l*a)),e);c<t&&(t=c,i=(this._distances[r+0]+a*l)/this.length())}return i}slice(e=0,t=1){if(e<0&&(e=1-e*-1%1),t<0&&(t=1-t*-1%1),e>t){const c=e;e=t,t=c}const i=this.getCurve(),r=this.getPointAt(e);let s=this.getPreviousPointIndexAt(e);const n=this.getPointAt(t),a=this.getPreviousPointIndexAt(t)+1,l=[];return e!==0&&(s++,l.push(r)),l.push(...i.slice(s,a)),(t!==1||e===1)&&l.push(n),new gu(l,this.getNormalAt(e),this._raw,this._alignTangentsWithPath)}update(e,t=null,i=!1){for(let r=0;r<e.length;r++)this._curve[r].x=e[r].x,this._curve[r].y=e[r].y,this._curve[r].z=e[r].z;return this._compute(t,i),this}_compute(e,t=!1){const i=this._curve.length;if(i<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[i-1]=this._curve[i-1].subtract(this._curve[i-2]),this._raw||this._tangents[i-1].normalize();const r=this._tangents[0],s=this._normalVector(r,e);this._normals[0]=s,this._raw||this._normals[0].normalize(),this._binormals[0]=x.Cross(r,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;let n,a,l,c,h;for(let u=1;u<i;u++)n=this._getLastNonNullVector(u),u<i-1&&(a=this._getFirstNonNullVector(u),this._tangents[u]=t?a:n.add(a),this._tangents[u].normalize()),this._distances[u]=this._distances[u-1]+this._curve[u].subtract(this._curve[u-1]).length(),l=this._tangents[u],h=this._binormals[u-1],this._normals[u]=x.Cross(h,l),this._raw||(this._normals[u].length()===0?(c=this._normals[u-1],this._normals[u]=c.clone()):this._normals[u].normalize()),this._binormals[u]=x.Cross(l,this._normals[u]),this._raw||this._binormals[u].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(e){let t=1,i=this._curve[e+t].subtract(this._curve[e]);for(;i.length()===0&&e+t+1<this._curve.length;)t++,i=this._curve[e+t].subtract(this._curve[e]);return i}_getLastNonNullVector(e){let t=1,i=this._curve[e].subtract(this._curve[e-t]);for(;i.length()===0&&e>t+1;)t++,i=this._curve[e].subtract(this._curve[e-t]);return i}_normalVector(e,t){let i,r=e.length();if(r===0&&(r=1),t==null){let s;Ee.WithinEpsilon(Math.abs(e.y)/r,1,kt)?Ee.WithinEpsilon(Math.abs(e.x)/r,1,kt)?Ee.WithinEpsilon(Math.abs(e.z)/r,1,kt)?s=x.Zero():s=new x(0,0,1):s=new x(1,0,0):s=new x(0,-1,0),i=x.Cross(e,s)}else i=x.Cross(e,t),x.CrossToRef(i,e,i);return i.normalize(),i}_updatePointAtData(e,t=!1){if(this._pointAtData.id===e)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=e;const i=this.getPoints();if(e<=0)return this._setPointAtData(0,0,i[0],0,t);if(e>=1)return this._setPointAtData(1,1,i[i.length-1],i.length-1,t);let r=i[0],s,n=0;const a=e*this.length();for(let l=1;l<i.length;l++){s=i[l];const c=x.Distance(r,s);if(n+=c,n===a)return this._setPointAtData(e,1,s,l,t);if(n>a){const u=(n-a)/c,d=r.subtract(s),f=s.add(d.scaleInPlace(u));return this._setPointAtData(e,1-u,f,l-1,t)}r=s}return this._pointAtData}_setPointAtData(e,t,i,r,s){return this._pointAtData.point=i,this._pointAtData.position=e,this._pointAtData.subPosition=t,this._pointAtData.previousPointArrayIndex=r,this._pointAtData.interpolateReady=s,s&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=H.Identity();const e=this._pointAtData.previousPointArrayIndex;if(e!==this._tangents.length-1){const t=e+1,i=this._tangents[e].clone(),r=this._normals[e].clone(),s=this._binormals[e].clone(),n=this._tangents[t].clone(),a=this._normals[t].clone(),l=this._binormals[t].clone(),c=oe.RotationQuaternionFromAxis(r,s,i),h=oe.RotationQuaternionFromAxis(a,l,n);oe.Slerp(c,h,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class Lo{static CreateQuadraticBezier(e,t,i,r){r=r>2?r:3;const s=new Array,n=(a,l,c,h)=>(1-a)*(1-a)*l+2*a*(1-a)*c+a*a*h;for(let a=0;a<=r;a++)s.push(new x(n(a/r,e.x,t.x,i.x),n(a/r,e.y,t.y,i.y),n(a/r,e.z,t.z,i.z)));return new Lo(s)}static CreateCubicBezier(e,t,i,r,s){s=s>3?s:4;const n=new Array,a=(l,c,h,u,d)=>(1-l)*(1-l)*(1-l)*c+3*l*(1-l)*(1-l)*h+3*l*l*(1-l)*u+l*l*l*d;for(let l=0;l<=s;l++)n.push(new x(a(l/s,e.x,t.x,i.x,r.x),a(l/s,e.y,t.y,i.y,r.y),a(l/s,e.z,t.z,i.z,r.z)));return new Lo(n)}static CreateHermiteSpline(e,t,i,r,s){const n=new Array,a=1/s;for(let l=0;l<=s;l++)n.push(x.Hermite(e,t,i,r,l*a));return new Lo(n)}static CreateCatmullRomSpline(e,t,i){const r=new Array,s=1/t;let n=0;if(i){const a=e.length;for(let l=0;l<a;l++){n=0;for(let c=0;c<t;c++)r.push(x.CatmullRom(e[l%a],e[(l+1)%a],e[(l+2)%a],e[(l+3)%a],n)),n+=s}r.push(r[0])}else{const a=new Array;a.push(e[0].clone()),Array.prototype.push.apply(a,e),a.push(e[e.length-1].clone());let l=0;for(;l<a.length-3;l++){n=0;for(let c=0;c<t;c++)r.push(x.CatmullRom(a[l],a[l+1],a[l+2],a[l+3],n)),n+=s}l--,r.push(x.CatmullRom(a[l],a[l+1],a[l+2],a[l+3],n))}return new Lo(r)}static ArcThru3Points(e,t,i,r=32,s=!1,n=!1){const a=new Array,l=t.subtract(e),c=i.subtract(t),h=e.subtract(i),u=x.Cross(l,c),d=u.length();if(d<Math.pow(10,-8))return new Lo(a);const f=l.lengthSquared(),_=c.lengthSquared(),p=h.lengthSquared(),m=u.lengthSquared(),T=l.length(),b=c.length(),y=h.length(),S=.5*T*b*y/d,C=x.Dot(l,h),I=x.Dot(l,c),P=x.Dot(c,h),D=-.5*_*C/m,w=-.5*p*I/m,L=-.5*f*P/m,U=e.scale(D).add(t.scale(w)).add(i.scale(L)),Z=e.subtract(U).normalize(),he=x.Cross(u,Z).normalize();if(n){const _e=2*Math.PI/r;for(let ne=0;ne<=2*Math.PI;ne+=_e)a.push(U.add(Z.scale(S*Math.cos(ne)).add(he.scale(S*Math.sin(ne)))));a.push(e)}else{const _e=1/r;let ne=0,Pe=x.Zero();do Pe=U.add(Z.scale(S*Math.cos(ne)).add(he.scale(S*Math.sin(ne)))),a.push(Pe),ne+=_e;while(!Pe.equalsWithEpsilon(i,S*_e*1.1));a.push(i),s&&a.push(e)}return new Lo(a)}constructor(e){this._length=0,this._points=e,this._length=this._computeLength(e)}getPoints(){return this._points}length(){return this._length}continue(e){const t=this._points[this._points.length-1],i=this._points.slice(),r=e.getPoints();for(let n=1;n<r.length;n++)i.push(r[n].subtract(r[0]).add(t));return new Lo(i)}_computeLength(e){let t=0;for(let i=1;i<e.length;i++)t+=e[i].subtract(e[i-1]).length();return t}}class xs{constructor(){this._easingMode=xs.EASINGMODE_EASEIN}setEasingMode(e){const t=Math.min(Math.max(e,0),2);this._easingMode=t}getEasingMode(){return this._easingMode}easeInCore(e){throw new Error("You must implement this method")}ease(e){switch(this._easingMode){case xs.EASINGMODE_EASEIN:return this.easeInCore(e);case xs.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?(1-this.easeInCore((1-e)*2))*.5+.5:this.easeInCore(e*2)*.5}}xs.EASINGMODE_EASEIN=0;xs.EASINGMODE_EASEOUT=1;xs.EASINGMODE_EASEINOUT=2;class _S extends xs{easeInCore(e){return e=Math.max(0,Math.min(1,e)),1-Math.sqrt(1-e*e)}}class pS extends xs{constructor(e=1){super(),this.amplitude=e}easeInCore(e){const t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)}}class sv extends xs{easeInCore(e){return e*e*e}}class mS extends xs{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}}class gS extends xs{easeInCore(e){return e*e}}class fT extends xs{easeInCore(e){return 1-Math.sin(1.5707963267948966*(1-e))}}class nm{constructor(e,t,i){this.frame=e,this.action=t,this.onlyOnce=i,this.isDone=!1}_clone(){return new nm(this.frame,this.action,this.onlyOnce)}}class vS{getClassName(){return"TargetedAnimation"}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class vu{get from(){return this._from}get to(){return this._to}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.speedRatio=this._speedRatio}}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.loopAnimation=this._loopAnimation}}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.isAdditive=this._isAdditive}}}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}constructor(e,t=null){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._parentContainer=null,this.onAnimationEndObservable=new Q,this.onAnimationLoopObservable=new Q,this.onAnimationGroupLoopObservable=new Q,this.onAnimationGroupEndObservable=new Q,this.onAnimationGroupPauseObservable=new Q,this.onAnimationGroupPlayObservable=new Q,this.metadata=null,this._animationLoopFlags=[],this._scene=t||qe.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){const i=new vS;i.animation=e,i.target=t;const r=e.getKeys();return this._from>r[0].frame&&(this._from=r[0].frame),this._to<r[r.length-1].frame&&(this._to=r[r.length-1].frame),this._targetedAnimations.push(i),i}normalize(e=null,t=null){e==null&&(e=this._from),t==null&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){const s=this._targetedAnimations[i].animation.getKeys(),n=s[0],a=s[s.length-1];if(n.frame>e){const l={frame:e,value:n.value,inTangent:n.inTangent,outTangent:n.outTangent,interpolation:n.interpolation};s.splice(0,0,l)}if(a.frame<t){const l={frame:t,value:a.value,inTangent:a.inTangent,outTangent:a.outTangent,interpolation:a.interpolation};s.push(l)}}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),!this._animationLoopFlags[i]&&(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._targetedAnimations.length&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,r,s){if(this._isStarted||this._targetedAnimations.length===0)return this;this._loopAnimation=e,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let n=0;n<this._targetedAnimations.length;n++){const a=this._targetedAnimations[n],l=this._scene.beginDirectAnimation(a.target,[a.animation],i!==void 0?i:this._from,r!==void 0?r:this._to,e,t,void 0,void 0,s!==void 0?s:this._isAdditive);l.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(a),this._checkAnimationGroupEnded(l)},this._processLoop(l,a,n),this._animatables.push(l)}return this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length===this._targetedAnimations.length?(e!==void 0&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this._isPaused=!1,this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(){if(!this._isStarted)return this;const e=this._animatables.slice();for(let t=0;t<e.length;t++)e[t].stop();return this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.weight=e}return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e){if(!this._isStarted)return this;for(let t=0;t<this._animatables.length;t++)this._animatables[t].goToFrame(e);return this}dispose(){this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const t=this._parentContainer.animationGroups.indexOf(this);t>-1&&this._parentContainer.animationGroups.splice(t,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e){const t=this._animatables.indexOf(e);t>-1&&this._animatables.splice(t,1),this._animatables.length===0&&(this._isStarted=!1,this.onAnimationGroupEndObservable.notifyObservers(this))}clone(e,t,i=!1){const r=new vu(e||this.name,this._scene);for(const s of this._targetedAnimations)r.addTargetedAnimation(i?s.animation.clone():s.animation,t?t(s.target):s.target);return r}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){const i=this.targetedAnimations[t];e.targetedAnimations[t]=i.serialize()}return qt&&qt.HasTags(this)&&(e.tags=qt.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){const i=new vu(e.name,t);for(let r=0;r<e.targetedAnimations.length;r++){const s=e.targetedAnimations[r],n=ae.Parse(s.animation),a=s.targetId;if(s.animation.property==="influence"){const l=t.getMorphTargetById(a);l&&i.addTargetedAnimation(n,l)}else{const l=t.getNodeById(a);l!=null&&i.addTargetedAnimation(n,l)}}return e.from!==null&&e.to!==null&&i.normalize(e.from,e.to),qt&&qt.AddTagsTo(i,e.tags),e.metadata!==void 0&&(i.metadata=e.metadata),i}static MakeAnimationAdditive(e,t=0,i,r=!1,s){let n=e;r&&(n=e.clone(s||n.name));const a=n.targetedAnimations;for(let l=0;l<a.length;l++){const c=a[l];ae.MakeAnimationAdditive(c.animation,t,i)}return n.isAdditive=!0,n}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}}function Wd(o,e,t){try{const i=o.next();i.done?e(i):i.value?i.value.then(()=>{i.value=void 0,e(i)},t):e(i)}catch(i){t(i)}}function xS(o=25){let e;return(t,i,r)=>{const s=performance.now();e===void 0||s-e>o?(e=s,setTimeout(()=>{Wd(t,i,r)},0)):Wd(t,i,r)}}function _T(o,e,t,i,r){const s=()=>{let n;const a=l=>{l.done?t(l.value):n===void 0?n=!0:s()};do n=void 0,!r||!r.aborted?e(o,a,i):i(new Error("Aborted")),n===void 0&&(n=!1);while(n)};s()}function am(o,e){let t;return _T(o,Wd,i=>t=i,i=>{throw i},e),t}function pT(o,e,t){return new Promise((i,r)=>{_T(o,e,i,r,t)})}function TS(o,e){return(...t)=>am(o(...t),e)}class Dn{constructor(e,t,i,r){this.x=e,this.y=t,this.width=i,this.height=r}toGlobal(e,t){return new Dn(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new Dn(this.x,this.y,this.width,this.height)}}class Ve extends ii{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){var e,t,i,r;let s=0,n=0;if(this.mode===Ve.PERSPECTIVE_CAMERA)this.fovMode===Ve.FOVMODE_VERTICAL_FIXED?(n=this.minZ*2*Math.tan(this.fov/2),s=this.getEngine().getAspectRatio(this)*n):(s=this.minZ*2*Math.tan(this.fov/2),n=s/this.getEngine().getAspectRatio(this));else{const a=this.getEngine().getRenderWidth()/2,l=this.getEngine().getRenderHeight()/2;s=((e=this.orthoRight)!==null&&e!==void 0?e:a)-((t=this.orthoLeft)!==null&&t!==void 0?t:-a),n=((i=this.orthoTop)!==null&&i!==void 0?i:l)-((r=this.orthoBottom)!==null&&r!==void 0?r:-l)}return s*n}set orthoLeft(e){this._orthoLeft=e;for(const t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(const t of this._rigCameras)t.mode=e}get mode(){return this._mode}constructor(e,t,i,r=!0){super(e,i),this._position=x.Zero(),this._upVector=x.Up(),this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=Ve.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new Dn(0,0,1,1),this.layerMask=268435455,this.fovMode=Ve.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=Ve.RIG_MODE_NONE,this.customRenderTargets=new Array,this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new Q,this.onProjectionMatrixChangedObservable=new Q,this.onAfterCheckInputsObservable=new Q,this.onRestoreStateObservable=new Q,this.isRigCamera=!1,this._rigCameras=new Array,this._webvrViewMatrix=H.Identity(),this._skipRendering=!1,this._projectionMatrix=new H,this._postProcesses=new Array,this._activeMeshes=new Lr(256),this._globalPosition=x.Zero(),this._computedViewMatrix=H.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=H.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=oe.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),r&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}_restoreStateValues(){return this._stateStored?(this.fov=this._storedFov,!0):!1}restoreState(){return this._restoreStateValues()?(this.onRestoreStateObservable.notifyObservers(this),!0):!1}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}isReady(e=!1){if(e){for(const t of this._postProcesses)if(t&&!t.isReady())return!1}return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new x(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new x(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return super._isSynchronized()?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;const t=this.getEngine();return this.mode===Ve.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),e}attachControl(e,t){}detachControl(e){}update(){this._checkInputs(),this.cameraRigMode!==Ve.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(this._postProcesses[e]!==null)return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let t=0,i=this._rigCameras.length;t<i;t++){const r=this._rigCameras[t],s=r._rigPostProcess;s?(s.getEffectName()==="pass"&&(r.isIntermediate=this._postProcesses.length===0),r._postProcesses=this._postProcesses.slice(0).concat(s),s.markTextureDirty()):r._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(X.Error("You're trying to reuse a post process not defined as reusable."),0):(t==null||t<0?this._postProcesses.push(e):this._postProcesses[t]===null?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)}_getViewMatrix(){return H.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,e!==void 0&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){var t,i,r,s,n,a,l,c;if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;const h=this.getEngine(),u=this.getScene(),d=h.useReverseDepthBuffer;if(this.mode===Ve.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=h.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1);let f;u.useRightHandedSystem?f=H.PerspectiveFovRHToRef:f=H.PerspectiveFovLHToRef,f(this.fov,h.getAspectRatio(this),d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===Ve.FOVMODE_VERTICAL_FIXED,h.isNDCHalfZRange,this.projectionPlaneTilt,d)}else{const f=h.getRenderWidth()/2,_=h.getRenderHeight()/2;u.useRightHandedSystem?H.OrthoOffCenterRHToRef((t=this.orthoLeft)!==null&&t!==void 0?t:-f,(i=this.orthoRight)!==null&&i!==void 0?i:f,(r=this.orthoBottom)!==null&&r!==void 0?r:-_,(s=this.orthoTop)!==null&&s!==void 0?s:_,d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,h.isNDCHalfZRange):H.OrthoOffCenterLHToRef((n=this.orthoLeft)!==null&&n!==void 0?n:-f,(a=this.orthoRight)!==null&&a!==void 0?a:f,(l=this.orthoBottom)!==null&&l!==void 0?l:-_,(c=this.orthoTop)!==null&&c!==void 0?c:_,d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,h.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=h.getRenderWidth(),this._cache.renderHeight=h.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?aa.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=aa.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let i=!1;return this.rigCameras.forEach(r=>{r._updateFrustumPlanes(),i=i||e.isInFrustum(r._frustumPlanes)}),i}else return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw pt("Ray")}getForwardRayToRef(e,t=100,i,r){throw pt("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const r=this._rigCameras.pop();r&&r.dispose()}if(this._parentContainer){const r=this._parentContainer.cameras.indexOf(this);r>-1&&this._parentContainer.cameras.splice(r,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==Ve.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let r=this._postProcesses.length;for(;--r>=0;){const s=this._postProcesses[r];s&&s.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const i=this._rigCameras.pop();i&&i.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=J.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==Ve.RIG_MODE_NONE){const i=this.createRigCamera(this.name+"_L",0);i&&(i._isLeftCamera=!0);const r=this.createRigCamera(this.name+"_R",1);r&&(r._isRightCamera=!0),i&&r&&(this._rigCameras.push(i),this._rigCameras.push(r))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return H.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}_updateCameraRotationMatrix(){}_updateWebVRCameraRotationMatrix(){}_getWebVRProjectionMatrix(){return H.Identity()}_getWebVRViewMatrix(){return H.Identity()}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,e==="interaxialDistance"&&(this._cameraRigParams.stereoHalfAngle=J.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===Ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){const e=ke.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),ke.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){const i=ke.Clone(Ve.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){const t=x.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){x.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,r=0,s=!0){const n=ii.Construct(e,t,i,{interaxial_distance:r,isStereoscopicSideBySide:s});return n||(()=>Ve._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){const i=e.type,r=Ve.GetConstructorFromName(i,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),s=ke.Parse(r,e,t);if(e.parentId!==void 0&&(s._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),s.inputs&&(s.inputs.parse(e),s._setupInputs()),e.upVector&&(s.upVector=x.FromArray(e.upVector)),s.setPosition&&(s.position.copyFromFloats(0,0,0),s.setPosition(x.FromArray(e.position))),e.target&&s.setTarget&&s.setTarget(x.FromArray(e.target)),e.cameraRigMode){const n=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};s.setCameraRigMode(e.cameraRigMode,n)}if(e.animations){for(let n=0;n<e.animations.length;n++){const a=e.animations[n],l=Xr("BABYLON.Animation");l&&s.animations.push(l.Parse(a))}ii.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&s.setEnabled(e.isEnabled),s}}Ve._CreateDefaultParsedCamera=(o,e)=>{throw pt("UniversalCamera")};Ve.PERSPECTIVE_CAMERA=0;Ve.ORTHOGRAPHIC_CAMERA=1;Ve.FOVMODE_VERTICAL_FIXED=0;Ve.FOVMODE_HORIZONTAL_FIXED=1;Ve.RIG_MODE_NONE=0;Ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;Ve.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;Ve.RIG_MODE_STEREOSCOPIC_INTERLACED=14;Ve.RIG_MODE_VR=20;Ve.RIG_MODE_WEBVR=21;Ve.RIG_MODE_CUSTOM=22;Ve.ForceAttachControlToAlwaysPreventDefault=!1;M([Zs("position")],Ve.prototype,"_position",void 0);M([Zs("upVector")],Ve.prototype,"_upVector",void 0);M([F()],Ve.prototype,"orthoLeft",null);M([F()],Ve.prototype,"orthoRight",null);M([F()],Ve.prototype,"orthoBottom",null);M([F()],Ve.prototype,"orthoTop",null);M([F()],Ve.prototype,"fov",void 0);M([F()],Ve.prototype,"projectionPlaneTilt",void 0);M([F()],Ve.prototype,"minZ",void 0);M([F()],Ve.prototype,"maxZ",void 0);M([F()],Ve.prototype,"inertia",void 0);M([F()],Ve.prototype,"mode",null);M([F()],Ve.prototype,"layerMask",void 0);M([F()],Ve.prototype,"fovMode",void 0);M([F()],Ve.prototype,"cameraRigMode",void 0);M([F()],Ve.prototype,"interaxialDistance",void 0);M([F()],Ve.prototype,"isStereoscopicSideBySide",void 0);class Oe{constructor(){this._applyTo=TS(this._applyToCoroutine.bind(this))}set(e,t){switch(e.length||X.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case O.PositionKind:this.positions=e;break;case O.NormalKind:this.normals=e;break;case O.TangentKind:this.tangents=e;break;case O.UVKind:this.uvs=e;break;case O.UV2Kind:this.uvs2=e;break;case O.UV3Kind:this.uvs3=e;break;case O.UV4Kind:this.uvs4=e;break;case O.UV5Kind:this.uvs5=e;break;case O.UV6Kind:this.uvs6=e;break;case O.ColorKind:this.colors=e;break;case O.MatricesIndicesKind:this.matricesIndices=e;break;case O.MatricesWeightsKind:this.matricesWeights=e;break;case O.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case O.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;break}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,i){return this.positions&&(e.setVerticesData(O.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(O.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(O.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(O.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(O.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(O.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(O.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(O.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(O.UV6Kind,this.uvs6,t),i&&(yield)),this.colors&&(e.setVerticesData(O.ColorKind,this.colors,t),i&&(yield)),this.matricesIndices&&(e.setVerticesData(O.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(O.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(O.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(O.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),this}_update(e,t,i){return this.positions&&e.updateVerticesData(O.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(O.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(O.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(O.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(O.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(O.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(O.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(O.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(O.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(O.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(O.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(O.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(O.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(O.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,r=e.length){const s=j.Vector3[0],n=j.Vector3[1];for(let a=i;a<i+r;a+=3)x.FromArrayToRef(e,a,s),x.TransformCoordinatesToRef(s,t,n),e[a]=n.x,e[a+1]=n.y,e[a+2]=n.z}static _TransformVector3Normals(e,t,i=0,r=e.length){const s=j.Vector3[0],n=j.Vector3[1];for(let a=i;a<i+r;a+=3)x.FromArrayToRef(e,a,s),x.TransformNormalToRef(s,t,n),e[a]=n.x,e[a+1]=n.y,e[a+2]=n.z}static _TransformVector4Normals(e,t,i=0,r=e.length){const s=j.Vector4[0],n=j.Vector4[1];for(let a=i;a<i+r;a+=4)Tt.FromArrayToRef(e,a,s),Tt.TransformNormalToRef(s,t,n),e[a]=n.x,e[a+1]=n.y,e[a+2]=n.z,e[a+3]=n.w}static _FlipFaces(e,t=0,i=e.length){for(let r=t;r<t+i;r+=3){const s=e[r+1];e[r+1]=e[r+2],e[r+2]=s}}transform(e){const t=e.determinant()<0;return this.positions&&Oe._TransformVector3Coordinates(this.positions,e),this.normals&&Oe._TransformVector3Normals(this.normals,e),this.tangents&&Oe._TransformVector4Normals(this.tangents,e),t&&this.indices&&Oe._FlipFaces(this.indices),this}merge(e,t=!1,i=!1){const r=Array.isArray(e)?e.map(s=>[s,void 0]):[[e,void 0]];return am(this._mergeCoroutine(void 0,r,t,!1,i))}*_mergeCoroutine(e,t,i=!1,r,s){var n,a,l,c;this._validate();const h=t.map(_=>_[0]);for(const _ of h)if(_._validate(),!this.normals!=!_.normals||!this.tangents!=!_.tangents||!this.uvs!=!_.uvs||!this.uvs2!=!_.uvs2||!this.uvs3!=!_.uvs3||!this.uvs4!=!_.uvs4||!this.uvs5!=!_.uvs5||!this.uvs6!=!_.uvs6||!this.colors!=!_.colors||!this.matricesIndices!=!_.matricesIndices||!this.matricesWeights!=!_.matricesWeights||!this.matricesIndicesExtra!=!_.matricesIndicesExtra||!this.matricesWeightsExtra!=!_.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");const u=h.reduce((_,p)=>{var m,T;return _+((T=(m=p.indices)===null||m===void 0?void 0:m.length)!==null&&T!==void 0?T:0)},(a=(n=this.indices)===null||n===void 0?void 0:n.length)!==null&&a!==void 0?a:0);let f=s||h.some(_=>_.indices===this.indices)?(l=this.indices)===null||l===void 0?void 0:l.slice():this.indices;if(u>0){let _=(c=f==null?void 0:f.length)!==null&&c!==void 0?c:0;if(f||(f=new Array(u)),f.length!==u){if(Array.isArray(f))f.length=u;else{const m=i||f instanceof Uint32Array?new Uint32Array(u):new Uint16Array(u);m.set(f),f=m}e&&e.determinant()<0&&Oe._FlipFaces(f,0,_)}let p=this.positions?this.positions.length/3:0;for(const[m,T]of t)if(m.indices){for(let b=0;b<m.indices.length;b++)f[_+b]=m.indices[b]+p;T&&T.determinant()<0&&Oe._FlipFaces(f,_,m.indices.length),p+=m.positions.length/3,_+=m.indices.length,r&&(yield)}}return this.indices=f,this.positions=Oe._MergeElement(O.PositionKind,this.positions,e,t.map(_=>[_[0].positions,_[1]])),r&&(yield),this.normals=Oe._MergeElement(O.NormalKind,this.normals,e,t.map(_=>[_[0].normals,_[1]])),r&&(yield),this.tangents=Oe._MergeElement(O.TangentKind,this.tangents,e,t.map(_=>[_[0].tangents,_[1]])),r&&(yield),this.uvs=Oe._MergeElement(O.UVKind,this.uvs,e,t.map(_=>[_[0].uvs,_[1]])),r&&(yield),this.uvs2=Oe._MergeElement(O.UV2Kind,this.uvs2,e,t.map(_=>[_[0].uvs2,_[1]])),r&&(yield),this.uvs3=Oe._MergeElement(O.UV3Kind,this.uvs3,e,t.map(_=>[_[0].uvs3,_[1]])),r&&(yield),this.uvs4=Oe._MergeElement(O.UV4Kind,this.uvs4,e,t.map(_=>[_[0].uvs4,_[1]])),r&&(yield),this.uvs5=Oe._MergeElement(O.UV5Kind,this.uvs5,e,t.map(_=>[_[0].uvs5,_[1]])),r&&(yield),this.uvs6=Oe._MergeElement(O.UV6Kind,this.uvs6,e,t.map(_=>[_[0].uvs6,_[1]])),r&&(yield),this.colors=Oe._MergeElement(O.ColorKind,this.colors,e,t.map(_=>[_[0].colors,_[1]])),r&&(yield),this.matricesIndices=Oe._MergeElement(O.MatricesIndicesKind,this.matricesIndices,e,t.map(_=>[_[0].matricesIndices,_[1]])),r&&(yield),this.matricesWeights=Oe._MergeElement(O.MatricesWeightsKind,this.matricesWeights,e,t.map(_=>[_[0].matricesWeights,_[1]])),r&&(yield),this.matricesIndicesExtra=Oe._MergeElement(O.MatricesIndicesExtraKind,this.matricesIndicesExtra,e,t.map(_=>[_[0].matricesIndicesExtra,_[1]])),r&&(yield),this.matricesWeightsExtra=Oe._MergeElement(O.MatricesWeightsExtraKind,this.matricesWeightsExtra,e,t.map(_=>[_[0].matricesWeightsExtra,_[1]])),this}static _MergeElement(e,t,i,r){const s=r.filter(l=>l[0]!==null&&l[0]!==void 0);if(!t&&s.length==0)return t;if(!t)return this._MergeElement(e,s[0][0],s[0][1],s.slice(1));const n=s.reduce((l,c)=>l+c[0].length,t.length),a=e===O.PositionKind?Oe._TransformVector3Coordinates:e===O.NormalKind?Oe._TransformVector3Normals:e===O.TangentKind?Oe._TransformVector4Normals:()=>{};if(t instanceof Float32Array){const l=new Float32Array(n);l.set(t),i&&a(l,i,0,t.length);let c=t.length;for(const[h,u]of s)l.set(h,c),u&&a(l,u,c,h.length),c+=h.length;return l}else{const l=new Array(n);for(let h=0;h<t.length;h++)l[h]=t[h];i&&a(l,i,0,t.length);let c=t.length;for(const[h,u]of s){for(let d=0;d<h.length;d++)l[c+d]=h[d];u&&a(l,u,c,h.length),c+=h.length}return l}}_validate(){if(!this.positions)throw new Wa("Positions are required",Wo.MeshInvalidPositionsError);const e=(r,s)=>{const n=O.DeduceStride(r);if(s.length%n!==0)throw new Error("The "+r+"s array count must be a multiple of "+n);return s.length/n},t=e(O.PositionKind,this.positions),i=(r,s)=>{const n=e(r,s);if(n!==t)throw new Error("The "+r+"s element count ("+n+") does not match the positions count ("+t+")")};this.normals&&i(O.NormalKind,this.normals),this.tangents&&i(O.TangentKind,this.tangents),this.uvs&&i(O.UVKind,this.uvs),this.uvs2&&i(O.UV2Kind,this.uvs2),this.uvs3&&i(O.UV3Kind,this.uvs3),this.uvs4&&i(O.UV4Kind,this.uvs4),this.uvs5&&i(O.UV5Kind,this.uvs5),this.uvs6&&i(O.UV6Kind,this.uvs6),this.colors&&i(O.ColorKind,this.colors),this.matricesIndices&&i(O.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(O.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(O.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(O.MatricesWeightsExtraKind,this.matricesWeightsExtra)}serialize(){const e={};return this.positions&&(e.positions=this.positions),this.normals&&(e.normals=this.normals),this.tangents&&(e.tangents=this.tangents),this.uvs&&(e.uvs=this.uvs),this.uvs2&&(e.uvs2=this.uvs2),this.uvs3&&(e.uvs3=this.uvs3),this.uvs4&&(e.uvs4=this.uvs4),this.uvs5&&(e.uvs5=this.uvs5),this.uvs6&&(e.uvs6=this.uvs6),this.colors&&(e.colors=this.colors),this.matricesIndices&&(e.matricesIndices=this.matricesIndices,e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(e.matricesIndicesExtra=this.matricesIndicesExtra,e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=this.matricesWeightsExtra),e.indices=this.indices,e}static ExtractFromMesh(e,t,i){return Oe._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return Oe._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){const r=new Oe;return e.isVerticesDataPresent(O.PositionKind)&&(r.positions=e.getVerticesData(O.PositionKind,t,i)),e.isVerticesDataPresent(O.NormalKind)&&(r.normals=e.getVerticesData(O.NormalKind,t,i)),e.isVerticesDataPresent(O.TangentKind)&&(r.tangents=e.getVerticesData(O.TangentKind,t,i)),e.isVerticesDataPresent(O.UVKind)&&(r.uvs=e.getVerticesData(O.UVKind,t,i)),e.isVerticesDataPresent(O.UV2Kind)&&(r.uvs2=e.getVerticesData(O.UV2Kind,t,i)),e.isVerticesDataPresent(O.UV3Kind)&&(r.uvs3=e.getVerticesData(O.UV3Kind,t,i)),e.isVerticesDataPresent(O.UV4Kind)&&(r.uvs4=e.getVerticesData(O.UV4Kind,t,i)),e.isVerticesDataPresent(O.UV5Kind)&&(r.uvs5=e.getVerticesData(O.UV5Kind,t,i)),e.isVerticesDataPresent(O.UV6Kind)&&(r.uvs6=e.getVerticesData(O.UV6Kind,t,i)),e.isVerticesDataPresent(O.ColorKind)&&(r.colors=e.getVerticesData(O.ColorKind,t,i)),e.isVerticesDataPresent(O.MatricesIndicesKind)&&(r.matricesIndices=e.getVerticesData(O.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(O.MatricesWeightsKind)&&(r.matricesWeights=e.getVerticesData(O.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(O.MatricesIndicesExtraKind)&&(r.matricesIndicesExtra=e.getVerticesData(O.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(O.MatricesWeightsExtraKind)&&(r.matricesWeightsExtra=e.getVerticesData(O.MatricesWeightsExtraKind,t,i)),r.indices=e.getIndices(t,i),r}static CreateRibbon(e){throw pt("ribbonBuilder")}static CreateBox(e){throw pt("boxBuilder")}static CreateTiledBox(e){throw pt("tiledBoxBuilder")}static CreateTiledPlane(e){throw pt("tiledPlaneBuilder")}static CreateSphere(e){throw pt("sphereBuilder")}static CreateCylinder(e){throw pt("cylinderBuilder")}static CreateTorus(e){throw pt("torusBuilder")}static CreateLineSystem(e){throw pt("linesBuilder")}static CreateDashedLines(e){throw pt("linesBuilder")}static CreateGround(e){throw pt("groundBuilder")}static CreateTiledGround(e){throw pt("groundBuilder")}static CreateGroundFromHeightMap(e){throw pt("groundBuilder")}static CreatePlane(e){throw pt("planeBuilder")}static CreateDisc(e){throw pt("discBuilder")}static CreatePolygon(e,t,i,r,s,n,a){throw pt("polygonBuilder")}static CreateIcoSphere(e){throw pt("icoSphereBuilder")}static CreatePolyhedron(e){throw pt("polyhedronBuilder")}static CreateCapsule(e={orientation:x.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw pt("capsuleBuilder")}static CreateTorusKnot(e){throw pt("torusKnotBuilder")}static ComputeNormals(e,t,i,r){let s=0,n=0,a=0,l=0,c=0,h=0,u=0,d=0,f=0,_=0,p=0,m=0,T=0,b=0,y=0,S=0,C=0,I=0,P=0,D=0,w=!1,L=!1,U=!1,G=!1,Z=1,he=0,_e=null;r&&(w=!!r.facetNormals,L=!!r.facetPositions,U=!!r.facetPartitioning,Z=r.useRightHandedSystem===!0?-1:1,he=r.ratio||0,G=!!r.depthSort,_e=r.distanceTo,G&&_e===void 0&&(_e=x.Zero()));let ne=0,Pe=0,Se=0,ce=0;for(U&&r&&r.bbSize&&(ne=r.subDiv.X*he/r.bbSize.x,Pe=r.subDiv.Y*he/r.bbSize.y,Se=r.subDiv.Z*he/r.bbSize.z,ce=r.subDiv.max*r.subDiv.max,r.facetPartitioning.length=0),s=0;s<e.length;s++)i[s]=0;const de=t.length/3|0;for(s=0;s<de;s++){if(m=t[s*3]*3,T=m+1,b=m+2,y=t[s*3+1]*3,S=y+1,C=y+2,I=t[s*3+2]*3,P=I+1,D=I+2,n=e[m]-e[y],a=e[T]-e[S],l=e[b]-e[C],c=e[I]-e[y],h=e[P]-e[S],u=e[D]-e[C],d=Z*(a*u-l*h),f=Z*(l*c-n*u),_=Z*(n*h-a*c),p=Math.sqrt(d*d+f*f+_*_),p=p===0?1:p,d/=p,f/=p,_/=p,w&&r&&(r.facetNormals[s].x=d,r.facetNormals[s].y=f,r.facetNormals[s].z=_),L&&r&&(r.facetPositions[s].x=(e[m]+e[y]+e[I])/3,r.facetPositions[s].y=(e[T]+e[S]+e[P])/3,r.facetPositions[s].z=(e[b]+e[C]+e[D])/3),U&&r){const k=Math.floor((r.facetPositions[s].x-r.bInfo.minimum.x*he)*ne),se=Math.floor((r.facetPositions[s].y-r.bInfo.minimum.y*he)*Pe),xe=Math.floor((r.facetPositions[s].z-r.bInfo.minimum.z*he)*Se),le=Math.floor((e[m]-r.bInfo.minimum.x*he)*ne),je=Math.floor((e[T]-r.bInfo.minimum.y*he)*Pe),st=Math.floor((e[b]-r.bInfo.minimum.z*he)*Se),be=Math.floor((e[y]-r.bInfo.minimum.x*he)*ne),We=Math.floor((e[S]-r.bInfo.minimum.y*he)*Pe),Ct=Math.floor((e[C]-r.bInfo.minimum.z*he)*Se),_t=Math.floor((e[I]-r.bInfo.minimum.x*he)*ne),mt=Math.floor((e[P]-r.bInfo.minimum.y*he)*Pe),Ge=Math.floor((e[D]-r.bInfo.minimum.z*he)*Se),Ut=le+r.subDiv.max*je+ce*st,Ft=be+r.subDiv.max*We+ce*Ct,Zt=_t+r.subDiv.max*mt+ce*Ge,$t=k+r.subDiv.max*se+ce*xe;r.facetPartitioning[$t]=r.facetPartitioning[$t]?r.facetPartitioning[$t]:new Array,r.facetPartitioning[Ut]=r.facetPartitioning[Ut]?r.facetPartitioning[Ut]:new Array,r.facetPartitioning[Ft]=r.facetPartitioning[Ft]?r.facetPartitioning[Ft]:new Array,r.facetPartitioning[Zt]=r.facetPartitioning[Zt]?r.facetPartitioning[Zt]:new Array,r.facetPartitioning[Ut].push(s),Ft!=Ut&&r.facetPartitioning[Ft].push(s),Zt==Ft||Zt==Ut||r.facetPartitioning[Zt].push(s),$t==Ut||$t==Ft||$t==Zt||r.facetPartitioning[$t].push(s)}if(G&&r&&r.facetPositions){const k=r.depthSortedFacets[s];k.ind=s*3,k.sqDistance=x.DistanceSquared(r.facetPositions[s],_e)}i[m]+=d,i[T]+=f,i[b]+=_,i[y]+=d,i[S]+=f,i[C]+=_,i[I]+=d,i[P]+=f,i[D]+=_}for(s=0;s<i.length/3;s++)d=i[s*3],f=i[s*3+1],_=i[s*3+2],p=Math.sqrt(d*d+f*f+_*_),p=p===0?1:p,d/=p,f/=p,_/=p,i[s*3]=d,i[s*3+1]=f,i[s*3+2]=_}static _ComputeSides(e,t,i,r,s,n,a){const l=i.length,c=r.length;let h,u;switch(e=e||Oe.DEFAULTSIDE,e){case Oe.FRONTSIDE:break;case Oe.BACKSIDE:for(h=0;h<l;h+=3){const d=i[h];i[h]=i[h+2],i[h+2]=d}for(u=0;u<c;u++)r[u]=-r[u];break;case Oe.DOUBLESIDE:{const d=t.length,f=d/3;for(let m=0;m<d;m++)t[d+m]=t[m];for(h=0;h<l;h+=3)i[h+l]=i[h+2]+f,i[h+1+l]=i[h+1]+f,i[h+2+l]=i[h]+f;for(u=0;u<c;u++)r[c+u]=-r[u];const _=s.length;let p=0;for(p=0;p<_;p++)s[p+_]=s[p];for(n=n||new Tt(0,0,1,1),a=a||new Tt(0,0,1,1),p=0,h=0;h<_/2;h++)s[p]=n.x+(n.z-n.x)*s[p],s[p+1]=n.y+(n.w-n.y)*s[p+1],s[p+_]=a.x+(a.z-a.x)*s[p+_],s[p+_+1]=a.y+(a.w-a.y)*s[p+_+1],p+=2;break}}}static ImportVertexData(e,t){const i=new Oe,r=e.positions;r&&i.set(r,O.PositionKind);const s=e.normals;s&&i.set(s,O.NormalKind);const n=e.tangents;n&&i.set(n,O.TangentKind);const a=e.uvs;a&&i.set(a,O.UVKind);const l=e.uv2s;l&&i.set(l,O.UV2Kind);const c=e.uv3s;c&&i.set(c,O.UV3Kind);const h=e.uv4s;h&&i.set(h,O.UV4Kind);const u=e.uv5s;u&&i.set(u,O.UV5Kind);const d=e.uv6s;d&&i.set(d,O.UV6Kind);const f=e.colors;f&&i.set(Ye.CheckColors4(f,r.length/3),O.ColorKind);const _=e.matricesIndices;_&&i.set(_,O.MatricesIndicesKind);const p=e.matricesWeights;p&&i.set(p,O.MatricesWeightsKind);const m=e.indices;m&&(i.indices=m),t.setAllVerticesData(i,e.updatable)}}Oe.FRONTSIDE=0;Oe.BACKSIDE=1;Oe.DOUBLESIDE=2;Oe.DEFAULTSIDE=0;M([Il.filter((...[o])=>!Array.isArray(o))],Oe,"_TransformVector3Coordinates",null);M([Il.filter((...[o])=>!Array.isArray(o))],Oe,"_TransformVector3Normals",null);M([Il.filter((...[o])=>!Array.isArray(o))],Oe,"_TransformVector4Normals",null);M([Il.filter((...[o])=>!Array.isArray(o))],Oe,"_FlipFaces",null);class H_{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0}}class Va{constructor(e,t,i){this.vectors=Br.BuildArray(8,x.Zero),this.center=x.Zero(),this.centerWorld=x.Zero(),this.extendSize=x.Zero(),this.extendSizeWorld=x.Zero(),this.directions=Br.BuildArray(3,x.Zero),this.vectorsWorld=Br.BuildArray(8,x.Zero),this.minimumWorld=x.Zero(),this.maximumWorld=x.Zero(),this.minimum=x.Zero(),this.maximum=x.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){const r=e.x,s=e.y,n=e.z,a=t.x,l=t.y,c=t.z,h=this.vectors;this.minimum.copyFromFloats(r,s,n),this.maximum.copyFromFloats(a,l,c),h[0].copyFromFloats(r,s,n),h[1].copyFromFloats(a,l,c),h[2].copyFromFloats(a,s,n),h[3].copyFromFloats(r,l,n),h[4].copyFromFloats(r,s,c),h[5].copyFromFloats(a,l,n),h[6].copyFromFloats(r,l,c),h[7].copyFromFloats(a,s,c),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||H.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){const t=Va._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),r=i.length();i.normalizeFromLength(r);const s=r*e,n=i.scaleInPlace(s*.5),a=this.center.subtractToRef(n,t[1]),l=this.center.addToRef(n,t[2]);return this.reConstruct(a,l,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){const t=this.minimumWorld,i=this.maximumWorld,r=this.directions,s=this.vectorsWorld,n=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let a=0;a<8;++a)s[a].copyFrom(n[a]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let a=0;a<8;++a){const l=s[a];x.TransformCoordinatesToRef(n[a],e,l),t.minimizeInPlace(l),i.maximizeInPlace(l)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}x.FromArrayToRef(e.m,0,r[0]),x.FromArrayToRef(e.m,4,r[1]),x.FromArrayToRef(e.m,8,r[2]),this._worldMatrix=e}isInFrustum(e){return Va.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return Va.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){const t=this.minimumWorld,i=this.maximumWorld,r=t.x,s=t.y,n=t.z,a=i.x,l=i.y,c=i.z,h=e.x,u=e.y,d=e.z,f=-kt;return!(a-h<f||f>h-r||l-u<f||f>u-s||c-d<f||f>d-n)}intersectsSphere(e){return Va.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){const i=this.minimumWorld,r=this.maximumWorld,s=i.x,n=i.y,a=i.z,l=r.x,c=r.y,h=r.z,u=e.x,d=e.y,f=e.z,_=t.x,p=t.y,m=t.z;return!(l<u||s>_||c<d||n>p||h<f||a>m)}dispose(){var e,t;(e=this._drawWrapperFront)===null||e===void 0||e.dispose(),(t=this._drawWrapperBack)===null||t===void 0||t.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,r){const s=Va._TmpVector3[0];return x.ClampToRef(i,e,t,s),x.DistanceSquared(i,s)<=r*r}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){const r=t[i];for(let s=0;s<8;++s)if(r.dotCoordinate(e[s])<0)return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let r=!0;const s=t[i];for(let n=0;n<8;++n)if(s.dotCoordinate(e[n])>=0){r=!1;break}if(r)return!1}return!0}}Va._TmpVector3=Br.BuildArray(3,x.Zero);class Xo{constructor(e,t,i){this.center=x.Zero(),this.centerWorld=x.Zero(),this.minimum=x.Zero(),this.maximum=x.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);const r=x.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=r*.5,this._update(i||H.IdentityReadOnly)}scale(e){const t=this.radius*e,i=Xo._TmpVector3,r=i[0].setAll(t),s=this.center.subtractToRef(r,i[1]),n=this.center.addToRef(r,i[2]);return this.reConstruct(s,n,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{x.TransformCoordinatesToRef(this.center,e,this.centerWorld);const t=Xo._TmpVector3[0];x.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){const t=this.centerWorld,i=this.radiusWorld;for(let r=0;r<6;r++)if(e[r].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){const t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){const t=x.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){const i=x.DistanceSquared(e.centerWorld,t.centerWorld),r=e.radiusWorld+t.radiusWorld;return!(r*r<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);const r=new Xo(this._TmpVector3[0],this._TmpVector3[2]);return i?r._worldMatrix=i:r._worldMatrix=H.Identity(),r}}Xo._TmpVector3=Br.BuildArray(3,x.Zero);const p_={min:0,max:0},m_={min:0,max:0},nv=(o,e,t)=>{const i=x.Dot(e.centerWorld,o),r=Math.abs(x.Dot(e.directions[0],o))*e.extendSize.x,s=Math.abs(x.Dot(e.directions[1],o))*e.extendSize.y,n=Math.abs(x.Dot(e.directions[2],o))*e.extendSize.z,a=r+s+n;t.min=i-a,t.max=i+a},An=(o,e,t)=>(nv(o,e,p_),nv(o,t,m_),!(p_.min>m_.max||m_.min>p_.max));class Qn{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new Va(e,t,i),this.boundingSphere=new Xo(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){const i=Qn._TmpVector3[0].copyFrom(e).subtractInPlace(t),r=Qn._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,r,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,r,this.boundingBox.getWorldMatrix()),this}encapsulate(e){const t=x.Minimize(this.minimum,e),i=x.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){return this.encapsulate(e.boundingBox.centerWorld.subtract(e.boundingBox.extendSizeWorld)),this.encapsulate(e.boundingBox.centerWorld.add(e.boundingBox.extendSizeWorld)),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return(t===2||t===3)&&this.boundingSphere.isCenterInFrustum(e)?!0:this.boundingSphere.isInFrustum(e)?t===1||t===3?!0:this.boundingBox.isInFrustum(e):!1}get diagonalLength(){const e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,Qn._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))}intersects(e,t){if(!Xo.Intersects(this.boundingSphere,e.boundingSphere)||!Va.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;const i=this.boundingBox,r=e.boundingBox;return!(!An(i.directions[0],i,r)||!An(i.directions[1],i,r)||!An(i.directions[2],i,r)||!An(r.directions[0],i,r)||!An(r.directions[1],i,r)||!An(r.directions[2],i,r)||!An(x.Cross(i.directions[0],r.directions[0]),i,r)||!An(x.Cross(i.directions[0],r.directions[1]),i,r)||!An(x.Cross(i.directions[0],r.directions[2]),i,r)||!An(x.Cross(i.directions[1],r.directions[0]),i,r)||!An(x.Cross(i.directions[1],r.directions[1]),i,r)||!An(x.Cross(i.directions[1],r.directions[2]),i,r)||!An(x.Cross(i.directions[2],r.directions[0]),i,r)||!An(x.Cross(i.directions[2],r.directions[1]),i,r)||!An(x.Cross(i.directions[2],r.directions[2]),i,r))}}Qn._TmpVector3=Br.BuildArray(2,x.Zero);class ff{static extractMinAndMaxIndexed(e,t,i,r,s,n){for(let a=i;a<i+r;a++){const l=t[a]*3,c=e[l],h=e[l+1],u=e[l+2];s.minimizeInPlaceFromFloats(c,h,u),n.maximizeInPlaceFromFloats(c,h,u)}}static extractMinAndMax(e,t,i,r,s,n){for(let a=t,l=t*r;a<t+i;a++,l+=r){const c=e[l],h=e[l+1],u=e[l+2];s.minimizeInPlaceFromFloats(c,h,u),n.maximizeInPlaceFromFloats(c,h,u)}}}M([Il.filter((...[o,e])=>!Array.isArray(o)&&!Array.isArray(e))],ff,"extractMinAndMaxIndexed",null);M([Il.filter((...[o])=>!Array.isArray(o))],ff,"extractMinAndMax",null);function ES(o,e,t,i,r=null){const s=new x(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new x(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return ff.extractMinAndMaxIndexed(o,e,t,i,s,n),r&&(s.x-=s.x*r.x+r.y,s.y-=s.y*r.x+r.y,s.z-=s.z*r.x+r.y,n.x+=n.x*r.x+r.y,n.y+=n.y*r.x+r.y,n.z+=n.z*r.x+r.y),{minimum:s,maximum:n}}function mT(o,e,t,i=null,r){const s=new x(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new x(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return r||(r=3),ff.extractMinAndMax(o,e,t,r,s,n),i&&(s.x-=s.x*i.x+i.y,s.y-=s.y*i.x+i.y,s.z-=s.z*i.x+i.y,n.x+=n.x*i.x+i.y,n.y+=n.y*i.x+i.y,n.z+=n.z*i.x+i.y),{minimum:s,maximum:n}}class qs{get materialDefines(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:(e=this._getDrawWrapper())===null||e===void 0?void 0:e.defines}set materialDefines(e){var t;const i=(t=this._mainDrawWrapperOverride)!==null&&t!==void 0?t:this._getDrawWrapper(void 0,!0);i.defines=e}_getDrawWrapper(e,t=!1){e=e??this._engine.currentRenderPassId;let i=this._drawWrappers[e];return!i&&t&&(this._drawWrappers[e]=i=new vs(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0){var i;t&&((i=this._drawWrappers[e])===null||i===void 0||i.dispose()),this._drawWrappers[e]=void 0}get effect(){var e,t;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:(t=(e=this._getDrawWrapper())===null||e===void 0?void 0:e.effect)!==null&&t!==void 0?t:null}get _drawWrapper(){var e;return(e=this._mainDrawWrapperOverride)!==null&&e!==void 0?e:this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,i,r=!0){const s=this._drawWrapper;s.setEffect(e,t,r),i!==void 0&&(s.materialContext=i),e||(s.defines=null,s.materialContext=void 0)}resetDrawCache(e){if(this._drawWrappers)if(e!==void 0){this._removeDrawWrapper(e);return}else for(const t of this._drawWrappers)t==null||t.dispose();this._drawWrappers=[]}static AddToMesh(e,t,i,r,s,n,a,l=!0){return new qs(e,t,i,r,s,n,a,l)}constructor(e,t,i,r,s,n,a,l=!0,c=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=r,this.indexCount=s,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=n,this._renderingMesh=a||n,c&&n.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=n.subMeshes.length-1,l&&(this.refreshBoundingInfo(),n.computeWorldMatrix(!0))}get IsGlobal(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){const e=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return e||this._renderingMesh}getMaterial(e=!0){var t;const i=(t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))!==null&&t!==void 0?t:this._renderingMesh.material;if(i){if(this._isMultiMaterial(i)){const r=i.getSubMaterial(this.materialIndex);return this._currentMaterial!==r&&(this._currentMaterial=r,this.resetDrawCache()),r}}else return e?this._mesh.getScene().defaultMaterial:null;return i}_isMultiMaterial(e){return e.getSubMaterial!==void 0}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(O.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;const t=this._renderingMesh.getIndices();let i;if(this.indexStart===0&&this.indexCount===t.length){const r=this._renderingMesh.getBoundingInfo();i={minimum:r.minimum.clone(),maximum:r.maximum.clone()}}else i=ES(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Qn(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){const t=this.getBoundingInfo();return t?t.isInFrustum(e,this._mesh.cullingStrategy):!1}isCompletelyInFrustum(e){const t=this.getBoundingInfo();return t?t.isCompletelyInFrustum(e):!1}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){const i=[];for(let r=this.indexStart;r<this.indexStart+this.indexCount;r+=3)i.push(e[r],e[r+1],e[r+1],e[r+2],e[r+2],e[r]);this._linesIndexBuffer=t.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer}canIntersects(e){const t=this.getBoundingInfo();return t?e.intersectsBox(t.boundingBox):!1}intersects(e,t,i,r,s){const n=this.getMaterial();if(!n)return null;let a=3,l=!1;switch(n.fillMode){case 3:case 5:case 6:case 8:return null;case 7:a=1,l=!0;break}return n.fillMode===4?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,r):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,r):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,r,s):this._intersectTriangles(e,t,i,a,l,r,s)}_intersectLines(e,t,i,r,s){let n=null;for(let a=this.indexStart;a<this.indexStart+this.indexCount;a+=2){const l=t[i[a]],c=t[i[a+1]],h=e.intersectionSegment(l,c,r);if(!(h<0)&&(s||!n||h<n.distance)&&(n=new H_(null,null,h),n.faceId=a/2,s))break}return n}_intersectUnIndexedLines(e,t,i,r,s){let n=null;for(let a=this.verticesStart;a<this.verticesStart+this.verticesCount;a+=2){const l=t[a],c=t[a+1],h=e.intersectionSegment(l,c,r);if(!(h<0)&&(s||!n||h<n.distance)&&(n=new H_(null,null,h),n.faceId=a/2,s))break}return n}_intersectTriangles(e,t,i,r,s,n,a){let l=null,c=-1;for(let h=this.indexStart;h<this.indexStart+this.indexCount-(3-r);h+=r){c++;const u=i[h],d=i[h+1],f=i[h+2];if(s&&f===4294967295){h+=2;continue}const _=t[u],p=t[d],m=t[f];if(!_||!p||!m||a&&!a(_,p,m,e,u,d,f))continue;const T=e.intersectsTriangle(_,p,m);if(T){if(T.distance<0)continue;if((n||!l||T.distance<l.distance)&&(l=T,l.faceId=c,n))break}}return l}_intersectUnIndexedTriangles(e,t,i,r,s){let n=null;for(let a=this.verticesStart;a<this.verticesStart+this.verticesCount;a+=3){const l=t[a],c=t[a+1],h=t[a+2];if(s&&!s(l,c,h,e,-1,-1,-1))continue;const u=e.intersectsTriangle(l,c,h);if(u){if(u.distance<0)continue;if((r||!n||u.distance<n.distance)&&(n=u,n.faceId=a/3,r))break}}return n}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){const i=new qs(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){const r=this.getBoundingInfo();if(!r)return i;i._boundingInfo=new Qn(r.minimum,r.maximum)}return i}dispose(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);const e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,i,r,s,n=!0){let a=Number.MAX_VALUE,l=-Number.MAX_VALUE;const h=(s||r).getIndices();for(let u=t;u<t+i;u++){const d=h[u];d<a&&(a=d),d>l&&(l=d)}return new qs(e,a,l-a+1,t,i,r,s,n)}}class Wr{static get ForceFullSceneLoadingForIncremental(){return Wr._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){Wr._ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return Wr._ShowLoadingScreen}static set ShowLoadingScreen(e){Wr._ShowLoadingScreen=e}static get loggingLevel(){return Wr._LoggingLevel}static set loggingLevel(e){Wr._LoggingLevel=e}static get CleanBoneMatrixWeights(){return Wr._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){Wr._CleanBoneMatrixWeights=e}}Wr._ForceFullSceneLoadingForIncremental=!1;Wr._ShowLoadingScreen=!0;Wr._CleanBoneMatrixWeights=!1;Wr._LoggingLevel=0;class Yt{}Yt.UseOpenGLOrientationForUV=!1;class Bs{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){const t=new Bs(Bs.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,t,i,r=!1,s=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||qe.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=r,i?this.setAllVerticesData(i,r):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),s&&(this.applyToMesh(s),s.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return this.delayLoadState===1||this.delayLoadState===0}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable));for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,i=!1,r){i&&Array.isArray(t)&&(t=new Float32Array(t));const s=new O(this._engine,t,e,i,this._meshes.length===0,r);this.setVerticesBuffer(s)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,i=!0){const r=e.getKind();this._vertexBuffers[r]&&i&&this._vertexBuffers[r].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[r]=e;const s=this._meshes,n=s.length;if(r===O.PositionKind){const a=e.getData();t!=null?this._totalVertices=t:a!=null&&(this._totalVertices=a.length/(e.type===O.BYTE?e.byteStride:e.byteStride/4)),this._updateExtend(a),this._resetPointsArrayCache();for(let l=0;l<n;l++){const c=s[l];c.buildBoundingInfo(this._extend.minimum,this._extend.maximum),c._createGlobalSubMesh(c.isUnIndexed),c.computeWorldMatrix(!0),c.synchronizeInstances()}}this._notifyUpdate(r)}updateVerticesDataDirectly(e,t,i,r=!1){const s=this.getVertexBuffer(e);s&&(s.updateDirectly(t,i,r),this._notifyUpdate(e))}updateVerticesData(e,t,i=!1){const r=this.getVertexBuffer(e);r&&(r.update(t),e===O.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){const i=this._meshes;for(const r of i){r.hasBoundingInfo?r.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):r.buildBoundingInfo(this._extend.minimum,this._extend.maximum);const s=r.subMeshes;for(const n of s)n.refreshBoundingInfo()}}}_bind(e,t,i,r){if(!e)return;t===void 0&&(t=this._indexBuffer);const s=this.getVertexBuffers();if(!s)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!r){this._engine.bindBuffers(s,t,e,i);return}const n=r||this._vertexArrayObjects;n[e.key]||(n[e.key]=this._engine.recordVertexArrayObject(s,t,e,i)),this._engine.bindVertexArrayObject(n[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){const r=this.getVertexBuffer(e);return r?r.getFloatData(this._totalVertices,i||t&&this._meshes.length!==1):null}isVertexBufferUpdatable(e){const t=this._vertexBuffers[e];return t?t.isUpdatable():!1}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?this._vertexBuffers[e]!==void 0:this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}getVerticesDataKinds(){const e=[];let t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=!1){if(this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(e,null,!0);else{const r=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),r)for(const s of this._meshes)s._createGlobalSubMesh(!0)}}setIndices(e,t=null,i=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i)),t!=null&&(this._totalVertices=t);for(const r of this._meshes)r._createGlobalSubMesh(!0),r.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;const i=this._indices;return!t&&(!e||this._meshes.length===1)?i:i.slice()}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){const i=this._meshes,r=i.indexOf(e);r!==-1&&(i.splice(r,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,i.length===0&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;const t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();const i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&(e=this.getVerticesData(O.PositionKind),!e))return;this._extend=mT(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){const t=this._meshes.length;for(const i in this._vertexBuffers)t===1&&this._vertexBuffers[i].create(),i===O.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());t===1&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(const t of this._meshes)t._markSubMeshesAsAttributesDirty()}load(e,t){if(this.delayLoadState!==2){if(this.isReady()){t&&t();return}this.delayLoadState=2,this._queueLoad(e,t)}}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);const r=this._meshes,s=r.length;for(let n=0;n<s;n++)this._applyToMesh(r[n]);t&&t()},void 0,!0))}toLeftHanded(){const e=this.getIndices(!1);if(e!=null&&e.length>0){for(let r=0;r<e.length;r+=3){const s=e[r+0];e[r+0]=e[r+2],e[r+2]=s}this.setIndices(e)}const t=this.getVerticesData(O.PositionKind,!1);if(t!=null&&t.length>0){for(let r=0;r<t.length;r+=3)t[r+2]=-t[r+2];this.setVerticesData(O.PositionKind,t,!1)}const i=this.getVerticesData(O.NormalKind,!1);if(i!=null&&i.length>0){for(let r=0;r<i.length;r+=3)i[r+2]=-i[r+2];this.setVerticesData(O.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;const e=this.getVerticesData(O.PositionKind);if(!e||e.length===0)return!1;for(let t=this._positionsCache.length*3,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=x.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(const i in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[i]);this._vertexArrayObjects={};const e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject()}}dispose(){const e=this._meshes,t=e.length;let i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(const r in this._vertexBuffers)this._vertexBuffers[r].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){const r=this._parentContainer.geometries.indexOf(this);r>-1&&this._parentContainer.geometries.splice(r,1),this._parentContainer=null}this._isDisposed=!0}copy(e){const t=new Oe;t.indices=[];const i=this.getIndices();if(i)for(let l=0;l<i.length;l++)t.indices.push(i[l]);let r=!1,s=!1,n;for(n in this._vertexBuffers){const l=this.getVerticesData(n);if(l&&(l instanceof Float32Array?t.set(new Float32Array(l),n):t.set(l.slice(0),n),!s)){const c=this.getVertexBuffer(n);c&&(r=c.isUpdatable(),s=!r)}}const a=new Bs(e,this._scene,t,r);a.delayLoadState=this.delayLoadState,a.delayLoadingFile=this.delayLoadingFile,a._delayLoadingFunction=this._delayLoadingFunction;for(n in this._delayInfo)a._delayInfo=a._delayInfo||[],a._delayInfo.push(n);return a._boundingInfo=new Qn(this._extend.minimum,this._extend.maximum),a}serialize(){const e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,qt&&qt.HasTags(this)&&(e.tags=qt.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(const e in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){const e=this.serialize();return this.isVerticesDataPresent(O.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(O.PositionKind)),this.isVertexBufferUpdatable(O.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(O.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(O.NormalKind)),this.isVertexBufferUpdatable(O.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(O.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(O.TangentKind)),this.isVertexBufferUpdatable(O.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(O.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(O.UVKind)),this.isVertexBufferUpdatable(O.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(O.UV2Kind)&&(e.uv2s=this._toNumberArray(this.getVerticesData(O.UV2Kind)),this.isVertexBufferUpdatable(O.UV2Kind)&&(e.uv2s._updatable=!0)),this.isVerticesDataPresent(O.UV3Kind)&&(e.uv3s=this._toNumberArray(this.getVerticesData(O.UV3Kind)),this.isVertexBufferUpdatable(O.UV3Kind)&&(e.uv3s._updatable=!0)),this.isVerticesDataPresent(O.UV4Kind)&&(e.uv4s=this._toNumberArray(this.getVerticesData(O.UV4Kind)),this.isVertexBufferUpdatable(O.UV4Kind)&&(e.uv4s._updatable=!0)),this.isVerticesDataPresent(O.UV5Kind)&&(e.uv5s=this._toNumberArray(this.getVerticesData(O.UV5Kind)),this.isVertexBufferUpdatable(O.UV5Kind)&&(e.uv5s._updatable=!0)),this.isVerticesDataPresent(O.UV6Kind)&&(e.uv6s=this._toNumberArray(this.getVerticesData(O.UV6Kind)),this.isVertexBufferUpdatable(O.UV6Kind)&&(e.uv6s._updatable=!0)),this.isVerticesDataPresent(O.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(O.ColorKind)),this.isVertexBufferUpdatable(O.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(O.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(O.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(O.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(O.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(O.MatricesWeightsKind)),this.isVertexBufferUpdatable(O.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){const i=e._geometry;return i?i.copy(t):null}static RandomId(){return J.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){const i=t.getScene(),r=e.geometryUniqueId,s=e.geometryId;if(r||s){const n=r?this._GetGeometryByLoadedUniqueId(r,i):i.getGeometryById(s);n&&n.applyToMesh(t)}else if(e instanceof ArrayBuffer){const n=t._binaryInfo;if(n.positionsAttrDesc&&n.positionsAttrDesc.count>0){const a=new Float32Array(e,n.positionsAttrDesc.offset,n.positionsAttrDesc.count);t.setVerticesData(O.PositionKind,a,!1)}if(n.normalsAttrDesc&&n.normalsAttrDesc.count>0){const a=new Float32Array(e,n.normalsAttrDesc.offset,n.normalsAttrDesc.count);t.setVerticesData(O.NormalKind,a,!1)}if(n.tangetsAttrDesc&&n.tangetsAttrDesc.count>0){const a=new Float32Array(e,n.tangetsAttrDesc.offset,n.tangetsAttrDesc.count);t.setVerticesData(O.TangentKind,a,!1)}if(n.uvsAttrDesc&&n.uvsAttrDesc.count>0){const a=new Float32Array(e,n.uvsAttrDesc.offset,n.uvsAttrDesc.count);if(Yt.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(O.UVKind,a,!1)}if(n.uvs2AttrDesc&&n.uvs2AttrDesc.count>0){const a=new Float32Array(e,n.uvs2AttrDesc.offset,n.uvs2AttrDesc.count);if(Yt.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(O.UV2Kind,a,!1)}if(n.uvs3AttrDesc&&n.uvs3AttrDesc.count>0){const a=new Float32Array(e,n.uvs3AttrDesc.offset,n.uvs3AttrDesc.count);if(Yt.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(O.UV3Kind,a,!1)}if(n.uvs4AttrDesc&&n.uvs4AttrDesc.count>0){const a=new Float32Array(e,n.uvs4AttrDesc.offset,n.uvs4AttrDesc.count);if(Yt.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(O.UV4Kind,a,!1)}if(n.uvs5AttrDesc&&n.uvs5AttrDesc.count>0){const a=new Float32Array(e,n.uvs5AttrDesc.offset,n.uvs5AttrDesc.count);if(Yt.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(O.UV5Kind,a,!1)}if(n.uvs6AttrDesc&&n.uvs6AttrDesc.count>0){const a=new Float32Array(e,n.uvs6AttrDesc.offset,n.uvs6AttrDesc.count);if(Yt.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(O.UV6Kind,a,!1)}if(n.colorsAttrDesc&&n.colorsAttrDesc.count>0){const a=new Float32Array(e,n.colorsAttrDesc.offset,n.colorsAttrDesc.count);t.setVerticesData(O.ColorKind,a,!1,n.colorsAttrDesc.stride)}if(n.matricesIndicesAttrDesc&&n.matricesIndicesAttrDesc.count>0){const a=new Int32Array(e,n.matricesIndicesAttrDesc.offset,n.matricesIndicesAttrDesc.count),l=[];for(let c=0;c<a.length;c++){const h=a[c];l.push(h&255),l.push((h&65280)>>8),l.push((h&16711680)>>16),l.push(h>>24&255)}t.setVerticesData(O.MatricesIndicesKind,l,!1)}if(n.matricesIndicesExtraAttrDesc&&n.matricesIndicesExtraAttrDesc.count>0){const a=new Int32Array(e,n.matricesIndicesExtraAttrDesc.offset,n.matricesIndicesExtraAttrDesc.count),l=[];for(let c=0;c<a.length;c++){const h=a[c];l.push(h&255),l.push((h&65280)>>8),l.push((h&16711680)>>16),l.push(h>>24&255)}t.setVerticesData(O.MatricesIndicesExtraKind,l,!1)}if(n.matricesWeightsAttrDesc&&n.matricesWeightsAttrDesc.count>0){const a=new Float32Array(e,n.matricesWeightsAttrDesc.offset,n.matricesWeightsAttrDesc.count);t.setVerticesData(O.MatricesWeightsKind,a,!1)}if(n.indicesAttrDesc&&n.indicesAttrDesc.count>0){const a=new Int32Array(e,n.indicesAttrDesc.offset,n.indicesAttrDesc.count);t.setIndices(a,null)}if(n.subMeshesAttrDesc&&n.subMeshesAttrDesc.count>0){const a=new Int32Array(e,n.subMeshesAttrDesc.offset,n.subMeshesAttrDesc.count*5);t.subMeshes=[];for(let l=0;l<n.subMeshesAttrDesc.count;l++){const c=a[l*5+0],h=a[l*5+1],u=a[l*5+2],d=a[l*5+3],f=a[l*5+4];qs.AddToMesh(c,h,u,d,f,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(O.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(O.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(O.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(O.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(O.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(O.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(O.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(O.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(O.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(O.ColorKind,Ye.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(O.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{const n=[];for(let a=0;a<e.matricesIndices.length;a++){const l=e.matricesIndices[a];n.push(l&255),n.push((l&65280)>>8),n.push((l&16711680)>>16),n.push(l>>24&255)}t.setVerticesData(O.MatricesIndicesKind,n,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(O.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{const n=[];for(let a=0;a<e.matricesIndicesExtra.length;a++){const l=e.matricesIndicesExtra[a];n.push(l&255),n.push((l&65280)>>8),n.push((l&16711680)>>16),n.push(l>>24&255)}t.setVerticesData(O.MatricesIndicesExtraKind,n,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(Bs._CleanMatricesWeights(e,t),t.setVerticesData(O.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(O.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let n=0;n<e.subMeshes.length;n++){const a=e.subMeshes[n];qs.AddToMesh(a.materialIndex,a.verticesStart,a.verticesCount,a.indexStart,a.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){if(!Wr.CleanBoneMatrixWeights)return;let r=0;if(e.skeletonId>-1){const u=t.getScene().getLastSkeletonById(e.skeletonId);if(!u)return;r=u.bones.length}else return;const s=t.getVerticesData(O.MatricesIndicesKind),n=t.getVerticesData(O.MatricesIndicesExtraKind),a=e.matricesWeights,l=e.matricesWeightsExtra,c=e.numBoneInfluencer,h=a.length;for(let u=0;u<h;u+=4){let d=0,f=-1;for(let _=0;_<4;_++){const p=a[u+_];d+=p,p<.001&&f<0&&(f=_)}if(l)for(let _=0;_<4;_++){const p=l[u+_];d+=p,p<.001&&f<0&&(f=_+4)}if((f<0||f>c-1)&&(f=c-1),d>.001){const _=1/d;for(let p=0;p<4;p++)a[u+p]*=_;if(l)for(let p=0;p<4;p++)l[u+p]*=_}else f>=4?(l[u+f-4]=1-d,n[u+f-4]=r):(a[u+f]=1-d,s[u+f]=r)}t.setVerticesData(O.MatricesIndicesKind,s),e.matricesWeightsExtra&&t.setVerticesData(O.MatricesIndicesExtraKind,n)}static Parse(e,t,i){const r=new Bs(e.id,t,void 0,e.updatable);return r._loadedUniqueId=e.uniqueId,qt&&qt.AddTagsTo(r,e.tags),e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=i+e.delayLoadingFile,r._boundingInfo=new Qn(x.FromArray(e.boundingBoxMinimum),x.FromArray(e.boundingBoxMaximum)),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(O.UVKind),e.hasUVs2&&r._delayInfo.push(O.UV2Kind),e.hasUVs3&&r._delayInfo.push(O.UV3Kind),e.hasUVs4&&r._delayInfo.push(O.UV4Kind),e.hasUVs5&&r._delayInfo.push(O.UV5Kind),e.hasUVs6&&r._delayInfo.push(O.UV6Kind),e.hasColors&&r._delayInfo.push(O.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(O.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(O.MatricesWeightsKind),r._delayLoadingFunction=Oe.ImportVertexData):Oe.ImportVertexData(e,r),t.pushGeometry(r,!0),r}}class bS{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new SS(e)}sampleFrame(e=Us.Now){if(this._enabled){if(this._lastFrameTimeMs!=null){const t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return e===0?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class SS{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){const i=this._samples[this._pos];t=i-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(i-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const t=this._samples.length;return(e%t+t)%t}}ze.prototype.setAlphaConstants=function(o,e,t,i){this._alphaState.setAlphaBlendConstants(o,e,t,i)};ze.prototype.setAlphaMode=function(o,e=!1){if(this._alphaMode===o){if(!e){const t=o===0;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}return}switch(o){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break}e||(this.depthCullingState.depthMask=o===0),this._alphaMode=o};ze.prototype.getAlphaMode=function(){return this._alphaMode};ze.prototype.setAlphaEquation=function(o){if(this._alphaEquation!==o){switch(o){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774);break}this._alphaEquation=o}};ze.prototype.getAlphaEquation=function(){return this._alphaEquation};function W_(o,e,t=!1,i){switch(o){case 3:{const s=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);return i&&s.set(new Int8Array(i)),s}case 0:{const s=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&s.set(new Uint8Array(i)),s}case 4:{const s=e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);return i&&s.set(new Int16Array(i)),s}case 5:case 8:case 9:case 10:case 2:{const s=e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);return i&&s.set(new Uint16Array(i)),s}case 6:{const s=e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);return i&&s.set(new Int32Array(i)),s}case 7:case 11:case 12:case 13:case 14:case 15:{const s=e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);return i&&s.set(new Uint32Array(i)),s}case 1:{const s=e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e);return i&&s.set(new Float32Array(i)),s}}const r=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&r.set(new Uint8Array(i)),r}ze.prototype._readTexturePixelsSync=function(o,e,t,i=-1,r=0,s=null,n=!0,a=!1,l=0,c=0){var h,u;const d=this._gl;if(!d)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const _=d.createFramebuffer();if(!_)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=_}d.bindFramebuffer(d.FRAMEBUFFER,this._dummyFramebuffer),i>-1?d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_CUBE_MAP_POSITIVE_X+i,(h=o._hardwareTexture)===null||h===void 0?void 0:h.underlyingResource,r):d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,(u=o._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,r);let f=o.type!==void 0?this._getWebGLTextureType(o.type):d.UNSIGNED_BYTE;if(a)s||(s=W_(o.type,4*e*t));else switch(f){case d.UNSIGNED_BYTE:s||(s=new Uint8Array(4*e*t)),f=d.UNSIGNED_BYTE;break;default:s||(s=new Float32Array(4*e*t)),f=d.FLOAT;break}return n&&this.flushFramebuffer(),d.readPixels(l,c,e,t,d.RGBA,f,s),d.bindFramebuffer(d.FRAMEBUFFER,this._currentFramebuffer),s};ze.prototype._readTexturePixels=function(o,e,t,i=-1,r=0,s=null,n=!0,a=!1,l=0,c=0){return Promise.resolve(this._readTexturePixelsSync(o,e,t,i,r,s,n,a,l,c))};ze.prototype.updateDynamicIndexBuffer=function(o,e,t=0){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(o);let i;o.is32Bits?i=e instanceof Uint32Array?e:new Uint32Array(e):i=e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};ze.prototype.updateDynamicVertexBuffer=function(o,e,t,i){this.bindArrayBuffer(o),t===void 0&&(t=0);const r=e.byteLength||e.length;i===void 0||i>=r&&t===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(e).subarray(t,t+i)):(e instanceof ArrayBuffer?e=new Uint8Array(e,t,i):e=new Uint8Array(e.buffer,e.byteOffset+t,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)),this._resetVertexBufferBinding()};class q extends ze{static get NpmPackage(){return ze.NpmPackage}static get Version(){return ze.Version}static get Instances(){return qe.Instances}static get LastCreatedEngine(){return qe.LastCreatedEngine}static get LastCreatedScene(){return qe.LastCreatedScene}_createImageBitmapFromSource(e,t){return new Promise((r,s)=>{const n=new Image;n.onload=()=>{n.decode().then(()=>{this.createImageBitmap(n,t).then(a=>{r(a)})})},n.onerror=()=>{s(`Error loading image ${n.src}`)},n.src=e})}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,i){const s=this.createCanvas(t,i).getContext("2d");if(!s)throw new Error("Unable to get 2d context for resizeImageBitmap");return s.drawImage(e,0,0),s.getImageData(0,0,t,i).data}static MarkAllMaterialsAsDirty(e,t){for(let i=0;i<q.Instances.length;i++){const r=q.Instances[i];for(let s=0;s<r.scenes.length;s++)r.scenes[s].markAllMaterialsAsDirty(e,t)}}static DefaultLoadingScreenFactory(e){throw pt("LoadingScreen")}get _supportsHardwareTextureRescaling(){return!!q._RescalePostProcessFactory}get performanceMonitor(){return this._performanceMonitor}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}getInputElement(){return this._renderingCanvas}constructor(e,t,i,r=!1){if(super(e,t,i,r),this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.scenes=new Array,this._virtualScenes=new Array,this.onNewSceneAddedObservable=new Q,this.postProcesses=new Array,this.isPointerLock=!1,this.onResizeObservable=new Q,this.onCanvasBlurObservable=new Q,this.onCanvasFocusObservable=new Q,this.onCanvasPointerOutObservable=new Q,this.onBeginFrameObservable=new Q,this.customAnimationFrameRequester=null,this.onEndFrameObservable=new Q,this.onBeforeShaderCompilationObservable=new Q,this.onAfterShaderCompilationObservable=new Q,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this._fps=60,this._deltaTime=0,this._drawCalls=new ya,this.canvasTabIndex=1,this.disablePerformanceMonitorInBackground=!1,this._performanceMonitor=new bS,this._compatibilityMode=!0,this.currentRenderPassId=0,this._renderPassNames=["main"],q.Instances.push(this),!!e){if(this._features.supportRenderPasses=!0,i=this._creationOptions,e.getContext){const s=e;this._sharedInit(s),this._connectVREvents()}this._prepareVRComponent(),i.autoEnableWebVR&&this.initWebVR()}}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),this._onCanvasFocus=()=>{this.onCanvasFocusObservable.notifyObservers(this)},this._onCanvasBlur=()=>{this.onCanvasBlurObservable.notifyObservers(this)},this._onCanvasContextMenu=i=>{this.disableContextMenu&&i.preventDefault()},e.addEventListener("focus",this._onCanvasFocus),e.addEventListener("blur",this._onCanvasBlur),e.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.disable(),this._windowIsBackground=!0},this._onFocus=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.enable(),this._windowIsBackground=!1},this._onCanvasPointerOut=i=>{document.elementFromPoint(i.clientX,i.clientY)!==e&&this.onCanvasPointerOutObservable.notifyObservers(i)};const t=this.getHostWindow();t&&typeof t.addEventListener=="function"&&(t.addEventListener("blur",this._onBlur),t.addEventListener("focus",this._onFocus)),e.addEventListener("pointerout",this._onCanvasPointerOut),this._creationOptions.doNotHandleTouchAction||this._disableTouchAction(),!q.audioEngine&&this._creationOptions.audioEngine&&q.AudioEngineFactory&&(q.audioEngine=q.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination())),fu()&&(this._onFullscreenChange=()=>{this.isFullscreen=!!document.fullscreenElement,this.isFullscreen&&this._pointerLockRequested&&e&&q._RequestPointerlock(e)},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=()=>{this.isPointerLock=document.pointerLockElement===e},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1)),this.enableOfflineSupport=q.OfflineProviderFactory!==void 0,this._deterministicLockstep=!!this._creationOptions.deterministicLockstep,this._lockstepMaxSteps=this._creationOptions.lockstepMaxSteps||0,this._timeStep=this._creationOptions.timeStep||1/60}getAspectRatio(e,t=!1){const i=e.viewport;return this.getRenderWidth(t)*i.width/(this.getRenderHeight(t)*i.height)}getScreenAspectRatio(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)}getRenderingCanvasClientRect(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null}getInputElementClientRect(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return this._timeStep*1e3}generateMipMapsForCubemap(e,t=!0){if(e.generateMipMaps){const i=this._gl;this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,e,!0),i.generateMipmap(i.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)}}getDepthWrite(){return this._depthCullingState.depthMask}setDepthWrite(e){this._depthCullingState.depthMask=e}getStencilBuffer(){return this._stencilState.stencilTest}setStencilBuffer(e){this._stencilState.stencilTest=e}getStencilMask(){return this._stencilState.stencilMask}setStencilMask(e){this._stencilState.stencilMask=e}getStencilFunction(){return this._stencilState.stencilFunc}getStencilFunctionReference(){return this._stencilState.stencilFuncRef}getStencilFunctionMask(){return this._stencilState.stencilFuncMask}setStencilFunction(e){this._stencilState.stencilFunc=e}setStencilFunctionReference(e){this._stencilState.stencilFuncRef=e}setStencilFunctionMask(e){this._stencilState.stencilFuncMask=e}getStencilOperationFail(){return this._stencilState.stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilState.stencilOpDepthFail}getStencilOperationPass(){return this._stencilState.stencilOpStencilDepthPass}setStencilOperationFail(e){this._stencilState.stencilOpStencilFail=e}setStencilOperationDepthFail(e){this._stencilState.stencilOpDepthFail=e}setStencilOperationPass(e){this._stencilState.stencilOpStencilDepthPass=e}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}getDepthFunction(){return this._depthCullingState.depthFunc}setDepthFunction(e){this._depthCullingState.depthFunc=e}setDepthFunctionToGreater(){this.setDepthFunction(516)}setDepthFunctionToGreaterOrEqual(){this.setDepthFunction(518)}setDepthFunctionToLess(){this.setDepthFunction(513)}setDepthFunctionToLessOrEqual(){this.setDepthFunction(515)}cacheStencilState(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()}restoreStencilState(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}setDirectViewport(e,t,i,r){const s=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,r),s}scissorClear(e,t,i,r,s){this.enableScissor(e,t,i,r),this.clear(s,!0,!0,!0),this.disableScissor()}enableScissor(e,t,i,r){const s=this._gl;s.enable(s.SCISSOR_TEST),s.scissor(e,t,i,r)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}_reportDrawCall(e=1){this._drawCalls.addCount(e,!1)}initWebVR(){throw pt("WebVRCamera")}_prepareVRComponent(){}_connectVREvents(e,t){}_submitVRFrame(){}disableVR(){}isVRPresenting(){return!1}_requestVRFrame(){}_loadFileAsync(e,t,i){return new Promise((r,s)=>{this._loadFile(e,n=>{r(n)},void 0,t,i,(n,a)=>{s(a)})})}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}setDepthStencilTexture(e,t,i,r){e!==void 0&&(t&&(this._boundUniforms[e]=t),!i||!i.depthStencilTexture?this._setTexture(e,null,void 0,void 0,r):this._setTexture(e,i,!1,!0,r))}setTextureFromPostProcess(e,t,i){var r;let s=null;t&&(t._textures.data[t._currentRenderTextureInd]?s=t._textures.data[t._currentRenderTextureInd]:t._forcedOutputTexture&&(s=t._forcedOutputTexture)),this._bindTexture(e,(r=s==null?void 0:s.texture)!==null&&r!==void 0?r:null,i)}setTextureFromPostProcessOutput(e,t,i){var r,s;this._bindTexture(e,(s=(r=t==null?void 0:t._outputTexture)===null||r===void 0?void 0:r.texture)!==null&&s!==void 0?s:null,i)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();super._rebuildBuffers()}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){const t=this._activeRenderLoops[e];t()}}_renderLoop(){if(!this._contextWasLost){let e=!0;!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}_renderViews(){return!1}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&q._RequestFullscreen(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&q._ExitFullscreen()}enterPointerlock(){this._renderingCanvas&&q._RequestPointerlock(this._renderingCanvas)}exitPointerlock(){q._ExitPointerlock()}beginFrame(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),super.beginFrame()}endFrame(){super.endFrame(),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)}resize(e=!1){this.isVRPresenting()||super.resize(e)}setSize(e,t,i=!1){if(!this._renderingCanvas||!super.setSize(e,t,i))return!1;if(this.scenes){for(let r=0;r<this.scenes.length;r++){const s=this.scenes[r];for(let n=0;n<s.cameras.length;n++){const a=s.cameras[n];a._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,i,r,s,n=null){s=s||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const a=super.createShaderProgram(e,t,i,r,s,n);return this.onAfterShaderCompilationObservable.notifyObservers(this),a}_createShaderProgram(e,t,i,r,s=null){const n=r.createProgram();if(e.program=n,!n)throw new Error("Unable to create program");if(r.attachShader(n,t),r.attachShader(n,i),this.webGLVersion>1&&s){const a=this.createTransformFeedback();this.bindTransformFeedback(a),this.setTranformFeedbackVaryings(n,s),e.transformFeedback=a}return r.linkProgram(n),this.webGLVersion>1&&s&&this.bindTransformFeedback(null),e.context=r,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),n}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach(t=>{t.postProcesses.forEach(i=>{i._outputTexture===e&&(i._outputTexture=null)}),t.cameras.forEach(i=>{i._postProcesses.forEach(r=>{r&&r._outputTexture===e&&(r._outputTexture=null)})})})}getRenderPassNames(){return this._renderPassNames}getCurrentRenderPassName(){return this._renderPassNames[this.currentRenderPassId]}createRenderPassId(e){const t=++q._RenderPassIdCounter;return this._renderPassNames[t]=e??"NONAME",t}releaseRenderPassId(e){this._renderPassNames[e]=void 0;for(let t=0;t<this.scenes.length;++t){const i=this.scenes[t];for(let r=0;r<i.meshes.length;++r){const s=i.meshes[r];if(s.subMeshes)for(let n=0;n<s.subMeshes.length;++n)s.subMeshes[n]._removeDrawWrapper(e)}}}_rescaleTexture(e,t,i,r,s){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const n=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&q._RescalePostProcessFactory&&(this._rescalePostProcess=q._RescalePostProcessFactory(this)),this._rescalePostProcess&&(this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled(()=>{this._rescalePostProcess.onApply=function(l){l._bindTexture("textureSampler",e)};let a=i;a||(a=this.scenes[this.scenes.length-1]),a.postProcessManager.directRender([this._rescalePostProcess],n,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,r,0,0,t.width,t.height,0),this.unBindFramebuffer(n),n.dispose(),s&&s()}))}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}wrapWebGLTexture(e){const t=new hf(e,this._gl),i=new hi(this,bt.Unknown,!0);return i._hardwareTexture=t,i.isReady=!0,i}_uploadImageToTexture(e,t,i=0,r=0){const s=this._gl,n=this._getWebGLTextureType(e.type),a=this._getInternalFormat(e.format),l=this._getRGBABufferInternalSizedFormat(e.type,a),c=e.isCube?s.TEXTURE_CUBE_MAP:s.TEXTURE_2D;this._bindTextureDirectly(c,e,!0),this._unpackFlipY(e.invertY);let h=s.TEXTURE_2D;e.isCube&&(h=s.TEXTURE_CUBE_MAP_POSITIVE_X+i),s.texImage2D(h,r,l,a,n,t),this._bindTextureDirectly(c,null,!0)}updateTextureComparisonFunction(e,t){if(this.webGLVersion===1){X.Error("WebGL 1 does not support texture comparison.");return}const i=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),t===0?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),t===0?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const i=new _u(t);return i.capacity=e,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),i.references=1,i}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,t=0,i=10){const r=this._gl;return new Promise((s,n)=>{const a=()=>{const l=r.clientWaitSync(e,t,0);if(l==r.WAIT_FAILED){n();return}if(l==r.TIMEOUT_EXPIRED){setTimeout(a,i);return}s()};a()})}_readPixelsAsync(e,t,i,r,s,n,a){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const l=this._gl,c=l.createBuffer();l.bindBuffer(l.PIXEL_PACK_BUFFER,c),l.bufferData(l.PIXEL_PACK_BUFFER,a.byteLength,l.STREAM_READ),l.readPixels(e,t,i,r,s,n,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null);const h=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);return h?(l.flush(),this._clientWaitAsync(h,0,10).then(()=>(l.deleteSync(h),l.bindBuffer(l.PIXEL_PACK_BUFFER,c),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,a),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(c),a))):null}dispose(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();q.Instances.length===1&&q.audioEngine&&(q.audioEngine.dispose(),q.audioEngine=null),this.disableVR();const e=this.getHostWindow();e&&typeof e.removeEventListener=="function"&&(e.removeEventListener("blur",this._onBlur),e.removeEventListener("focus",this._onFocus)),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),fu()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)),super.dispose();const t=q.Instances.indexOf(this);t>=0&&q.Instances.splice(t,1),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}_disableTouchAction(){!this._renderingCanvas||!this._renderingCanvas.setAttribute||(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")}displayLoadingUI(){if(!Ar())return;const e=this.loadingScreen;e&&e.displayLoadingUI()}hideLoadingUI(){if(!Ar())return;const e=this._loadingScreen;e&&e.hideLoadingUI()}get loadingScreen(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=q.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen}set loadingScreen(e){this._loadingScreen=e}set loadingUIText(e){this.loadingScreen.loadingUIText=e}set loadingUIBackgroundColor(e){this.loadingScreen.loadingUIBackgroundColor=e}createVideoElement(e){return document.createElement("video")}static _RequestPointerlock(e){if(e.requestPointerLock){const t=e.requestPointerLock();t instanceof Promise?t.then(()=>{e.focus()}).catch(()=>{}):e.focus()}}static _ExitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}static _RequestFullscreen(e){const t=e.requestFullscreen||e.webkitRequestFullscreen;t&&t.call(e)}static _ExitFullscreen(){const e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen()}getFontOffset(e){const t=document.createElement("span");t.innerHTML="Hg",t.setAttribute("style",`font: ${e} !important`);const i=document.createElement("div");i.style.display="inline-block",i.style.width="1px",i.style.height="0px",i.style.verticalAlign="bottom";const r=document.createElement("div");r.style.whiteSpace="nowrap",r.appendChild(t),r.appendChild(i),document.body.appendChild(r);let s=0,n=0;try{n=i.getBoundingClientRect().top-t.getBoundingClientRect().top,i.style.verticalAlign="baseline",s=i.getBoundingClientRect().top-t.getBoundingClientRect().top}finally{document.body.removeChild(r)}return{ascent:s,height:n,descent:n-s}}}q.ALPHA_DISABLE=0;q.ALPHA_ADD=1;q.ALPHA_COMBINE=2;q.ALPHA_SUBTRACT=3;q.ALPHA_MULTIPLY=4;q.ALPHA_MAXIMIZED=5;q.ALPHA_ONEONE=6;q.ALPHA_PREMULTIPLIED=7;q.ALPHA_PREMULTIPLIED_PORTERDUFF=8;q.ALPHA_INTERPOLATE=9;q.ALPHA_SCREENMODE=10;q.DELAYLOADSTATE_NONE=0;q.DELAYLOADSTATE_LOADED=1;q.DELAYLOADSTATE_LOADING=2;q.DELAYLOADSTATE_NOTLOADED=4;q.NEVER=512;q.ALWAYS=519;q.LESS=513;q.EQUAL=514;q.LEQUAL=515;q.GREATER=516;q.GEQUAL=518;q.NOTEQUAL=517;q.KEEP=7680;q.REPLACE=7681;q.INCR=7682;q.DECR=7683;q.INVERT=5386;q.INCR_WRAP=34055;q.DECR_WRAP=34056;q.TEXTURE_CLAMP_ADDRESSMODE=0;q.TEXTURE_WRAP_ADDRESSMODE=1;q.TEXTURE_MIRROR_ADDRESSMODE=2;q.TEXTUREFORMAT_ALPHA=0;q.TEXTUREFORMAT_LUMINANCE=1;q.TEXTUREFORMAT_LUMINANCE_ALPHA=2;q.TEXTUREFORMAT_RGB=4;q.TEXTUREFORMAT_RGBA=5;q.TEXTUREFORMAT_RED=6;q.TEXTUREFORMAT_R=6;q.TEXTUREFORMAT_RG=7;q.TEXTUREFORMAT_RED_INTEGER=8;q.TEXTUREFORMAT_R_INTEGER=8;q.TEXTUREFORMAT_RG_INTEGER=9;q.TEXTUREFORMAT_RGB_INTEGER=10;q.TEXTUREFORMAT_RGBA_INTEGER=11;q.TEXTURETYPE_UNSIGNED_BYTE=0;q.TEXTURETYPE_UNSIGNED_INT=0;q.TEXTURETYPE_FLOAT=1;q.TEXTURETYPE_HALF_FLOAT=2;q.TEXTURETYPE_BYTE=3;q.TEXTURETYPE_SHORT=4;q.TEXTURETYPE_UNSIGNED_SHORT=5;q.TEXTURETYPE_INT=6;q.TEXTURETYPE_UNSIGNED_INTEGER=7;q.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;q.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;q.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;q.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;q.TEXTURETYPE_UNSIGNED_INT_24_8=12;q.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;q.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;q.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;q.TEXTURE_NEAREST_SAMPLINGMODE=1;q.TEXTURE_BILINEAR_SAMPLINGMODE=2;q.TEXTURE_TRILINEAR_SAMPLINGMODE=3;q.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;q.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;q.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;q.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;q.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;q.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;q.TEXTURE_NEAREST_LINEAR=7;q.TEXTURE_NEAREST_NEAREST=1;q.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;q.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;q.TEXTURE_LINEAR_LINEAR=2;q.TEXTURE_LINEAR_NEAREST=12;q.TEXTURE_EXPLICIT_MODE=0;q.TEXTURE_SPHERICAL_MODE=1;q.TEXTURE_PLANAR_MODE=2;q.TEXTURE_CUBIC_MODE=3;q.TEXTURE_PROJECTION_MODE=4;q.TEXTURE_SKYBOX_MODE=5;q.TEXTURE_INVCUBIC_MODE=6;q.TEXTURE_EQUIRECTANGULAR_MODE=7;q.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;q.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;q.SCALEMODE_FLOOR=1;q.SCALEMODE_NEAREST=2;q.SCALEMODE_CEILING=3;q._RescalePostProcessFactory=null;q._RenderPassIdCounter=0;class gt extends ii{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=(this._billboardMode&gt.BILLBOARDMODE_USE_POSITION)!==0,this._computeUseBillboardPath())}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e,this._computeUseBillboardPath())}_computeUseBillboardPath(){this._cache.useBillboardPath=this._billboardMode!==gt.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,t=null,i=!0){super(e,t),this._forward=new x(0,0,1),this._up=new x(0,1,0),this._right=new x(1,0,0),this._position=x.Zero(),this._rotation=x.Zero(),this._rotationQuaternion=null,this._scaling=x.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=gt.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=H.Zero(),this._usePivotMatrix=!1,this._absolutePosition=x.Zero(),this._absoluteScaling=x.Zero(),this._absoluteRotationQuaternion=oe.Identity(),this._pivotMatrix=H.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new Q,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._isDirty=!0}isUsingPivotMatrix(){return this._usePivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._isDirty=!0}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._isDirty=!0}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._isDirty=!0}get forward(){return x.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return x.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return x.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=H.Identity()),this._poseMatrix}_isSynchronized(){const e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==gt.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();const e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1,e.useBillboardPath=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=H.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){const r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);r&&i&&i(this,r);for(const s of this.getChildTransformNodes(!0))s.instantiateHierarchy(r,t,i);return r}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||oe.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,r;if(e.x===void 0){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],r=arguments[2]}else t=e.x,i=e.y,r=e.z;if(this.parent){const s=j.Matrix[0];this.parent.getWorldMatrix().invertToRef(s),x.TransformCoordinatesFromFloatsToRef(t,i,r,s,this.position)}else this.position.x=t,this.position.y=i,this.position.z=r;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=x.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const e=j.Matrix[0];return this._localMatrix.invertToRef(e),x.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=x.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,r=0,s=Kt.LOCAL){const n=gt._LookAtVectorCache,a=s===Kt.LOCAL?this.position:this.getAbsolutePosition();if(e.subtractToRef(a,n),this.setDirection(n,t,i,r),s===Kt.WORLD&&this.parent)if(this.rotationQuaternion){const l=j.Matrix[0];this.rotationQuaternion.toRotationMatrix(l);const c=j.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(c),c.invert(),l.multiplyToRef(c,l),this.rotationQuaternion.fromRotationMatrix(l)}else{const l=j.Quaternion[0];oe.FromEulerVectorToRef(this.rotation,l);const c=j.Matrix[0];l.toRotationMatrix(c);const h=j.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(h),h.invert(),c.multiplyToRef(h,c),l.fromRotationMatrix(c),l.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){const t=x.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return x.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,r=0){const s=-Math.atan2(e.z,e.x)+Math.PI/2,n=Math.sqrt(e.x*e.x+e.z*e.z),a=-Math.atan2(e.y,n);return this.rotationQuaternion?oe.RotationYawPitchRollToRef(s+t,a+i,r,this.rotationQuaternion):(this.rotation.x=a+i,this.rotation.y=s+t,this.rotation.z=r),this}setPivotPoint(e,t=Kt.LOCAL){this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);const i=this.getWorldMatrix();if(t==Kt.WORLD){const r=j.Matrix[0];i.invertToRef(r),e=x.TransformCoordinates(e,r)}return this.setPivotMatrix(H.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){const e=x.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){const e=x.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),x.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(const t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;const r=j.Quaternion[0],s=j.Vector3[0],n=j.Vector3[1],a=j.Matrix[1];H.IdentityToRef(a);const l=j.Matrix[0];this.computeWorldMatrix(!0);let c=this.rotationQuaternion;return c||(c=gt._TmpRotation,oe.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,c)),H.ComposeToRef(this.scaling,c,this.position,l),this.parent&&l.multiplyToRef(this.parent.computeWorldMatrix(!0),l),e&&(e.computeWorldMatrix(!0).invertToRef(a),l.multiplyToRef(a,l)),l.decompose(n,r,s,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(r):r.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(n),this.position.copyFrom(s),this.parent=e,i&&this.setPivotMatrix(H.Identity()),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling===e?!1:(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(),e.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,e?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));let r;if(!i||i===Kt.LOCAL)r=oe.RotationAxisToRef(e,t,gt._RotationAxisCache),this.rotationQuaternion.multiplyToRef(r,this.rotationQuaternion);else{if(this.parent){const s=j.Matrix[0];this.parent.getWorldMatrix().invertToRef(s),e=x.TransformNormal(e,s)}r=oe.RotationAxisToRef(e,t,gt._RotationAxisCache),r.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=oe.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const r=j.Vector3[0],s=j.Vector3[1],n=j.Vector3[2],a=j.Quaternion[0],l=j.Matrix[0],c=j.Matrix[1],h=j.Matrix[2],u=j.Matrix[3];return e.subtractToRef(this.position,r),H.TranslationToRef(r.x,r.y,r.z,l),H.TranslationToRef(-r.x,-r.y,-r.z,c),H.RotationAxisToRef(t,i,h),c.multiplyToRef(h,u),u.multiplyToRef(l,u),u.decompose(s,a,n),this.position.addInPlace(n),a.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){const r=e.scale(t);if(!i||i===Kt.LOCAL){const s=this.getPositionExpressedInLocalSpace().add(r);this.setPositionWithLocalVector(s)}else this.setAbsolutePosition(this.getAbsolutePosition().add(r));return this}addRotation(e,t,i){let r;this.rotationQuaternion?r=this.rotationQuaternion:(r=j.Quaternion[1],oe.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,r));const s=j.Quaternion[0];return oe.RotationYawPitchRollToRef(t,e,i,s),r.multiplyInPlace(s),this.rotationQuaternion||r.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==gt.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}computeWorldMatrix(e=!1,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;const i=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();const r=this._cache;r.pivotMatrixUpdated=!1,r.billboardMode=this.billboardMode,r.infiniteDistance=this.infiniteDistance,r.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;const s=this._getEffectiveParent(),n=gt._TmpScaling;let a=this._position;if(this._infiniteDistance&&!this.parent&&t){const c=t.getWorldMatrix(),h=new x(c.m[12],c.m[13],c.m[14]);a=gt._TmpTranslation,a.copyFromFloats(this._position.x+h.x,this._position.y+h.y,this._position.z+h.z)}n.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);let l;if(this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,l=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(oe.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(l=gt._TmpRotation,oe.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),this._usePivotMatrix){const c=j.Matrix[1];H.ScalingToRef(n.x,n.y,n.z,c);const h=j.Matrix[0];l.toRotationMatrix(h),this._pivotMatrix.multiplyToRef(c,j.Matrix[4]),j.Matrix[4].multiplyToRef(h,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(a.x,a.y,a.z)}else H.ComposeToRef(n,l,a,this._localMatrix);if(s&&s.getWorldMatrix){if(e&&s.computeWorldMatrix(e),r.useBillboardPath){this._transformToBoneReferal?s.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),j.Matrix[7]):j.Matrix[7].copyFrom(s.getWorldMatrix());const c=j.Vector3[5],h=j.Vector3[6],u=j.Quaternion[0];j.Matrix[7].decompose(h,u,c),H.ScalingToRef(h.x,h.y,h.z,j.Matrix[7]),j.Matrix[7].setTranslation(c),gt.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(u,c),this._localMatrix.setTranslation(c)),this._localMatrix.multiplyToRef(j.Matrix[7],this._worldMatrix)}else this._transformToBoneReferal?(this._localMatrix.multiplyToRef(s.getWorldMatrix(),j.Matrix[6]),j.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localMatrix.multiplyToRef(s.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(r.useBillboardPath&&t&&this.billboardMode&&!r.useBillboardPosition){const c=j.Vector3[0];if(this._worldMatrix.getTranslationToRef(c),j.Matrix[1].copyFrom(t.getViewMatrix()),j.Matrix[1].setTranslationFromFloats(0,0,0),j.Matrix[1].invertToRef(j.Matrix[0]),(this.billboardMode&gt.BILLBOARDMODE_ALL)!==gt.BILLBOARDMODE_ALL){j.Matrix[0].decompose(void 0,j.Quaternion[0],void 0);const h=j.Vector3[1];j.Quaternion[0].toEulerAnglesToRef(h),(this.billboardMode&gt.BILLBOARDMODE_X)!==gt.BILLBOARDMODE_X&&(h.x=0),(this.billboardMode&gt.BILLBOARDMODE_Y)!==gt.BILLBOARDMODE_Y&&(h.y=0),(this.billboardMode&gt.BILLBOARDMODE_Z)!==gt.BILLBOARDMODE_Z&&(h.z=0),H.RotationYawPitchRollToRef(h.y,h.x,h.z,j.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(j.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(j.Vector3[0])}else if(r.useBillboardPath&&t&&r.useBillboardPosition){const c=j.Vector3[0];this._worldMatrix.getTranslationToRef(c);const h=t.globalPosition;this._worldMatrix.invertToRef(j.Matrix[1]);const u=j.Vector3[1];x.TransformCoordinatesToRef(h,j.Matrix[1],u),u.normalize();const d=-Math.atan2(u.z,u.x)+Math.PI/2,f=Math.sqrt(u.x*u.x+u.z*u.z),_=-Math.atan2(u.y,f);if(oe.RotationYawPitchRollToRef(d,_,0,j.Quaternion[0]),(this.billboardMode&gt.BILLBOARDMODE_ALL)!==gt.BILLBOARDMODE_ALL){const p=j.Vector3[1];j.Quaternion[0].toEulerAnglesToRef(p),(this.billboardMode&gt.BILLBOARDMODE_X)!==gt.BILLBOARDMODE_X&&(p.x=0),(this.billboardMode&gt.BILLBOARDMODE_Y)!==gt.BILLBOARDMODE_Y&&(p.y=0),(this.billboardMode&gt.BILLBOARDMODE_Z)!==gt.BILLBOARDMODE_Z&&(p.z=0),H.RotationYawPitchRollToRef(p.y,p.x,p.z,j.Matrix[0])}else H.FromQuaternionToRef(j.Quaternion[0],j.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(j.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(j.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):s&&s._nonUniformScaling?this._updateNonUniformScalingState(s._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=H.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){const t=this.getChildren();for(let i=0;i<t.length;++i){const r=t[i];if(r){r.computeWorldMatrix();const s=j.Matrix[0];r._localMatrix.multiplyToRef(this._localMatrix,s);const n=j.Quaternion[0];s.decompose(r.scaling,n,r.position),r.rotationQuaternion?r.rotationQuaternion.copyFrom(n):n.toEulerAnglesToRef(r.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=oe.Identity()),this._worldMatrix=H.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),x.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){const r=ke.Clone(()=>new gt(e,this.getScene()),this);if(r.name=e,r.id=e,t&&(r.parent=t),!i){const s=this.getDescendants(!0);for(let n=0;n<s.length;n++){const a=s[n];a.clone&&a.clone(e+"."+a.name,r)}}return r}serialize(e){const t=ke.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),t}static Parse(e,t,i){const r=ke.Parse(()=>new gt(e.name,t),e,t,i);return e.localMatrix?r.setPreTransformMatrix(H.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(H.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r._waitingParsedUniqueId=e.uniqueId,e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),r}getChildTransformNodes(e,t){const i=[];return this._getDescendants(i,e,r=>(!t||t(r))&&r instanceof gt),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){const i=this._parentContainer.transformNodes.indexOf(this);i>-1&&this._parentContainer.transformNodes.splice(i,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){const i=this.getChildTransformNodes(!0);for(const r of i)r.parent=null,r.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let r=null,s=null;t&&(this.rotationQuaternion?(s=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(r=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const n=this.getHierarchyBoundingVectors(e,i),a=n.max.subtract(n.min),l=Math.max(a.x,a.y,a.z);if(l===0)return this;const c=1/l;return this.scaling.scaleInPlace(c),t&&(this.rotationQuaternion&&s?this.rotationQuaternion.copyFrom(s):this.rotation&&r&&this.rotation.copyFrom(r)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}}gt.BILLBOARDMODE_NONE=0;gt.BILLBOARDMODE_X=1;gt.BILLBOARDMODE_Y=2;gt.BILLBOARDMODE_Z=4;gt.BILLBOARDMODE_ALL=7;gt.BILLBOARDMODE_USE_POSITION=128;gt.BillboardUseParentOrientation=!1;gt._TmpRotation=oe.Zero();gt._TmpScaling=x.Zero();gt._TmpTranslation=x.Zero();gt._LookAtVectorCache=new x(0,0,0);gt._RotationAxisCache=new oe;M([Zs("position")],gt.prototype,"_position",void 0);M([Zs("rotation")],gt.prototype,"_rotation",void 0);M([Pb("rotationQuaternion")],gt.prototype,"_rotationQuaternion",void 0);M([Zs("scaling")],gt.prototype,"_scaling",void 0);M([F("billboardMode")],gt.prototype,"_billboardMode",void 0);M([F()],gt.prototype,"scalingDeterminant",void 0);M([F("infiniteDistance")],gt.prototype,"_infiniteDistance",void 0);M([F()],gt.prototype,"ignoreNonUniformScaling",void 0);M([F()],gt.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);class yS{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new x(0,0,0),this._diffPositionForCollisions=new x(0,0,0),this._collisionResponse=!0}}class CS{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=x.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}}class AS{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new CS,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new yS,this._enableDistantPicking=!1}}class Qt extends gt{static get BILLBOARDMODE_NONE(){return gt.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return gt.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return gt.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return gt.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return gt.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return gt.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return super._updateNonUniformScalingState(e)?(this._markSubMeshesAsMiscDirty(),!0):!1}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;const t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(t===1&&e!==1||t!==1&&e===1)&&this._markSubMeshesAsMiscDirty()}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}getMaterialForRenderPass(e){var t;return(t=this._internalAbstractMeshDataInfo._materialForRenderPass)===null||t===void 0?void 0:t[e]}setMaterialForRenderPass(e,t){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}get _positions(){return null}set skeleton(e){const t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(e,t=null){switch(super(e,t,!1),this._internalAbstractMeshDataInfo=new AS,this._waitingMaterialId=null,this.cullingStrategy=Qt.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new Q,this.onCollisionPositionChangeObservable=new Q,this.onMaterialChangedObservable=new Q,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=ge.Red(),this.outlineWidth=.02,this.overlayColor=ge.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new x(.5,1,.5),this.ellipsoidOffset=new x(0,0,0),this.edgesWidth=1,this.edgesColor=new Ye(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new Q,this._onCollisionPositionChange=(i,r,s=null)=>{r.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>q.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),s&&this.onCollideObservable.notifyObservers(s),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},t=this.getScene(),t.addMesh(this),this._resyncLightSources(),this._uniformBuffer=new $e(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),t.performancePriority){case la.Aggressive:this.doNotSyncBoundingInfo=!0;case la.Intermediate:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1;break}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(e){const t=this._uniformBuffer;t.updateMatrix("world",e),t.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),t.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(e){let t="Name: "+this.name+", isInstance: "+(this.getClassName()!=="InstancedMesh"?"YES":"NO");t+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const i=this._internalAbstractMeshDataInfo._skeleton;return i&&(t+=", skeleton: "+i.name),e&&(t+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],t+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),t}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==gt.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,t=!0){if(this.actionManager&&(t||this.actionManager.isRecursive))if(e){if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes)for(const t of this.subMeshes)t._rebuild()}_resyncLightSources(){this._lightSources.length=0;for(const e of this.getScene().lights)e.isEnabled()&&e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){const t=e.isEnabled()&&e.canAffectMesh(this),i=this._lightSources.indexOf(e);let r=!1;if(i===-1){if(!t)return;this._lightSources.push(e)}else{if(t)return;r=!0,this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty(r)}_unBindEffect(){for(const e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,t){const i=this._lightSources.indexOf(e);i!==-1&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(t))}_markSubMeshesAsDirty(e){if(this.subMeshes)for(const t of this.subMeshes)for(let i=0;i<t._drawWrappers.length;++i){const r=t._drawWrappers[i];!r||!r.defines||!r.defines.markAllAsDirty||e(r.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty(t=>t.markAsLightDirty(e))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(e=>e.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(e=>e.markAsMiscDirty())}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}resetDrawCache(e){if(this.subMeshes)for(const t of this.subMeshes)t.resetDrawCache(e)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,t,i,r){return this}updateVerticesData(e,t,i,r){return this}setIndices(e,t){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return this._boundingInfo!==null}buildBoundingInfo(e,t,i){return this._boundingInfo=new Qn(e,t,i),this._boundingInfo}normalizeToUnitCube(e=!0,t=!1,i){return super.normalizeToUnitCube(e,t,i)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(O.MatricesIndicesKind)&&this.isVerticesDataPresent(O.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,t){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===gt.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,t,i){return this.position.addInPlace(this.calcMovePOV(e,t,i)),this}calcMovePOV(e,t,i){const r=new H;(this.rotationQuaternion?this.rotationQuaternion:oe.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(r);const n=x.Zero(),a=this.definedFacingForward?-1:1;return x.TransformCoordinatesFromFloatsToRef(e*a,t,i*a,r,n),n}rotatePOV(e,t,i){return this.rotation.addInPlace(this.calcRotatePOV(e,t,i)),this}calcRotatePOV(e,t,i){const r=this.definedFacingForward?1:-1;return new x(e*r,t,i*r)}refreshBoundingInfo(e=!1,t=!1){return this._boundingInfo&&this._boundingInfo.isLocked?this:(this._refreshBoundingInfo(this._getPositionData(e,t),null),this)}_refreshBoundingInfo(e,t){if(e){const i=mT(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Qn(i.minimum,i.maximum)}if(this.subMeshes)for(let i=0;i<this.subMeshes.length;i++)this.subMeshes[i].refreshBoundingInfo(e);this._updateBoundingInfo()}_getData(e=!1,t=!1,i,r=O.PositionKind){if(i=i??this.getVerticesData(r).slice(),i&&t&&this.morphTargetManager){let s=0,n=0;for(let a=0;a<i.length;a++){for(let l=0;l<this.morphTargetManager.numTargets;l++){const c=this.morphTargetManager.getTarget(l),h=c.influence;if(h>0){const u=c.getPositions();u&&(i[a]+=(u[a]-i[a])*h)}}if(s++,r===O.PositionKind&&this._positions&&s===3){s=0;const l=n*3;this._positions[n++].copyFromFloats(i[l],i[l+1],i[l+2])}}}if(i&&e&&this.skeleton){const s=this.getVerticesData(O.MatricesIndicesKind),n=this.getVerticesData(O.MatricesWeightsKind);if(n&&s){const a=this.numBoneInfluencers>4,l=a?this.getVerticesData(O.MatricesIndicesExtraKind):null,c=a?this.getVerticesData(O.MatricesWeightsExtraKind):null,h=this.skeleton.getTransformMatrices(this),u=j.Vector3[0],d=j.Matrix[0],f=j.Matrix[1];let _=0;for(let p=0;p<i.length;p+=3,_+=4){d.reset();let m,T;for(m=0;m<4;m++)T=n[_+m],T>0&&(H.FromFloat32ArrayToRefScaled(h,Math.floor(s[_+m]*16),T,f),d.addToSelf(f));if(a)for(m=0;m<4;m++)T=c[_+m],T>0&&(H.FromFloat32ArrayToRefScaled(h,Math.floor(l[_+m]*16),T,f),d.addToSelf(f));r===O.NormalKind?x.TransformNormalFromFloatsToRef(i[p],i[p+1],i[p+2],d,u):x.TransformCoordinatesFromFloatsToRef(i[p],i[p+1],i[p+2],d,u),u.toArray(i,p),r===O.PositionKind&&this._positions&&this._positions[p/3].copyFrom(u)}}}return i}getNormalsData(e=!1,t=!1){return this._getData(e,t,null,O.NormalKind)}getPositionData(e=!1,t=!1,i){return this._getData(e,t,i,O.PositionKind)}_getPositionData(e,t){var i;let r=this.getVerticesData(O.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),r&&(e&&this.skeleton||t&&this.morphTargetManager)){if(r=r.slice(),this._generatePointsArray(),this._positions){const s=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(s.length);for(let n=0;n<s.length;n++)this._internalAbstractMeshDataInfo._positions[n]=((i=s[n])===null||i===void 0?void 0:i.clone())||new x}return this.getPositionData(e,t,r)}return r}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new Qn(x.Zero(),x.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;const t=this.subMeshes.length;for(let i=0;i<t;i++){const r=this.subMeshes[i];(t>1||!r.IsGlobal)&&r.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,t=!1,i){const r=this.getBoundingInfo(),s=e.getBoundingInfo();if(r.intersects(s,t))return!0;if(i){for(const n of this.getChildMeshes())if(n.intersectsMesh(e,t,!0))return!0}return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);const i=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=i.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,i.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(e,t,i){var r;if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];const s=e.verticesStart,n=e.verticesStart+e.verticesCount;for(let a=s;a<n;a++)e._lastColliderWorldVertices.push(x.TransformCoordinates(this._positions[a],t))}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),((r=e.getMaterial())===null||r===void 0?void 0:r.fillMode)===7),this}_processCollisionsForSubMeshes(e,t){const i=this._scene.getCollidingSubMeshCandidates(this,e),r=i.length;for(let s=0;s<r;s++){const n=i.data[s];r>1&&!n._checkCollision(e)||this._collideForSubMesh(n,t,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;const t=j.Matrix[0],i=j.Matrix[1];return H.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,i),this._processCollisionsForSubMeshes(e,i),this}_generatePointsArray(){return!1}intersects(e,t,i,r=!1,s,n=!1){const a=new Vs,l=this.getClassName()==="InstancedLinesMesh"||this.getClassName()==="LinesMesh"?this.intersectionThreshold:0,c=this.getBoundingInfo();if(!this.subMeshes||!n&&(!e.intersectsSphere(c.boundingSphere,l)||!e.intersectsBox(c.boundingBox,l)))return a;if(r)return a.hit=!n,a.pickedMesh=n?null:this,a.distance=n?0:x.Distance(e.origin,c.boundingSphere.center),a.subMeshId=0,a;if(!this._generatePointsArray())return a;let h=null;const u=this._scene.getIntersectingSubMeshCandidates(this,e),d=u.length;let f=!1;for(let _=0;_<d;_++){const m=u.data[_].getMaterial();if(m&&(m.fillMode==7||m.fillMode==0||m.fillMode==1||m.fillMode==2||m.fillMode==4)){f=!0;break}}if(!f)return a.hit=!0,a.pickedMesh=this,a.distance=x.Distance(e.origin,c.boundingSphere.center),a.subMeshId=-1,a;for(let _=0;_<d;_++){const p=u.data[_];if(d>1&&!p.canIntersects(e))continue;const m=p.intersects(e,this._positions,this.getIndices(),t,i);if(m&&(t||!h||m.distance<h.distance)&&(h=m,h.subMeshId=_,t))break}if(h){const _=s??this.getWorldMatrix(),p=j.Vector3[0],m=j.Vector3[1];x.TransformCoordinatesToRef(e.origin,_,p),e.direction.scaleToRef(h.distance,m);const b=x.TransformNormal(m,_).addInPlace(p);return a.hit=!0,a.distance=x.Distance(p,b),a.pickedPoint=b,a.pickedMesh=this,a.bu=h.bu||0,a.bv=h.bv||0,a.subMeshFaceId=h.faceId,a.faceId=h.faceId+u.data[h.subMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),a.subMeshId=h.subMeshId,a}return a}clone(e,t,i){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array;return this}dispose(e,t=!1){let i;for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),i=0;i<this._intersectionsInProgress.length;i++){const n=this._intersectionsInProgress[i],a=n._intersectionsInProgress.indexOf(this);n._intersectionsInProgress.splice(a,1)}this._intersectionsInProgress.length=0,this.getScene().lights.forEach(n=>{let a=n.includedOnlyMeshes.indexOf(this);a!==-1&&n.includedOnlyMeshes.splice(a,1),a=n.excludedMeshes.indexOf(this),a!==-1&&n.excludedMeshes.splice(a,1);const l=n.getShadowGenerators();if(l){const c=l.values();for(let h=c.next();h.done!==!0;h=c.next()){const d=h.value.getShadowMap();d&&d.renderList&&(a=d.renderList.indexOf(this),a!==-1&&d.renderList.splice(a,1))}}}),(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes();const s=this.getScene().getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,s.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),s.wipeCaches(),this.getScene().removeMesh(this),this._parentContainer){const n=this._parentContainer.meshes.indexOf(this);n>-1&&this._parentContainer.meshes.splice(n,1),this._parentContainer=null}if(t&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(i=0;i<this.getScene().particleSystems.length;i++)this.getScene().particleSystems[i].emitter===this&&(this.getScene().particleSystems[i].dispose(),i--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,t)}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.setParent(null,t),this}_initFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=new Array),e.facetPositions||(e.facetPositions=new Array),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let t=0;t<e.facetNb;t++)e.facetNormals[t]=x.Zero(),e.facetPositions[t]=x.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();const t=this.getVerticesData(O.PositionKind),i=this.getIndices(),r=this.getVerticesData(O.NormalKind),s=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,i instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(i);else{let a=!1;for(let l=0;l<i.length;l++)if(i[l]>65535){a=!0;break}a?e.depthSortedIndices=new Uint32Array(i):e.depthSortedIndices=new Uint16Array(i)}if(e.facetDepthSortFunction=function(a,l){return l.sqDistance-a.sqDistance},!e.facetDepthSortFrom){const a=this.getScene().activeCamera;e.facetDepthSortFrom=a?a.position:x.Zero()}e.depthSortedFacets=[];for(let a=0;a<e.facetNb;a++){const l={ind:a*3,sqDistance:0};e.depthSortedFacets.push(l)}e.invertedMatrix=H.Identity(),e.facetDepthSortOrigin=x.Zero()}e.bbSize.x=s.maximum.x-s.minimum.x>kt?s.maximum.x-s.minimum.x:kt,e.bbSize.y=s.maximum.y-s.minimum.y>kt?s.maximum.y-s.minimum.y:kt,e.bbSize.z=s.maximum.z-s.minimum.z>kt?s.maximum.z-s.minimum.z:kt;let n=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(n=n>e.bbSize.z?n:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/n),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/n),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/n),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=s,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),x.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,r&&Oe.ComputeNormals(t,i,r,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);const a=e.depthSortedIndices.length/3|0;for(let l=0;l<a;l++){const c=e.depthSortedFacets[l].ind;e.depthSortedIndices[l*3]=i[c],e.depthSortedIndices[l*3+1]=i[c+1],e.depthSortedIndices[l*3+2]=i[c+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){const t=x.Zero();return this.getFacetPositionToRef(e,t),t}getFacetPositionToRef(e,t){const i=this.getFacetLocalPositions()[e],r=this.getWorldMatrix();return x.TransformCoordinatesToRef(i,r,t),this}getFacetNormal(e){const t=x.Zero();return this.getFacetNormalToRef(e,t),t}getFacetNormalToRef(e,t){const i=this.getFacetLocalNormals()[e];return x.TransformNormalToRef(i,this.getWorldMatrix(),t),this}getFacetsAtLocalCoordinates(e,t,i){const r=this.getBoundingInfo(),s=this._internalAbstractMeshDataInfo._facetData,n=Math.floor((e-r.minimum.x*s.partitioningBBoxRatio)*s.subDiv.X*s.partitioningBBoxRatio/s.bbSize.x),a=Math.floor((t-r.minimum.y*s.partitioningBBoxRatio)*s.subDiv.Y*s.partitioningBBoxRatio/s.bbSize.y),l=Math.floor((i-r.minimum.z*s.partitioningBBoxRatio)*s.subDiv.Z*s.partitioningBBoxRatio/s.bbSize.z);return n<0||n>s.subDiv.max||a<0||a>s.subDiv.max||l<0||l>s.subDiv.max?null:s.facetPartitioning[n+s.subDiv.max*a+s.subDiv.max*s.subDiv.max*l]}getClosestFacetAtCoordinates(e,t,i,r,s=!1,n=!0){const a=this.getWorldMatrix(),l=j.Matrix[5];a.invertToRef(l);const c=j.Vector3[8];x.TransformCoordinatesFromFloatsToRef(e,t,i,l,c);const h=this.getClosestFacetAtLocalCoordinates(c.x,c.y,c.z,r,s,n);return r&&x.TransformCoordinatesFromFloatsToRef(r.x,r.y,r.z,a,r),h}getClosestFacetAtLocalCoordinates(e,t,i,r,s=!1,n=!0){let a=null,l=0,c=0,h=0,u=0,d=0,f=0,_=0,p=0;const m=this.getFacetLocalPositions(),T=this.getFacetLocalNormals(),b=this.getFacetsAtLocalCoordinates(e,t,i);if(!b)return null;let y=Number.MAX_VALUE,S=y,C,I,P;for(let D=0;D<b.length;D++)C=b[D],I=T[C],P=m[C],u=(e-P.x)*I.x+(t-P.y)*I.y+(i-P.z)*I.z,(!s||s&&n&&u>=0||s&&!n&&u<=0)&&(u=I.x*P.x+I.y*P.y+I.z*P.z,d=-(I.x*e+I.y*t+I.z*i-u)/(I.x*I.x+I.y*I.y+I.z*I.z),f=e+I.x*d,_=t+I.y*d,p=i+I.z*d,l=f-e,c=_-t,h=p-i,S=l*l+c*c+h*h,S<y&&(y=S,a=C,r&&(r.x=f,r.y=_,r.z=p)));return a}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=new Array,e.facetNormals=new Array,e.facetPartitioning=new Array,e.facetParameters=null,e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,t,i=!1){return this}createNormals(e){const t=this.getVerticesData(O.PositionKind),i=this.getIndices();let r;return this.isVerticesDataPresent(O.NormalKind)?r=this.getVerticesData(O.NormalKind):r=[],Oe.ComputeNormals(t,i,r,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(O.NormalKind,r,e),this}alignWithNormal(e,t){t||(t=As.Y);const i=j.Vector3[0],r=j.Vector3[1];return x.CrossToRef(t,e,r),x.CrossToRef(e,r,i),this.rotationQuaternion?oe.RotationQuaternionFromAxisToRef(i,e,r,this.rotationQuaternion):x.RotationFromAxisToRef(i,e,r,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw pt("EdgesRenderer")}enableEdgesRendering(e,t,i){throw pt("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(e=>e.emitter===this)}}Qt.OCCLUSION_TYPE_NONE=0;Qt.OCCLUSION_TYPE_OPTIMISTIC=1;Qt.OCCLUSION_TYPE_STRICT=2;Qt.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0;Qt.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1;Qt.CULLINGSTRATEGY_STANDARD=0;Qt.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;Qt.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;Qt.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;ye("BABYLON.AbstractMesh",Qt);function ja(o){o.indexOf("vClipPlane")===-1&&o.push("vClipPlane"),o.indexOf("vClipPlane2")===-1&&o.push("vClipPlane2"),o.indexOf("vClipPlane3")===-1&&o.push("vClipPlane3"),o.indexOf("vClipPlane4")===-1&&o.push("vClipPlane4"),o.indexOf("vClipPlane5")===-1&&o.push("vClipPlane5"),o.indexOf("vClipPlane6")===-1&&o.push("vClipPlane6")}function Zo(o,e,t){var i,r,s,n,a,l;let c=!1,h=(i=o.clipPlane)!==null&&i!==void 0?i:e.clipPlane;return c=Pc(h,t,"CLIPPLANE","#define CLIPPLANE")||c,h=(r=o.clipPlane2)!==null&&r!==void 0?r:e.clipPlane2,c=Pc(h,t,"CLIPPLANE2","#define CLIPPLANE2")||c,h=(s=o.clipPlane3)!==null&&s!==void 0?s:e.clipPlane3,c=Pc(h,t,"CLIPPLANE3","#define CLIPPLANE3")||c,h=(n=o.clipPlane4)!==null&&n!==void 0?n:e.clipPlane4,c=Pc(h,t,"CLIPPLANE4","#define CLIPPLANE4")||c,h=(a=o.clipPlane5)!==null&&a!==void 0?a:e.clipPlane5,c=Pc(h,t,"CLIPPLANE5","#define CLIPPLANE5")||c,h=(l=o.clipPlane6)!==null&&l!==void 0?l:e.clipPlane6,c=Pc(h,t,"CLIPPLANE6","#define CLIPPLANE6")||c,c}function Ra(o,e,t){var i,r,s,n,a,l;let c=(i=e.clipPlane)!==null&&i!==void 0?i:t.clipPlane;Ic(o,"vClipPlane",c),c=(r=e.clipPlane2)!==null&&r!==void 0?r:t.clipPlane2,Ic(o,"vClipPlane2",c),c=(s=e.clipPlane3)!==null&&s!==void 0?s:t.clipPlane3,Ic(o,"vClipPlane3",c),c=(n=e.clipPlane4)!==null&&n!==void 0?n:t.clipPlane4,Ic(o,"vClipPlane4",c),c=(a=e.clipPlane5)!==null&&a!==void 0?a:t.clipPlane5,Ic(o,"vClipPlane5",c),c=(l=e.clipPlane6)!==null&&l!==void 0?l:t.clipPlane6,Ic(o,"vClipPlane6",c)}function Ic(o,e,t){t&&o.setFloat4(e,t.normal.x,t.normal.y,t.normal.z,t.d)}function Pc(o,e,t,i){const r=!!o;let s;if(Array.isArray(e)){const a=e.indexOf(i);s=a!==-1,!s&&o?e.push(i):s&&!o&&e.splice(a,1)}else s=e[t],e[t]=r;return s!==r}class Ce{static BindSceneUniformBuffer(e,t){t.bindToEffect(e,"Scene")}static PrepareDefinesForMergedUV(e,t,i){t._needUVs=!0,t[i]=!0,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(t[i+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[i+"DIRECTUV"]=0}static BindTextureMatrix(e,t,i){const r=e.getTextureMatrix();t.updateMatrix(i+"Matrix",r)}static GetFogState(e,t){return t.fogEnabled&&e.applyFog&&t.fogMode!==Ne.FOGMODE_NONE}static PrepareDefinesForMisc(e,t,i,r,s,n,a){a._areMiscDirty&&(a.LOGARITHMICDEPTH=i,a.POINTSIZE=r,a.FOG=s&&this.GetFogState(e,t),a.NONUNIFORMSCALING=e.nonUniformScaling,a.ALPHATEST=n)}static PrepareDefinesForCamera(e,t){let i=!1;if(e.activeCamera){const r=t.CAMERA_ORTHOGRAPHIC?1:0,s=t.CAMERA_PERSPECTIVE?1:0,n=e.activeCamera.mode===Ve.ORTHOGRAPHIC_CAMERA?1:0,a=e.activeCamera.mode===Ve.PERSPECTIVE_CAMERA?1:0;(r^n||s^a)&&(t.CAMERA_ORTHOGRAPHIC=n===1,t.CAMERA_PERSPECTIVE=a===1,i=!0)}return i}static PrepareDefinesForFrameBoundValues(e,t,i,r,s,n=null,a=!1){let l=Ce.PrepareDefinesForCamera(e,r);n!==!1&&(l=Zo(i,e,r)),r.DEPTHPREPASS!==!t.getColorWrite()&&(r.DEPTHPREPASS=!r.DEPTHPREPASS,l=!0),r.INSTANCES!==s&&(r.INSTANCES=s,l=!0),r.THIN_INSTANCES!==a&&(r.THIN_INSTANCES=a,l=!0),l&&r.markAsUnprocessed()}static PrepareDefinesForBones(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;const i=t.BONETEXTURE!==void 0;if(e.skeleton.isUsingTextureForMatrices&&i)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=i?!1:void 0;const r=e.getScene().prePassRenderer;if(r&&r.enabled){const s=r.excludedSkinnedMesh.indexOf(e)===-1;t.BONES_VELOCITY_ENABLED=s}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,t.BONETEXTURE!==void 0&&(t.BONETEXTURE=!1)}static PrepareDefinesForMorphTargets(e,t){const i=e.morphTargetManager;i?(t.MORPHTARGETS_UV=i.supportsUVs&&t.UV1,t.MORPHTARGETS_TANGENT=i.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=i.supportsNormals&&t.NORMAL,t.MORPHTARGETS=i.numInfluencers>0,t.NUM_MORPH_INFLUENCERS=i.numInfluencers,t.MORPHTARGETS_TEXTURE=i.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)}static PrepareDefinesForBakedVertexAnimation(e,t){const i=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!!(i&&i.isEnabled)}static PrepareDefinesForAttributes(e,t,i,r,s=!1,n=!0,a=!0){if(!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(O.NormalKind),t._needNormals&&e.isVerticesDataPresent(O.TangentKind)&&(t.TANGENT=!0);for(let l=1;l<=6;++l)t["UV"+l]=t._needUVs?e.isVerticesDataPresent(`uv${l===1?"":l}`):!1;if(i){const l=e.useVertexColors&&e.isVerticesDataPresent(O.ColorKind);t.VERTEXCOLOR=l,t.VERTEXALPHA=e.hasVertexAlpha&&l&&n}return e.isVerticesDataPresent(O.ColorInstanceKind)&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),r&&this.PrepareDefinesForBones(e,t),s&&this.PrepareDefinesForMorphTargets(e,t),a&&this.PrepareDefinesForBakedVertexAnimation(e,t),!0}static PrepareDefinesForMultiview(e,t){if(e.activeCamera){const i=t.MULTIVIEW;t.MULTIVIEW=e.activeCamera.outputRenderTarget!==null&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=i&&t.markAsUnprocessed()}}static PrepareDefinesForOIT(e,t,i){const r=t.ORDER_INDEPENDENT_TRANSPARENCY,s=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&i,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,(r!==t.ORDER_INDEPENDENT_TRANSPARENCY||s!==t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&t.markAsUnprocessed()}static PrepareDefinesForPrePass(e,t,i){const r=t.PREPASS;if(!t._arePrePassDirty)return;const s=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&i){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount;for(let n=0;n<s.length;n++){const a=e.prePassRenderer.getIndex(s[n].type);a!==-1?(t[s[n].define]=!0,t[s[n].index]=a):t[s[n].define]=!1}}else{t.PREPASS=!1;for(let n=0;n<s.length;n++)t[s[n].define]=!1}t.PREPASS!=r&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}static PrepareDefinesForLight(e,t,i,r,s,n,a){var l;switch(a.needNormals=!0,s["LIGHT"+r]===void 0&&(a.needRebuild=!0),s["LIGHT"+r]=!0,s["SPOTLIGHT"+r]=!1,s["HEMILIGHT"+r]=!1,s["POINTLIGHT"+r]=!1,s["DIRLIGHT"+r]=!1,i.prepareLightSpecificDefines(s,r),s["LIGHT_FALLOFF_PHYSICAL"+r]=!1,s["LIGHT_FALLOFF_GLTF"+r]=!1,s["LIGHT_FALLOFF_STANDARD"+r]=!1,i.falloffType){case fi.FALLOFF_GLTF:s["LIGHT_FALLOFF_GLTF"+r]=!0;break;case fi.FALLOFF_PHYSICAL:s["LIGHT_FALLOFF_PHYSICAL"+r]=!0;break;case fi.FALLOFF_STANDARD:s["LIGHT_FALLOFF_STANDARD"+r]=!0;break}if(n&&!i.specular.equalsFloats(0,0,0)&&(a.specularEnabled=!0),s["SHADOW"+r]=!1,s["SHADOWCSM"+r]=!1,s["SHADOWCSMDEBUG"+r]=!1,s["SHADOWCSMNUM_CASCADES"+r]=!1,s["SHADOWCSMUSESHADOWMAXZ"+r]=!1,s["SHADOWCSMNOBLEND"+r]=!1,s["SHADOWCSM_RIGHTHANDED"+r]=!1,s["SHADOWPCF"+r]=!1,s["SHADOWPCSS"+r]=!1,s["SHADOWPOISSON"+r]=!1,s["SHADOWESM"+r]=!1,s["SHADOWCLOSEESM"+r]=!1,s["SHADOWCUBE"+r]=!1,s["SHADOWLOWQUALITY"+r]=!1,s["SHADOWMEDIUMQUALITY"+r]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&i.shadowEnabled){const c=(l=i.getShadowGenerator(e.activeCamera))!==null&&l!==void 0?l:i.getShadowGenerator();if(c){const h=c.getShadowMap();h&&h.renderList&&h.renderList.length>0&&(a.shadowEnabled=!0,c.prepareDefines(s,r))}}i.lightmapMode!=fi.LIGHTMAP_DEFAULT?(a.lightmapMode=!0,s["LIGHTMAPEXCLUDED"+r]=!0,s["LIGHTMAPNOSPECULAR"+r]=i.lightmapMode==fi.LIGHTMAP_SHADOWSONLY):(s["LIGHTMAPEXCLUDED"+r]=!1,s["LIGHTMAPNOSPECULAR"+r]=!1)}static PrepareDefinesForLights(e,t,i,r,s=4,n=!1){if(!i._areLightsDirty)return i._needNormals;let a=0;const l={needNormals:i._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!n){for(const h of t.lightSources)if(this.PrepareDefinesForLight(e,t,h,a,i,r,l),a++,a===s)break}i.SPECULARTERM=l.specularEnabled,i.SHADOWS=l.shadowEnabled;for(let h=a;h<s;h++)i["LIGHT"+h]!==void 0&&(i["LIGHT"+h]=!1,i["HEMILIGHT"+h]=!1,i["POINTLIGHT"+h]=!1,i["DIRLIGHT"+h]=!1,i["SPOTLIGHT"+h]=!1,i["SHADOW"+h]=!1,i["SHADOWCSM"+h]=!1,i["SHADOWCSMDEBUG"+h]=!1,i["SHADOWCSMNUM_CASCADES"+h]=!1,i["SHADOWCSMUSESHADOWMAXZ"+h]=!1,i["SHADOWCSMNOBLEND"+h]=!1,i["SHADOWCSM_RIGHTHANDED"+h]=!1,i["SHADOWPCF"+h]=!1,i["SHADOWPCSS"+h]=!1,i["SHADOWPOISSON"+h]=!1,i["SHADOWESM"+h]=!1,i["SHADOWCLOSEESM"+h]=!1,i["SHADOWCUBE"+h]=!1,i["SHADOWLOWQUALITY"+h]=!1,i["SHADOWMEDIUMQUALITY"+h]=!1);const c=e.getEngine().getCaps();return i.SHADOWFLOAT===void 0&&(l.needRebuild=!0),i.SHADOWFLOAT=l.shadowEnabled&&(c.textureFloatRender&&c.textureFloatLinearFiltering||c.textureHalfFloatRender&&c.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=l.lightmapMode,l.needRebuild&&i.rebuild(),l.needNormals}static PrepareUniformsAndSamplersForLight(e,t,i,r,s=null,n=!1){s&&s.push("Light"+e),!n&&(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),i.push("shadowSampler"+e),i.push("depthSampler"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),r&&(i.push("projectionLightSampler"+e),t.push("textureProjectionMatrix"+e)))}static PrepareUniformsAndSamplersList(e,t,i,r=4){let s,n=null;if(e.uniformsNames){const a=e;s=a.uniformsNames,n=a.uniformBuffersNames,t=a.samplers,i=a.defines,r=a.maxSimultaneousLights||0}else s=e,t||(t=[]);for(let a=0;a<r&&i["LIGHT"+a];a++)this.PrepareUniformsAndSamplersForLight(a,s,t,i["PROJECTEDLIGHTTEXTURE"+a],n);i.NUM_MORPH_INFLUENCERS&&s.push("morphTargetInfluences"),i.BAKED_VERTEX_ANIMATION_TEXTURE&&(s.push("bakedVertexAnimationSettings"),s.push("bakedVertexAnimationTextureSizeInverted"),s.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))}static HandleFallbacksForShadows(e,t,i=4,r=0){let s=0;for(let n=0;n<i&&e["LIGHT"+n];n++)n>0&&(s=r+n,t.addFallback(s,"LIGHT"+n)),e.SHADOWS||(e["SHADOW"+n]&&t.addFallback(r,"SHADOW"+n),e["SHADOWPCF"+n]&&t.addFallback(r,"SHADOWPCF"+n),e["SHADOWPCSS"+n]&&t.addFallback(r,"SHADOWPCSS"+n),e["SHADOWPOISSON"+n]&&t.addFallback(r,"SHADOWPOISSON"+n),e["SHADOWESM"+n]&&t.addFallback(r,"SHADOWESM"+n),e["SHADOWCLOSEESM"+n]&&t.addFallback(r,"SHADOWCLOSEESM"+n));return s++}static PrepareAttributesForMorphTargetsInfluencers(e,t,i){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=i,this.PrepareAttributesForMorphTargets(e,t,this._TmpMorphInfluencers)}static PrepareAttributesForMorphTargets(e,t,i){const r=i.NUM_MORPH_INFLUENCERS;if(r>0&&qe.LastCreatedEngine){const s=qe.LastCreatedEngine.getCaps().maxVertexAttribs,n=t.morphTargetManager;if(n!=null&&n.isUsingTextureForTargets)return;const a=n&&n.supportsNormals&&i.NORMAL,l=n&&n.supportsTangents&&i.TANGENT,c=n&&n.supportsUVs&&i.UV1;for(let h=0;h<r;h++)e.push(O.PositionKind+h),a&&e.push(O.NormalKind+h),l&&e.push(O.TangentKind+h),c&&e.push(O.UVKind+"_"+h),e.length>s&&X.Error("Cannot add more vertex attributes for mesh "+t.name)}}static PrepareAttributesForBakedVertexAnimation(e,t,i){i.BAKED_VERTEX_ANIMATION_TEXTURE&&i.INSTANCES&&e.push("bakedVertexAnimationSettingsInstanced")}static PrepareAttributesForBones(e,t,i,r){i.NUM_BONE_INFLUENCERS>0&&(r.addCPUSkinningFallback(0,t),e.push(O.MatricesIndicesKind),e.push(O.MatricesWeightsKind),i.NUM_BONE_INFLUENCERS>4&&(e.push(O.MatricesIndicesExtraKind),e.push(O.MatricesWeightsExtraKind)))}static PrepareAttributesForInstances(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&this.PushAttributesForInstances(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push(O.ColorInstanceKind)}static PushAttributesForInstances(e,t=!1){e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))}static BindLightProperties(e,t,i){e.transferToEffect(t,i+"")}static BindLight(e,t,i,r,s,n=!0){e._bindLight(t,i,r,s,n)}static BindLights(e,t,i,r,s=4){const n=Math.min(t.lightSources.length,s);for(let a=0;a<n;a++){const l=t.lightSources[a];this.BindLight(l,a,e,i,typeof r=="boolean"?r:r.SPECULARTERM,t.receiveShadows)}}static BindFogParameters(e,t,i,r=!1){e.fogEnabled&&t.applyFog&&e.fogMode!==Ne.FOGMODE_NONE&&(i.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),r?(e.fogColor.toLinearSpaceToRef(this._TempFogColor),i.setColor3("vFogColor",this._TempFogColor)):i.setColor3("vFogColor",e.fogColor))}static BindBonesParameters(e,t,i){if(!(!t||!e)&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){const r=e.skeleton;if(r.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){const s=r.getTransformMatrixTexture(e);t.setTexture("boneSampler",s),t.setFloat("boneTextureWidth",4*(r.bones.length+1))}else{const s=r.getTransformMatrices(e);s&&(t.setMatrices("mBones",s),i&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2)&&(i.previousBones[e.uniqueId]||(i.previousBones[e.uniqueId]=s.slice()),t.setMatrices("mPreviousBones",i.previousBones[e.uniqueId]),Ce._CopyBonesTransformationMatrices(s,i.previousBones[e.uniqueId])))}}}static _CopyBonesTransformationMatrices(e,t){return t.set(e),t}static BindMorphTargetParameters(e,t){const i=e.morphTargetManager;!e||!i||t.setFloatArray("morphTargetInfluences",i.influences)}static BindLogDepth(e,t,i){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf("LOGARITHMICDEPTH")>=0){const r=i.activeCamera;r.mode===Ve.ORTHOGRAPHIC_CAMERA&&X.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(r.maxZ+1)/Math.LN2))}}}Ce._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0};Ce._TempFogColor=ge.Black();class Jo{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){ke.Clone(()=>e,this)}serialize(){return ke.Serialize(this)}parse(e,t,i){ke.Parse(()=>this,e,t,i)}}M([F()],Jo.prototype,"func",null);M([F()],Jo.prototype,"funcRef",null);M([F()],Jo.prototype,"funcMask",null);M([F()],Jo.prototype,"opStencilFail",null);M([F()],Jo.prototype,"opDepthFail",null);M([F()],Jo.prototype,"opStencilDepthPass",null);M([F()],Jo.prototype,"mask",null);M([F()],Jo.prototype,"enabled",null);var Cs;(function(o){o[o.Created=1]="Created",o[o.Disposed=2]="Disposed",o[o.GetDefineNames=4]="GetDefineNames",o[o.PrepareUniformBuffer=8]="PrepareUniformBuffer",o[o.IsReadyForSubMesh=16]="IsReadyForSubMesh",o[o.PrepareDefines=32]="PrepareDefines",o[o.BindForSubMesh=64]="BindForSubMesh",o[o.PrepareEffect=128]="PrepareEffect",o[o.GetAnimatables=256]="GetAnimatables",o[o.GetActiveTextures=512]="GetActiveTextures",o[o.HasTexture=1024]="HasTexture",o[o.FillRenderTargetTextures=2048]="FillRenderTargetTextures",o[o.HasRenderTargetTextures=4096]="HasRenderTargetTextures",o[o.HardBindForSubMesh=8192]="HardBindForSubMesh"})(Cs||(Cs={}));class me{get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;const t=this._alpha;this._alpha=e,(t===1||e===1)&&this.markAsDirty(me.MiscDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(me.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(me.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new Q),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new Q),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new Q),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(me.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(me.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case me.WireFrameFillMode:case me.LineListDrawMode:case me.LineLoopDrawMode:case me.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?me.WireFrameFillMode:me.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case me.PointFillMode:case me.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?me.PointFillMode:me.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(me.MiscDirtyFlag))}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}constructor(e,t,i){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new Q,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new Jo,this._useUBO=!1,this._fillMode=me.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=e;const r=t||qe.LastCreatedScene;r&&(this._scene=r,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||J.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new vs(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._scene.useRightHandedSystem?this.sideOrientation=me.ClockWiseSideOrientation:this.sideOrientation=me.CounterClockWiseSideOrientation,this._uniformBuffer=new $e(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),me.OnEventObservable.notifyObservers(this,Cs.Created))}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,i){const r=t.materialDefines;return r?(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh):!1}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===me.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _disableAlphaBlending(){return this._transparencyMode===me.MATERIAL_OPAQUE||this._transparencyMode===me.MATERIAL_ALPHATEST}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1}needAlphaBlendingForMesh(e){return e.visibility<1?!0:this._disableAlphaBlending?!1:e.hasVertexAlpha||this.needAlphaBlending()}needAlphaTesting(){return!!this._forceAlphaTest}_shouldTurnAlphaTestOn(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=!1){const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const r of i.subMeshes)r.getMaterial()===this&&r.effect&&(r.effect._wasPreviouslyReady=!1,r.effect._wasPreviouslyUsingInstances=null,r.effect._forceRebindOnNextCall=e);e&&this.markAsDirty(me.AllDirtyFlag)}_preBind(e,t=null){const i=this._scene.getEngine(),s=(t??this.sideOrientation)===me.ClockWiseSideOrientation;return i.enableEffect(e||this._getDrawWrapper()),i.setState(this.backFaceCulling,this.zOffset,!1,s,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),s}bind(e,t){}buildUniformLayout(){const e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(Cs.PrepareUniformBuffer,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,i){const r=i.effect;r&&(this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),r._forceRebindOnNextCall=!1)}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,Ce.BindSceneUniformBuffer(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),e?this._scene._cachedVisibility=e.visibility:this._scene._cachedVisibility=1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){const i=this._scene.getEngine();this._cachedDepthWriteState=i.getDepthWrite(),i.setDepthWrite(!1)}if(this.disableColorWrite){const i=this._scene.getEngine();this._cachedColorWriteState=i.getColorWrite(),i.setColorWrite(!1)}if(this.depthFunction!==0){const i=this._scene.getEngine();this._cachedDepthFunctionState=i.getDepthFunction()||0,i.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),this.depthFunction!==0&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(Cs.GetAnimatables,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(Cs.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(Cs.HasTexture,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}getBindedMeshes(){if(this.meshMap){const e=new Array;for(const t in this.meshMap){const i=this.meshMap[t];i&&e.push(i)}return e}else return this._scene.meshes.filter(t=>t.material===this)}forceCompilation(e,t,i,r){const s={clipPlane:!1,useInstances:!1,...i},n=this.getScene(),a=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;const l=()=>{if(!this._scene||!this._scene.getEngine())return;const c=n.clipPlane;if(s.clipPlane&&(n.clipPlane=new Tn(0,0,0,1)),this._storeEffectOnSubMeshes){let h=!0,u=null;if(e.subMeshes){const d=new qs(0,0,0,0,0,e,void 0,!1,!1);d.materialDefines&&(d.materialDefines._renderId=-1),this.isReadyForSubMesh(e,d,s.useInstances)||(d.effect&&d.effect.getCompilationError()&&d.effect.allFallbacksProcessed()?u=d.effect.getCompilationError():(h=!1,setTimeout(l,16)))}h&&(this.allowShaderHotSwapping=a,u&&r&&r(u),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=a,t&&t(this)):setTimeout(l,16);s.clipPlane&&(n.clipPlane=c)};l()}forceCompilationAsync(e,t){return new Promise((i,r)=>{this.forceCompilation(e,()=>{i()},t,s=>{r(s)})})}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(me._DirtyCallbackArray.length=0,e&me.TextureDirtyFlag&&me._DirtyCallbackArray.push(me._TextureDirtyCallBack),e&me.LightDirtyFlag&&me._DirtyCallbackArray.push(me._LightsDirtyCallBack),e&me.FresnelDirtyFlag&&me._DirtyCallbackArray.push(me._FresnelDirtyCallBack),e&me.AttributesDirtyFlag&&me._DirtyCallbackArray.push(me._AttributeDirtyCallBack),e&me.MiscDirtyFlag&&me._DirtyCallbackArray.push(me._MiscDirtyCallBack),e&me.PrePassDirtyFlag&&me._DirtyCallbackArray.push(me._PrePassDirtyCallBack),me._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(me._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){const e=this.getScene().meshes;for(const t of e)if(t.subMeshes)for(const i of t.subMeshes)i.getMaterial()===this&&i.resetDrawCache()}_markAllSubMeshesAsDirty(e){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const t=this.getScene().meshes;for(const i of t)if(i.subMeshes){for(const r of i.subMeshes)if(r.getMaterial(!1)===this)for(const s of r._drawWrappers)!s||!s.defines||!s.defines.markAllAsDirty||this._materialContext===s.materialContext&&e(s.defines)}}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(me._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(me._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(me._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(me._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(me._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(me._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(me._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(me._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(me._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(me._TextureAndMiscDirtyCallBack)}setPrePassRenderer(e){return!1}dispose(e,t,i){const r=this.getScene();if(r.stopAnimation(this),r.freeProcessedMaterials(),r.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(Cs.Disposed,this._eventInfo),this._parentContainer){const s=this._parentContainer.materials.indexOf(this);s>-1&&this._parentContainer.materials.splice(s,1),this._parentContainer=null}if(i!==!0)if(this.meshMap)for(const s in this.meshMap){const n=this.meshMap[s];n&&(n.material=null,this.releaseVertexArrayObject(n,e))}else{const s=r.meshes;for(const n of s)n.material===this&&!n.sourceMesh&&(n.material=null,this.releaseVertexArrayObject(n,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}releaseVertexArrayObject(e,t){if(e.geometry){const i=e.geometry;if(this._storeEffectOnSubMeshes)for(const r of e.subMeshes)i._releaseVertexArrayObject(r.effect),t&&r.effect&&r.effect.dispose();else i._releaseVertexArrayObject(this._drawWrapper.effect)}}serialize(){const e=ke.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,e}static Parse(e,t,i){if(!e.customType)e.customType="BABYLON.StandardMaterial";else if(e.customType==="BABYLON.PBRMaterial"&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return X.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null;const s=J.Instantiate(e.customType).Parse(e,t,i);return s._loadedUniqueId=e.uniqueId,s}}me.TriangleFillMode=0;me.WireFrameFillMode=1;me.PointFillMode=2;me.PointListDrawMode=3;me.LineListDrawMode=4;me.LineLoopDrawMode=5;me.LineStripDrawMode=6;me.TriangleStripDrawMode=7;me.TriangleFanDrawMode=8;me.ClockWiseSideOrientation=0;me.CounterClockWiseSideOrientation=1;me.TextureDirtyFlag=1;me.LightDirtyFlag=2;me.FresnelDirtyFlag=4;me.AttributesDirtyFlag=8;me.MiscDirtyFlag=16;me.PrePassDirtyFlag=32;me.AllDirtyFlag=63;me.MATERIAL_OPAQUE=0;me.MATERIAL_ALPHATEST=1;me.MATERIAL_ALPHABLEND=2;me.MATERIAL_ALPHATESTANDBLEND=3;me.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0;me.MATERIAL_NORMALBLENDMETHOD_RNM=1;me.OnEventObservable=new Q;me._AllDirtyCallBack=o=>o.markAllAsDirty();me._ImageProcessingDirtyCallBack=o=>o.markAsImageProcessingDirty();me._TextureDirtyCallBack=o=>o.markAsTexturesDirty();me._FresnelDirtyCallBack=o=>o.markAsFresnelDirty();me._MiscDirtyCallBack=o=>o.markAsMiscDirty();me._PrePassDirtyCallBack=o=>o.markAsPrePassDirty();me._LightsDirtyCallBack=o=>o.markAsLightDirty();me._AttributeDirtyCallBack=o=>o.markAsAttributesDirty();me._FresnelAndMiscDirtyCallBack=o=>{me._FresnelDirtyCallBack(o),me._MiscDirtyCallBack(o)};me._TextureAndMiscDirtyCallBack=o=>{me._TextureDirtyCallBack(o),me._MiscDirtyCallBack(o)};me._DirtyCallbackArray=[];me._RunDirtyCallBacks=o=>{for(const e of me._DirtyCallbackArray)e(o)};M([F()],me.prototype,"id",void 0);M([F()],me.prototype,"uniqueId",void 0);M([F()],me.prototype,"name",void 0);M([F()],me.prototype,"metadata",void 0);M([F()],me.prototype,"checkReadyOnEveryCall",void 0);M([F()],me.prototype,"checkReadyOnlyOnce",void 0);M([F()],me.prototype,"state",void 0);M([F("alpha")],me.prototype,"_alpha",void 0);M([F("backFaceCulling")],me.prototype,"_backFaceCulling",void 0);M([F("cullBackFaces")],me.prototype,"_cullBackFaces",void 0);M([F()],me.prototype,"sideOrientation",void 0);M([F("alphaMode")],me.prototype,"_alphaMode",void 0);M([F()],me.prototype,"_needDepthPrePass",void 0);M([F()],me.prototype,"disableDepthWrite",void 0);M([F()],me.prototype,"disableColorWrite",void 0);M([F()],me.prototype,"forceDepthWrite",void 0);M([F()],me.prototype,"depthFunction",void 0);M([F()],me.prototype,"separateCullingPass",void 0);M([F("fogEnabled")],me.prototype,"_fogEnabled",void 0);M([F()],me.prototype,"pointSize",void 0);M([F()],me.prototype,"zOffset",void 0);M([F()],me.prototype,"zOffsetUnits",void 0);M([F()],me.prototype,"pointsCloud",null);M([F()],me.prototype,"fillMode",null);M([F()],me.prototype,"transparencyMode",null);class $a extends me{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().multiMaterials.push(this),this.subMaterials=new Array,this._storeEffectOnSubMeshes=!0}_hookArray(e){const t=e.push;e.push=(...r)=>{const s=t.apply(e,r);return this._markAllSubMeshesAsTexturesDirty(),s};const i=e.splice;e.splice=(r,s)=>{const n=i.apply(e,[r,s]);return this._markAllSubMeshesAsTexturesDirty(),n}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){var t;if(super.hasTexture(e))return!0;for(let i=0;i<this.subMaterials.length;i++)if(!((t=this.subMaterials[i])===null||t===void 0)&&t.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,i){for(let r=0;r<this.subMaterials.length;r++){const s=this.subMaterials[r];if(s){if(s._storeEffectOnSubMeshes){if(!s.isReadyForSubMesh(e,t,i))return!1;continue}if(!s.isReady(e))return!1}}return!0}clone(e,t){const i=new $a(e,this.getScene());for(let r=0;r<this.subMaterials.length;r++){let s=null;const n=this.subMaterials[r];t&&n?s=n.clone(e+"-"+n.name):s=this.subMaterials[r],i.subMaterials.push(s)}return i}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,qt&&(e.tags=qt.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){const i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,i){const r=this.getScene();if(!r)return;if(i)for(let n=0;n<this.subMaterials.length;n++){const a=this.subMaterials[n];a&&a.dispose(e,t)}const s=r.multiMaterials.indexOf(this);s>=0&&r.multiMaterials.splice(s,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){const i=new $a(e.name,t);return i.id=e.id,i._loadedUniqueId=e.uniqueId,qt&&qt.AddTagsTo(i,e.tags),e.materialsUniqueIds?i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach(r=>i.subMaterials.push(t.getLastMaterialById(r))),i}}ye("BABYLON.MultiMaterial",$a);class RS{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}}class gT{}class IS{constructor(){this.visibleInstances={},this.batchCache=new av,this.batchCacheReplacementModeInFrozenMode=new av,this.instancesBufferSize=32*16*4}}class av{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array}}class PS{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=32*16,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class MS{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0}}class K extends Qt{static _GetDefaultSideOrientation(e){return e||K.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(O.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(O.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new Q),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new Q),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new Q),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new Q),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new Q),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){var e;return((e=this._thinInstanceDataStorage.instancesCount)!==null&&e!==void 0?e:0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}constructor(e,t=null,i=null,r=null,s,n=!0){if(super(e,t),this._internalMeshDataInfo=new MS,this.delayLoadState=0,this.instances=new Array,this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new IS,this._thinInstanceDataStorage=new PS,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=K.DEFAULTSIDE,this.overrideMaterialSideOrientation=null,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._onBeforeDraw=(a,l,c)=>{a&&c&&(this._uniformBuffer?this.transferToEffect(l):c.bindOnlyWorldMatrix(l))},r){if(r._geometry&&r._geometry.applyToMesh(this),Sn.DeepCopy(r,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo"],["_poseMatrix"]),this._internalMeshDataInfo._source=r,t.useClonedMeshMap&&(r._internalMeshDataInfo.meshMap||(r._internalMeshDataInfo.meshMap={}),r._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=r._originalBuilderSideOrientation,this._creationDataStorage=r._creationDataStorage,r._ranges){const a=r._ranges;for(const l in a)Object.prototype.hasOwnProperty.call(a,l)&&a[l]&&this.createAnimationRange(l,a[l].from,a[l].to)}if(r.metadata&&r.metadata.clone?this.metadata=r.metadata.clone():this.metadata=r.metadata,this._internalMetadata=r._internalMetadata,qt&&qt.HasTags(r)&&qt.AddTagsTo(this,qt.GetTags(r,!0)),this.setEnabled(r.isEnabled(!1)),this.parent=r.parent,this.setPivotMatrix(r.getPivotMatrix()),this.id=e+"."+r.id,this.material=r.material,!s){const a=r.getDescendants(!0);for(let l=0;l<a.length;l++){const c=a[l];c.clone&&c.clone(e+"."+c.name,this)}}if(r.morphTargetManager&&(this.morphTargetManager=r.morphTargetManager),t.getPhysicsEngine){const a=t.getPhysicsEngine();if(n&&a&&a.getPluginVersion()===1){const l=a.getImpostorForPhysicsObject(r);l&&(this.physicsImpostor=l.clone(this))}}for(let a=0;a<t.particleSystems.length;a++){const l=t.particleSystems[a];l.emitter===r&&l.clone(l.name,this)}this.skeleton=r.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}i!==null&&(this.parent=i),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=a=>{a.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new Q(this._internalMeshDataInfo._onMeshReadyObserverAdded),r&&r.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,i){const r=this.getTotalVertices()===0||t&&t.doNotInstantiate&&(t.doNotInstantiate===!0||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));r.parent=e||this.parent,r.position=this.position.clone(),r.scaling=this.scaling.clone(),this.rotationQuaternion?r.rotationQuaternion=this.rotationQuaternion.clone():r.rotation=this.rotation.clone(),i&&i(this,r);for(const s of this.getChildTransformNodes(!0))s.getClassName()==="InstancedMesh"&&r.getClassName()==="Mesh"&&s.sourceMesh===this?s.instantiateHierarchy(r,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:r},i):s.instantiateHierarchy(r,t,i);return r}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){const i=this.getIndices(),r=this.getVerticesData(O.PositionKind);r&&i&&(t+=", flat shading: "+(r.length/3===i.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0)}addLODLevel(e,t){if(t&&t._masterMesh)return X.Warn("You cannot use a mesh as LOD level twice"),this;const i=new RS(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){const r=t._LODLevels[i];if(r.distanceOrScreenCoverage===e)return r.mesh}return null}removeLODLevel(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){const i=this._internalMeshDataInfo;if(!i._LODLevels||i._LODLevels.length===0)return this;const r=t||this.getBoundingInfo().boundingSphere,s=e.mode===Ve.ORTHOGRAPHIC_CAMERA?e.minZ:r.centerWorld.subtract(e.globalPosition).length();let n=s,a=1;if(i._useLODScreenCoverage){const l=e.screenArea;let c=r.radiusWorld*e.minZ/s;c=c*c*Math.PI,n=c/l,a=-1}if(a*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>a*n)return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,this),this;for(let l=0;l<i._LODLevels.length;l++){const c=i._LODLevels[l];if(a*c.distanceOrScreenCoverage<a*n){if(c.mesh){if(c.mesh.delayLoadState===4)return c.mesh._checkDelayState(),this;if(c.mesh.delayLoadState===2)return this;c.mesh._preActivate(),c.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,c.mesh),c.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i){var r,s;if(!this._geometry)return null;let n=(s=(r=this._userInstancedBuffersStorage)===null||r===void 0?void 0:r.vertexBuffers[e])===null||s===void 0?void 0:s.getFloatData(this._geometry.getTotalVertices(),i||t&&this._geometry.meshes.length!==1);return n||(n=this._geometry.getVerticesData(e,t,i)),n}getVertexBuffer(e){var t,i;return this._geometry?(i=(t=this._userInstancedBuffersStorage)===null||t===void 0?void 0:t.vertexBuffers[e])!==null&&i!==void 0?i:this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e){var t;return this._geometry?((t=this._userInstancedBuffersStorage)===null||t===void 0?void 0:t.vertexBuffers[e])!==void 0||this._geometry.isVerticesDataPresent(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}isVertexBufferUpdatable(e){var t,i;return this._geometry?((i=(t=this._userInstancedBuffersStorage)===null||t===void 0?void 0:t.vertexBuffers[e])===null||i===void 0?void 0:i.isUpdatable())||this._geometry.isVertexBufferUpdatable(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}getVerticesDataKinds(){if(!this._geometry){const t=new Array;return this._delayInfo&&this._delayInfo.forEach(function(i){t.push(i)}),t}const e=this._geometry.getVerticesDataKinds();if(this._userInstancedBuffersStorage)for(const t in this._userInstancedBuffersStorage.vertexBuffers)e.push(t);return e}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return this._masterMesh!==null&&this._masterMesh!==void 0}isReady(e=!1,t=!1){var i,r,s,n,a,l;if(this.delayLoadState===2||!super.isReady(e))return!1;if(!this.subMeshes||this.subMeshes.length===0||!e)return!0;const c=this.getEngine(),h=this.getScene(),u=t||c.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const d=this.material||h.defaultMaterial;if(d){if(d._storeEffectOnSubMeshes)for(const _ of this.subMeshes){const p=_.getMaterial();if(p){if(p._storeEffectOnSubMeshes){if(!p.isReadyForSubMesh(this,_,u))return!1}else if(!p.isReady(this,u))return!1}}else if(!d.isReady(this,u))return!1}const f=c.currentRenderPassId;for(const _ of this.lightSources){const p=_.getShadowGenerators();if(!p)continue;const m=p.values();for(let T=m.next();T.done!==!0;T=m.next()){const b=T.value;if(b&&(!(!((i=b.getShadowMap())===null||i===void 0)&&i.renderList)||!((r=b.getShadowMap())===null||r===void 0)&&r.renderList&&((n=(s=b.getShadowMap())===null||s===void 0?void 0:s.renderList)===null||n===void 0?void 0:n.indexOf(this))!==-1)){b.getShadowMap()&&(c.currentRenderPassId=b.getShadowMap().renderPassId);for(const y of this.subMeshes)if(!b.isReady(y,u,(l=(a=y.getMaterial())===null||a===void 0?void 0:a.needAlphaBlendingForMesh(this))!==null&&l!==void 0?l:!1))return c.currentRenderPassId=f,!1;c.currentRenderPassId=f}}}for(const _ of this._internalMeshDataInfo._LODLevels)if(_.mesh&&!_.mesh.isReady(u))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){const e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t?this:(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null,this)}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(this._instanceDataStorage.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,t),i),this}_createGlobalSubMesh(e){const t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const i=this.getIndices();if(!i)return null;const r=i.length;let s=!1;if(e)s=!0;else for(const n of this.subMeshes){if(n.indexStart+n.indexCount>r){s=!0;break}if(n.verticesStart+n.verticesCount>t){s=!0;break}}if(!s)return this.subMeshes[0]}return this.releaseSubMeshes(),new qs(0,0,t,0,this.getTotalIndices(),this)}subdivide(e){if(e<1)return;const t=this.getTotalIndices();let i=t/e|0,r=0;for(;i%3!==0;)i++;this.releaseSubMeshes();for(let s=0;s<e&&!(r>=t);s++)qs.CreateFromIndices(0,r,s===e-1?t-r:i,this),r+=i;this.synchronizeInstances()}setVerticesData(e,t,i=!1,r){if(this._geometry)this._geometry.setVerticesData(e,t,i,r);else{const s=new Oe;s.set(t,e);const n=this.getScene();new Bs(Bs.RandomId(),n,s,i,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){const i=this.getVertexBuffer(e);!i||i.isUpdatable()===t||this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=Bs.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,r){return this._geometry?(r?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){const i=this.getVerticesData(O.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(O.PositionKind,i,!1,!1),t){const r=this.getIndices(),s=this.getVerticesData(O.NormalKind);if(!s)return this;Oe.ComputeNormals(i,r,s),this.updateVerticesData(O.NormalKind,s,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;const e=this._geometry,t=this._geometry.copy(Bs.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndices(e,t=null,i=!1){if(this._geometry)this._geometry.setIndices(e,t,i);else{const r=new Oe;r.indices=e;const s=this.getScene();new Bs(Bs.RandomId(),s,r,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i){if(!this._geometry)return this;const r=this.getScene().getEngine();this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(t);let s;if(this._unIndexed)s=null;else switch(i){case me.PointFillMode:s=null;break;case me.WireFrameFillMode:s=e._getLinesIndexBuffer(this.getIndices(),r);break;default:case me.TriangleFillMode:s=this._geometry.getIndexBuffer();break}return!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,s):this._geometry._bind(t,s,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const s=this.getScene().getEngine();return this._unIndexed||t==me.PointFillMode?s.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==me.WireFrameFillMode?s.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):s.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}const i=this.getScene(),r=i._isInIntermediateRendering(),s=r?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,n=this._instanceDataStorage.batchCache;if(n.mustReturn=!1,n.renderSelf[e]=t||!s&&this.isEnabled()&&this.isVisible,n.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){const a=this._instanceDataStorage.visibleInstances,l=i.getRenderId(),c=r?a.intermediateDefaultRenderId:a.defaultRenderId;n.visibleInstances[e]=a[l],!n.visibleInstances[e]&&c&&(n.visibleInstances[e]=a[c])}return n.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&n.visibleInstances[e]!==null&&n.visibleInstances[e]!==void 0,this._instanceDataStorage.previousBatch=n,n}_renderWithInstances(e,t,i,r,s){var n;const a=i.visibleInstances[e._id],l=a?a.length:0,c=this._instanceDataStorage,h=c.instancesBufferSize;let u=c.instancesBuffer,d=c.instancesPreviousBuffer;const _=(l+1)*16*4;for(;c.instancesBufferSize<_;)c.instancesBufferSize*=2;(!c.instancesData||h!=c.instancesBufferSize)&&(c.instancesData=new Float32Array(c.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!c.instancesPreviousData||h!=c.instancesBufferSize)&&(c.instancesPreviousData=new Float32Array(c.instancesBufferSize/4));let p=0,m=0;const T=i.renderSelf[e._id],b=!u||h!==c.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!c.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!c.isFrozen||b)){const y=this.getWorldMatrix();if(T&&(this._scene.needsPreviousWorldMatrices&&(c.masterMeshPreviousWorldMatrix?(c.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,p),c.masterMeshPreviousWorldMatrix.copyFrom(y)):(c.masterMeshPreviousWorldMatrix=y.clone(),c.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,p))),y.copyToArray(c.instancesData,p),p+=16,m++),a){if(K.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&(!((n=e.getMaterial())===null||n===void 0)&&n.needAlphaBlendingForMesh(e.getRenderingMesh()))){const S=this._scene.activeCamera.globalPosition;for(let C=0;C<a.length;C++){const I=a[C];I._distanceToCamera=x.Distance(I.getBoundingInfo().boundingSphere.centerWorld,S)}a.sort((C,I)=>C._distanceToCamera>I._distanceToCamera?-1:C._distanceToCamera<I._distanceToCamera?1:0)}for(let S=0;S<a.length;S++){const C=a[S],I=C.getWorldMatrix();I.copyToArray(c.instancesData,p),this._scene.needsPreviousWorldMatrices&&(C._previousWorldMatrix?(C._previousWorldMatrix.copyToArray(c.instancesPreviousData,p),C._previousWorldMatrix.copyFrom(I)):(C._previousWorldMatrix=I.clone(),C._previousWorldMatrix.copyToArray(c.instancesPreviousData,p))),p+=16,m++}}}else m=(T?1:0)+l;return b?(u&&u.dispose(),d&&d.dispose(),u=new Xa(s,c.instancesData,!0,16,!1,!0),c.instancesBuffer=u,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=u.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=u.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=u.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=u.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(d=new Xa(s,c.instancesPreviousData,!0,16,!1,!0),c.instancesPreviousBuffer=d,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=d.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=d.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=d.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=d.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(u.updateDirectly(c.instancesData,0,m),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&d.updateDirectly(c.instancesPreviousData,0,m)),this._processInstancedBuffers(a,T),this.getScene()._activeIndices.addCount(e.indexCount*m,!1),s._currentDrawContext&&(s._currentDrawContext.useInstancing=!0),this._bind(e,r,t),this._draw(e,t,m),this._scene.needsPreviousWorldMatrices&&!b&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&d.updateDirectly(c.instancesData,0,m),s.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,r){var s,n;const a=(n=(s=this._thinInstanceDataStorage)===null||s===void 0?void 0:s.instancesCount)!==null&&n!==void 0?n:0;this.getScene()._activeIndices.addCount(e.indexCount*a,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,a),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,a):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),r.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,r,s,n,a,l){const c=this.getScene(),h=c.getEngine();if(n&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,r,i,h),this;if(n)this._renderWithInstances(t,r,s,i,h);else{h._currentDrawContext&&(h._currentDrawContext.useInstancing=!1);let u=0;s.renderSelf[t._id]&&(a&&a(!1,e.getWorldMatrix(),l),u++,this._draw(t,r,this._instanceDataStorage.overridenInstanceCount));const d=s.visibleInstances[t._id];if(d){const f=d.length;u+=f;for(let _=0;_<f;_++){const m=d[_].getWorldMatrix();a&&a(!0,m,l),this._draw(t,r)}}c._activeIndices.addCount(t.indexCount*u,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(const t in this._userInstancedBuffersStorage.vertexBuffers){const i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}render(e,t,i){var r,s,n;const a=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const l=this._getInstancesRenderList(e._id,!!i);if(l.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const c=a.getEngine();let h=0,u=null;this.ignoreCameraMaxZ&&a.activeCamera&&!a._isInIntermediateRendering()&&(h=a.activeCamera.maxZ,u=a.activeCamera,a.activeCamera.maxZ=0,a.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const d=e.getRenderingMesh(),f=l.hardwareInstancedRendering[e._id]||d.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,_=this._instanceDataStorage,p=e.getMaterial();if(!p)return u&&(u.maxZ=h,a.updateTransformMatrix(!0)),this;if(!_.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==p){if(p._storeEffectOnSubMeshes){if(!p.isReadyForSubMesh(this,e,f))return u&&(u.maxZ=h,a.updateTransformMatrix(!0)),this}else if(!p.isReady(this,f))return u&&(u.maxZ=h,a.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=p}else if(p._storeEffectOnSubMeshes&&!(!((r=e.effect)===null||r===void 0)&&r._wasPreviouslyReady)||!p._storeEffectOnSubMeshes&&!(!((s=p.getEffect())===null||s===void 0)&&s._wasPreviouslyReady))return u&&(u.maxZ=h,a.updateTransformMatrix(!0)),this;t&&c.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);let m;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?m=e._drawWrapper:m=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const T=(n=m==null?void 0:m.effect)!==null&&n!==void 0?n:null;for(const D of a._beforeRenderingMeshStage)D.action(this,e,l,T);if(!m||!T)return u&&(u.maxZ=h,a.updateTransformMatrix(!0)),this;const b=i||this;let y;if(!_.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this.overrideMaterialSideOrientation!==null)){const D=b._getWorldMatrixDeterminant();y=this.overrideMaterialSideOrientation,y==null&&(y=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),D<0&&(y=y===me.ClockWiseSideOrientation?me.CounterClockWiseSideOrientation:me.ClockWiseSideOrientation),_.sideOrientation=y}else y=_.sideOrientation;const S=this._internalMeshDataInfo._effectiveMaterial._preBind(m,y);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&c.setDepthWrite(!0);const C=a.forcePointsCloud?me.PointFillMode:a.forceWireframe?me.WireFrameFillMode:this._internalMeshDataInfo._effectiveMaterial.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),f||this._bind(e,T,C);const I=this._internalMeshDataInfo._effectiveMaterial,P=b.getWorldMatrix();I._storeEffectOnSubMeshes?I.bindForSubMesh(P,this,e):I.bind(P,this),!I.backFaceCulling&&I.separateCullingPass&&(c.setState(!0,I.zOffset,!1,!S,I.cullBackFaces,I.stencil,I.zOffsetUnits),this._processRendering(this,e,T,C,l,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),c.setState(!0,I.zOffset,!1,S,I.cullBackFaces,I.stencil,I.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,T,C,l,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const D of a._afterRenderingMeshStage)D.action(this,e,l,T);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),u&&(u.maxZ=h,a.updateTransformMatrix(!0)),a.performancePriority===la.Aggressive&&!_.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(O.MatricesWeightsKind)&&(this.isVerticesDataPresent(O.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){const e=this.getVerticesData(O.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){const r=e[i]+e[i+1]+e[i+2]+e[i+3];if(r===0)e[i]=1;else{const s=1/r;e[i]*=s,e[i+1]*=s,e[i+2]*=s,e[i+3]*=s}}this.setVerticesData(O.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(O.MatricesWeightsExtraKind),t=this.getVerticesData(O.MatricesWeightsKind),i=t.length;for(let r=0;r<i;r+=4){let s=t[r]+t[r+1]+t[r+2]+t[r+3];if(s+=e[r]+e[r+1]+e[r+2]+e[r+3],s===0)t[r]=1;else{const n=1/s;t[r]*=n,t[r+1]*=n,t[r+2]*=n,t[r+3]*=n,e[r]*=n,e[r+1]*=n,e[r+2]*=n,e[r+3]*=n}}this.setVerticesData(O.MatricesWeightsKind,t),this.setVerticesData(O.MatricesWeightsKind,e)}validateSkinning(){const e=this.getVerticesData(O.MatricesWeightsExtraKind),t=this.getVerticesData(O.MatricesWeightsKind);if(t===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};const i=t.length;let r=0,s=0,n=0,a=0;const l=e===null?4:8,c=new Array;for(let m=0;m<=l;m++)c[m]=0;const h=.001;for(let m=0;m<i;m+=4){let T=t[m],b=T,y=b===0?0:1;for(let S=1;S<l;S++){const C=S<4?t[m+S]:e[m+S-4];C>T&&r++,C!==0&&y++,b+=C,T=C}if(c[y]++,y>n&&(n=y),b===0)s++;else{const S=1/b;let C=0;for(let I=0;I<l;I++)I<4?C+=Math.abs(t[m+I]-t[m+I]*S):C+=Math.abs(e[m+I-4]-e[m+I-4]*S);C>h&&a++}}const u=this.skeleton.bones.length,d=this.getVerticesData(O.MatricesIndicesKind),f=this.getVerticesData(O.MatricesIndicesExtraKind);let _=0;for(let m=0;m<i;m+=4)for(let T=0;T<l;T++){const b=T<4?d[m+T]:f[m+T-4];(b>=u||b<0)&&_++}const p="Number of Weights = "+i/4+`
Maximum influences = `+n+`
Missing Weights = `+s+`
Not Sorted = `+r+`
Not Normalized = `+a+`
WeightCounts = [`+c+`]
Number of bones = `+u+`
Bad Bone Indices = `+_;return{skinned:!0,valid:s===0&&a===0&&_===0,report:p}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const t=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return J.LoadFile(this.delayLoadingFile,i=>{i instanceof ArrayBuffer?this._delayLoadingFunction(i,this):this._delayLoadingFunction(JSON.parse(i),this),this.instances.forEach(r=>{r.refreshBoundingInfo(),r._syncSubMeshes()}),this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,t),this}isInFrustum(e){return this.delayLoadState===2||!super.isInFrustum(e)?!1:(this._checkDelayState(),!0)}setMaterialById(e){const t=this.getScene().materials;let i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;const r=this.getScene().multiMaterials;for(i=r.length-1;i>-1;i--)if(r[i].id===e)return this.material=r[i],this;return this}getAnimatables(){const e=new Array;return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(O.PositionKind))return this;const t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(O.PositionKind);const r=x.Zero();let s;for(s=0;s<i.length;s+=3)x.TransformCoordinatesFromFloatsToRef(i[s],i[s+1],i[s+2],e,r).toArray(i,s);if(this.setVerticesData(O.PositionKind,i,this.getVertexBuffer(O.PositionKind).isUpdatable()),this.isVerticesDataPresent(O.NormalKind)){for(i=this.getVerticesData(O.NormalKind),s=0;s<i.length;s+=3)x.TransformNormalFromFloatsToRef(i[s],i[s+1],i[s+2],e,r).normalize().toArray(i,s);this.setVerticesData(O.NormalKind,i,this.getVertexBuffer(O.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return this._geometry?this._geometry._generatePointsArray():!1}clone(e="",t=null,i,r=!0){return new K(e,this.getScene(),t,this,i,r)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);const i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(const r in i.meshMap){const s=i.meshMap[r];s&&(s._internalMeshDataInfo._source=null,i.meshMap[r]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{const r=this.getScene().meshes;for(const s of r){const n=s;n._internalMeshDataInfo&&n._internalMeshDataInfo._source&&n._internalMeshDataInfo._source===this&&(n._internalMeshDataInfo._source=null)}}i._source=null,this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,r,s,n,a=!1){const l=this.getScene(),c=h=>{const u=h.width,d=h.height,_=this.getEngine().createCanvas(u,d).getContext("2d");_.drawImage(h,0,0);const p=_.getImageData(0,0,u,d).data;this.applyDisplacementMapFromBuffer(p,u,d,t,i,s,n,a),r&&r(this)};return J.LoadImage(e,c,()=>{},l.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,r,s,n,a,l=!1){if(!this.isVerticesDataPresent(O.PositionKind)||!this.isVerticesDataPresent(O.NormalKind)||!this.isVerticesDataPresent(O.UVKind))return X.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const c=this.getVerticesData(O.PositionKind,!0,!0),h=this.getVerticesData(O.NormalKind),u=this.getVerticesData(O.UVKind);let d=x.Zero();const f=x.Zero(),_=Ie.Zero();n=n||Ie.Zero(),a=a||new Ie(1,1);for(let p=0;p<c.length;p+=3){x.FromArrayToRef(c,p,d),x.FromArrayToRef(h,p,f),Ie.FromArrayToRef(u,p/3*2,_);const m=Math.abs(_.x*a.x+n.x%1)*(t-1)%t|0,T=Math.abs(_.y*a.y+n.y%1)*(i-1)%i|0,b=(m+T*t)*4,y=e[b]/255,S=e[b+1]/255,C=e[b+2]/255,I=y*.3+S*.59+C*.11;f.normalize(),f.scaleInPlace(r+(s-r)*I),d=d.add(f),d.toArray(c,p)}return Oe.ComputeNormals(c,this.getIndices(),h),l?(this.setVerticesData(O.PositionKind,c),this.setVerticesData(O.NormalKind,h),this.setVerticesData(O.UVKind,u)):(this.updateVerticesData(O.PositionKind,c),this.updateVerticesData(O.NormalKind,h)),this}convertToFlatShadedMesh(){const e=this.getVerticesDataKinds(),t={},i={},r={};let s=!1,n,a;for(n=0;n<e.length;n++){a=e[n];const m=this.getVertexBuffer(a),T=m.getData();if(!((T instanceof Array||T instanceof Float32Array)&&T.length===0)){if(a===O.NormalKind){s=m.isUpdatable(),e.splice(n,1),n--;continue}t[a]=m,i[a]=this.getVerticesData(a),r[a]=[]}}const l=this.subMeshes.slice(0),c=this.getIndices(),h=this.getTotalIndices();let u;for(u=0;u<h;u++){const m=c[u];for(n=0;n<e.length;n++){if(a=e[n],!t[a])continue;const T=t[a].getStrideSize();for(let b=0;b<T;b++)r[a].push(i[a][m*T+b])}}const d=[],f=r[O.PositionKind],_=this.getScene().useRightHandedSystem;let p;for(_?p=this.overrideMaterialSideOrientation===1:p=this.overrideMaterialSideOrientation===0,u=0;u<h;u+=3){c[u]=u,c[u+1]=u+1,c[u+2]=u+2;const m=x.FromArray(f,u*3),T=x.FromArray(f,(u+1)*3),b=x.FromArray(f,(u+2)*3),y=m.subtract(T),S=b.subtract(T),C=x.Normalize(x.Cross(y,S));p&&C.scaleInPlace(-1);for(let I=0;I<3;I++)d.push(C.x),d.push(C.y),d.push(C.z)}for(this.setIndices(c),this.setVerticesData(O.NormalKind,d,s),n=0;n<e.length;n++)a=e[n],r[a]&&this.setVerticesData(a,r[a],t[a].isUpdatable());this.releaseSubMeshes();for(let m=0;m<l.length;m++){const T=l[m];qs.AddToMesh(T.materialIndex,T.indexStart,T.indexCount,T.indexStart,T.indexCount,this)}return this.synchronizeInstances(),this}convertToUnIndexedMesh(){const e=this.getVerticesDataKinds(),t={},i={},r={};let s,n;for(s=0;s<e.length;s++){n=e[s];const u=this.getVertexBuffer(n);t[n]=u,i[n]=t[n].getData(),r[n]=[]}const a=this.subMeshes.slice(0),l=this.getIndices(),c=this.getTotalIndices();let h;for(h=0;h<c;h++){const u=l[h];for(s=0;s<e.length;s++){n=e[s];const d=t[n].getStrideSize();for(let f=0;f<d;f++)r[n].push(i[n][u*d+f])}}for(h=0;h<c;h+=3)l[h]=h,l[h+1]=h+1,l[h+2]=h+2;for(this.setIndices(l),s=0;s<e.length;s++)n=e[s],this.setVerticesData(n,r[n],t[n].isUpdatable(),t[n].getStrideSize());this.releaseSubMeshes();for(let u=0;u<a.length;u++){const d=a[u];qs.AddToMesh(d.materialIndex,d.indexStart,d.indexCount,d.indexStart,d.indexCount,this)}return this._unIndexed=!0,this.synchronizeInstances(),this}flipFaces(e=!1){const t=Oe.ExtractFromMesh(this);let i;if(e&&this.isVerticesDataPresent(O.NormalKind)&&t.normals)for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;if(t.indices){let r;for(i=0;i<t.indices.length;i+=3)r=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=r}return t.applyToMesh(this,this.isVertexBufferUpdatable(O.PositionKind)),this}increaseVertices(e=1){const t=Oe.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,r=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,s=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,n=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(!i||!r)X.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{t.indices=i,t.positions=r,s&&(t.uvs=s),n&&(t.normals=n);const a=e+1,l=new Array;for(let C=0;C<a+1;C++)l[C]=new Array;let c,h;const u=new x(0,0,0),d=new x(0,0,0),f=new Ie(0,0),_=new Array,p=new Array,m=new Array;let T,b=r.length,y;s&&(y=s.length);let S;n&&(S=n.length);for(let C=0;C<i.length;C+=3){p[0]=i[C],p[1]=i[C+1],p[2]=i[C+2];for(let I=0;I<3;I++)if(c=p[I],h=p[(I+1)%3],m[c]===void 0&&m[h]===void 0?(m[c]=new Array,m[h]=new Array):(m[c]===void 0&&(m[c]=new Array),m[h]===void 0&&(m[h]=new Array)),m[c][h]===void 0&&m[h][c]===void 0){m[c][h]=[],u.x=(r[3*h]-r[3*c])/a,u.y=(r[3*h+1]-r[3*c+1])/a,u.z=(r[3*h+2]-r[3*c+2])/a,n&&(d.x=(n[3*h]-n[3*c])/a,d.y=(n[3*h+1]-n[3*c+1])/a,d.z=(n[3*h+2]-n[3*c+2])/a),s&&(f.x=(s[2*h]-s[2*c])/a,f.y=(s[2*h+1]-s[2*c+1])/a),m[c][h].push(c);for(let P=1;P<a;P++)m[c][h].push(r.length/3),r[b++]=r[3*c]+P*u.x,r[b++]=r[3*c+1]+P*u.y,r[b++]=r[3*c+2]+P*u.z,n&&(n[S++]=n[3*c]+P*d.x,n[S++]=n[3*c+1]+P*d.y,n[S++]=n[3*c+2]+P*d.z),s&&(s[y++]=s[2*c]+P*f.x,s[y++]=s[2*c+1]+P*f.y);m[c][h].push(h),m[h][c]=new Array,T=m[c][h].length;for(let P=0;P<T;P++)m[h][c][P]=m[c][h][T-1-P]}l[0][0]=i[C],l[1][0]=m[i[C]][i[C+1]][1],l[1][1]=m[i[C]][i[C+2]][1];for(let I=2;I<a;I++){l[I][0]=m[i[C]][i[C+1]][I],l[I][I]=m[i[C]][i[C+2]][I],u.x=(r[3*l[I][I]]-r[3*l[I][0]])/I,u.y=(r[3*l[I][I]+1]-r[3*l[I][0]+1])/I,u.z=(r[3*l[I][I]+2]-r[3*l[I][0]+2])/I,n&&(d.x=(n[3*l[I][I]]-n[3*l[I][0]])/I,d.y=(n[3*l[I][I]+1]-n[3*l[I][0]+1])/I,d.z=(n[3*l[I][I]+2]-n[3*l[I][0]+2])/I),s&&(f.x=(s[2*l[I][I]]-s[2*l[I][0]])/I,f.y=(s[2*l[I][I]+1]-s[2*l[I][0]+1])/I);for(let P=1;P<I;P++)l[I][P]=r.length/3,r[b++]=r[3*l[I][0]]+P*u.x,r[b++]=r[3*l[I][0]+1]+P*u.y,r[b++]=r[3*l[I][0]+2]+P*u.z,n&&(n[S++]=n[3*l[I][0]]+P*d.x,n[S++]=n[3*l[I][0]+1]+P*d.y,n[S++]=n[3*l[I][0]+2]+P*d.z),s&&(s[y++]=s[2*l[I][0]]+P*f.x,s[y++]=s[2*l[I][0]+1]+P*f.y)}l[a]=m[i[C+1]][i[C+2]],_.push(l[0][0],l[1][0],l[1][1]);for(let I=1;I<a;I++){let P;for(P=0;P<I;P++)_.push(l[I][P],l[I+1][P],l[I+1][P+1]),_.push(l[I][P],l[I+1][P+1],l[I][P+1]);_.push(l[I][P],l[I+1][P],l[I+1][P+1])}}t.indices=_,t.applyToMesh(this,this.isVertexBufferUpdatable(O.PositionKind))}}forceSharedVertices(){const e=Oe.ExtractFromMesh(this),t=e.uvs,i=e.indices,r=e.positions,s=e.colors,n=e.matricesIndices,a=e.matricesWeights,l=e.matricesIndicesExtra,c=e.matricesWeightsExtra;if(i===void 0||r===void 0||i===null||r===null)X.Warn("VertexData contains empty entries");else{const h=new Array,u=new Array,d=new Array,f=new Array,_=new Array,p=new Array,m=new Array,T=new Array;let b=new Array,y=0;const S={};let C,I;for(let D=0;D<i.length;D+=3){I=[i[D],i[D+1],i[D+2]],b=new Array;for(let w=0;w<3;w++){b[w]="";for(let L=0;L<3;L++)Math.abs(r[3*I[w]+L])<1e-8&&(r[3*I[w]+L]=0),b[w]+=r[3*I[w]+L]+"|"}if(!(b[0]==b[1]||b[0]==b[2]||b[1]==b[2]))for(let w=0;w<3;w++){if(C=S[b[w]],C===void 0){S[b[w]]=y,C=y++;for(let L=0;L<3;L++)h.push(r[3*I[w]+L]);if(s!=null)for(let L=0;L<4;L++)f.push(s[4*I[w]+L]);if(t!=null)for(let L=0;L<2;L++)d.push(t[2*I[w]+L]);if(n!=null)for(let L=0;L<4;L++)_.push(n[4*I[w]+L]);if(a!=null)for(let L=0;L<4;L++)p.push(a[4*I[w]+L]);if(l!=null)for(let L=0;L<4;L++)m.push(l[4*I[w]+L]);if(c!=null)for(let L=0;L<4;L++)T.push(c[4*I[w]+L])}u.push(C)}}const P=new Array;Oe.ComputeNormals(h,u,P),e.positions=h,e.indices=u,e.normals=P,t!=null&&(e.uvs=d),s!=null&&(e.colors=f),n!=null&&(e.matricesIndices=_),a!=null&&(e.matricesWeights=p),l!=null&&(e.matricesIndicesExtra=m),a!=null&&(e.matricesWeightsExtra=T),e.applyToMesh(this,this.isVertexBufferUpdatable(O.PositionKind))}}static _instancedMeshFactory(e,t){throw pt("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw pt("PhysicsImpostor")}createInstance(e){return K._instancedMeshFactory(e,this)}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){const t=this.getIndices(),i=this.getVerticesData(O.PositionKind);if(!i||!t)return this;const r=new Array;for(let n=0;n<i.length;n=n+3)r.push(x.FromArray(i,n));const s=new Array;return ba.SyncAsyncForLoop(r.length,40,n=>{const a=r.length-1-n,l=r[a];for(let c=0;c<a;++c){const h=r[c];if(l.equals(h)){s[a]=c;break}}},()=>{for(let a=0;a<t.length;++a)t[a]=s[t[a]]||t[a];const n=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=n,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),qt&&qt.HasTags(this)&&(e.tags=qt.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let i=0;i<this.subMeshes.length;i++){const r=this.subMeshes[i];e.subMeshes.push({materialIndex:r.materialIndex,verticesStart:r.verticesStart,verticesCount:r.verticesCount,indexStart:r.indexStart,indexCount:r.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(Re.NAME_PHYSICSENGINE)){const i=this.getPhysicsImpostor();i&&(e.physicsMass=i.getParam("mass"),e.physicsFriction=i.getParam("friction"),e.physicsRestitution=i.getParam("mass"),e.physicsImpostor=i.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let i=0;i<this.instances.length;i++){const r=this.instances[i];if(r.doNotSerialize)continue;const s={name:r.name,id:r.id,isEnabled:r.isEnabled(!1),isVisible:r.isVisible,isPickable:r.isPickable,checkCollisions:r.checkCollisions,position:r.position.asArray(),scaling:r.scaling.asArray()};if(r.parent&&r.parent._serializeAsParent(s),r.rotationQuaternion?s.rotationQuaternion=r.rotationQuaternion.asArray():r.rotation&&(s.rotation=r.rotation.asArray()),this.getScene()._getComponent(Re.NAME_PHYSICSENGINE)){const n=r.getPhysicsImpostor();n&&(s.physicsMass=n.getParam("mass"),s.physicsFriction=n.getParam("friction"),s.physicsRestitution=n.getParam("mass"),s.physicsImpostor=n.type)}r.metadata&&(s.metadata=r.metadata),r.actionManager&&(s.actions=r.actionManager.serialize(r.name)),e.instances.push(s),ke.AppendSerializedAnimations(r,s),s.ranges=r.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const i={data:{},sizes:{},strides:{}};for(const r in this._userThinInstanceBuffersStorage.data)i.data[r]=Array.from(this._userThinInstanceBuffersStorage.data[r]),i.sizes[r]=this._userThinInstanceBuffersStorage.sizes[r],i.strides[r]=this._userThinInstanceBuffersStorage.strides[r];e.thinInstances.userThinInstance=i}return ke.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices()){X.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){const i=e.getActiveTarget(t),r=i.getPositions();if(!r){X.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(O.PositionKind+t,r,!1,3);const s=i.getNormals();s&&this.geometry.setVerticesData(O.NormalKind+t,s,!1,3);const n=i.getTangents();n&&this.geometry.setVerticesData(O.TangentKind+t,n,!1,3);const a=i.getUVs();a&&this.geometry.setVerticesData(O.UVKind+"_"+t,a,!1,2)}}else{let t=0;for(;this.geometry.isVerticesDataPresent(O.PositionKind+t);)this.geometry.removeVerticesData(O.PositionKind+t),this.geometry.isVerticesDataPresent(O.NormalKind+t)&&this.geometry.removeVerticesData(O.NormalKind+t),this.geometry.isVerticesDataPresent(O.TangentKind+t)&&this.geometry.removeVerticesData(O.TangentKind+t),this.geometry.isVerticesDataPresent(O.UVKind+t)&&this.geometry.removeVerticesData(O.UVKind+"_"+t),t++}}static Parse(e,t,i){let r;if(e.type&&e.type==="LinesMesh"?r=K._LinesMeshParser(e,t):e.type&&e.type==="GroundMesh"?r=K._GroundMeshParser(e,t):e.type&&e.type==="GoldbergMesh"?r=K._GoldbergMeshParser(e,t):r=new K(e.name,t),r.id=e.id,r._waitingParsedUniqueId=e.uniqueId,qt&&qt.AddTagsTo(r,e.tags),r.position=x.FromArray(e.position),e.metadata!==void 0&&(r.metadata=e.metadata),e.rotationQuaternion?r.rotationQuaternion=oe.FromArray(e.rotationQuaternion):e.rotation&&(r.rotation=x.FromArray(e.rotation)),r.scaling=x.FromArray(e.scaling),e.localMatrix?r.setPreTransformMatrix(H.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(H.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r.isVisible=e.isVisible,r.infiniteDistance=e.infiniteDistance,r.showBoundingBox=e.showBoundingBox,r.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,e.applyFog!==void 0&&(r.applyFog=e.applyFog),e.pickable!==void 0&&(r.isPickable=e.pickable),e.alphaIndex!==void 0&&(r.alphaIndex=e.alphaIndex),r.receiveShadows=e.receiveShadows,e.billboardMode!==void 0&&(r.billboardMode=e.billboardMode),e.visibility!==void 0&&(r.visibility=e.visibility),r.checkCollisions=e.checkCollisions,r.overrideMaterialSideOrientation=e.overrideMaterialSideOrientation,e.isBlocker!==void 0&&(r.isBlocker=e.isBlocker),r._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(r._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.actions!==void 0&&(r._waitingData.actions=e.actions),e.overlayAlpha!==void 0&&(r.overlayAlpha=e.overlayAlpha),e.overlayColor!==void 0&&(r.overlayColor=ge.FromArray(e.overlayColor)),e.renderOverlay!==void 0&&(r.renderOverlay=e.renderOverlay),r.isUnIndexed=!!e.isUnIndexed,r.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=i+e.delayLoadingFile,r.buildBoundingInfo(x.FromArray(e.boundingBoxMinimum),x.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(r._binaryInfo=e._binaryInfo),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(O.UVKind),e.hasUVs2&&r._delayInfo.push(O.UV2Kind),e.hasUVs3&&r._delayInfo.push(O.UV3Kind),e.hasUVs4&&r._delayInfo.push(O.UV4Kind),e.hasUVs5&&r._delayInfo.push(O.UV5Kind),e.hasUVs6&&r._delayInfo.push(O.UV6Kind),e.hasColors&&r._delayInfo.push(O.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(O.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(O.MatricesWeightsKind),r._delayLoadingFunction=Bs._ImportGeometry,Wr.ForceFullSceneLoadingForIncremental&&r._checkDelayState()):Bs._ImportGeometry(e,r),e.materialUniqueId?r._waitingMaterialId=e.materialUniqueId:e.materialId&&(r._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(r.morphTargetManager=t.getMorphTargetManagerById(e.morphTargetManagerId)),e.skeletonId!==void 0&&e.skeletonId!==null&&(r.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(r.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let s=0;s<e.animations.length;s++){const n=e.animations[s],a=Xr("BABYLON.Animation");a&&r.animations.push(a.Parse(n))}ii.ParseAnimationRanges(r,e,t)}if(e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?r.layerMask=Math.abs(parseInt(e.layerMask)):r.layerMask=268435455,e.physicsImpostor&&K._PhysicsImpostorParser(t,r,e),e.lodMeshIds&&(r._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let s=0;s<e.instances.length;s++){const n=e.instances[s],a=r.createInstance(n.name);if(n.id&&(a.id=n.id),qt&&(n.tags?qt.AddTagsTo(a,n.tags):qt.AddTagsTo(a,e.tags)),a.position=x.FromArray(n.position),n.metadata!==void 0&&(a.metadata=n.metadata),n.parentId!==void 0&&(a._waitingParentId=n.parentId),n.parentInstanceIndex!==void 0&&(a._waitingParentInstanceIndex=n.parentInstanceIndex),n.isEnabled!==void 0&&n.isEnabled!==null&&a.setEnabled(n.isEnabled),n.isVisible!==void 0&&n.isVisible!==null&&(a.isVisible=n.isVisible),n.isPickable!==void 0&&n.isPickable!==null&&(a.isPickable=n.isPickable),n.rotationQuaternion?a.rotationQuaternion=oe.FromArray(n.rotationQuaternion):n.rotation&&(a.rotation=x.FromArray(n.rotation)),a.scaling=x.FromArray(n.scaling),n.checkCollisions!=null&&n.checkCollisions!=null&&(a.checkCollisions=n.checkCollisions),n.pickable!=null&&n.pickable!=null&&(a.isPickable=n.pickable),n.showBoundingBox!=null&&n.showBoundingBox!=null&&(a.showBoundingBox=n.showBoundingBox),n.showSubMeshesBoundingBox!=null&&n.showSubMeshesBoundingBox!=null&&(a.showSubMeshesBoundingBox=n.showSubMeshesBoundingBox),n.alphaIndex!=null&&n.showSubMeshesBoundingBox!=null&&(a.alphaIndex=n.alphaIndex),n.physicsImpostor&&K._PhysicsImpostorParser(t,a,n),n.actions!==void 0&&(a._waitingData.actions=n.actions),n.animations){for(let l=0;l<n.animations.length;l++){const c=n.animations[l],h=Xr("BABYLON.Animation");h&&a.animations.push(h.Parse(c))}ii.ParseAnimationRanges(a,n,t),n.autoAnimate&&t.beginAnimation(a,n.autoAnimateFrom,n.autoAnimateTo,n.autoAnimateLoop,n.autoAnimateSpeed||1)}}if(e.thinInstances){const s=e.thinInstances;if(r.thinInstanceEnablePicking=!!s.enablePicking,s.matrixData?(r.thinInstanceSetBuffer("matrix",new Float32Array(s.matrixData),16,!1),r._thinInstanceDataStorage.matrixBufferSize=s.matrixBufferSize,r._thinInstanceDataStorage.instancesCount=s.instancesCount):r._thinInstanceDataStorage.matrixBufferSize=s.matrixBufferSize,e.thinInstances.userThinInstance){const n=e.thinInstances.userThinInstance;for(const a in n.data)r.thinInstanceSetBuffer(a,new Float32Array(n.data[a]),n.strides[a],!1),r._userThinInstanceBuffersStorage.sizes[a]=n.sizes[a]}}return r}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const t=this.getVerticesData(O.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(O.PositionKind)||this.setVerticesData(O.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const t=this.getVerticesData(O.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(O.NormalKind)||this.setVerticesData(O.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(O.PositionKind))return this;if(!this.isVerticesDataPresent(O.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(O.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(O.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const T=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=T}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let r=this.getVerticesData(O.PositionKind);if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r));let s=this.getVerticesData(O.NormalKind);if(t){if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s))}const n=this.getVerticesData(O.MatricesIndicesKind),a=this.getVerticesData(O.MatricesWeightsKind);if(!a||!n)return this;const l=this.numBoneInfluencers>4,c=l?this.getVerticesData(O.MatricesIndicesExtraKind):null,h=l?this.getVerticesData(O.MatricesWeightsExtraKind):null,u=e.getTransformMatrices(this),d=x.Zero(),f=new H,_=new H;let p=0,m;for(let T=0;T<r.length;T+=3,p+=4){let b;for(m=0;m<4;m++)b=a[p+m],b>0&&(H.FromFloat32ArrayToRefScaled(u,Math.floor(n[p+m]*16),b,_),f.addToSelf(_));if(l)for(m=0;m<4;m++)b=h[p+m],b>0&&(H.FromFloat32ArrayToRefScaled(u,Math.floor(c[p+m]*16),b,_),f.addToSelf(_));x.TransformCoordinatesFromFloatsToRef(i._sourcePositions[T],i._sourcePositions[T+1],i._sourcePositions[T+2],f,d),d.toArray(r,T),t&&(x.TransformNormalFromFloatsToRef(i._sourceNormals[T],i._sourceNormals[T+1],i._sourceNormals[T+2],f,d),d.toArray(s,T)),f.reset()}return this.updateVerticesData(O.PositionKind,r),t&&this.updateVerticesData(O.NormalKind,s),this}static MinMax(e){let t=null,i=null;return e.forEach(function(r){const n=r.getBoundingInfo().boundingBox;!t||!i?(t=n.minimumWorld,i=n.maximumWorld):(t.minimizeInPlace(n.minimumWorld),i.maximizeInPlace(n.maximumWorld))}),!t||!i?{min:x.Zero(),max:x.Zero()}:{min:t,max:i}}static Center(e){const t=e instanceof Array?K.MinMax(e):e;return x.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,r,s,n){return am(K._MergeMeshesCoroutine(e,t,i,r,s,n,!1))}static MergeMeshesAsync(e,t=!0,i,r,s,n){return pT(K._MergeMeshesCoroutine(e,t,i,r,s,n,!0),xS())}static*_MergeMeshesCoroutine(e,t=!0,i,r,s,n,a){if(e=e.filter(Boolean),e.length===0)return null;let l;if(!i){let P=0;for(l=0;l<e.length;l++)if(P+=e[l].getTotalVertices(),P>=65536)return X.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}n&&(s=!1);const c=new Array,h=new Array,u=new Array,d=e[0].overrideMaterialSideOrientation;for(l=0;l<e.length;l++){const P=e[l];if(P.isAnInstance)return X.Warn("Cannot merge instance meshes."),null;if(d!==P.overrideMaterialSideOrientation)return X.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),null;if(s&&u.push(P.getTotalIndices()),n)if(P.material){const D=P.material;if(D instanceof $a){for(let w=0;w<D.subMaterials.length;w++)c.indexOf(D.subMaterials[w])<0&&c.push(D.subMaterials[w]);for(let w=0;w<P.subMeshes.length;w++)h.push(c.indexOf(D.subMaterials[P.subMeshes[w].materialIndex])),u.push(P.subMeshes[w].indexCount)}else{c.indexOf(D)<0&&c.push(D);for(let w=0;w<P.subMeshes.length;w++)h.push(c.indexOf(D)),u.push(P.subMeshes[w].indexCount)}}else for(let D=0;D<P.subMeshes.length;D++)h.push(0),u.push(P.subMeshes[D].indexCount)}const f=e[0],_=P=>{const D=P.computeWorldMatrix(!0);return[Oe.ExtractFromMesh(P,!1,!1),D]},[p,m]=_(f);a&&(yield);const T=new Array(e.length-1);for(let P=1;P<e.length;P++)T[P-1]=_(e[P]),a&&(yield);const b=p._mergeCoroutine(m,T,i,a,!t);let y=b.next();for(;!y.done;)a&&(yield),y=b.next();const S=y.value;r||(r=new K(f.name+"_merged",f.getScene()));const C=S._applyToCoroutine(r,void 0,a);let I=C.next();for(;!I.done;)a&&(yield),I=C.next();if(r.checkCollisions=f.checkCollisions,r.overrideMaterialSideOrientation=f.overrideMaterialSideOrientation,t)for(l=0;l<e.length;l++)e[l].dispose();if(s||n){r.releaseSubMeshes(),l=0;let P=0;for(;l<u.length;)qs.CreateFromIndices(0,P,u[l],r,void 0,!1),P+=u[l],l++;for(const D of r.subMeshes)D.refreshBoundingInfo();r.computeWorldMatrix(!0)}if(n){const P=new $a(f.name+"_merged",f.getScene());P.subMaterials=c;for(let D=0;D<r.subMeshes.length;D++)r.subMeshes[D].materialIndex=h[D];r.material=P}else r.material=f.material;return r}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){const t=e._indexInSourceMeshInstanceArray;if(t!=-1){if(t!==this.instances.length-1){const i=this.instances[this.instances.length-1];this.instances[t]=i,i._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this.overrideMaterialSideOrientation===me.CounterClockWiseSideOrientation}}K.FRONTSIDE=Oe.FRONTSIDE;K.BACKSIDE=Oe.BACKSIDE;K.DOUBLESIDE=Oe.DOUBLESIDE;K.DEFAULTSIDE=Oe.DEFAULTSIDE;K.NO_CAP=0;K.CAP_START=1;K.CAP_END=2;K.CAP_ALL=3;K.NO_FLIP=0;K.FLIP_TILE=1;K.ROTATE_TILE=2;K.FLIP_ROW=3;K.ROTATE_ROW=4;K.FLIP_N_ROTATE_TILE=5;K.FLIP_N_ROTATE_ROW=6;K.CENTER=0;K.LEFT=1;K.RIGHT=2;K.TOP=3;K.BOTTOM=4;K.INSTANCEDMESH_SORT_TRANSPARENT=!1;K._GroundMeshParser=(o,e)=>{throw pt("GroundMesh")};K._GoldbergMeshParser=(o,e)=>{throw pt("GoldbergMesh")};K._LinesMeshParser=(o,e)=>{throw pt("LinesMesh")};ye("BABYLON.Mesh",K);K.prototype.setMaterialByID=function(o){return this.setMaterialById(o)};K.CreateDisc=K.CreateDisc||(()=>{throw new Error("Import MeshBuilder to populate this function")});K.CreateBox=K.CreateBox||(()=>{throw new Error("Import MeshBuilder to populate this function")});K.CreateSphere=K.CreateSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")});K.CreateCylinder=K.CreateCylinder||(()=>{throw new Error("Import MeshBuilder to populate this function")});K.CreateTorusKnot=K.CreateTorusKnot||(()=>{throw new Error("Import MeshBuilder to populate this function")});K.CreateTorus=K.CreateTorus||(()=>{throw new Error("Import MeshBuilder to populate this function")});K.CreatePlane=K.CreatePlane||(()=>{throw new Error("Import MeshBuilder to populate this function")});K.CreateGround=K.CreateGround||(()=>{throw new Error("Import MeshBuilder to populate this function")});K.CreateTiledGround=K.CreateTiledGround||(()=>{throw new Error("Import MeshBuilder to populate this function")});K.CreateGroundFromHeightMap=K.CreateGroundFromHeightMap||(()=>{throw new Error("Import MeshBuilder to populate this function")});K.CreateTube=K.CreateTube||(()=>{throw new Error("Import MeshBuilder to populate this function")});K.CreatePolyhedron=K.CreatePolyhedron||(()=>{throw new Error("Import MeshBuilder to populate this function")});K.CreateIcoSphere=K.CreateIcoSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")});K.CreateDecal=K.CreateDecal||(()=>{throw new Error("Import MeshBuilder to populate this function")});K.CreateCapsule=K.CreateCapsule||(()=>{throw new Error("Import MeshBuilder to populate this function")});K.ExtendToGoldberg=K.ExtendToGoldberg||(()=>{throw new Error("Import MeshBuilder to populate this function")});K._instancedMeshFactory=(o,e)=>{const t=new $c(o,e);if(e.instancedBuffers){t.instancedBuffers={};for(const i in e.instancedBuffers)t.instancedBuffers[i]=e.instancedBuffers[i]}return t};class $c extends Qt{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(const i of t.getAnimationRanges())i!=null&&this.createAnimationRange(i.name,i.from,i.to);this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}get material(){return this._sourceMesh.material}get visibility(){return this._sourceMesh.visibility}get skeleton(){return this._sourceMesh.skeleton}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||X.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t){return this._sourceMesh.getVerticesData(e,t)}setVerticesData(e,t,i,r){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,r),this.sourceMesh}updateVerticesData(e,t,i,r){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,r),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(e,t),i),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||X.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==gt.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new H);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,j.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(j.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const t=this.sourceMesh.getLODLevels();if(!t||t.length===0)this._currentLOD=this.sourceMesh;else{const i=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,i.boundingSphere)}return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,i,r){const s=(r||this._sourceMesh).createInstance(e);if(Sn.DeepCopy(this,s,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),t&&(s.parent=t),!i)for(let n=0;n<this.getScene().meshes.length;n++){const a=this.getScene().meshes[n];a.parent===this&&a.clone(a.name,s)}return s.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(s),s}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,i){const r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);r&&i&&i(this,r);for(const s of this.getChildTransformNodes(!0))s.instantiateHierarchy(r,t,i);return r}}K.prototype.registerInstancedBuffer=function(o,e){var t,i;if((i=(t=this._userInstancedBuffersStorage)===null||t===void 0?void 0:t.vertexBuffers[o])===null||i===void 0||i.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const r of this.instances)r.instancedBuffers={};this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0})}this.instancedBuffers[o]=null,this._userInstancedBuffersStorage.strides[o]=e,this._userInstancedBuffersStorage.sizes[o]=e*32,this._userInstancedBuffersStorage.data[o]=new Float32Array(this._userInstancedBuffersStorage.sizes[o]),this._userInstancedBuffersStorage.vertexBuffers[o]=new O(this.getEngine(),this._userInstancedBuffersStorage.data[o],o,!0,!1,e,!0);for(const r of this.instances)r.instancedBuffers[o]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()};K.prototype._processInstancedBuffers=function(o,e){const t=o?o.length:0;for(const i in this.instancedBuffers){let r=this._userInstancedBuffersStorage.sizes[i];const s=this._userInstancedBuffersStorage.strides[i],n=(t+1)*s;for(;r<n;)r*=2;this._userInstancedBuffersStorage.data[i].length!=r&&(this._userInstancedBuffersStorage.data[i]=new Float32Array(r),this._userInstancedBuffersStorage.sizes[i]=r,this._userInstancedBuffersStorage.vertexBuffers[i]&&(this._userInstancedBuffersStorage.vertexBuffers[i].dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null));const a=this._userInstancedBuffersStorage.data[i];let l=0;if(e){const c=this.instancedBuffers[i];c.toArray?c.toArray(a,l):c.copyToArray?c.copyToArray(a,l):a[l]=c,l+=s}for(let c=0;c<t;c++){const u=o[c].instancedBuffers[i];u.toArray?u.toArray(a,l):u.copyToArray?u.copyToArray(a,l):a[l]=u,l+=s}this._userInstancedBuffersStorage.vertexBuffers[i]?this._userInstancedBuffersStorage.vertexBuffers[i].updateDirectly(a,0):(this._userInstancedBuffersStorage.vertexBuffers[i]=new O(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,s,!0),this._invalidateInstanceVertexArrayObject())}};K.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(const o in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[o]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};K.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(const o in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[o]&&this._userInstancedBuffersStorage.vertexBuffers[o].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};class St extends ii{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}constructor(e,t){super(e,t),this.diffuse=new ge(1,1,1),this.specular=new ge(1,1,1),this.falloffType=St.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=St.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new $e(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=new Array,this.excludedMeshes=new Array,this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,r,s=!0){var n;const a=e.toString();let l=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+a),this._renderId!==t.getRenderId()||this._lastUseSpecular!==r||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=r;const c=this.getScaledIntensity();this.transferToEffect(i,a),this.diffuse.scaleToRef(c,Jt.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",Jt.Color3[0],this.range,a),r&&(this.specular.scaleToRef(c,Jt.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",Jt.Color3[1],this.radius,a)),l=!0}if(this.transferTexturesToEffect(i,a),t.shadowsEnabled&&this.shadowEnabled&&s){const c=(n=this.getShadowGenerator(t.activeCamera))!==null&&n!==void 0?n:this.getShadowGenerator();c&&(c.bindShadowLight(a,i),l=!0)}l?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){var t;return this._shadowGenerators===null?null:(t=this._shadowGenerators.get(e))!==null&&t!==void 0?t:null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return x.Zero()}canAffectMesh(e){return e?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(e)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1||this.includeOnlyWithLayerMask!==0&&!(this.includeOnlyWithLayerMask&e.layerMask)||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&e.layerMask):!0}dispose(e,t=!1){if(this._shadowGenerators){const i=this._shadowGenerators.values();for(let r=i.next();r.done!==!0;r=i.next())r.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){const i=this._parentContainer.lights.indexOf(this);i>-1&&this._parentContainer.lights.splice(i,1),this._parentContainer=null}for(const i of this.getScene().meshes)i._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const i=St.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;const r=ke.Clone(i,this);return e&&(r.name=e),t&&(r.parent=t),r.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(r),r}serialize(){const e=ke.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach(t=>{e.excludedMeshesIds.push(t.id)})),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(t=>{e.includedOnlyMeshesIds.push(t.id)})),ke.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){const r=ii.Construct("Light_Type_"+e,t,i);return r||null}static Parse(e,t){const i=St.GetConstructorFromName(e.type,e.name,t);if(!i)return null;const r=ke.Parse(i,e,t);if(e.excludedMeshesIds&&(r._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(r._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.falloffType!==void 0&&(r.falloffType=e.falloffType),e.lightmapMode!==void 0&&(r.lightmapMode=e.lightmapMode),e.animations){for(let s=0;s<e.animations.length;s++){const n=e.animations[s],a=Xr("BABYLON.Animation");a&&r.animations.push(a.Parse(n))}ii.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&r.setEnabled(e.isEnabled),r}_hookArrayForExcluded(e){const t=e.push;e.push=(...r)=>{const s=t.apply(e,r);for(const n of r)n._resyncLightSource(this);return s};const i=e.splice;e.splice=(r,s)=>{const n=i.apply(e,[r,s]);for(const a of n)a._resyncLightSource(this);return n};for(const r of e)r._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...r)=>{const s=t.apply(e,r);return this._resyncMeshes(),s};const i=e.splice;e.splice=(r,s)=>{const n=i.apply(e,[r,s]);return this._resyncMeshes(),n},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)e.lightSources.indexOf(this)!==-1&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const t=this.getTypeID();let i=this.intensityMode;switch(i===St.INTENSITYMODE_AUTOMATIC&&(t===St.LIGHTTYPEID_DIRECTIONALLIGHT?i=St.INTENSITYMODE_ILLUMINANCE:i=St.INTENSITYMODE_LUMINOUSINTENSITY),t){case St.LIGHTTYPEID_POINTLIGHT:case St.LIGHTTYPEID_SPOTLIGHT:switch(i){case St.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case St.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case St.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;break}break;case St.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case St.INTENSITYMODE_ILLUMINANCE:e=1;break;case St.INTENSITYMODE_LUMINANCE:{let r=this.radius;r=Math.max(r,.001),e=2*Math.PI*(1-Math.cos(r));break}}break;case St.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;break}return e}_reorderLightsInScene(){const e=this.getScene();this._renderPriority!=0&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}}St.FALLOFF_DEFAULT=fi.FALLOFF_DEFAULT;St.FALLOFF_PHYSICAL=fi.FALLOFF_PHYSICAL;St.FALLOFF_GLTF=fi.FALLOFF_GLTF;St.FALLOFF_STANDARD=fi.FALLOFF_STANDARD;St.LIGHTMAP_DEFAULT=fi.LIGHTMAP_DEFAULT;St.LIGHTMAP_SPECULAR=fi.LIGHTMAP_SPECULAR;St.LIGHTMAP_SHADOWSONLY=fi.LIGHTMAP_SHADOWSONLY;St.INTENSITYMODE_AUTOMATIC=fi.INTENSITYMODE_AUTOMATIC;St.INTENSITYMODE_LUMINOUSPOWER=fi.INTENSITYMODE_LUMINOUSPOWER;St.INTENSITYMODE_LUMINOUSINTENSITY=fi.INTENSITYMODE_LUMINOUSINTENSITY;St.INTENSITYMODE_ILLUMINANCE=fi.INTENSITYMODE_ILLUMINANCE;St.INTENSITYMODE_LUMINANCE=fi.INTENSITYMODE_LUMINANCE;St.LIGHTTYPEID_POINTLIGHT=fi.LIGHTTYPEID_POINTLIGHT;St.LIGHTTYPEID_DIRECTIONALLIGHT=fi.LIGHTTYPEID_DIRECTIONALLIGHT;St.LIGHTTYPEID_SPOTLIGHT=fi.LIGHTTYPEID_SPOTLIGHT;St.LIGHTTYPEID_HEMISPHERICLIGHT=fi.LIGHTTYPEID_HEMISPHERICLIGHT;M([Kr()],St.prototype,"diffuse",void 0);M([Kr()],St.prototype,"specular",void 0);M([F()],St.prototype,"falloffType",void 0);M([F()],St.prototype,"intensity",void 0);M([F()],St.prototype,"range",null);M([F()],St.prototype,"intensityMode",null);M([F()],St.prototype,"radius",null);M([F()],St.prototype,"_renderPriority",void 0);M([Te("_reorderLightsInScene")],St.prototype,"renderPriority",void 0);M([F("shadowEnabled")],St.prototype,"_shadowEnabled",void 0);M([F("excludeWithLayerMask")],St.prototype,"_excludeWithLayerMask",void 0);M([F("includeOnlyWithLayerMask")],St.prototype,"_includeOnlyWithLayerMask",void 0);M([F("lightmapMode")],St.prototype,"_lightmapMode",void 0);class OS extends Er{}class DS{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach(e=>{e.dispose()}),this.rootNodes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0}}class vT extends Er{constructor(e){super(),this._wasAddedToScene=!1,e=e||qe.LastCreatedScene,e&&(this.scene=e,this.sounds=[],this.effectLayers=[],this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.reflectionProbes=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(const t of this.geometries)t._rebuild();for(const t of this.meshes)t._rebuild();for(const t of this.particleSystems)t.rebuild();for(const t of this.textures)t._rebuild()}))}_topologicalSort(e){const t=new Map;for(const a of e)t.set(a.uniqueId,a);const i={dependsOn:new Map,dependedBy:new Map};for(const a of e){const l=a.uniqueId;i.dependsOn.set(l,new Set),i.dependedBy.set(l,new Set)}for(const a of e){const l=a.uniqueId,c=i.dependsOn.get(l);if(a instanceof $c){const u=a.sourceMesh;t.has(u.uniqueId)&&(c.add(u.uniqueId),i.dependedBy.get(u.uniqueId).add(l))}const h=i.dependedBy.get(l);for(const u of a.getDescendants()){const d=u.uniqueId;t.has(d)&&(h.add(d),i.dependsOn.get(d).add(l))}}const r=[],s=[];for(const a of e){const l=a.uniqueId;i.dependsOn.get(l).size===0&&(s.push(a),t.delete(l))}const n=s;for(;n.length>0;){const a=n.shift();r.push(a);const l=i.dependedBy.get(a.uniqueId);for(const c of Array.from(l.values())){const h=i.dependsOn.get(c);h.delete(a.uniqueId),h.size===0&&t.get(c)&&(n.push(t.get(c)),t.delete(c))}}return t.size>0&&(console.error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(a=>console.error(a.name))),r}_addNodeAndDescendantsToList(e,t,i,r){if(!(r&&!r(i)||t.has(i.uniqueId))){e.push(i),t.add(i.uniqueId);for(const s of i.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,s,r)}}_isNodeInContainer(e){return e instanceof K&&this.meshes.indexOf(e)!==-1||e instanceof gt&&this.transformNodes.indexOf(e)!==-1||e instanceof St&&this.lights.indexOf(e)!==-1||e instanceof Ve&&this.cameras.indexOf(e)!==-1}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return X.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return X.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return X.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return X.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||J.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const r={},s={},n=new DS,a=[],l=[],c={doNotInstantiate:!0,...i};c.doNotInstantiate||(c.doNotInstantiate=p=>!!p.skeleton);const h=(p,m)=>{if(r[p.uniqueId]=m.uniqueId,s[m.uniqueId]=m,e&&(m.name=e(p.name)),m instanceof K){const T=m;if(T.morphTargetManager){const b=p.morphTargetManager;T.morphTargetManager=b.clone();for(let y=0;y<b.numTargets;y++){const S=b.getTarget(y),C=T.morphTargetManager.getTarget(y);r[S.uniqueId]=C.uniqueId,s[C.uniqueId]=C}}}},u=[],d=new Set;for(const p of this.transformNodes)p.parent===null&&this._addNodeAndDescendantsToList(u,d,p,c.predicate);for(const p of this.meshes)p.parent===null&&this._addNodeAndDescendantsToList(u,d,p,c.predicate);const f=this._topologicalSort(u),_=(p,m)=>{if(h(p,m),p.parent){const T=r[p.parent.uniqueId],b=s[T];b?m.parent=b:m.parent=p.parent}if(m.position.copyFrom(p.position),m.rotation.copyFrom(p.rotation),m.scaling.copyFrom(p.scaling),m.material){const T=m;if(T.material)if(t){const b=p.material;if(l.indexOf(b)===-1){let y=b.clone(e?e(b.name):"Clone of "+b.name);if(l.push(b),r[b.uniqueId]=y.uniqueId,s[y.uniqueId]=y,b.getClassName()==="MultiMaterial"){const S=b;for(const C of S.subMaterials)C&&(y=C.clone(e?e(C.name):"Clone of "+C.name),l.push(C),r[C.uniqueId]=y.uniqueId,s[y.uniqueId]=y);S.subMaterials=S.subMaterials.map(C=>C&&s[r[C.uniqueId]])}}T.getClassName()!=="InstancedMesh"&&(T.material=s[r[b.uniqueId]])}else T.material.getClassName()==="MultiMaterial"?this.scene.multiMaterials.indexOf(T.material)===-1&&this.scene.addMultiMaterial(T.material):this.scene.materials.indexOf(T.material)===-1&&this.scene.addMaterial(T.material)}m.parent===null&&n.rootNodes.push(m)};return f.forEach(p=>{if(p.getClassName()==="InstancedMesh"){const m=p,T=m.sourceMesh,b=r[T.uniqueId],S=(typeof b=="number"?s[b]:T).createInstance(m.name);_(m,S)}else{const T=!(c!=null&&c.doNotInstantiate)&&p.getTotalVertices()>0?p.createInstance(`instance of ${p.name}`):p.clone(`Clone of ${p.name}`,null,!0);if(!T)throw new Error(`Could not clone or instantiate node on Asset Container ${p.name}`);_(p,T)}}),this.skeletons.forEach(p=>{if(c.predicate&&!c.predicate(p))return;const m=p.clone(e?e(p.name):"Clone of "+p.name);for(const T of this.meshes)if(T.skeleton===p&&!T.isAnInstance){const b=s[r[T.uniqueId]];if(b.isAnInstance||(b.skeleton=m,a.indexOf(m)!==-1))continue;a.push(m);for(const y of m.bones)y._linkedTransformNode&&(y._linkedTransformNode=s[r[y._linkedTransformNode.uniqueId]])}n.skeletons.push(m)}),this.animationGroups.forEach(p=>{if(c.predicate&&!c.predicate(p))return;const m=p.clone(e?e(p.name):"Clone of "+p.name,T=>s[r[T.uniqueId]]||T);n.animationGroups.push(m)}),n}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||J.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.addCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.addLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.addMesh(t)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.addSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.addAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.addAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.addMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.addMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.addMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.addGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.addTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.addActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.addTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.addReflectionProbe(t)})}removeAllFromScene(){this._isValidHierarchy()||J.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.removeCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.removeLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.removeMesh(t)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.removeSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.removeAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.removeAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.removeMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.removeMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.removeMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.removeGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.removeTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.removeActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.removeTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.removeReflectionProbe(t)})}dispose(){this.cameras.slice(0).forEach(e=>{e.dispose()}),this.cameras.length=0,this.lights.slice(0).forEach(e=>{e.dispose()}),this.lights.length=0,this.meshes.slice(0).forEach(e=>{e.dispose()}),this.meshes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach(e=>{e.dispose()}),this.multiMaterials.length=0,this.materials.slice(0).forEach(e=>{e.dispose()}),this.materials.length=0,this.geometries.slice(0).forEach(e=>{e.dispose()}),this.geometries.length=0,this.transformNodes.slice(0).forEach(e=>{e.dispose()}),this.transformNodes.length=0,this.actionManagers.slice(0).forEach(e=>{e.dispose()}),this.actionManagers.length=0,this.textures.slice(0).forEach(e=>{e.dispose()}),this.textures.length=0,this.reflectionProbes.slice(0).forEach(e=>{e.dispose()}),this.reflectionProbes.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(!(!e||!t))for(const r of e){let s=!0;if(i){for(const n of i)if(r===n){s=!1;break}}s&&(t.push(r),r._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,e===void 0&&(e=new OS);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||(t==="_environmentTexture"?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new K("assetContainerRootMesh",this.scene);return this.meshes.forEach(t=>{t.parent||e.addChild(t)}),this.meshes.unshift(e),e}mergeAnimationsTo(e=qe.LastCreatedScene,t,i=null){if(!e)return X.Error("No scene available to merge animations to"),[];const r=i||(a=>{let l=null;const c=a.animations.length?a.animations[0].targetProperty:"",h=a.name.split(".").join("").split("_primitive")[0];switch(c){case"position":case"rotationQuaternion":l=e.getTransformNodeByName(a.name)||e.getTransformNodeByName(h);break;case"influence":l=e.getMorphTargetByName(a.name)||e.getMorphTargetByName(h);break;default:l=e.getNodeByName(a.name)||e.getNodeByName(h)}return l});this.getNodes().forEach(a=>{const l=r(a);if(l!==null){for(const c of a.animations){const h=l.animations.filter(u=>u.targetProperty===c.targetProperty);for(const u of h){const d=l.animations.indexOf(u,0);d>-1&&l.animations.splice(d,1)}}l.animations=l.animations.concat(a.animations)}});const n=new Array;return this.animationGroups.slice().forEach(a=>{n.push(a.clone(a.name,r)),a.animatables.forEach(l=>{l.stop()})}),t.forEach(a=>{const l=r(a.target);l&&(e.beginAnimation(l,a.fromFrame,a.toFrame,a.loopAnimation,a.speedRatio,a.onAnimationEnd?a.onAnimationEnd:void 0,void 0,!0,void 0,a.onAnimationLoop?a.onAnimationLoop:void 0),e.stopAnimation(a.target))}),n}}q.AudioEngineFactory=(o,e,t)=>new NS(o,e,t);class NS{get audioContext(){return this._audioContextInitialized?!this.unlocked&&!this._muteButton&&this._displayMuteButton():this._initializeAudioContext(),this._audioContext}constructor(e=null,t=null,i=null){if(this._audioContext=null,this._audioContextInitialized=!1,this._muteButton=null,this._audioDestination=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!0,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new Q,this.onAudioLockedObservable=new Q,this._tryToRun=!1,this._onResize=()=>{this._moveButtonToTopLeft()},!Ar())return;typeof window.AudioContext<"u"&&(this.canUseWebAudio=!0);const r=document.createElement("audio");this._hostElement=e,this._audioContext=t,this._audioDestination=i;try{r&&r.canPlayType&&(r.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||r.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch{}try{r&&r.canPlayType&&r.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch{}}lock(){this._triggerSuspendedState()}unlock(){this._triggerRunningState()}_resumeAudioContext(){let e;return this._audioContext.resume!==void 0&&(e=this._audioContext.resume()),e||Promise.resolve()}_initializeAudioContext(){try{this.canUseWebAudio&&(this._audioContext||(this._audioContext=new AudioContext),this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this._audioDestination||(this._audioDestination=this._audioContext.destination),this.masterGain.connect(this._audioDestination),this._audioContextInitialized=!0,this._audioContext.state==="running"&&this._triggerRunningState())}catch(e){this.canUseWebAudio=!1,X.Error("Web Audio: "+e.message)}}_triggerRunningState(){this._tryToRun||(this._tryToRun=!0,this._resumeAudioContext().then(()=>{this._tryToRun=!1,this._muteButton&&this._hideMuteButton(),this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)}).catch(()=>{this._tryToRun=!1,this.unlocked=!1}))}_triggerSuspendedState(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this._displayMuteButton()}_displayMuteButton(){if(this.useCustomUnlockedButton||this._muteButton)return;this._muteButton=document.createElement("BUTTON"),this._muteButton.className="babylonUnmuteIcon",this._muteButton.id="babylonUnmuteIconBtn",this._muteButton.title="Unmute";const t=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png")+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",i=document.createElement("style");i.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(i),document.body.appendChild(this._muteButton),this._moveButtonToTopLeft(),this._muteButton.addEventListener("touchend",()=>{this._triggerRunningState()},!0),this._muteButton.addEventListener("click",()=>{this._triggerRunningState()},!0),window.addEventListener("resize",this._onResize)}_moveButtonToTopLeft(){this._hostElement&&this._muteButton&&(this._muteButton.style.top=this._hostElement.offsetTop+20+"px",this._muteButton.style.left=this._hostElement.offsetLeft+20+"px")}_hideMuteButton(){this._muteButton&&(document.body.removeChild(this._muteButton),this._muteButton=null)}dispose(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this._hideMuteButton(),window.removeEventListener("resize",this._onResize),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1}setGlobalVolume(e){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=e)}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))}}class Ga{get loop(){return this._loop}set loop(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}))}get currentTime(){var e;if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if(!((e=q.audioEngine)===null||e===void 0)&&e.audioContext&&(this.isPlaying||this.isPaused)){const t=this.isPaused?0:q.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+t}return 0}get spatialSound(){return this._spatialSound}set spatialSound(e){var t;this._spatialSound=e,this._spatialSound&&(!((t=q.audioEngine)===null||t===void 0)&&t.canUseWebAudio)&&q.audioEngine.audioContext&&this._createSpatialParameters()}constructor(e,t,i,r=null,s){var n,a,l,c,h;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new Q,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=x.Zero(),this._localDirection=new x(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,i=i||qe.LastCreatedScene,!!i)if(this._scene=i,Ga._SceneComponentInitialization(i),this._readyToPlayCallback=r,this._customAttenuationFunction=(u,d,f,_,p)=>d<f?u*(1-d/f):0,s&&(this.autoplay=s.autoplay||!1,this._loop=s.loop||!1,s.volume!==void 0&&(this._volume=s.volume),this._spatialSound=(n=s.spatialSound)!==null&&n!==void 0?n:!1,this.maxDistance=(a=s.maxDistance)!==null&&a!==void 0?a:100,this.useCustomAttenuation=(l=s.useCustomAttenuation)!==null&&l!==void 0?l:!1,this.rolloffFactor=s.rolloffFactor||1,this.refDistance=s.refDistance||1,this.distanceModel=s.distanceModel||"linear",this._playbackRate=s.playbackRate||1,this._streaming=(c=s.streaming)!==null&&c!==void 0?c:!1,this._length=s.length,this._offset=s.offset),!((h=q.audioEngine)===null||h===void 0)&&h.canUseWebAudio&&q.audioEngine.audioContext){this._soundGain=q.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let u=!0;if(t)try{typeof t=="string"?this._urlType="String":t instanceof ArrayBuffer?this._urlType="ArrayBuffer":t instanceof HTMLMediaElement?this._urlType="MediaElement":t instanceof MediaStream?this._urlType="MediaStream":t instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(t)&&(this._urlType="Array");let d=[],f=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=q.audioEngine.audioContext.createMediaElementSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=q.audioEngine.audioContext.createMediaStreamSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":t.byteLength>0&&(f=!0,this._soundLoaded(t));break;case"AudioBuffer":this._audioBufferLoaded(t);break;case"String":d.push(t);case"Array":d.length===0&&(d=t);for(let _=0;_<d.length;_++){const p=d[_];if(f=s&&s.skipCodecCheck||p.indexOf(".mp3",p.length-4)!==-1&&q.audioEngine.isMP3supported||p.indexOf(".ogg",p.length-4)!==-1&&q.audioEngine.isOGGsupported||p.indexOf(".wav",p.length-4)!==-1||p.indexOf(".m4a",p.length-4)!==-1||p.indexOf(".mp4",p.length-4)!==-1||p.indexOf("blob:")!==-1,f){this._streaming?(this._htmlAudioElement=new Audio(p),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,J.SetCorsBehavior(p,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(p,m=>{this._soundLoaded(m)},void 0,!0,!0,m=>{m&&X.Error("XHR "+m.status+" error on: "+p+"."),X.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:u=!1;break}u?f||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):X.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch{X.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),q.audioEngine&&!q.audioEngine.WarnedWebAudioUnsupported&&(X.Error("Web Audio is not supported by your browser."),q.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}dispose(){var e;!((e=q.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._streamingSource&&this._streamingSource.disconnect(),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null))}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(e){var t;!((t=q.audioEngine)===null||t===void 0)&&t.audioContext&&(this._audioBuffer=e,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(e){var t;!((t=q.audioEngine)===null||t===void 0)&&t.audioContext&&q.audioEngine.audioContext.decodeAudioData(e,i=>{this._audioBufferLoaded(i)},i=>{X.Error("Error while decoding audio data for: "+this.name+" / Error: "+i)})}setAudioBuffer(e){var t;!((t=q.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)}updateOptions(e){var t,i,r,s,n,a,l,c,h,u;e&&(this.loop=(t=e.loop)!==null&&t!==void 0?t:this.loop,this.maxDistance=(i=e.maxDistance)!==null&&i!==void 0?i:this.maxDistance,this.useCustomAttenuation=(r=e.useCustomAttenuation)!==null&&r!==void 0?r:this.useCustomAttenuation,this.rolloffFactor=(s=e.rolloffFactor)!==null&&s!==void 0?s:this.rolloffFactor,this.refDistance=(n=e.refDistance)!==null&&n!==void 0?n:this.refDistance,this.distanceModel=(a=e.distanceModel)!==null&&a!==void 0?a:this.distanceModel,this._playbackRate=(l=e.playbackRate)!==null&&l!==void 0?l:this._playbackRate,this._length=(c=e.length)!==null&&c!==void 0?c:void 0,this._setOffset((h=e.offset)!==null&&h!==void 0?h:void 0),this.setVolume((u=e.volume)!==null&&u!==void 0?u:this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))}_createSpatialParameters(){var e,t;!((e=q.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&q.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=(t=this._soundPanner)!==null&&t!==void 0?t:q.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_updateSpatialParameters(){this._spatialSound&&this._soundPanner&&(this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel))}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){var e;!((e=q.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(e){var t;!((t=q.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)}setDirectionalCone(e,t,i){if(t<e){X.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=i,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){var t;if(e!=this._coneInnerAngle){if(this._coneOuterAngle<e){X.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,!((t=q.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){var t;if(e!=this._coneOuterAngle){if(e<this._coneInnerAngle){X.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e,!((t=q.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(e){var t;e.equals(this._position)||(this._position.copyFrom(e),!((t=q.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(e){var t;this._localDirection=e,!((t=q.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;const e=this._connectedTransformNode.getWorldMatrix(),t=x.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.orientationX.value=t.x,this._soundPanner.orientationY.value=t.y,this._soundPanner.orientationZ.value=t.z}updateDistanceFromListener(){var e;if(!((e=q.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){const t=this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(e){this._customAttenuationFunction=e}play(e,t,i){var r,s,n,a;if(this._isReadyToPlay&&this._scene.audioEnabled&&(!((r=q.audioEngine)===null||r===void 0)&&r.audioContext))try{let l=e?((s=q.audioEngine)===null||s===void 0?void 0:s.audioContext.currentTime)+e:(n=q.audioEngine)===null||n===void 0?void 0:n.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(this._streamingSource||(this._streamingSource=q.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement){const c=()=>{var h,u;if(!((h=q.audioEngine)===null||h===void 0)&&h.unlocked){const d=this._htmlAudioElement.play();d!==void 0&&d.catch(()=>{var f,_;(f=q.audioEngine)===null||f===void 0||f.lock(),(this.loop||this.autoplay)&&((_=q.audioEngine)===null||_===void 0||_.onAudioUnlockedObservable.addOnce(()=>{c()}))})}else(this.loop||this.autoplay)&&((u=q.audioEngine)===null||u===void 0||u.onAudioUnlockedObservable.addOnce(()=>{c()}))};c()}}else{const c=()=>{var h,u,d,f;if(!((h=q.audioEngine)===null||h===void 0)&&h.audioContext){if(i=i||this._length,t!==void 0&&this._setOffset(t),this._soundSource){const _=this._soundSource;_.onended=()=>{_.disconnect()}}if(this._soundSource=(u=q.audioEngine)===null||u===void 0?void 0:u.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,t!==void 0&&(this._soundSource.loopStart=t),i!==void 0&&(this._soundSource.loopEnd=(t|0)+i),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},l=e?((d=q.audioEngine)===null||d===void 0?void 0:d.audioContext.currentTime)+e:q.audioEngine.audioContext.currentTime;const _=((this.isPaused?this.currentTime:0)+((f=this._offset)!==null&&f!==void 0?f:0))%this._soundSource.buffer.duration;this._soundSource.start(l,_,this.loop?void 0:i)}}};((a=q.audioEngine)===null||a===void 0?void 0:a.audioContext.state)==="suspended"?setTimeout(()=>{var h;((h=q.audioEngine)===null||h===void 0?void 0:h.audioContext.state)==="suspended"?(q.audioEngine.lock(),(this.loop||this.autoplay)&&q.audioEngine.onAudioUnlockedObservable.addOnce(()=>{c()})):c()},500):c()}this._startTime=l,this.isPlaying=!0,this.isPaused=!1}catch(l){X.Error("Error while trying to play audio: "+this.name+", "+l.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(e){var t;if(this.isPlaying){if(this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource.disconnect(),this.isPlaying=!1;else if(!((t=q.audioEngine)===null||t===void 0)&&t.audioContext&&this._soundSource){const i=e?q.audioEngine.audioContext.currentTime+e:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(i)}}else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){var e;this.isPlaying&&(this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource.disconnect(),this.isPlaying=!1,this.isPaused=!0):!((e=q.audioEngine)===null||e===void 0)&&e.audioContext&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=q.audioEngine.audioContext.currentTime-this._startTime))}setVolume(e,t){var i;!((i=q.audioEngine)===null||i===void 0)&&i.canUseWebAudio&&this._soundGain&&(t&&q.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(q.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,q.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,q.audioEngine.audioContext.currentTime+t)):this._soundGain.gain.value=e),this._volume=e}setPlaybackRate(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=t=>this._onRegisterAfterWorldMatrixUpdate(t),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(e){var t;if(!e.getBoundingInfo)this.setPosition(e.absolutePosition);else{const r=e.getBoundingInfo();this.setPosition(r.boundingSphere.centerWorld)}!((t=q.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{const e=()=>{this._isReadyToPlay?(i._audioBuffer=this.getAudioBuffer(),i._isReadyToPlay=!0,i.autoplay&&i.play(0,this._offset,this._length)):setTimeout(e,300)},t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},i=new Ga(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,t);return this.useCustomAttenuation&&i.setAttenuationFunction(this._customAttenuationFunction),i.setPosition(this._position),i.setPlaybackRate(this._playbackRate),e(),i}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){const e={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e}static Parse(e,t,i,r){const s=e.name;let n;e.url?n=i+e.url:n=i+s;const a={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate};let l;if(!r)l=new Ga(s,n,t,()=>{t.removePendingData(l)},a),t.addPendingData(l);else{const c=()=>{r._isReadyToPlay?(l._audioBuffer=r.getAudioBuffer(),l._isReadyToPlay=!0,l.autoplay&&l.play(0,l._offset,l._length)):setTimeout(c,300)};l=new Ga(s,new ArrayBuffer(0),t,null,a),c()}if(e.position){const c=x.FromArray(e.position);l.setPosition(c)}if(e.isDirectional&&(l.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){const c=x.FromArray(e.localDirectionToMesh);l.setLocalDirectionToMesh(c)}if(e.connectedMeshId){const c=t.getMeshById(e.connectedMeshId);c&&l.attachToMesh(c)}return e.metadata&&(l.metadata=e.metadata),l}_setOffset(e){this._offset!==e&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=e)}}Ga._SceneComponentInitialization=o=>{throw pt("AudioSceneComponent")};class wS{constructor(e,t={}){this.id=-1,this._isInitialized=!1,e=e||qe.LastCreatedScene,e&&(this._scene=e,this.soundCollection=new Array,this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){var e;!((e=q.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&q.audioEngine.audioContext&&(this._outputAudioNode=q.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(q.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(q.audioEngine&&q.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){var t;this._isInitialized||this._initializeSoundTrackAudioGraph(),!((t=q.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),e.soundTrackId&&(e.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){const t=this.soundCollection.indexOf(e);t!==-1&&this.soundCollection.splice(t,1)}setVolume(e){var t;!((t=q.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){var e;if(!((e=q.audioEngine)===null||e===void 0)&&e.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){var e;if(!((e=q.audioEngine)===null||e===void 0)&&e.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToEqualPower()}connectToAnalyser(e){var t;this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,!((t=q.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,q.audioEngine.masterGain))}}Er.AddParser(Re.NAME_AUDIO,(o,e,t,i)=>{var r;let s=[],n;if(t.sounds=t.sounds||[],o.sounds!==void 0&&o.sounds!==null)for(let a=0,l=o.sounds.length;a<l;a++){const c=o.sounds[a];!((r=q.audioEngine)===null||r===void 0)&&r.canUseWebAudio?(c.url||(c.url=c.name),s[c.url]?t.sounds.push(Ga.Parse(c,e,i,s[c.url])):(n=Ga.Parse(c,e,i),s[c.url]=n,t.sounds.push(n))):t.sounds.push(new Ga(c.name,null,e))}s=[]});Object.defineProperty(Ne.prototype,"mainSoundTrack",{get:function(){let o=this._getComponent(Re.NAME_AUDIO);return o||(o=new Nn(this),this._addComponent(o)),this._mainSoundTrack||(this._mainSoundTrack=new wS(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0});Ne.prototype.getSoundByName=function(o){let e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++)if(this.mainSoundTrack.soundCollection[e].name===o)return this.mainSoundTrack.soundCollection[e];if(this.soundTracks){for(let t=0;t<this.soundTracks.length;t++)for(e=0;e<this.soundTracks[t].soundCollection.length;e++)if(this.soundTracks[t].soundCollection[e].name===o)return this.soundTracks[t].soundCollection[e]}return null};Object.defineProperty(Ne.prototype,"audioEnabled",{get:function(){let o=this._getComponent(Re.NAME_AUDIO);return o||(o=new Nn(this),this._addComponent(o)),o.audioEnabled},set:function(o){let e=this._getComponent(Re.NAME_AUDIO);e||(e=new Nn(this),this._addComponent(e)),o?e.enableAudio():e.disableAudio()},enumerable:!0,configurable:!0});Object.defineProperty(Ne.prototype,"headphone",{get:function(){let o=this._getComponent(Re.NAME_AUDIO);return o||(o=new Nn(this),this._addComponent(o)),o.headphone},set:function(o){let e=this._getComponent(Re.NAME_AUDIO);e||(e=new Nn(this),this._addComponent(e)),o?e.switchAudioModeForHeadphones():e.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0});Object.defineProperty(Ne.prototype,"audioListenerPositionProvider",{get:function(){let o=this._getComponent(Re.NAME_AUDIO);return o||(o=new Nn(this),this._addComponent(o)),o.audioListenerPositionProvider},set:function(o){let e=this._getComponent(Re.NAME_AUDIO);if(e||(e=new Nn(this),this._addComponent(e)),typeof o!="function")throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");e.audioListenerPositionProvider=o},enumerable:!0,configurable:!0});Object.defineProperty(Ne.prototype,"audioListenerRotationProvider",{get:function(){let o=this._getComponent(Re.NAME_AUDIO);return o||(o=new Nn(this),this._addComponent(o)),o.audioListenerRotationProvider},set:function(o){let e=this._getComponent(Re.NAME_AUDIO);if(e||(e=new Nn(this),this._addComponent(e)),typeof o!="function")throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");e.audioListenerRotationProvider=o},enumerable:!0,configurable:!0});Object.defineProperty(Ne.prototype,"audioPositioningRefreshRate",{get:function(){let o=this._getComponent(Re.NAME_AUDIO);return o||(o=new Nn(this),this._addComponent(o)),o.audioPositioningRefreshRate},set:function(o){let e=this._getComponent(Re.NAME_AUDIO);e||(e=new Nn(this),this._addComponent(e)),e.audioPositioningRefreshRate=o},enumerable:!0,configurable:!0});class Nn{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){this.name=Re.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new x,this._cachedCameraPosition=new x,this._lastCheck=0,this._invertMatrixTemp=new H,this._cameraDirectionTemp=new x,e=e||qe.LastCreatedScene,e&&(this.scene=e,e.soundTracks=new Array,e.sounds=new Array)}register(){this.scene._afterRenderStage.registerStep(Re.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){const i=this.scene.soundTracks[t];for(let r=0;r<i.soundCollection.length;r++)e.sounds.push(i.soundCollection[r].serialize())}}addFromContainer(e){e.sounds&&e.sounds.forEach(t=>{t.play(),t.autoplay=!0,this.scene.mainSoundTrack.addSound(t)})}removeFromContainer(e,t=!1){e.sounds&&e.sounds.forEach(i=>{i.stop(),i.autoplay=!1,this.scene.mainSoundTrack.removeSound(i),t&&i.dispose()})}dispose(){const e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){const e=this.scene;this._audioEnabled=!1,q.audioEngine&&q.audioEngine.audioContext&&q.audioEngine.audioContext.suspend();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].pause()}enableAudio(){const e=this.scene;this._audioEnabled=!0,q.audioEngine&&q.audioEngine.audioContext&&q.audioEngine.audioContext.resume();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].isPaused&&e.soundTracks[t].soundCollection[i].play()}switchAudioModeForHeadphones(){const e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){const e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){const e=Us.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;const t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||t._mainSoundTrack.soundCollection.length===0&&t.soundTracks.length===1)return;const i=q.audioEngine;if(i&&i.audioContext){let r=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(r=t.activeCameras[0]),this.audioListenerPositionProvider){const n=this.audioListenerPositionProvider();i.audioContext.listener.setPosition(n.x||0,n.y||0,n.z||0)}else r?this._cachedCameraPosition.equals(r.globalPosition)||(this._cachedCameraPosition.copyFrom(r.globalPosition),i.audioContext.listener.setPosition(r.globalPosition.x,r.globalPosition.y,r.globalPosition.z)):i.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){const n=this.audioListenerRotationProvider();i.audioContext.listener.setOrientation(n.x||0,n.y||0,n.z||0,0,1,0)}else r?(r.rigCameras&&r.rigCameras.length>0&&(r=r.rigCameras[0]),r.getViewMatrix().invertToRef(this._invertMatrixTemp),x.TransformNormalToRef(Nn._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),!isNaN(this._cameraDirectionTemp.x)&&!isNaN(this._cameraDirectionTemp.y)&&!isNaN(this._cameraDirectionTemp.z)&&(this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0)))):i.audioContext.listener.setOrientation(0,0,0,0,1,0);let s;for(s=0;s<t.mainSoundTrack.soundCollection.length;s++){const n=t.mainSoundTrack.soundCollection[s];n.useCustomAttenuation&&n.updateDistanceFromListener()}if(t.soundTracks)for(s=0;s<t.soundTracks.length;s++)for(let n=0;n<t.soundTracks[s].soundCollection.length;n++){const a=t.soundTracks[s].soundCollection[n];a.useCustomAttenuation&&a.updateDistanceFromListener()}}}}Nn._CameraDirection=new x(0,0,-1);Ga._SceneComponentInitialization=o=>{let e=o._getComponent(Re.NAME_AUDIO);e||(e=new Nn(o),o._addComponent(e))};class FS{constructor(e,t,i){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==i.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=i;let r=0;for(const n of i)r+=n;const s=r>0?1/r:0;for(let n=0;n<this._weights.length;n++)this._weights[n]*=s;this._sounds=t;for(const n of this._sounds)n.onEndedObservable.add(()=>{this._onended()})}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e){X.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e;for(const t of this._sounds)t.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle){X.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e;for(const t of this._sounds)t.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(const t of this._sounds)t.setVolume(e)}_onended(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause()}stop(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();const i=Math.random();let r=0;for(let s=0;s<this._weights.length;s++)if(r+=this._weights[s],i<=r){this._currentIndex=s;break}}const t=this._sounds[this._currentIndex];t.isReady()?t.play(0,this.isPaused?void 0:e):t.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}}class xh{constructor(e){this._texture=null,this._isEnabled=!0,this.isEnabled=!0,this.time=0,e=e||qe.LastCreatedScene,e&&(this._scene=e,this.animationParameters=new Tt(0,0,0,30))}_markSubMeshesAsAttributesDirty(){for(const e of this._scene.meshes)e.bakedVertexAnimationManager===this&&e._markSubMeshesAsAttributesDirty()}bind(e,t=!1){if(!this._texture||!this._isEnabled)return;const i=this._texture.getSize();e.setFloat2("bakedVertexAnimationTextureSizeInverted",1/i.width,1/i.height),e.setFloat("bakedVertexAnimationTime",this.time),t||e.setVector4("bakedVertexAnimationSettings",this.animationParameters),e.setTexture("bakedVertexAnimationTexture",this._texture)}clone(){const e=new xh(this._scene);return this.copyTo(e),e}setAnimationParameters(e,t,i=0,r=30){this.animationParameters=new Tt(e,t,i,r)}dispose(e){var t;e&&((t=this._texture)===null||t===void 0||t.dispose())}getClassName(){return"BakedVertexAnimationManager"}copyTo(e){ke.Clone(()=>e,this)}serialize(){return ke.Serialize(this)}parse(e,t,i){ke.Parse(()=>this,e,t,i)}}M([Bt(),Te("_markSubMeshesAsAttributesDirty")],xh.prototype,"texture",void 0);M([F(),Te("_markSubMeshesAsAttributesDirty")],xh.prototype,"isEnabled",void 0);M([F()],xh.prototype,"animationParameters",void 0);M([F()],xh.prototype,"time",void 0);class kh{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return this._texture?this._texture.isCube:!1}set isCube(e){this._texture&&(this._texture.isCube=e)}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=oa.Zero(),this._cachedBaseSize=oa.Zero(),this._initialSamplingMode=2,this._texture=e,this._texture&&(this._engine=this._texture.getEngine())}isReady(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}class ni extends kh{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}get gammaSpace(){if(this._texture)this._texture._gammaSpace===null&&(this._texture._gammaSpace=this._gammaSpace);else return this._gammaSpace;return this._texture._gammaSpace&&!this._texture._useSRGBBuffer}set gammaSpace(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}this._markAllSubMeshesAsTexturesDirty()}get isRGBD(){return this._texture!=null&&this._texture._isRGBD}set isRGBD(e){this._texture&&(this._texture._isRGBD=e)}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return this._texture?this._texture._linearSpecularLOD:!1}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=rm()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=ni.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=new Array,this.onDisposeObservable=new Q,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?ni._IsScene(e)?this._scene=e:this._engine=e:this._scene=qe.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}checkTransformsAreIdentical(e){return e!==null}getTextureMatrix(){return H.IdentityReadOnly}getReflectionTextureMatrix(){return H.IdentityReadOnly}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,i,r,s,n){const a=this._getEngine();if(!a)return null;const l=a._getUseSRGBBuffer(!!s,t),c=a.getLoadedTexturesCache();for(let h=0;h<c.length;h++){const u=c[h];if((s===void 0||l===u._useSRGBBuffer)&&(r===void 0||r===u.invertY)&&u.url===e&&u.generateMipMaps===!t&&(!i||i===u.samplingMode)&&(n===void 0||n===u.isCube))return u.incrementReferences(),u}return null}_rebuild(){}clone(){return null}get textureType(){return this._texture&&this._texture.type!==void 0?this._texture.type:0}get textureFormat(){return this._texture&&this._texture.format!==void 0?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,i=null,r=!0,s=!1,n=0,a=0,l=Number.MAX_VALUE,c=Number.MAX_VALUE){if(!this._texture)return null;const h=this._getEngine();if(!h)return null;const u=this.getSize();let d=u.width,f=u.height;t!==0&&(d=d/Math.pow(2,t),f=f/Math.pow(2,t),d=Math.round(d),f=Math.round(f)),l=Math.min(d,l),c=Math.min(f,c);try{return this._texture.isCube?h._readTexturePixels(this._texture,l,c,e,t,i,r,s,n,a):h._readTexturePixels(this._texture,l,c,-1,t,i,r,s,n,a)}catch{return null}}_readPixelsSync(e=0,t=0,i=null,r=!0,s=!1){if(!this._texture)return null;const n=this.getSize();let a=n.width,l=n.height;const c=this._getEngine();if(!c)return null;t!=0&&(a=a/Math.pow(2,t),l=l/Math.pow(2,t),a=Math.round(a),l=Math.round(l));try{return this._texture.isCube?c._readTexturePixelsSync(this._texture,a,l,e,t,i,r,s):c._readTexturePixelsSync(this._texture,a,l,-1,t,i,r,s)}catch{return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const t=this._parentContainer.textures.indexOf(this);t>-1&&this._parentContainer.textures.splice(t,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;const t=ke.Serialize(this);return ke.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let i=e.length;if(i===0){t();return}for(let r=0;r<e.length;r++){const s=e[r];if(s.isReady())--i===0&&t();else{const n=s.onLoadObservable;n?n.addOnce(()=>{--i===0&&t()}):--i===0&&t()}}}static _IsScene(e){return e.getClassName()==="Scene"}}ni.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4;M([F()],ni.prototype,"uniqueId",void 0);M([F()],ni.prototype,"name",void 0);M([F()],ni.prototype,"metadata",void 0);M([F("hasAlpha")],ni.prototype,"_hasAlpha",void 0);M([F("getAlphaFromRGB")],ni.prototype,"_getAlphaFromRGB",void 0);M([F()],ni.prototype,"level",void 0);M([F("coordinatesIndex")],ni.prototype,"_coordinatesIndex",void 0);M([F()],ni.prototype,"optimizeUVAllocation",void 0);M([F("coordinatesMode")],ni.prototype,"_coordinatesMode",void 0);M([F()],ni.prototype,"wrapU",null);M([F()],ni.prototype,"wrapV",null);M([F()],ni.prototype,"wrapR",void 0);M([F()],ni.prototype,"anisotropicFilteringLevel",void 0);M([F()],ni.prototype,"isCube",null);M([F()],ni.prototype,"is3D",null);M([F()],ni.prototype,"is2DArray",null);M([F()],ni.prototype,"gammaSpace",null);M([F()],ni.prototype,"invertZ",void 0);M([F()],ni.prototype,"lodLevelInAlpha",void 0);M([F()],ni.prototype,"lodGenerationOffset",null);M([F()],ni.prototype,"lodGenerationScale",null);M([F()],ni.prototype,"linearSpecularLOD",null);M([Bt()],ni.prototype,"irradianceTexture",null);M([F()],ni.prototype,"isRenderTarget",void 0);function xT(o,e,t=!1){const i=e.width,r=e.height;if(o instanceof Float32Array){let c=o.byteLength/o.BYTES_PER_ELEMENT;const h=new Uint8Array(c);for(;--c>=0;){let u=o[c];u<0?u=0:u>1&&(u=1),h[c]=u*255}o=h}const s=document.createElement("canvas");s.width=i,s.height=r;const n=s.getContext("2d");if(!n)return null;const a=n.createImageData(i,r);if(a.data.set(o),n.putImageData(a,0,0),t){const c=document.createElement("canvas");c.width=i,c.height=r;const h=c.getContext("2d");return h?(h.translate(0,r),h.scale(1,-1),h.drawImage(s,0,0),c.toDataURL("image/png")):null}return s.toDataURL("image/png")}function LS(o,e=0,t=0){const i=o.getInternalTexture();if(!i)return null;const r=o._readPixelsSync(e,t);return r?xT(r,o.getSize(),i.invertY):null}async function BS(o,e=0,t=0){const i=o.getInternalTexture();if(!i)return null;const r=await o.readPixels(e,t);return r?xT(r,o.getSize(),i.invertY):null}class Y extends ni{get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,t,i,r,s=Y.TRILINEAR_SAMPLINGMODE,n=null,a=null,l=null,c=!1,h,u,d,f,_){var p,m,T,b,y,S,C,I,P;super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new Q,this._isBlocking=!0,this.name=e||"",this.url=e;let D,w=!1,L=null;typeof i=="object"&&i!==null?(D=(p=i.noMipmap)!==null&&p!==void 0?p:!1,r=(m=i.invertY)!==null&&m!==void 0?m:!Yt.UseOpenGLOrientationForUV,s=(T=i.samplingMode)!==null&&T!==void 0?T:Y.TRILINEAR_SAMPLINGMODE,n=(b=i.onLoad)!==null&&b!==void 0?b:null,a=(y=i.onError)!==null&&y!==void 0?y:null,l=(S=i.buffer)!==null&&S!==void 0?S:null,c=(C=i.deleteBuffer)!==null&&C!==void 0?C:!1,h=i.format,u=i.mimeType,d=i.loaderOptions,f=i.creationFlags,w=(I=i.useSRGBBuffer)!==null&&I!==void 0?I:!1,L=(P=i.internalTexture)!==null&&P!==void 0?P:null):D=!!i,this._noMipmap=D,this._invertY=r===void 0?!Yt.UseOpenGLOrientationForUV:r,this._initialSamplingMode=s,this._buffer=l,this._deleteBuffer=c,this._mimeType=u,this._loaderOptions=d,this._creationFlags=f,this._useSRGBBuffer=w,this._forcedExtension=_,h&&(this._format=h);const U=this.getScene(),G=this._getEngine();if(!G)return;G.onBeforeTextureInitObservable.notifyObservers(this);const Z=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),this._texture._cachedWrapU!==null&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),this._texture._cachedWrapV!==null&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),this._texture._cachedWrapR!==null&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),n&&n(),!this.isBlocking&&U&&U.resetCachedMaterial()},he=(_e,ne)=>{this._loadingError=!0,this._errorObject={message:_e,exception:ne},a&&a(_e,ne),Y.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!L){this._delayedOnLoad=Z,this._delayedOnError=he;return}if(this._texture=L??this._getFromCache(this.url,D,s,this._invertY,w),this._texture)if(this._texture.isReady)sh.SetImmediate(()=>Z());else{const _e=this._texture.onLoadedObservable.add(Z);this._texture.onErrorObservable.add(ne=>{var Pe;he(ne.message,ne.exception),(Pe=this._texture)===null||Pe===void 0||Pe.onLoadedObservable.remove(_e)})}else if(!U||!U.useDelayedTextureLoading){try{this._texture=G.createTexture(this.url,D,this._invertY,U,s,Z,he,this._buffer,void 0,this._format,this._forcedExtension,u,d,f,w)}catch(_e){throw he("error loading",_e),_e}c&&(this._buffer=null)}else this.delayLoadState=4,this._delayedOnLoad=Z,this._delayedOnError=he}updateURL(e,t=null,i,r){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1)),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=r,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(this.delayLoadState!==4)return;const e=this.getScene();e&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer),this._texture?this._delayedOnLoad&&(this._texture.isReady?sh.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,i,r){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,x.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,r),r.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,r.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,r.z+=this.wRotationCenter}checkTransformsAreIdentical(e){return e!==null&&this.uOffset===e.uOffset&&this.vOffset===e.vOffset&&this.uScale===e.uScale&&this.vScale===e.vScale&&this.uAng===e.uAng&&this.vAng===e.vAng&&this.wAng===e.wAng}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=H.Zero(),this._rowGenerationMatrix=new H,this._t0=x.Zero(),this._t1=x.Zero(),this._t2=x.Zero()),H.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(H.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,j.Matrix[0]),H.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,j.Matrix[1]),H.ScalingToRef(this._cachedUScale,this._cachedVScale,0,j.Matrix[2]),H.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,j.Matrix[3]),j.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(j.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(j.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(j.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),H.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const t=this.getScene();return t?(this.optimizeUVAllocation&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)),this._cachedTextureMatrix):this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode)if(this.coordinatesMode===Y.PROJECTION_MODE){if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}else return this._cachedReflectionTextureMatrix;this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=H.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=H.Zero());const t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case Y.PLANAR_MODE:{H.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break}case Y.PROJECTION_MODE:{H.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const i=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=i.updateFlag,i.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:H.IdentityToRef(this._cachedReflectionTextureMatrix);break}return t&&e.markAllMaterialsAsDirty(1,i=>i.getActiveTextures().indexOf(this)!==-1),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return ke.Clone(()=>new Y(this._texture?this._texture.url:null,this.getScene(),e),this)}serialize(){var e,t;const i=this.name;Y.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const r=super.serialize(Y._SerializeInternalTextureUniqueId);return r?((Y.SerializeBuffers||Y.ForceSerializeBuffers)&&(typeof this._buffer=="string"&&this._buffer.substr(0,5)==="data:"?(r.base64String=this._buffer,r.name=r.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?r.base64String="data:image/png;base64,"+tT(this._buffer):(Y.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(r.base64String=!this._engine||this._engine._features.supportSyncTextureRead?LS(this):BS(this))),r.invertY=this._invertY,r.samplingMode=this.samplingMode,r._creationFlags=this._creationFlags,r._useSRGBBuffer=this._useSRGBBuffer,Y._SerializeInternalTextureUniqueId&&(r.internalTextureUniqueId=(t=(e=this._texture)===null||e===void 0?void 0:e.uniqueId)!==null&&t!==void 0?t:void 0),this.name=i,r):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,t,i){if(e.customType){const c=Xh.Instantiate(e.customType).Parse(e,t,i);return e.samplingMode&&c.updateSamplingMode&&c._samplingMode&&c._samplingMode!==e.samplingMode&&c.updateSamplingMode(e.samplingMode),c}if(e.isCube&&!e.isRenderTarget)return Y._CubeTextureParser(e,t,i);const r=e.internalTextureUniqueId!==void 0;if(!e.name&&!e.isRenderTarget&&!r)return null;let s;if(r){const l=t.getEngine().getLoadedTexturesCache();for(const c of l)if(c.uniqueId===e.internalTextureUniqueId){s=c;break}}const n=l=>{var c;if(l&&l._texture&&(l._texture._cachedWrapU=null,l._texture._cachedWrapV=null,l._texture._cachedWrapR=null),e.samplingMode){const h=e.samplingMode;l&&l.samplingMode!==h&&l.updateSamplingMode(h)}if(l&&e.animations)for(let h=0;h<e.animations.length;h++){const u=e.animations[h],d=Xr("BABYLON.Animation");d&&l.animations.push(d.Parse(u))}r&&!s&&((c=l==null?void 0:l._texture)===null||c===void 0||c._setUniqueId(e.internalTextureUniqueId))};return ke.Parse(()=>{var l,c,h;let u=!0;if(e.noMipmap&&(u=!1),e.mirrorPlane){const d=Y._CreateMirror(e.name,e.renderTargetSize,t,u);return d._waitingRenderList=e.renderList,d.mirrorPlane=Tn.FromArray(e.mirrorPlane),n(d),d}else if(e.isRenderTarget){let d=null;if(e.isCube){if(t.reflectionProbes)for(let f=0;f<t.reflectionProbes.length;f++){const _=t.reflectionProbes[f];if(_.name===e.name)return _.cubeTexture}}else d=Y._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,u,(l=e._creationFlags)!==null&&l!==void 0?l:0),d._waitingRenderList=e.renderList;return n(d),d}else{let d;if(e.base64String&&!s)d=Y.CreateFromBase64String(e.base64String,e.base64String,t,!u,e.invertY,e.samplingMode,()=>{n(d)},(c=e._creationFlags)!==null&&c!==void 0?c:0,(h=e._useSRGBBuffer)!==null&&h!==void 0?h:!1),d.name=e.name;else{let f;e.name&&e.name.indexOf("://")>0?f=e.name:f=i+e.name,e.url&&(e.url.startsWith("data:")||Y.UseSerializedUrlIfAny)&&(f=e.url);const _={noMipmap:!u,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{n(d)},internalTexture:s};d=new Y(f,t,_)}return d}},e,t)}static CreateFromBase64String(e,t,i,r,s,n=Y.TRILINEAR_SAMPLINGMODE,a=null,l=null,c=5,h){return new Y("data:"+t,i,r,s,n,a,l,e,!1,c,void 0,void 0,h)}static LoadFromDataString(e,t,i,r=!1,s,n=!0,a=Y.TRILINEAR_SAMPLINGMODE,l=null,c=null,h=5,u){return e.substr(0,5)!=="data:"&&(e="data:"+e),new Y(e,i,s,n,a,l,c,t,r,h,void 0,void 0,u)}}Y.SerializeBuffers=!0;Y.ForceSerializeBuffers=!1;Y.OnTextureLoadErrorObservable=new Q;Y._SerializeInternalTextureUniqueId=!1;Y._CubeTextureParser=(o,e,t)=>{throw pt("CubeTexture")};Y._CreateMirror=(o,e,t,i)=>{throw pt("MirrorTexture")};Y._CreateRenderTargetTexture=(o,e,t,i,r)=>{throw pt("RenderTargetTexture")};Y.NEAREST_SAMPLINGMODE=1;Y.NEAREST_NEAREST_MIPLINEAR=8;Y.BILINEAR_SAMPLINGMODE=2;Y.LINEAR_LINEAR_MIPNEAREST=11;Y.TRILINEAR_SAMPLINGMODE=3;Y.LINEAR_LINEAR_MIPLINEAR=3;Y.NEAREST_NEAREST_MIPNEAREST=4;Y.NEAREST_LINEAR_MIPNEAREST=5;Y.NEAREST_LINEAR_MIPLINEAR=6;Y.NEAREST_LINEAR=7;Y.NEAREST_NEAREST=1;Y.LINEAR_NEAREST_MIPNEAREST=9;Y.LINEAR_NEAREST_MIPLINEAR=10;Y.LINEAR_LINEAR=2;Y.LINEAR_NEAREST=12;Y.EXPLICIT_MODE=0;Y.SPHERICAL_MODE=1;Y.PLANAR_MODE=2;Y.CUBIC_MODE=3;Y.PROJECTION_MODE=4;Y.SKYBOX_MODE=5;Y.INVCUBIC_MODE=6;Y.EQUIRECTANGULAR_MODE=7;Y.FIXED_EQUIRECTANGULAR_MODE=8;Y.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;Y.CLAMP_ADDRESSMODE=0;Y.WRAP_ADDRESSMODE=1;Y.MIRROR_ADDRESSMODE=2;Y.UseSerializedUrlIfAny=!1;M([F()],Y.prototype,"url",void 0);M([F()],Y.prototype,"uOffset",void 0);M([F()],Y.prototype,"vOffset",void 0);M([F()],Y.prototype,"uScale",void 0);M([F()],Y.prototype,"vScale",void 0);M([F()],Y.prototype,"uAng",void 0);M([F()],Y.prototype,"vAng",void 0);M([F()],Y.prototype,"wAng",void 0);M([F()],Y.prototype,"uRotationCenter",void 0);M([F()],Y.prototype,"vRotationCenter",void 0);M([F()],Y.prototype,"wRotationCenter",void 0);M([F()],Y.prototype,"homogeneousRotationInUVTransform",void 0);M([F()],Y.prototype,"isBlocking",null);ye("BABYLON.Texture",Y);ke._TextureParser=Y.Parse;ze.prototype.updateRawTexture=function(o,e,t,i,r=null,s=0,n=!1){if(!o)return;const a=this._getRGBABufferInternalSizedFormat(s,t,n),l=this._getInternalFormat(t),c=this._getWebGLTextureType(s);this._bindTextureDirectly(this._gl.TEXTURE_2D,o,!0),this._unpackFlipY(i===void 0?!0:!!i),this._doNotHandleContextLost||(o._bufferView=e,o.format=t,o.type=s,o.invertY=i,o._compression=r),o.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[r],o.width,o.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,a,o.width,o.height,0,l,c,e),o.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),o.isReady=!0};ze.prototype.createRawTexture=function(o,e,t,i,r,s,n,a=null,l=0,c=0,h=!1){const u=new hi(this,bt.Raw);u.baseWidth=e,u.baseHeight=t,u.width=e,u.height=t,u.format=i,u.generateMipMaps=r,u.samplingMode=n,u.invertY=s,u._compression=a,u.type=l,u._useSRGBBuffer=this._getUseSRGBBuffer(h,!r),this._doNotHandleContextLost||(u._bufferView=o),this.updateRawTexture(u,o,i,s,a,l,u._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,u,!0);const d=this._getSamplingParameters(n,r);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,d.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,d.min),r&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(u),u};ze.prototype.createRawCubeTexture=function(o,e,t,i,r,s,n,a=null){const l=this._gl,c=new hi(this,bt.CubeRaw);c.isCube=!0,c.format=t,c.type=i,this._doNotHandleContextLost||(c._bufferViewArray=o);const h=this._getWebGLTextureType(i);let u=this._getInternalFormat(t);u===l.RGB&&(u=l.RGBA),h===l.FLOAT&&!this._caps.textureFloatLinearFiltering?(r=!1,n=1,X.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):h===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(r=!1,n=1,X.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):h===l.FLOAT&&!this._caps.textureFloatRender?(r=!1,X.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):h===l.HALF_FLOAT&&!this._caps.colorBufferFloat&&(r=!1,X.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));const d=e,f=d;if(c.width=d,c.height=f,c.invertY=s,c._compression=a,!this.needPOTTextures||J.IsExponentOfTwo(c.width)&&J.IsExponentOfTwo(c.height)||(r=!1),o)this.updateRawCubeTexture(c,o,t,i,s,a);else{const m=this._getRGBABufferInternalSizedFormat(i),T=0;this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,c,!0);for(let b=0;b<6;b++)a?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+b,T,this.getCaps().s3tc[a],c.width,c.height,0,void 0):l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+b,T,m,c.width,c.height,0,u,h,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,c,!0),o&&r&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const p=this._getSamplingParameters(n,r);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,p.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,p.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),c.generateMipMaps=r,c.samplingMode=n,c.isReady=!0,c};ze.prototype.updateRawCubeTexture=function(o,e,t,i,r,s=null,n=0){o._bufferViewArray=e,o.format=t,o.type=i,o.invertY=r,o._compression=s;const a=this._gl,l=this._getWebGLTextureType(i);let c=this._getInternalFormat(t);const h=this._getRGBABufferInternalSizedFormat(i);let u=!1;c===a.RGB&&(c=a.RGBA,u=!0),this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,o,!0),this._unpackFlipY(r===void 0?!0:!!r),o.width%4!==0&&a.pixelStorei(a.UNPACK_ALIGNMENT,1);for(let f=0;f<6;f++){let _=e[f];s?a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+f,n,this.getCaps().s3tc[s],o.width,o.height,0,_):(u&&(_=TT(_,o.width,o.height,i)),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+f,n,h,o.width,o.height,0,c,l,_))}(!this.needPOTTextures||J.IsExponentOfTwo(o.width)&&J.IsExponentOfTwo(o.height))&&o.generateMipMaps&&n===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),o.isReady=!0};ze.prototype.createRawCubeTextureFromUrl=function(o,e,t,i,r,s,n,a,l=null,c=null,h=3,u=!1){const d=this._gl,f=this.createRawCubeTexture(null,t,i,r,!s,u,h,null);e==null||e.addPendingData(f),f.url=o,this._internalTexturesCache.push(f);const _=(m,T)=>{e==null||e.removePendingData(f),c&&m&&c(m.status+" "+m.statusText,T)},p=m=>{const T=f.width,b=n(m);if(b){if(a){const y=this._getWebGLTextureType(r);let S=this._getInternalFormat(i);const C=this._getRGBABufferInternalSizedFormat(r);let I=!1;S===d.RGB&&(S=d.RGBA,I=!0),this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,f,!0),this._unpackFlipY(!1);const P=a(b);for(let D=0;D<P.length;D++){const w=T>>D;for(let L=0;L<6;L++){let U=P[D][L];I&&(U=TT(U,w,w,r)),d.texImage2D(L,D,C,w,w,0,S,y,U)}}this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(f,b,i,r,u);f.isReady=!0,e==null||e.removePendingData(f),f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),l&&l()}};return this._loadFile(o,m=>{p(m)},void 0,e==null?void 0:e.offlineProvider,!0,_),f};function TT(o,e,t,i){let r,s=1;i===1?r=new Float32Array(e*t*4):i===2?(r=new Uint16Array(e*t*4),s=15360):i===7?r=new Uint32Array(e*t*4):r=new Uint8Array(e*t*4);for(let n=0;n<e;n++)for(let a=0;a<t;a++){const l=(a*e+n)*3,c=(a*e+n)*4;r[c+0]=o[l+0],r[c+1]=o[l+1],r[c+2]=o[l+2],r[c+3]=s}return r}function ET(o){return function(e,t,i,r,s,n,a,l,c=null,h=0){const u=o?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,d=o?bt.Raw3D:bt.Raw2DArray,f=new hi(this,d);f.baseWidth=t,f.baseHeight=i,f.baseDepth=r,f.width=t,f.height=i,f.depth=r,f.format=s,f.type=h,f.generateMipMaps=n,f.samplingMode=l,o?f.is3D=!0:f.is2DArray=!0,this._doNotHandleContextLost||(f._bufferView=e),o?this.updateRawTexture3D(f,e,s,a,c,h):this.updateRawTexture2DArray(f,e,s,a,c,h),this._bindTextureDirectly(u,f,!0);const _=this._getSamplingParameters(l,n);return this._gl.texParameteri(u,this._gl.TEXTURE_MAG_FILTER,_.mag),this._gl.texParameteri(u,this._gl.TEXTURE_MIN_FILTER,_.min),n&&this._gl.generateMipmap(u),this._bindTextureDirectly(u,null),this._internalTexturesCache.push(f),f}}ze.prototype.createRawTexture2DArray=ET(!1);ze.prototype.createRawTexture3D=ET(!0);function bT(o){return function(e,t,i,r,s=null,n=0){const a=o?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(n),c=this._getInternalFormat(i),h=this._getRGBABufferInternalSizedFormat(n,i);this._bindTextureDirectly(a,e,!0),this._unpackFlipY(r===void 0?!0:!!r),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=r,e._compression=s),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&t?this._gl.compressedTexImage3D(a,0,this.getCaps().s3tc[s],e.width,e.height,e.depth,0,t):this._gl.texImage3D(a,0,h,e.width,e.height,e.depth,0,c,l,t),e.generateMipMaps&&this._gl.generateMipmap(a),this._bindTextureDirectly(a,null),e.isReady=!0}}ze.prototype.updateRawTexture2DArray=bT(!1);ze.prototype.updateRawTexture3D=bT(!0);class an extends Y{constructor(e,t,i,r,s,n=!0,a=!1,l=3,c=0,h,u){super(null,s,!n,a,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,h),this.format=r,this._engine&&(!this._engine._caps.textureFloatLinearFiltering&&c===1&&(l=1),!this._engine._caps.textureHalfFloatLinearFiltering&&c===2&&(l=1),this._texture=this._engine.createRawTexture(e,t,i,r,n,a,l,null,c,h??0,u??!1),this.wrapU=Y.CLAMP_ADDRESSMODE,this.wrapV=Y.CLAMP_ADDRESSMODE)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)}static CreateLuminanceTexture(e,t,i,r,s=!0,n=!1,a=3){return new an(e,t,i,1,r,s,n,a)}static CreateLuminanceAlphaTexture(e,t,i,r,s=!0,n=!1,a=3){return new an(e,t,i,2,r,s,n,a)}static CreateAlphaTexture(e,t,i,r,s=!0,n=!1,a=3){return new an(e,t,i,0,r,s,n,a)}static CreateRGBTexture(e,t,i,r,s=!0,n=!1,a=3,l=0,c=0,h=!1){return new an(e,t,i,4,r,s,n,a,l,c,h)}static CreateRGBATexture(e,t,i,r,s=!0,n=!1,a=3,l=0,c=0,h=!1){return new an(e,t,i,5,r,s,n,a,l,c,h)}static CreateRGBAStorageTexture(e,t,i,r,s=!0,n=!1,a=3,l=0,c=!1){return new an(e,t,i,5,r,s,n,a,l,1,c)}static CreateRTexture(e,t,i,r,s=!0,n=!1,a=Y.TRILINEAR_SAMPLINGMODE,l=1){return new an(e,t,i,6,r,s,n,a,l)}static CreateRStorageTexture(e,t,i,r,s=!0,n=!1,a=Y.TRILINEAR_SAMPLINGMODE,l=1){return new an(e,t,i,6,r,s,n,a,l,1)}}class US{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===Qe.POINTERDOWN){this._isPointerDown=!0;return}i.type===Qe.POINTERUP&&(this._isPointerDown=!1)}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{if(this._reachTargetAlpha())return;const i=Us.Now;let r=0;this._lastFrameTime!=null&&(r=i-this._lastFrameTime),this._lastFrameTime=i,this._applyUserInteraction();const s=i-this._lastInteractionTime-this._idleRotationWaitTime,n=Math.max(Math.min(s/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*n,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(r/1e3))})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null}resetLastInteractionTime(e){this._lastInteractionTime=e??Us.Now}_reachTargetAlpha(){return this._attachedCamera&&this.targetAlpha?Math.abs(this._attachedCamera.alpha-this.targetAlpha)<kt:!1}_userIsZooming(){return this._attachedCamera?this._attachedCamera.inertialRadiusOffset!==0:!1}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&this._attachedCamera.inertialRadiusOffset!==0&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=Us.Now)}_userIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}class rc{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;const t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add(i=>{if(!i)return;i.computeWorldMatrix(!0);const r=i.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=r*.05,this.upperRadiusTransitionRange=r*.05}):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))})}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return this._attachedCamera?this._attachedCamera.radius===e&&!this._radiusIsAnimating:!1}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(rc.EasingFunction.setEasingMode(rc.EasingMode),this._radiusBounceTransition=ae.CreateAnimation("radius",ae.ANIMATIONTYPE_FLOAT,60,rc.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;const t=ae.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,()=>this._clearAnimationLocks());t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}}rc.EasingFunction=new pS(.3);rc.EasingMode=xs.EASINGMODE_EASEOUT;class Pn{constructor(){this.onTargetFramingAnimationEndObservable=new Q,this._mode=Pn.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();Pn.EasingFunction.setEasingMode(Pn.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===Qe.POINTERDOWN){this._isPointerDown=!0;return}i.type===Qe.POINTERUP&&(this._isPointerDown=!1)}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(i=>{i&&this.zoomOnMesh(i,void 0,()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()})}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);const r=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(r.minimumWorld,r.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);const r=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(r.min,r.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){const r=new x(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new x(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let n=0;n<e.length;n++){const a=e[n].getHierarchyBoundingVectors(!0);x.CheckExtends(a.min,r,s),x.CheckExtends(a.max,r,s)}this.zoomOnBoundingInfo(r,s,t,i)}zoomOnBoundingInfo(e,t,i=!1,r=null){let s;if(!this._attachedCamera)return;const n=e.y,a=t.y,l=n+(a-n)*this._positionScale,c=t.subtract(e).scale(.5);if(i)s=new x(0,l,0);else{const d=e.add(c);s=new x(d.x,l,d.z)}this._vectorTransition||(this._vectorTransition=ae.CreateAnimation("target",ae.ANIMATIONTYPE_VECTOR3,60,Pn.EasingFunction)),this._betaIsAnimating=!0;let h=ae.TransitionTo("target",s,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);h&&this._animatables.push(h);let u=0;if(this._mode===Pn.FitFrustumSidesMode){const d=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=c.length()+this._attachedCamera.minZ),u=d}else this._mode===Pn.IgnoreBoundsSizeMode&&(u=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&this._attachedCamera.lowerRadiusLimit===null&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){const d=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/d,this._attachedCamera.wheelPrecision=100/u}this._radiusTransition||(this._radiusTransition=ae.CreateAnimation("radius",ae.ANIMATIONTYPE_FLOAT,60,Pn.EasingFunction)),h=ae.TransitionTo("radius",u,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,()=>{this.stopAllAnimations(),r&&r(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()}),h&&this._animatables.push(h)}_calculateLowerRadiusFromModelBoundingSphere(e,t){const r=t.subtract(e).length(),s=this._getFrustumSlope(),a=r*.5*this._radiusScale,l=a*Math.sqrt(1+1/(s.x*s.x)),c=a*Math.sqrt(1+1/(s.y*s.y));let h=Math.max(l,c);const u=this._attachedCamera;return u?(u.lowerRadiusLimit&&this._mode===Pn.IgnoreBoundsSizeMode&&(h=h<u.lowerRadiusLimit?u.lowerRadiusLimit:h),u.upperRadiusLimit&&(h=h>u.upperRadiusLimit?u.upperRadiusLimit:h),h):0}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;const e=Us.Now-this._lastInteractionTime,t=Math.PI*.5-this._defaultElevation,i=Math.PI*.5;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=ae.CreateAnimation("beta",ae.ANIMATIONTYPE_FLOAT,60,Pn.EasingFunction));const r=ae.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,()=>{this._clearAnimationLocks(),this.stopAllAnimations()});r&&this._animatables.push(r)}}_getFrustumSlope(){const e=this._attachedCamera;if(!e)return Ie.Zero();const i=e.getScene().getEngine().getAspectRatio(e),r=Math.tan(e.fov/2),s=r*i;return new Ie(s,r)}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=Us.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}Pn.EasingFunction=new mS;Pn.EasingMode=xs.EASINGMODE_EASEINOUT;Pn.IgnoreBoundsSizeMode=0;Pn.FitFrustumSidesMode=1;class Pt{constructor(e,t,i=Number.MAX_VALUE){this.origin=e,this.direction=t,this.length=i}clone(){return new Pt(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){const r=Pt._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),s=Pt._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i);let n=0,a=Number.MAX_VALUE,l,c,h,u;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<r.x||this.origin.x>s.x)return!1}else if(l=1/this.direction.x,c=(r.x-this.origin.x)*l,h=(s.x-this.origin.x)*l,h===-1/0&&(h=1/0),c>h&&(u=c,c=h,h=u),n=Math.max(c,n),a=Math.min(h,a),n>a)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<r.y||this.origin.y>s.y)return!1}else if(l=1/this.direction.y,c=(r.y-this.origin.y)*l,h=(s.y-this.origin.y)*l,h===-1/0&&(h=1/0),c>h&&(u=c,c=h,h=u),n=Math.max(c,n),a=Math.min(h,a),n>a)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<r.z||this.origin.z>s.z)return!1}else if(l=1/this.direction.z,c=(r.z-this.origin.z)*l,h=(s.z-this.origin.z)*l,h===-1/0&&(h=1/0),c>h&&(u=c,c=h,h=u),n=Math.max(c,n),a=Math.min(h,a),n>a)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){const i=e.center.x-this.origin.x,r=e.center.y-this.origin.y,s=e.center.z-this.origin.z,n=i*i+r*r+s*s,a=e.radius+t,l=a*a;if(n<=l)return!0;const c=i*this.direction.x+r*this.direction.y+s*this.direction.z;return c<0?!1:n-c*c<=l}intersectsTriangle(e,t,i){const r=Pt._TmpVector3[0],s=Pt._TmpVector3[1],n=Pt._TmpVector3[2],a=Pt._TmpVector3[3],l=Pt._TmpVector3[4];t.subtractToRef(e,r),i.subtractToRef(e,s),x.CrossToRef(this.direction,s,n);const c=x.Dot(r,n);if(c===0)return null;const h=1/c;this.origin.subtractToRef(e,a);const u=x.Dot(a,n)*h;if(u<0||u>1)return null;x.CrossToRef(a,r,l);const d=x.Dot(this.direction,l)*h;if(d<0||u+d>1)return null;const f=x.Dot(s,l)*h;return f>this.length?null:new H_(1-u-d,u,f)}intersectsPlane(e){let t;const i=x.Dot(e.normal,this.direction);if(Math.abs(i)<999999997475243e-21)return null;{const r=x.Dot(e.normal,this.origin);return t=(-e.d-r)/i,t<0?t<-999999997475243e-21?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{const i=(this.origin.y-t)/this.direction.y;return i>0?null:new x(this.origin.x+this.direction.x*-i,t,this.origin.z+this.direction.z*-i)}case"x":{const i=(this.origin.x-t)/this.direction.x;return i>0?null:new x(t,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{const i=(this.origin.z-t)/this.direction.z;return i>0?null:new x(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,t)}default:return null}}intersectsMesh(e,t){const i=j.Matrix[0];return e.getWorldMatrix().invertToRef(i),this._tmpRay?Pt.TransformToRef(this,i,this._tmpRay):this._tmpRay=Pt.Transform(this,i),e.intersects(this._tmpRay,t)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let r=0;r<e.length;r++){const s=this.intersectsMesh(e[r],t);s.hit&&i.push(s)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){const r=this.origin,s=j.Vector3[0],n=j.Vector3[1],a=j.Vector3[2],l=j.Vector3[3];t.subtractToRef(e,s),this.direction.scaleToRef(Pt._Rayl,a),r.addToRef(a,n),e.subtractToRef(r,l);const c=x.Dot(s,s),h=x.Dot(s,a),u=x.Dot(a,a),d=x.Dot(s,l),f=x.Dot(a,l),_=c*u-h*h;let p,m=_,T,b=_;_<Pt._Smallnum?(p=0,m=1,T=f,b=u):(p=h*f-u*d,T=c*f-h*d,p<0?(p=0,T=f,b=u):p>m&&(p=m,T=f+h,b=u)),T<0?(T=0,-d<0?p=0:-d>c?p=m:(p=-d,m=c)):T>b&&(T=b,-d+h<0?p=0:-d+h>c?p=m:(p=-d+h,m=c));const y=Math.abs(p)<Pt._Smallnum?0:p/m,S=Math.abs(T)<Pt._Smallnum?0:T/b,C=j.Vector3[4];a.scaleToRef(S,C);const I=j.Vector3[5];s.scaleToRef(y,I),I.addInPlace(l);const P=j.Vector3[6];return I.subtractToRef(C,P),S>0&&S<=this.length&&P.lengthSquared()<i*i?I.length():-1}update(e,t,i,r,s,n,a,l=!1){if(l){Pt._RayDistant||(Pt._RayDistant=Pt.Zero()),Pt._RayDistant.unprojectRayToRef(e,t,i,r,H.IdentityReadOnly,n,a);const c=j.Matrix[0];s.invertToRef(c),Pt.TransformToRef(Pt._RayDistant,c,this)}else this.unprojectRayToRef(e,t,i,r,s,n,a);return this}static Zero(){return new Pt(x.Zero(),x.Zero())}static CreateNew(e,t,i,r,s,n,a){return Pt.Zero().update(e,t,i,r,s,n,a)}static CreateNewFromTo(e,t,i=H.IdentityReadOnly){const r=t.subtract(e),s=Math.sqrt(r.x*r.x+r.y*r.y+r.z*r.z);return r.normalize(),Pt.Transform(new Pt(e,r,s),i)}static Transform(e,t){const i=new Pt(new x(0,0,0),new x(0,0,0));return Pt.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){x.TransformCoordinatesToRef(e.origin,t,i.origin),x.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length;const r=i.direction,s=r.length();if(!(s===0||s===1)){const n=1/s;r.x*=n,r.y*=n,r.z*=n,i.length*=s}}unprojectRayToRef(e,t,i,r,s,n,a){var l;const c=j.Matrix[0];s.multiplyToRef(n,c),c.multiplyToRef(a,c),c.invert();const h=j.Vector3[0];h.x=e/i*2-1,h.y=-(t/r*2-1),h.z=!((l=qe.LastCreatedEngine)===null||l===void 0)&&l.isNDCHalfZRange?0:-1;const u=j.Vector3[1].copyFromFloats(h.x,h.y,1-1e-8),d=j.Vector3[2],f=j.Vector3[3];x._UnprojectFromInvertedMatrixToRef(h,c,d),x._UnprojectFromInvertedMatrixToRef(u,c,f),this.origin.copyFrom(d),f.subtractToRef(d,this.direction),this.direction.normalize()}}Pt._TmpVector3=Br.BuildArray(6,x.Zero);Pt._RayDistant=Pt.Zero();Pt._Smallnum=1e-8;Pt._Rayl=1e9;Ne.prototype.createPickingRay=function(o,e,t,i,r=!1){const s=Pt.Zero();return this.createPickingRayToRef(o,e,t,s,i,r),s};Ne.prototype.createPickingRayToRef=function(o,e,t,i,r,s=!1,n=!1){const a=this.getEngine();if(!r){if(!this.activeCamera)return this;r=this.activeCamera}const c=r.viewport.toGlobal(a.getRenderWidth(),a.getRenderHeight());return o=o/a.getHardwareScalingLevel()-c.x,e=e/a.getHardwareScalingLevel()-(a.getRenderHeight()-c.y-c.height),i.update(o,e,c.width,c.height,t||H.IdentityReadOnly,s?H.IdentityReadOnly:r.getViewMatrix(),r.getProjectionMatrix(),n),this};Ne.prototype.createPickingRayInCameraSpace=function(o,e,t){const i=Pt.Zero();return this.createPickingRayInCameraSpaceToRef(o,e,i,t),i};Ne.prototype.createPickingRayInCameraSpaceToRef=function(o,e,t,i){if(!Vs)return this;const r=this.getEngine();if(!i){if(!this.activeCamera)throw new Error("Active camera not set");i=this.activeCamera}const n=i.viewport.toGlobal(r.getRenderWidth(),r.getRenderHeight()),a=H.Identity();return o=o/r.getHardwareScalingLevel()-n.x,e=e/r.getHardwareScalingLevel()-(r.getRenderHeight()-n.y-n.height),t.update(o,e,n.width,n.height,a,a,i.getProjectionMatrix()),this};Ne.prototype._internalPickForMesh=function(o,e,t,i,r,s,n,a){const l=e(i,t.enableDistantPicking),c=t.intersects(l,r,n,s,i,a);return!c||!c.hit||!r&&o!=null&&c.distance>=o.distance?null:c};Ne.prototype._internalPick=function(o,e,t,i,r){let s=null;const n=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),a=this.cameraToUseForPointers||this.activeCamera;for(let l=0;l<this.meshes.length;l++){const c=this.meshes[l];if(e){if(!e(c))continue}else if(!c.isEnabled()||!c.isVisible||!c.isPickable)continue;const h=n&&c.isWorldMatrixCameraDependent(),u=c.computeWorldMatrix(h,a);if(c.hasThinInstances&&c.thinInstanceEnablePicking){const d=this._internalPickForMesh(s,o,c,u,!0,!0,r);if(d){if(i)return d;const f=j.Matrix[1],_=c.thinInstanceGetWorldMatrices();for(let p=0;p<_.length;p++){_[p].multiplyToRef(u,f);const T=this._internalPickForMesh(s,o,c,f,t,i,r,!0);if(T&&(s=T,s.thinInstanceIndex=p,t))return s}}}else{const d=this._internalPickForMesh(s,o,c,u,t,i,r);if(d&&(s=d,t))return s}}return s||new Vs};Ne.prototype._internalMultiPick=function(o,e,t){if(!Vs)return null;const i=new Array,r=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),s=this.cameraToUseForPointers||this.activeCamera;for(let n=0;n<this.meshes.length;n++){const a=this.meshes[n];if(e){if(!e(a))continue}else if(!a.isEnabled()||!a.isVisible||!a.isPickable)continue;const l=r&&a.isWorldMatrixCameraDependent(),c=a.computeWorldMatrix(l,s);if(a.hasThinInstances&&a.thinInstanceEnablePicking){if(this._internalPickForMesh(null,o,a,c,!0,!0,t)){const u=j.Matrix[1],d=a.thinInstanceGetWorldMatrices();for(let f=0;f<d.length;f++){d[f].multiplyToRef(c,u);const p=this._internalPickForMesh(null,o,a,u,!1,!1,t,!0);p&&(p.thinInstanceIndex=f,i.push(p))}}}else{const h=this._internalPickForMesh(null,o,a,c,!1,!1,t);h&&i.push(h)}}return i};Ne.prototype.pickWithBoundingInfo=function(o,e,t,i,r){if(!Vs)return null;const s=this._internalPick(n=>(this._tempPickingRay||(this._tempPickingRay=Pt.Zero()),this.createPickingRayToRef(o,e,n,this._tempPickingRay,r||null),this._tempPickingRay),t,i,!0);return s&&(s.ray=this.createPickingRay(o,e,H.Identity(),r||null)),s};Object.defineProperty(Ne.prototype,"_pickingAvailable",{get:()=>!0,enumerable:!1,configurable:!1});Ne.prototype.pick=function(o,e,t,i,r,s,n=!1){const a=this._internalPick((l,c)=>(this._tempPickingRay||(this._tempPickingRay=Pt.Zero()),this.createPickingRayToRef(o,e,l,this._tempPickingRay,r||null,!1,c),this._tempPickingRay),t,i,!1,s);return a&&(a.ray=this.createPickingRay(o,e,H.Identity(),r||null)),a};Ne.prototype.pickWithRay=function(o,e,t,i){const r=this._internalPick(s=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=H.Identity()),s.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=Pt.Zero()),Pt.TransformToRef(o,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t,!1,i);return r&&(r.ray=o),r};Ne.prototype.multiPick=function(o,e,t,i,r){return this._internalMultiPick(s=>this.createPickingRay(o,e,s,i||null),t,r)};Ne.prototype.multiPickWithRay=function(o,e,t){return this._internalMultiPick(i=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=H.Identity()),i.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=Pt.Zero()),Pt.TransformToRef(o,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t)};Ve.prototype.getForwardRay=function(o=100,e,t){return this.getForwardRayToRef(new Pt(x.Zero(),x.Zero(),o),o,e,t)};Ve.prototype.getForwardRayToRef=function(o,e=100,t,i){return t||(t=this.getWorldMatrix()),o.length=e,i?o.origin.copyFrom(i):o.origin.copyFrom(this.position),j.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),x.TransformNormalToRef(j.Vector3[2],t,j.Vector3[3]),x.NormalizeToRef(j.Vector3[3],o.direction),o};function ST(o){const e=[],t=[],i=[],r=[],s=o.width||o.size||1,n=o.height||o.size||1,a=o.sideOrientation===0?0:o.sideOrientation||Oe.DEFAULTSIDE,l=s/2,c=n/2;t.push(-l,-c,0),i.push(0,0,-1),r.push(0,Yt.UseOpenGLOrientationForUV?1:0),t.push(l,-c,0),i.push(0,0,-1),r.push(1,Yt.UseOpenGLOrientationForUV?1:0),t.push(l,c,0),i.push(0,0,-1),r.push(1,Yt.UseOpenGLOrientationForUV?0:1),t.push(-l,c,0),i.push(0,0,-1),r.push(0,Yt.UseOpenGLOrientationForUV?0:1),e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),Oe._ComputeSides(a,t,e,i,r,o.frontUVs,o.backUVs);const h=new Oe;return h.indices=e,h.positions=t,h.normals=i,h.uvs=r,h}function om(o,e={},t=null){const i=new K(o,t);return e.sideOrientation=K._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,ST(e).applyToMesh(i,e.updatable),e.sourcePlane&&(i.translate(e.sourcePlane.normal,-e.sourcePlane.d),i.setDirection(e.sourcePlane.normal.scale(-1))),i}Oe.CreatePlane=ST;K.CreatePlane=(o,e,t,i,r)=>om(o,{size:e,width:e,height:e,sideOrientation:r,updatable:i},t);class si{}si.ANCHOR_SYSTEM="xr-anchor-system";si.BACKGROUND_REMOVER="xr-background-remover";si.HIT_TEST="xr-hit-test";si.MESH_DETECTION="xr-mesh-detection";si.PHYSICS_CONTROLLERS="xr-physics-controller";si.PLANE_DETECTION="xr-plane-detection";si.POINTER_SELECTION="xr-controller-pointer-selection";si.TELEPORTATION="xr-controller-teleportation";si.FEATURE_POINTS="xr-feature-points";si.HAND_TRACKING="xr-hand-tracking";si.IMAGE_TRACKING="xr-image-tracking";si.NEAR_INTERACTION="xr-near-interaction";si.DOM_OVERLAY="xr-dom-overlay";si.MOVEMENT="xr-controller-movement";si.LIGHT_ESTIMATION="xr-light-estimation";si.EYE_TRACKING="xr-eye-tracking";si.WALKING_LOCOMOTION="xr-walking-locomotion";si.LAYERS="xr-layers";class dr{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add(()=>{this.getEnabledFeatures().forEach(t=>{const i=this._features[t];i.enabled&&!i.featureImplementation.attached&&!i.featureImplementation.disableAutoAttach&&this.attachFeature(t)})}),this._xrSessionManager.onXRSessionEnded.add(()=>{this.getEnabledFeatures().forEach(t=>{const i=this._features[t];i.enabled&&i.featureImplementation.attached&&this.detachFeature(t)})})}static AddWebXRFeature(e,t,i=1,r=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:i},i>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=i),r&&(this._AvailableFeatures[e].stable=i),this._AvailableFeatures[e][i]=t}static ConstructFeature(e,t=1,i,r){const s=this._AvailableFeatures[e][t];if(!s)throw new Error("feature not found");return s(i,r)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){const t=this._features[e];t&&t.enabled&&!t.featureImplementation.attached&&t.featureImplementation.attach()}detachFeature(e){const t=this._features[e];t&&t.featureImplementation.attached&&t.featureImplementation.detach()}disableFeature(e){const t=typeof e=="string"?e:e.Name,i=this._features[t];return i&&i.enabled?(i.enabled=!1,this.detachFeature(t),i.featureImplementation.dispose(),delete this._features[t],!0):!1}dispose(){this.getEnabledFeatures().forEach(e=>{this.disableFeature(e)})}enableFeature(e,t="latest",i={},r=!0,s=!0){const n=typeof e=="string"?e:e.Name;let a=0;if(typeof t=="string"){if(!t)throw new Error(`Error in provided version - ${n} (${t})`);if(t==="stable"?a=dr.GetStableVersionOfFeature(n):t==="latest"?a=dr.GetLatestVersionOfFeature(n):a=+t,a===-1||isNaN(a))throw new Error(`feature not found - ${n} (${t})`)}else a=t;const l=dr._ConflictingFeatures[n];if(l!==void 0&&this.getEnabledFeatures().indexOf(l)!==-1)throw new Error(`Feature ${n} cannot be enabled while ${l} is enabled.`);const c=this._features[n],h=dr.ConstructFeature(n,a,this._xrSessionManager,i);if(!h)throw new Error(`feature not found - ${n}`);c&&this.disableFeature(n);const u=h();if(u.dependsOn&&!u.dependsOn.every(f=>!!this._features[f]))throw new Error(`Dependant features missing. Make sure the following features are enabled - ${u.dependsOn.join(", ")}`);if(u.isCompatible())return this._features[n]={featureImplementation:u,enabled:!0,version:a,required:s},r?this._xrSessionManager.session&&!this._features[n].featureImplementation.attached&&this.attachFeature(n):this._features[n].featureImplementation.disableAutoAttach=!0,this._features[n].featureImplementation;if(s)throw new Error("required feature not compatible");return J.Warn(`Feature ${n} not compatible with the current environment/browser and was not enabled.`),u}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}async _extendXRSessionInitObject(e){const t=this.getEnabledFeatures();for(const i of t){const r=this._features[i],s=r.featureImplementation.xrNativeFeatureName;if(s&&(r.required?(e.requiredFeatures=e.requiredFeatures||[],e.requiredFeatures.indexOf(s)===-1&&e.requiredFeatures.push(s)):(e.optionalFeatures=e.optionalFeatures||[],e.optionalFeatures.indexOf(s)===-1&&e.optionalFeatures.push(s))),r.featureImplementation.getXRSessionInitExtension){const n=await r.featureImplementation.getXRSessionInitExtension();e={...e,...n}}}return e}}dr._AvailableFeatures={};dr._ConflictingFeatures={[si.TELEPORTATION]:si.MOVEMENT,[si.MOVEMENT]:si.TELEPORTATION};class Gs{constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this.xrNativeFeatureName=""}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,t=>this._onXRFrame(t)),!0}detach(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach(e=>{e.observable.remove(e.observer)}),!0):(this.disableAutoAttach=!0,!1)}dispose(){this.detach(),this.isDisposed=!0}isCompatible(){return!0}_addNewAttachObserver(e,t){this._removeOnDetach.push({observable:e,observer:e.add(t)})}}class Oi{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint,this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}}Oi.DistanceJoint=0;Oi.HingeJoint=1;Oi.BallAndSocketJoint=2;Oi.WheelJoint=3;Oi.SliderJoint=4;Oi.PrismaticJoint=5;Oi.UniversalJoint=6;Oi.Hinge2Joint=Oi.WheelJoint;Oi.PointToPointJoint=8;Oi.SpringJoint=9;Oi.LockJoint=10;K._PhysicsImpostorParser=function(o,e,t){return new ht(e,t.physicsImpostor,{mass:t.physicsMass,friction:t.physicsFriction,restitution:t.physicsRestitution},o)};class ht{get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPressure&&t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyStiffness&&t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyVelocityIterations&&t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPositionIterations&&t.setBodyPositionIterations(this,e)}constructor(e,t,i={mass:0},r){if(this.object=e,this.type=t,this._options=i,this._scene=r,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=x.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new oe,this._tmpQuat2=new oe,this.beforeStep=()=>{this._physicsEngine&&(this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new oe),this._options.disableBidirectionalTransformation||this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat),this._onBeforePhysicsStepCallbacks.forEach(s=>{s(this)}))},this.afterStep=()=>{this._physicsEngine&&(this._onAfterPhysicsStepCallbacks.forEach(s=>{s(this)}),this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,ht._TmpVecs[0]),this.object.translate(ht._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0))},this.onCollideEvent=null,this.onCollide=s=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent||!this._physicsEngine)return;const n=this._physicsEngine.getImpostorWithPhysicsBody(s.body);n&&(this.onCollideEvent&&this.onCollideEvent(this,n),this._onPhysicsCollideCallbacks.filter(a=>a.otherImpostors.indexOf(n)!==-1).forEach(a=>{a.callback(this,n,s.point,s.distance,s.impulse,s.normal)}))},!this.object){X.Error("No object was provided. A physics object is obligatory");return}this.object.parent&&i.mass!==0&&X.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=oe.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new oe),this._options.mass=i.mass===void 0?0:i.mass,this._options.friction=i.friction===void 0?.2:i.friction,this._options.restitution=i.restitution===void 0?.2:i.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=i.pressure===void 0?200:i.pressure,this._options.stiffness=i.stiffness===void 0?1:i.stiffness,this._options.velocityIterations=i.velocityIterations===void 0?20:i.velocityIterations,this._options.positionIterations=i.positionIterations===void 0?20:i.positionIterations,this._options.fixedPoints=i.fixedPoints===void 0?0:i.fixedPoints,this._options.margin=i.margin===void 0?0:i.margin,this._options.damping=i.damping===void 0?0:i.damping,this._options.path=i.path===void 0?null:i.path,this._options.shape=i.shape===void 0?null:i.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&X.Warn("You must affect impostors to children before affecting impostor to parent.")):X.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))}_init(){this._physicsEngine&&(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),!this._isDisposed&&(!this.parent||this._options.ignoreParent)&&this._physicsEngine.addImpostor(this))}_getPhysicsParent(){return this.object.parent instanceof Qt?this.object.parent.physicsImpostor:null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(this.object.getBoundingInfo){const e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=ht.IDENTITY_QUATERNION;const i=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);i&&i.decompose(t,void 0,void 0);const s=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return s.x=Math.abs(s.x),s.y=Math.abs(s.y),s.z=Math.abs(s.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),s}else return ht.DEFAULT_OBJECT_SIZE}getObjectCenter(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):x.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):x.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){const t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):X.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){const t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):X.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:i})}unregisterOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];let r=-1;this._onPhysicsCollideCallbacks.some((n,a)=>{if(n.callback===t&&n.otherImpostors.length===i.length){const l=n.otherImpostors.every(c=>i.indexOf(c)>-1);return l&&(r=a),l}return!1})?this._onPhysicsCollideCallbacks.splice(r,1):X.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):oe.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,i){const r=new Oi(t,i);return this.addJoint(e,r),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,i,r,s){if(!this._physicsEngine)return this;const n=this._physicsEngine.getPhysicsPlugin();return n.appendAnchor?(this._physicsEngine&&n.appendAnchor(this,e,t,i,r,s),this):this}addHook(e,t,i,r){if(!this._physicsEngine)return this;const s=this._physicsEngine.getPhysicsPlugin();return s.appendAnchor?(this._physicsEngine&&s.appendHook(this,e,t,i,r),this):this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new ht(e,this.type,this._options,this._scene):null}dispose(){this._physicsEngine&&(this._joints.forEach(e=>{this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint)}),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new oe),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,i,r,s){const n=ht._TmpVecs[0],a=this.object;if(a.rotationQuaternion)if(s){const l=ht._TmpQuat;a.rotationQuaternion.multiplyToRef(s,l),e.setRotationQuaternion(l,Kt.WORLD,t)}else e.setRotationQuaternion(a.rotationQuaternion,Kt.WORLD,t);n.x=0,n.y=0,n.z=0,i&&(n.x=i.x,n.y=i.y,n.z=i.z,e.getDirectionToRef(n,t,n),r==null&&(r=i.length()),n.x*=r,n.y*=r,n.z*=r),e.getParent()?(n.addInPlace(a.getAbsolutePosition()),e.setAbsolutePosition(n,t)):(t.setAbsolutePosition(a.getAbsolutePosition()),t.position.x-=n.x,t.position.y-=n.y,t.position.z-=n.z)}syncImpostorWithBone(e,t,i,r,s,n){const a=this.object;if(a.rotationQuaternion)if(s){const h=ht._TmpQuat;e.getRotationQuaternionToRef(Kt.WORLD,t,h),h.multiplyToRef(s,a.rotationQuaternion)}else e.getRotationQuaternionToRef(Kt.WORLD,t,a.rotationQuaternion);const l=ht._TmpVecs[0],c=ht._TmpVecs[1];n||(n=ht._TmpVecs[2],n.x=0,n.y=1,n.z=0),e.getDirectionToRef(n,t,c),e.getAbsolutePositionToRef(t,l),r==null&&i&&(r=i.length()),r!=null&&(l.x+=c.x*r,l.y+=c.y*r,l.z+=c.z*r),a.setAbsolutePosition(l)}}ht.DEFAULT_OBJECT_SIZE=new x(1,1,1);ht.IDENTITY_QUATERNION=oe.Identity();ht._TmpVecs=Br.BuildArray(3,x.Zero);ht._TmpQuat=oe.Identity();ht.NoImpostor=0;ht.SphereImpostor=1;ht.BoxImpostor=2;ht.PlaneImpostor=3;ht.MeshImpostor=4;ht.CapsuleImpostor=6;ht.CylinderImpostor=7;ht.ParticleImpostor=8;ht.HeightmapImpostor=9;ht.ConvexHullImpostor=10;ht.CustomImpostor=100;ht.RopeImpostor=101;ht.ClothImpostor=102;ht.SoftbodyImpostor=103;var ul;(function(o){o[o.Clean=0]="Clean",o[o.Stop=1]="Stop",o[o.Sync=2]="Sync",o[o.NoSync=3]="NoSync"})(ul||(ul={}));class ft{static get ForceFullSceneLoadingForIncremental(){return Wr.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){Wr.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return Wr.ShowLoadingScreen}static set ShowLoadingScreen(e){Wr.ShowLoadingScreen=e}static get loggingLevel(){return Wr.loggingLevel}static set loggingLevel(e){Wr.loggingLevel=e}static get CleanBoneMatrixWeights(){return Wr.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){Wr.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return ft._RegisteredPlugins[".babylon"]}static _GetPluginForExtension(e){const t=ft._RegisteredPlugins[e];return t||(X.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),ft.GetDefaultPlugin())}static _GetPluginForDirectLoad(e){for(const t in ft._RegisteredPlugins){const i=ft._RegisteredPlugins[t].plugin;if(i.canDirectLoad&&i.canDirectLoad(e))return ft._RegisteredPlugins[t]}return ft.GetDefaultPlugin()}static _GetPluginForFilename(e){const t=e.indexOf("?");t!==-1&&(e=e.substring(0,t));const i=e.lastIndexOf("."),r=e.substring(i,e.length).toLowerCase();return ft._GetPluginForExtension(r)}static _GetDirectLoad(e){return e.substr(0,5)==="data:"?e.substr(5):null}static _FormatErrorMessage(e,t,i){let r="Unable to load from "+e.url;return t?r+=`: ${t}`:i&&(r+=`: ${i}`),r}static _LoadData(e,t,i,r,s,n,a){const l=ft._GetDirectLoad(e.url),c=a?ft._GetPluginForExtension(a):l?ft._GetPluginForDirectLoad(e.url):ft._GetPluginForFilename(e.url);let h;if(c.plugin.createPlugin!==void 0?h=c.plugin.createPlugin():h=c.plugin,!h)throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(ft.OnPluginActivatedObservable.notifyObservers(h),l&&(h.canDirectLoad&&h.canDirectLoad(e.url)||!uf(e.url))){if(h.directLoad){const y=h.directLoad(t,l);y.then?y.then(S=>{i(h,S)}).catch(S=>{s("Error in directLoad of _loadData: "+S,S)}):i(h,y)}else i(h,l);return h}const u=c.isBinary,d=(y,S)=>{if(t.isDisposed){s("Scene has been disposed");return}i(h,y,S)};let f=null,_=!1;const p=h.onDisposeObservable;p&&p.add(()=>{_=!0,f&&(f.abort(),f=null),n()});const m=()=>{if(_)return;const y=(C,I)=>{s(C==null?void 0:C.statusText,I)},S=e.file||e.url;f=h.loadFile?h.loadFile(t,S,d,r,u,y):t._loadFile(S,d,r,!0,u,y)},T=t.getEngine();let b=T.enableOfflineSupport;if(b){let y=!1;for(const S of t.disableOfflineSupportExceptionRules)if(S.test(e.url)){y=!0;break}b=!y}return b&&q.OfflineProviderFactory?t.offlineProvider=q.OfflineProviderFactory(e.url,m,T.disableManifestCheck):m(),h}static _GetFileInfo(e,t){let i,r,s=null;if(!t)i=e,r=J.GetFilename(e),e=J.GetFolderPath(e);else if(t.name){const n=t;i=`file:${n.name}`,r=n.name,s=n}else if(typeof t=="string"&&t.startsWith("data:"))i=t,r="";else{const n=t;if(n.substr(0,1)==="/")return J.Error("Wrong sceneFilename parameter"),null;i=e+n,r=n}return{url:i,rootUrl:e,name:r,file:s}}static GetPluginForExtension(e){return ft._GetPluginForExtension(e).plugin}static IsPluginForExtensionAvailable(e){return!!ft._RegisteredPlugins[e]}static RegisterPlugin(e){if(typeof e.extensions=="string"){const t=e.extensions;ft._RegisteredPlugins[t.toLowerCase()]={plugin:e,isBinary:!1}}else{const t=e.extensions;Object.keys(t).forEach(i=>{ft._RegisteredPlugins[i.toLowerCase()]={plugin:e,isBinary:t[i].isBinary}})}}static ImportMesh(e,t,i="",r=qe.LastCreatedScene,s=null,n=null,a=null,l=null){if(!r)return X.Error("No scene available to import mesh to"),null;const c=ft._GetFileInfo(t,i);if(!c)return null;const h={};r.addPendingData(h);const u=()=>{r.removePendingData(h)},d=(p,m)=>{const T=ft._FormatErrorMessage(c,p,m);a?a(r,T,new Wa(T,Wo.SceneLoaderError,m)):X.Error(T),u()},f=n?p=>{try{n(p)}catch(m){d("Error in onProgress callback: "+m,m)}}:void 0,_=(p,m,T,b,y,S,C)=>{if(r.importedMeshesFiles.push(c.url),s)try{s(p,m,T,b,y,S,C)}catch(I){d("Error in onSuccess callback: "+I,I)}r.removePendingData(h)};return ft._LoadData(c,r,(p,m,T)=>{if(p.rewriteRootURL&&(c.rootUrl=p.rewriteRootURL(c.rootUrl,T)),p.importMesh){const b=p,y=new Array,S=new Array,C=new Array;if(!b.importMesh(e,r,m,c.rootUrl,y,S,C,d))return;r.loadingPluginName=p.name,_(y,S,C,[],[],[],[])}else p.importMeshAsync(e,r,m,c.rootUrl,f,c.name).then(y=>{r.loadingPluginName=p.name,_(y.meshes,y.particleSystems,y.skeletons,y.animationGroups,y.transformNodes,y.geometries,y.lights)}).catch(y=>{d(y.message,y)})},f,d,u,l)}static ImportMeshAsync(e,t,i="",r=qe.LastCreatedScene,s=null,n=null){return new Promise((a,l)=>{ft.ImportMesh(e,t,i,r,(c,h,u,d,f,_,p)=>{a({meshes:c,particleSystems:h,skeletons:u,animationGroups:d,transformNodes:f,geometries:_,lights:p})},s,(c,h,u)=>{l(u||new Error(h))},n)})}static Load(e,t="",i=qe.LastCreatedEngine,r=null,s=null,n=null,a=null){return i?ft.Append(e,t,new Ne(i),r,s,n,a):(J.Error("No engine available"),null)}static LoadAsync(e,t="",i=qe.LastCreatedEngine,r=null,s=null){return new Promise((n,a)=>{ft.Load(e,t,i,l=>{n(l)},r,(l,c,h)=>{a(h||new Error(c))},s)})}static Append(e,t="",i=qe.LastCreatedScene,r=null,s=null,n=null,a=null){if(!i)return X.Error("No scene available to append to"),null;const l=ft._GetFileInfo(e,t);if(!l)return null;const c={};i.addPendingData(c);const h=()=>{i.removePendingData(c)};ft.ShowLoadingScreen&&!this._ShowingLoadingScreen&&(this._ShowingLoadingScreen=!0,i.getEngine().displayLoadingUI(),i.executeWhenReady(()=>{i.getEngine().hideLoadingUI(),this._ShowingLoadingScreen=!1}));const u=(_,p)=>{const m=ft._FormatErrorMessage(l,_,p);n?n(i,m,new Wa(m,Wo.SceneLoaderError,p)):X.Error(m),h()},d=s?_=>{try{s(_)}catch(p){u("Error in onProgress callback",p)}}:void 0,f=()=>{if(r)try{r(i)}catch(_){u("Error in onSuccess callback",_)}i.removePendingData(c)};return ft._LoadData(l,i,(_,p)=>{if(_.load){if(!_.load(i,p,l.rootUrl,u))return;i.loadingPluginName=_.name,f()}else _.loadAsync(i,p,l.rootUrl,d,l.name).then(()=>{i.loadingPluginName=_.name,f()}).catch(T=>{u(T.message,T)})},d,u,h,a)}static AppendAsync(e,t="",i=qe.LastCreatedScene,r=null,s=null){return new Promise((n,a)=>{ft.Append(e,t,i,l=>{n(l)},r,(l,c,h)=>{a(h||new Error(c))},s)})}static LoadAssetContainer(e,t="",i=qe.LastCreatedScene,r=null,s=null,n=null,a=null){if(!i)return X.Error("No scene available to load asset container to"),null;const l=ft._GetFileInfo(e,t);if(!l)return null;const c={};i.addPendingData(c);const h=()=>{i.removePendingData(c)},u=(_,p)=>{const m=ft._FormatErrorMessage(l,_,p);n?n(i,m,new Wa(m,Wo.SceneLoaderError,p)):X.Error(m),h()},d=s?_=>{try{s(_)}catch(p){u("Error in onProgress callback",p)}}:void 0,f=_=>{if(r)try{r(_)}catch(p){u("Error in onSuccess callback",p)}i.removePendingData(c)};return ft._LoadData(l,i,(_,p)=>{if(_.loadAssetContainer){const T=_.loadAssetContainer(i,p,l.rootUrl,u);if(!T)return;i.loadingPluginName=_.name,f(T)}else _.loadAssetContainerAsync?_.loadAssetContainerAsync(i,p,l.rootUrl,d,l.name).then(T=>{i.loadingPluginName=_.name,f(T)}).catch(T=>{u(T.message,T)}):u("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},d,u,h,a)}static LoadAssetContainerAsync(e,t="",i=qe.LastCreatedScene,r=null,s=null){return new Promise((n,a)=>{ft.LoadAssetContainer(e,t,i,l=>{n(l)},r,(l,c,h)=>{a(h||new Error(c))},s)})}static ImportAnimations(e,t="",i=qe.LastCreatedScene,r=!0,s=ul.Clean,n=null,a=null,l=null,c=null,h=null){if(!i){X.Error("No scene available to load animations to");return}if(r){for(const _ of i.animatables)_.reset();i.stopAllAnimations(),i.animationGroups.slice().forEach(_=>{_.dispose()}),i.getNodes().forEach(_=>{_.animations&&(_.animations=[])})}else switch(s){case ul.Clean:i.animationGroups.slice().forEach(f=>{f.dispose()});break;case ul.Stop:i.animationGroups.forEach(f=>{f.stop()});break;case ul.Sync:i.animationGroups.forEach(f=>{f.reset(),f.restart()});break;case ul.NoSync:break;default:X.Error("Unknown animation group loading mode value '"+s+"'");return}const u=i.animatables.length,d=f=>{f.mergeAnimationsTo(i,i.animatables.slice(u),n),f.dispose(),i.onAnimationFileImportedObservable.notifyObservers(i),a&&a(i)};this.LoadAssetContainer(e,t,i,d,l,c,h)}static ImportAnimationsAsync(e,t="",i=qe.LastCreatedScene,r=!0,s=ul.Clean,n=null,a=null,l=null,c=null,h=null){return new Promise((u,d)=>{ft.ImportAnimations(e,t,i,r,s,n,f=>{u(f)},l,(f,_,p)=>{d(p||new Error(_))},h)})}}ft.NO_LOGGING=0;ft.MINIMAL_LOGGING=1;ft.SUMMARY_LOGGING=2;ft.DETAILED_LOGGING=3;ft.OnPluginActivatedObservable=new Q;ft._RegisteredPlugins={};ft._ShowingLoadingScreen=!1;class Fu extends me{constructor(e,t,i=!0){super(e,t),this._normalMatrix=new H,this._storeEffectOnSubMeshes=i}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return e?!this._storeEffectOnSubMeshes||!e.subMeshes||e.subMeshes.length===0?!0:this.isReadyForSubMesh(e,e.subMeshes[0],t):!1}_isReadyForSubMesh(e){const t=e.materialDefines;return!!(!this.checkReadyOnEveryCall&&e.effect&&t&&t._renderId===this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,t){t&&this.bindForSubMesh(e,t,t.subMeshes[0])}_afterBind(e,t=null){super._afterBind(e,t),this.getScene()._cachedEffect=t,t&&(t._forceRebindOnNextCall=!1)}_mustRebind(e,t,i=1){return e.isCachedMaterialInvalid(this,t,i)}}var N;(function(o){o[o.Float=1]="Float",o[o.Int=2]="Int",o[o.Vector2=4]="Vector2",o[o.Vector3=8]="Vector3",o[o.Vector4=16]="Vector4",o[o.Color3=32]="Color3",o[o.Color4=64]="Color4",o[o.Matrix=128]="Matrix",o[o.Object=256]="Object",o[o.AutoDetect=1024]="AutoDetect",o[o.BasedOnInput=2048]="BasedOnInput",o[o.All=4095]="All"})(N||(N={}));var W;(function(o){o[o.Vertex=1]="Vertex",o[o.Fragment=2]="Fragment",o[o.Neutral=4]="Neutral",o[o.VertexAndFragment=3]="VertexAndFragment"})(W||(W={}));class ov{constructor(){this.supportUniformBuffers=!1,this.attributes=new Array,this.uniforms=new Array,this.constants=new Array,this.samplers=new Array,this.functions={},this.extensions={},this.counters={},this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}finalize(e){const t=e.sharedData.emitComments,i=this.target===W.Fragment;this.compilationString=`\r
${t?`//Entry point\r
`:""}void main(void) {\r
${this.compilationString}`,this._constantDeclaration&&(this.compilationString=`\r
${t?`//Constants\r
`:""}${this._constantDeclaration}\r
${this.compilationString}`);let r="";for(const s in this.functions)r+=this.functions[s]+`\r
`;this.compilationString=`\r
${r}\r
${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}\r
${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}\r
${this._injectAtEnd}`),this.compilationString=`${this.compilationString}\r
}`,this.sharedData.varyingDeclaration&&(this.compilationString=`\r
${t?`//Varyings\r
`:""}${this.sharedData.varyingDeclaration}\r
${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`\r
${t?`//Samplers\r
`:""}${this._samplerDeclaration}\r
${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`\r
${t?`//Uniforms\r
`:""}${this._uniformDeclaration}\r
${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`\r
${t?`//Attributes\r
`:""}${this._attributeDeclaration}\r
${this.compilationString}`),this.compilationString=`precision highp float;\r
`+this.compilationString;for(const s in this.extensions){const n=this.extensions[s];this.compilationString=`\r
${n}\r
${this.compilationString}`}this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=e.replace(/[^a-zA-Z_]+/g,""),this.sharedData.variableNames[e]===void 0?(this.sharedData.variableNames[e]=0,e==="output"||e==="texture"?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return this.sharedData.defineNames[e]===void 0?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2D ${e};\r
`,this.samplers.push(e))}_getGLType(e){switch(e){case N.Float:return"float";case N.Int:return"int";case N.Vector2:return"vec2";case N.Color3:case N.Vector3:return"vec3";case N.Color4:case N.Vector4:return"vec4";case N.Matrix:return"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}\r
${t}\r
#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+`\r
`+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\r
`;let r=ri.IncludesShadersStore[e]+`\r
`;if(this.sharedData.emitComments&&(r=t+`\r
`+r),!i)return r;if(i.replaceStrings)for(let s=0;s<i.replaceStrings.length;s++){const n=i.replaceStrings[s];r=r.replace(n.search,n.replace)}return r}_emitFunctionFromInclude(e,t,i,r=""){const s=e+r;if(!this.functions[s]){if(!i||!i.removeAttributes&&!i.removeUniforms&&!i.removeVaryings&&!i.removeIfDef&&!i.replaceStrings){i&&i.repeatKey?this.functions[s]=`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\r
`:this.functions[s]=`#include<${e}>${i!=null&&i.substitutionVars?"("+(i==null?void 0:i.substitutionVars)+")":""}\r
`,this.sharedData.emitComments&&(this.functions[s]=t+`\r
`+this.functions[s]);return}if(this.functions[s]=ri.IncludesShadersStore[e],this.sharedData.emitComments&&(this.functions[s]=t+`\r
`+this.functions[s]),i.removeIfDef&&(this.functions[s]=this.functions[s].replace(/^\s*?#ifdef.+$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#endif.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#else.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[s]=this.functions[s].replace(/^\s*?attribute.+$/gm,"")),i.removeUniforms&&(this.functions[s]=this.functions[s].replace(/^\s*?uniform.+$/gm,"")),i.removeVaryings&&(this.functions[s]=this.functions[s].replace(/^\s*?varying.+$/gm,"")),i.replaceStrings)for(let n=0;n<i.replaceStrings.length;n++){const a=i.replaceStrings[n];this.functions[s]=this.functions[s].replace(a.search,a.replace)}}}_registerTempVariable(e){return this.sharedData.temps.indexOf(e)!==-1?!1:(this.sharedData.temps.push(e),!0)}_emitVaryingFromString(e,t,i="",r=!1){return this.sharedData.varyings.indexOf(e)!==-1?!1:(this.sharedData.varyings.push(e),i&&(i.startsWith("defined(")?this.sharedData.varyingDeclaration+=`#if ${i}\r
`:this.sharedData.varyingDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}\r
`),this.sharedData.varyingDeclaration+=`varying ${t} ${e};\r
`,i&&(this.sharedData.varyingDeclaration+=`#endif\r
`),!0)}_emitUniformFromString(e,t,i="",r=!1){this.uniforms.indexOf(e)===-1&&(this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}\r
`:this._uniformDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}\r
`),this._uniformDeclaration+=`uniform ${t} ${e};\r
`,i&&(this._uniformDeclaration+=`#endif\r
`))}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}}class VS{constructor(){this.temps=new Array,this.varyings=new Array,this.varyingDeclaration="",this.inputBlocks=new Array,this.textureBlocks=new Array,this.bindableBlocks=new Array,this.forcedBindableBlocks=new Array,this.blocksWithFallbacks=new Array,this.blocksWithDefines=new Array,this.repeatableContentBlocks=new Array,this.dynamicUniformBlocks=new Array,this.blockingBlocks=new Array,this.animatedInputs=new Array,this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(){let e="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(e+=`NodeMaterial does not have a vertex output. You need to at least add a block that generates a glPosition value.\r
`),this.checks.emitFragment||(e+=`NodeMaterial does not have a fragment output. You need to at least add a block that generates a glFragColor value.\r
`);for(const t of this.checks.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.\r
`;if(e)throw`Build of NodeMaterial failed:\r
`+e}}var sa;(function(o){o[o.Compatible=0]="Compatible",o[o.TypeIncompatible=1]="TypeIncompatible",o[o.TargetIncompatible=2]="TargetIncompatible",o[o.HierarchyIssue=3]="HierarchyIssue"})(sa||(sa={}));var nr;(function(o){o[o.Input=0]="Input",o[o.Output=1]="Output"})(nr||(nr={}));class nh{static AreEquivalentTypes(e,t){switch(e){case N.Vector3:{if(t===N.Color3)return!0;break}case N.Vector4:{if(t===N.Color4)return!0;break}case N.Color3:{if(t===N.Vector3)return!0;break}case N.Color4:{if(t===N.Vector4)return!0;break}}return!1}get direction(){return this._direction}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.associatedVariableName:this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===N.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===N.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get target(){return!this._prioritizeVertex||!this._ownerBlock?this._target:this._target!==W.VertexAndFragment?this._target:this._ownerBlock.target===W.Fragment?W.Fragment:W.Vertex}set target(e){this._target=e}get isConnected(){return this.connectedPoint!==null||this.hasEndpoints}get isConnectedToInputBlock(){return this.connectedPoint!==null&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return this._endpoints.length===0?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===W.Vertex||(e.ownerBlock.target===W.Neutral||e.ownerBlock.target===W.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isDirectlyConnectedToVertexOutput))return!0;return!1}get isConnectedInVertexShader(){if(this.target===W.Vertex)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===W.Vertex||e.target===W.Vertex||(e.ownerBlock.target===W.Neutral||e.ownerBlock.target===W.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInVertexShader))return!0;return!1}get isConnectedInFragmentShader(){if(this.target===W.Fragment)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===W.Fragment||(e.ownerBlock.target===W.Neutral||e.ownerBlock.target===W.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInFragmentShader))return!0;return!1}createCustomInputBlock(){return null}constructor(e,t,i){this._connectedPoint=null,this._endpoints=new Array,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this._linkedConnectionSource=null,this._acceptedConnectionPointType=null,this._type=N.Float,this._enforceAssociatedVariableName=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=new Array,this.excludedConnectionPointTypes=new Array,this.onConnectionObservable=new Q,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=W.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===sa.Compatible}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(t.target===W.Fragment){if(i.target===W.Vertex)return sa.TargetIncompatible;for(const n of i.outputs)if(n.ownerBlock.target!=W.Neutral&&n.isConnectedInVertexShader)return sa.TargetIncompatible}if(this.type!==e.type&&e.innerType!==N.AutoDetect)return nh.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&e.acceptedConnectionPointTypes.indexOf(this.type)!==-1||e._acceptedConnectionPointType&&nh.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?sa.Compatible:sa.TypeIncompatible;if(e.excludedConnectionPointTypes&&e.excludedConnectionPointTypes.indexOf(this.type)!==-1)return sa.TypeIncompatible;let r=i,s=t;return this.direction===nr.Input&&(r=t,s=i),r.isAnAncestorOf(s)?sa.HierarchyIssue:sa.Compatible}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return t===-1?this:(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1,this)}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<N.All;)e&t||this.excludedConnectionPointTypes.push(t),t=t<<1}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear()}}class rt{get name(){return this._name}set name(e){this.validateBlockName(e)&&(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){this._target&e||(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){const t=this._inputs.filter(i=>i.name===e);return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter(i=>i.name===e);return t.length?t[0]:null}constructor(e,t=W.Vertex,i=!1,r=!1){this._isFinalMerger=!1,this._isInput=!1,this._name="",this._isUnique=!1,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===W.Neutral,this._isFinalMerger=i,this._isInput=r,this._name=e,this.uniqueId=df.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===W.Neutral}initialize(e){}bind(e,t,i,r){}_declareOutput(e,t){return`${t._getGLType(e.type)} ${e.associatedVariableName}`}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return t.indexOf(".")===-1&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}registerInput(e,t,i=!1,r,s){return s=s??new nh(e,this,nr.Input),s.type=t,s.isOptional=i,r&&(s.target=r),this._inputs.push(s),this}registerOutput(e,t,i,r){return r=r??new nh(e,this,nr.Output),r.type=t,i&&(r.target=i),this._outputs.push(r),this}getFirstAvailableInput(e=null){for(const t of this._inputs)if(!t.connectedPoint&&(!e||e.type===t.type||t.type===N.AutoDetect))return t;return null}getFirstAvailableOutput(e=null){for(const t of this._outputs)if(!e||!e.target||e.target===W.Neutral||e.target&t.target)return t;return null}getSiblingOutput(e){const t=this._outputs.indexOf(e);return t===-1||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints){for(const i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,t){if(this._outputs.length===0)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),r=!0;for(;r;){const s=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&s&&i.canConnectTo(s))i.connectTo(s),r=!1;else if(i)i=this.getSiblingOutput(i);else throw"Unable to find a compatible match"}return this}_buildBlock(e){}updateUniformsAndSamples(e,t,i,r){}provideFallbacks(e,t){}initializeDefines(e,t,i,r=!1){}prepareDefines(e,t,i,r=!1,s){}autoConfigure(e){}replaceRepeatableContent(e,t,i,r){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return this.isInput||this.isFinalMerger||this._outputs.some(e=>e.isDirectlyConnectedToVertexOutput)||this.target===W.Vertex?!1:!!((this.target===W.VertexAndFragment||this.target===W.Neutral)&&this._outputs.some(e=>e.isConnectedInVertexShader))}isReady(e,t,i,r=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,r){e.build(t,r);const s=t._vertexState!=null,n=e._buildTarget===W.Vertex&&e.target!==W.VertexAndFragment;if(s&&(!(e.target&e._buildTarget)||!(e.target&i.target)||this.target!==W.VertexAndFragment&&n)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){const a=i.connectedPoint;t._vertexState._emitVaryingFromString("v_"+a.associatedVariableName,t._getGLType(a.type))&&(t._vertexState.compilationString+=`${"v_"+a.associatedVariableName} = ${a.associatedVariableName};\r
`),i.associatedVariableName="v_"+a.associatedVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){const t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(const i of t)if(e===i)return!1;return!0}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(const i of this._outputs)i.associatedVariableName||(i.associatedVariableName=e._getFreeVariableName(i.name));for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==W.Neutral&&(!(i.target&this.target)||!(i.target&e.target)))continue;const r=i.connectedPoint.ownerBlock;r&&r!==this&&this._processBuild(r,e,i,t)}if(this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&console.log(`${e.target===W.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case W.Vertex:e.sharedData.checks.emitVertex=!0;break;case W.Fragment:e.sharedData.checks.emitFragment=!0;break}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`\r
//${this.name}\r
`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(const i of this._outputs)if(i.target&e.target)for(const r of i.endpoints){const s=r.ownerBlock;s&&s.target&e.target&&t.indexOf(s)!==-1&&this._processBuild(s,e,r,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};\r
${e}.visibleOnFrame = ${this.visibleOnFrame};\r
${e}.target = ${this.target};\r
`}_dumpCode(e,t){t.push(this);let i;const r=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=r||`${this.getClassName()}_${this.uniqueId}`,e.indexOf(this._codeVariableName)!==-1){let s=0;do s++,this._codeVariableName=r+s;while(e.indexOf(this._codeVariableName)!==-1)}e.push(this._codeVariableName),i=`\r
// ${this.getClassName()}\r
`,this.comments&&(i+=`// ${this.comments}\r
`),i+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");\r
`,i+=this._dumpPropertiesCode();for(const s of this.inputs){if(!s.isConnected)continue;const a=s.connectedPoint.ownerBlock;t.indexOf(a)===-1&&(i+=a._dumpCode(e,t))}for(const s of this.outputs)if(s.hasEndpoints)for(const n of s.endpoints){const a=n.ownerBlock;a&&t.indexOf(a)===-1&&(i+=a._dumpCode(e,t))}return i}_dumpCodeForOutputConnections(e){let t="";if(e.indexOf(this)!==-1)return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint,s=r.ownerBlock;t+=s._dumpCodeForOutputConnections(e),t+=`${s._codeVariableName}.${s._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});\r
`}return t}clone(e,t=""){const i=this.serialize(),r=Xr(i.customType);if(r){const s=new r;return s._deserialize(i,e,t),s}return null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i){var r;this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=(r=e.target)!==null&&r!==void 0?r:this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach((r,s)=>{r.displayName&&(this.inputs[s].displayName=r.displayName),r.isExposedOnFrame&&(this.inputs[s].isExposedOnFrame=r.isExposedOnFrame,this.inputs[s].exposedPortPosition=r.exposedPortPosition)}),i&&i.forEach((r,s)=>{r.displayName&&(this.outputs[s].displayName=r.displayName),r.isExposedOnFrame&&(this.outputs[s].isExposedOnFrame=r.isExposedOnFrame,this.outputs[s].exposedPortPosition=r.exposedPortPosition)})}dispose(){for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose()}}class X_ extends rt{constructor(e){super(e,W.Neutral),this.complementW=1,this.complementZ=0,this.target=W.Vertex,this.registerInput("vector",N.AutoDetect),this.registerInput("transform",N.Matrix),this.registerOutput("output",N.Vector4),this.registerOutput("xyz",N.Vector3),this._inputs[0].onConnectionObservable.add(t=>{if(t.ownerBlock.isInput){const i=t.ownerBlock;(i.name==="normal"||i.name==="tangent")&&(this.complementW=0)}})}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.transform;if(t.connectedPoint){if(this.complementW===0){const r=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",r),e.sharedData.blocksWithDefines.push(this);const s=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(e.compilationString+=`mat3 ${s} = mat3(${i.associatedVariableName});\r
`,e.compilationString+=`#ifdef NONUNIFORMSCALING\r
`,e.compilationString+=`${s} = transposeMat3(inverseMat3(${s}));\r
`,e.compilationString+=`#endif\r
`,t.connectedPoint.type){case N.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${s} * vec3(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});\r
`;break;case N.Vector3:case N.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${s} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\r
`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${s} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});\r
`;break}}else{const r=i.associatedVariableName;switch(t.connectedPoint.type){case N.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = ${r} * vec4(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});\r
`;break;case N.Vector3:case N.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = ${r} * vec4(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\r
`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = ${r} * ${t.associatedVariableName};\r
`;break}}this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+` = ${this.output.associatedVariableName}.xyz;\r
`)}return this}prepareDefines(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)}serialize(){const e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=e.complementZ!==void 0?e.complementZ:0,this.complementW=e.complementW!==void 0?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};\r
`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};\r
`,e}}ye("BABYLON.TransformBlock",X_);class wd extends rt{constructor(e){super(e,W.Vertex,!0),this.registerInput("vector",N.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e){for(const t of e)if(t.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);const t=this.vector;return e.compilationString+=`gl_Position = ${t.associatedVariableName};\r
`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes)&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.compilationString+=`vFragmentDepth = 1.0 + gl_Position.w;\r
`,e.compilationString+=`gl_Position.z = log2(max(0.000001, vFragmentDepth)) * logarithmicDepthConstant;\r
`),this}}ye("BABYLON.VertexOutputBlock",wd);var zt;(function(o){o[o.Boolean=0]="Boolean",o[o.Float=1]="Float",o[o.Int=2]="Int",o[o.Vector2=3]="Vector2",o[o.List=4]="List"})(zt||(zt={}));function Xt(o,e=zt.Boolean,t="PROPERTIES",i){return(r,s)=>{let n=r._propStore;n||(n=[],r._propStore=n),n.push({propertyName:s,displayName:o,type:e,groupName:t,options:i??{}})}}class vl extends rt{constructor(e){super(e,W.Fragment,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",N.Color4,!0),this.registerInput("rgb",N.AutoDetect,!0),this.registerInput("a",N.Float,!0),this.rgb.addExcludedConnectionPointFromAllowedTypes(N.Color3|N.Vector3|N.Float)}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)}bind(e,t,i){this.useLogarithmicDepth&&i&&Ce.BindLogDepth(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=this.rgba,i=this.rgb,r=this.a;e.sharedData.hints.needAlphaBlending=t.isConnected||r.isConnected,e.sharedData.blocksWithDefines.push(this),this.useLogarithmicDepth&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.sharedData.bindableBlocks.push(this)),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");const s=`//${this.name}`;if(e._emitFunctionFromInclude("helperFunctions",s),t.connectedPoint)r.isConnected?e.compilationString+=`gl_FragColor = vec4(${t.associatedVariableName}.rgb, ${r.associatedVariableName});\r
`:e.compilationString+=`gl_FragColor = ${t.associatedVariableName};\r
`;else if(i.connectedPoint){let n="1.0";r.connectedPoint&&(n=r.associatedVariableName),i.connectedPoint.type===N.Float?e.compilationString+=`gl_FragColor = vec4(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${n});\r
`:e.compilationString+=`gl_FragColor = vec4(${i.associatedVariableName}, ${n});\r
`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);return e.compilationString+=`#ifdef ${this._linearDefineName}\r
`,e.compilationString+=`gl_FragColor = toLinearSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef ${this._gammaDefineName}\r
`,e.compilationString+=`gl_FragColor = toGammaSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,this.useLogarithmicDepth&&(e.compilationString+=`gl_FragDepthEXT = log2(vFragmentDepth) * logarithmicDepthConstant * 0.5;\r
`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\r
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\r
`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};\r
`,e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){var r;super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=e.convertToLinearSpace,this.useLogarithmicDepth=(r=e.useLogarithmicDepth)!==null&&r!==void 0?r:!1}}M([Xt("Convert to gamma space",zt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],vl.prototype,"convertToGammaSpace",void 0);M([Xt("Convert to linear space",zt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],vl.prototype,"convertToLinearSpace",void 0);M([Xt("Use logarithmic depth",zt.Boolean,"PROPERTIES")],vl.prototype,"useLogarithmicDepth",void 0);ye("BABYLON.FragmentOutputBlock",vl);var ws;(function(o){o[o.Uniform=0]="Uniform",o[o.Attribute=1]="Attribute",o[o.Varying=2]="Varying",o[o.Undefined=3]="Undefined"})(ws||(ws={}));var Rt;(function(o){o[o.World=1]="World",o[o.View=2]="View",o[o.Projection=3]="Projection",o[o.ViewProjection=4]="ViewProjection",o[o.WorldView=5]="WorldView",o[o.WorldViewProjection=6]="WorldViewProjection",o[o.CameraPosition=7]="CameraPosition",o[o.FogColor=8]="FogColor",o[o.DeltaTime=9]="DeltaTime",o[o.CameraParameters=10]="CameraParameters",o[o.MaterialAlpha=11]="MaterialAlpha"})(Rt||(Rt={}));var ml;(function(o){o[o.None=0]="None",o[o.Time=1]="Time",o[o.RealTime=2]="RealTime"})(ml||(ml={}));const kS={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},g_={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},lv={particle_texturemask:!0};class yt extends rt{get type(){if(this._type===N.AutoDetect){if(this.isUniform&&this.value!=null){if(!isNaN(this.value))return this._type=N.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=N.Vector2,this._type;case"Vector3":return this._type=N.Vector3,this._type;case"Vector4":return this._type=N.Vector4,this._type;case"Color3":return this._type=N.Color3,this._type;case"Color4":return this._type=N.Color4,this._type;case"Matrix":return this._type=N.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"particle_positionw":return this._type=N.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":return this._type=N.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=N.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":return this._type=N.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case Rt.World:case Rt.WorldView:case Rt.WorldViewProjection:case Rt.View:case Rt.ViewProjection:case Rt.Projection:return this._type=N.Matrix,this._type;case Rt.CameraPosition:return this._type=N.Vector3,this._type;case Rt.FogColor:return this._type=N.Color3,this._type;case Rt.DeltaTime:case Rt.MaterialAlpha:return this._type=N.Float,this._type;case Rt.CameraParameters:return this._type=N.Vector4,this._type}}return this._type}constructor(e,t=W.Vertex,i=N.AutoDetect){super(e,t,!1,!0),this._mode=ws.Undefined,this._animationType=ml.None,this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new Q,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}validateBlockName(e){return this.isAttribute?!0:super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=ws.Attribute,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===N.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=ws.Uniform,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=ws.Uniform}get associatedVariableName(){return this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return this._mode===ws.Undefined}get isUniform(){return this._mode===ws.Uniform}set isUniform(e){this._mode=e?ws.Uniform:ws.Undefined,this.associatedVariableName=""}get isAttribute(){return this._mode===ws.Attribute}set isAttribute(e){this._mode=e?ws.Attribute:ws.Undefined,this.associatedVariableName=""}get isVarying(){return this._mode===ws.Varying}set isVarying(e){this._mode=e?ws.Varying:ws.Undefined,this.associatedVariableName=""}get isSystemValue(){return this._systemValue!=null}get systemValue(){return this._systemValue}set systemValue(e){this._mode=ws.Uniform,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case ml.Time:{this.type===N.Float&&(this.value+=e.getAnimationRatio()*.01);break}case ml.RealTime:{this.type===N.Float&&(this.value=(Us.Now-e.getEngine().startTime)/1e3);break}}}_emitDefine(e){return e[0]==="!"?`#ifndef ${e.substring(1)}\r
`:`#ifdef ${e}\r
`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case N.Float:this.value=0;break;case N.Vector2:this.value=Ie.Zero();break;case N.Vector3:this.value=x.Zero();break;case N.Vector4:this.value=Tt.Zero();break;case N.Color3:this.value=ge.White();break;case N.Color4:this.value=new Ye(1,1,1,1);break;case N.Matrix:this.value=H.Identity();break}}_emitConstant(e){switch(this.type){case N.Float:return`${e._emitFloat(this.value)}`;case N.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case N.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case N.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case N.Color3:return Jt.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&Jt.Color3[0].toGammaSpaceToRef(Jt.Color3[0]),this.convertToLinearSpace&&Jt.Color3[0].toLinearSpaceToRef(Jt.Color3[0]),`vec3(${Jt.Color3[0].r}, ${Jt.Color3[0].g}, ${Jt.Color3[0].b})`;case N.Color4:return Jt.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&Jt.Color4[0].toGammaSpaceToRef(Jt.Color4[0]),this.convertToLinearSpace&&Jt.Color4[0].toLinearSpaceToRef(Jt.Color4[0]),`vec4(${Jt.Color4[0].r}, ${Jt.Color4[0].g}, ${Jt.Color4[0].b}, ${Jt.Color4[0].a})`}return""}get _noContextSwitch(){return g_[this.name]}_emit(e,t){var i;if(this.isUniform){if(this.associatedVariableName||(this.associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(e.constants.indexOf(this.associatedVariableName)!==-1)return;e.constants.push(this.associatedVariableName),e._constantDeclaration+=this._declareOutput(this.output,e)+` = ${this._emitConstant(e)};\r
`;return}if(e.uniforms.indexOf(this.associatedVariableName)!==-1)return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t)),e._uniformDeclaration+=`uniform ${e._getGLType(this.type)} ${this.associatedVariableName};\r
`,t&&(e._uniformDeclaration+=`#endif\r
`);const r=e.sharedData.hints;if(this._systemValue!==null&&this._systemValue!==void 0)switch(this._systemValue){case Rt.WorldView:r.needWorldViewMatrix=!0;break;case Rt.WorldViewProjection:r.needWorldViewProjectionMatrix=!0;break}else this._animationType!==ml.None&&e.sharedData.animatedInputs.push(this);return}if(this.isAttribute){if(this.associatedVariableName=(i=kS[this.name])!==null&&i!==void 0?i:this.name,this.target===W.Vertex&&e._vertexState){g_[this.name]?lv[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):this._emit(e._vertexState,t);return}if(e.attributes.indexOf(this.associatedVariableName)!==-1)return;e.attributes.push(this.associatedVariableName),g_[this.name]?lv[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):(t&&(e._attributeDeclaration+=this._emitDefine(t)),e._attributeDeclaration+=`attribute ${e._getGLType(this.type)} ${this.associatedVariableName};\r
`,t&&(e._attributeDeclaration+=`#endif\r
`))}}_transmitWorld(e,t,i,r){if(!this._systemValue)return;const s=this.associatedVariableName;switch(this._systemValue){case Rt.World:e.setMatrix(s,t);break;case Rt.WorldView:e.setMatrix(s,i);break;case Rt.WorldViewProjection:e.setMatrix(s,r);break}}_transmit(e,t,i){if(this.isAttribute)return;const r=this.associatedVariableName;if(this._systemValue){switch(this._systemValue){case Rt.World:case Rt.WorldView:case Rt.WorldViewProjection:return;case Rt.View:e.setMatrix(r,t.getViewMatrix());break;case Rt.Projection:e.setMatrix(r,t.getProjectionMatrix());break;case Rt.ViewProjection:e.setMatrix(r,t.getTransformMatrix());break;case Rt.CameraPosition:t.bindEyePosition(e,r,!0);break;case Rt.FogColor:e.setColor3(r,t.fogColor);break;case Rt.DeltaTime:e.setFloat(r,t.deltaTime/1e3);break;case Rt.CameraParameters:t.activeCamera&&e.setFloat4(r,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case Rt.MaterialAlpha:e.setFloat(r,i.alpha);break}return}const s=this._valueCallback?this._valueCallback():this._storedValue;if(s!==null)switch(this.type){case N.Float:e.setFloat(r,s);break;case N.Int:e.setInt(r,s);break;case N.Color3:Jt.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&Jt.Color3[0].toGammaSpaceToRef(Jt.Color3[0]),this.convertToLinearSpace&&Jt.Color3[0].toLinearSpaceToRef(Jt.Color3[0]),e.setColor3(r,Jt.Color3[0]);break;case N.Color4:Jt.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&Jt.Color4[0].toGammaSpaceToRef(Jt.Color4[0]),this.convertToLinearSpace&&Jt.Color4[0].toLinearSpaceToRef(Jt.Color4[0]),e.setDirectColor4(r,Jt.Color4[0]);break;case N.Vector2:e.setVector2(r,s);break;case N.Vector3:e.setVector3(r,s);break;case N.Vector4:e.setVector4(r,s);break;case N.Matrix:e.setMatrix(r,s);break}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");\r
`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${Rt[this._systemValue]});\r
`;if(this.isUniform){const t=[];let i="";switch(this.type){case N.Float:i=`${this.value}`;break;case N.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case N.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case N.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case N.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case N.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case N.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m}])`;break}return t.push(`${e}.value = ${i}`),this.type===N.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${ml[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(`;\r
`)}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this._storedValue!=null&&this._mode===ws.Uniform&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.name==="tangent"&&e.mode===ws.Attribute&&e.type===N.Vector3&&(this._type=N.Vector4),!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{const r=Xr(e.valueType);r&&(this._storedValue=r.FromArray(e.value))}}}ye("BABYLON.InputBlock",yt);class yT extends rt{constructor(e){super(e,W.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",N.AutoDetect,!1,W.VertexAndFragment),this.registerOutput("rgba",N.Color4,W.Neutral),this.registerOutput("rgb",N.Color3,W.Neutral),this.registerOutput("r",N.Float,W.Neutral),this.registerOutput("g",N.Float,W.Neutral),this.registerOutput("b",N.Float,W.Neutral),this.registerOutput("a",N.Float,W.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(N.Vector2|N.Vector3|N.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?W.VertexAndFragment:W.Fragment}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec2")),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\r
`,!!this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name,!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===W.Fragment)return;e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName});\r
`;return}if(this.uv.ownerBlock.target===W.Fragment){e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName});\r
`;return}e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this._mainUVName});\r
`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===W.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`;return}if(this.uv.ownerBlock.target===W.Fragment){e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`;return}e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`,e.compilationString+=`#ifdef ${this._linearDefineName}\r
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef ${this._gammaDefineName}\r
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==W.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(!this._outputs.some(i=>i.isConnectedInFragmentShader))return;e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=Y.Parse(e.texture,t,i))}}ye("BABYLON.CurrentScreenBlock",yT);class CT extends rt{constructor(e){super(e,W.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",N.AutoDetect,!1,W.VertexAndFragment),this.registerOutput("rgba",N.Color4,W.Neutral),this.registerOutput("rgb",N.Color3,W.Neutral),this.registerOutput("r",N.Float,W.Neutral),this.registerOutput("g",N.Float,W.Neutral),this.registerOutput("b",N.Float,W.Neutral),this.registerOutput("a",N.Float,W.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(N.Vector2|N.Vector3|N.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e){if(!this.uv.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="particle_uv");t||(t=new yt("uv"),t.setAsAttribute("particle_uv")),t.output.connectTo(this.uv)}}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,i){e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`,e.compilationString+=`#ifdef ${this._linearDefineName}\r
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef ${this._gammaDefineName}\r
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`}_buildBlock(e){if(super._buildBlock(e),e.target===W.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this.uv.associatedVariableName});\r
`;for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=Y.Parse(e.texture,t,i))}}ye("BABYLON.ParticleTextureBlock",CT);class AT extends rt{constructor(e){super(e,W.Fragment),this._isUnique=!0,this.registerInput("color",N.Color4,!1,W.Fragment),this.registerOutput("rampColor",N.Color4,W.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor"),e._excludeVariableName("finalAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==W.Vertex)return e._emit2DSampler("rampSampler"),e._emitVaryingFromString("remapRanges","vec4","RAMPGRADIENT"),e.compilationString+=`
            #ifdef RAMPGRADIENT
                vec4 baseColor = ${this.color.associatedVariableName};
                float alpha = ${this.color.associatedVariableName}.a;

                float remappedColorIndex = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);

                vec4 rampColor = texture2D(rampSampler, vec2(1.0 - remappedColorIndex, 0.));
                baseColor.rgb *= rampColor.rgb;

                // Remapped alpha
                float finalAlpha = baseColor.a;
                baseColor.a = clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0);

                ${this._declareOutput(this.rampColor,e)} = baseColor;
            #else
                ${this._declareOutput(this.rampColor,e)} = ${this.color.associatedVariableName};
            #endif
        `,this}}ye("BABYLON.ParticleRampGradientBlock",AT);class RT extends rt{constructor(e){super(e,W.Fragment),this._isUnique=!0,this.registerInput("color",N.Color4,!1,W.Fragment),this.registerInput("alphaTexture",N.Float,!1,W.Fragment),this.registerInput("alphaColor",N.Float,!1,W.Fragment),this.registerOutput("blendColor",N.Color4,W.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==W.Vertex)return e.compilationString+=`
            #ifdef BLENDMULTIPLYMODE
                ${this._declareOutput(this.blendColor,e)};
                float sourceAlpha = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};
                ${this.blendColor.associatedVariableName}.rgb = ${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha);
                ${this.blendColor.associatedVariableName}.a = ${this.color.associatedVariableName}.a;
            #else
                ${this._declareOutput(this.blendColor,e)} = ${this.color.associatedVariableName};
            #endif
        `,this}}ye("BABYLON.ParticleBlendMultiplyBlock",RT);class pc{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;const i=this._mesh.getScene();for(let r=0;r<i.meshes.length;r++){const s=i.meshes[r];if(!s.material){!this._mesh.material&&s.computeBonesUsingShaders&&s.numBoneInfluencers>0&&(s.computeBonesUsingShaders=!1);continue}if(!(!s.computeBonesUsingShaders||s.numBoneInfluencers===0)){if(s.material.getEffect()===t)s.computeBonesUsingShaders=!1;else if(s.subMeshes){for(const n of s.subMeshes)if(n.effect===t){s.computeBonesUsingShaders=!1;break}}}}}else{const i=this._defines[this._currentRank];if(i)for(let r=0;r<i.length;r++)e=e.replace("#define "+i[r],"");this._currentRank++}return e}}const GS="postprocessVertexShader",zS=`attribute vec2 position;
uniform vec2 scale;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd)*scale;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;te.ShadersStore[GS]=zS;class lm{get depthStencilTexture(){return this._depthStencilTexture}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get size(){return this.width}get width(){return this._size.width||this._size}get height(){return this._size.height||this._size}get layers(){return this._size.layers||0}get texture(){var e,t;return(t=(e=this._textures)===null||e===void 0?void 0:e[0])!==null&&t!==void 0?t:null}get textures(){return this._textures}get samples(){return this._samples}setSamples(e,t=!0,i=!1){if(this.samples===e&&!i)return e;const r=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,r}constructor(e,t,i,r){this._textures=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=e,this._isCube=t,this._size=i,this._engine=r,this._depthStencilTexture=null}setTextures(e){Array.isArray(e)?this._textures=e:e?this._textures=[e]:this._textures=null}setTexture(e,t=0,i=!0){this._textures||(this._textures=[]),this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e}createDepthStencilTexture(e=0,t=!0,i=!1,r=1,s=14){var n;return(n=this._depthStencilTexture)===null||n===void 0||n.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:r,depthTextureFormat:s},this),this._depthStencilTexture}_shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){var e,t,i,r,s,n;let a=null;if(this._isMulti){const l=this.textures;if(l&&l.length>0){let c=!1,h=l.length;const u=l[l.length-1]._source;(u===bt.Depth||u===bt.DepthStencil)&&(c=!0,h--);const d=[],f=[];for(let m=0;m<h;++m){const T=l[m];d.push(T.samplingMode),f.push(T.type)}const _={samplingModes:d,generateMipMaps:l[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:c,types:f,textureCount:h},p={width:this.width,height:this.height};a=this._engine.createMultipleRenderTarget(p,_)}}else{const l={};if(l.generateDepthBuffer=this._generateDepthBuffer,l.generateMipMaps=(t=(e=this.texture)===null||e===void 0?void 0:e.generateMipMaps)!==null&&t!==void 0?t:!1,l.generateStencilBuffer=this._generateStencilBuffer,l.samplingMode=(i=this.texture)===null||i===void 0?void 0:i.samplingMode,l.type=(r=this.texture)===null||r===void 0?void 0:r.type,l.format=(s=this.texture)===null||s===void 0?void 0:s.format,this.isCube)a=this._engine.createRenderTargetCubeTexture(this.width,l);else{const c={width:this.width,height:this.height,layers:this.is2DArray?(n=this.texture)===null||n===void 0?void 0:n.depth:void 0};a=this._engine.createRenderTargetTexture(c,l)}a.texture.isReady=!0}return a}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){const t=this._depthStencilTexture.samplingMode,i=t===2||t===3||t===11;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,i,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){var e,t;if(this._textures)for(let i=0;(t=i<((e=this._textures)===null||e===void 0?void 0:e.length))!==null&&t!==void 0&&t;++i)this._textures[i].dispose();this._textures=null}dispose(e=!1){var t;e||((t=this._depthStencilTexture)===null||t===void 0||t.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}class HS extends lm{constructor(e,t,i,r,s){super(e,t,i,r),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._context=s}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}_shareDepth(e){super._shareDepth(e);const t=this._context,i=this._depthStencilBuffer,r=e._MSAAFramebuffer||e._framebuffer;e._depthStencilBuffer&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=this._depthStencilBuffer,this._engine._bindUnboundFramebuffer(r),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,i),this._engine._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,i=-1,r=0){if(!e._hardwareTexture)return;const s=this._context,n=this._framebuffer,a=this._engine._currentFramebuffer;this._engine._bindUnboundFramebuffer(n);const l=s[this._engine.webGLVersion>1?"COLOR_ATTACHMENT"+t:"COLOR_ATTACHMENT"+t+"_WEBGL"],c=i!==-1?s.TEXTURE_CUBE_MAP_POSITIVE_X+i:s.TEXTURE_2D;s.framebufferTexture2D(s.FRAMEBUFFER,l,c,e._hardwareTexture.underlyingResource,r),this._engine._bindUnboundFramebuffer(a)}setTexture(e,t=0,i=!0){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t)}dispose(e=!1){const t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}ze.prototype._createHardwareRenderTargetWrapper=function(o,e,t){const i=new HS(o,e,t,this,this._gl);return this._renderTargetWrapperCache.push(i),i};ze.prototype.createRenderTargetTexture=function(o,e){var t,i;const r=this._createHardwareRenderTargetWrapper(!1,!1,o);let s=!0,n=!1,a=!1,l,c=1;e!==void 0&&typeof e=="object"&&(s=(t=e.generateDepthBuffer)!==null&&t!==void 0?t:!0,n=!!e.generateStencilBuffer,a=!!e.noColorAttachment,l=e.colorAttachment,c=(i=e.samples)!==null&&i!==void 0?i:1);const h=l||(a?null:this._createInternalTexture(o,e,!0,bt.RenderTarget)),u=o.width||o,d=o.height||o,f=this._currentFramebuffer,_=this._gl,p=_.createFramebuffer();return this._bindUnboundFramebuffer(p),r._depthStencilBuffer=this._setupFramebufferDepthAttachments(n,s,u,d),h&&!h.is2DArray&&_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,h._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(f),r._framebuffer=p,r._generateDepthBuffer=s,r._generateStencilBuffer=n,r.setTextures(h),this.updateRenderTargetTextureSampleCount(r,c),r};ze.prototype.createDepthStencilTexture=function(o,e,t){if(e.isCube){const i=o.width||o;return this._createDepthStencilCubeTexture(i,e,t)}else return this._createDepthStencilTexture(o,e,t)};ze.prototype._createDepthStencilTexture=function(o,e,t){const i=this._gl,r=o.layers||0,s=r!==0?i.TEXTURE_2D_ARRAY:i.TEXTURE_2D,n=new hi(this,bt.DepthStencil);if(!this._caps.depthTextureExtension)return X.Error("Depth texture is not supported by your browser or hardware."),n;const a={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e};if(this._bindTextureDirectly(s,n,!0),this._setupDepthStencilTexture(n,o,a.generateStencil,a.comparisonFunction===0?!1:a.bilinearFiltering,a.comparisonFunction,a.samples),a.depthTextureFormat!==void 0){if(a.depthTextureFormat!==15&&a.depthTextureFormat!==16&&a.depthTextureFormat!==17&&a.depthTextureFormat!==13&&a.depthTextureFormat!==14&&a.depthTextureFormat!==18)return X.Error("Depth texture format is not supported."),n;n.format=a.depthTextureFormat}else n.format=a.generateStencil?13:16;const l=n.format===17||n.format===13||n.format===18;t._depthStencilTexture=n,t._depthStencilTextureWithStencil=l;let c=i.UNSIGNED_INT;n.format===15?c=i.UNSIGNED_SHORT:n.format===17||n.format===13?c=i.UNSIGNED_INT_24_8:n.format===14?c=i.FLOAT:n.format===18&&(c=i.FLOAT_32_UNSIGNED_INT_24_8_REV);const h=l?i.DEPTH_STENCIL:i.DEPTH_COMPONENT;let u=h;this.webGLVersion>1&&(n.format===15?u=i.DEPTH_COMPONENT16:n.format===16?u=i.DEPTH_COMPONENT24:n.format===17||n.format===13?u=i.DEPTH24_STENCIL8:n.format===14?u=i.DEPTH_COMPONENT32F:n.format===18&&(u=i.DEPTH32F_STENCIL8)),n.is2DArray?i.texImage3D(s,0,u,n.width,n.height,r,0,h,c,null):i.texImage2D(s,0,u,n.width,n.height,0,h,c,null),this._bindTextureDirectly(s,null),this._internalTexturesCache.push(n);const d=t;if(d._depthStencilBuffer){const f=this._currentFramebuffer;this._bindUnboundFramebuffer(d._framebuffer),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,null),this._bindUnboundFramebuffer(f),i.deleteRenderbuffer(d._depthStencilBuffer),d._depthStencilBuffer=null}return n};ze.prototype.updateRenderTargetTextureSampleCount=function(o,e){if(this.webGLVersion<2||!o||!o.texture)return 1;if(o.samples===e)return e;const t=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),o._depthStencilBuffer&&(t.deleteRenderbuffer(o._depthStencilBuffer),o._depthStencilBuffer=null),o._MSAAFramebuffer&&(t.deleteFramebuffer(o._MSAAFramebuffer),o._MSAAFramebuffer=null);const i=o.texture._hardwareTexture;if(i._MSAARenderBuffer&&(t.deleteRenderbuffer(i._MSAARenderBuffer),i._MSAARenderBuffer=null),e>1&&typeof t.renderbufferStorageMultisample=="function"){const r=t.createFramebuffer();if(!r)throw new Error("Unable to create multi sampled framebuffer");o._MSAAFramebuffer=r,this._bindUnboundFramebuffer(o._MSAAFramebuffer);const s=this._createRenderBuffer(o.texture.width,o.texture.height,e,-1,this._getRGBAMultiSampleBufferFormat(o.texture.type),t.COLOR_ATTACHMENT0,!1);if(!s)throw new Error("Unable to create multi sampled framebuffer");i._MSAARenderBuffer=s}else this._bindUnboundFramebuffer(o._framebuffer);return o.texture.samples=e,o._samples=e,o._depthStencilBuffer=this._setupFramebufferDepthAttachments(o._generateStencilBuffer,o._generateDepthBuffer,o.texture.width,o.texture.height,e),this._bindUnboundFramebuffer(null),e};class et{static RegisterShaderCodeProcessing(e,t){if(!t){delete et._CustomShaderCodeProcessing[e??""];return}et._CustomShaderCodeProcessing[e??""]=t}static _GetShaderCodeProcessing(e){var t;return(t=et._CustomShaderCodeProcessing[e])!==null&&t!==void 0?t:et._CustomShaderCodeProcessing[""]}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(t=>{t.setSamples(this._samples)})}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,i,r,s,n,a=1,l,c,h=null,u=0,d="postprocess",f,_=!1,p=5,m=Gi.GLSL){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.alphaMode=0,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new Lr(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new Ie(1,1),this._texelSize=Ie.Zero(),this.onActivateObservable=new Q,this.onSizeChangedObservable=new Q,this.onApplyObservable=new Q,this.onBeforeRenderObservable=new Q,this.onAfterRenderObservable=new Q,this.name=e,n!=null?(this._camera=n,this._scene=n.getScene(),n.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):l&&(this._engine=l,this._engine.postProcesses.push(this)),this._options=s,this.renderTargetSamplingMode=a||1,this._reusable=c||!1,this._textureType=u,this._textureFormat=p,this._shaderLanguage=m,this._samplers=r||[],this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=d,this._parameters=i||[],this._parameters.push("scale"),this._indexParameters=f,this._drawWrapper=new vs(this._engine),_||this.updateEffect(h)}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){this._textures.length==0&&(this._textures=new Lr(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,i=null,r,s,n,a,l){var c,h;const u=et._GetShaderCodeProcessing(this.name);if(u!=null&&u.defineCustomBindings){const d=(c=t==null?void 0:t.slice())!==null&&c!==void 0?c:[];d.push(...this._parameters);const f=(h=i==null?void 0:i.slice())!==null&&h!==void 0?h:[];f.push(...this._samplers),e=u.defineCustomBindings(this.name,e,d,f),t=d,i=f}this._postProcessDefines=e,this._drawWrapper.effect=this._engine.createEffect({vertex:a??this._vertexUrl,fragment:l??this._fragmentUrl},{attributes:["position"],uniformsNames:t||this._parameters,uniformBuffersNames:[],samplers:i||this._samplers,defines:e!==null?e:"",fallbacks:null,onCompiled:s??null,onError:n??null,indexParameters:r||this._indexParameters,processCodeAfterIncludes:u!=null&&u.processCodeAfterIncludes?(d,f)=>u.processCodeAfterIncludes(this.name,d,f):null,processFinalCode:u!=null&&u.processFinalCode?(d,f)=>u.processFinalCode(this.name,d,f):null,shaderLanguage:this._shaderLanguage},this._engine)}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,i=0){for(let s=0;s<this._textureCache.length;s++)if(this._textureCache[s].texture.width===e.width&&this._textureCache[s].texture.height===e.height&&this._textureCache[s].postProcessChannel===i&&this._textureCache[s].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[s].texture.samples===t.samples)return this._textureCache[s].texture;const r=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:r,postProcessChannel:i,lastUsedRenderId:-1}),r}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let i=!1;for(let r=0;r<this._textures.length;r++)if(this._textures.data[r]===this._textureCache[t].texture){i=!0;break}i||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}_resize(e,t,i,r,s){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let n=null;for(let c=0;c<i._postProcesses.length;c++)if(i._postProcesses[c]!==null){n=i._postProcesses[c];break}const a={width:this.width,height:this.height},l={generateMipMaps:r,generateDepthBuffer:s||n===this,generateStencilBuffer:(s||n===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples};this._textures.push(this._createRenderTargetTexture(a,l,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(a,l,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}activate(e,t=null,i){var r,s;e=e||this._camera;const n=e.getScene(),a=n.getEngine(),l=a.getCaps().maxTextureSize;let c=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0;const h=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0,u=e.parent;u&&(u.leftCamera==e||u.rightCamera==e)&&(c/=2);let d=this._options.width||c,f=this._options.height||h;const _=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const m=a.currentViewport;m&&(d*=m.width,f*=m.height)}(_||this.alwaysForcePOT)&&(this._options.width||(d=a.needPOTTextures?q.GetExponentOfTwo(d,l,this.scaleMode):d),this._options.height||(f=a.needPOTTextures?q.GetExponentOfTwo(f,l,this.scaleMode):f)),(this.width!==d||this.height!==f)&&this._resize(d,f,e,_,i),this._textures.forEach(m=>{m.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(m,this.samples)}),this._flushTextureCache(),this._renderId++}let p;if(this._shareOutputWithPostProcess)p=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)p=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{p=this.inputTexture;let m;for(let T=0;T<this._textureCache.length;T++)if(this._textureCache[T].texture===p){m=this._textureCache[T];break}m&&(m.lastUsedRenderId=this._renderId)}return this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(c/d,h/f),this._engine.bindFramebuffer(p,0,c,h,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(p,0,void 0,void 0,this.forceFullscreenViewport)),(s=(r=this._engine)._debugInsertMarker)===null||s===void 0||s.call(r,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(e),this.autoClear&&this.alphaMode===0&&this._engine.clear(this.clearColor?this.clearColor:n.clearColor,n._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),p}get isSupported(){return this._drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){var e,t;return(t=(e=this._drawWrapper.effect)===null||e===void 0?void 0:e.isReady())!==null&&t!==void 0?t:!1}apply(){var e,t,i;if(!(!((e=this._drawWrapper.effect)===null||e===void 0)&&e.isReady()))return null;this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);let r;return this._shareOutputWithPostProcess?r=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?r=this._forcedOutputTexture:r=this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",r==null?void 0:r.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),(i=(t=et._GetShaderCodeProcessing(this.name))===null||t===void 0?void 0:t.bindCustomBindings)===null||i===void 0||i.call(t,this.name,this._drawWrapper.effect),this._drawWrapper.effect}_disposeTextures(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1}dispose(e){e=e||this._camera,this._disposeTextures();let t;if(this._scene&&(t=this._scene.postProcesses.indexOf(this),t!==-1&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const i=this._parentContainer.postProcesses.indexOf(this);i>-1&&this._parentContainer.postProcesses.splice(i,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),t!==-1&&this._engine.postProcesses.splice(t,1),!!e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),t===0&&e._postProcesses.length>0){const i=this._camera._getFirstPostProcess();i&&i.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}}serialize(){const e=ke.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=et.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,i){const r=Xr(e.customType);if(!r||!r._Parse)return null;const s=t?t.getCameraById(e.cameraId):null;return r._Parse(e,s,t,i)}static _Parse(e,t,i,r){return ke.Parse(()=>new et(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,i,r)}}et._CustomShaderCodeProcessing={};M([F()],et.prototype,"uniqueId",void 0);M([F()],et.prototype,"name",void 0);M([F()],et.prototype,"width",void 0);M([F()],et.prototype,"height",void 0);M([F()],et.prototype,"renderTargetSamplingMode",void 0);M([Jp()],et.prototype,"clearColor",void 0);M([F()],et.prototype,"autoClear",void 0);M([F()],et.prototype,"alphaMode",void 0);M([F()],et.prototype,"alphaConstants",void 0);M([F()],et.prototype,"enablePixelPerfectMode",void 0);M([F()],et.prototype,"forceFullscreenViewport",void 0);M([F()],et.prototype,"scaleMode",void 0);M([F()],et.prototype,"alwaysForcePOT",void 0);M([F("samples")],et.prototype,"_samples",void 0);M([F()],et.prototype,"adaptScaleToCurrentViewport",void 0);ye("BABYLON.PostProcess",et);class Fd extends rt{constructor(e){super(e,W.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",N.Vector4,!0),this.registerInput("xyz ",N.Vector3,!0),this.registerInput("xy ",N.Vector2,!0),this.registerInput("zw ",N.Vector2,!0),this.registerInput("x",N.Float,!0),this.registerInput("y",N.Float,!0),this.registerInput("z",N.Float,!0),this.registerInput("w",N.Float,!0),this.registerOutput("xyzw",N.Vector4),this.registerOutput("xyz",N.Vector3),this.registerOutput("xy",N.Vector2),this.registerOutput("zw",N.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return e==="xyzw "?"xyzwIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substr(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.x,i=this.y,r=this.z,s=this.w,n=this.xyIn,a=this.zwIn,l=this.xyzIn,c=this.xyzwIn,h=this._outputs[0],u=this._outputs[1],d=this._outputs[2],f=this._outputs[3];return c.isConnected?(h.hasEndpoints&&(e.compilationString+=this._declareOutput(h,e)+` = ${c.associatedVariableName}${this._buildSwizzle(4)};\r
`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = ${c.associatedVariableName}${this._buildSwizzle(3)};\r
`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${c.associatedVariableName}${this._buildSwizzle(2)};\r
`)):l.isConnected?(h.hasEndpoints&&(e.compilationString+=this._declareOutput(h,e)+` = vec4(${l.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\r
`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};\r
`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};\r
`)):n.isConnected?(h.hasEndpoints&&(a.isConnected?e.compilationString+=this._declareOutput(h,e)+` = vec4(${n.associatedVariableName}, ${a.associatedVariableName})${this._buildSwizzle(4)};\r
`:e.compilationString+=this._declareOutput(h,e)+` = vec4(${n.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\r
`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = vec3(${n.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};\r
`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${n.associatedVariableName}${this._buildSwizzle(2)};\r
`),f.hasEndpoints&&(a.isConnected?e.compilationString+=this._declareOutput(f,e)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};\r
`:e.compilationString+=this._declareOutput(f,e)+` = vec2(${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};\r
`)):(h.hasEndpoints&&(a.isConnected?e.compilationString+=this._declareOutput(h,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${a.associatedVariableName})${this._buildSwizzle(4)};\r
`:e.compilationString+=this._declareOutput(h,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\r
`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = vec3(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};\r
`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = vec2(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};\r
`),f.hasEndpoints&&(a.isConnected?e.compilationString+=this._declareOutput(f,e)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};\r
`:e.compilationString+=this._declareOutput(f,e)+` = vec2(${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};\r
`)),this}serialize(){const e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){var r,s,n,a;super._deserialize(e,t,i),this.xSwizzle=(r=e.xSwizzle)!==null&&r!==void 0?r:"x",this.ySwizzle=(s=e.ySwizzle)!==null&&s!==void 0?s:"y",this.zSwizzle=(n=e.zSwizzle)!==null&&n!==void 0?n:"z",this.wSwizzle=(a=e.wSwizzle)!==null&&a!==void 0?a:"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";\r
`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";\r
`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";\r
`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";\r
`,e}}ye("BABYLON.VectorMergerBlock",Fd);class _f extends rt{constructor(e){super(e,W.Neutral),this.sourceRange=new Ie(-1,1),this.targetRange=new Ie(0,1),this.registerInput("input",N.AutoDetect),this.registerInput("sourceMin",N.Float,!0),this.registerInput("sourceMax",N.Float,!0),this.registerInput("targetMin",N.Float,!0),this.registerInput("targetMax",N.Float,!0),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),r=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),s=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),n=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=this._declareOutput(t,e)+` = ${s} + (${this._inputs[0].associatedVariableName} - ${i}) * (${n} - ${s}) / (${r} - ${i});\r
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});\r
`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});\r
`,e}serialize(){const e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=Ie.FromArray(e.sourceRange),this.targetRange=Ie.FromArray(e.targetRange)}}M([Xt("From",zt.Vector2)],_f.prototype,"sourceRange",void 0);M([Xt("To",zt.Vector2)],_f.prototype,"targetRange",void 0);ye("BABYLON.RemapBlock",_f);class $_ extends rt{constructor(e){super(e,W.Neutral),this.registerInput("left",N.AutoDetect),this.registerInput("right",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MultiplyBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};\r
`,this}}ye("BABYLON.MultiplyBlock",$_);var In;(function(o){o[o.Material=0]="Material",o[o.PostProcess=1]="PostProcess",o[o.Particle=2]="Particle",o[o.ProceduralTexture=3]="ProceduralTexture"})(In||(In={}));class sc{constructor(){this.direction1=new x(0,1,0),this.direction2=new x(0,1,0),this.minEmitBox=new x(-.5,-.5,-.5),this.maxEmitBox=new x(.5,.5,.5)}startDirectionFunction(e,t,i,r){const s=Ee.RandomRange(this.direction1.x,this.direction2.x),n=Ee.RandomRange(this.direction1.y,this.direction2.y),a=Ee.RandomRange(this.direction1.z,this.direction2.z);if(r){t.x=s,t.y=n,t.z=a;return}x.TransformNormalFromFloatsToRef(s,n,a,e,t)}startPositionFunction(e,t,i,r){const s=Ee.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),n=Ee.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),a=Ee.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(r){t.x=s,t.y=n,t.z=a;return}x.TransformCoordinatesFromFloatsToRef(s,n,a,e,t)}clone(){const e=new sc;return Sn.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e}parse(e){x.FromArrayToRef(e.direction1,0,this.direction1),x.FromArrayToRef(e.direction2,0,this.direction2),x.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),x.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)}}class pf{get radius(){return this._radius}set radius(e){this._radius=e,this._buildHeight()}get angle(){return this._angle}set angle(e){this._angle=e,this._buildHeight()}_buildHeight(){this._angle!==0?this._height=this._radius/Math.tan(this._angle/2):this._height=1}constructor(e=1,t=Math.PI,i=0){this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}startDirectionFunction(e,t,i,r){r?j.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(e.getTranslation(),j.Vector3[0]).normalize();const s=Ee.RandomRange(0,this.directionRandomizer),n=Ee.RandomRange(0,this.directionRandomizer),a=Ee.RandomRange(0,this.directionRandomizer);t.x=j.Vector3[0].x+s,t.y=j.Vector3[0].y+n,t.z=j.Vector3[0].z+a,t.normalize()}startPositionFunction(e,t,i,r){const s=Ee.RandomRange(0,Math.PI*2);let n;this.emitFromSpawnPointOnly?n=1e-4:(n=Ee.RandomRange(0,this.heightRange),n=1-n*n);let a=this._radius-Ee.RandomRange(0,this._radius*this.radiusRange);a=a*n;const l=a*Math.sin(s),c=a*Math.cos(s),h=n*this._height;if(r){t.x=l,t.y=h,t.z=c;return}x.TransformCoordinatesFromFloatsToRef(l,h,c,e,t)}clone(){const e=new pf(this._radius,this._angle,this.directionRandomizer);return Sn.DeepCopy(this,e),e}applyToShader(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)}getEffectDefines(){let e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+=`
#define CONEEMITTERSPAWNPOINT`),e}getClassName(){return"ConeParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e}parse(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=e.radiusRange!==void 0?e.radiusRange:1,this.heightRange=e.radiusRange!==void 0?e.heightRange:1,this.emitFromSpawnPointOnly=e.emitFromSpawnPointOnly!==void 0?e.emitFromSpawnPointOnly:!1}}class Lu{constructor(e=1,t=1,i=1,r=0){this.radius=e,this.height=t,this.radiusRange=i,this.directionRandomizer=r,this._tempVector=x.Zero()}startDirectionFunction(e,t,i,r,s){i.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),x.TransformNormalToRef(this._tempVector,s,this._tempVector);const n=Ee.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2);let a=Math.atan2(this._tempVector.x,this._tempVector.z);if(a+=Ee.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=n,this._tempVector.x=Math.sin(a),this._tempVector.z=Math.cos(a),this._tempVector.normalize(),r){t.copyFrom(this._tempVector);return}x.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)}startPositionFunction(e,t,i,r){const s=Ee.RandomRange(-this.height/2,this.height/2),n=Ee.RandomRange(0,2*Math.PI),a=Ee.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),l=Math.sqrt(a)*this.radius,c=l*Math.cos(n),h=l*Math.sin(n);if(r){t.copyFromFloats(c,s,h);return}x.TransformCoordinatesFromFloatsToRef(c,s,h,e,t)}clone(){const e=new Lu(this.radius,this.directionRandomizer);return Sn.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class mf extends Lu{constructor(e=1,t=1,i=1,r=new x(0,1,0),s=new x(0,1,0)){super(e,t,i),this.direction1=r,this.direction2=s}startDirectionFunction(e,t){const i=Ee.RandomRange(this.direction1.x,this.direction2.x),r=Ee.RandomRange(this.direction1.y,this.direction2.y),s=Ee.RandomRange(this.direction1.z,this.direction2.z);x.TransformNormalFromFloatsToRef(i,r,s,e,t)}clone(){const e=new mf(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return Sn.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define CYLINDEREMITTER
#define DIRECTEDCYLINDEREMITTER`}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class gf{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,r){const s=i.position.subtract(e.getTranslation()).normalize(),n=Ee.RandomRange(0,this.directionRandomizer),a=Ee.RandomRange(0,this.directionRandomizer),l=Ee.RandomRange(0,this.directionRandomizer);if(s.x+=n,s.y+=a,s.z+=l,s.normalize(),r){t.copyFrom(s);return}x.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,i,r){const s=this.radius-Ee.RandomRange(0,this.radius*this.radiusRange),n=Ee.RandomRange(0,1),a=Ee.RandomRange(0,2*Math.PI),l=Math.acos(2*n-1),c=s*Math.cos(a)*Math.sin(l),h=s*Math.cos(l),u=s*Math.sin(a)*Math.sin(l);if(r){t.copyFromFloats(c,Math.abs(h),u);return}x.TransformCoordinatesFromFloatsToRef(c,Math.abs(h),u,e,t)}clone(){const e=new gf(this.radius,this.directionRandomizer);return Sn.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class vf{constructor(){this.direction1=new x(0,1,0),this.direction2=new x(0,1,0)}startDirectionFunction(e,t,i,r){const s=Ee.RandomRange(this.direction1.x,this.direction2.x),n=Ee.RandomRange(this.direction1.y,this.direction2.y),a=Ee.RandomRange(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,n,a);return}x.TransformNormalFromFloatsToRef(s,n,a,e,t)}startPositionFunction(e,t,i,r){if(r){t.copyFromFloats(0,0,0);return}x.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)}clone(){const e=new vf;return Sn.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){x.FromArrayToRef(e.direction1,0,this.direction1),x.FromArrayToRef(e.direction2,0,this.direction2)}}class Bu{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,r){const s=i.position.subtract(e.getTranslation()).normalize(),n=Ee.RandomRange(0,this.directionRandomizer),a=Ee.RandomRange(0,this.directionRandomizer),l=Ee.RandomRange(0,this.directionRandomizer);if(s.x+=n,s.y+=a,s.z+=l,s.normalize(),r){t.copyFrom(s);return}x.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,i,r){const s=this.radius-Ee.RandomRange(0,this.radius*this.radiusRange),n=Ee.RandomRange(0,1),a=Ee.RandomRange(0,2*Math.PI),l=Math.acos(2*n-1),c=s*Math.cos(a)*Math.sin(l),h=s*Math.cos(l),u=s*Math.sin(a)*Math.sin(l);if(r){t.copyFromFloats(c,h,u);return}x.TransformCoordinatesFromFloatsToRef(c,h,u,e,t)}clone(){const e=new Bu(this.radius,this.directionRandomizer);return Sn.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class xf extends Bu{constructor(e=1,t=new x(0,1,0),i=new x(0,1,0)){super(e),this.direction1=t,this.direction2=i}startDirectionFunction(e,t){const i=Ee.RandomRange(this.direction1.x,this.direction2.x),r=Ee.RandomRange(this.direction1.y,this.direction2.y),s=Ee.RandomRange(this.direction1.z,this.direction2.z);x.TransformNormalFromFloatsToRef(i,r,s,e,t)}clone(){const e=new xf(this.radius,this.direction1,this.direction2);return Sn.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define SPHEREEMITTER
#define DIRECTEDSPHEREEMITTER`}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class nc{constructor(){this.particlePositionGenerator=()=>{},this.particleDestinationGenerator=()=>{}}startDirectionFunction(e,t,i,r){const s=j.Vector3[0];if(this.particleDestinationGenerator){this.particleDestinationGenerator(-1,i,s);const n=j.Vector3[1];s.subtractToRef(i.position,n),n.scaleToRef(1/i.lifeTime,s)}else s.set(0,0,0);if(r){t.copyFrom(s);return}x.TransformNormalToRef(s,e,t)}startPositionFunction(e,t,i,r){const s=j.Vector3[0];if(this.particlePositionGenerator?this.particlePositionGenerator(-1,i,s):s.set(0,0,0),r){t.copyFrom(s);return}x.TransformCoordinatesToRef(s,e,t)}clone(){const e=new nc;return Sn.DeepCopy(this,e),e}applyToShader(e){}buildUniformLayout(e){}getEffectDefines(){return"#define CUSTOMEMITTER"}getClassName(){return"CustomParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e}parse(e){}}class cm{get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh=e,e?(this._indices=e.getIndices(),this._positions=e.getVerticesData(O.PositionKind),this._normals=e.getVerticesData(O.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))}constructor(e=null){this._indices=null,this._positions=null,this._normals=null,this._storedNormal=x.Zero(),this._mesh=null,this.direction1=new x(0,1,0),this.direction2=new x(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=e}startDirectionFunction(e,t,i,r){if(this.useMeshNormalsForDirection&&this._normals){x.TransformNormalToRef(this._storedNormal,e,t);return}const s=Ee.RandomRange(this.direction1.x,this.direction2.x),n=Ee.RandomRange(this.direction1.y,this.direction2.y),a=Ee.RandomRange(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,n,a);return}x.TransformNormalFromFloatsToRef(s,n,a,e,t)}startPositionFunction(e,t,i,r){if(!this._indices||!this._positions)return;const s=3*Math.random()*(this._indices.length/3)|0,n=Math.random(),a=Math.random()*(1-n),l=1-n-a,c=this._indices[s],h=this._indices[s+1],u=this._indices[s+2],d=j.Vector3[0],f=j.Vector3[1],_=j.Vector3[2],p=j.Vector3[3];x.FromArrayToRef(this._positions,c*3,d),x.FromArrayToRef(this._positions,h*3,f),x.FromArrayToRef(this._positions,u*3,_),p.x=n*d.x+a*f.x+l*_.x,p.y=n*d.y+a*f.y+l*_.y,p.z=n*d.z+a*f.z+l*_.z,r?t.copyFromFloats(p.x,p.y,p.z):x.TransformCoordinatesFromFloatsToRef(p.x,p.y,p.z,e,t),this.useMeshNormalsForDirection&&this._normals&&(x.FromArrayToRef(this._normals,c*3,d),x.FromArrayToRef(this._normals,h*3,f),x.FromArrayToRef(this._normals,u*3,_),this._storedNormal.x=n*d.x+a*f.x+l*_.x,this._storedNormal.y=n*d.y+a*f.y+l*_.y,this._storedNormal.z=n*d.z+a*f.z+l*_.z)}clone(){const e=new cm(this.mesh);return Sn.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return""}getClassName(){return"MeshParticleEmitter"}serialize(){var e;const t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t.meshId=(e=this.mesh)===null||e===void 0?void 0:e.id,t.useMeshNormalsForDirection=this.useMeshNormalsForDirection,t}parse(e,t){x.FromArrayToRef(e.direction1,0,this.direction1),x.FromArrayToRef(e.direction2,0,this.direction2),e.meshId&&t&&(this.mesh=t.getLastMeshById(e.meshId)),this.useMeshNormalsForDirection=e.useMeshNormalsForDirection}}class Ya{get noiseTexture(){return this._noiseTexture}set noiseTexture(e){this._noiseTexture!==e&&(this._noiseTexture=e,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(e){this._isAnimationSheetEnabled!=e&&(this._isAnimationSheetEnabled=e,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:x.Zero()}set direction1(e){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=e)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:x.Zero()}set direction2(e){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=e)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:x.Zero()}set minEmitBox(e){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=e)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:x.Zero()}set maxEmitBox(e){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=e)}get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(e){this._isBillboardBased!==e&&(this._isBillboardBased=e,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(!e&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=e)}_reset(){}_removeGradientAndTexture(e,t,i){if(!t)return this;let r=0;for(const s of t){if(s.gradient===e){t.splice(r,1);break}r++}return i&&i.dispose(),this}constructor(e){this.animations=[],this.renderingGroupId=0,this.emitter=x.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new x(10,10,10),this.onAnimationEnd=null,this.blendMode=Ya.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new Ie(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new x(0,0,0),this._useLogarithmicDepth=!1,this.gravity=x.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new Ye(1,1,1,1),this.color2=new Ye(1,1,1,1),this.colorDead=new Ye(0,0,0,1),this.textureMask=new Ye(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new aS,this.id=e,this.name=e}createPointEmitter(e,t){const i=new vf;return i.direction1=e,i.direction2=t,this.particleEmitterType=i,i}createHemisphericEmitter(e=1,t=1){const i=new gf(e,t);return this.particleEmitterType=i,i}createSphereEmitter(e=1,t=1){const i=new Bu(e,t);return this.particleEmitterType=i,i}createDirectedSphereEmitter(e=1,t=new x(0,1,0),i=new x(0,1,0)){const r=new xf(e,t,i);return this.particleEmitterType=r,r}createCylinderEmitter(e=1,t=1,i=1,r=0){const s=new Lu(e,t,i,r);return this.particleEmitterType=s,s}createDirectedCylinderEmitter(e=1,t=1,i=1,r=new x(0,1,0),s=new x(0,1,0)){const n=new mf(e,t,i,r,s);return this.particleEmitterType=n,n}createConeEmitter(e=1,t=Math.PI/4){const i=new pf(e,t);return this.particleEmitterType=i,i}createBoxEmitter(e,t,i,r){const s=new sc;return this.particleEmitterType=s,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=r,s}}Ya.BLENDMODE_ONEONE=0;Ya.BLENDMODE_STANDARD=1;Ya.BLENDMODE_ADD=2;Ya.BLENDMODE_MULTIPLY=3;Ya.BLENDMODE_MULTIPLYADD=4;class IT extends rt{constructor(e){super(e,W.Neutral),this.registerInput("rgba",N.Color4,!0),this.registerInput("rgb ",N.Color3,!0),this.registerOutput("rgb",N.Color3),this.registerOutput("r",N.Float),this.registerOutput("g",N.Float),this.registerOutput("b",N.Float),this.registerOutput("a",N.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return e==="rgb "?"rgbIn":e}_outputRename(e){return e==="rgb"?"rgbOut":e}_buildBlock(e){super._buildBlock(e);const t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;const i=this._outputs[0],r=this._outputs[1],s=this._outputs[2],n=this._outputs[3],a=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+` = ${t.associatedVariableName}.rgb;\r
`),r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+` = ${t.associatedVariableName}.r;\r
`),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+` = ${t.associatedVariableName}.g;\r
`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${t.associatedVariableName}.b;\r
`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${t.associatedVariableName}.a;\r
`),this}}ye("BABYLON.ColorSplitterBlock",IT);ze.prototype.createRenderTargetCubeTexture=function(o,e){const t=this._createHardwareRenderTargetWrapper(!1,!0,o),i={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...e};i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,(i.type===1&&!this._caps.textureFloatLinearFiltering||i.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(i.samplingMode=1);const r=this._gl,s=new hi(this,bt.RenderTarget);this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,s,!0);const n=this._getSamplingParameters(i.samplingMode,i.generateMipMaps);i.type===1&&!this._caps.textureFloat&&(i.type=0,X.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,n.mag),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,n.min),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);for(let l=0;l<6;l++)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,this._getRGBABufferInternalSizedFormat(i.type,i.format),o,o,0,this._getInternalFormat(i.format),this._getWebGLTextureType(i.type),null);const a=r.createFramebuffer();return this._bindUnboundFramebuffer(a),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(i.generateStencilBuffer,i.generateDepthBuffer,o,o),i.generateMipMaps&&r.generateMipmap(r.TEXTURE_CUBE_MAP),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),t._framebuffer=a,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer,s.width=o,s.height=o,s.isReady=!0,s.isCube=!0,s.samples=1,s.generateMipMaps=i.generateMipMaps,s.samplingMode=i.samplingMode,s.type=i.type,s.format=i.format,this._internalTexturesCache.push(s),t.setTextures(s),t};const v_={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class Tf{constructor(e,t=v_){var i,r;this._fullscreenViewport=new Dn(0,0,1,1);const s=(i=t.positions)!==null&&i!==void 0?i:v_.positions,n=(r=t.indices)!==null&&r!==void 0?r:v_.indices;this.engine=e,this._vertexBuffers={[O.PositionKind]:new O(e,s,O.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(n),this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{this._indexBuffer=e.createIndexBuffer(n);for(const a in this._vertexBuffers)this._vertexBuffers[a]._rebuild()})}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e._drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}restoreStates(){this.engine.depthCullingState.depthTest=!0,this.engine.stencilState.stencilTest=!0}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return e.renderTarget!==void 0}render(e,t=null){if(!e.effect.isReady())return;this.setViewport();const i=t===null?null:this._isRenderTargetTexture(t)?t.renderTarget:t;i&&this.engine.bindFramebuffer(i),this.applyEffectWrapper(e),this.draw(),i&&this.engine.unBindFramebuffer(i),this.restoreStates()}dispose(){const e=this._vertexBuffers[O.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[O.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class $o{get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){this.onApplyObservable=new Q;let t;const i=e.uniformNames||[];e.vertexShader?t={fragmentSource:e.fragmentShader,vertexSource:e.vertexShader,spectorName:e.name||"effectWrapper"}:(i.push("scale"),t={fragmentSource:e.fragmentShader,vertex:"postprocess",spectorName:e.name||"effectWrapper"},this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)}));const r=e.defines?e.defines.join(`
`):"";this._drawWrapper=new vs(e.engine),e.useShaderStore?(t.fragment=t.fragmentSource,t.vertex||(t.vertex=t.vertexSource),delete t.fragmentSource,delete t.vertexSource,this.effect=e.engine.createEffect(t,e.attributeNames||["position"],i,e.samplerNames,r,void 0,e.onCompiled,void 0,void 0,e.shaderLanguage)):(this.effect=new ri(t,e.attributeNames||["position"],i,e.samplerNames,e.engine,r,void 0,e.onCompiled,void 0,void 0,void 0,e.shaderLanguage),this._onContextRestoredObserver=e.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._wasPreviouslyReady=!1,this.effect._prepareEffect()}))}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.effect.dispose()}}const PT="passPixelShader",MT=`varying vec2 vUV;
uniform sampler2D textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=texture2D(textureSampler,vUV);
}`;te.ShadersStore[PT]=MT;const cv={name:PT,shader:MT};class Ys{static _CreateDumpRenderer(){if(!Ys._DumpToolsEngine){const e=document.createElement("canvas"),t=new ze(e,!1,{preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1});t.getCaps().parallelShaderCompile=void 0;const i=new Tf(t),r=new $o({engine:t,name:cv.name,fragmentShader:cv.shader,samplerNames:["textureSampler"]});Ys._DumpToolsEngine={canvas:e,engine:t,renderer:i,wrapper:r}}return Ys._DumpToolsEngine}static async DumpFramebuffer(e,t,i,r,s="image/png",n){const a=await i.readPixels(0,0,e,t),l=new Uint8Array(a.buffer);Ys.DumpData(e,t,l,r,s,n,!0)}static DumpDataAsync(e,t,i,r="image/png",s,n=!1,a=!1,l){return new Promise(c=>{Ys.DumpData(e,t,i,h=>c(h),r,s,n,a,l)})}static DumpData(e,t,i,r,s="image/png",n,a=!1,l=!1,c){const h=Ys._CreateDumpRenderer();if(h.engine.setSize(e,t,!0),i instanceof Float32Array){const d=new Uint8Array(i.length);let f=i.length;for(;f--;){const _=i[f];d[f]=_<0?0:_>1?1:Math.round(_*255)}i=d}const u=h.engine.createRawTexture(i,e,t,5,!1,!a,1);h.renderer.setViewport(),h.renderer.applyEffectWrapper(h.wrapper),h.wrapper.effect._bindTexture("textureSampler",u),h.renderer.draw(),l?J.ToBlob(h.canvas,d=>{const f=new FileReader;f.onload=_=>{const p=_.target.result;r&&r(p)},f.readAsArrayBuffer(d)},s,c):J.EncodeScreenshotCanvasData(h.canvas,r,s,n,c),u.dispose()}static Dispose(){Ys._DumpToolsEngine&&(Ys._DumpToolsEngine.wrapper.dispose(),Ys._DumpToolsEngine.renderer.dispose(),Ys._DumpToolsEngine.engine.dispose()),Ys._DumpToolsEngine=null}}const WS=()=>{J.DumpData=Ys.DumpData,J.DumpDataAsync=Ys.DumpDataAsync,J.DumpFramebuffer=Ys.DumpFramebuffer};WS();class Zi extends Y{get renderList(){return this._renderList}set renderList(e){this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=Yx(e,this._renderListHasChanged)),this._renderList=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(e,t){let i;Array.isArray(e)?i=e:i=[e];for(let r=0;r<i.length;++r)for(let s=0;s<this._renderPassIds.length;++s)i[r].setMaterialForRenderPass(this._renderPassIds[s],t!==void 0?Array.isArray(t)?t[s]:t:void 0)}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var e,t;return(t=(e=this._renderTarget)===null||e===void 0?void 0:e._depthStencilTexture)!==null&&t!==void 0?t:null}constructor(e,t,i,r=!1,s=!0,n=0,a=!1,l=Y.TRILINEAR_SAMPLINGMODE,c=!0,h=!1,u=!1,d=5,f=!1,_,p,m=!1,T=!1){var b,y,S,C,I,P;let D;if(typeof r=="object"){const L=r;r=!!L.generateMipMaps,s=(b=L.doNotChangeAspectRatio)!==null&&b!==void 0?b:!0,n=(y=L.type)!==null&&y!==void 0?y:0,a=!!L.isCube,l=(S=L.samplingMode)!==null&&S!==void 0?S:Y.TRILINEAR_SAMPLINGMODE,c=(C=L.generateDepthBuffer)!==null&&C!==void 0?C:!0,h=!!L.generateStencilBuffer,u=!!L.isMulti,d=(I=L.format)!==null&&I!==void 0?I:5,f=!!L.delayAllocation,_=L.samples,p=L.creationFlags,m=!!L.noColorAttachment,T=!!L.useSRGBBuffer,D=L.colorAttachment}if(super(null,i,!r,void 0,l,void 0,void 0,void 0,void 0,d),this._unObserveRenderList=null,this._renderListHasChanged=(L,U)=>{var G;const Z=this._renderList?this._renderList.length:0;(U===0&&Z>0||Z===0)&&((G=this.getScene())===null||G===void 0||G.meshes.forEach(he=>{he._markSubMeshesAsLightDirty()}))},this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new Q,this.onAfterUnbindObservable=new Q,this.onBeforeRenderObservable=new Q,this.onAfterRenderObservable=new Q,this.onClearObservable=new Q,this.onResizeObservable=new Q,this._cleared=!1,this.skipInitialClear=!1,this._currentRefreshId=-1,this._refreshRate=1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=x.Zero(),i=this.getScene(),!i)return;const w=this.getScene().getEngine();this._coordinatesMode=Y.PROJECTION_MODE,this.renderList=new Array,this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._renderPassIds=[],this._isCubeData=a,this._processSizeParameter(t),this.renderPassId=this._renderPassIds[0],this._resizeObserver=w.onResizeObservable.add(()=>{}),this._generateMipMaps=!!r,this._doNotChangeAspectRatio=s,this._renderingManager=new ys(i),this._renderingManager._useSceneAutoClearSetup=!0,!u&&(this._renderTargetOptions={generateMipMaps:r,type:n,format:(P=this._format)!==null&&P!==void 0?P:void 0,samplingMode:this.samplingMode,generateDepthBuffer:c,generateStencilBuffer:h,samples:_,creationFlags:p,noColorAttachment:m,useSRGBBuffer:T,colorAttachment:D},this.samplingMode===Y.NEAREST_SAMPLINGMODE&&(this.wrapU=Y.CLAMP_ADDRESSMODE,this.wrapV=Y.CLAMP_ADDRESSMODE),f||(a?(this._renderTarget=i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=Y.INVCUBIC_MODE,this._textureMatrix=H.Identity()):this._renderTarget=i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,_!==void 0&&(this.samples=_)))}createDepthStencilTexture(e=0,t=!0,i=!1,r=1,s=14){var n;(n=this._renderTarget)===null||n===void 0||n.createDepthStencilTexture(e,t,i,r,s)}_releaseRenderPassId(){if(this._scene){const e=this._scene.getEngine();for(let t=0;t<this._renderPassIds.length;++t)e.releaseRenderPassId(this._renderPassIds[t])}this._renderPassIds=[]}_createRenderPassId(){this._releaseRenderPassId();const e=this._scene.getEngine(),t=this._isCubeData?6:this.getRenderLayers()||1;for(let i=0;i<t;++i)this._renderPassIds[i]=e.createRenderPassId(`RenderTargetTexture - ${this.name}#${i}`)}_processSizeParameter(e){if(e.ratio){this._sizeRatio=e.ratio;const t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e;this._createRenderPassId()}get samples(){var e,t;return(t=(e=this._renderTarget)===null||e===void 0?void 0:e.samples)!==null&&t!==void 0?t:this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}addPostProcess(e){if(!this._postProcessManager){const t=this.getScene();if(!t)return;this._postProcessManager=new zd(t),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(const t of this._postProcesses)t.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;const t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}_shouldRender(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const e=this._size.layers;return e||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){const t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){var t;const i=this.isCube;(t=this._renderTarget)===null||t===void 0||t.dispose(),this._renderTarget=null;const r=this.getScene();r&&(this._processSizeParameter(e),i?this._renderTarget=r.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=r.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){return this._render(!1,!1,!0)}_render(e=!1,t=!1,i=!1){var r;const s=this.getScene();if(!s)return i;const n=s.getEngine();if(this.useCameraPostProcesses!==void 0&&(e=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(let u=0;u<this._waitingRenderList.length;u++){const d=this._waitingRenderList[u],f=s.getMeshById(d);f&&this.renderList.push(f)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const u=this.getScene();if(!u)return i;const d=u.meshes;for(let f=0;f<d.length;f++){const _=d[f];this.renderListPredicate(_)&&this.renderList.push(_)}}const a=n.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);const l=(r=this.activeCamera)!==null&&r!==void 0?r:s.activeCamera,c=s.activeCamera;l&&(l!==s.activeCamera&&(s.setTransformMatrix(l.getViewMatrix(),l.getProjectionMatrix(!0)),s.activeCamera=l),n.setViewport(l.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;let h=i;if(i){s.getViewMatrix()||s.updateTransformMatrix();const u=this.is2DArray?this.getRenderLayers():this.isCube?6:1;for(let d=0;d<u&&h;d++){let f=null;const _=this.renderList?this.renderList:s.getActiveMeshes().data,p=this.renderList?this.renderList.length:s.getActiveMeshes().length;n.currentRenderPassId=this._renderPassIds[d],this.onBeforeRenderObservable.notifyObservers(d),this.getCustomRenderList&&(f=this.getCustomRenderList(d,_,p)),f||(f=_),this._doNotChangeAspectRatio||s.updateTransformMatrix(!0);for(let m=0;m<f.length&&h;++m){const T=f[m];if(!(!T.isEnabled()||T.isBlocked||!T.isVisible||!T.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(T,this.refreshRate,i)){h=!1;continue}}else if(!T.isReady(!0)){h=!1;continue}}}this.onAfterRenderObservable.notifyObservers(d),(this.is2DArray||this.isCube)&&(s.incrementRenderId(),s.resetCachedMaterial())}}else if(this.is2DArray)for(let u=0;u<this.getRenderLayers();u++)this._renderToTarget(0,e,t,u,l),s.incrementRenderId(),s.resetCachedMaterial();else if(this.isCube)for(let u=0;u<6;u++)this._renderToTarget(u,e,t,void 0,l),s.incrementRenderId(),s.resetCachedMaterial();else this._renderToTarget(0,e,t,void 0,l);return this.onAfterUnbindObservable.notifyObservers(this),n.currentRenderPassId=a,c&&(s.activeCamera=c,(s.getEngine().scenes.length>1||this.activeCamera&&this.activeCamera!==s.activeCamera)&&s.setTransformMatrix(s.activeCamera.getViewMatrix(),s.activeCamera.getProjectionMatrix(!0)),n.setViewport(s.activeCamera.viewport)),s.resetCachedMaterial(),h}_bestReflectionRenderTargetDimension(e,t){const r=e*t,s=q.NearestPOT(r+128*128/(128+r));return Math.min(q.FloorPOT(e),s)}_prepareRenderingManager(e,t,i,r){const s=this.getScene();if(!s)return;this._renderingManager.reset();const n=s.getRenderId();for(let a=0;a<t;a++){const l=e[a];if(l&&!l.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(l,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!l.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}if(!l._internalAbstractMeshDataInfo._currentLODIsUpToDate&&s.activeCamera&&(l._internalAbstractMeshDataInfo._currentLOD=s.customLODSelector?s.customLODSelector(l,this.activeCamera||s.activeCamera):l.getLOD(this.activeCamera||s.activeCamera),l._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!l._internalAbstractMeshDataInfo._currentLOD)continue;let c=l._internalAbstractMeshDataInfo._currentLOD;c._preActivateForIntermediateRendering(n);let h;if(r&&i?h=(l.layerMask&i.layerMask)===0:h=!1,l.isEnabled()&&l.isVisible&&l.subMeshes&&!h&&(c!==l&&c._activate(n,!0),l._activate(n,!0)&&l.subMeshes.length)){l.isAnInstance?l._internalAbstractMeshDataInfo._actAsRegularMesh&&(c=l):c._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,c._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(let u=0;u<c.subMeshes.length;u++){const d=c.subMeshes[u];this._renderingManager.dispatch(d,c)}}}}for(let a=0;a<s.particleSystems.length;a++){const l=s.particleSystems[a],c=l.emitter;!l.isStarted()||!c||!c.position||!c.isEnabled()||e.indexOf(c)>=0&&this._renderingManager.dispatchParticles(l)}}_bindFrameBuffer(e=0,t=0){const i=this.getScene();if(!i)return;const r=i.getEngine();this._renderTarget&&r.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}_prepareFrame(e,t,i,r){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!r||!e.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(t,i)}_renderToTarget(e,t,i,r=0,s=null){var n,a,l,c,h,u;const d=this.getScene();if(!d)return;const f=d.getEngine();if((n=f._debugPushGroup)===null||n===void 0||n.call(f,`render to face #${e} layer #${r}`,1),this._prepareFrame(d,e,r,t),this.is2DArray?(f.currentRenderPassId=this._renderPassIds[r],this.onBeforeRenderObservable.notifyObservers(r)):(f.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e)),f.snapshotRendering&&f.snapshotRenderingMode===1)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(f):this.skipInitialClear||f.clear(this.clearColor||d.clearColor,!0,!0,!0);else{let p=null;const m=this.renderList?this.renderList:d.getActiveMeshes().data,T=this.renderList?this.renderList.length:d.getActiveMeshes().length;this.getCustomRenderList&&(p=this.getCustomRenderList(this.is2DArray?r:e,m,T)),p?this._prepareRenderingManager(p,p.length,s,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(m,T,s,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),p=m);for(const y of d._beforeRenderTargetClearStage)y.action(this,e,r);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(f):this.skipInitialClear||f.clear(this.clearColor||d.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||d.updateTransformMatrix(!0);for(const y of d._beforeRenderTargetDrawStage)y.action(this,e,r);this._renderingManager.render(this.customRenderFunction,p,this.renderParticles,this.renderSprites);for(const y of d._afterRenderTargetDrawStage)y.action(this,e,r);const b=(l=(a=this._texture)===null||a===void 0?void 0:a.generateMipMaps)!==null&&l!==void 0?l:!1;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,(c=this._renderTarget)!==null&&c!==void 0?c:void 0,e,this._postProcesses,this.ignoreCameraViewport):t&&d.postProcessManager._finalizeFrame(!1,(h=this._renderTarget)!==null&&h!==void 0?h:void 0,e);for(const y of d._afterRenderTargetPostProcessStage)y.action(this,e,r);this._texture&&(this._texture.generateMipMaps=b),this._doNotChangeAspectRatio||d.updateTransformMatrix(!0),i&&Ys.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),f)}this._unbindFrameBuffer(f,e),this._texture&&this.isCube&&e===5&&f.generateMipMapsForCubemap(this._texture),(u=f._debugPopGroup)===null||u===void 0||u.call(f,1)}setRenderingOrder(e,t=null,i=null,r=null){this._renderingManager.setRenderingOrder(e,t,i,r)}setRenderingAutoClearDepthStencil(e,t){this._renderingManager.setRenderingAutoClearDepthStencil(e,t),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const e=this.getSize(),t=new Zi(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){var e;(e=this._renderTarget)===null||e===void 0||e.dispose(!0)}releaseInternalTexture(){var e;(e=this._renderTarget)===null||e===void 0||e.releaseTextures(),this._texture=null}dispose(){var e;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;const t=this.getScene();if(!t)return;let i=t.customRenderTargets.indexOf(this);i>=0&&t.customRenderTargets.splice(i,1);for(const r of t.cameras)i=r.customRenderTargets.indexOf(this),i>=0&&r.customRenderTargets.splice(i,1);(e=this._renderTarget)===null||e===void 0||e.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this.refreshRate===Zi.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Zi.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}getViewCount(){return 1}}Zi.REFRESHRATE_RENDER_ONCE=0;Zi.REFRESHRATE_RENDER_ONEVERYFRAME=1;Zi.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2;Y._CreateRenderTargetTexture=(o,e,t,i,r)=>new Zi(o,e,t,i);class XS{constructor(e){this.name=Re.NAME_PROCEDURALTEXTURE,this.scene=e,this.scene.proceduralTextures=new Array}register(){this.scene._beforeClearStage.registerStep(Re.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){J.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){const t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}J.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}}const $S="proceduralVertexShader",YS=`attribute vec2 position;
varying vec2 vPosition;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vPosition=position;
vUV=position*madd+madd;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;te.ShadersStore[$S]=YS;class bo extends Y{constructor(e,t,i,r,s=null,n=!0,a=!1,l=0){super(null,r,!n),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new Q,this.onBeforeGenerationObservable=new Q,this.nodeMaterialSource=null,this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null,r=this.getScene()||qe.LastCreatedScene;let c=r._getComponent(Re.NAME_PROCEDURALTEXTURE);c||(c=new XS(r),r._addComponent(c)),r.proceduralTextures.push(this),this._fullEngine=r.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=t,this._textureType=l,this._generateMipMaps=n,this._drawWrapper=new vs(this._fullEngine),this.setFragment(i),this._fallbackTexture=s;const h=this._createRtWrapper(a,t,n,l);this._texture=h.texture;const u=[];u.push(1,1),u.push(-1,1),u.push(-1,-1),u.push(1,-1),this._vertexBuffers[O.PositionKind]=new O(this._fullEngine,u,O.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,i,r){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r}),this.setFloat("face",0)):this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r}),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId?this._contentData:(this._contentData?this._contentData.then(e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId),this._contentData)}_createIndexBuffer(){const e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[O.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===Zi.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Zi.REFRESHRATE_RENDER_ONCE)}reset(){var e;(e=this._drawWrapper.effect)===null||e===void 0||e.dispose()}_getDefines(){return""}isReady(){const e=this._fullEngine;let t;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;const i=this._getDefines();return this._drawWrapper.effect&&i===this._cachedDefines&&this._drawWrapper.effect.isReady()?!0:(this._fragment.fragmentElement!==void 0?t={vertex:"procedural",fragmentElement:this._fragment.fragmentElement}:t={vertex:"procedural",fragment:this._fragment},this._cachedDefines!==i&&(this._cachedDefines=i,this._drawWrapper.effect=e.createEffect(t,[O.PositionKind],this._uniforms,this._samplers,i,void 0,void 0,()=>{var r;(r=this._rtWrapper)===null||r===void 0||r.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0})),this._drawWrapper.effect.isReady())}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return!this.isEnabled||!this.isReady()||!this._texture?(this._texture&&(this._texture.isReady=!1),!1):this._fallbackTextureUsed?!1:this._currentRefreshId===-1?(this._currentRefreshId=1,this._frameId++,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;const i=this._texture.isCube;this._rtWrapper.dispose();const r=this._createRtWrapper(i,e,t,this._textureType);this._texture=r.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){this._uniforms.indexOf(e)===-1&&this._uniforms.push(e)}setTexture(e,t){return this._samplers.indexOf(e)===-1&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){var t,i;const r=this.getScene();if(!r)return;const s=this._fullEngine;if(s.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),s.setState(!1),!this.nodeMaterialSource){for(const a in this._textures)this._drawWrapper.effect.setTexture(a,this._textures[a]);for(const a in this._ints)this._drawWrapper.effect.setInt(a,this._ints[a]);for(const a in this._floats)this._drawWrapper.effect.setFloat(a,this._floats[a]);for(const a in this._floatsArrays)this._drawWrapper.effect.setArray(a,this._floatsArrays[a]);for(const a in this._colors3)this._drawWrapper.effect.setColor3(a,this._colors3[a]);for(const a in this._colors4){const l=this._colors4[a];this._drawWrapper.effect.setFloat4(a,l.r,l.g,l.b,l.a)}for(const a in this._vectors2)this._drawWrapper.effect.setVector2(a,this._vectors2[a]);for(const a in this._vectors3)this._drawWrapper.effect.setVector3(a,this._vectors3[a]);for(const a in this._matrices)this._drawWrapper.effect.setMatrix(a,this._matrices[a])}if(!this._texture||!this._rtWrapper)return;(t=s._debugPushGroup)===null||t===void 0||t.call(s,`procedural texture generation for ${this.name}`,1);const n=s.currentViewport;if(this.isCube)for(let a=0;a<6;a++)s.bindFramebuffer(this._rtWrapper,a,void 0,void 0,!0),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",a),this.autoClear&&s.clear(r.clearColor,!0,!1,!1),s.drawElementsType(me.TriangleFillMode,0,6);else s.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this.autoClear&&s.clear(r.clearColor,!0,!1,!1),s.drawElementsType(me.TriangleFillMode,0,6);s.unBindFramebuffer(this._rtWrapper,this.isCube),n&&s.setViewport(n),this.isCube&&s.generateMipMapsForCubemap(this._texture),(i=s._debugPopGroup)===null||i===void 0||i.call(s,1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){const e=this.getSize(),t=new bo(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){const e=this.getScene();if(!e)return;const t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);const i=this._vertexBuffers[O.PositionKind];i&&(i.dispose(),this._vertexBuffers[O.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}}M([F()],bo.prototype,"isEnabled",void 0);M([F()],bo.prototype,"autoClear",void 0);M([F()],bo.prototype,"_generateMipMaps",void 0);M([F()],bo.prototype,"_size",void 0);M([F()],bo.prototype,"refreshRate",null);ye("BABYLON.ProceduralTexture",bo);var Gr;(function(o){o[o.Cos=0]="Cos",o[o.Sin=1]="Sin",o[o.Abs=2]="Abs",o[o.Exp=3]="Exp",o[o.Exp2=4]="Exp2",o[o.Round=5]="Round",o[o.Floor=6]="Floor",o[o.Ceiling=7]="Ceiling",o[o.Sqrt=8]="Sqrt",o[o.Log=9]="Log",o[o.Tan=10]="Tan",o[o.ArcTan=11]="ArcTan",o[o.ArcCos=12]="ArcCos",o[o.ArcSin=13]="ArcSin",o[o.Fract=14]="Fract",o[o.Sign=15]="Sign",o[o.Radians=16]="Radians",o[o.Degrees=17]="Degrees"})(Gr||(Gr={}));class OT extends rt{constructor(e){super(e,W.Neutral),this.operation=Gr.Cos,this.registerInput("input",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="";switch(this.operation){case Gr.Cos:{i="cos";break}case Gr.Sin:{i="sin";break}case Gr.Abs:{i="abs";break}case Gr.Exp:{i="exp";break}case Gr.Exp2:{i="exp2";break}case Gr.Round:{i="round";break}case Gr.Floor:{i="floor";break}case Gr.Ceiling:{i="ceil";break}case Gr.Sqrt:{i="sqrt";break}case Gr.Log:{i="log";break}case Gr.Tan:{i="tan";break}case Gr.ArcTan:{i="atan";break}case Gr.ArcCos:{i="acos";break}case Gr.ArcSin:{i="asin";break}case Gr.Fract:{i="fract";break}case Gr.Sign:{i="sign";break}case Gr.Radians:{i="radians";break}case Gr.Degrees:{i="degrees";break}}return e.compilationString+=this._declareOutput(t,e)+` = ${i}(${this.input.associatedVariableName});\r
`,this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${Gr[this.operation]};\r
`}}ye("BABYLON.TrigonometryBlock",OT);const x_={effect:null,subMesh:null};class Sd extends Aa{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.rebuild()}setValue(e,t,i=!1){this[e]===void 0&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}}class sr extends Fu{static _BlockIsTextureBlock(e){return e.getClassName()==="TextureBlock"||e.getClassName()==="ReflectionTextureBaseBlock"||e.getClassName()==="RefractionBlock"||e.getClassName()==="CurrentScreenBlock"||e.getClassName()==="ParticleTextureBlock"||e.getClassName()==="ImageSourceBlock"||e.getClassName()==="TriPlanarBlock"||e.getClassName()==="BiPlanarBlock"}_getGlobalNodeMaterialEditor(){if(typeof NODEEDITOR<"u")return NODEEDITOR;if(typeof BABYLON<"u"&&typeof BABYLON.NodeEditor<"u")return BABYLON}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,i={}){super(e,t||qe.LastCreatedScene),this._buildId=sr._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new H,this._cachedWorldViewProjectionMatrix=new H,this._optimizers=new Array,this._animationFrame=-1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new Q,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=new Array,this._mode=In.Material,this.forceAlphaBlending=!1,this._options={emitComments:!1,...i},this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e)if(!t)t=i;else return J.Warn("More than one block was found with the name `"+e+"`"),t;return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(const t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){const t=this._optimizers.indexOf(e);if(t!==-1)return this._optimizers.splice(t,1),this}addOutputNode(e){if(e.target===null)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return e.target&W.Vertex&&this._addVertexOutputNode(e),e.target&W.Fragment&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return e.target===null?this:(e.target&W.Vertex&&this._removeVertexOutputNode(e),e.target&W.Fragment&&this._removeFragmentOutputNode(e),this)}_addVertexOutputNode(e){if(this._vertexOutputNodes.indexOf(e)===-1)return e.target=W.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){const t=this._vertexOutputNodes.indexOf(e);if(t!==-1)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(this._fragmentOutputNodes.indexOf(e)===-1)return e.target=W.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){const t=this._fragmentOutputNodes.indexOf(e);if(t!==-1)return this._fragmentOutputNodes.splice(t,1),this}needAlphaBlending(){return this.ignoreAlpha?!1:this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_initializeBlock(e,t,i,r=!0){if(e.initialize(t),r&&e.autoConfigure(this),e._preparationId=this._buildId,this.attachedBlocks.indexOf(e)===-1){if(e.isUnique){const s=e.getClassName();for(const n of this.attachedBlocks)if(n.getClassName()===s)throw`Cannot have multiple blocks of type ${s} in the same NodeMaterial`}this.attachedBlocks.push(e)}for(const s of e.inputs){s.associatedVariableName="";const n=s.connectedPoint;if(n){const a=n.ownerBlock;a!==e&&((a.target===W.VertexAndFragment||t.target===W.Fragment&&a.target===W.Vertex&&a._preparationId!==this._buildId)&&i.push(a),this._initializeBlock(a,t,i,r))}}for(const s of e.outputs)s.associatedVariableName=""}_resetDualBlocks(e,t){e.target===W.VertexAndFragment&&(e.buildId=t);for(const i of e.inputs){const r=i.connectedPoint;if(r){const s=r.ownerBlock;s!==e&&this._resetDualBlocks(s,t)}}}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!0){this._buildWasSuccessful=!1;const r=this.getScene().getEngine(),s=this._mode===In.Particle;if(this._vertexOutputNodes.length===0&&!s)throw"You must define at least one vertexOutputNode";if(this._fragmentOutputNodes.length===0)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new ov,this._vertexCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._vertexCompilationState.target=W.Vertex,this._fragmentCompilationState=new ov,this._fragmentCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._fragmentCompilationState.target=W.Fragment,this._sharedData=new VS,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=s;const n=[],a=[];for(const c of this._vertexOutputNodes)n.push(c),this._initializeBlock(c,this._vertexCompilationState,a,i);for(const c of this._fragmentOutputNodes)a.push(c),this._initializeBlock(c,this._fragmentCompilationState,n,i);this.optimize();for(const c of n)c.build(this._vertexCompilationState,n);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(const c of a)this._resetDualBlocks(c,this._buildId-1);for(const c of a)c.build(this._fragmentCompilationState,a);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=sr._BuildIdGenerator++),this._sharedData.emitErrors(),e&&(console.log("Vertex shader:"),console.log(this._vertexCompilationState.compilationString),console.log("Fragment shader:"),console.log(this._fragmentCompilationState.compilationString)),this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this);const l=this.getScene().meshes;for(const c of l)if(c.subMeshes)for(const h of c.subMeshes){if(h.getMaterial()!==this||!h.materialDefines)continue;const u=h.materialDefines;u.markAllAsDirty(),u.reset()}}optimize(){for(const e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){const i=t.NORMAL,r=t.TANGENT;t.NORMAL=e.isVerticesDataPresent(O.NormalKind),t.TANGENT=e.isVerticesDataPresent(O.TangentKind);let s=!1;for(let n=1;n<=6;++n){const a=t["UV"+n];t["UV"+n]=e.isVerticesDataPresent(`uv${n===1?"":n}`),s=s||t["UV"+n]!==a}(i!==t.NORMAL||r!==t.TANGENT||s)&&t.markAsAttributesDirty()}createPostProcess(e,t=1,i=1,r,s,n=0,a=5){return this.mode!==In.PostProcess?(console.log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,r,s,n,a)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,r=1,s,n,a=0,l=5){let c=this.name+this._buildId;const h=new Sd,u=new Qt(c+"PostProcess",this.getScene());let d=this._buildId;return this._processDefines(u,h),ri.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),e?e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c):e=new et(this.name+"PostProcess",c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,r,s,n,h.toString(),a,c,{maxSimultaneousLights:this.maxSimultaneousLights},!1,l),e.nodeMaterialSource=this,e.onApplyObservable.add(f=>{d!==this._buildId&&(delete ri.ShadersStore[c+"VertexShader"],delete ri.ShadersStore[c+"PixelShader"],c=this.name+this._buildId,h.markAllAsDirty(),d=this._buildId),this._processDefines(u,h)&&(ri.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),sh.SetImmediate(()=>e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c))),this._checkInternals(f)}),e}createProceduralTexture(e,t){if(this.mode!==In.ProceduralTexture)return console.log("Incompatible material mode"),null;let i=this.name+this._buildId;const r=new bo(i,e,null,t),s=new Qt(i+"Procedural",this.getScene());s.reservedDataStore={hidden:!0};const n=new Sd,a=this._processDefines(s,n);ri.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString);let l=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[O.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),a==null?void 0:a.fallbacks,void 0);r.nodeMaterialSource=this,r._setEffect(l);let c=this._buildId;return r.onBeforeGenerationObservable.add(()=>{c!==this._buildId&&(delete ri.ShadersStore[i+"VertexShader"],delete ri.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,n.markAllAsDirty(),c=this._buildId);const h=this._processDefines(s,n);h&&(ri.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),sh.SetImmediate(()=>{l=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[O.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),h==null?void 0:h.fallbacks,void 0),r._setEffect(l)})),this._checkInternals(l)}),r}_createEffectForParticles(e,t,i,r,s,n,a,l=""){let c=this.name+this._buildId+"_"+t;n||(n=new Sd),a||(a=this.getScene().getMeshByName(this.name+"Particle"),a||(a=new Qt(this.name+"Particle",this.getScene()),a.reservedDataStore={hidden:!0}));let h=this._buildId;const u=[];let d=l;if(!s){const f=this._processDefines(a,n);ri.RegisterShader(c,this._fragmentCompilationState._builtCompilationString),e.fillDefines(u,t),d=u.join(`
`),s=this.getScene().getEngine().createEffectForParticles(c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+`
`+d,f==null?void 0:f.fallbacks,i,r,e),e.setCustomEffect(s,t)}s.onBindObservable.add(f=>{h!==this._buildId&&(delete ri.ShadersStore[c+"PixelShader"],c=this.name+this._buildId+"_"+t,n.markAllAsDirty(),h=this._buildId),u.length=0,e.fillDefines(u,t);const _=u.join(`
`);_!==d&&(n.markAllAsDirty(),d=_);const p=this._processDefines(a,n);if(p){ri.RegisterShader(c,this._fragmentCompilationState._builtCompilationString),f=this.getScene().getEngine().createEffectForParticles(c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+`
`+d,p==null?void 0:p.fallbacks,i,r,e),e.setCustomEffect(f,t),this._createEffectForParticles(e,t,i,r,f,n,a,l);return}this._checkInternals(f)})}_checkInternals(e){if(this._sharedData.animatedInputs){const t=this.getScene(),i=t.getFrameId();if(this._animationFrame!==i){for(const r of this._sharedData.animatedInputs)r.animate(t);this._animationFrame=i}}for(const t of this._sharedData.bindableBlocks)t.bind(e,this);for(const t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){if(this.mode!==In.Particle){console.log("Incompatible material mode");return}this._createEffectForParticles(e,Ya.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,Ya.BLENDMODE_MULTIPLY,t,i)}createAsShadowDepthWrapper(e){if(this.mode!==In.Material){console.log("Incompatible material mode");return}e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene())}_processDefines(e,t,i=!1,r){let s=null;const n=this.getScene();if(Ce.PrepareDefinesForCamera(n,t)&&t.markAsMiscDirty(),this._sharedData.blocksWithDefines.forEach(a=>{a.initializeDefines(e,this,t,i)}),this._sharedData.blocksWithDefines.forEach(a=>{a.prepareDefines(e,this,t,i,r)}),t.isDirty){const a=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach(d=>{d.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,t)});const l=[];this._sharedData.dynamicUniformBlocks.forEach(d=>{d.updateUniformsAndSamples(this._vertexCompilationState,this,t,l)});const c=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach(d=>{c.indexOf(d)===-1&&c.push(d)});const h=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach(d=>{h.indexOf(d)===-1&&h.push(d)});const u=new pc;this._sharedData.blocksWithFallbacks.forEach(d=>{d.provideFallbacks(e,u)}),s={lightDisposed:a,uniformBuffers:l,mergedUniforms:c,mergedSamplers:h,fallbacks:u}}return s}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;const r=this.getScene();if(this._sharedData.animatedInputs){const l=r.getFrameId();if(this._animationFrame!==l){for(const c of this._sharedData.animatedInputs)c.animate(r);this._animationFrame=l}}if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new Sd);const s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=r.getEngine();if(this._prepareDefinesForAttributes(e,s),this._sharedData.blockingBlocks.some(l=>!l.isReady(e,this,s,i)))return!1;const a=this._processDefines(e,s,i,t);if(a){const l=t.effect,c=s.toString();let h=n.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:a.mergedUniforms,uniformBuffersNames:a.uniformBuffers,samplers:a.mergedSamplers,defines:c,fallbacks:a.fallbacks,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:s.NUM_MORPH_INFLUENCERS}},n);if(h)if(this._onEffectCreatedObservable&&(x_.effect=h,x_.subMesh=t,this._onEffectCreatedObservable.notifyObservers(x_)),this.allowShaderHotSwapping&&l&&!h.isReady()){if(h=l,s.markAsUnprocessed(),a.lightDisposed)return s._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(h,s,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(s._renderId=r.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,r.performancePriority!==la.BackwardCompatible&&(this.checkReadyOnlyOnce=!0),!0)}get compiledShaders(){return`// Vertex shader\r
${this._vertexCompilationState.compilationString}\r
\r
// Fragment shader\r
${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){const t=this.getScene();if(!this._activeEffect)return;const i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(const r of this._sharedData.inputBlocks)r._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){const r=this.getScene(),s=i.effect;if(!s)return;this._activeEffect=s,this.bindOnlyWorldMatrix(e);const n=this._mustRebind(r,s,t.visibility),a=this._sharedData;if(n){for(const l of a.bindableBlocks)l.bind(s,this,t,i);for(const l of a.forcedBindableBlocks)l.bind(s,this,t,i);for(const l of a.inputBlocks)l._transmit(s,r,this)}else if(!this.isFrozen)for(const l of a.forcedBindableBlocks)l.bind(s,this,t,i);this._afterBind(t,this._activeEffect)}getActiveTextures(){const e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter(t=>t.texture).map(t=>t.texture)),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){const e=[];for(const t of this.attachedBlocks)sr._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(const t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(const r of this.getTextureBlocks().filter(s=>s.texture).map(s=>s.texture))r.dispose();for(const r of this.attachedBlocks)r.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(){this.BJSNODEMATERIALEDITOR.NodeEditor.Show({nodeMaterial:this})}edit(e){return new Promise(t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),typeof this.BJSNODEMATERIALEDITOR>"u"){const i=e&&e.editorURL?e.editorURL:sr.EditorURL;J.LoadScript(i,()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(),t()})}else this._createNodeEditor(),t()})}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0}setToDefault(){this.clear(),this.editorData=null;const e=new yt("Position");e.setAsAttribute("position");const t=new yt("World");t.setAsSystemValue(Rt.World);const i=new X_("WorldPos");e.connectTo(i),t.connectTo(i);const r=new yt("ViewProjection");r.setAsSystemValue(Rt.ViewProjection);const s=new X_("WorldPos * ViewProjectionTransform");i.connectTo(s),r.connectTo(s);const n=new wd("VertexOutput");s.connectTo(n);const a=new yt("color");a.value=new Ye(.8,.8,.8,1);const l=new vl("FragmentOutput");a.connectTo(l),this.addOutputNode(n),this.addOutputNode(l),this._mode=In.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const e=new yt("Position");e.setAsAttribute("position2d");const t=new yt("Constant1");t.isConstant=!0,t.value=1;const i=new Fd("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const r=new wd("VertexOutput");i.connectTo(r);const s=new yt("Scale");s.visibleInInspector=!0,s.value=new Ie(1,1);const n=new _f("uv0");e.connectTo(n);const a=new $_("UV scale");n.connectTo(a),s.connectTo(a);const l=new yT("CurrentScreen");a.connectTo(l),l.texture=new Y("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());const c=new vl("FragmentOutput");l.connectTo(c,{output:"rgba"}),this.addOutputNode(r),this.addOutputNode(c),this._mode=In.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const e=new yt("Position");e.setAsAttribute("position2d");const t=new yt("Constant1");t.isConstant=!0,t.value=1;const i=new Fd("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const r=new wd("VertexOutput");i.connectTo(r);const s=new yt("Time");s.value=0,s.min=0,s.max=0,s.isBoolean=!1,s.matrixMode=0,s.animationType=ml.Time,s.isConstant=!1;const n=new yt("Color3");n.value=new ge(1,1,1),n.isConstant=!1;const a=new vl("FragmentOutput"),l=new Fd("VectorMerger");l.visibleInInspector=!1;const c=new OT("Cos");c.operation=Gr.Cos,e.connectTo(l),s.output.connectTo(c.input),c.output.connectTo(l.z),l.xyzOut.connectTo(a.rgb),this.addOutputNode(r),this.addOutputNode(a),this._mode=In.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const e=new yt("uv");e.setAsAttribute("particle_uv");const t=new CT("ParticleTexture");e.connectTo(t);const i=new yt("Color");i.setAsAttribute("particle_color");const r=new $_("Texture * Color");t.connectTo(r),i.connectTo(r);const s=new AT("ParticleRampGradient");r.connectTo(s);const n=new IT("ColorSplitter");i.connectTo(n);const a=new RT("ParticleBlendMultiply");s.connectTo(a),t.connectTo(a,{output:"a"}),n.connectTo(a,{output:"a"});const l=new vl("FragmentOutput");a.connectTo(l),this.addOutputNode(l),this._mode=In.Particle}async loadAsync(e,t=""){return sr.ParseFromFileAsync("",e,this.getScene(),t,!0,this)}_gatherBlocks(e,t){if(t.indexOf(e)===-1){t.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const s=r.ownerBlock;s!==e&&this._gatherBlocks(s,t)}}}}generateCode(){let e=[];const t=[],i=["const","var","let"];for(const n of this._vertexOutputNodes)this._gatherBlocks(n,t);const r=[];for(const n of this._fragmentOutputNodes)this._gatherBlocks(n,r);let s=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");\r
`;for(const n of t)n.isInput&&e.indexOf(n)===-1&&(s+=n._dumpCode(i,e));for(const n of r)n.isInput&&e.indexOf(n)===-1&&(s+=n._dumpCode(i,e));e=[],s+=`\r
// Connections\r
`;for(const n of this._vertexOutputNodes)s+=n._dumpCodeForOutputConnections(e);for(const n of this._fragmentOutputNodes)s+=n._dumpCodeForOutputConnections(e);s+=`\r
// Output nodes\r
`;for(const n of this._vertexOutputNodes)s+=`nodeMaterial.addOutputNode(${n._codeVariableName});\r
`;for(const n of this._fragmentOutputNodes)s+=`nodeMaterial.addOutputNode(${n._codeVariableName});\r
`;return s+=`nodeMaterial.build();\r
`,s}serialize(e){const t=e?{}:ke.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(const r of this._vertexOutputNodes)this._gatherBlocks(r,i),t.outputNodes.push(r.uniqueId);for(const r of this._fragmentOutputNodes)this._gatherBlocks(r,i),t.outputNodes.indexOf(r.uniqueId)===-1&&t.outputNodes.push(r.uniqueId)}t.blocks=[];for(const r of i)t.blocks.push(r.serialize());if(!e)for(const r of this.attachedBlocks)i.indexOf(r)===-1&&t.blocks.push(r.serialize());return t}_restoreConnections(e,t,i){for(const r of e.outputs)for(const s of t.blocks){const n=i[s.id];if(n){for(const a of s.inputs)if(i[a.targetBlockId]===e&&a.targetConnectionName===r.name){const l=n.getInputByName(a.inputName);if(!l||l.isConnected)continue;r.connectTo(l,!0),this._restoreConnections(n,t,i);continue}}}}parseSerializedObject(e,t="",i=!1){var r;i||this.clear();const s={};for(const n of e.blocks){const a=Xr(n.customType);if(a){const l=new a;l._deserialize(n,this.getScene(),t),s[n.id]=l,this.attachedBlocks.push(l)}}for(let n=0;n<e.blocks.length;n++){const a=e.blocks[n],l=s[a.id];l&&(l.inputs.length&&!i||this._restoreConnections(l,e,s))}if(e.outputNodes)for(const n of e.outputNodes)this.addOutputNode(s[n]);if(e.locations||e.editorData&&e.editorData.locations){const n=e.locations||e.editorData.locations;for(const l of n)s[l.blockId]&&(l.blockId=s[l.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&n.concat(this.editorData.locations),e.locations?this.editorData={locations:n}:(this.editorData=e.editorData,this.editorData.locations=n);const a=[];for(const l in s)a[l]=s[l].uniqueId;this.editorData.map=a}this.comment=e.comment,e.forceAlphaBlending!==void 0&&(this.forceAlphaBlending=e.forceAlphaBlending),i||(this._mode=(r=e.mode)!==null&&r!==void 0?r:In.Material)}loadFromSerialization(e,t="",i=!1){this.parseSerializedObject(e,t,i)}clone(e,t=!1){const i=this.serialize(),r=ke.Clone(()=>new sr(e,this.getScene(),this.options),this);return r.id=e,r.name=e,r.parseSerializedObject(i),r._buildId=this._buildId,r.build(!1,!t),r}static Parse(e,t,i=""){const r=ke.Parse(()=>new sr(e.name,t),e,t,i);return r.parseSerializedObject(e,i),r.build(),r}static async ParseFromFileAsync(e,t,i,r="",s=!1,n){const a=n??new sr(e,i),l=await i._loadFileAsync(t),c=JSON.parse(l);return a.parseSerializedObject(c,r),s||a.build(),a}static ParseFromSnippetAsync(e,t=qe.LastCreatedScene,i="",r,s=!1){return e==="_BLANK"?Promise.resolve(sr.CreateDefault("blank",t)):new Promise((n,a)=>{const l=new gs;l.addEventListener("readystatechange",()=>{if(l.readyState==4)if(l.status==200){const c=JSON.parse(JSON.parse(l.responseText).jsonPayload),h=JSON.parse(c.nodeMaterial);r||(r=ke.Parse(()=>new sr(e,t),h,t,i),r.uniqueId=t.getUniqueId()),r.parseSerializedObject(h),r.snippetId=e;try{s||r.build(),n(r)}catch(u){a(u)}}else a("Unable to load the snippet "+e)}),l.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),l.send()})}static CreateDefault(e,t){const i=new sr(e,t);return i.setToDefault(),i.build(),i}}sr._BuildIdGenerator=0;sr.EditorURL=`https://unpkg.com/babylonjs-node-editor@${q.Version}/babylon.nodeEditor.js`;sr.SnippetUrl="https://snippet.babylonjs.com";sr.IgnoreTexturesAtLoadTime=!1;M([F()],sr.prototype,"ignoreAlpha",void 0);M([F()],sr.prototype,"maxSimultaneousLights",void 0);M([F("mode")],sr.prototype,"_mode",void 0);M([F("comment")],sr.prototype,"comment",void 0);M([F()],sr.prototype,"forceAlphaBlending",void 0);ye("BABYLON.NodeMaterial",sr);function DT(o){const e=o.sideOrientation||Oe.DEFAULTSIDE,t=o.radius||1,i=o.flat===void 0?!0:o.flat,r=o.subdivisions||4,s=o.radiusX||t,n=o.radiusY||t,a=o.radiusZ||t,l=(1+Math.sqrt(5))/2,c=[-1,l,-0,1,l,0,-1,-l,0,1,-l,0,0,-1,-l,0,1,-l,0,-1,l,0,1,l,l,0,1,l,0,-1,-l,0,1,-l,0,-1],h=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],u=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],d=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],f=138/1024,_=239/1024,p=60/1024,m=26/1024,T=-40/1024,b=20/1024,y=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],S=new Array,C=new Array,I=new Array,P=new Array;let D=0;const w=new Array(3),L=new Array(3);let U;for(U=0;U<3;U++)w[U]=x.Zero(),L[U]=Ie.Zero();for(let Z=0;Z<20;Z++){for(U=0;U<3;U++){const _e=h[3*Z+U];w[U].copyFromFloats(c[3*u[_e]],c[3*u[_e]+1],c[3*u[_e]+2]),w[U].normalize(),L[U].copyFromFloats(d[2*_e]*f+p+y[Z]*T,d[2*_e+1]*_+m+y[Z]*b)}const he=(_e,ne,Pe,Se)=>{const ce=x.Lerp(w[0],w[2],ne/r),de=x.Lerp(w[1],w[2],ne/r),k=r===ne?w[2]:x.Lerp(ce,de,_e/(r-ne));k.normalize();let se;if(i){const st=x.Lerp(w[0],w[2],Se/r),be=x.Lerp(w[1],w[2],Se/r);se=x.Lerp(st,be,Pe/(r-Se))}else se=new x(k.x,k.y,k.z);se.x/=s,se.y/=n,se.z/=a,se.normalize();const xe=Ie.Lerp(L[0],L[2],ne/r),le=Ie.Lerp(L[1],L[2],ne/r),je=r===ne?L[2]:Ie.Lerp(xe,le,_e/(r-ne));C.push(k.x*s,k.y*n,k.z*a),I.push(se.x,se.y,se.z),P.push(je.x,Yt.UseOpenGLOrientationForUV?1-je.y:je.y),S.push(D),D++};for(let _e=0;_e<r;_e++)for(let ne=0;ne+_e<r;ne++)he(ne,_e,ne+1/3,_e+1/3),he(ne+1,_e,ne+1/3,_e+1/3),he(ne,_e+1,ne+1/3,_e+1/3),ne+_e+1<r&&(he(ne+1,_e,ne+2/3,_e+2/3),he(ne+1,_e+1,ne+2/3,_e+2/3),he(ne,_e+1,ne+2/3,_e+2/3))}Oe._ComputeSides(e,C,S,I,P,o.frontUVs,o.backUVs);const G=new Oe;return G.indices=S,G.positions=C,G.normals=I,G.uvs=P,G}function NT(o,e={},t=null){const i=new K(o,t);return e.sideOrientation=K._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,DT(e).applyToMesh(i,e.updatable),i}Oe.CreateIcoSphere=DT;K.CreateIcoSphere=(o,e,t)=>NT(o,e,t);var dl;(function(o){o.WRIST="wrist",o.THUMB="thumb",o.INDEX="index",o.MIDDLE="middle",o.RING="ring",o.LITTLE="little"})(dl||(dl={}));var ut;(function(o){o.WRIST="wrist",o.THUMB_METACARPAL="thumb-metacarpal",o.THUMB_PHALANX_PROXIMAL="thumb-phalanx-proximal",o.THUMB_PHALANX_DISTAL="thumb-phalanx-distal",o.THUMB_TIP="thumb-tip",o.INDEX_FINGER_METACARPAL="index-finger-metacarpal",o.INDEX_FINGER_PHALANX_PROXIMAL="index-finger-phalanx-proximal",o.INDEX_FINGER_PHALANX_INTERMEDIATE="index-finger-phalanx-intermediate",o.INDEX_FINGER_PHALANX_DISTAL="index-finger-phalanx-distal",o.INDEX_FINGER_TIP="index-finger-tip",o.MIDDLE_FINGER_METACARPAL="middle-finger-metacarpal",o.MIDDLE_FINGER_PHALANX_PROXIMAL="middle-finger-phalanx-proximal",o.MIDDLE_FINGER_PHALANX_INTERMEDIATE="middle-finger-phalanx-intermediate",o.MIDDLE_FINGER_PHALANX_DISTAL="middle-finger-phalanx-distal",o.MIDDLE_FINGER_TIP="middle-finger-tip",o.RING_FINGER_METACARPAL="ring-finger-metacarpal",o.RING_FINGER_PHALANX_PROXIMAL="ring-finger-phalanx-proximal",o.RING_FINGER_PHALANX_INTERMEDIATE="ring-finger-phalanx-intermediate",o.RING_FINGER_PHALANX_DISTAL="ring-finger-phalanx-distal",o.RING_FINGER_TIP="ring-finger-tip",o.PINKY_FINGER_METACARPAL="pinky-finger-metacarpal",o.PINKY_FINGER_PHALANX_PROXIMAL="pinky-finger-phalanx-proximal",o.PINKY_FINGER_PHALANX_INTERMEDIATE="pinky-finger-phalanx-intermediate",o.PINKY_FINGER_PHALANX_DISTAL="pinky-finger-phalanx-distal",o.PINKY_FINGER_TIP="pinky-finger-tip"})(ut||(ut={}));const Fa=[ut.WRIST,ut.THUMB_METACARPAL,ut.THUMB_PHALANX_PROXIMAL,ut.THUMB_PHALANX_DISTAL,ut.THUMB_TIP,ut.INDEX_FINGER_METACARPAL,ut.INDEX_FINGER_PHALANX_PROXIMAL,ut.INDEX_FINGER_PHALANX_INTERMEDIATE,ut.INDEX_FINGER_PHALANX_DISTAL,ut.INDEX_FINGER_TIP,ut.MIDDLE_FINGER_METACARPAL,ut.MIDDLE_FINGER_PHALANX_PROXIMAL,ut.MIDDLE_FINGER_PHALANX_INTERMEDIATE,ut.MIDDLE_FINGER_PHALANX_DISTAL,ut.MIDDLE_FINGER_TIP,ut.RING_FINGER_METACARPAL,ut.RING_FINGER_PHALANX_PROXIMAL,ut.RING_FINGER_PHALANX_INTERMEDIATE,ut.RING_FINGER_PHALANX_DISTAL,ut.RING_FINGER_TIP,ut.PINKY_FINGER_METACARPAL,ut.PINKY_FINGER_PHALANX_PROXIMAL,ut.PINKY_FINGER_PHALANX_INTERMEDIATE,ut.PINKY_FINGER_PHALANX_DISTAL,ut.PINKY_FINGER_TIP],jS={[dl.WRIST]:[ut.WRIST],[dl.THUMB]:[ut.THUMB_METACARPAL,ut.THUMB_PHALANX_PROXIMAL,ut.THUMB_PHALANX_DISTAL,ut.THUMB_TIP],[dl.INDEX]:[ut.INDEX_FINGER_METACARPAL,ut.INDEX_FINGER_PHALANX_PROXIMAL,ut.INDEX_FINGER_PHALANX_INTERMEDIATE,ut.INDEX_FINGER_PHALANX_DISTAL,ut.INDEX_FINGER_TIP],[dl.MIDDLE]:[ut.MIDDLE_FINGER_METACARPAL,ut.MIDDLE_FINGER_PHALANX_PROXIMAL,ut.MIDDLE_FINGER_PHALANX_INTERMEDIATE,ut.MIDDLE_FINGER_PHALANX_DISTAL,ut.MIDDLE_FINGER_TIP],[dl.RING]:[ut.RING_FINGER_METACARPAL,ut.RING_FINGER_PHALANX_PROXIMAL,ut.RING_FINGER_PHALANX_INTERMEDIATE,ut.RING_FINGER_PHALANX_DISTAL,ut.RING_FINGER_TIP],[dl.LITTLE]:[ut.PINKY_FINGER_METACARPAL,ut.PINKY_FINGER_PHALANX_PROXIMAL,ut.PINKY_FINGER_PHALANX_INTERMEDIATE,ut.PINKY_FINGER_PHALANX_DISTAL,ut.PINKY_FINGER_TIP]};class KS{get handMesh(){return this._handMesh}getHandPartMeshes(e){return jS[e].map(t=>this._jointMeshes[Fa.indexOf(t)])}getJointMesh(e){return this._jointMeshes[Fa.indexOf(e)]}constructor(e,t,i,r,s=!1,n=!1,a=1){this.xrController=e,this._jointMeshes=t,this._handMesh=i,this.rigMapping=r,this._leftHandedMeshes=s,this._jointsInvisible=n,this._jointScaleFactor=a,this._jointTransforms=new Array(Fa.length),this._jointTransformMatrices=new Float32Array(Fa.length*16),this._tempJointMatrix=new H,this._jointRadii=new Float32Array(Fa.length),this._scene=t[0].getScene();for(let l=0;l<this._jointTransforms.length;l++){const c=this._jointTransforms[l]=new gt(Fa[l],this._scene);c.rotationQuaternion=new oe,t[l].rotationQuaternion=new oe}i&&this.setHandMesh(i,r),this.xrController.motionController&&(this.xrController.motionController.rootMesh?this.xrController.motionController.rootMesh.setEnabled(!1):this.xrController.motionController.onModelLoadedObservable.add(l=>{l.rootMesh&&l.rootMesh.setEnabled(!1)})),this.xrController.onMotionControllerInitObservable.add(l=>{l.onModelLoadedObservable.add(c=>{c.rootMesh&&c.rootMesh.setEnabled(!1)}),l.rootMesh&&l.rootMesh.setEnabled(!1)})}setHandMesh(e,t){if(this._handMesh=e,e.alwaysSelectAsActiveMesh=!0,e.getChildMeshes().forEach(i=>i.alwaysSelectAsActiveMesh=!0),this._handMesh.skeleton){const i=this._handMesh.skeleton;Fa.forEach((r,s)=>{const n=i.getBoneIndexByName(t?t[r]:r);n!==-1&&i.bones[n].linkTransformNode(this._jointTransforms[s])})}}updateFromXRFrame(e,t){const i=this.xrController.inputSource.hand;if(!i)return;const r=i,s=Fa.map(a=>r[a]||i.get(a));let n=!1;if(e.fillPoses&&e.fillJointRadii)n=e.fillPoses(s,t,this._jointTransformMatrices)&&e.fillJointRadii(s,this._jointRadii);else if(e.getJointPose){n=!0;for(let a=0;a<s.length;a++){const l=e.getJointPose(s[a],t);if(l)this._jointTransformMatrices.set(l.transform.matrix,a*16),this._jointRadii[a]=l.radius||.008;else{n=!1;break}}}n&&(Fa.forEach((a,l)=>{const c=this._jointTransforms[l];H.FromArrayToRef(this._jointTransformMatrices,l*16,this._tempJointMatrix),this._tempJointMatrix.decompose(void 0,c.rotationQuaternion,c.position);const h=this._jointRadii[l]*this._jointScaleFactor,u=this._jointMeshes[l];u.isVisible=!this._handMesh&&!this._jointsInvisible,u.position.copyFrom(c.position),u.rotationQuaternion.copyFrom(c.rotationQuaternion),u.scaling.setAll(h),this._scene.useRightHandedSystem||(u.position.z*=-1,u.rotationQuaternion.z*=-1,u.rotationQuaternion.w*=-1,this._leftHandedMeshes&&this._handMesh&&(c.position.z*=-1,c.rotationQuaternion.z*=-1,c.rotationQuaternion.w*=-1))}),this._handMesh&&(this._handMesh.isVisible=!0))}dispose(){this._handMesh&&(this._handMesh.isVisible=!1)}}class Ti extends Gs{static _GenerateTrackedJointMeshes(e){const t={};return["left","right"].map(i=>{var r,s,n,a,l;const c=[],h=((r=e.jointMeshes)===null||r===void 0?void 0:r.sourceMesh)||NT("jointParent",Ti._ICOSPHERE_PARAMS);h.isVisible=!!(!((s=e.jointMeshes)===null||s===void 0)&&s.keepOriginalVisible);for(let u=0;u<Fa.length;++u){let d=h.createInstance(`${i}-handJoint-${u}`);if(!((n=e.jointMeshes)===null||n===void 0)&&n.onHandJointMeshGenerated){const f=e.jointMeshes.onHandJointMeshGenerated(d,u,i);f&&f!==d&&(d.dispose(),d=f)}if(d.isPickable=!1,!((a=e.jointMeshes)===null||a===void 0)&&a.enablePhysics){const f=((l=e.jointMeshes)===null||l===void 0?void 0:l.physicsProps)||{};d.scaling.setAll(.02);const _=f.impostorType!==void 0?f.impostorType:ht.SphereImpostor;d.physicsImpostor=new ht(d,_,{mass:0,...f})}d.rotationQuaternion=new oe,d.isVisible=!1,c.push(d)}t[i]=c}),{left:t.left,right:t.right}}static _GenerateDefaultHandMeshesAsync(e,t){return new Promise(async i=>{var r,s,n,a,l;const c={};!((s=(r=Ti._RightHandGLB)===null||r===void 0?void 0:r.meshes[1])===null||s===void 0)&&s.isDisposed()&&(Ti._RightHandGLB=null),!((a=(n=Ti._LeftHandGLB)===null||n===void 0?void 0:n.meshes[1])===null||a===void 0)&&a.isDisposed()&&(Ti._LeftHandGLB=null);const h=!!(Ti._RightHandGLB&&Ti._LeftHandGLB),u=await Promise.all([Ti._RightHandGLB||ft.ImportMeshAsync("",Ti.DEFAULT_HAND_MODEL_BASE_URL,Ti.DEFAULT_HAND_MODEL_RIGHT_FILENAME,e),Ti._LeftHandGLB||ft.ImportMeshAsync("",Ti.DEFAULT_HAND_MODEL_BASE_URL,Ti.DEFAULT_HAND_MODEL_LEFT_FILENAME,e)]);Ti._RightHandGLB=u[0],Ti._LeftHandGLB=u[1];const d=new sr("handShader",e,{emitComments:!1});await d.loadAsync(Ti.DEFAULT_HAND_MODEL_SHADER_URL),d.needDepthPrePass=!0,d.transparencyMode=me.MATERIAL_ALPHABLEND,d.alphaMode=2,d.build(!1);const f={base:ge.FromInts(116,63,203),fresnel:ge.FromInts(149,102,229),fingerColor:ge.FromInts(177,130,255),tipFresnel:ge.FromInts(220,200,255),...(l=t==null?void 0:t.handMeshes)===null||l===void 0?void 0:l.customColors},_={base:d.getBlockByName("baseColor"),fresnel:d.getBlockByName("fresnelColor"),fingerColor:d.getBlockByName("fingerColor"),tipFresnel:d.getBlockByName("tipFresnelColor")};_.base.value=f.base,_.fresnel.value=f.fresnel,_.fingerColor.value=f.fingerColor,_.tipFresnel.value=f.tipFresnel,["left","right"].forEach(p=>{const m=p=="left"?Ti._LeftHandGLB:Ti._RightHandGLB;if(!m)throw new Error("Could not load hand model");const T=m.meshes[1];T._internalAbstractMeshDataInfo._computeBonesUsingShaders=!0,T.material=d.clone(`${p}HandShaderClone`,!0),T.isVisible=!1,c[p]=T,!h&&!e.useRightHandedSystem&&m.meshes[1].rotate(As.Y,Math.PI)}),d.dispose(),i({left:c.left,right:c.right})})}static _GenerateDefaultHandMeshRigMapping(e){const t=e=="right"?"R":"L";return{[ut.WRIST]:`wrist_${t}`,[ut.THUMB_METACARPAL]:`thumb_metacarpal_${t}`,[ut.THUMB_PHALANX_PROXIMAL]:`thumb_proxPhalanx_${t}`,[ut.THUMB_PHALANX_DISTAL]:`thumb_distPhalanx_${t}`,[ut.THUMB_TIP]:`thumb_tip_${t}`,[ut.INDEX_FINGER_METACARPAL]:`index_metacarpal_${t}`,[ut.INDEX_FINGER_PHALANX_PROXIMAL]:`index_proxPhalanx_${t}`,[ut.INDEX_FINGER_PHALANX_INTERMEDIATE]:`index_intPhalanx_${t}`,[ut.INDEX_FINGER_PHALANX_DISTAL]:`index_distPhalanx_${t}`,[ut.INDEX_FINGER_TIP]:`index_tip_${t}`,[ut.MIDDLE_FINGER_METACARPAL]:`middle_metacarpal_${t}`,[ut.MIDDLE_FINGER_PHALANX_PROXIMAL]:`middle_proxPhalanx_${t}`,[ut.MIDDLE_FINGER_PHALANX_INTERMEDIATE]:`middle_intPhalanx_${t}`,[ut.MIDDLE_FINGER_PHALANX_DISTAL]:`middle_distPhalanx_${t}`,[ut.MIDDLE_FINGER_TIP]:`middle_tip_${t}`,[ut.RING_FINGER_METACARPAL]:`ring_metacarpal_${t}`,[ut.RING_FINGER_PHALANX_PROXIMAL]:`ring_proxPhalanx_${t}`,[ut.RING_FINGER_PHALANX_INTERMEDIATE]:`ring_intPhalanx_${t}`,[ut.RING_FINGER_PHALANX_DISTAL]:`ring_distPhalanx_${t}`,[ut.RING_FINGER_TIP]:`ring_tip_${t}`,[ut.PINKY_FINGER_METACARPAL]:`little_metacarpal_${t}`,[ut.PINKY_FINGER_PHALANX_PROXIMAL]:`little_proxPhalanx_${t}`,[ut.PINKY_FINGER_PHALANX_INTERMEDIATE]:`little_intPhalanx_${t}`,[ut.PINKY_FINGER_PHALANX_DISTAL]:`little_distPhalanx_${t}`,[ut.PINKY_FINGER_TIP]:`little_tip_${t}`}}isCompatible(){return typeof XRHand<"u"}getHandByControllerId(e){return this._attachedHands[e]}getHandByHandedness(e){return e=="none"?null:this._trackingHands[e]}constructor(e,t){super(e),this.options=t,this._attachedHands={},this._trackingHands={left:null,right:null},this._handResources={jointMeshes:null,handMeshes:null,rigMappings:null},this.onHandAddedObservable=new Q,this.onHandRemovedObservable=new Q,this._attachHand=s=>{var n,a,l;if(!s.inputSource.hand||s.inputSource.handedness=="none"||!this._handResources.jointMeshes)return;const c=s.inputSource.handedness,h=new KS(s,this._handResources.jointMeshes[c],this._handResources.handMeshes&&this._handResources.handMeshes[c],this._handResources.rigMappings&&this._handResources.rigMappings[c],(n=this.options.handMeshes)===null||n===void 0?void 0:n.meshesUseLeftHandedCoordinates,(a=this.options.jointMeshes)===null||a===void 0?void 0:a.invisible,(l=this.options.jointMeshes)===null||l===void 0?void 0:l.scaleFactor);this._attachedHands[s.uniqueId]=h,this._trackingHands[c]=h,this.onHandAddedObservable.notifyObservers(h)},this._detachHand=s=>{this._detachHandById(s.uniqueId)},this.xrNativeFeatureName="hand-tracking";const r=t.jointMeshes;if(r&&(typeof r.disableDefaultHandMesh<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.disableDefaultMeshes=r.disableDefaultHandMesh),typeof r.handMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.customMeshes=r.handMeshes),typeof r.leftHandedSystemMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.meshesUseLeftHandedCoordinates=r.leftHandedSystemMeshes),typeof r.rigMapping<"u")){t.handMeshes=t.handMeshes||{};const s={},n={};[[r.rigMapping.left,s],[r.rigMapping.right,n]].forEach(a=>{const l=a[0],c=a[1];l.forEach((h,u)=>{c[Fa[u]]=h})}),t.handMeshes.customRigMappings={left:s,right:n}}}attach(){var e,t,i,r;return super.attach()?(this._handResources={jointMeshes:Ti._GenerateTrackedJointMeshes(this.options),handMeshes:((e=this.options.handMeshes)===null||e===void 0?void 0:e.customMeshes)||null,rigMappings:((t=this.options.handMeshes)===null||t===void 0?void 0:t.customRigMappings)||null},!(!((i=this.options.handMeshes)===null||i===void 0)&&i.customMeshes)&&!(!((r=this.options.handMeshes)===null||r===void 0)&&r.disableDefaultMeshes)&&Ti._GenerateDefaultHandMeshesAsync(qe.LastCreatedScene,this.options).then(s=>{var n,a;this._handResources.handMeshes=s,this._handResources.rigMappings={left:Ti._GenerateDefaultHandMeshRigMapping("left"),right:Ti._GenerateDefaultHandMeshRigMapping("right")},(n=this._trackingHands.left)===null||n===void 0||n.setHandMesh(this._handResources.handMeshes.left,this._handResources.rigMappings.left),(a=this._trackingHands.right)===null||a===void 0||a.setHandMesh(this._handResources.handMeshes.right,this._handResources.rigMappings.right)}),this.options.xrInput.controllers.forEach(this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,this._detachHand),!0):!1}_onXRFrame(e){var t,i;(t=this._trackingHands.left)===null||t===void 0||t.updateFromXRFrame(e,this._xrSessionManager.referenceSpace),(i=this._trackingHands.right)===null||i===void 0||i.updateFromXRFrame(e,this._xrSessionManager.referenceSpace)}_detachHandById(e){var t;const i=this.getHandByControllerId(e);if(i){const r=i.xrController.inputSource.handedness=="left"?"left":"right";((t=this._trackingHands[r])===null||t===void 0?void 0:t.xrController.uniqueId)===e&&(this._trackingHands[r]=null),this.onHandRemovedObservable.notifyObservers(i),i.dispose(),delete this._attachedHands[e]}}detach(){return super.detach()?(Object.keys(this._attachedHands).forEach(e=>this._detachHandById(e)),!0):!1}dispose(){var e;super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this._handResources.handMeshes&&!(!((e=this.options.handMeshes)===null||e===void 0)&&e.customMeshes)&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),Ti._RightHandGLB=null,Ti._LeftHandGLB=null),this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach(t=>t.dispose()),this._handResources.jointMeshes.right.forEach(t=>t.dispose()))}}Ti.Name=si.HAND_TRACKING;Ti.Version=1;Ti.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/meshes/HandMeshes/";Ti.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb";Ti.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb";Ti.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/meshes/HandMeshes/handsShader.json";Ti._ICOSPHERE_PARAMS={radius:.5,flat:!1,subdivisions:2};Ti._RightHandGLB=null;Ti._LeftHandGLB=null;dr.AddWebXRFeature(Ti.Name,(o,e)=>()=>new Ti(o,e),Ti.Version,!1);var hv;(function(o){o[o.ABOVE_FINGER_TIPS=0]="ABOVE_FINGER_TIPS",o[o.RADIAL_SIDE=1]="RADIAL_SIDE",o[o.ULNAR_SIDE=2]="ULNAR_SIDE",o[o.BELOW_WRIST=3]="BELOW_WRIST"})(hv||(hv={}));var uv;(function(o){o[o.LOOK_AT_CAMERA=0]="LOOK_AT_CAMERA",o[o.HAND_ROTATION=1]="HAND_ROTATION"})(uv||(uv={}));var dv;(function(o){o[o.ALWAYS_VISIBLE=0]="ALWAYS_VISIBLE",o[o.PALM_UP=1]="PALM_UP",o[o.GAZE_FOCUS=2]="GAZE_FOCUS",o[o.PALM_AND_GAZE=3]="PALM_AND_GAZE"})(dv||(dv={}));x.Zero(),x.Zero(),x.Zero(),x.Zero(),x.Zero(),x.Zero();oe.Identity();H.Identity(),H.Identity();Br.BuildArray(10,x.Zero);oe.Identity();Br.BuildArray(5,H.Identity);class Ol{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,i){this.name=e,this.id=t,this.bones=new Array,this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=H.Identity(),this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new Q,this.bones=[],this._scene=i||qe.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const r=this._scene.getEngine().getCaps();this._canUseTextureForBones=r.textureFloat&&r.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){return this.needInitialSkinMatrix?(e._bonesTransformMatrices||this.prepare(),e._bonesTransformMatrices):(this._transformMatrices||this.prepare(),this._transformMatrices)}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let i=!0;for(const r in this._ranges)i&&(t+=", ",i=!1),t+=r;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new ih(e,t,i);for(let r=0,s=this.bones.length;r<s;r++)this.bones[r].animations[0]&&this.bones[r].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.bones.length;i<r;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let r=!0;const s=this._getHighestAnimationFrame()+1,n={},a=e.bones;let l,c;for(c=0,l=a.length;c<l;c++)n[a[c].name]=a[c];this.bones.length!==a.length&&(X.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${a.length}`),r=!1);const h=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(c=0,l=this.bones.length;c<l;c++){const d=this.bones[c].name,f=n[d];f?r=r&&this.bones[c].copyAnimationRange(f,t,s,i,h):(X.Warn("copyAnimationRange: not same rig, missing source bone "+d),r=!1)}const u=e.getAnimationRange(t);return u&&(this._ranges[t]=new ih(t,u.from+s,u.to+s)),r}returnToRest(){for(const e of this.bones)e._index!==-1&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){const r=this.bones[t].animations[0].getHighestFrame();e<r&&(e=r)}return e}beginAnimation(e,t,i,r){const s=this.getAnimationRange(e);return s?this._scene.beginAnimation(this,s.from,s.to,t,i,r):null}static MakeAnimationAdditive(e,t=0,i){const r=e.getAnimationRange(i);if(!r)return null;const s=e._scene.getAllAnimatablesByTarget(e);let n=null;for(let l=0;l<s.length;l++){const c=s[l];if(c.fromFrame===(r==null?void 0:r.from)&&c.toFrame===(r==null?void 0:r.to)){n=c;break}}const a=e.getAnimatables();for(let l=0;l<a.length;l++){const h=a[l].animations;if(h)for(let u=0;u<h.length;u++)ae.MakeAnimationAdditive(h[u],t,i)}return n&&(n.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){const r=this.bones[i];r._childUpdateId++;const s=r.getParent();if(s?r.getLocalMatrix().multiplyToRef(s.getWorldMatrix(),r.getWorldMatrix()):t?r.getLocalMatrix().multiplyToRef(t,r.getWorldMatrix()):r.getWorldMatrix().copyFrom(r.getLocalMatrix()),r._index!==-1){const n=r._index===null?i:r._index;r.getInvertedAbsoluteTransform().multiplyToArray(r.getWorldMatrix(),e,n*16)}}this._identity.copyToArray(e,this.bones.length*16)}prepare(){if(this._numBonesWithLinkedTransformNode>0){for(const e of this.bones)if(e._linkedTransformNode){const t=e._linkedTransformNode;e.position=t.position,t.rotationQuaternion?e.rotationQuaternion=t.rotationQuaternion:e.rotation=t.rotation,e.scaling=t.scaling}}if(this.needInitialSkinMatrix)for(const e of this._meshesWithPoseMatrix){const t=e.getPoseMatrix();let i=this._isDirty;if((!e._bonesTransformMatrices||e._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(e._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),i=!0),!!i){if(this._synchronizedWithMesh!==e){this._synchronizedWithMesh=e;for(const r of this.bones)r.getParent()||(r.getBaseMatrix().multiplyToRef(t,j.Matrix[1]),r._updateDifferenceMatrix(j.Matrix[1]));if(this.isUsingTextureForMatrices){const r=(this.bones.length+1)*4;(!e._transformMatrixTexture||e._transformMatrixTexture.getSize().width!==r)&&(e._transformMatrixTexture&&e._transformMatrixTexture.dispose(),e._transformMatrixTexture=an.CreateRGBATexture(e._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(e._bonesTransformMatrices,t),this.isUsingTextureForMatrices&&e._transformMatrixTexture&&e._transformMatrixTexture.update(e._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=an.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){const i=new Ol(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let r=0;r<this.bones.length;r++){const s=this.bones[r];let n=null;const a=s.getParent();if(a){const c=this.bones.indexOf(a);n=i.bones[c]}const l=new di(s.name,i,n,s.getBaseMatrix().clone(),s.getRestPose().clone());l._index=s._index,s._linkedTransformNode&&l.linkTransformNode(s._linkedTransformNode),Sn.DeepCopy(s.animations,l.animations)}if(this._ranges){i._ranges={};for(const r in this._ranges){const s=this._ranges[r];s&&(i._ranges[r]=s.clone())}}return this._isDirty=!0,i}enableBlending(e=.01){this.bones.forEach(t=>{t.animations.forEach(i=>{i.enableBlending=!0,i.blendingSpeed=e})})}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){var e;const t={};t.name=this.name,t.id=this.id,this.dimensionsAtRest&&(t.dimensionsAtRest=this.dimensionsAtRest.asArray()),t.bones=[],t.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let i=0;i<this.bones.length;i++){const r=this.bones[i],s=r.getParent(),n={parentBoneIndex:s?this.bones.indexOf(s):-1,index:r.getIndex(),name:r.name,id:r.id,matrix:r.getBaseMatrix().toArray(),rest:r.getRestPose().toArray(),linkedTransformNodeId:(e=r.getTransformNode())===null||e===void 0?void 0:e.id};t.bones.push(n),r.length&&(n.length=r.length),r.metadata&&(n.metadata=r.metadata),r.animations&&r.animations.length>0&&(n.animation=r.animations[0].serialize()),t.ranges=[];for(const a in this._ranges){const l=this._ranges[a];if(!l)continue;const c={};c.name=a,c.from=l.from,c.to=l.to,t.ranges.push(c)}}return t}static Parse(e,t){const i=new Ol(e.name,e.id,t);e.dimensionsAtRest&&(i.dimensionsAtRest=x.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix;let r;for(r=0;r<e.bones.length;r++){const s=e.bones[r],n=e.bones[r].index;let a=null;s.parentBoneIndex>-1&&(a=i.bones[s.parentBoneIndex]);const l=s.rest?H.FromArray(s.rest):null,c=new di(s.name,i,a,H.FromArray(s.matrix),l,null,n);s.id!==void 0&&s.id!==null&&(c.id=s.id),s.length&&(c.length=s.length),s.metadata&&(c.metadata=s.metadata),s.animation&&c.animations.push(ae.Parse(s.animation)),s.linkedTransformNodeId!==void 0&&s.linkedTransformNodeId!==null&&(i._hasWaitingData=!0,c._waitingTransformNodeId=s.linkedTransformNodeId)}if(e.ranges)for(r=0;r<e.ranges.length;r++){const s=e.ranges[r];i.createAnimationRange(s.name,s.from,s.to)}return i}computeAbsoluteTransforms(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteTransforms(),this._absoluteTransformIsDirty=!1)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=new Array,t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;const r=this.bones[e];if(!r)return;r._index===void 0&&(r._index=e);const s=r.getParent();s&&this._sortBones(this.bones.indexOf(s),t,i),t.push(r)}setCurrentPoseAsRest(){this.bones.forEach(e=>{e.setCurrentPoseAsRest()})}}class qS{constructor(e,t,i=3){this._engine=e,this._engine._storageBuffers.push(this),this._create(t,i)}_create(e,t){this._bufferSize=e,this._creationFlags=t,this._buffer=this._engine.createStorageBuffer(e,t)}_rebuild(){this._create(this._bufferSize,this._creationFlags)}getBuffer(){return this._buffer}update(e,t,i){this._buffer&&this._engine.updateStorageBuffer(this._buffer,e,t,i)}read(e,t,i){return this._engine.readFromStorageBuffer(this._buffer,e,t,i)}dispose(){const e=this._engine._storageBuffers,t=e.indexOf(this);t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._releaseBuffer(this._buffer),this._buffer=null}}class Ef{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new Q,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Qe.POINTERWHEEL)return;const i=t.event,r=i.deltaMode===vh.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*r*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*r*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*r*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Qe.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}M([F()],Ef.prototype,"wheelPrecisionX",void 0);M([F()],Ef.prototype,"wheelPrecisionY",void 0);M([F()],Ef.prototype,"wheelPrecisionZ",void 0);class hm{constructor(){this._currentActiveButton=-1,this.buttons=[0,1,2]}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();let r=0,s=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=a=>{var l,c;const h=a.event,u=h.pointerType==="touch";if(t.isInVRExclusivePointerMode||a.type!==Qe.POINTERMOVE&&this.buttons.indexOf(h.button)===-1)return;const d=h.target;if(this._altKey=h.altKey,this._ctrlKey=h.ctrlKey,this._metaKey=h.metaKey,this._shiftKey=h.shiftKey,this._buttonsPressed=h.buttons,t.isPointerLock){const f=h.movementX,_=h.movementY;this.onTouch(null,f,_),this._pointA=null,this._pointB=null}else{if(a.type!==Qe.POINTERDOWN&&u&&((l=this._pointA)===null||l===void 0?void 0:l.pointerId)!==h.pointerId&&((c=this._pointB)===null||c===void 0?void 0:c.pointerId)!==h.pointerId)return;if(a.type===Qe.POINTERDOWN&&(this._currentActiveButton===-1||u)){try{d==null||d.setPointerCapture(h.pointerId)}catch{}if(this._pointA===null)this._pointA={x:h.clientX,y:h.clientY,pointerId:h.pointerId,type:h.pointerType};else if(this._pointB===null)this._pointB={x:h.clientX,y:h.clientY,pointerId:h.pointerId,type:h.pointerType};else return;this._currentActiveButton===-1&&!u&&(this._currentActiveButton=h.button),this.onButtonDown(h),e||(h.preventDefault(),i&&i.focus())}else if(a.type===Qe.POINTERDOUBLETAP)this.onDoubleTap(h.pointerType);else if(a.type===Qe.POINTERUP&&(this._currentActiveButton===h.button||u)){try{d==null||d.releasePointerCapture(h.pointerId)}catch{}u||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==h.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==h.pointerId?this._pointB=null:this._pointA=this._pointB=null,(r!==0||s)&&(this.onMultiTouch(this._pointA,this._pointB,r,0,s,null),r=0,s=null),this._currentActiveButton=-1,this.onButtonUp(h),e||h.preventDefault()}else if(a.type===Qe.POINTERMOVE){if(e||h.preventDefault(),this._pointA&&this._pointB===null){const f=h.clientX-this._pointA.x,_=h.clientY-this._pointA.y;this.onTouch(this._pointA,f,_),this._pointA.x=h.clientX,this._pointA.y=h.clientY}else if(this._pointA&&this._pointB){const f=this._pointA.pointerId===h.pointerId?this._pointA:this._pointB;f.x=h.clientX,f.y=h.clientY;const _=this._pointA.x-this._pointB.x,p=this._pointA.y-this._pointB.y,m=_*_+p*p,T={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:h.pointerId,type:a.type};this.onMultiTouch(this._pointA,this._pointB,r,m,s,T),s=T,r=m}}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Qe.POINTERDOWN|Qe.POINTERUP|Qe.POINTERMOVE|Qe.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,r=0,s=null,this.onLostFocus()},this._contextMenuBind=this.onContextMenu.bind(this),i&&i.addEventListener("contextmenu",this._contextMenuBind,!1);const n=this.camera.getScene().getEngine().getHostWindow();n&&J.RegisterTopRootEvents(n,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){const e=this.camera.getScene().getEngine().getHostWindow();e&&J.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){const e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentActiveButton=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,r,s,n){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}}M([F()],hm.prototype,"buttons",void 0);var ks={};class bf{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){const t=e.getSimpleName();if(this.attached[t]){X.Warn("camera input of type "+t+" already exists on camera");return}this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault)}remove(e){for(const t in this.attached){const i=this.attached[t];if(i===e){i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck();return}}}removeByType(e){for(const t in this.attached){const i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){const t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=Ve.ForceAttachControlToAlwaysPreventDefault?!1:e,this.attachedToElement=!0,this.noPreventDefault=e;for(const t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(const t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){const t={};for(const i in this.attached){const r=this.attached[i],s=ke.Serialize(r);t[r.getClassName()]=s}e.inputsmgr=t}parse(e){const t=e.inputsmgr;if(t){this.clear();for(const i in t){const r=ks[i];if(r){const s=t[i],n=ke.Parse(()=>new r,s,null);this.add(n)}}}else for(const i in this.attached){const r=ks[this.attached[i].getClassName()];if(r){const s=ke.Parse(()=>new r,e,null);this.remove(this.attached[i]),this.add(s)}}}}class Tr{get isConnected(){return this._isConnected}constructor(e,t,i,r=0,s=1,n=2,a=3){this.id=e,this.index=t,this.browserGamepad=i,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=Tr.GAMEPAD,this._leftStickAxisX=r,this._leftStickAxisY=s,this._rightStickAxisX=n,this._rightStickAxisY=a,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(e){this._onleftstickchanged=e}onrightstickchanged(e){this._onrightstickchanged=e}get leftStick(){return this._leftStick}set leftStick(e){this._onleftstickchanged&&(this._leftStick.x!==e.x||this._leftStick.y!==e.y)&&this._onleftstickchanged(e),this._leftStick=e}get rightStick(){return this._rightStick}set rightStick(e){this._onrightstickchanged&&(this._rightStick.x!==e.x||this._rightStick.y!==e.y)&&this._onrightstickchanged(e),this._rightStick=e}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}Tr.GAMEPAD=0;Tr.GENERIC=1;Tr.XBOX=2;Tr.POSE_ENABLED=3;Tr.DUALSHOCK=4;class QS extends Tr{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,t,i){super(e,t,i),this.onButtonDownObservable=new Q,this.onButtonUpObservable=new Q,this.type=Tr.GENERIC,this._buttons=new Array(i.buttons.length)}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}}class Sf{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==Tr.POSE_ENABLED&&(!this.gamepad||t.type===Tr.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(Tr.XBOX)}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){const e=this.camera,t=this.gamepad.rightStick;if(t){if(t.x!=0){const r=t.x/this.gamepadRotationSensibility;r!=0&&Math.abs(r)>.005&&(e.inertialAlphaOffset+=r)}if(t.y!=0){const r=t.y/this.gamepadRotationSensibility*this._yAxisScale;r!=0&&Math.abs(r)>.005&&(e.inertialBetaOffset+=r)}}const i=this.gamepad.leftStick;if(i&&i.y!=0){const r=i.y/this.gamepadMoveSensibility;r!=0&&Math.abs(r)>.005&&(this.camera.inertialRadiusOffset-=r)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}}M([F()],Sf.prototype,"gamepadRotationSensibility",void 0);M([F()],Sf.prototype,"gamepadMoveSensibility",void 0);ks.ArcRotateCameraGamepadInput=Sf;class Ka{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===Ml.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1){const r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),i.preventDefault&&(e||i.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];this.keysLeft.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:this.keysUp.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:this.keysRight.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:this.keysDown.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:this.keysReset.indexOf(i)!==-1&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}}M([F()],Ka.prototype,"keysUp",void 0);M([F()],Ka.prototype,"keysDown",void 0);M([F()],Ka.prototype,"keysLeft",void 0);M([F()],Ka.prototype,"keysRight",void 0);M([F()],Ka.prototype,"keysReset",void 0);M([F()],Ka.prototype,"panningSensibility",void 0);M([F()],Ka.prototype,"zoomingSensibility",void 0);M([F()],Ka.prototype,"useAltToZoom",void 0);M([F()],Ka.prototype,"angularSpeed",void 0);ks.ArcRotateCameraKeyboardMoveInput=Ka;const ZS=40;class Uu{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._inertialPanning=x.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0;const r=e*.01*this.wheelDeltaPercentage*t;return e>0?i=r/(1+this.wheelDeltaPercentage):i=r*(1+this.wheelDeltaPercentage),i}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Qe.POINTERWHEEL)return;const i=t.event;let r=0;const s=i.deltaMode===vh.DOM_DELTA_LINE?ZS:1,n=-(i.deltaY*s);if(this.customComputeDeltaFromMouseWheel)r=this.customComputeDeltaFromMouseWheel(n,this,i);else if(this.wheelDeltaPercentage){if(r=this._computeDeltaFromMouseWheelLegacyEvent(n,this.camera.radius),r>0){let a=this.camera.radius,l=this.camera.inertialRadiusOffset+r;for(let c=0;c<20&&Math.abs(l)>.001;c++)a-=l,l*=this.camera.inertia;a=Ee.Clamp(a,0,Number.MAX_VALUE),r=this._computeDeltaFromMouseWheelLegacyEvent(n,a)}}else r=n/(this.wheelPrecision*40);r&&(this.zoomToMouseLocation&&this._hitPlane?this._zoomToMouse(r):this.camera.inertialRadiusOffset+=r),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Qe.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;const e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){const e=this.camera,t=e.target.subtract(e.position);this._hitPlane=Tn.FromPositionAndNormal(e.target,t)}_getPosition(){var e;const t=this.camera,i=t.getScene(),r=i.createPickingRay(i.pointerX,i.pointerY,H.Identity(),t,!1);let s=0;return this._hitPlane&&(s=(e=r.intersectsPlane(this._hitPlane))!==null&&e!==void 0?e:0),r.origin.addInPlace(r.direction.scaleInPlace(s))}_zoomToMouse(e){var t,i;const r=this.camera,s=1-r.inertia;if(r.lowerRadiusLimit){const h=(t=r.lowerRadiusLimit)!==null&&t!==void 0?t:0;r.radius-(r.inertialRadiusOffset+e)/s<h&&(e=(r.radius-h)*s-r.inertialRadiusOffset)}if(r.upperRadiusLimit){const h=(i=r.upperRadiusLimit)!==null&&i!==void 0?i:0;r.radius-(r.inertialRadiusOffset+e)/s>h&&(e=(r.radius-h)*s-r.inertialRadiusOffset)}const a=e/s/r.radius,l=this._getPosition(),c=j.Vector3[6];l.subtractToRef(r.target,c),c.scaleInPlace(a),c.scaleInPlace(s),this._inertialPanning.addInPlace(c),r.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<kt&&(e.x=0),Math.abs(e.y)<kt&&(e.y=0),Math.abs(e.z)<kt&&(e.z=0)}}M([F()],Uu.prototype,"wheelPrecision",void 0);M([F()],Uu.prototype,"zoomToMouseLocation",void 0);M([F()],Uu.prototype,"wheelDeltaPercentage",void 0);ks.ArcRotateCameraMouseWheelInput=Uu;class Fn extends hm{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(this.panningSensibility!==0&&e&&t){const i=t.x-e.x,r=t.y-e.y;this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=r/this.panningSensibility}}_computePinchZoom(e,t){const i=this.camera.radius||Fn.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=(t-e)*.001*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){this.panningSensibility!==0&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,r,s,n){i===0&&s===null||r===0&&n===null||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,r),this._computeMultiTouchPanning(s,n)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(r)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,r),this._isPinching=!0):this._computeMultiTouchPanning(s,n)):this.multiTouchPanning?this._computeMultiTouchPanning(s,n):this.pinchZoom&&this._computePinchZoom(i,r))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}}Fn.MinimumRadiusForPinch=.001;M([F()],Fn.prototype,"buttons",void 0);M([F()],Fn.prototype,"angularSensibilityX",void 0);M([F()],Fn.prototype,"angularSensibilityY",void 0);M([F()],Fn.prototype,"pinchPrecision",void 0);M([F()],Fn.prototype,"pinchDeltaPercentage",void 0);M([F()],Fn.prototype,"useNaturalPinchZoom",void 0);M([F()],Fn.prototype,"pinchZoom",void 0);M([F()],Fn.prototype,"panningSensibility",void 0);M([F()],Fn.prototype,"multiTouchPanning",void 0);M([F()],Fn.prototype,"multiTouchPanAndZoom",void 0);ks.ArcRotateCameraPointersInput=Fn;class um extends bf{constructor(e){super(e)}addMouseWheel(){return this.add(new Uu),this}addPointers(){return this.add(new Fn),this}addKeyboard(){return this.add(new Ka),this}}um.prototype.addVRDeviceOrientation=function(){return this.add(new wT),this};class wT{constructor(){this.alphaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=this._onOrientationEvent.bind(this)}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),this.camera.attachControl(e);const t=this.camera.getScene().getEngine().getHostWindow();t&&(typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"?t.addEventListener("deviceorientation",this._deviceOrientationHandler):J.Warn("Permission not granted.")}).catch(i=>{J.Error(i)}):t.addEventListener("deviceorientation",this._deviceOrientationHandler))}_onOrientationEvent(e){e.alpha!==null&&(this._alpha=(+e.alpha|0)*this.alphaCorrection),e.gamma!==null&&(this._gamma=(+e.gamma|0)*this.gammaCorrection),this._dirty=!0}checkInputs(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)}detachControl(){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)}getClassName(){return"ArcRotateCameraVRDeviceOrientationInput"}getSimpleName(){return"VRDeviceOrientation"}}ks.ArcRotateCameraVRDeviceOrientationInput=wT;class Vl{constructor(){this.keysForward=[87],this.keysBackward=[83],this.keysUp=[69],this.keysDown=[81],this.keysRight=[68],this.keysLeft=[65],this._keys=new Array}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(t.type===Ml.KEYDOWN)(this.keysForward.indexOf(i.keyCode)!==-1||this.keysBackward.indexOf(i.keyCode)!==-1||this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysForward.indexOf(i.keyCode)!==-1||this.keysBackward.indexOf(i.keyCode)!==-1||this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1){const r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),e||i.preventDefault()}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}getClassName(){return"FlyCameraKeyboardInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],r=e._computeLocalCameraSpeed();this.keysForward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,r):this.keysBackward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-r):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,r,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-r,0):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(r,0,0):this.keysLeft.indexOf(i)!==-1&&e._localDirection.copyFromFloats(-r,0,0),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),x.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}}M([F()],Vl.prototype,"keysForward",void 0);M([F()],Vl.prototype,"keysBackward",void 0);M([F()],Vl.prototype,"keysUp",void 0);M([F()],Vl.prototype,"keysDown",void 0);M([F()],Vl.prototype,"keysRight",void 0);M([F()],Vl.prototype,"keysLeft",void 0);ks.FlyCameraKeyboardInput=Vl;class yf{constructor(){this.buttons=[0,1,2],this.buttonsYaw=[-1,0,1],this.buttonsPitch=[-1,0,1],this.buttonsRoll=[2],this.activeButton=-1,this.angularSensibility=1e3,this._previousPosition=null}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),this._noPreventDefault=e,this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(t=>{this._pointerInput(t)},Qe.POINTERDOWN|Qe.POINTERUP|Qe.POINTERMOVE),this._rollObserver=this.camera.getScene().onBeforeRenderObservable.add(()=>{this.camera.rollCorrect&&this.camera.restoreRoll(this.camera.rollCorrect)})}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this.camera.getScene().onBeforeRenderObservable.remove(this._rollObserver),this._observer=null,this._rollObserver=null,this._previousPosition=null,this._noPreventDefault=void 0)}getClassName(){return"FlyCameraMouseInput"}getSimpleName(){return"mouse"}_pointerInput(e){const t=e.event,r=this.camera.getEngine();if(r.isInVRExclusivePointerMode||!this.touchEnabled&&t.pointerType==="touch"||e.type!==Qe.POINTERMOVE&&this.buttons.indexOf(t.button)===-1)return;const s=t.target;if(e.type===Qe.POINTERDOWN){try{s==null||s.setPointerCapture(t.pointerId)}catch{}this._previousPosition={x:t.clientX,y:t.clientY},this.activeButton=t.button,this._noPreventDefault||(t.preventDefault(),this._element.focus()),r.isPointerLock&&this._onMouseMove(e.event)}else if(e.type===Qe.POINTERUP){try{s==null||s.releasePointerCapture(t.pointerId)}catch{}this.activeButton=-1,this._previousPosition=null,this._noPreventDefault||t.preventDefault()}else if(e.type===Qe.POINTERMOVE){if(!this._previousPosition){r.isPointerLock&&this._onMouseMove(e.event);return}const n=t.clientX-this._previousPosition.x,a=t.clientY-this._previousPosition.y;this._rotateCamera(n,a),this._previousPosition={x:t.clientX,y:t.clientY},this._noPreventDefault||t.preventDefault()}}_onMouseMove(e){const i=this.camera.getEngine();if(!i.isPointerLock||i.isInVRExclusivePointerMode)return;const r=e.movementX,s=e.movementY;this._rotateCamera(r,s),this._previousPosition=null,this._noPreventDefault||e.preventDefault()}_rotateCamera(e,t){const i=this.camera;this.camera.getScene().useRightHandedSystem&&(e*=-1),i.parent&&i.parent._getWorldMatrixDeterminant()<0&&(e*=-1);const s=e/this.angularSensibility,n=t/this.angularSensibility,a=oe.RotationYawPitchRoll(i.rotation.y,i.rotation.x,i.rotation.z);let l;if(this.buttonsPitch.some(c=>c===this.activeButton)&&(l=oe.RotationAxis(As.X,n),a.multiplyInPlace(l)),this.buttonsYaw.some(c=>c===this.activeButton)){l=oe.RotationAxis(As.Y,s),a.multiplyInPlace(l);const c=i.bankedTurnLimit+i._trackRoll;if(i.bankedTurn&&-c<i.rotation.z&&i.rotation.z<c){const h=i.bankedTurnMultiplier*-s;l=oe.RotationAxis(As.Z,h),a.multiplyInPlace(l)}}this.buttonsRoll.some(c=>c===this.activeButton)&&(l=oe.RotationAxis(As.Z,-s),i._trackRoll-=s,a.multiplyInPlace(l)),a.toEulerAnglesToRef(i.rotation)}}M([F()],yf.prototype,"buttons",void 0);M([F()],yf.prototype,"angularSensibility",void 0);ks.FlyCameraMouseInput=yf;class Rs{constructor(){this.keysHeightOffsetIncr=[38],this.keysHeightOffsetDecr=[40],this.keysHeightOffsetModifierAlt=!1,this.keysHeightOffsetModifierCtrl=!1,this.keysHeightOffsetModifierShift=!1,this.keysRotationOffsetIncr=[37],this.keysRotationOffsetDecr=[39],this.keysRotationOffsetModifierAlt=!1,this.keysRotationOffsetModifierCtrl=!1,this.keysRotationOffsetModifierShift=!1,this.keysRadiusIncr=[40],this.keysRadiusDecr=[38],this.keysRadiusModifierAlt=!0,this.keysRadiusModifierCtrl=!1,this.keysRadiusModifierShift=!1,this.heightSensibility=1,this.rotationSensibility=1,this.radiusSensibility=1,this._keys=new Array}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===Ml.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,this._shiftPressed=i.shiftKey,(this.keysHeightOffsetIncr.indexOf(i.keyCode)!==-1||this.keysHeightOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetIncr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRadiusIncr.indexOf(i.keyCode)!==-1||this.keysRadiusDecr.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(this.keysHeightOffsetIncr.indexOf(i.keyCode)!==-1||this.keysHeightOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetIncr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRadiusIncr.indexOf(i.keyCode)!==-1||this.keysRadiusDecr.indexOf(i.keyCode)!==-1){const r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),i.preventDefault&&(e||i.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){this._onKeyboardObserver&&this._keys.forEach(e=>{this.keysHeightOffsetIncr.indexOf(e)!==-1&&this._modifierHeightOffset()?this.camera.heightOffset+=this.heightSensibility:this.keysHeightOffsetDecr.indexOf(e)!==-1&&this._modifierHeightOffset()?this.camera.heightOffset-=this.heightSensibility:this.keysRotationOffsetIncr.indexOf(e)!==-1&&this._modifierRotationOffset()?(this.camera.rotationOffset+=this.rotationSensibility,this.camera.rotationOffset%=360):this.keysRotationOffsetDecr.indexOf(e)!==-1&&this._modifierRotationOffset()?(this.camera.rotationOffset-=this.rotationSensibility,this.camera.rotationOffset%=360):this.keysRadiusIncr.indexOf(e)!==-1&&this._modifierRadius()?this.camera.radius+=this.radiusSensibility:this.keysRadiusDecr.indexOf(e)!==-1&&this._modifierRadius()&&(this.camera.radius-=this.radiusSensibility)})}getClassName(){return"FollowCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}_modifierHeightOffset(){return this.keysHeightOffsetModifierAlt===this._altPressed&&this.keysHeightOffsetModifierCtrl===this._ctrlPressed&&this.keysHeightOffsetModifierShift===this._shiftPressed}_modifierRotationOffset(){return this.keysRotationOffsetModifierAlt===this._altPressed&&this.keysRotationOffsetModifierCtrl===this._ctrlPressed&&this.keysRotationOffsetModifierShift===this._shiftPressed}_modifierRadius(){return this.keysRadiusModifierAlt===this._altPressed&&this.keysRadiusModifierCtrl===this._ctrlPressed&&this.keysRadiusModifierShift===this._shiftPressed}}M([F()],Rs.prototype,"keysHeightOffsetIncr",void 0);M([F()],Rs.prototype,"keysHeightOffsetDecr",void 0);M([F()],Rs.prototype,"keysHeightOffsetModifierAlt",void 0);M([F()],Rs.prototype,"keysHeightOffsetModifierCtrl",void 0);M([F()],Rs.prototype,"keysHeightOffsetModifierShift",void 0);M([F()],Rs.prototype,"keysRotationOffsetIncr",void 0);M([F()],Rs.prototype,"keysRotationOffsetDecr",void 0);M([F()],Rs.prototype,"keysRotationOffsetModifierAlt",void 0);M([F()],Rs.prototype,"keysRotationOffsetModifierCtrl",void 0);M([F()],Rs.prototype,"keysRotationOffsetModifierShift",void 0);M([F()],Rs.prototype,"keysRadiusIncr",void 0);M([F()],Rs.prototype,"keysRadiusDecr",void 0);M([F()],Rs.prototype,"keysRadiusModifierAlt",void 0);M([F()],Rs.prototype,"keysRadiusModifierCtrl",void 0);M([F()],Rs.prototype,"keysRadiusModifierShift",void 0);M([F()],Rs.prototype,"heightSensibility",void 0);M([F()],Rs.prototype,"rotationSensibility",void 0);M([F()],Rs.prototype,"radiusSensibility",void 0);ks.FollowCameraKeyboardMoveInput=Rs;class mc{constructor(){this.axisControlRadius=!0,this.axisControlHeight=!1,this.axisControlRotation=!1,this.wheelPrecision=3,this.wheelDeltaPercentage=0}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Qe.POINTERWHEEL)return;const i=t.event;let r=0;const s=Math.max(-1,Math.min(1,i.deltaY));this.wheelDeltaPercentage?(console.assert(this.axisControlRadius+this.axisControlHeight+this.axisControlRotation<=1,"wheelDeltaPercentage only usable when mouse wheel controls ONE axis. Currently enabled: axisControlRadius: "+this.axisControlRadius+", axisControlHeightOffset: "+this.axisControlHeight+", axisControlRotationOffset: "+this.axisControlRotation),this.axisControlRadius?r=s*.01*this.wheelDeltaPercentage*this.camera.radius:this.axisControlHeight?r=s*.01*this.wheelDeltaPercentage*this.camera.heightOffset:this.axisControlRotation&&(r=s*.01*this.wheelDeltaPercentage*this.camera.rotationOffset)):r=s*this.wheelPrecision,r&&(this.axisControlRadius?this.camera.radius+=r:this.axisControlHeight?this.camera.heightOffset-=r:this.axisControlRotation&&(this.camera.rotationOffset-=r)),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Qe.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}M([F()],mc.prototype,"axisControlRadius",void 0);M([F()],mc.prototype,"axisControlHeight",void 0);M([F()],mc.prototype,"axisControlRotation",void 0);M([F()],mc.prototype,"wheelPrecision",void 0);M([F()],mc.prototype,"wheelDeltaPercentage",void 0);ks.FollowCameraMouseWheelInput=mc;class Ln extends hm{constructor(){super(...arguments),this.angularSensibilityX=1,this.angularSensibilityY=1,this.pinchPrecision=1e4,this.pinchDeltaPercentage=0,this.axisXControlRadius=!1,this.axisXControlHeight=!1,this.axisXControlRotation=!0,this.axisYControlRadius=!1,this.axisYControlHeight=!0,this.axisYControlRotation=!1,this.axisPinchControlRadius=!0,this.axisPinchControlHeight=!1,this.axisPinchControlRotation=!1,this.warningEnable=!0,this._warningCounter=0}getClassName(){return"FollowCameraPointersInput"}onTouch(e,t,i){this._warning(),this.axisXControlRotation?this.camera.rotationOffset+=t/this.angularSensibilityX:this.axisYControlRotation&&(this.camera.rotationOffset+=i/this.angularSensibilityX),this.axisXControlHeight?this.camera.heightOffset+=t/this.angularSensibilityY:this.axisYControlHeight&&(this.camera.heightOffset+=i/this.angularSensibilityY),this.axisXControlRadius?this.camera.radius-=t/this.angularSensibilityY:this.axisYControlRadius&&(this.camera.radius-=i/this.angularSensibilityY)}onMultiTouch(e,t,i,r,s,n){if(i===0&&s===null||r===0&&n===null)return;let a=(r-i)/(this.pinchPrecision*(this.angularSensibilityX+this.angularSensibilityY)/2);this.pinchDeltaPercentage?(a*=.01*this.pinchDeltaPercentage,this.axisPinchControlRotation&&(this.camera.rotationOffset+=a*this.camera.rotationOffset),this.axisPinchControlHeight&&(this.camera.heightOffset+=a*this.camera.heightOffset),this.axisPinchControlRadius&&(this.camera.radius-=a*this.camera.radius)):(this.axisPinchControlRotation&&(this.camera.rotationOffset+=a),this.axisPinchControlHeight&&(this.camera.heightOffset+=a),this.axisPinchControlRadius&&(this.camera.radius-=a))}_warning(){if(!this.warningEnable||this._warningCounter++%100!==0)return;const e="It probably only makes sense to control ONE camera property with each pointer axis. Set 'warningEnable = false' if you are sure. Currently enabled: ";console.assert(this.axisXControlRotation+this.axisXControlHeight+this.axisXControlRadius<=1,e+"axisXControlRotation: "+this.axisXControlRotation+", axisXControlHeight: "+this.axisXControlHeight+", axisXControlRadius: "+this.axisXControlRadius),console.assert(this.axisYControlRotation+this.axisYControlHeight+this.axisYControlRadius<=1,e+"axisYControlRotation: "+this.axisYControlRotation+", axisYControlHeight: "+this.axisYControlHeight+", axisYControlRadius: "+this.axisYControlRadius),console.assert(this.axisPinchControlRotation+this.axisPinchControlHeight+this.axisPinchControlRadius<=1,e+"axisPinchControlRotation: "+this.axisPinchControlRotation+", axisPinchControlHeight: "+this.axisPinchControlHeight+", axisPinchControlRadius: "+this.axisPinchControlRadius)}}M([F()],Ln.prototype,"angularSensibilityX",void 0);M([F()],Ln.prototype,"angularSensibilityY",void 0);M([F()],Ln.prototype,"pinchPrecision",void 0);M([F()],Ln.prototype,"pinchDeltaPercentage",void 0);M([F()],Ln.prototype,"axisXControlRadius",void 0);M([F()],Ln.prototype,"axisXControlHeight",void 0);M([F()],Ln.prototype,"axisXControlRotation",void 0);M([F()],Ln.prototype,"axisYControlRadius",void 0);M([F()],Ln.prototype,"axisYControlHeight",void 0);M([F()],Ln.prototype,"axisYControlRotation",void 0);M([F()],Ln.prototype,"axisPinchControlRadius",void 0);M([F()],Ln.prototype,"axisPinchControlHeight",void 0);M([F()],Ln.prototype,"axisPinchControlRotation",void 0);ks.FollowCameraPointersInput=Ln;class qa{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this._keys=new Array}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===Ml.KEYDOWN)(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1){const r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),e||i.preventDefault()}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],r=e._computeLocalCameraSpeed();this.keysLeft.indexOf(i)!==-1?e._localDirection.copyFromFloats(-r,0,0):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,r):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(r,0,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-r):this.keysUpward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,r,0):this.keysDownward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-r,0):this.keysRotateLeft.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):this.keysRotateRight.indexOf(i)!==-1&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),x.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){let e=this.rotationSpeed*this._engine.getDeltaTime()/1e3;return this.camera.getScene().useRightHandedSystem&&(e*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}}M([F()],qa.prototype,"keysUp",void 0);M([F()],qa.prototype,"keysUpward",void 0);M([F()],qa.prototype,"keysDown",void 0);M([F()],qa.prototype,"keysDownward",void 0);M([F()],qa.prototype,"keysLeft",void 0);M([F()],qa.prototype,"keysRight",void 0);M([F()],qa.prototype,"rotationSpeed",void 0);M([F()],qa.prototype,"keysRotateLeft",void 0);M([F()],qa.prototype,"keysRotateRight",void 0);ks.FreeCameraKeyboardMoveInput=qa;class Cf{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new Q,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=r=>{const s=r.event,n=s.pointerType==="touch";if(t.isInVRExclusivePointerMode||!this.touchEnabled&&n||r.type!==Qe.POINTERMOVE&&this.buttons.indexOf(s.button)===-1)return;const a=s.target;if(r.type===Qe.POINTERDOWN){if(n&&this._activePointerId!==-1||!n&&this._currentActiveButton!==-1)return;this._activePointerId=s.pointerId;try{a==null||a.setPointerCapture(s.pointerId)}catch{}this._currentActiveButton===-1&&(this._currentActiveButton=s.button),this._previousPosition={x:s.clientX,y:s.clientY},e||(s.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(r.event)}else if(r.type===Qe.POINTERUP){if(n&&this._activePointerId!==s.pointerId||!n&&this._currentActiveButton!==s.button)return;try{a==null||a.releasePointerCapture(s.pointerId)}catch{}this._currentActiveButton=-1,this._previousPosition=null,e||s.preventDefault(),this._activePointerId=-1}else if(r.type===Qe.POINTERMOVE&&(this._activePointerId===s.pointerId||!n)){if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(r.event);else if(this._previousPosition){let l=s.clientX-this._previousPosition.x;const c=s.clientY-this._previousPosition.y;this.camera.getScene().useRightHandedSystem&&(l*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(l*=-1),this._allowCameraRotation&&(this.camera.cameraRotation.y+=l/this.angularSensibility,this.camera.cameraRotation.x+=c/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:l,offsetY:c}),this._previousPosition={x:s.clientX,y:s.clientY},e||s.preventDefault()}}}),this._onMouseMove=r=>{if(!t.isPointerLock||t.isInVRExclusivePointerMode)return;let s=r.movementX;this.camera.getScene().useRightHandedSystem&&(s*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(s*=-1),this.camera.cameraRotation.y+=s/this.angularSensibility;const n=r.movementY;this.camera.cameraRotation.x+=n/this.angularSensibility,this._previousPosition=null,e||r.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Qe.POINTERDOWN|Qe.POINTERUP|Qe.POINTERMOVE),i&&(this._contextMenuBind=this.onContextMenu.bind(this),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}M([F()],Cf.prototype,"buttons",void 0);M([F()],Cf.prototype,"angularSensibility",void 0);ks.FreeCameraMouseInput=Cf;var Pi;(function(o){o[o.MoveRelative=0]="MoveRelative",o[o.RotateRelative=1]="RotateRelative",o[o.MoveScene=2]="MoveScene"})(Pi||(Pi={}));class Qa extends Ef{constructor(){super(...arguments),this._moveRelative=x.Zero(),this._rotateRelative=x.Zero(),this._moveScene=x.Zero(),this._wheelXAction=Pi.MoveRelative,this._wheelXActionCoordinate=Zl.X,this._wheelYAction=Pi.MoveRelative,this._wheelYActionCoordinate=Zl.Z,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){e===null&&this._wheelXAction!==Pi.MoveRelative||(this._wheelXAction=Pi.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==Pi.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){e===null&&this._wheelYAction!==Pi.MoveRelative||(this._wheelYAction=Pi.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==Pi.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){e===null&&this._wheelZAction!==Pi.MoveRelative||(this._wheelZAction=Pi.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==Pi.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){e===null&&this._wheelXAction!==Pi.RotateRelative||(this._wheelXAction=Pi.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==Pi.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){e===null&&this._wheelYAction!==Pi.RotateRelative||(this._wheelYAction=Pi.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==Pi.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){e===null&&this._wheelZAction!==Pi.RotateRelative||(this._wheelZAction=Pi.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==Pi.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){e===null&&this._wheelXAction!==Pi.MoveScene||(this._wheelXAction=Pi.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==Pi.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){e===null&&this._wheelYAction!==Pi.MoveScene||(this._wheelYAction=Pi.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==Pi.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){e===null&&this._wheelZAction!==Pi.MoveScene||(this._wheelZAction=Pi.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==Pi.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=H.Zero();this.camera.getViewMatrix().invertToRef(e);const t=x.Zero();x.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(e===0||t===null||i===null)return;let r=null;switch(t){case Pi.MoveRelative:r=this._moveRelative;break;case Pi.RotateRelative:r=this._rotateRelative;break;case Pi.MoveScene:r=this._moveScene;break}switch(i){case Zl.X:r.set(e,0,0);break;case Zl.Y:r.set(0,e,0);break;case Zl.Z:r.set(0,0,e);break}}}M([F()],Qa.prototype,"wheelXMoveRelative",null);M([F()],Qa.prototype,"wheelYMoveRelative",null);M([F()],Qa.prototype,"wheelZMoveRelative",null);M([F()],Qa.prototype,"wheelXRotateRelative",null);M([F()],Qa.prototype,"wheelYRotateRelative",null);M([F()],Qa.prototype,"wheelZRotateRelative",null);M([F()],Qa.prototype,"wheelXMoveScene",null);M([F()],Qa.prototype,"wheelYMoveScene",null);M([F()],Qa.prototype,"wheelZMoveScene",null);ks.FreeCameraMouseWheelInput=Qa;class Af{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=J.IsSafari()}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments);let t=null;if(this._pointerInput===void 0&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{const r=i.event,s=r.pointerType==="mouse"||this._isSafari&&typeof r.pointerType>"u";if(!(!this.allowMouse&&s)){if(i.type===Qe.POINTERDOWN){if(e||r.preventDefault(),this._pointerPressed.push(r.pointerId),this._pointerPressed.length!==1)return;t={x:r.clientX,y:r.clientY}}else if(i.type===Qe.POINTERUP){e||r.preventDefault();const n=this._pointerPressed.indexOf(r.pointerId);if(n===-1||(this._pointerPressed.splice(n,1),n!=0))return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===Qe.POINTERMOVE){if(e||r.preventDefault(),!t||this._pointerPressed.indexOf(r.pointerId)!=0)return;this._offsetX=r.clientX-t.x,this._offsetY=-(r.clientY-t.y)}}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Qe.POINTERDOWN|Qe.POINTERUP|Qe.POINTERMOVE),this._onLostFocus){const r=this.camera.getEngine().getInputElement();r&&r.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(this._offsetX===null||this._offsetY===null||this._offsetX===0&&this._offsetY===0)return;const e=this.camera;if(e.cameraRotation.y=this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&this._pointerPressed.length===1||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const i=e._computeLocalCameraSpeed(),r=new x(0,0,this.touchMoveSensibility!==0?i*this._offsetY/this.touchMoveSensibility:0);H.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(x.TransformCoordinates(r,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}M([F()],Af.prototype,"touchAngularSensibility",void 0);M([F()],Af.prototype,"touchMoveSensibility",void 0);ks.FreeCameraTouchInput=Af;class Rf extends bf{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new qa),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new Cf(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new Qa,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new Af),this}clear(){super.clear(),this._mouseInput=null}}Rf.prototype.addDeviceOrientation=function(o){return this._deviceOrientationInput||(this._deviceOrientationInput=new FT,o&&(this._deviceOrientationInput.smoothFactor=o),this.add(this._deviceOrientationInput)),this};class FT{static WaitForOrientationChangeAsync(e){return new Promise((t,i)=>{let r=!1;const s=()=>{window.removeEventListener("deviceorientation",s),r=!0,t()};e&&setTimeout(()=>{r||(window.removeEventListener("deviceorientation",s),i("WaitForOrientationChangeAsync timed out"))},e),typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(n=>{n=="granted"?window.addEventListener("deviceorientation",s):J.Warn("Permission not granted.")}).catch(n=>{J.Error(n)}):window.addEventListener("deviceorientation",s)})}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new oe,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new Q,this._orientationChanged=()=>{this._screenOrientationAngle=window.orientation!==void 0?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-J.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=e.alpha!==null?J.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=e.beta!==null?J.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=e.gamma!==null?J.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=e.alpha!==null?e.alpha:0,this._beta=e.beta!==null?e.beta:0,this._gamma=e.gamma!==null?e.gamma:0),e.alpha!==null&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTranform=new oe(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,this._camera!=null&&!this._camera.rotationQuaternion&&(this._camera.rotationQuaternion=new oe),this._camera&&this._camera.onDisposeObservable.add(()=>{this._onDeviceOrientationChangedObservable.clear()})}attachControl(){const e=this.camera.getScene().getEngine().getHostWindow();if(e){const t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"?t():J.Warn("Permission not granted.")}).catch(i=>{J.Error(i)}):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&(oe.RotationYawPitchRollToRef(J.ToRadians(this._alpha),J.ToRadians(this._beta),-J.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform),this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}ks.FreeCameraDeviceOrientationInput=FT;class If{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=H.Identity(),this._deltaTransform=x.Zero(),this._vector3=x.Zero(),this._vector2=Ie.Zero()}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==Tr.POSE_ENABLED&&(!this.gamepad||t.type===Tr.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(Tr.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){const e=this.camera,t=this.gamepad.leftStick;this.gamepadMoveSensibility!==0&&(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadMoveSensibility:0,t.y=Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadMoveSensibility:0);let i=this.gamepad.rightStick;i&&this.gamepadAngularSensibility!==0?(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadAngularSensibility:0,i.y=(Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadAngularSensibility:0)*this._yAxisScale):i={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):H.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);const r=e._computeLocalCameraSpeed()*50;this._vector3.copyFromFloats(t.x*r,0,-t.y*r),x.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(i.y,i.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}}M([F()],If.prototype,"gamepadAngularSensibility",void 0);M([F()],If.prototype,"gamepadMoveSensibility",void 0);ks.FreeCameraGamepadInput=If;var es;(function(o){o[o.X=0]="X",o[o.Y=1]="Y",o[o.Z=2]="Z"})(es||(es={}));class tt{static _GetDefaultOptions(){return{puckSize:40,containerSize:60,color:"cyan",puckImage:void 0,containerImage:void 0,position:void 0,alwaysVisible:!1,limitToContainer:!1}}constructor(e,t){this._released=!1;const i={...tt._GetDefaultOptions(),...t};if(e?this._leftJoystick=!0:this._leftJoystick=!1,tt._GlobalJoystickIndex++,this._axisTargetedByLeftAndRight=es.X,this._axisTargetedByUpAndDown=es.Y,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new G_,this.deltaPosition=x.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._onResize=()=>{tt._VJCanvasWidth=window.innerWidth,tt._VJCanvasHeight=window.innerHeight,tt.Canvas&&(tt.Canvas.width=tt._VJCanvasWidth,tt.Canvas.height=tt._VJCanvasHeight),tt._HalfWidth=tt._VJCanvasWidth/2},!tt.Canvas){window.addEventListener("resize",this._onResize,!1),tt.Canvas=document.createElement("canvas"),tt._VJCanvasWidth=window.innerWidth,tt._VJCanvasHeight=window.innerHeight,tt.Canvas.width=window.innerWidth,tt.Canvas.height=window.innerHeight,tt.Canvas.style.width="100%",tt.Canvas.style.height="100%",tt.Canvas.style.position="absolute",tt.Canvas.style.backgroundColor="transparent",tt.Canvas.style.top="0px",tt.Canvas.style.left="0px",tt.Canvas.style.zIndex="5",tt.Canvas.style.touchAction="none",tt.Canvas.setAttribute("touch-action","none");const r=tt.Canvas.getContext("2d");if(!r)throw new Error("Unable to create canvas for virtual joystick");tt._VJCanvasContext=r,tt._VJCanvasContext.strokeStyle="#ffffff",tt._VJCanvasContext.lineWidth=2,document.body.appendChild(tt.Canvas)}tt._HalfWidth=tt.Canvas.width/2,this.pressed=!1,this.limitToContainer=i.limitToContainer,this._joystickColor=i.color,this.containerSize=i.containerSize,this.puckSize=i.puckSize,i.position&&this.setPosition(i.position.x,i.position.y),i.puckImage&&this.setPuckImage(i.puckImage),i.containerImage&&this.setContainerImage(i.containerImage),i.alwaysVisible&&tt._AlwaysVisibleSticks++,this.alwaysVisible=i.alwaysVisible,this._joystickPointerId=-1,this._joystickPointerPos=new Ie(0,0),this._joystickPreviousPointerPos=new Ie(0,0),this._joystickPointerStartPos=new Ie(0,0),this._deltaJoystickVector=new Ie(0,0),this._onPointerDownHandlerRef=r=>{this._onPointerDown(r)},this._onPointerMoveHandlerRef=r=>{this._onPointerMove(r)},this._onPointerUpHandlerRef=r=>{this._onPointerUp(r)},tt.Canvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,!1),tt.Canvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,!1),tt.Canvas.addEventListener("pointerup",this._onPointerUpHandlerRef,!1),tt.Canvas.addEventListener("pointerout",this._onPointerUpHandlerRef,!1),tt.Canvas.addEventListener("contextmenu",r=>{r.preventDefault()},!1),requestAnimationFrame(()=>{this._drawVirtualJoystick()})}setJoystickSensibility(e){this._joystickSensibility=e,this._inversedSensibility=1/(this._joystickSensibility/1e3)}_onPointerDown(e){let t;e.preventDefault(),this._leftJoystick===!0?t=e.clientX<tt._HalfWidth:t=e.clientX>tt._HalfWidth,t&&this._joystickPointerId<0?(this._joystickPointerId=e.pointerId,this._joystickPosition?(this._joystickPointerStartPos=this._joystickPosition.clone(),this._joystickPointerPos=this._joystickPosition.clone(),this._joystickPreviousPointerPos=this._joystickPosition.clone(),this._onPointerMove(e)):(this._joystickPointerStartPos.x=e.clientX,this._joystickPointerStartPos.y=e.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone()),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(e.pointerId.toString(),e)):tt._GlobalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(e.pointerId.toString(),{x:e.clientX,y:e.clientY,prevX:e.clientX,prevY:e.clientY}))}_onPointerMove(e){if(this._joystickPointerId==e.pointerId){if(this.limitToContainer){const n=new Ie(e.clientX-this._joystickPointerStartPos.x,e.clientY-this._joystickPointerStartPos.y),a=n.length();a>this.containerSize&&n.scaleInPlace(this.containerSize/a),this._joystickPointerPos.x=this._joystickPointerStartPos.x+n.x,this._joystickPointerPos.y=this._joystickPointerStartPos.y+n.y}else this._joystickPointerPos.x=e.clientX,this._joystickPointerPos.y=e.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos),0<tt._AlwaysVisibleSticks&&(this._leftJoystick?this._joystickPointerPos.x=Math.min(tt._HalfWidth,this._joystickPointerPos.x):this._joystickPointerPos.x=Math.max(tt._HalfWidth,this._joystickPointerPos.x));const i=(this.reverseLeftRight?-1:1)*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case es.X:this.deltaPosition.x=Math.min(1,Math.max(-1,i));break;case es.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,i));break;case es.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,i));break}const s=(this.reverseUpDown?1:-1)*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case es.X:this.deltaPosition.x=Math.min(1,Math.max(-1,s));break;case es.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,s));break;case es.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,s));break}}else{const t=this._touches.get(e.pointerId.toString());t&&(t.x=e.clientX,t.y=e.clientY)}}_onPointerUp(e){if(this._joystickPointerId==e.pointerId)this._clearPreviousDraw(),this._joystickPointerId=-1,this.pressed=!1;else{const t=this._touches.get(e.pointerId.toString());t&&tt._VJCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88)}this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(e.pointerId.toString())}setJoystickColor(e){this._joystickColor=e}set containerSize(e){this._joystickContainerSize=e,this._clearContainerSize=~~(this._joystickContainerSize*2.1),this._clearContainerSizeOffset=~~(this._clearContainerSize/2)}get containerSize(){return this._joystickContainerSize}set puckSize(e){this._joystickPuckSize=e,this._clearPuckSize=~~(this._joystickPuckSize*2.1),this._clearPuckSizeOffset=~~(this._clearPuckSize/2)}get puckSize(){return this._joystickPuckSize}clearPosition(){this.alwaysVisible=!1,this._joystickPosition=null}set alwaysVisible(e){this._alwaysVisible!==e&&(e&&this._joystickPosition?(tt._AlwaysVisibleSticks++,this._alwaysVisible=!0):(tt._AlwaysVisibleSticks--,this._alwaysVisible=!1))}get alwaysVisible(){return this._alwaysVisible}setPosition(e,t){this._joystickPointerStartPos&&this._clearPreviousDraw(),this._joystickPosition=new Ie(e,t)}setActionOnTouch(e){this._action=e}setAxisForLeftRight(e){switch(e){case es.X:case es.Y:case es.Z:this._axisTargetedByLeftAndRight=e;break;default:this._axisTargetedByLeftAndRight=es.X;break}}setAxisForUpDown(e){switch(e){case es.X:case es.Y:case es.Z:this._axisTargetedByUpAndDown=e;break;default:this._axisTargetedByUpAndDown=es.Y;break}}_clearPreviousDraw(){const e=this._joystickPosition||this._joystickPointerStartPos;tt._VJCanvasContext.clearRect(e.x-this._clearContainerSizeOffset,e.y-this._clearContainerSizeOffset,this._clearContainerSize,this._clearContainerSize),tt._VJCanvasContext.clearRect(this._joystickPreviousPointerPos.x-this._clearPuckSizeOffset,this._joystickPreviousPointerPos.y-this._clearPuckSizeOffset,this._clearPuckSize,this._clearPuckSize)}setContainerImage(e){const t=new Image;t.src=e,t.onload=()=>this._containerImage=t}setPuckImage(e){const t=new Image;t.src=e,t.onload=()=>this._puckImage=t}_drawContainer(){const e=this._joystickPosition||this._joystickPointerStartPos;this._clearPreviousDraw(),this._containerImage?tt._VJCanvasContext.drawImage(this._containerImage,e.x-this.containerSize,e.y-this.containerSize,this.containerSize*2,this.containerSize*2):(tt._VJCanvasContext.beginPath(),tt._VJCanvasContext.strokeStyle=this._joystickColor,tt._VJCanvasContext.lineWidth=2,tt._VJCanvasContext.arc(e.x,e.y,this.containerSize,0,Math.PI*2,!0),tt._VJCanvasContext.stroke(),tt._VJCanvasContext.closePath(),tt._VJCanvasContext.beginPath(),tt._VJCanvasContext.lineWidth=6,tt._VJCanvasContext.strokeStyle=this._joystickColor,tt._VJCanvasContext.arc(e.x,e.y,this.puckSize,0,Math.PI*2,!0),tt._VJCanvasContext.stroke(),tt._VJCanvasContext.closePath())}_drawPuck(){this._puckImage?tt._VJCanvasContext.drawImage(this._puckImage,this._joystickPointerPos.x-this.puckSize,this._joystickPointerPos.y-this.puckSize,this.puckSize*2,this.puckSize*2):(tt._VJCanvasContext.beginPath(),tt._VJCanvasContext.strokeStyle=this._joystickColor,tt._VJCanvasContext.lineWidth=2,tt._VJCanvasContext.arc(this._joystickPointerPos.x,this._joystickPointerPos.y,this.puckSize,0,Math.PI*2,!0),tt._VJCanvasContext.stroke(),tt._VJCanvasContext.closePath())}_drawVirtualJoystick(){this._released||(this.alwaysVisible&&this._drawContainer(),this.pressed&&this._touches.forEach((e,t)=>{t.pointerId===this._joystickPointerId?(this.alwaysVisible||this._drawContainer(),this._drawPuck(),this._joystickPreviousPointerPos=this._joystickPointerPos.clone()):(tt._VJCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88),tt._VJCanvasContext.beginPath(),tt._VJCanvasContext.fillStyle="white",tt._VJCanvasContext.beginPath(),tt._VJCanvasContext.strokeStyle="red",tt._VJCanvasContext.lineWidth=6,tt._VJCanvasContext.arc(t.x,t.y,40,0,Math.PI*2,!0),tt._VJCanvasContext.stroke(),tt._VJCanvasContext.closePath(),t.prevX=t.x,t.prevY=t.y)}),requestAnimationFrame(()=>{this._drawVirtualJoystick()}))}releaseCanvas(){tt.Canvas&&(tt.Canvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef),tt.Canvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef),tt.Canvas.removeEventListener("pointerup",this._onPointerUpHandlerRef),tt.Canvas.removeEventListener("pointerout",this._onPointerUpHandlerRef),window.removeEventListener("resize",this._onResize),document.body.removeChild(tt.Canvas),tt.Canvas=null),this._released=!0}}tt._GlobalJoystickIndex=0;tt._AlwaysVisibleSticks=0;Rf.prototype.addVirtualJoystick=function(){return this.add(new LT),this};class LT{getLeftJoystick(){return this._leftjoystick}getRightJoystick(){return this._rightjoystick}checkInputs(){if(this._leftjoystick){const e=this.camera,t=e._computeLocalCameraSpeed()*50,i=H.RotationYawPitchRoll(e.rotation.y,e.rotation.x,0),r=x.TransformCoordinates(new x(this._leftjoystick.deltaPosition.x*t,this._leftjoystick.deltaPosition.y*t,this._leftjoystick.deltaPosition.z*t),i);e.cameraDirection=e.cameraDirection.add(r),e.cameraRotation=e.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}}attachControl(){this._leftjoystick=new tt(!0),this._leftjoystick.setAxisForUpDown(es.Z),this._leftjoystick.setAxisForLeftRight(es.X),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new tt(!1),this._rightjoystick.setAxisForUpDown(es.X),this._rightjoystick.setAxisForLeftRight(es.Y),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")}detachControl(){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()}getClassName(){return"FreeCameraVirtualJoystickInput"}getSimpleName(){return"virtualJoystick"}}ks.FreeCameraVirtualJoystickInput=LT;class xr extends Ve{constructor(e,t,i,r=!0){super(e,t,i,r),this._tmpUpVector=x.Zero(),this._tmpTargetVector=x.Zero(),this.cameraDirection=new x(0,0,0),this.cameraRotation=new Ie(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new oe,this.rotation=new x(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=x.Zero(),this._initialFocalDistance=1,this._viewMatrix=H.Zero(),this._camMatrix=H.Zero(),this._cameraTransformMatrix=H.Zero(),this._cameraRotationMatrix=H.Zero(),this._referencePoint=new x(0,0,1),this._transformedReferencePoint=x.Zero(),this._defaultUp=x.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(e){this.getWorldMatrix();const t=this.getTarget().subtract(this.position);return t.normalize(),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){return this.lockedTarget?(this.lockedTarget.absolutePosition&&this.lockedTarget.computeWorldMatrix(),this.lockedTarget.absolutePosition||this.lockedTarget):null}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0):!1}_initCache(){super._initCache(),this._cache.lockedTarget=new x(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new x(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new oe(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();const t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;const e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(e.getFps()*100))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=kt),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),H.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);const t=e.subtract(this.position);t.x>=0?this.rotation.y=-Math.atan(t.z/t.x)+Math.PI/2:this.rotation.y=-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&oe.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent){this.parent.getWorldMatrix().invertToRef(j.Matrix[0]),x.TransformNormalToRef(this.cameraDirection,j.Matrix[0],j.Vector3[0]),this.position.addInPlace(j.Vector3[0]);return}this.position.addInPlace(this.cameraDirection)}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;t&&this._updatePosition(),i&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this.rotation),this.rotation.x+=this.cameraRotation.x*e,this.rotation.y+=this.cameraRotation.y*e,this.noRotationConstraint||(this.rotation.x>1.570796&&(this.rotation.x=1.570796),this.rotation.x<-1.570796&&(this.rotation.x=-1.570796)),this.rotationQuaternion&&this.rotation.lengthSquared()&&oe.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)),t&&(Math.abs(this.cameraDirection.x)<this.speed*kt&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*kt&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*kt&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*kt&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*kt&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):H.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return x.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),x.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?As.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(oe.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),As.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.ignoreParentScaling){if(this.parent){const r=this.parent.getWorldMatrix();x.TransformCoordinatesToRef(e,r,this._globalPosition),x.TransformCoordinatesToRef(t,r,this._tmpTargetVector),x.TransformNormalToRef(i,r,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(t),this._tmpUpVector.copyFrom(i);this.getScene().useRightHandedSystem?H.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):H.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix);return}if(this.getScene().useRightHandedSystem?H.LookAtRHToRef(e,t,i,this._viewMatrix):H.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){const r=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(r,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==Ve.RIG_MODE_NONE){const i=new xr(e,this.position.clone(),this.getScene());return i.isRigCamera=!0,i.rigParent=this,(this.cameraRigMode===Ve.RIG_MODE_VR||this.cameraRigMode===Ve.RIG_MODE_WEBVR)&&(this.rotationQuaternion||(this.rotationQuaternion=new oe),i._cameraRigParams={},i.rotationQuaternion=new oe),i.mode=this.mode,i.orthoLeft=this.orthoLeft,i.orthoRight=this.orthoRight,i.orthoTop=this.orthoTop,i.orthoBottom=this.orthoBottom,i}return null}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case Ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case Ve.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ve.RIG_MODE_STEREOSCOPIC_INTERLACED:{const i=this.cameraRigMode===Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,r=this.cameraRigMode===Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*r,t);break}case Ve.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position);break}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,xr._TargetFocalPoint),xr._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const r=xr._TargetFocalPoint.addInPlace(this.position);H.TranslationToRef(-r.x,-r.y,-r.z,xr._TargetTransformMatrix),xr._TargetTransformMatrix.multiplyToRef(H.RotationAxis(t.upVector,e),xr._RigCamTransformMatrix),H.TranslationToRef(r.x,r.y,r.z,xr._TargetTransformMatrix),xr._RigCamTransformMatrix.multiplyToRef(xr._TargetTransformMatrix,xr._RigCamTransformMatrix),x.TransformCoordinatesToRef(this.position,xr._RigCamTransformMatrix,t.position),t.setTarget(r)}getClassName(){return"TargetCamera"}}xr._RigCamTransformMatrix=new H;xr._TargetTransformMatrix=new H;xr._TargetFocalPoint=new x;M([Zs()],xr.prototype,"rotation",void 0);M([F()],xr.prototype,"speed",void 0);M([Du("lockedTargetId")],xr.prototype,"lockedTarget",void 0);class Qs extends xr{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new x(.5,1,.5),this.ellipsoidOffset=new x(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=x.Zero(),this._diffPosition=x.Zero(),this._newPosition=x.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(s,n,a=null)=>{(c=>{this._newPosition.copyFrom(c),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>q.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&a&&this.onCollide(a))})(n)},this.inputs=new Rf(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=J.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new x(0,0,0),this.cameraRotation=new Ie(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=x.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=x.Zero(),this._transformedDirection=x.Zero()),this.inputs.checkInputs(),super._checkInputs()}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}M([Zs()],Qs.prototype,"ellipsoid",void 0);M([Zs()],Qs.prototype,"ellipsoidOffset",void 0);M([F()],Qs.prototype,"checkCollisions",void 0);M([F()],Qs.prototype,"applyGravity",void 0);ii.AddNodeConstructor("TouchCamera",(o,e)=>()=>new BT(o,x.Zero(),e));class BT extends Qs{get touchAngularSensibility(){const e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)}get touchMoveSensibility(){const e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){const e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!1:e.allowMouse=!0}}ii.AddNodeConstructor("ArcRotateCamera",(o,e)=>()=>new Ei(o,0,0,1,x.Zero(),e));class Ei extends xr{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new H,this._upToYMatrix=new H,this._upVector=x.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){H.RotationAlignToRef(x.UpReadOnly,this._upVector,this._yToUpMatrix),H.RotationAlignToRef(this._upVector,x.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){const e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){const t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){const e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){const t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){const e=this.inputs.attached.pointers;return e?e.useNaturalPinchZoom:!1}set useNaturalPinchZoom(e){const t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){const e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){const t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){const e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){const e=this.inputs.attached.mousewheel;return e?e.zoomToMouseLocation:!1}set zoomToMouseLocation(e){const t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){const e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return this._bouncingBehavior!=null}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new rc,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return this._framingBehavior!=null}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new Pn,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return this._autoRotationBehavior!=null}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new US,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,i,r,s,n,a=!0){super(e,x.Zero(),n,a),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=x.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=Ie.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this._viewMatrix=new H,this.panningAxis=new x(1,1,0),this._transformedDirection=new x,this.mapPanning=!1,this.onMeshTargetChangedObservable=new Q,this.checkCollisions=!1,this.collisionRadius=new x(.5,.5,.5),this._previousPosition=x.Zero(),this._collisionVelocity=x.Zero(),this._newPosition=x.Zero(),this._computationVector=x.Zero(),this._onCollisionPositionChange=(l,c,h=null)=>{h?(this.setPosition(c),this.onCollide&&this.onCollide(h)):this._previousPosition.copyFrom(this._position);const u=Math.cos(this.alpha),d=Math.sin(this.alpha),f=Math.cos(this.beta);let _=Math.sin(this.beta);_===0&&(_=1e-4);const p=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*u*_,this.radius*f,this.radius*d*_),p.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let m=this.upVector;this.allowUpsideDown&&this.beta<0&&(m=m.clone(),m=m.negate()),this._computeViewMatrix(this._position,p,m),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=x.Zero(),s&&this.setTarget(s),this.alpha=t,this.beta=i,this.radius=r,this.getViewMatrix(),this.inputs=new um(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new x(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=Ie.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){const t=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?t.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(t)}const e=this._getLockedTargetPosition();return e||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0):!1}_isSynchronizedViewMatrix(){return super._isSynchronizedViewMatrix()?this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset):!1}attachControl(e,t,i=!0,r=2){const s=arguments;t=J.BackCompatCameraNoPreventDefault(s),this._useCtrlForPanning=i,this._panningMouseButton=r,typeof s[0]=="boolean"&&(s.length>1&&(this._useCtrlForPanning=s[1]),s.length>2&&(this._panningMouseButton=s[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0){const e=this.invertRotation?-1:1;let t=this.inertialAlphaOffset;this.beta<=0&&(t*=-1),this.getScene().useRightHandedSystem&&(t*=-1),this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(t*=-1),this.alpha+=t*e,this.beta+=this.inertialBetaOffset*e,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<kt&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<kt&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*kt&&(this.inertialRadiusOffset=0)}if(this.inertialPanningX!==0||this.inertialPanningY!==0){const e=new x(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);this._viewMatrix.invertToRef(this._cameraTransformMatrix),e.multiplyInPlace(this.panningAxis),x.TransformNormalToRef(e,this._cameraTransformMatrix,this._transformedDirection),(this.mapPanning||!this.panningAxis.y)&&(this._transformedDirection.y=0),this._targetHost||(this.panningDistanceLimit?(this._transformedDirection.addInPlace(this._target),x.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection)):this._target.addInPlace(this._transformedDirection)),this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*kt&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*kt&&(this.inertialPanningY=0)}this._checkLimits(),super._checkInputs()}}_checkLimits(){this.lowerBetaLimit===null||this.lowerBetaLimit===void 0?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit===null||this.upperBetaLimit===void 0?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerAlphaLimit!==null&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit!==null&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&x.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),this.radius===0&&(this.radius=1e-4);const e=this.alpha;this._computationVector.x===0&&this._computationVector.z===0?this.alpha=Math.PI/2:this.alpha=Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2))),this._computationVector.z<0&&(this.alpha=2*Math.PI-this.alpha);const t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=t*2*Math.PI,this.beta=Math.acos(this._computationVector.y/this.radius),this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,r=!1){var s;if(r=(s=this.overrideCloneAlphaBetaRadius)!==null&&s!==void 0?s:r,e.getBoundingInfo)t?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{const n=e,a=this._getTargetPosition();if(a&&!i&&a.equals(n))return;this._targetHost=null,this._target=n,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}r||this.rebuildAnglesAndRadius()}_getViewMatrix(){const e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta);let r=Math.sin(this.beta);r===0&&(r=1e-4),this.radius===0&&(this.radius=1e-4);const s=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*r,this.radius*i,this.radius*t*r),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&x.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),s.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){const n=this.getScene().collisionCoordinator;this._collider||(this._collider=n.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,n.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let n=this.upVector;this.allowUpsideDown&&r<0&&(n=n.negate()),this._computeViewMatrix(this._position,s,n),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=s,this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;const i=K.MinMax(e),r=x.Distance(i.min,i.max);this.radius=r*this.zoomOnFactor,this.focusOn({min:i.min,max:i.max,distance:r},t)}focusOn(e,t=!1){let i,r;if(e.min===void 0){const s=e||this.getScene().meshes;i=K.MinMax(s),r=x.Distance(i.min,i.max)}else{const s=e;i=s,r=s.distance}this._target=K.Center(i),t||(this.maxZ=r*2)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case Ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ve.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ve.RIG_MODE_STEREOSCOPIC_INTERLACED:case Ve.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(t===0?1:-1);break;case Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(t===0?-1:1);break}const r=new Ei(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return r._cameraRigParams={},r.isRigCamera=!0,r.rigParent=this,r.upVector=this.upVector,r.mode=this.mode,r.orthoLeft=this.orthoLeft,r.orthoRight=this.orthoRight,r.orthoBottom=this.orthoBottom,r.orthoTop=this.orthoTop,r}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case Ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ve.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ve.RIG_MODE_STEREOSCOPIC_INTERLACED:case Ve.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;break}super._updateRigCameras()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}}M([F()],Ei.prototype,"alpha",void 0);M([F()],Ei.prototype,"beta",void 0);M([F()],Ei.prototype,"radius",void 0);M([F()],Ei.prototype,"overrideCloneAlphaBetaRadius",void 0);M([Zs("target")],Ei.prototype,"_target",void 0);M([Du("targetHost")],Ei.prototype,"_targetHost",void 0);M([F()],Ei.prototype,"inertialAlphaOffset",void 0);M([F()],Ei.prototype,"inertialBetaOffset",void 0);M([F()],Ei.prototype,"inertialRadiusOffset",void 0);M([F()],Ei.prototype,"lowerAlphaLimit",void 0);M([F()],Ei.prototype,"upperAlphaLimit",void 0);M([F()],Ei.prototype,"lowerBetaLimit",void 0);M([F()],Ei.prototype,"upperBetaLimit",void 0);M([F()],Ei.prototype,"lowerRadiusLimit",void 0);M([F()],Ei.prototype,"upperRadiusLimit",void 0);M([F()],Ei.prototype,"inertialPanningX",void 0);M([F()],Ei.prototype,"inertialPanningY",void 0);M([F()],Ei.prototype,"pinchToPanMaxDistance",void 0);M([F()],Ei.prototype,"panningDistanceLimit",void 0);M([Zs()],Ei.prototype,"panningOriginTarget",void 0);M([F()],Ei.prototype,"panningInertia",void 0);M([F()],Ei.prototype,"zoomToMouseLocation",null);M([F()],Ei.prototype,"zoomOnFactor",void 0);M([Zp()],Ei.prototype,"targetScreenOffset",void 0);M([F()],Ei.prototype,"allowUpsideDown",void 0);M([F()],Ei.prototype,"useInputToRestoreState",void 0);ii.AddNodeConstructor("DeviceOrientationCamera",(o,e)=>()=>new dm(o,x.Zero(),e));class dm extends Qs{constructor(e,t,i){super(e,t,i),this._tmpDragQuaternion=new oe,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new oe,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce(()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add(r=>{this._dragFactor!=0&&(this._initialQuaternion||(this._initialQuaternion=new oe),oe.FromEulerAnglesToRef(0,r.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))}))})}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(e=As.Y){this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new oe),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach(t=>{e[t]?this._initialQuaternion[t]*=-1:this._initialQuaternion[t]=0}),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}}class JS extends bf{constructor(e){super(e)}addKeyboard(){return this.add(new Vl),this}addMouse(){return this.add(new yf),this}}class Pf extends xr{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysForward(){const e=this.inputs.attached.keyboard;return e?e.keysForward:[]}set keysForward(e){const t=this.inputs.attached.keyboard;t&&(t.keysForward=e)}get keysBackward(){const e=this.inputs.attached.keyboard;return e?e.keysBackward:[]}set keysBackward(e){const t=this.inputs.attached.keyboard;t&&(t.keysBackward=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new x(1,1,1),this.ellipsoidOffset=new x(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this.cameraDirection=x.Zero(),this._trackRoll=0,this.rollCorrect=100,this.bankedTurn=!1,this.bankedTurnLimit=Math.PI/2,this.bankedTurnMultiplier=1,this._needMoveForGravity=!1,this._oldPosition=x.Zero(),this._diffPosition=x.Zero(),this._newPosition=x.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(s,n,a=null)=>{(c=>{this._newPosition.copyFrom(c),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>q.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&a&&this.onCollide(a))})(n)},this.inputs=new JS(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=J.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new x(0,0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=x.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=x.Zero(),this._transformedDirection=x.Zero()),this.inputs.checkInputs(),super._checkInputs()}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}restoreRoll(e){const t=this._trackRoll,i=this.rotation.z,r=t-i,s=.001;Math.abs(r)>=s&&(this.rotation.z+=r/e,Math.abs(t-this.rotation.z)<=s&&(this.rotation.z=t))}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FlyCamera"}}M([Zs()],Pf.prototype,"ellipsoid",void 0);M([Zs()],Pf.prototype,"ellipsoidOffset",void 0);M([F()],Pf.prototype,"checkCollisions",void 0);M([F()],Pf.prototype,"applyGravity",void 0);class ey extends bf{constructor(e){super(e)}addKeyboard(){return this.add(new Rs),this}addMouseWheel(){return this.add(new mc),this}addPointers(){return this.add(new Ln),this}addVRDeviceOrientation(){return console.warn("DeviceOrientation support not yet implemented for FollowCamera."),this}}ii.AddNodeConstructor("FollowCamera",(o,e)=>()=>new _a(o,x.Zero(),e));ii.AddNodeConstructor("ArcFollowCamera",(o,e)=>()=>new ty(o,0,0,1,null,e));class _a extends xr{constructor(e,t,i,r=null){super(e,t,i),this.radius=12,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.rotationOffset=0,this.lowerRotationOffsetLimit=null,this.upperRotationOffsetLimit=null,this.heightOffset=4,this.lowerHeightOffsetLimit=null,this.upperHeightOffsetLimit=null,this.cameraAcceleration=.05,this.maxCameraSpeed=20,this.lockedTarget=r,this.inputs=new ey(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_follow(e){if(!e)return;const t=j.Matrix[0];e.absoluteRotationQuaternion.toRotationMatrix(t);const i=Math.atan2(t.m[8],t.m[10]),r=J.ToRadians(this.rotationOffset)+i,s=e.getAbsolutePosition(),n=s.x+Math.sin(r)*this.radius,a=s.z+Math.cos(r)*this.radius,l=n-this.position.x,c=s.y+this.heightOffset-this.position.y,h=a-this.position.z;let u=l*this.cameraAcceleration*2,d=c*this.cameraAcceleration,f=h*this.cameraAcceleration*2;(u>this.maxCameraSpeed||u<-this.maxCameraSpeed)&&(u=u<1?-this.maxCameraSpeed:this.maxCameraSpeed),(d>this.maxCameraSpeed||d<-this.maxCameraSpeed)&&(d=d<1?-this.maxCameraSpeed:this.maxCameraSpeed),(f>this.maxCameraSpeed||f<-this.maxCameraSpeed)&&(f=f<1?-this.maxCameraSpeed:this.maxCameraSpeed),this.position=new x(this.position.x+u,this.position.y+d,this.position.z+f),this.setTarget(s)}attachControl(e,t){t=J.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t),this._reset=()=>{}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){this.inputs.checkInputs(),this._checkLimits(),super._checkInputs(),this.lockedTarget&&this._follow(this.lockedTarget)}_checkLimits(){this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit),this.lowerHeightOffsetLimit!==null&&this.heightOffset<this.lowerHeightOffsetLimit&&(this.heightOffset=this.lowerHeightOffsetLimit),this.upperHeightOffsetLimit!==null&&this.heightOffset>this.upperHeightOffsetLimit&&(this.heightOffset=this.upperHeightOffsetLimit),this.lowerRotationOffsetLimit!==null&&this.rotationOffset<this.lowerRotationOffsetLimit&&(this.rotationOffset=this.lowerRotationOffsetLimit),this.upperRotationOffsetLimit!==null&&this.rotationOffset>this.upperRotationOffsetLimit&&(this.rotationOffset=this.upperRotationOffsetLimit)}getClassName(){return"FollowCamera"}}M([F()],_a.prototype,"radius",void 0);M([F()],_a.prototype,"lowerRadiusLimit",void 0);M([F()],_a.prototype,"upperRadiusLimit",void 0);M([F()],_a.prototype,"rotationOffset",void 0);M([F()],_a.prototype,"lowerRotationOffsetLimit",void 0);M([F()],_a.prototype,"upperRotationOffsetLimit",void 0);M([F()],_a.prototype,"heightOffset",void 0);M([F()],_a.prototype,"lowerHeightOffsetLimit",void 0);M([F()],_a.prototype,"upperHeightOffsetLimit",void 0);M([F()],_a.prototype,"cameraAcceleration",void 0);M([F()],_a.prototype,"maxCameraSpeed",void 0);M([Du("lockedTargetId")],_a.prototype,"lockedTarget",void 0);class ty extends xr{constructor(e,t,i,r,s,n){super(e,x.Zero(),n),this.alpha=t,this.beta=i,this.radius=r,this._cartesianCoordinates=x.Zero(),this.setMeshTarget(s)}setMeshTarget(e){this._meshTarget=e,this._follow()}_follow(){if(!this._meshTarget)return;this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta),this._cartesianCoordinates.y=this.radius*Math.sin(this.beta),this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);const e=this._meshTarget.getAbsolutePosition();this.position=e.add(this._cartesianCoordinates),this.setTarget(e)}_checkInputs(){super._checkInputs(),this._follow()}getClassName(){return"ArcFollowCamera"}}var To;(function(o){o[o.VIVE=0]="VIVE",o[o.OCULUS=1]="OCULUS",o[o.WINDOWS=2]="WINDOWS",o[o.GEAR_VR=3]="GEAR_VR",o[o.DAYDREAM=4]="DAYDREAM",o[o.GENERIC=5]="GENERIC"})(To||(To={}));class el{static InitiateController(e){for(const t of this._ControllerFactories)if(t.canCreate(e))return t.create(e);if(this._DefaultControllerFactory)return this._DefaultControllerFactory(e);throw"The type of gamepad you are trying to load needs to be imported first or is not supported."}}el._ControllerFactories=[];el._DefaultControllerFactory=null;class xu extends Tr{_disableTrackPosition(e){this._trackPosition&&(this._calculatedPosition.copyFrom(e),this._trackPosition=!1)}constructor(e){super(e.id,e.index,e),this.isXR=!1,this._deviceRoomPosition=x.Zero(),this._deviceRoomRotationQuaternion=new oe,this.devicePosition=x.Zero(),this.deviceRotationQuaternion=new oe,this.deviceScaleFactor=1,this._trackPosition=!0,this._maxRotationDistFromHeadset=Math.PI/5,this._draggedRoomRotation=0,this._leftHandSystemQuaternion=new oe,this._deviceToWorld=H.Identity(),this._pointingPoseNode=null,this._workingMatrix=H.Identity(),this._meshAttachedObservable=new Q,this.type=Tr.POSE_ENABLED,this.controllerType=To.GENERIC,this.position=x.Zero(),this.rotationQuaternion=new oe,this._calculatedPosition=x.Zero(),this._calculatedRotation=new oe,oe.RotationYawPitchRollToRef(Math.PI,0,0,this._leftHandSystemQuaternion)}update(){super.update(),this._updatePoseAndMesh()}_updatePoseAndMesh(){if(this.isXR)return;const e=this.browserGamepad.pose;if(this.updateFromDevice(e),!this._trackPosition&&qe.LastCreatedScene&&qe.LastCreatedScene.activeCamera&&qe.LastCreatedScene.activeCamera.devicePosition){const t=qe.LastCreatedScene.activeCamera;if(t._computeDevicePosition(),this._deviceToWorld.setTranslation(t.devicePosition),t.deviceRotationQuaternion){t._deviceRoomRotationQuaternion.toEulerAnglesToRef(j.Vector3[0]);const i=Math.atan2(Math.sin(j.Vector3[0].y-this._draggedRoomRotation),Math.cos(j.Vector3[0].y-this._draggedRoomRotation));if(Math.abs(i)>this._maxRotationDistFromHeadset){const r=i-(i<0?-this._maxRotationDistFromHeadset:this._maxRotationDistFromHeadset);this._draggedRoomRotation+=r;const s=Math.sin(-r),n=Math.cos(-r);this._calculatedPosition.x=this._calculatedPosition.x*n-this._calculatedPosition.z*s,this._calculatedPosition.z=this._calculatedPosition.x*s+this._calculatedPosition.z*n}}}x.TransformCoordinatesToRef(this._calculatedPosition,this._deviceToWorld,this.devicePosition),this._deviceToWorld.getRotationMatrixToRef(this._workingMatrix),oe.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion),this.deviceRotationQuaternion.multiplyInPlace(this._calculatedRotation),this._mesh&&(this._mesh.position.copyFrom(this.devicePosition),this._mesh.rotationQuaternion&&this._mesh.rotationQuaternion.copyFrom(this.deviceRotationQuaternion))}updateFromDevice(e){if(!this.isXR&&e){this.rawPose=e,e.position&&(this._deviceRoomPosition.copyFromFloats(e.position[0],e.position[1],-e.position[2]),this._mesh&&this._mesh.getScene().useRightHandedSystem&&(this._deviceRoomPosition.z*=-1),this._trackPosition&&this._deviceRoomPosition.scaleToRef(this.deviceScaleFactor,this._calculatedPosition),this._calculatedPosition.addInPlace(this.position));const t=this.rawPose;e.orientation&&t.orientation&&t.orientation.length===4&&(this._deviceRoomRotationQuaternion.copyFromFloats(t.orientation[0],t.orientation[1],-t.orientation[2],-t.orientation[3]),this._mesh&&(this._mesh.getScene().useRightHandedSystem?(this._deviceRoomRotationQuaternion.z*=-1,this._deviceRoomRotationQuaternion.w*=-1):this._deviceRoomRotationQuaternion.multiplyToRef(this._leftHandSystemQuaternion,this._deviceRoomRotationQuaternion)),this._deviceRoomRotationQuaternion.multiplyToRef(this.rotationQuaternion,this._calculatedRotation))}}attachToMesh(e){if(this._mesh&&(this._mesh.parent=null),this._mesh=e,this._poseControlledCamera&&(this._mesh.parent=this._poseControlledCamera),this._mesh.rotationQuaternion||(this._mesh.rotationQuaternion=new oe),!this.isXR&&(this._updatePoseAndMesh(),this._pointingPoseNode)){const t=[];let i=this._pointingPoseNode;for(;i.parent;)t.push(i.parent),i=i.parent;t.reverse().forEach(r=>{r.computeWorldMatrix(!0)})}this._meshAttachedObservable.notifyObservers(e)}attachToPoseControlledCamera(e){this._poseControlledCamera=e,this._mesh&&(this._mesh.parent=this._poseControlledCamera)}dispose(){this._mesh&&this._mesh.dispose(),this._mesh=null,super.dispose()}get mesh(){return this._mesh}getForwardRay(e=100){if(!this.mesh)return new Pt(x.Zero(),new x(0,0,1),e);const t=this._pointingPoseNode?this._pointingPoseNode.getWorldMatrix():this.mesh.getWorldMatrix(),i=t.getTranslation(),r=new x(0,0,-1),s=x.TransformNormal(r,t),n=x.Normalize(s);return new Pt(i,n,e)}}xu.POINTING_POSE="POINTING_POSE";var Xn;(function(o){o[o.A=0]="A",o[o.B=1]="B",o[o.X=2]="X",o[o.Y=3]="Y",o[o.LB=4]="LB",o[o.RB=5]="RB",o[o.Back=8]="Back",o[o.Start=9]="Start",o[o.LeftStick=10]="LeftStick",o[o.RightStick=11]="RightStick"})(Xn||(Xn={}));var Bc;(function(o){o[o.Up=12]="Up",o[o.Down=13]="Down",o[o.Left=14]="Left",o[o.Right=15]="Right"})(Bc||(Bc={}));class iy extends Tr{constructor(e,t,i,r=!1){super(e,t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new Q,this.onButtonUpObservable=new Q,this.onPadDownObservable=new Q,this.onPadUpObservable=new Q,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=Tr.XBOX,this._isXboxOnePad=r}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,Xn.A)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,Xn.B)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,Xn.X)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,Xn.Y)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,Xn.Start)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,Xn.Back)}get buttonLB(){return this._buttonLB}set buttonLB(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,Xn.LB)}get buttonRB(){return this._buttonRB}set buttonRB(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,Xn.RB)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,Xn.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,Xn.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,Bc.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,Bc.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,Bc.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,Bc.Right)}update(){super.update(),this._isXboxOnePad?(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value):(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}var Ta;(function(o){o[o.Cross=0]="Cross",o[o.Circle=1]="Circle",o[o.Square=2]="Square",o[o.Triangle=3]="Triangle",o[o.L1=4]="L1",o[o.R1=5]="R1",o[o.Share=8]="Share",o[o.Options=9]="Options",o[o.LeftStick=10]="LeftStick",o[o.RightStick=11]="RightStick"})(Ta||(Ta={}));var Uc;(function(o){o[o.Up=12]="Up",o[o.Down=13]="Down",o[o.Left=14]="Left",o[o.Right=15]="Right"})(Uc||(Uc={}));class ry extends Tr{constructor(e,t,i){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new Q,this.onButtonUpObservable=new Q,this.onPadDownObservable=new Q,this.onPadUpObservable=new Q,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=Tr.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,Ta.Cross)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,Ta.Circle)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,Ta.Square)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,Ta.Triangle)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,Ta.Options)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,Ta.Share)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,Ta.L1)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,Ta.R1)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,Ta.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,Ta.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,Uc.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,Uc.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,Uc.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,Uc.Right)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}class sy{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new Q,Ar()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new Q(t=>{for(const i in this._babylonGamepads){const r=this._babylonGamepads[i];r&&r._isConnected&&this.onGamepadConnectedObservable.notifyObserver(t,r)}}),this._onGamepadConnectedEvent=t=>{const i=t.gamepad;if(i.index in this._babylonGamepads&&this._babylonGamepads[i.index].isConnected)return;let r;this._babylonGamepads[i.index]?(r=this._babylonGamepads[i.index],r.browserGamepad=i,r._isConnected=!0):r=this._addNewGamepad(i),this.onGamepadConnectedObservable.notifyObservers(r),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=t=>{const i=t.gamepad;for(const r in this._babylonGamepads)if(this._babylonGamepads[r].index===i.index){const s=this._babylonGamepads[r];s._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(s),s.dispose&&s.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){const t=this._scene?this._scene.getEngine().getHostWindow():window;t&&(t.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),t.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=Tr.XBOX){for(const t of this._babylonGamepads)if(t&&t.type===e)return t;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach(e=>{e.dispose()}),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){this._oneGamepadConnected||(this._oneGamepadConnected=!0);let t;const i=e.id.search("054c")!==-1&&e.id.search("0ce6")===-1,r=e.id.search("Xbox One")!==-1;return r||e.id.search("Xbox 360")!==-1||e.id.search("xinput")!==-1||e.id.search("045e")!==-1&&e.id.search("Surface Dock")===-1?t=new iy(e.id,e.index,e,r):i?t=new ry(e.id,e.index,e):e.pose?t=el.InitiateController(e):t=new QS(e.id,e.index,e),this._babylonGamepads[t.index]=t,t}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._scene||this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(const e in this._babylonGamepads){const t=this._babylonGamepads[e];if(!(!t||!t.isConnected))try{t.update()}catch{this._loggedErrors.indexOf(t.index)===-1&&(J.Warn(`Error updating gamepad ${t.id}`),this._loggedErrors.push(t.index))}}this._isMonitoring&&!this._scene&&q.QueueNewFrame(()=>{this._checkGamepadsStatus()})}_updateGamepadObjects(){const e=navigator.getGamepads?navigator.getGamepads():[];for(let t=0;t<e.length;t++){const i=e[t];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[t].browserGamepad=i,this._babylonGamepads[t].isConnected||(this._babylonGamepads[t]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t]));else{const r=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(r)}}}}Object.defineProperty(Ne.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new sy(this);let o=this._getComponent(Re.NAME_GAMEPAD);o||(o=new ny(this),this._addComponent(o))}return this._gamepadManager},enumerable:!0,configurable:!0});Rf.prototype.addGamepad=function(){return this.add(new If),this};um.prototype.addGamepad=function(){return this.add(new Sf),this};class ny{constructor(e){this.name=Re.NAME_GAMEPAD,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(Re.STEP_BEFORECAMERAUPDATE_GAMEPAD,this,this._beforeCameraUpdate)}rebuild(){}dispose(){const e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}_beforeCameraUpdate(){const e=this.scene._gamepadManager;e&&e._isMonitoring&&e._checkGamepadsStatus()}}ii.AddNodeConstructor("FreeCamera",(o,e)=>()=>new Th(o,x.Zero(),e));class Th extends BT{get gamepadAngularSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}}Ve._CreateDefaultParsedCamera=(o,e)=>new Th(o,x.Zero(),e);ii.AddNodeConstructor("GamepadCamera",(o,e)=>()=>new fm(o,x.Zero(),e));class fm extends Th{constructor(e,t,i){super(e,t,i)}getClassName(){return"GamepadCamera"}}const ay="passCubePixelShader",oy=`varying vec2 vUV;
uniform samplerCube textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
vec2 uv=vUV*2.0-1.0;
#ifdef POSITIVEX
gl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));
#endif
#ifdef NEGATIVEX
gl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));
#endif
#ifdef POSITIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));
#endif
#ifdef NEGATIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));
#endif
#ifdef POSITIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,1.001));
#endif
#ifdef NEGATIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));
#endif
}`;te.ShadersStore[ay]=oy;class So extends et{getClassName(){return"PassPostProcess"}constructor(e,t,i=null,r,s,n,a=0,l=!1){super(e,"pass",null,null,t,i,r,s,n,void 0,a,void 0,null,l)}static _Parse(e,t,i,r){return ke.Parse(()=>new So(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,i,r)}}ye("BABYLON.PassPostProcess",So);q._RescalePostProcessFactory=o=>new So("rescale",1,null,2,o,!1,0);const ly="anaglyphPixelShader",cy=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D leftSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec4 leftFrag=texture2D(leftSampler,vUV);
leftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);
vec4 rightFrag=texture2D(textureSampler,vUV);
rightFrag=vec4(rightFrag.r,1.0,1.0,1.0);
gl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);
}`;te.ShadersStore[ly]=cy;class UT extends et{getClassName(){return"AnaglyphPostProcess"}constructor(e,t,i,r,s,n){super(e,"anaglyph",null,["leftSampler"],t,i[1],r,s,n),this._passedProcess=i[0]._rigPostProcess,this.onApplyObservable.add(a=>{a.setTextureFromPostProcess("leftSampler",this._passedProcess)})}}ye("BABYLON.AnaglyphPostProcess",UT);function Mf(o){o._rigCameras[0]._rigPostProcess=new So(o.name+"_passthru",1,o._rigCameras[0]),o._rigCameras[1]._rigPostProcess=new UT(o.name+"_anaglyph",1,o._rigCameras)}ii.AddNodeConstructor("AnaglyphArcRotateCamera",(o,e,t)=>()=>new hy(o,0,0,1,x.Zero(),t.interaxial_distance,e));class hy extends Ei{constructor(e,t,i,r,s,n,a){super(e,t,i,r,s,a),this._setRigMode=Mf.bind(null,this),this.interaxialDistance=n,this.setCameraRigMode(Ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:n})}getClassName(){return"AnaglyphArcRotateCamera"}}ii.AddNodeConstructor("AnaglyphFreeCamera",(o,e,t)=>()=>new uy(o,x.Zero(),t.interaxial_distance,e));class uy extends Qs{constructor(e,t,i,r){super(e,t,r),this._setRigMode=Mf.bind(null,this),this.interaxialDistance=i,this.setCameraRigMode(Ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphFreeCamera"}}ii.AddNodeConstructor("AnaglyphGamepadCamera",(o,e,t)=>()=>new dy(o,x.Zero(),t.interaxial_distance,e));class dy extends fm{constructor(e,t,i,r){super(e,t,r),this._setRigMode=Mf.bind(null,this),this.interaxialDistance=i,this.setCameraRigMode(Ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphGamepadCamera"}}ii.AddNodeConstructor("AnaglyphUniversalCamera",(o,e,t)=>()=>new fy(o,x.Zero(),t.interaxial_distance,e));class fy extends Th{constructor(e,t,i,r){super(e,t,r),this._setRigMode=Mf.bind(null,this),this.interaxialDistance=i,this.setCameraRigMode(Ve.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphUniversalCamera"}}const _y="stereoscopicInterlacePixelShader",py=`const vec3 TWO=vec3(2.0,2.0,2.0);
varying vec2 vUV;
uniform sampler2D camASampler;
uniform sampler2D textureSampler;
uniform vec2 stepSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
bool useCamA;
bool useCamB;
vec2 texCoord1;
vec2 texCoord2;
vec3 frag1;
vec3 frag2;
#ifdef IS_STEREOSCOPIC_HORIZ
useCamB=vUV.x>0.5;
useCamA=!useCamB;
texCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);
texCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);
#else
#ifdef IS_STEREOSCOPIC_INTERLACED
float rowNum=floor(vUV.y/stepSize.y);
useCamA=mod(rowNum,2.0)==1.0;
useCamB=mod(rowNum,2.0)==0.0;
texCoord1=vec2(vUV.x,vUV.y);
texCoord2=vec2(vUV.x,vUV.y);
#else
useCamB=vUV.y>0.5;
useCamA=!useCamB;
texCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);
texCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);
#endif
#endif
if (useCamB){
frag1=texture2D(textureSampler,texCoord1).rgb;
frag2=texture2D(textureSampler,texCoord2).rgb;
}else if (useCamA){
frag1=texture2D(camASampler ,texCoord1).rgb;
frag2=texture2D(camASampler ,texCoord2).rgb;
}else {
discard;
}
gl_FragColor=vec4((frag1+frag2)/TWO,1.0);
}
`;te.ShadersStore[_y]=py;class my extends et{getClassName(){return"StereoscopicInterlacePostProcessI"}constructor(e,t,i,r,s,n,a){super(e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,t[1],s,n,a,r?"#define IS_STEREOSCOPIC_INTERLACED 1":i?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=t[0]._rigPostProcess,this._stepSize=new Ie(1/this.width,1/this.height),this.onSizeChangedObservable.add(()=>{this._stepSize=new Ie(1/this.width,1/this.height)}),this.onApplyObservable.add(l=>{l.setTextureFromPostProcess("camASampler",this._passedProcess),l.setFloat2("stepSize",this._stepSize.x,this._stepSize.y)})}}function Of(o){const e=o.cameraRigMode===Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||o.cameraRigMode===Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,t=o.cameraRigMode===Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;o.cameraRigMode===Ve.RIG_MODE_STEREOSCOPIC_INTERLACED?(o._rigCameras[0]._rigPostProcess=new So(o.name+"_passthru",1,o._rigCameras[0]),o._rigCameras[1]._rigPostProcess=new my(o.name+"_stereoInterlace",o._rigCameras,!1,!0)):(o._rigCameras[t?1:0].viewport=new Dn(0,0,e?.5:1,e?1:.5),o._rigCameras[t?0:1].viewport=new Dn(e?.5:0,e?0:.5,e?.5:1,e?1:.5))}ii.AddNodeConstructor("StereoscopicArcRotateCamera",(o,e,t)=>()=>new gy(o,0,0,1,x.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class gy extends Ei{constructor(e,t,i,r,s,n,a,l){super(e,t,i,r,s,l),this._setRigMode=Of.bind(null,this),this.interaxialDistance=n,this.isStereoscopicSideBySide=a,this.setCameraRigMode(a?Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ve.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:n})}getClassName(){return"StereoscopicArcRotateCamera"}}ii.AddNodeConstructor("StereoscopicFreeCamera",(o,e,t)=>()=>new vy(o,x.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class vy extends Qs{constructor(e,t,i,r,s){super(e,t,s),this._setRigMode=Of.bind(null,this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ve.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicFreeCamera"}}ii.AddNodeConstructor("StereoscopicGamepadCamera",(o,e,t)=>()=>new xy(o,x.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class xy extends fm{constructor(e,t,i,r,s){super(e,t,s),this._setRigMode=Of.bind(null,this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ve.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicGamepadCamera"}}ii.AddNodeConstructor("StereoscopicFreeCamera",(o,e,t)=>()=>new Ty(o,x.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class Ty extends Th{constructor(e,t,i,r,s){super(e,t,s),this._setRigMode=Of.bind(null,this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?Ve.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ve.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicUniversalCamera"}}ii.AddNodeConstructor("VirtualJoysticksCamera",(o,e)=>()=>new Ey(o,x.Zero(),e));class Ey extends Qs{constructor(e,t,i){super(e,t,i),this.inputs.addVirtualJoystick()}getClassName(){return"VirtualJoysticksCamera"}}class gc{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){const t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return H.Translation(t,0,0)}get rightHMatrix(){const t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return H.Translation(-t,0,0)}get leftPreViewMatrix(){return H.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return H.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){const e=new gc;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}}const by="vrDistortionCorrectionPixelShader",Sy=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 LensCenter;
uniform vec2 Scale;
uniform vec2 ScaleIn;
uniform vec4 HmdWarpParam;
vec2 HmdWarp(vec2 in01) {
vec2 theta=(in01-LensCenter)*ScaleIn; 
float rSq=theta.x*theta.x+theta.y*theta.y;
vec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);
return LensCenter+Scale*rvector;
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec2 tc=HmdWarp(vUV);
if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)
gl_FragColor=vec4(0.0,0.0,0.0,0.0);
else{
gl_FragColor=texture2D(textureSampler,tc);
}
}`;te.ShadersStore[by]=Sy;class fv extends et{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,t,i,r){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,r.postProcessScaleFactor,t,Y.BILINEAR_SAMPLINGMODE),this._isRightEye=i,this._distortionFactors=r.distortionK,this._postProcessScaleFactor=r.postProcessScaleFactor,this._lensCenterOffset=r.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add(()=>{this._scaleIn=new Ie(2,2/this.aspectRatio),this._scaleFactor=new Ie(.5*(1/this._postProcessScaleFactor),.5*(1/this._postProcessScaleFactor)*this.aspectRatio),this._lensCenter=new Ie(this._isRightEye?.5-this._lensCenterOffset*.5:.5+this._lensCenterOffset*.5,.5)}),this.onApplyObservable.add(s=>{s.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),s.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),s.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),s.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])})}}const yy="vrMultiviewToSingleviewPixelShader",Cy=`precision mediump sampler2DArray;
varying vec2 vUV;
uniform sampler2DArray multiviewSampler;
uniform int imageIndex;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));
}`;te.ShadersStore[yy]=Cy;class Y_ extends Zi{set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}}q.prototype.createMultiviewRenderTargetTexture=function(o,e){const t=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";const i=this._createHardwareRenderTargetWrapper(!1,!1,{width:o,height:e});i._framebuffer=t.createFramebuffer();const r=new hi(this,bt.Unknown,!0);return r.width=o,r.height=e,r.isMultiview=!0,i._colorTextureArray=t.createTexture(),t.bindTexture(t.TEXTURE_2D_ARRAY,i._colorTextureArray),t.texStorage3D(t.TEXTURE_2D_ARRAY,1,t.RGBA8,o,e,2),i._depthStencilTextureArray=t.createTexture(),t.bindTexture(t.TEXTURE_2D_ARRAY,i._depthStencilTextureArray),t.texStorage3D(t.TEXTURE_2D_ARRAY,1,t.DEPTH24_STENCIL8,o,e,2),r.isReady=!0,i.setTextures(r),i._depthStencilTexture=r,i};q.prototype.bindMultiviewFramebuffer=function(o){const e=o,t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)this.getCaps().oculusMultiview?(i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,e.samples,0,2),i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,e.samples,0,2)):(i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,0,2));else throw"Invalid multiview frame buffer"};Ve.prototype._useMultiviewToSingleView=!1;Ve.prototype._multiviewTexture=null;Ve.prototype._resizeOrCreateMultiviewTexture=function(o,e){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=o||this._multiviewTexture.getRenderHeight()!=e)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new Y_(this.getScene(),{width:o,height:e})):this._multiviewTexture=new Y_(this.getScene(),{width:o,height:e})};function VT(o,e){const t=new $e(o,void 0,!0,e);return t.addUniform("viewProjection",16),t.addUniform("viewProjectionR",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}const Ay=Ne.prototype.createSceneUniformBuffer;Ne.prototype._transformMatrixR=H.Zero();Ne.prototype._multiviewSceneUbo=null;Ne.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=VT(this.getEngine(),"scene_multiview")};Ne.prototype.createSceneUniformBuffer=function(o){return this._multiviewSceneUbo?VT(this.getEngine(),o):Ay.bind(this)(o)};Ne.prototype._updateMultiviewUbo=function(o,e){o&&e&&o.multiplyToRef(e,this._transformMatrixR),o&&e&&(o.multiplyToRef(e,j.Matrix[0]),aa.GetRightPlaneToRef(j.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))};Ne.prototype._renderMultiviewToSingleView=function(o){o._resizeOrCreateMultiviewTexture(o._rigPostProcess&&o._rigPostProcess&&o._rigPostProcess.width>0?o._rigPostProcess.width:this.getEngine().getRenderWidth(!0),o._rigPostProcess&&o._rigPostProcess&&o._rigPostProcess.height>0?o._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),o.outputRenderTarget=o._multiviewTexture,this._renderForCamera(o),o.outputRenderTarget=null;for(let e=0;e<o._rigCameras.length;e++){const t=this.getEngine();this._activeCamera=o._rigCameras[e],t.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};class kT extends et{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,i){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],i,t,Y.BILINEAR_SAMPLINGMODE);const r=t??this.getCamera();this.onSizeChangedObservable.add(()=>{}),this.onApplyObservable.add(s=>{r._scene.activeCamera&&r._scene.activeCamera.isLeftCamera?s.setInt("imageIndex",0):s.setInt("imageIndex",1),s.setTexture("multiviewSampler",r._multiviewTexture)})}}function _m(o,e){const t=e.vrCameraMetrics||gc.GetDefault();o._rigCameras[0]._cameraRigParams.vrMetrics=t,o._rigCameras[0].viewport=new Dn(0,0,.5,1),o._rigCameras[0]._cameraRigParams.vrWorkMatrix=new H,o._rigCameras[0]._cameraRigParams.vrHMatrix=t.leftHMatrix,o._rigCameras[0]._cameraRigParams.vrPreViewMatrix=t.leftPreViewMatrix,o._rigCameras[0].getProjectionMatrix=o._rigCameras[0]._getVRProjectionMatrix,o._rigCameras[1]._cameraRigParams.vrMetrics=t,o._rigCameras[1].viewport=new Dn(.5,0,.5,1),o._rigCameras[1]._cameraRigParams.vrWorkMatrix=new H,o._rigCameras[1]._cameraRigParams.vrHMatrix=t.rightHMatrix,o._rigCameras[1]._cameraRigParams.vrPreViewMatrix=t.rightPreViewMatrix,o._rigCameras[1].getProjectionMatrix=o._rigCameras[1]._getVRProjectionMatrix,t.multiviewEnabled&&(o.getScene().getEngine().getCaps().multiview?(o._useMultiviewToSingleView=!0,o._rigPostProcess=new kT("VRMultiviewToSingleview",o,t.postProcessScaleFactor)):(X.Warn("Multiview is not supported, falling back to standard rendering"),t.multiviewEnabled=!1)),t.compensateDistortion&&(o._rigCameras[0]._rigPostProcess=new fv("VR_Distort_Compensation_Left",o._rigCameras[0],!1,t),o._rigCameras[1]._rigPostProcess=new fv("VR_Distort_Compensation_Right",o._rigCameras[1],!0,t))}ii.AddNodeConstructor("VRDeviceOrientationArcRotateCamera",(o,e)=>()=>new Ry(o,0,0,1,x.Zero(),e));class Ry extends Ei{constructor(e,t,i,r,s,n,a=!0,l=gc.GetDefault()){super(e,t,i,r,s,n),this._setRigMode=_m.bind(null,this),l.compensateDistortion=a,this.setCameraRigMode(Ve.RIG_MODE_VR,{vrCameraMetrics:l}),this.inputs.addVRDeviceOrientation()}getClassName(){return"VRDeviceOrientationArcRotateCamera"}}ii.AddNodeConstructor("VRDeviceOrientationFreeCamera",(o,e)=>()=>new pm(o,x.Zero(),e));class pm extends dm{constructor(e,t,i,r=!0,s=gc.GetDefault()){super(e,t,i),this._setRigMode=_m.bind(null,this),s.compensateDistortion=r,this.setCameraRigMode(Ve.RIG_MODE_VR,{vrCameraMetrics:s})}getClassName(){return"VRDeviceOrientationFreeCamera"}}ii.AddNodeConstructor("VRDeviceOrientationGamepadCamera",(o,e)=>()=>new Iy(o,x.Zero(),e));class Iy extends pm{constructor(e,t,i,r=!0,s=gc.GetDefault()){super(e,t,i,r,s),this._setRigMode=_m.bind(null,this),this.inputs.addGamepad()}getClassName(){return"VRDeviceOrientationGamepadCamera"}}ii.AddNodeConstructor("Light_Type_3",(o,e)=>()=>new kl(o,x.Zero(),e));class kl extends St{constructor(e,t,i){super(e,i),this.groundColor=new ge(0,0,0),this.direction=t||x.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=x.Normalize(e.subtract(x.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){const i=x.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){const i=x.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=H.Identity()),this._worldMatrix}getTypeID(){return St.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}}M([Kr()],kl.prototype,"groundColor",void 0);M([Zs()],kl.prototype,"direction",void 0);function Py(o,e){if(e.vrDisplay){const t=e.vrDisplay.getEyeParameters("left"),i=e.vrDisplay.getEyeParameters("right");o._rigCameras[0].viewport=new Dn(0,0,.5,1),o._rigCameras[0].setCameraRigParameter("left",!0),o._rigCameras[0].setCameraRigParameter("specs",e.specs),o._rigCameras[0].setCameraRigParameter("eyeParameters",t),o._rigCameras[0].setCameraRigParameter("frameData",e.frameData),o._rigCameras[0].setCameraRigParameter("parentCamera",e.parentCamera),o._rigCameras[0]._cameraRigParams.vrWorkMatrix=new H,o._rigCameras[0].getProjectionMatrix=o._getWebVRProjectionMatrix,o._rigCameras[0].parent=o,o._rigCameras[0]._getViewMatrix=o._getWebVRViewMatrix,o._rigCameras[1].viewport=new Dn(.5,0,.5,1),o._rigCameras[1].setCameraRigParameter("eyeParameters",i),o._rigCameras[1].setCameraRigParameter("specs",e.specs),o._rigCameras[1].setCameraRigParameter("frameData",e.frameData),o._rigCameras[1].setCameraRigParameter("parentCamera",e.parentCamera),o._rigCameras[1]._cameraRigParams.vrWorkMatrix=new H,o._rigCameras[1].getProjectionMatrix=o._getWebVRProjectionMatrix,o._rigCameras[1].parent=o,o._rigCameras[1]._getViewMatrix=o._getWebVRViewMatrix}}Object.defineProperty(q.prototype,"isInVRExclusivePointerMode",{get:function(){return this._vrExclusivePointerMode},enumerable:!0,configurable:!0});q.prototype._prepareVRComponent=function(){this._vrSupported=!1,this._vrExclusivePointerMode=!1,this.onVRDisplayChangedObservable=new Q,this.onVRRequestPresentComplete=new Q,this.onVRRequestPresentStart=new Q};q.prototype.isVRDevicePresent=function(){return!!this._vrDisplay};q.prototype.getVRDevice=function(){return this._vrDisplay};q.prototype.initWebVR=function(){return this.initWebVRAsync(),this.onVRDisplayChangedObservable};q.prototype.initWebVRAsync=function(){const o=()=>{const e={vrDisplay:this._vrDisplay,vrSupported:this._vrSupported};this.onVRDisplayChangedObservable.notifyObservers(e),this._webVRInitPromise=new Promise(t=>{t(e)})};if(!this._onVrDisplayConnect){this._onVrDisplayConnect=t=>{this._vrDisplay=t.display,o()},this._onVrDisplayDisconnect=()=>{this._vrDisplay.cancelAnimationFrame(this._frameHandler),this._vrDisplay=void 0,this._frameHandler=q.QueueNewFrame(this._boundRenderFunction),o()},this._onVrDisplayPresentChange=()=>{this._vrExclusivePointerMode=this._vrDisplay&&this._vrDisplay.isPresenting};const e=this.getHostWindow();e&&(e.addEventListener("vrdisplayconnect",this._onVrDisplayConnect),e.addEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),e.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange))}return this._webVRInitPromise=this._webVRInitPromise||this._getVRDisplaysAsync(),this._webVRInitPromise.then(o),this._webVRInitPromise};q.prototype._getVRDisplaysAsync=function(){return new Promise(o=>{navigator.getVRDisplays?navigator.getVRDisplays().then(e=>{this._vrSupported=!0,this._vrDisplay=e[0],o({vrDisplay:this._vrDisplay,vrSupported:this._vrSupported})}):(this._vrDisplay=void 0,this._vrSupported=!1,o({vrDisplay:this._vrDisplay,vrSupported:this._vrSupported}))})};q.prototype.enableVR=function(o){if(this._vrDisplay&&!this._vrDisplay.isPresenting){const e=()=>{this.onVRRequestPresentComplete.notifyObservers(!0),this._onVRFullScreenTriggered()},t=()=>{this.onVRRequestPresentComplete.notifyObservers(!1)};this.onVRRequestPresentStart.notifyObservers(this);const i={highRefreshRate:this.vrPresentationAttributes?this.vrPresentationAttributes.highRefreshRate:!1,foveationLevel:this.vrPresentationAttributes?this.vrPresentationAttributes.foveationLevel:1,multiview:(this.getCaps().multiview||this.getCaps().oculusMultiview)&&o.useMultiview};this._vrDisplay.requestPresent([{source:this.getRenderingCanvas(),attributes:i,...i}]).then(e).catch(t)}};q.prototype._onVRFullScreenTriggered=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting){this._oldSize=new oa(this.getRenderWidth(),this.getRenderHeight()),this._oldHardwareScaleFactor=this.getHardwareScalingLevel();const o=this._vrDisplay.getEyeParameters("left");this.setHardwareScalingLevel(1),this.setSize(o.renderWidth*2,o.renderHeight)}else this.setHardwareScalingLevel(this._oldHardwareScaleFactor),this.setSize(this._oldSize.width,this._oldSize.height)};q.prototype.disableVR=function(){this._vrDisplay&&this._vrDisplay.isPresenting&&this._vrDisplay.exitPresent().then(()=>this._onVRFullScreenTriggered()).catch(()=>this._onVRFullScreenTriggered()),Ar()&&(window.removeEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted),window.removeEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted),this._onVrDisplayConnect&&(window.removeEventListener("vrdisplayconnect",this._onVrDisplayConnect),this._onVrDisplayDisconnect&&window.removeEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),this._onVrDisplayPresentChange&&window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),this._onVrDisplayConnect=null,this._onVrDisplayDisconnect=null))};q.prototype._connectVREvents=function(o,e){if(this._onVRDisplayPointerRestricted=()=>{o&&o.requestPointerLock()},this._onVRDisplayPointerUnrestricted=()=>{if(!e){const t=this.getHostWindow();t.document&&t.document.exitPointerLock&&t.document.exitPointerLock();return}e.exitPointerLock&&e.exitPointerLock()},Ar()){const t=this.getHostWindow();t.addEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted,!1),t.addEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted,!1)}};q.prototype._submitVRFrame=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting)try{this._vrDisplay.submitFrame()}catch(o){J.Warn("webVR submitFrame has had an unexpected failure: "+o)}};q.prototype.isVRPresenting=function(){return this._vrDisplay&&this._vrDisplay.isPresenting};q.prototype._requestVRFrame=function(){this._frameHandler=q.QueueNewFrame(this._boundRenderFunction,this._vrDisplay)};ii.AddNodeConstructor("WebVRFreeCamera",(o,e)=>()=>new mm(o,x.Zero(),e));ii.AddNodeConstructor("WebVRGamepadCamera",(o,e)=>()=>new mm(o,x.Zero(),e));class mm extends Qs{constructor(e,t,i,r={}){super(e,t,i),this._webVROptions=r,this._vrDevice=null,this.rawPose=null,this._specsVersion="1.1",this._attached=!1,this._descendants=[],this._deviceRoomPosition=x.Zero(),this._deviceRoomRotationQuaternion=oe.Identity(),this._standingMatrix=null,this.devicePosition=x.Zero(),this.deviceRotationQuaternion=oe.Identity(),this.deviceScaleFactor=1,this._deviceToWorld=H.Identity(),this._worldToDevice=H.Identity(),this.controllers=[],this.onControllersAttachedObservable=new Q,this.onControllerMeshLoadedObservable=new Q,this.onPoseUpdatedFromDeviceObservable=new Q,this._poseSet=!1,this.rigParenting=!0,this._defaultHeight=void 0,this._setRigMode=Py.bind(null,this),this._detachIfAttached=()=>{const n=this.getEngine().getVRDevice();n&&!n.isPresenting&&this.detachControl()},this._workingVector=x.Zero(),this._oneVector=x.One(),this._workingMatrix=H.Identity(),this._tmpMatrix=new H,this._cache.position=x.Zero(),r.defaultHeight&&(this._defaultHeight=r.defaultHeight,this.position.y=this._defaultHeight),this.minZ=.1,arguments.length===5&&(this._webVROptions=arguments[4]),this._webVROptions.trackPosition==null&&(this._webVROptions.trackPosition=!0),this._webVROptions.controllerMeshes==null&&(this._webVROptions.controllerMeshes=!0),this._webVROptions.defaultLightingOnControllers==null&&(this._webVROptions.defaultLightingOnControllers=!0),this.rotationQuaternion=new oe,this._webVROptions&&this._webVROptions.positionScale&&(this.deviceScaleFactor=this._webVROptions.positionScale);const s=this.getEngine();this._onVREnabled=n=>{n&&this.initControllers()},s.onVRRequestPresentComplete.add(this._onVREnabled),s.initWebVR().add(n=>{!n.vrDisplay||this._vrDevice===n.vrDisplay||(this._vrDevice=n.vrDisplay,this.setCameraRigMode(Ve.RIG_MODE_WEBVR,{parentCamera:this,vrDisplay:this._vrDevice,frameData:this._frameData,specs:this._specsVersion}),this._attached&&this.getEngine().enableVR(this._webVROptions))}),typeof VRFrameData<"u"&&(this._frameData=new VRFrameData),r.useMultiview&&(this.getScene().getEngine().getCaps().multiview?(this._useMultiviewToSingleView=!0,this._rigPostProcess=new kT("VRMultiviewToSingleview",this,1)):(X.Warn("Multiview is not supported, falling back to standard rendering"),this._useMultiviewToSingleView=!1)),this.getScene().onBeforeCameraRenderObservable.add(n=>{n.parent===this&&this.rigParenting&&(this._descendants=this.getDescendants(!0,a=>{const l=this.controllers.some(h=>h._mesh===a),c=this._rigCameras.indexOf(a)!==-1;return!l&&!c}),this._descendants.forEach(a=>{a.parent=n}))}),this.getScene().onAfterCameraRenderObservable.add(n=>{n.parent===this&&this.rigParenting&&this._descendants.forEach(a=>{a.parent=this})})}deviceDistanceToRoomGround(){return this._standingMatrix?(this._standingMatrix.getTranslationToRef(this._workingVector),this._deviceRoomPosition.y+this._workingVector.y):this._defaultHeight||0}useStandingMatrix(e=t=>{}){this.getEngine().initWebVRAsync().then(t=>{!t.vrDisplay||!t.vrDisplay.stageParameters||!t.vrDisplay.stageParameters.sittingToStandingTransform||!this._webVROptions.trackPosition?e(!1):(this._standingMatrix=new H,H.FromFloat32ArrayToRefScaled(t.vrDisplay.stageParameters.sittingToStandingTransform,0,1,this._standingMatrix),this.getScene().useRightHandedSystem||this._standingMatrix&&this._standingMatrix.toggleModelMatrixHandInPlace(),e(!0))})}useStandingMatrixAsync(){return new Promise(e=>{this.useStandingMatrix(t=>{e(t)})})}dispose(){this._detachIfAttached(),this.getEngine().onVRRequestPresentComplete.removeCallback(this._onVREnabled),this._updateCacheWhenTrackingDisabledObserver&&this._scene.onBeforeRenderObservable.remove(this._updateCacheWhenTrackingDisabledObserver),super.dispose()}getControllerByName(e){for(const t of this.controllers)if(t.hand===e)return t;return null}get leftController(){return this._leftController||(this._leftController=this.getControllerByName("left")),this._leftController}get rightController(){return this._rightController||(this._rightController=this.getControllerByName("right")),this._rightController}getForwardRay(e=100){return this.leftCamera?super.getForwardRay(e,this.leftCamera.getWorldMatrix(),this.leftCamera.globalPosition):super.getForwardRay(e)}_checkInputs(){this._vrDevice&&this._vrDevice.isPresenting&&(this._vrDevice.getFrameData(this._frameData),this.updateFromDevice(this._frameData.pose)),super._checkInputs()}updateFromDevice(e){e&&e.orientation&&e.orientation.length===4&&(this.rawPose=e,this._deviceRoomRotationQuaternion.copyFromFloats(e.orientation[0],e.orientation[1],-e.orientation[2],-e.orientation[3]),this.getScene().useRightHandedSystem&&(this._deviceRoomRotationQuaternion.z*=-1,this._deviceRoomRotationQuaternion.w*=-1),this._webVROptions.trackPosition&&this.rawPose.position&&(this._deviceRoomPosition.copyFromFloats(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2]),this.getScene().useRightHandedSystem&&(this._deviceRoomPosition.z*=-1)),this._poseSet=!0)}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),super.attachControl(e),this._attached=!0,e=Ve.ForceAttachControlToAlwaysPreventDefault?!1:e,this._vrDevice&&this.getEngine().enableVR(this._webVROptions);const t=this._scene.getEngine().getHostWindow();t&&t.addEventListener("vrdisplaypresentchange",this._detachIfAttached)}detachControl(){this.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),super.detachControl(),this._attached=!1,this.getEngine().disableVR(),window.removeEventListener("vrdisplaypresentchange",this._detachIfAttached)}getClassName(){return"WebVRFreeCamera"}resetToCurrentRotation(){this._vrDevice.resetPose()}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];e.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion),t.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion),e.position.copyFrom(this._deviceRoomPosition),t.position.copyFrom(this._deviceRoomPosition)}_correctPositionIfNotTrackPosition(e,t=!1){this.rawPose&&this.rawPose.position&&!this._webVROptions.trackPosition&&(H.TranslationToRef(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2],this._tmpMatrix),t||this._tmpMatrix.invert(),this._tmpMatrix.multiplyToRef(e,e))}_updateCache(e){(!this.rotationQuaternion.equals(this._cache.rotationQuaternion)||!this.position.equals(this._cache.position))&&(this._updateCacheCalled||(this._updateCacheCalled=!0,this.update()),this.rotationQuaternion.toRotationMatrix(this._workingMatrix),x.TransformCoordinatesToRef(this._deviceRoomPosition,this._workingMatrix,this._workingVector),this.devicePosition.subtractToRef(this._workingVector,this._workingVector),H.ComposeToRef(this._oneVector,this.rotationQuaternion,this._workingVector,this._deviceToWorld),this._deviceToWorld.getTranslationToRef(this._workingVector),this._workingVector.addInPlace(this.position),this._workingVector.subtractInPlace(this._cache.position),this._deviceToWorld.setTranslation(this._workingVector),this._deviceToWorld.invertToRef(this._worldToDevice),this.controllers.forEach(t=>{t._deviceToWorld.copyFrom(this._deviceToWorld),this._correctPositionIfNotTrackPosition(t._deviceToWorld),t.update()})),e||super._updateCache(),this._updateCacheCalled=!1}_computeDevicePosition(){x.TransformCoordinatesToRef(this._deviceRoomPosition,this._deviceToWorld,this.devicePosition)}update(){this._computeDevicePosition(),H.FromQuaternionToRef(this._deviceRoomRotationQuaternion,this._workingMatrix),this._workingMatrix.multiplyToRef(this._deviceToWorld,this._workingMatrix),oe.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion),this._poseSet&&this.onPoseUpdatedFromDeviceObservable.notifyObservers(null),super.update()}_getViewMatrix(){return H.Identity()}_getWebVRViewMatrix(){const e=this._cameraRigParams.parentCamera;e._updateCache();const t=this._cameraRigParams.left?this._cameraRigParams.frameData.leftViewMatrix:this._cameraRigParams.frameData.rightViewMatrix;return H.FromArrayToRef(t,0,this._webvrViewMatrix),this.getScene().useRightHandedSystem||this._webvrViewMatrix.toggleModelMatrixHandInPlace(),this._webvrViewMatrix.getRotationMatrixToRef(this._cameraRotationMatrix),x.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),e.deviceScaleFactor!==1&&(this._webvrViewMatrix.invert(),e.deviceScaleFactor&&(this._webvrViewMatrix.multiplyAtIndex(12,e.deviceScaleFactor),this._webvrViewMatrix.multiplyAtIndex(13,e.deviceScaleFactor),this._webvrViewMatrix.multiplyAtIndex(14,e.deviceScaleFactor)),this._webvrViewMatrix.invert()),e._correctPositionIfNotTrackPosition(this._webvrViewMatrix,!0),e._worldToDevice.multiplyToRef(this._webvrViewMatrix,this._webvrViewMatrix),this._workingMatrix=this._workingMatrix||H.Identity(),this._webvrViewMatrix.invertToRef(this._workingMatrix),this._workingMatrix.multiplyToRef(e.getWorldMatrix(),this._workingMatrix),this._workingMatrix.getTranslationToRef(this._globalPosition),this._markSyncedWithParent(),this._webvrViewMatrix}_getWebVRProjectionMatrix(){const e=this.parent;e._vrDevice.depthNear=e.minZ,e._vrDevice.depthFar=e.maxZ;const t=this._cameraRigParams.left?this._cameraRigParams.frameData.leftProjectionMatrix:this._cameraRigParams.frameData.rightProjectionMatrix;return H.FromArrayToRef(t,0,this._projectionMatrix),this.getScene().useRightHandedSystem||this._projectionMatrix.toggleProjectionMatrixHandInPlace(),this._projectionMatrix}initControllers(){this.controllers.length=0;const e=this.getScene().gamepadManager;this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{if(t.type===Tr.POSE_ENABLED){const i=t;i.defaultModel&&i.defaultModel.setEnabled(!1),i.hand==="right"&&(this._rightController=null),i.hand==="left"&&(this._leftController=null);const r=this.controllers.indexOf(i);r!==-1&&this.controllers.splice(r,1)}}),this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{if(t.type===Tr.POSE_ENABLED){const i=t;if(this._webVROptions.trackPosition||(i._disableTrackPosition(new x(i.hand=="left"?-.15:.15,-.5,.25)),this._updateCacheWhenTrackingDisabledObserver||(this._updateCacheWhenTrackingDisabledObserver=this._scene.onBeforeRenderObservable.add(()=>{this._updateCache()}))),i.deviceScaleFactor=this.deviceScaleFactor,i._deviceToWorld.copyFrom(this._deviceToWorld),this._correctPositionIfNotTrackPosition(i._deviceToWorld),this._webVROptions.controllerMeshes&&(i.defaultModel?i.defaultModel.setEnabled(!0):i.initControllerMesh(this.getScene(),r=>{if(r.scaling.scaleInPlace(this.deviceScaleFactor),this.onControllerMeshLoadedObservable.notifyObservers(i),this._webVROptions.defaultLightingOnControllers){this._lightOnControllers||(this._lightOnControllers=new kl("vrControllersLight",new x(0,1,0),this.getScene()));const s=function(n,a){const l=n.getChildren();l&&l.length!==0&&l.forEach(c=>{a.includedOnlyMeshes.push(c),s(c,a)})};this._lightOnControllers.includedOnlyMeshes.push(r),s(r,this._lightOnControllers)}})),i.attachToPoseControlledCamera(this),this.controllers.indexOf(i)===-1){this.controllers.push(i);let r=!1;for(let s=0;s<this.controllers.length;s++)this.controllers[s].controllerType===To.VIVE&&(r?this.controllers[s].hand="right":(r=!0,this.controllers[s].hand="left"));this.controllers.length>=2&&this.onControllersAttachedObservable.notifyObservers(this.controllers)}}})}}class vc extends xu{onButtonStateChange(e){this._onButtonStateChange=e}get defaultModel(){return this._defaultModel}constructor(e){super(e),this.onTriggerStateChangedObservable=new Q,this.onMainButtonStateChangedObservable=new Q,this.onSecondaryButtonStateChangedObservable=new Q,this.onPadStateChangedObservable=new Q,this.onPadValuesChangedObservable=new Q,this.pad={x:0,y:0},this._changes={pressChanged:!1,touchChanged:!1,valueChanged:!1,changed:!1},this._buttons=new Array(e.buttons.length),this.hand=e.hand}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._setButtonValue(this.browserGamepad.buttons[e],this._buttons[e],e);(this.leftStick.x!==this.pad.x||this.leftStick.y!==this.pad.y)&&(this.pad.x=this.leftStick.x,this.pad.y=this.leftStick.y,this.onPadValuesChangedObservable.notifyObservers(this.pad))}_setButtonValue(e,t,i){if(e||(e={pressed:!1,touched:!1,value:0}),!t){this._buttons[i]={pressed:e.pressed,touched:e.touched,value:e.value};return}this._checkChanges(e,t),this._changes.changed&&(this._onButtonStateChange&&this._onButtonStateChange(this.index,i,e),this._handleButtonChange(i,e,this._changes)),this._buttons[i].pressed=e.pressed,this._buttons[i].touched=e.touched,this._buttons[i].value=e.value<1e-8?0:e.value}_checkChanges(e,t){return this._changes.pressChanged=e.pressed!==t.pressed,this._changes.touchChanged=e.touched!==t.touched,this._changes.valueChanged=e.value!==t.value,this._changes.changed=this._changes.pressChanged||this._changes.touchChanged||this._changes.valueChanged,this._changes}dispose(){super.dispose(),this._defaultModel=null,this.onTriggerStateChangedObservable.clear(),this.onMainButtonStateChangedObservable.clear(),this.onSecondaryButtonStateChangedObservable.clear(),this.onPadStateChangedObservable.clear(),this.onPadValuesChangedObservable.clear()}}class Xd{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,i,r,s){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&t.prePassRenderer.getIndex(2)!==-1){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=r.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());const n=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==n.frameId&&(this._lastUpdateFrameId=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=r.clone()}}}class Me{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,q.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}}Me._DiffuseTextureEnabled=!0;Me._DetailTextureEnabled=!0;Me._AmbientTextureEnabled=!0;Me._OpacityTextureEnabled=!0;Me._ReflectionTextureEnabled=!0;Me._EmissiveTextureEnabled=!0;Me._SpecularTextureEnabled=!0;Me._BumpTextureEnabled=!0;Me._LightmapTextureEnabled=!0;Me._RefractionTextureEnabled=!0;Me._ColorGradingTextureEnabled=!0;Me._FresnelEnabled=!0;Me._ClearCoatTextureEnabled=!0;Me._ClearCoatBumpTextureEnabled=!0;Me._ClearCoatTintTextureEnabled=!0;Me._SheenTextureEnabled=!0;Me._AnisotropicTextureEnabled=!0;Me._ThicknessTextureEnabled=!0;Me._RefractionIntensityTextureEnabled=!0;Me._TranslucencyIntensityTextureEnabled=!0;Me._IridescenceTextureEnabled=!0;const My="defaultFragmentDeclaration",Oy=`uniform vec4 vEyePosition;
uniform vec4 vDiffuseColor;
#ifdef SPECULARTERM
uniform vec4 vSpecularColor;
#endif
uniform vec3 vEmissiveColor;
uniform vec3 vAmbientColor;
uniform float visibility;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY 
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#ifdef ALPHATEST
uniform float alphaCutOff;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFRACTION
uniform vec4 vRefractionInfos;
#ifndef REFRACTIONMAP_3D
uniform mat4 refractionMatrix;
#endif
#ifdef REFRACTIONFRESNEL
uniform vec4 refractionLeftColor;
uniform vec4 refractionRightColor;
#endif
#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)
uniform vec3 vRefractionPosition;
uniform vec3 vRefractionSize; 
#endif
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
#endif
#ifdef DIFFUSEFRESNEL
uniform vec4 diffuseLeftColor;
uniform vec4 diffuseRightColor;
#endif
#ifdef OPACITYFRESNEL
uniform vec4 opacityParts;
#endif
#ifdef EMISSIVEFRESNEL
uniform vec4 emissiveLeftColor;
uniform vec4 emissiveRightColor;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)
uniform mat4 reflectionMatrix;
#endif
#ifndef REFLECTIONMAP_SKYBOX
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;
uniform vec3 vReflectionSize; 
#endif
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 reflectionLeftColor;
uniform vec4 reflectionRightColor;
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;te.IncludesShadersStore[My]=Oy;const Dy="sceneUboDeclaration",Ny=`layout(std140,column_major) uniform;
uniform Scene {
mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
mat4 view;
mat4 projection;
vec4 vEyePosition;
};
`;te.IncludesShadersStore[Dy]=Ny;const wy="meshUboDeclaration",Fy=`#ifdef WEBGL2
uniform mat4 world;
uniform float visibility;
#else
layout(std140,column_major) uniform;
uniform Mesh
{
mat4 world;
float visibility;
};
#endif
#define WORLD_UBO
`;te.IncludesShadersStore[wy]=Fy;const Ly="defaultUboDeclaration",By=`layout(std140,column_major) uniform;
uniform Material
{
vec4 diffuseLeftColor;
vec4 diffuseRightColor;
vec4 opacityParts;
vec4 reflectionLeftColor;
vec4 reflectionRightColor;
vec4 refractionLeftColor;
vec4 refractionRightColor;
vec4 emissiveLeftColor;
vec4 emissiveRightColor;
vec2 vDiffuseInfos;
vec2 vAmbientInfos;
vec2 vOpacityInfos;
vec2 vReflectionInfos;
vec3 vReflectionPosition;
vec3 vReflectionSize;
vec2 vEmissiveInfos;
vec2 vLightmapInfos;
vec2 vSpecularInfos;
vec3 vBumpInfos;
mat4 diffuseMatrix;
mat4 ambientMatrix;
mat4 opacityMatrix;
mat4 reflectionMatrix;
mat4 emissiveMatrix;
mat4 lightmapMatrix;
mat4 specularMatrix;
mat4 bumpMatrix;
vec2 vTangentSpaceParams;
float pointSize;
float alphaCutOff;
mat4 refractionMatrix;
vec4 vRefractionInfos;
vec3 vRefractionPosition;
vec3 vRefractionSize;
vec4 vSpecularColor;
vec3 vEmissiveColor;
vec4 vDiffuseColor;
vec3 vAmbientColor;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;te.IncludesShadersStore[Ly]=By;const Uy="prePassDeclaration",Vy=`#ifdef PREPASS
#extension GL_EXT_draw_buffers : require
layout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;
#ifdef PREPASS_DEPTH
varying highp vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
varying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;
#endif
#endif
`;te.IncludesShadersStore[Uy]=Vy;const ky="oitDeclaration",Gy=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#extension GL_EXT_draw_buffers : require
layout(location=0) out vec2 depth; 
layout(location=1) out vec4 frontColor;
layout(location=2) out vec4 backColor;
#define MAX_DEPTH 99999.0
highp vec4 gl_FragColor;
uniform sampler2D oitDepthSampler;
uniform sampler2D oitFrontColorSampler;
#endif
`;te.IncludesShadersStore[ky]=Gy;const zy="mainUVVaryingDeclaration",Hy=`#ifdef MAINUV{X}
varying vec2 vMainUV{X};
#endif
`;te.IncludesShadersStore[zy]=Hy;const Wy="helperFunctions",Xy=`const float PI=3.1415926535897932384626433832795;
const float HALF_MIN=5.96046448e-08; 
const float LinearEncodePowerApprox=2.2;
const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;
const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);
const float Epsilon=0.0000001;
#define saturate(x) clamp(x,0.0,1.0)
#define absEps(x) abs(x)+Epsilon
#define maxEps(x) max(x,Epsilon)
#define saturateEps(x) clamp(x,Epsilon,1.0)
mat3 transposeMat3(mat3 inMatrix) {
vec3 i0=inMatrix[0];
vec3 i1=inMatrix[1];
vec3 i2=inMatrix[2];
mat3 outMatrix=mat3(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);
return outMatrix;
}
mat3 inverseMat3(mat3 inMatrix) {
float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];
float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];
float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];
float b01=a22*a11-a12*a21;
float b11=-a22*a10+a12*a20;
float b21=a21*a10-a11*a20;
float det=a00*b01+a01*b11+a02*b21;
return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),
b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),
b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;
}
#if USE_EXACT_SRGB_CONVERSIONS
vec3 toLinearSpaceExact(vec3 color)
{
vec3 nearZeroSection=0.0773993808*color;
vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));
#else
return
vec3(
color.r<=0.04045 ? nearZeroSection.r : remainingSection.r,
color.g<=0.04045 ? nearZeroSection.g : remainingSection.g,
color.b<=0.04045 ? nearZeroSection.b : remainingSection.b);
#endif
}
vec3 toGammaSpaceExact(vec3 color)
{
vec3 nearZeroSection=12.92*color;
vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));
#else
return
vec3(
color.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,
color.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,
color.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);
#endif
}
#endif
float toLinearSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=0.0773993808*color;
float remainingSection=pow(0.947867299*(color+0.055),2.4);
return color<=0.04045 ? nearZeroSection : remainingSection;
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
vec3 toLinearSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3(LinearEncodePowerApprox));
#endif
}
vec4 toLinearSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);
#endif
}
float toGammaSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=12.92*color;
float remainingSection=1.055*pow(color,0.41666)-0.055;
return color<=0.0031308 ? nearZeroSection : remainingSection;
#else
return pow(color,GammaEncodePowerApprox);
#endif
}
vec3 toGammaSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3(GammaEncodePowerApprox));
#endif
}
vec4 toGammaSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);
#endif
}
float square(float value)
{
return value*value;
}
vec3 square(vec3 value)
{
return value*value;
}
float pow5(float value) {
float sq=value*value;
return sq*sq*value;
}
float getLuminance(vec3 color)
{
return clamp(dot(color,LuminanceEncodeApprox),0.,1.);
}
float getRand(vec2 seed) {
return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);
}
float dither(vec2 seed,float varianceAmount) {
float rand=getRand(seed);
float normVariance=varianceAmount/255.0;
float dither=mix(-normVariance,normVariance,rand);
return dither;
}
const float rgbdMaxRange=255.0;
vec4 toRGBD(vec3 color) {
float maxRGB=maxEps(max(color.r,max(color.g,color.b)));
float D =max(rgbdMaxRange/maxRGB,1.);
D =clamp(floor(D)/255.0,0.,1.);
vec3 rgb=color.rgb*D;
rgb=toGammaSpace(rgb);
return vec4(clamp(rgb,0.,1.),D); 
}
vec3 fromRGBD(vec4 rgbd) {
rgbd.rgb=toLinearSpace(rgbd.rgb);
return rgbd.rgb/rgbd.a;
}
vec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {
vec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;
vec3 halfSize=cubeSize*0.5;
vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;
vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;
vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);
float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);
vec3 intersectPositionWS=vertexPos+origVec*distance;
return intersectPositionWS-cubePos;
}
`;te.IncludesShadersStore[Wy]=Xy;const $y="lightFragmentDeclaration",Yy=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};
uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float cascadeBlendFactor{X};
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
uniform highp sampler2DArray depthSampler{X};
uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);
vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X};
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};
uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};
uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};
uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};
uniform sampler2D projectionLightSampler{X};
#endif
#endif
`;te.IncludesShadersStore[$y]=Yy;const jy="lightUboDeclaration",Ky=`#ifdef LIGHT{X}
uniform Light{X}
{
vec4 vLightData;
vec4 vLightDiffuse;
vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;
vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;
vec2 depthValues;
} light{X};
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};
uniform sampler2D projectionLightSampler{X};
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float cascadeBlendFactor{X};
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
uniform highp sampler2DArray depthSampler{X};
uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);
vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X}; 
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};
uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;te.IncludesShadersStore[jy]=Ky;const qy="lightsFragmentFunctions",Qy=`struct lightingInfo
{
vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef NDOTL
float ndl;
#endif
};
lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {
lightingInfo result;
vec3 lightVectorW;
float attenuation=1.0;
if (lightData.w==0.)
{
vec3 direction=lightData.xyz-vPositionW;
attenuation=max(0.,1.0-length(direction)/range);
lightVectorW=normalize(direction);
}
else
{
lightVectorW=normalize(-lightData.xyz);
}
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor*attenuation;
#endif
return result;
}
lightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {
lightingInfo result;
vec3 direction=lightData.xyz-vPositionW;
vec3 lightVectorW=normalize(direction);
float attenuation=max(0.,1.0-length(direction)/range);
float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));
if (cosAngle>=lightDirection.w)
{
cosAngle=max(0.,pow(cosAngle,lightData.w));
attenuation*=cosAngle;
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor*attenuation;
#endif
return result;
}
result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;
}
lightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {
lightingInfo result;
float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightData.xyz);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor;
#endif
return result;
}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){
vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);
strq/=strq.w;
vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;
return textureColor;
}`;te.IncludesShadersStore[qy]=Qy;const Zy="shadowsFragmentFunctions",Jy=`#ifdef SHADOWS
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
#ifndef SHADOWFLOAT
float unpack(vec4 color)
{
const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);
return dot(color,bit_shift);
}
#endif
float computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)
{
float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));
return mix(value,1.0,mask);
}
#define inline
float computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
depth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadow=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadow=textureCube(shadowSampler,directionToLight).x;
#endif
return depth>shadow ? darkness : 1.0;
}
#define inline
float computeShadowWithPoissonSamplingCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
depth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
float visibility=1.;
vec3 poissonDisk[4];
poissonDisk[0]=vec3(-1.0,1.0,-1.0);
poissonDisk[1]=vec3(1.0,-1.0,-1.0);
poissonDisk[2]=vec3(-1.0,-1.0,-1.0);
poissonDisk[3]=vec3(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;
#else
if (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;
#endif
return min(1.0,visibility+darkness);
}
#define inline
float computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); 
return esm;
}
#define inline
float computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);
return esm;
}
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define inline
float computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
vec3 uvLayer=vec3(uv.x,uv.y,layer);
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uvLayer));
#else
float shadow=texture2D(shadowSampler,uvLayer).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;
}
#endif
#define inline
float computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;
}
}
#define inline
float computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
float visibility=1.;
vec2 poissonDisk[4];
poissonDisk[0]=vec2(-0.94201624,-0.39906216);
poissonDisk[1]=vec2(0.94558609,-0.76890725);
poissonDisk[2]=vec2(-0.094184101,-0.92938870);
poissonDisk[3]=vec2(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
#else
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);
return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);
return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);
}
}
#ifdef IS_NDC_HALF_ZRANGE
#define ZINCLIP clipSpace.z
#else
#define ZINCLIP uvDepth.z
#endif
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define GREATEST_LESS_THAN_ONE 0.99999994
#define inline
float computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);
float shadow=texture2D(shadowSampler,uvDepthLayer);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;
vec2 uvw1=1.+2.*st;
vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;
vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));
shadow=shadow/16.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;
vec2 uvw1=vec2(7.);
vec2 uvw2=1.+3.*st;
vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;
vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));
shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));
shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));
shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));
shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));
shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));
shadow=shadow/144.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;
vec2 uvw1=1.+2.*st;
vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;
vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);
shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);
shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);
shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);
shadow=shadow/16.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;
vec2 uvw1=vec2(7.);
vec2 uvw2=1.+3.*st;
vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;
vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);
shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);
shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);
shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);
shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);
shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);
shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);
shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);
shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);
shadow=shadow/144.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
const vec3 PoissonSamplers32[64]=vec3[64](
vec3(0.06407013,0.05409927,0.),
vec3(0.7366577,0.5789394,0.),
vec3(-0.6270542,-0.5320278,0.),
vec3(-0.4096107,0.8411095,0.),
vec3(0.6849564,-0.4990818,0.),
vec3(-0.874181,-0.04579735,0.),
vec3(0.9989998,0.0009880066,0.),
vec3(-0.004920578,-0.9151649,0.),
vec3(0.1805763,0.9747483,0.),
vec3(-0.2138451,0.2635818,0.),
vec3(0.109845,0.3884785,0.),
vec3(0.06876755,-0.3581074,0.),
vec3(0.374073,-0.7661266,0.),
vec3(0.3079132,-0.1216763,0.),
vec3(-0.3794335,-0.8271583,0.),
vec3(-0.203878,-0.07715034,0.),
vec3(0.5912697,0.1469799,0.),
vec3(-0.88069,0.3031784,0.),
vec3(0.5040108,0.8283722,0.),
vec3(-0.5844124,0.5494877,0.),
vec3(0.6017799,-0.1726654,0.),
vec3(-0.5554981,0.1559997,0.),
vec3(-0.3016369,-0.3900928,0.),
vec3(-0.5550632,-0.1723762,0.),
vec3(0.925029,0.2995041,0.),
vec3(-0.2473137,0.5538505,0.),
vec3(0.9183037,-0.2862392,0.),
vec3(0.2469421,0.6718712,0.),
vec3(0.3916397,-0.4328209,0.),
vec3(-0.03576927,-0.6220032,0.),
vec3(-0.04661255,0.7995201,0.),
vec3(0.4402924,0.3640312,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.)
);
const vec3 PoissonSamplers64[64]=vec3[64](
vec3(-0.613392,0.617481,0.),
vec3(0.170019,-0.040254,0.),
vec3(-0.299417,0.791925,0.),
vec3(0.645680,0.493210,0.),
vec3(-0.651784,0.717887,0.),
vec3(0.421003,0.027070,0.),
vec3(-0.817194,-0.271096,0.),
vec3(-0.705374,-0.668203,0.),
vec3(0.977050,-0.108615,0.),
vec3(0.063326,0.142369,0.),
vec3(0.203528,0.214331,0.),
vec3(-0.667531,0.326090,0.),
vec3(-0.098422,-0.295755,0.),
vec3(-0.885922,0.215369,0.),
vec3(0.566637,0.605213,0.),
vec3(0.039766,-0.396100,0.),
vec3(0.751946,0.453352,0.),
vec3(0.078707,-0.715323,0.),
vec3(-0.075838,-0.529344,0.),
vec3(0.724479,-0.580798,0.),
vec3(0.222999,-0.215125,0.),
vec3(-0.467574,-0.405438,0.),
vec3(-0.248268,-0.814753,0.),
vec3(0.354411,-0.887570,0.),
vec3(0.175817,0.382366,0.),
vec3(0.487472,-0.063082,0.),
vec3(-0.084078,0.898312,0.),
vec3(0.488876,-0.783441,0.),
vec3(0.470016,0.217933,0.),
vec3(-0.696890,-0.549791,0.),
vec3(-0.149693,0.605762,0.),
vec3(0.034211,0.979980,0.),
vec3(0.503098,-0.308878,0.),
vec3(-0.016205,-0.872921,0.),
vec3(0.385784,-0.393902,0.),
vec3(-0.146886,-0.859249,0.),
vec3(0.643361,0.164098,0.),
vec3(0.634388,-0.049471,0.),
vec3(-0.688894,0.007843,0.),
vec3(0.464034,-0.188818,0.),
vec3(-0.440840,0.137486,0.),
vec3(0.364483,0.511704,0.),
vec3(0.034028,0.325968,0.),
vec3(0.099094,-0.308023,0.),
vec3(0.693960,-0.366253,0.),
vec3(0.678884,-0.204688,0.),
vec3(0.001801,0.780328,0.),
vec3(0.145177,-0.898984,0.),
vec3(0.062655,-0.611866,0.),
vec3(0.315226,-0.604297,0.),
vec3(-0.780145,0.486251,0.),
vec3(-0.371868,0.882138,0.),
vec3(0.200476,0.494430,0.),
vec3(-0.494552,-0.711051,0.),
vec3(0.612476,0.705252,0.),
vec3(-0.578845,-0.768792,0.),
vec3(-0.772454,-0.090976,0.),
vec3(0.504440,0.372295,0.),
vec3(0.155736,0.065157,0.),
vec3(0.391522,0.849605,0.),
vec3(-0.620106,-0.328104,0.),
vec3(0.789239,-0.419965,0.),
vec3(-0.545396,0.538133,0.),
vec3(-0.178564,-0.596057,0.)
);
#define inline
float computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);
float blockerDepth=0.0;
float sumBlockerDepth=0.0;
float numBlocker=0.0;
for (int i=0; i<searchTapCount; i ++) {
blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;
if (blockerDepth<depthMetric) {
sumBlockerDepth+=blockerDepth;
numBlocker++;
}
}
float avgBlockerDepth=sumBlockerDepth/numBlocker;
float AAOffset=shadowMapSizeInverse*10.;
float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);
vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);
float random=getRand(vPositionFromLight.xy);
float rotationAngle=random*3.1415926;
vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));
float shadow=0.;
for (int i=0; i<pcfTapCount; i++) {
vec4 offset=vec4(poissonSamplers[i],0.);
offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);
shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);
}
shadow/=float(pcfTapCount);
shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));
shadow=mix(darkness,1.,shadow);
if (numBlocker<1.0) {
return 1.0;
}
else
{
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
float blockerDepth=0.0;
float sumBlockerDepth=0.0;
float numBlocker=0.0;
for (int i=0; i<searchTapCount; i ++) {
blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;
if (blockerDepth<depthMetric) {
sumBlockerDepth+=blockerDepth;
numBlocker++;
}
}
if (numBlocker<1.0) {
return 1.0;
}
else
{
float avgBlockerDepth=sumBlockerDepth/numBlocker;
float AAOffset=shadowMapSizeInverse*10.;
float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);
float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;
float random=getRand(vPositionFromLight.xy);
float rotationAngle=random*3.1415926;
vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));
float shadow=0.;
for (int i=0; i<pcfTapCount; i++) {
vec3 offset=poissonSamplers[i];
offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);
shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);
}
shadow/=float(pcfTapCount);
shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
}
#define inline
float computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);
}
#define inline
float computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);
}
#define inline
float computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);
}
#define inline
float computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#define inline
float computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#define inline
float computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#endif
#endif
`;te.IncludesShadersStore[Zy]=Jy;const eC="samplerFragmentDeclaration",tC=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
uniform sampler2D _SAMPLERNAME_Sampler;
#endif
`;te.IncludesShadersStore[eC]=tC;const iC="fresnelFunction",rC=`#ifdef FRESNEL
float computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)
{
float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);
return clamp(fresnelTerm,0.,1.);
}
#endif
`;te.IncludesShadersStore[iC]=rC;const sC="reflectionFunction",nC=`vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{
float lon=atan(direction.z,direction.x);
float lat=acos(direction.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(s,t,0); 
}
vec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{
float lon=atan(direction.z,direction.x);
float lat=acos(direction.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(1.0-s,t,0); 
}
vec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);
vec3 r=normalize(reflect(cameraToVertex,worldNormal));
r=vec3(reflectionMatrix*vec4(r,0));
float lon=atan(r.z,r.x);
float lat=acos(r.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(s,t,0);
}
vec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)
{
vec3 viewDir=normalize(vec3(view*worldPos));
vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));
vec3 r=reflect(viewDir,viewNormal);
r=vec3(reflectionMatrix*vec4(r,0));
r.z=r.z-1.0;
float m=2.0*length(r);
return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);
}
vec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 viewDir=worldPos.xyz-eyePosition;
vec3 coords=normalize(reflect(viewDir,worldNormal));
return vec3(reflectionMatrix*vec4(coords,1));
}
vec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 viewDir=normalize(worldPos.xyz-eyePosition);
vec3 coords=reflect(viewDir,worldNormal);
coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;
}
vec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)
{
vec3 viewDir=normalize(worldPos.xyz-eyePosition);
vec3 coords=reflect(viewDir,worldNormal);
coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);
coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;
}
vec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)
{
return vec3(reflectionMatrix*(view*worldPos));
}
vec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)
{
return vec3(reflectionMatrix*vec4(positionW,1.));
}
#ifdef REFLECTION
vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);
return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);
return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(vPositionUVW,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3(0,0,0);
#endif
}
#endif
`;te.IncludesShadersStore[sC]=nC;const aC="imageProcessingDeclaration",oC=`#ifdef EXPOSURE
uniform float exposureLinear;
#endif
#ifdef CONTRAST
uniform float contrast;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vec2 vInverseScreenSize;
#endif
#ifdef VIGNETTE
uniform vec4 vignetteSettings1;
uniform vec4 vignetteSettings2;
#endif
#ifdef COLORCURVES
uniform vec4 vCameraColorCurveNegative;
uniform vec4 vCameraColorCurveNeutral;
uniform vec4 vCameraColorCurvePositive;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
uniform highp sampler3D txColorTransform;
#else
uniform sampler2D txColorTransform;
#endif
uniform vec4 colorTransformSettings;
#endif
#ifdef DITHER
uniform float ditherIntensity;
#endif
`;te.IncludesShadersStore[aC]=oC;const lC="imageProcessingFunctions",cC=`#if defined(COLORGRADING) && !defined(COLORGRADING3D)
/** 
* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.
* sampler3dSetting.x=textureOffset (0.5/textureSize).
* sampler3dSetting.y=textureSize.
*/
#define inline
vec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)
{
float sliceSize=2.0*sampler3dSetting.x; 
#ifdef SAMPLER3DGREENDEPTH
float sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;
#else
float sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;
#endif
float sliceInteger=floor(sliceContinuous);
float sliceFraction=sliceContinuous-sliceInteger;
#ifdef SAMPLER3DGREENDEPTH
vec2 sliceUV=color.rb;
#else
vec2 sliceUV=color.rg;
#endif
sliceUV.x*=sliceSize;
sliceUV.x+=sliceInteger*sliceSize;
sliceUV=saturate(sliceUV);
vec4 slice0Color=texture2D(colorTransform,sliceUV);
sliceUV.x+=sliceSize;
sliceUV=saturate(sliceUV);
vec4 slice1Color=texture2D(colorTransform,sliceUV);
vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);
#ifdef SAMPLER3DBGRMAP
color.rgb=result.rgb;
#else
color.rgb=result.bgr;
#endif
return color;
}
#endif
#ifdef TONEMAPPING_ACES
const mat3 ACESInputMat=mat3(
vec3(0.59719,0.07600,0.02840),
vec3(0.35458,0.90834,0.13383),
vec3(0.04823,0.01566,0.83777)
);
const mat3 ACESOutputMat=mat3(
vec3( 1.60475,-0.10208,-0.00327),
vec3(-0.53108, 1.10813,-0.07276),
vec3(-0.07367,-0.00605, 1.07602)
);
vec3 RRTAndODTFit(vec3 v)
{
vec3 a=v*(v+0.0245786)-0.000090537;
vec3 b=v*(0.983729*v+0.4329510)+0.238081;
return a/b;
}
vec3 ACESFitted(vec3 color)
{
color=ACESInputMat*color;
color=RRTAndODTFit(color);
color=ACESOutputMat*color;
color=saturate(color);
return color;
}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
vec4 applyImageProcessing(vec4 result) {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
#ifdef EXPOSURE
result.rgb*=exposureLinear;
#endif
#ifdef VIGNETTE
vec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;
viewportXY=viewportXY*2.0-1.0;
vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);
float vignetteTerm=dot(vignetteXY1,vignetteXY1);
float vignette=pow(vignetteTerm,vignetteSettings2.w);
vec3 vignetteColor=vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
vec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);
result.rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
result.rgb=mix(vignetteColor,result.rgb,vignette);
#endif
#endif
#ifdef TONEMAPPING
#ifdef TONEMAPPING_ACES
result.rgb=ACESFitted(result.rgb);
#else
const float tonemappingCalibration=1.590579;
result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);
#endif
#endif
result.rgb=toGammaSpace(result.rgb);
result.rgb=saturate(result.rgb);
#ifdef CONTRAST
vec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);
if (contrast<1.0) {
result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);
} else {
result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);
}
#endif
#ifdef COLORGRADING
vec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;
#ifdef COLORGRADING3D
vec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;
#else
vec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;
#endif
result.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);
#endif
#ifdef COLORCURVES
float luma=getLuminance(result.rgb);
vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));
vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;
result.rgb*=colorCurve.rgb;
result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);
#endif
#ifdef DITHER
float rand=getRand(gl_FragCoord.xy*vInverseScreenSize);
float dither=mix(-ditherIntensity,ditherIntensity,rand);
result.rgb=saturate(result.rgb+vec3(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return result;
}`;te.IncludesShadersStore[lC]=cC;const hC="bumpFragmentMainFunctions",uC=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#if defined(WEBGL2) || defined(WEBGPU)
mat4 toNormalMatrix(mat4 wMatrix)
{
mat4 ret=inverse(wMatrix);
ret=transpose(ret);
ret[0][3]=0.;
ret[1][3]=0.;
ret[2][3]=0.;
ret[3]=vec4(0.,0.,0.,1.);
return ret;
}
#else
mat4 toNormalMatrix(mat4 m)
{
float
a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],
a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],
a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],
a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],
b00=a00*a11-a01*a10,
b01=a00*a12-a02*a10,
b02=a00*a13-a03*a10,
b03=a01*a12-a02*a11,
b04=a01*a13-a03*a11,
b05=a02*a13-a03*a12,
b06=a20*a31-a21*a30,
b07=a20*a32-a22*a30,
b08=a20*a33-a23*a30,
b09=a21*a32-a22*a31,
b10=a21*a33-a23*a31,
b11=a22*a33-a23*a32,
det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;
mat4 mi=mat4(
a11*b11-a12*b10+a13*b09,
a02*b10-a01*b11-a03*b09,
a31*b05-a32*b04+a33*b03,
a22*b04-a21*b05-a23*b03,
a12*b08-a10*b11-a13*b07,
a00*b11-a02*b08+a03*b07,
a32*b02-a30*b05-a33*b01,
a20*b05-a22*b02+a23*b01,
a10*b10-a11*b08+a13*b06,
a01*b08-a00*b10-a03*b06,
a30*b04-a31*b02+a33*b00,
a21*b02-a20*b04-a23*b00,
a11*b07-a10*b09-a12*b06,
a00*b09-a01*b07+a02*b06,
a31*b01-a30*b03-a32*b00,
a20*b03-a21*b01+a22*b00)/det;
return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);
}
#endif
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);
}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{
return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);
}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{
vec3 dp1=dFdx(p);
vec3 dp2=dFdy(p);
vec2 duv1=dFdx(uv);
vec2 duv2=dFdy(uv);
vec3 dp2perp=cross(dp2,normal);
vec3 dp1perp=cross(normal,dp1);
vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;
vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;
tangent*=tangentSpaceParams.x;
bitangent*=tangentSpaceParams.y;
float det=max(dot(tangent,tangent),dot(bitangent,bitangent));
float invmax=det==0.0 ? 0.0 : inversesqrt(det);
return mat3(tangent*invmax,bitangent*invmax,normal);
}
#endif
`;te.IncludesShadersStore[hC]=uC;const dC="bumpFragmentFunctions",fC=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const float minSamples=4.;
const float maxSamples=15.;
const int iMaxSamples=15;
vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {
float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;
parallaxLimit*=parallaxScale;
vec2 vOffsetDir=normalize(vViewDirCoT.xy);
vec2 vMaxOffset=vOffsetDir*parallaxLimit;
float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));
float stepSize=1.0/numSamples;
float currRayHeight=1.0;
vec2 vCurrOffset=vec2(0,0);
vec2 vLastOffset=vec2(0,0);
float lastSampledHeight=1.0;
float currSampledHeight=1.0;
bool keepWorking=true;
for (int i=0; i<iMaxSamples; i++)
{
currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;
if (!keepWorking)
{
}
else if (currSampledHeight>currRayHeight)
{
float delta1=currSampledHeight-currRayHeight;
float delta2=(currRayHeight+stepSize)-lastSampledHeight;
float ratio=delta1/(delta1+delta2);
vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;
keepWorking=false;
}
else
{
currRayHeight-=stepSize;
vLastOffset=vCurrOffset;
vCurrOffset+=stepSize*vMaxOffset;
lastSampledHeight=currSampledHeight;
}
}
return vCurrOffset;
}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{
float height=texture2D(bumpSampler,vBumpUV).w;
vec2 texCoordOffset=heightScale*viewDir.xy*height;
return -texCoordOffset;
}
#endif
`;te.IncludesShadersStore[dC]=fC;const _C="clipPlaneFragmentDeclaration",pC=`#ifdef CLIPPLANE
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
varying float fClipDistance6;
#endif
`;te.IncludesShadersStore[_C]=pC;const mC="logDepthDeclaration",gC=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;
varying float vFragmentDepth;
#endif
`;te.IncludesShadersStore[mC]=gC;const vC="fogFragmentDeclaration",xC=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;
uniform vec3 vFogColor;
varying vec3 vFogDistance;
float CalcFogFactor()
{
float fogCoeff=1.0;
float fogStart=vFogInfos.y;
float fogEnd=vFogInfos.z;
float fogDensity=vFogInfos.w;
float fogDistance=length(vFogDistance);
if (FOGMODE_LINEAR==vFogInfos.x)
{
fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);
}
else if (FOGMODE_EXP==vFogInfos.x)
{
fogCoeff=1.0/pow(E,fogDistance*fogDensity);
}
else if (FOGMODE_EXP2==vFogInfos.x)
{
fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);
}
return clamp(fogCoeff,0.0,1.0);
}
#endif
`;te.IncludesShadersStore[vC]=xC;const TC="clipPlaneFragment",EC=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fClipDistance>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE2
else if (fClipDistance2>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE3
else if (fClipDistance3>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE4
else if (fClipDistance4>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE5
else if (fClipDistance5>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE6
else if (fClipDistance6>0.0)
{
discard;
}
#endif
`;te.IncludesShadersStore[TC]=EC;const bC="bumpFragment",SC=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(BUMP)
float normalScale=vBumpInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(BUMP)
vec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;
mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;
mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;
mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);
vec2 detailNormalRG=detailColor.wy*2.0-1.0;
float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));
vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);
normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);
#else
vec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;
vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;
bumpNormal+=vec3(0.0,0.0,1.0);
detailNormal*=vec3(-1.0,-1.0,1.0);
vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;
normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;te.IncludesShadersStore[bC]=SC;const yC="depthPrePass",CC=`#ifdef DEPTHPREPASS
gl_FragColor=vec4(0.,0.,0.,1.0);
return;
#endif
`;te.IncludesShadersStore[yC]=CC;const AC="lightFragment",RC=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
#ifdef PBR
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#ifdef HEMILIGHT{X}
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);
#elif defined(SS_TRANSLUCENCY)
info.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#else
info.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);
info.diffuse*=absorption;
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) 
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;
#else
diff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {
index{X}=i;
break;
}
}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
float frustumLength=frustumLengths{X}[index{X}];
float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};
if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{
index{X}+=1;
float nextShadow=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;
shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else 
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;te.IncludesShadersStore[AC]=RC;const IC="logDepthFragment",PC=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;te.IncludesShadersStore[IC]=PC;const MC="fogFragment",OC=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;te.IncludesShadersStore[MC]=OC;const DC="oitFragment",NC=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
float fragDepth=gl_FragCoord.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
uint halfFloat=packHalf2x16(vec2(fragDepth));
vec2 full=unpackHalf2x16(halfFloat);
fragDepth=full.x;
#endif
ivec2 fragCoord=ivec2(gl_FragCoord.xy);
vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;
vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);
depth.rg=vec2(-MAX_DEPTH);
frontColor=lastFrontColor;
backColor=vec4(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
float furthestDepth=-lastDepth.x;
float nearestDepth=lastDepth.y;
#else
float nearestDepth=-lastDepth.x;
float furthestDepth=lastDepth.y;
#endif
float alphaMultiplier=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return;
}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
depth.rg=vec2(-fragDepth,fragDepth);
return;
}
#endif
`;te.IncludesShadersStore[DC]=NC;const wC="defaultPixelShader",FC=`#include<__decl__defaultFragment>
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#define RECIPROCAL_PI2 0.15915494
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
uniform samplerCube refractionCubeSampler;
#else
uniform sampler2D refraction2DSampler;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
uniform samplerCube reflectionCubeSampler;
#else
uniform sampler2D reflection2DSampler;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
vec4 baseColor=vec4(1.,1.,1.,1.);
vec3 diffuseColor=vDiffuseColor.rgb;
float alpha=vDiffuseColor.a;
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#ifdef DIFFUSE
baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<alphaCutOff)
discard;
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor.rgb*=vDiffuseInfos.y;
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
baseColor.rgb*=vColor.rgb;
#endif
#ifdef DETAIL
baseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
vec3 baseAmbientColor=vec3(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
#ifdef SPECULARTERM
float glossiness=vSpecularColor.a;
vec3 specularColor=vSpecularColor.rgb;
#ifdef SPECULAR
vec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);
specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#else
float glossiness=0.;
#endif
vec3 diffuseBase=vec3(0.,0.,0.);
lightingInfo info;
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
float shadow=1.;
#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
#include<lightFragment>[0..maxSimultaneousLights]
vec4 refractionColor=vec4(0.,0.,0.,1.);
#ifdef REFRACTION
vec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;
if (dot(refractionVector,viewDirectionW)<1.0) {
refractionColor=textureCube(refractionCubeSampler,refractionVector);
}
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;
refractionCoords.y=1.0-refractionCoords.y;
refractionColor=texture2D(refraction2DSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor.rgb=fromRGBD(refractionColor);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor.rgb=toGammaSpace(refractionColor.rgb);
#endif
refractionColor.rgb*=vRefractionInfos.x;
#endif
vec4 reflectionColor=vec4(0.,0.,0.,1.);
#ifdef REFLECTION
vec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
float bias=vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);
#else
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);
#endif
#else
vec2 coords=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;
reflectionColor=texture2D(reflection2DSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor.rgb=toGammaSpace(reflectionColor.rgb);
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#ifdef REFLECTIONFRESNEL
float reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
float refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);
refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);
alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;
#else
alpha*=opacityMap.a*vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#ifdef OPACITYFRESNEL
float opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);
alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<alphaCutOff)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
vec3 emissiveColor=vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
float emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);
emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
float diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);
diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
vec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#else
vec3 finalSpecular=vec3(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#ifdef EMISSIVEASILLUMINATION
vec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
vec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color.rgb*=lightmapColor.rgb;
#else
color.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color.rgb=max(color.rgb,0.);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color.rgb=toLinearSpace(color.rgb);
#else
#ifdef IMAGEPROCESSING
color.rgb=toLinearSpace(color.rgb);
color=applyImageProcessing(color);
#endif
#endif
color.a*=visibility;
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;
gl_FragData[0]=color; 
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULARTERM)
#if defined(SPECULAR)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; 
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;
#endif
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0)*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=color;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {
frontColor.rgb+=color.rgb*color.a*alphaMultiplier;
frontColor.a=1.0-alphaMultiplier*(1.0-color.a);
} else {
backColor+=color;
}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;te.ShadersStore[wC]=FC;const LC="defaultVertexDeclaration",BC=`uniform mat4 viewProjection;
uniform mat4 view;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
uniform mat4 lightmapMatrix;
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
uniform mat4 specularMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform mat4 bumpMatrix;
#endif
#ifdef REFLECTION
uniform mat4 reflectionMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
uniform mat4 detailMatrix;
#endif
#define ADDITIONAL_VERTEX_DECLARATION
`;te.IncludesShadersStore[LC]=BC;const UC="uvAttributeDeclaration",VC=`#ifdef UV{X}
attribute vec2 uv{X};
#endif
`;te.IncludesShadersStore[UC]=VC;const kC="bonesDeclaration",GC=`#if NUM_BONE_INFLUENCERS>0
attribute vec4 matricesIndices;
attribute vec4 matricesWeights;
#if NUM_BONE_INFLUENCERS>4
attribute vec4 matricesIndicesExtra;
attribute vec4 matricesWeightsExtra;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
uniform sampler2D boneSampler;
uniform float boneTextureWidth;
#else
uniform mat4 mBones[BonesPerMesh];
#ifdef BONES_VELOCITY_ENABLED
uniform mat4 mPreviousBones[BonesPerMesh];
#endif
#endif
#ifdef BONETEXTURE
#define inline
mat4 readMatrixFromRawSampler(sampler2D smp,float index)
{
float offset=index *4.0;
float dx=1.0/boneTextureWidth;
vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));
vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));
vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));
vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));
return mat4(m0,m1,m2,m3);
}
#endif
#endif
#endif
`;te.IncludesShadersStore[kC]=GC;const zC="bakedVertexAnimationDeclaration",HC=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform float bakedVertexAnimationTime;
uniform vec2 bakedVertexAnimationTextureSizeInverted;
uniform vec4 bakedVertexAnimationSettings;
uniform sampler2D bakedVertexAnimationTexture;
#ifdef INSTANCES
attribute vec4 bakedVertexAnimationSettingsInstanced;
#endif
#define inline
mat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)
{
float offset=index*4.0;
float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;
float dx=bakedVertexAnimationTextureSizeInverted.x;
vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));
vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));
vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));
vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));
return mat4(m0,m1,m2,m3);
}
#endif
`;te.IncludesShadersStore[zC]=HC;const WC="instancesDeclaration",XC=`#ifdef INSTANCES
attribute vec4 world0;
attribute vec4 world1;
attribute vec4 world2;
attribute vec4 world3;
#ifdef INSTANCESCOLOR
attribute vec4 instanceColor;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
attribute vec4 previousWorld0;
attribute vec4 previousWorld1;
attribute vec4 previousWorld2;
attribute vec4 previousWorld3;
#ifdef THIN_INSTANCES
uniform mat4 previousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
uniform mat4 previousWorld;
#endif
#endif
`;te.IncludesShadersStore[WC]=XC;const $C="prePassVertexDeclaration",YC=`#ifdef PREPASS
#ifdef PREPASS_DEPTH
varying vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
uniform mat4 previousViewProjection;
varying vec4 vCurrentPosition;
varying vec4 vPreviousPosition;
#endif
#endif
`;te.IncludesShadersStore[$C]=YC;const jC="samplerVertexDeclaration",KC=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying vec2 v_VARYINGNAME_UV;
#endif
`;te.IncludesShadersStore[jC]=KC;const qC="bumpVertexDeclaration",QC=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;te.IncludesShadersStore[qC]=QC;const ZC="clipPlaneVertexDeclaration",JC=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;
varying float fClipDistance6;
#endif
`;te.IncludesShadersStore[ZC]=JC;const eA="fogVertexDeclaration",tA=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;te.IncludesShadersStore[eA]=tA;const iA="lightVxFragmentDeclaration",rA=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};
uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};
uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};
uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#endif
`;te.IncludesShadersStore[iA]=rA;const sA="lightVxUboDeclaration",nA=`#ifdef LIGHT{X}
uniform Light{X}
{
vec4 vLightData;
vec4 vLightDiffuse;
vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;
vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;
vec2 depthValues;
} light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;te.IncludesShadersStore[sA]=nA;const aA="morphTargetsVertexGlobalDeclaration",oA=`#ifdef MORPHTARGETS
uniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];
#ifdef MORPHTARGETS_TEXTURE 
precision mediump sampler2DArray; 
uniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];
uniform vec3 morphTargetTextureInfo;
uniform sampler2DArray morphTargets;
vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)
{ 
float y=floor(vertexIndex/morphTargetTextureInfo.y);
float x=vertexIndex-y*morphTargetTextureInfo.y;
vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);
return texture(morphTargets,textureUV).xyz;
}
#endif
#endif
`;te.IncludesShadersStore[aA]=oA;const lA="morphTargetsVertexDeclaration",cA=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
attribute vec3 position{X};
#ifdef MORPHTARGETS_NORMAL
attribute vec3 normal{X};
#endif
#ifdef MORPHTARGETS_TANGENT
attribute vec3 tangent{X};
#endif
#ifdef MORPHTARGETS_UV
attribute vec2 uv_{X};
#endif
#endif
#endif
`;te.IncludesShadersStore[lA]=cA;const hA="morphTargetsVertexGlobal",uA=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
float vertexID;
#endif
#endif
`;te.IncludesShadersStore[hA]=uA;const dA="morphTargetsVertex",fA=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE 
vertexID=float(gl_VertexID)*morphTargetTextureInfo.x;
positionUpdated+=(readVector3FromRawSampler({X},vertexID)-position)*morphTargetInfluences[{X}];
vertexID+=1.0;
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(readVector3FromRawSampler({X},vertexID) -normal)*morphTargetInfluences[{X}];
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(readVector3FromRawSampler({X},vertexID).xy-uv)*morphTargetInfluences[{X}];
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*morphTargetInfluences[{X}];
#endif
#else
positionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];
#endif
#endif
#endif
`;te.IncludesShadersStore[dA]=fA;const _A="instancesVertex",pA=`#ifdef INSTANCES
mat4 finalWorld=mat4(world0,world1,world2,world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
finalWorld=world*finalWorld;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
mat4 finalWorld=world;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=previousWorld;
#endif
#endif
`;te.IncludesShadersStore[_A]=pA;const mA="bonesVertex",gA=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
mat4 influence;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];
#endif
#else
influence=mBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=mBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=mBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=mBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;te.IncludesShadersStore[mA]=gA;const vA="bakedVertexAnimation",xA=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
#define BVASNAME bakedVertexAnimationSettingsInstanced
#else
#define BVASNAME bakedVertexAnimationSettings
#endif
float VATStartFrame=BVASNAME.x;
float VATEndFrame=BVASNAME.y;
float VATOffsetFrame=BVASNAME.z;
float VATSpeed=BVASNAME.w;
float totalFrames=VATEndFrame-VATStartFrame+1.0;
float time=bakedVertexAnimationTime*VATSpeed/totalFrames;
float frameCorrection=time<1.0 ? 0.0 : 1.0;
float numOfFrames=totalFrames-frameCorrection;
float VATFrameNum=fract(time)*numOfFrames;
VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);
VATFrameNum=floor(VATFrameNum);
VATFrameNum+=VATStartFrame+frameCorrection;
mat4 VATInfluence;
VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;
}
#endif
`;te.IncludesShadersStore[vA]=xA;const TA="prePassVertex",EA=`#ifdef PREPASS_DEPTH
vViewPos=(view*worldPos).rgb;
#endif
#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;
previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
`;te.IncludesShadersStore[TA]=EA;const bA="uvVariableDeclaration",SA=`#if !defined(UV{X}) && defined(MAINUV{X})
vec2 uv{X}=vec2(0.,0.);
#endif
#ifdef MAINUV{X}
vMainUV{X}=uv{X};
#endif
`;te.IncludesShadersStore[bA]=SA;const yA="samplerVertexImplementation",CA=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (v_INFONAME_==0.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));
}
#ifdef UV2
else if (v_INFONAME_==1.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));
}
#endif
#ifdef UV3
else if (v_INFONAME_==2.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));
}
#endif
#ifdef UV4
else if (v_INFONAME_==3.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));
}
#endif
#ifdef UV5
else if (v_INFONAME_==4.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));
}
#endif
#ifdef UV6
else if (v_INFONAME_==5.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));
}
#endif
#endif
`;te.IncludesShadersStore[yA]=CA;const AA="bumpVertex",RA=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);
vec3 tbnTangent=normalize(tangentUpdated.xyz);
vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;
vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;te.IncludesShadersStore[AA]=RA;const IA="clipPlaneVertex",PA=`#ifdef CLIPPLANE
fClipDistance=dot(worldPos,vClipPlane);
#endif
#ifdef CLIPPLANE2
fClipDistance2=dot(worldPos,vClipPlane2);
#endif
#ifdef CLIPPLANE3
fClipDistance3=dot(worldPos,vClipPlane3);
#endif
#ifdef CLIPPLANE4
fClipDistance4=dot(worldPos,vClipPlane4);
#endif
#ifdef CLIPPLANE5
fClipDistance5=dot(worldPos,vClipPlane5);
#endif
#ifdef CLIPPLANE6
fClipDistance6=dot(worldPos,vClipPlane6);
#endif
`;te.IncludesShadersStore[IA]=PA;const MA="fogVertex",OA=`#ifdef FOG
vFogDistance=(view*worldPos).xyz;
#endif
`;te.IncludesShadersStore[MA]=OA;const DA="shadowsVertex",NA=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vPositionFromCamera{X}=view*worldPos;
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {
vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
}
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vPositionFromLight{X}=lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;te.IncludesShadersStore[DA]=NA;const wA="vertexColorMixing",FA=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vColor=vec4(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vColor*=color;
#else
vColor.rgb*=color.rgb;
#endif
#endif
#ifdef INSTANCESCOLOR
vColor*=instanceColor;
#endif
#endif
`;te.IncludesShadersStore[wA]=FA;const LA="pointCloudVertex",BA=`#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
`;te.IncludesShadersStore[LA]=BA;const UA="logDepthVertex",VA=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;
gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;te.IncludesShadersStore[UA]=VA;const kA="defaultVertexShader",GA=`#include<__decl__defaultVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));
vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
vPositionW=vec3(worldPos);
#include<prePassVertex>
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<pointCloudVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;te.ShadersStore[kA]=GA;const zA=new RegExp("^([gimus]+)!");class xl{constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}_addPlugin(e){for(let r=0;r<this._plugins.length;++r)if(this._plugins[r].name===e.name)throw`Plugin "${e.name}" already added to the material "${this._material.name}"!`;if(this._material._uniformBufferLayoutBuilt)throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.`;const t=e.getClassName();xl._MaterialPluginClassToMainDefine[t]||(xl._MaterialPluginClassToMainDefine[t]="MATERIALPLUGIN_"+ ++xl._MaterialPluginCounter),this._material._callbackPluginEventGeneric=this._handlePluginEvent.bind(this),this._plugins.push(e),this._plugins.sort((r,s)=>r.priority-s.priority),this._codeInjectionPoints={};const i={};i[xl._MaterialPluginClassToMainDefine[t]]={type:"boolean",default:!0};for(const r of this._plugins)r.collectDefines(i),this._collectPointNames("vertex",r.getCustomCode("vertex")),this._collectPointNames("fragment",r.getCustomCode("fragment"));this._defineNamesFromPlugins=i}_activatePlugin(e){this._activePlugins.indexOf(e)===-1&&(this._activePlugins.push(e),this._activePlugins.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null}_handlePluginEventIsReadyForSubMesh(e){let t=!0;for(const i of this._activePlugins)t=t&&i.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=t}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(const t of this._activePlugins)t.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}_handlePluginEventPrepareDefines(e){for(const t of this._activePlugins)t.prepareDefines(e.defines,this._scene,e.mesh)}_handlePluginEventHardBindForSubMesh(e){for(const t of this._activePluginsForExtraEvents)t.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventBindForSubMesh(e){for(const t of this._activePlugins)t.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventHasRenderTargetTextures(e){let t=!1;for(const i of this._activePluginsForExtraEvents)if(t=i.hasRenderTargetTextures(),t)break;e.hasRenderTargetTextures=t}_handlePluginEventFillRenderTargetTextures(e){for(const t of this._activePluginsForExtraEvents)t.fillRenderTargetTextures(e.renderTargets)}_handlePluginEvent(e,t){switch(e){case Cs.GetActiveTextures:{const i=t;for(const r of this._activePlugins)r.getActiveTextures(i.activeTextures);break}case Cs.GetAnimatables:{const i=t;for(const r of this._activePlugins)r.getAnimatables(i.animatables);break}case Cs.HasTexture:{const i=t;let r=!1;for(const s of this._activePlugins)if(r=s.hasTexture(i.texture),r)break;i.hasTexture=r;break}case Cs.Disposed:{const i=t;for(const r of this._plugins)r.dispose(i.forceDisposeTextures);break}case Cs.GetDefineNames:{const i=t;i.defineNames=this._defineNamesFromPlugins;break}case Cs.PrepareEffect:{const i=t;for(const r of this._activePlugins)i.fallbackRank=r.addFallbacks(i.defines,i.fallbacks,i.fallbackRank),r.getAttributes(i.attributes,this._scene,i.mesh);this._uniformList.length>0&&i.uniforms.push(...this._uniformList),this._samplerList.length>0&&i.samplers.push(...this._samplerList),this._uboList.length>0&&i.uniformBuffersNames.push(...this._uboList),i.customCode=this._injectCustomCode(i.customCode);break}case Cs.PrepareUniformBuffer:{const i=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(const r of this._plugins){const s=r.getUniforms();if(s){if(s.ubo)for(const n of s.ubo)i.ubo.addUniform(n.name,n.size),this._uboDeclaration+=`${n.type} ${n.name};\r
`,this._uniformList.push(n.name);s.vertex&&(this._vertexDeclaration+=s.vertex+`\r
`),s.fragment&&(this._fragmentDeclaration+=s.fragment+`\r
`)}r.getSamplers(this._samplerList),r.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(e,t){if(t)for(const i in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][i]=!0}_injectCustomCode(e){return(t,i)=>{var r;e&&(i=e(t,i)),this._uboDeclaration&&(i=i.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(i=i.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(i=i.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const s=(r=this._codeInjectionPoints)===null||r===void 0?void 0:r[t];if(!s)return i;for(let n in s){let a="";for(const l of this._activePlugins){const c=l.getCustomCode(t);c!=null&&c[n]&&(a+=c[n]+`\r
`)}if(a.length>0)if(n.charAt(0)==="!"){n=n.substring(1);let l="g";if(n.charAt(0)==="!")l="",n=n.substring(1);else{const d=zA.exec(n);d&&d.length>=2&&(l=d[1],n=n.substring(l.length+1))}l.indexOf("g")<0&&(l+="g");const c=i,h=new RegExp(n,l);let u=h.exec(c);for(;u!==null;){let d=a;for(let f=0;f<u.length;++f)d=d.replace("$"+f,u[f]);i=i.replace(u[0],d),u=h.exec(c)}}else{const l="#define "+n;i=i.replace(l,`\r
`+a+`\r
`+l)}}return i}}}xl._MaterialPluginClassToMainDefine={};xl._MaterialPluginCounter=0;class yo{_enable(e){e&&this._pluginManager._activatePlugin(this)}constructor(e,t,i,r,s=!0,n=!1){this.priority=500,this.registerForExtraEvents=!1,this._material=e,this.name=t,this.priority=i,e.pluginManager||(e.pluginManager=new xl(e)),this._pluginDefineNames=r,this._pluginManager=e.pluginManager,s&&this._pluginManager._addPlugin(this),n&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,t,i,r){return!0}hardBindForSubMesh(e,t,i,r){}bindForSubMesh(e,t,i,r){}dispose(e){}getCustomCode(e){return null}collectDefines(e){if(this._pluginDefineNames)for(const t of Object.keys(this._pluginDefineNames)){if(t[0]==="_")continue;const i=typeof this._pluginDefineNames[t];e[t]={type:i==="number"?"number":i==="string"?"string":i==="boolean"?"boolean":"object",default:this._pluginDefineNames[t]}}}prepareDefinesBeforeAttributes(e,t,i){}prepareDefines(e,t,i){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,i){return i}getSamplers(e){}getAttributes(e,t,i){}getUniformBuffersNames(e){}getUniforms(){return{}}copyTo(e){ke.Clone(()=>e,this)}serialize(){return ke.Serialize(this)}parse(e,t,i){ke.Parse(()=>this,e,t,i)}}M([F()],yo.prototype,"name",void 0);M([F()],yo.prototype,"priority",void 0);M([F()],yo.prototype,"registerForExtraEvents",void 0);class HA extends Aa{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class Gl extends yo{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"DetailMap",140,new HA,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=me.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&Me.DetailTextureEnabled&&!this._texture.isReady()):!0}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&Me.DetailTextureEnabled&&this._isEnabled?(Ce.PrepareDefinesForMergedUV(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&this._texture&&Me.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),Ce.BindTextureMatrix(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&Me.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){var t;e&&((t=this._texture)===null||t===void 0||t.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}M([Bt("detailTexture"),Te("_markAllSubMeshesAsTexturesDirty")],Gl.prototype,"texture",void 0);M([F()],Gl.prototype,"diffuseBlendLevel",void 0);M([F()],Gl.prototype,"roughnessBlendLevel",void 0);M([F()],Gl.prototype,"bumpLevel",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],Gl.prototype,"normalBlendMethod",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],Gl.prototype,"isEnabled",void 0);const T_={effect:null,subMesh:null};class WA extends Aa{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.rebuild()}setReflectionMode(e){const t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const i of t)this[i]=i===e}}class Be extends Fu{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}constructor(e,t){super(e,t),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new ge(0,0,0),this.diffuseColor=new ge(1,1,1),this.specularColor=new ge(1,1,1),this.emissiveColor=new ge(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._renderTargets=new Lr(16),this._worldViewProjectionMatrix=H.Zero(),this._globalAmbientColor=new ge(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new Gl(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new Xd,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),Be.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),Be.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return Be.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||Be.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this._markAllSubMeshesAsMiscDirty()}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled}needAlphaTesting(){return this._forceAlphaTest?!0:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===me.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==me.MATERIAL_OPAQUE}_hasAlphaChannel(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(Cs.GetDefineNames,this._eventInfo),t.materialDefines=new WA(this._eventInfo.defineNames));const r=this.getScene(),s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=r.getEngine();s._needNormals=Ce.PrepareDefinesForLights(r,e,s,!0,this._maxSimultaneousLights,this._disableLighting),Ce.PrepareDefinesForMultiview(r,s);const a=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(Ce.PrepareDefinesForPrePass(r,s,this.canRenderToMRT&&!a),Ce.PrepareDefinesForOIT(r,s,a),s._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,s._needUVs=!1;for(let c=1;c<=6;++c)s["MAINUV"+c]=!1;if(r.texturesEnabled){if(s.DIFFUSEDIRECTUV=0,s.BUMPDIRECTUV=0,s.AMBIENTDIRECTUV=0,s.OPACITYDIRECTUV=0,s.EMISSIVEDIRECTUV=0,s.SPECULARDIRECTUV=0,s.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&Be.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())Ce.PrepareDefinesForMergedUV(this._diffuseTexture,s,"DIFFUSE");else return!1;else s.DIFFUSE=!1;if(this._ambientTexture&&Be.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())Ce.PrepareDefinesForMergedUV(this._ambientTexture,s,"AMBIENT");else return!1;else s.AMBIENT=!1;if(this._opacityTexture&&Be.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())Ce.PrepareDefinesForMergedUV(this._opacityTexture,s,"OPACITY"),s.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else s.OPACITY=!1;if(this._reflectionTexture&&Be.ReflectionTextureEnabled)if(this._reflectionTexture.isReadyOrNotBlocking()){switch(s._needNormals=!0,s.REFLECTION=!0,s.ROUGHNESS=this._roughness>0,s.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,s.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===Y.INVCUBIC_MODE,s.REFLECTIONMAP_3D=this._reflectionTexture.isCube,s.REFLECTIONMAP_OPPOSITEZ=s.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,s.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case Y.EXPLICIT_MODE:s.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case Y.PLANAR_MODE:s.setReflectionMode("REFLECTIONMAP_PLANAR");break;case Y.PROJECTION_MODE:s.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case Y.SKYBOX_MODE:s.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case Y.SPHERICAL_MODE:s.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case Y.EQUIRECTANGULAR_MODE:s.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case Y.FIXED_EQUIRECTANGULAR_MODE:s.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case Y.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:s.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case Y.CUBIC_MODE:case Y.INVCUBIC_MODE:default:s.setReflectionMode("REFLECTIONMAP_CUBIC");break}s.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else return!1;else s.REFLECTION=!1,s.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&Be.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())Ce.PrepareDefinesForMergedUV(this._emissiveTexture,s,"EMISSIVE");else return!1;else s.EMISSIVE=!1;if(this._lightmapTexture&&Be.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())Ce.PrepareDefinesForMergedUV(this._lightmapTexture,s,"LIGHTMAP"),s.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,s.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else s.LIGHTMAP=!1;if(this._specularTexture&&Be.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())Ce.PrepareDefinesForMergedUV(this._specularTexture,s,"SPECULAR"),s.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else s.SPECULAR=!1;if(r.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&Be.BumpTextureEnabled){if(this._bumpTexture.isReady())Ce.PrepareDefinesForMergedUV(this._bumpTexture,s,"BUMP"),s.PARALLAX=this._useParallax,s.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;s.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else s.BUMP=!1,s.PARALLAX=!1,s.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&Be.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())s._needUVs=!0,s.REFRACTION=!0,s.REFRACTIONMAP_3D=this._refractionTexture.isCube,s.RGBDREFRACTION=this._refractionTexture.isRGBD,s.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else s.REFRACTION=!1;s.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else s.DIFFUSE=!1,s.AMBIENT=!1,s.OPACITY=!1,s.REFLECTION=!1,s.EMISSIVE=!1,s.LIGHTMAP=!1,s.BUMP=!1,s.REFRACTION=!1;s.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),s.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,s.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,s.SPECULAROVERALPHA=this._useSpecularOverAlpha,s.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,s.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,s.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(s._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(s),s.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,s.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}s._areFresnelDirty&&(Be.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(s.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,s.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,s.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,s.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,s.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,s.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,s._needNormals=!0,s.FRESNEL=!0):s.FRESNEL=!1),Ce.PrepareDefinesForMisc(e,r,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,s),Ce.PrepareDefinesForFrameBoundValues(r,n,this,s,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=s,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),Ce.PrepareDefinesForAttributes(e,s,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let l=!1;if(s.isDirty){const c=s._areLightsDisposed;s.markAsProcessed();const h=new pc;s.REFLECTION&&h.addFallback(0,"REFLECTION"),s.SPECULAR&&h.addFallback(0,"SPECULAR"),s.BUMP&&h.addFallback(0,"BUMP"),s.PARALLAX&&h.addFallback(1,"PARALLAX"),s.PARALLAXOCCLUSION&&h.addFallback(0,"PARALLAXOCCLUSION"),s.SPECULAROVERALPHA&&h.addFallback(0,"SPECULAROVERALPHA"),s.FOG&&h.addFallback(1,"FOG"),s.POINTSIZE&&h.addFallback(0,"POINTSIZE"),s.LOGARITHMICDEPTH&&h.addFallback(0,"LOGARITHMICDEPTH"),Ce.HandleFallbacksForShadows(s,h,this._maxSimultaneousLights),s.SPECULARTERM&&h.addFallback(0,"SPECULARTERM"),s.DIFFUSEFRESNEL&&h.addFallback(1,"DIFFUSEFRESNEL"),s.OPACITYFRESNEL&&h.addFallback(2,"OPACITYFRESNEL"),s.REFLECTIONFRESNEL&&h.addFallback(3,"REFLECTIONFRESNEL"),s.EMISSIVEFRESNEL&&h.addFallback(4,"EMISSIVEFRESNEL"),s.FRESNEL&&h.addFallback(4,"FRESNEL"),s.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");const u=[O.PositionKind];s.NORMAL&&u.push(O.NormalKind),s.TANGENT&&u.push(O.TangentKind);for(let S=1;S<=6;++S)s["UV"+S]&&u.push(`uv${S===1?"":S}`);s.VERTEXCOLOR&&u.push(O.ColorKind),Ce.PrepareAttributesForBones(u,e,s,h),Ce.PrepareAttributesForInstances(u,s),Ce.PrepareAttributesForMorphTargets(u,e,s),Ce.PrepareAttributesForBakedVertexAnimation(u,e,s);let d="default";const f=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],_=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],p=["Material","Scene","Mesh"];this._eventInfo.fallbacks=h,this._eventInfo.fallbackRank=0,this._eventInfo.defines=s,this._eventInfo.uniforms=f,this._eventInfo.attributes=u,this._eventInfo.samplers=_,this._eventInfo.uniformBuffersNames=p,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._callbackPluginEventGeneric(Cs.PrepareEffect,this._eventInfo),Xd.AddUniforms(f),wt&&(wt.PrepareUniforms(f,s),wt.PrepareSamplers(_,s)),Ce.PrepareUniformsAndSamplersList({uniformsNames:f,uniformBuffersNames:p,samplers:_,defines:s,maxSimultaneousLights:this._maxSimultaneousLights}),ja(f);const m={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,f,p,_,s,u,m));const T=s.toString(),b=t.effect;let y=r.getEngine().createEffect(d,{attributes:u,uniformsNames:f,uniformBuffersNames:p,samplers:_,defines:T,fallbacks:h,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:s.NUM_MORPH_INFLUENCERS},processFinalCode:m.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:s.PREPASS},n);if(this._eventInfo.customCode=void 0,y)if(this._onEffectCreatedObservable&&(T_.effect=y,T_.subMesh=t,this._onEffectCreatedObservable.notifyObservers(T_)),this.allowShaderHotSwapping&&b&&!y.isReady()){if(y=b,s.markAsUnprocessed(),l=this.isFrozen,c)return s._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(y,s,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(s._renderId=r.getRenderId(),t.effect._wasPreviouslyReady=!l,t.effect._wasPreviouslyUsingInstances=i,r.performancePriority!==la.BackwardCompatible&&(this.checkReadyOnlyOnce=!0),!0)}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var r;const s=this.getScene(),n=i.materialDefines;if(!n)return;const a=i.effect;if(!a)return;this._activeEffect=a,t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(a,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,s,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),n.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const l=a._forceRebindOnNextCall||this._mustRebind(s,a,t.visibility);Ce.BindBonesParameters(t,a);const c=this._uniformBuffer;if(l){if(this.bindViewProjection(a),!c.useUbo||!this.isFrozen||!c.isSync||a._forceRebindOnNextCall){if(Be.FresnelEnabled&&n.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(c.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),c.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&c.updateColor4("opacityParts",new ge(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(c.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),c.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(c.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),c.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(c.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),c.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),s.texturesEnabled){if(this._diffuseTexture&&Be.DiffuseTextureEnabled&&(c.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),Ce.BindTextureMatrix(this._diffuseTexture,c,"diffuse")),this._ambientTexture&&Be.AmbientTextureEnabled&&(c.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),Ce.BindTextureMatrix(this._ambientTexture,c,"ambient")),this._opacityTexture&&Be.OpacityTextureEnabled&&(c.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),Ce.BindTextureMatrix(this._opacityTexture,c,"opacity")),this._hasAlphaChannel()&&c.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&Be.ReflectionTextureEnabled&&(c.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),c.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){const h=this._reflectionTexture;c.updateVector3("vReflectionPosition",h.boundingBoxPosition),c.updateVector3("vReflectionSize",h.boundingBoxSize)}if(this._emissiveTexture&&Be.EmissiveTextureEnabled&&(c.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),Ce.BindTextureMatrix(this._emissiveTexture,c,"emissive")),this._lightmapTexture&&Be.LightmapTextureEnabled&&(c.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),Ce.BindTextureMatrix(this._lightmapTexture,c,"lightmap")),this._specularTexture&&Be.SpecularTextureEnabled&&(c.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),Ce.BindTextureMatrix(this._specularTexture,c,"specular")),this._bumpTexture&&s.getEngine().getCaps().standardDerivatives&&Be.BumpTextureEnabled&&(c.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),Ce.BindTextureMatrix(this._bumpTexture,c,"bump"),s._mirroredCameraPosition?c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&Be.RefractionTextureEnabled){let h=1;if(this._refractionTexture.isCube||(c.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(h=this._refractionTexture.depth)),c.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,h,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const u=this._refractionTexture;c.updateVector3("vRefractionPosition",u.boundingBoxPosition),c.updateVector3("vRefractionSize",u.boundingBoxSize)}}}this.pointsCloud&&c.updateFloat("pointSize",this.pointSize),n.SPECULARTERM&&c.updateColor4("vSpecularColor",this.specularColor,this.specularPower),c.updateColor3("vEmissiveColor",Be.EmissiveTextureEnabled?this.emissiveColor:ge.BlackReadOnly),c.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),s.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),c.updateColor3("vAmbientColor",this._globalAmbientColor)}s.texturesEnabled&&(this._diffuseTexture&&Be.DiffuseTextureEnabled&&a.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&Be.AmbientTextureEnabled&&a.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&Be.OpacityTextureEnabled&&a.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&Be.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?a.setTexture("reflectionCubeSampler",this._reflectionTexture):a.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&Be.EmissiveTextureEnabled&&a.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&Be.LightmapTextureEnabled&&a.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&Be.SpecularTextureEnabled&&a.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&s.getEngine().getCaps().standardDerivatives&&Be.BumpTextureEnabled&&a.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&Be.RefractionTextureEnabled&&(this._refractionTexture.isCube?a.setTexture("refractionCubeSampler",this._refractionTexture):a.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(a),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Ra(a,this,s),this.bindEyePosition(a)}else s.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(s.lightsEnabled&&!this._disableLighting&&Ce.BindLights(s,t,a,n,this._maxSimultaneousLights),(s.fogEnabled&&t.applyFog&&s.fogMode!==Ne.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||n.PREPASS)&&this.bindView(a),Ce.BindFogParameters(s,t,a),n.NUM_MORPH_INFLUENCERS&&Ce.BindMorphTargetParameters(t,a),n.BAKED_VERTEX_ANIMATION_TEXTURE&&((r=t.bakedVertexAnimationManager)===null||r===void 0||r.bind(a,n.INSTANCES)),this.useLogarithmicDepth&&Ce.BindLogDepth(n,a,s),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),c.update()}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e)}dispose(e,t){var i,r,s,n,a,l,c,h,u;t&&((i=this._diffuseTexture)===null||i===void 0||i.dispose(),(r=this._ambientTexture)===null||r===void 0||r.dispose(),(s=this._opacityTexture)===null||s===void 0||s.dispose(),(n=this._reflectionTexture)===null||n===void 0||n.dispose(),(a=this._emissiveTexture)===null||a===void 0||a.dispose(),(l=this._specularTexture)===null||l===void 0||l.dispose(),(c=this._bumpTexture)===null||c===void 0||c.dispose(),(h=this._lightmapTexture)===null||h===void 0||h.dispose(),(u=this._refractionTexture)===null||u===void 0||u.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e){const t=ke.Clone(()=>new Be(e,this.getScene()),this);return t.name=e,t.id=e,this.stencil.copyTo(t.stencil),t}static Parse(e,t,i){const r=ke.Parse(()=>new Be(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),r}static get DiffuseTextureEnabled(){return Me.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){Me.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return Me.DetailTextureEnabled}static set DetailTextureEnabled(e){Me.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return Me.AmbientTextureEnabled}static set AmbientTextureEnabled(e){Me.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return Me.OpacityTextureEnabled}static set OpacityTextureEnabled(e){Me.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return Me.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){Me.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return Me.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){Me.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return Me.SpecularTextureEnabled}static set SpecularTextureEnabled(e){Me.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return Me.BumpTextureEnabled}static set BumpTextureEnabled(e){Me.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return Me.LightmapTextureEnabled}static set LightmapTextureEnabled(e){Me.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return Me.RefractionTextureEnabled}static set RefractionTextureEnabled(e){Me.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return Me.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){Me.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return Me.FresnelEnabled}static set FresnelEnabled(e){Me.FresnelEnabled=e}}M([Bt("diffuseTexture")],Be.prototype,"_diffuseTexture",void 0);M([Te("_markAllSubMeshesAsTexturesAndMiscDirty")],Be.prototype,"diffuseTexture",void 0);M([Bt("ambientTexture")],Be.prototype,"_ambientTexture",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"ambientTexture",void 0);M([Bt("opacityTexture")],Be.prototype,"_opacityTexture",void 0);M([Te("_markAllSubMeshesAsTexturesAndMiscDirty")],Be.prototype,"opacityTexture",void 0);M([Bt("reflectionTexture")],Be.prototype,"_reflectionTexture",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"reflectionTexture",void 0);M([Bt("emissiveTexture")],Be.prototype,"_emissiveTexture",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"emissiveTexture",void 0);M([Bt("specularTexture")],Be.prototype,"_specularTexture",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"specularTexture",void 0);M([Bt("bumpTexture")],Be.prototype,"_bumpTexture",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"bumpTexture",void 0);M([Bt("lightmapTexture")],Be.prototype,"_lightmapTexture",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"lightmapTexture",void 0);M([Bt("refractionTexture")],Be.prototype,"_refractionTexture",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"refractionTexture",void 0);M([Kr("ambient")],Be.prototype,"ambientColor",void 0);M([Kr("diffuse")],Be.prototype,"diffuseColor",void 0);M([Kr("specular")],Be.prototype,"specularColor",void 0);M([Kr("emissive")],Be.prototype,"emissiveColor",void 0);M([F()],Be.prototype,"specularPower",void 0);M([F("useAlphaFromDiffuseTexture")],Be.prototype,"_useAlphaFromDiffuseTexture",void 0);M([Te("_markAllSubMeshesAsTexturesAndMiscDirty")],Be.prototype,"useAlphaFromDiffuseTexture",void 0);M([F("useEmissiveAsIllumination")],Be.prototype,"_useEmissiveAsIllumination",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"useEmissiveAsIllumination",void 0);M([F("linkEmissiveWithDiffuse")],Be.prototype,"_linkEmissiveWithDiffuse",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"linkEmissiveWithDiffuse",void 0);M([F("useSpecularOverAlpha")],Be.prototype,"_useSpecularOverAlpha",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"useSpecularOverAlpha",void 0);M([F("useReflectionOverAlpha")],Be.prototype,"_useReflectionOverAlpha",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"useReflectionOverAlpha",void 0);M([F("disableLighting")],Be.prototype,"_disableLighting",void 0);M([Te("_markAllSubMeshesAsLightsDirty")],Be.prototype,"disableLighting",void 0);M([F("useObjectSpaceNormalMap")],Be.prototype,"_useObjectSpaceNormalMap",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"useObjectSpaceNormalMap",void 0);M([F("useParallax")],Be.prototype,"_useParallax",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"useParallax",void 0);M([F("useParallaxOcclusion")],Be.prototype,"_useParallaxOcclusion",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"useParallaxOcclusion",void 0);M([F()],Be.prototype,"parallaxScaleBias",void 0);M([F("roughness")],Be.prototype,"_roughness",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"roughness",void 0);M([F()],Be.prototype,"indexOfRefraction",void 0);M([F()],Be.prototype,"invertRefractionY",void 0);M([F()],Be.prototype,"alphaCutOff",void 0);M([F("useLightmapAsShadowmap")],Be.prototype,"_useLightmapAsShadowmap",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"useLightmapAsShadowmap",void 0);M([Ou("diffuseFresnelParameters")],Be.prototype,"_diffuseFresnelParameters",void 0);M([Te("_markAllSubMeshesAsFresnelDirty")],Be.prototype,"diffuseFresnelParameters",void 0);M([Ou("opacityFresnelParameters")],Be.prototype,"_opacityFresnelParameters",void 0);M([Te("_markAllSubMeshesAsFresnelAndMiscDirty")],Be.prototype,"opacityFresnelParameters",void 0);M([Ou("reflectionFresnelParameters")],Be.prototype,"_reflectionFresnelParameters",void 0);M([Te("_markAllSubMeshesAsFresnelDirty")],Be.prototype,"reflectionFresnelParameters",void 0);M([Ou("refractionFresnelParameters")],Be.prototype,"_refractionFresnelParameters",void 0);M([Te("_markAllSubMeshesAsFresnelDirty")],Be.prototype,"refractionFresnelParameters",void 0);M([Ou("emissiveFresnelParameters")],Be.prototype,"_emissiveFresnelParameters",void 0);M([Te("_markAllSubMeshesAsFresnelDirty")],Be.prototype,"emissiveFresnelParameters",void 0);M([F("useReflectionFresnelFromSpecular")],Be.prototype,"_useReflectionFresnelFromSpecular",void 0);M([Te("_markAllSubMeshesAsFresnelDirty")],Be.prototype,"useReflectionFresnelFromSpecular",void 0);M([F("useGlossinessFromSpecularMapAlpha")],Be.prototype,"_useGlossinessFromSpecularMapAlpha",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"useGlossinessFromSpecularMapAlpha",void 0);M([F("maxSimultaneousLights")],Be.prototype,"_maxSimultaneousLights",void 0);M([Te("_markAllSubMeshesAsLightsDirty")],Be.prototype,"maxSimultaneousLights",void 0);M([F("invertNormalMapX")],Be.prototype,"_invertNormalMapX",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"invertNormalMapX",void 0);M([F("invertNormalMapY")],Be.prototype,"_invertNormalMapY",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"invertNormalMapY",void 0);M([F("twoSidedLighting")],Be.prototype,"_twoSidedLighting",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Be.prototype,"twoSidedLighting",void 0);M([F()],Be.prototype,"useLogarithmicDepth",null);ye("BABYLON.StandardMaterial",Be);Ne.DefaultMaterialFactory=o=>new Be("default material",o);ze.prototype.createDynamicTexture=function(o,e,t,i){const r=new hi(this,bt.Dynamic);return r.baseWidth=o,r.baseHeight=e,t&&(o=this.needPOTTextures?ze.GetExponentOfTwo(o,this._caps.maxTextureSize):o,e=this.needPOTTextures?ze.GetExponentOfTwo(e,this._caps.maxTextureSize):e),r.width=o,r.height=e,r.isReady=!1,r.generateMipMaps=t,r.samplingMode=i,this.updateTextureSamplingMode(i,r),this._internalTexturesCache.push(r),r};ze.prototype.updateDynamicTexture=function(o,e,t,i=!1,r,s=!1,n=!1){if(!o)return;const a=this._gl,l=a.TEXTURE_2D,c=this._bindTextureDirectly(l,o,!0,s);this._unpackFlipY(t===void 0?o.invertY:t),i&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const h=this._getWebGLTextureType(o.type),u=this._getInternalFormat(r||o.format),d=this._getRGBABufferInternalSizedFormat(o.type,u);a.texImage2D(l,0,d,u,h,e),o.generateMipMaps&&a.generateMipmap(l),c||this._bindTextureDirectly(l,null),i&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),o.isReady=!0};class za extends Y{constructor(e,t,i=null,r=!1,s=3,n=5,a){super(null,i,!r,a,s,void 0,void 0,void 0,void 0,n),this.name=e,this.wrapU=Y.CLAMP_ADDRESSMODE,this.wrapV=Y.CLAMP_ADDRESSMODE,this._generateMipMaps=r;const l=this._getEngine();if(!l)return;t.getContext?(this._canvas=t,this._texture=l.createDynamicTexture(t.width,t.height,r,s)):(this._canvas=l.createCanvas(1,1),t.width||t.width===0?this._texture=l.createDynamicTexture(t.width,t.height,r,s):this._texture=l.createDynamicTexture(t,t,r,s));const c=this.getSize();this._canvas.width!==c.width&&(this._canvas.width=c.width),this._canvas.height!==c.height&&(this._canvas.height=c.height),this._context=this._canvas.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}_recreate(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)}scale(e){const t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)}scaleTo(e,t){const i=this.getSize();i.width=e,i.height=t,this._recreate(i)}getContext(){return this._context}clear(){const e=this.getSize();this._context.fillRect(0,0,e.width,e.height)}update(e,t=!1,i=!1){this._getEngine().updateDynamicTexture(this._texture,this._canvas,e===void 0?!0:e,t,this._format||void 0,void 0,i)}drawText(e,t,i,r,s,n,a,l=!0){const c=this.getSize();if(n&&(this._context.fillStyle=n,this._context.fillRect(0,0,c.width,c.height)),this._context.font=r,t==null){const h=this._context.measureText(e);t=(c.width-h.width)/2}if(i==null){const h=parseInt(r.replace(/\D/g,""));i=c.height/2+h/3.65}this._context.fillStyle=s||"",this._context.fillText(e,t,i),l&&this.update(a)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new za(this.name,t,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i}serialize(){const e=this.getScene();e&&!e.isReady()&&X.Warn("The scene must be ready before serializing the dynamic texture");const t=super.serialize();return za._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t}static _IsCanvasElement(e){return e.toDataURL!==void 0}_rebuild(){this.update()}}const XA="imageProcessingPixelShader",$A=`varying vec2 vUV;
uniform sampler2D textureSampler;
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec4 result=texture2D(textureSampler,vUV);
#ifdef IMAGEPROCESSING
#ifndef FROMLINEARSPACE
result.rgb=toLinearSpace(result.rgb);
#endif
result=applyImageProcessing(result);
#else
#ifdef FROMLINEARSPACE
result=applyImageProcessing(result);
#endif
#endif
gl_FragColor=result;
}`;te.ShadersStore[XA]=$A;class Df extends et{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){e.applyByPostProcess=!0,this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e,t=!1){if(e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{let i=null;const r=this.getEngine(),s=this.getCamera();if(s)i=s.getScene();else if(r&&r.scenes){const n=r.scenes;i=n[n.length-1]}else i=qe.LastCreatedScene;i?this._imageProcessingConfiguration=i.imageProcessingConfiguration:this._imageProcessingConfiguration=new wt}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateParameters()})),t||this._updateParameters()}}get isSupported(){const e=this.getEffect();return!e||e.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e}get fromLinearSpace(){return this._fromLinearSpace}set fromLinearSpace(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())}constructor(e,t,i=null,r,s,n,a=0,l){super(e,"imageProcessing",[],[],t,i,r,s,n,null,a,"postprocess",null,!0),this._fromLinearSpace=!0,this._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:!1,TONEMAPPING_ACES:!1,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,DITHER:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1},l?(l.applyByPostProcess=!0,this._attachImageProcessingConfiguration(l,!0),this._updateParameters()):(this._attachImageProcessingConfiguration(null,!0),this.imageProcessingConfiguration.applyByPostProcess=!0),this.onApply=c=>{this.imageProcessingConfiguration.bind(c,this.aspectRatio)}}getClassName(){return"ImageProcessingPostProcess"}_updateParameters(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);let e="";for(const r in this._defines)this._defines[r]&&(e+=`#define ${r};\r
`);const t=["textureSampler"],i=["scale"];wt&&(wt.PrepareSamplers(t,this._defines),wt.PrepareUniforms(i,this._defines)),this.updateEffect(e,i,t)}dispose(e){super.dispose(e),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}}M([F()],Df.prototype,"_fromLinearSpace",void 0);class gm{get isFixedFoveationSupported(){return this.layerType=="XRWebGLLayer"&&typeof this.layer.fixedFoveation=="number"}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){if(this.isFixedFoveationSupported){const t=Math.max(0,Math.min(1,e||0));this.layer.fixedFoveation=t}}constructor(e,t,i,r,s){this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this.createRenderTargetTextureProvider=s}}class vm{constructor(e,t){this._scene=e,this.layerWrapper=t,this._renderTargetTextures=new Array,this._engine=e.getEngine()}_createInternalTexture(e,t){const i=new hi(this._engine,bt.Unknown,!0);return i.width=e.width,i.height=e.height,i._hardwareTexture=new hf(t,this._engine._gl),i.isReady=!0,i}_createRenderTargetTexture(e,t,i,r,s,n){if(!this._engine)throw new Error("Engine is disposed");const a={width:e,height:t},l=n?new Y_(this._scene,a):new Zi("XR renderTargetTexture",a,this._scene),c=l.renderTarget;if(c._samples=l.samples,(i||!r)&&(c._framebuffer=i),r)if(n)c._colorTextureArray=r;else{const h=this._createInternalTexture(a,r);c.setTexture(h,0),l._texture=h}return s&&(n?c._depthStencilTextureArray=s:c._depthStencilTexture=this._createInternalTexture(a,s)),l.disableRescaling(),typeof XRWebGLBinding<"u"&&(l.skipInitialClear=!0),this._renderTargetTextures.push(l),l}_destroyRenderTargetTexture(e){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(e),1),e.dispose()}getFramebufferDimensions(){return this._framebufferDimensions}dispose(){this._renderTargetTextures.forEach(e=>e.dispose()),this._renderTargetTextures.length=0}}class xm extends gm{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new YA(t.scene,this)),this.layer=e}}class YA extends vm{constructor(e,t){super(e,t),this.layerWrapper=t,this._layer=t.layer,this._framebufferDimensions={framebufferWidth:this._layer.framebufferWidth,framebufferHeight:this._layer.framebufferHeight}}trySetViewportForView(e,t){const i=this._layer.getViewport(t);if(!i)return!1;const r=this._framebufferDimensions.framebufferWidth,s=this._framebufferDimensions.framebufferHeight;return e.x=i.x/r,e.y=i.y/s,e.width=i.width/r,e.height=i.height/s,!0}getRenderTargetTextureForEye(e){const t=this._layer.framebufferWidth,i=this._layer.framebufferHeight,r=this._layer.framebuffer;return(!this._rtt||t!==this._framebufferDimensions.framebufferWidth||i!==this._framebufferDimensions.framebufferHeight||r!==this._framebuffer)&&(this._rtt=this._createRenderTargetTexture(t,i,r),this._framebufferDimensions.framebufferWidth=t,this._framebufferDimensions.framebufferHeight=i,this._framebuffer=r),this._rtt}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}}class Nf{static GetDefaults(e){const t=new Nf;return t.canvasOptions={antialias:!0,depth:!0,stencil:e?e.isStencilEnable:!0,alpha:!0,framebufferScaleFactor:1},t.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",t}}class jA{constructor(e,t=Nf.GetDefaults()){if(this._options=t,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new Q,this._engine=e.scene.getEngine(),this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),t.canvasElement)this._setManagedOutputCanvas(t.canvasElement);else{const i=document.createElement("canvas");i.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(i)}e.onXRSessionInit.add(()=>{this._addCanvas()}),e.onXRSessionEnded.add(()=>{this._removeCanvas()})}dispose(){this._removeCanvas(),this._setManagedOutputCanvas(null)}async initializeXRLayerAsync(e){const t=()=>(this.xrLayer=new XRWebGLLayer(e,this.canvasContext,this._options.canvasOptions),this._xrLayerWrapper=new xm(this.xrLayer),this.onXRLayerInitObservable.notifyObservers(this.xrLayer),this.xrLayer);return this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then(()=>{},()=>{J.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly.")}).then(()=>t()):Promise.resolve(t())}_addCanvas(){this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce(()=>{this._setCanvasSize(!0)})}_removeCanvas(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)}_setCanvasSize(e=!0,t=this._xrLayerWrapper){!this._canvas||!this._engine||(e?t&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=t.getWidth()+"px",this._canvas.style.height=t.getHeight()+"px"):this._engine.setSize(t.getWidth(),t.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))}_setManagedOutputCanvas(e){this._removeCanvas(),e?(this._originalCanvasSize={width:e.offsetWidth,height:e.offsetHeight},this._canvas=e,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)}}class KA extends gm{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new qA(t,this)),this.layer=e}}class qA extends vm{constructor(e,t){super(e.scene,t),this.layerWrapper=t,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=t.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}}class QA{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}async initializeXRLayerAsync(e){return await this._nativeRenderTarget.initializeXRLayerAsync(e),this.xrLayer=this._nativeRenderTarget.xrLayer,this.xrLayer}dispose(){}}class wf{constructor(e){this.scene=e,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new Q,this.onXRReferenceSpaceChanged=new Q,this.onXRSessionEnded=new Q,this.onXRSessionInit=new Q,this.inXRFrameLoop=!1,this.inXRSession=!1,this._engine=e.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),e.onDisposeObservable.addOnce(()=>{this.dispose()})}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)}get sessionMode(){return this._sessionMode}dispose(){var e;this.inXRSession&&this.exitXRAsync(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),(e=this._engine)===null||e===void 0||e.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null}exitXRAsync(){return this.session&&this.inXRSession?(this.inXRSession=!1,this.session.end().catch(()=>{X.Warn("Could not end XR session.")})):Promise.resolve()}trySetViewportForView(e,t){var i;return((i=this._baseLayerRTTProvider)===null||i===void 0?void 0:i.trySetViewportForView(e,t))||!1}getRenderTargetTextureForEye(e){var t;return((t=this._baseLayerRTTProvider)===null||t===void 0?void 0:t.getRenderTargetTextureForEye(e))||null}getRenderTargetTextureForView(e){var t;return((t=this._baseLayerRTTProvider)===null||t===void 0?void 0:t.getRenderTargetTextureForView(e))||null}getWebXRRenderTarget(e){const t=this.scene.getEngine();return this._xrNavigator.xr.native?new QA(this):(e=e||Nf.GetDefaults(t),e.canvasElement=e.canvasElement||t.getRenderingCanvas()||void 0,new jA(this,e))}initializeAsync(){return this._xrNavigator=navigator,this._xrNavigator.xr?Promise.resolve():Promise.reject("WebXR not available")}initializeSessionAsync(e="immersive-vr",t={}){return this._xrNavigator.xr.requestSession(e,t).then(i=>(this.session=i,this._sessionMode=e,this.onXRSessionInit.notifyObservers(i),this.inXRSession=!0,this.session.addEventListener("end",()=>{var r;this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this._engine&&(this._engine.framebufferDimensionsObject=null,this._engine.restoreDefaultFramebuffer(),this._engine.customAnimationFrameRequester=null,this._engine._renderLoop()),this.isNative&&((r=this._baseLayerRTTProvider)===null||r===void 0||r.dispose()),this._baseLayerRTTProvider=null,this._baseLayerWrapper=null},{once:!0}),this.session))}isSessionSupportedAsync(e){return wf.IsSessionSupportedAsync(e)}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){var e;!this.inXRSession||!this._engine||(this._engine.customAnimationFrameRequester={requestAnimationFrame:this.session.requestAnimationFrame.bind(this.session),renderFunction:(t,i)=>{var r;!this.inXRSession||!this._engine||(this.currentFrame=i,this.currentTimestamp=t,i&&(this.inXRFrameLoop=!0,this._engine.framebufferDimensionsObject=((r=this._baseLayerRTTProvider)===null||r===void 0?void 0:r.getFramebufferDimensions())||null,this.onXRFrameObservable.notifyObservers(i),this._engine._renderLoop(),this._engine.framebufferDimensionsObject=null,this.inXRFrameLoop=!1))}},this._engine.framebufferDimensionsObject=((e=this._baseLayerRTTProvider)===null||e===void 0?void 0:e.getFramebufferDimensions())||null,typeof window<"u"&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())}setReferenceSpaceTypeAsync(e="local-floor"){return this.session.requestReferenceSpace(e).then(t=>t,t=>(X.Error("XR.requestReferenceSpace failed for the following reason: "),X.Error(t),X.Log('Defaulting to universally-supported "viewer" reference space type.'),this.session.requestReferenceSpace("viewer").then(i=>{const r=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return i.getOffsetReferenceSpace(r)},i=>{throw X.Error(i),'XR initialization failed: required "viewer" reference space type not supported.'}))).then(t=>this.session.requestReferenceSpace("viewer").then(i=>(this.viewerReferenceSpace=i,t))).then(t=>(this.referenceSpace=this.baseReferenceSpace=t,this.referenceSpace))}updateRenderStateAsync(e){return Promise.resolve(this.session.updateRenderState(e))}_setBaseLayerWrapper(e){var t,i;this.isNative&&((t=this._baseLayerRTTProvider)===null||t===void 0||t.dispose()),this._baseLayerWrapper=e,this._baseLayerRTTProvider=((i=this._baseLayerWrapper)===null||i===void 0?void 0:i.createRenderTargetTextureProvider(this))||null}updateRenderState(e){e.baseLayer&&this._setBaseLayerWrapper(this.isNative?new KA(e.baseLayer):new xm(e.baseLayer)),this.session.updateRenderState(e)}static IsSessionSupportedAsync(e){if(!navigator.xr)return Promise.resolve(!1);const t=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return t?t.call(navigator.xr,e).then(i=>{const r=typeof i>"u"?!0:i;return Promise.resolve(r)}).catch(i=>(X.Warn(i),Promise.resolve(!1))):Promise.resolve(!1)}get isNative(){var e;return(e=this._xrNavigator.xr.native)!==null&&e!==void 0?e:!1}get currentFrameRate(){var e;return(e=this.session)===null||e===void 0?void 0:e.frameRate}get supportedFrameRates(){var e;return(e=this.session)===null||e===void 0?void 0:e.supportedFrameRates}updateTargetFrameRate(e){return this.session.updateTargetFrameRate(e)}runInXRFrame(e,t=!0){this.inXRFrameLoop?e():(this.inXRSession||!t)&&this.onXRFrameObservable.addOnce(e)}get isFixedFoveationSupported(){var e;return((e=this._baseLayerWrapper)===null||e===void 0?void 0:e.isFixedFoveationSupported)||!1}get fixedFoveation(){var e;return((e=this._baseLayerWrapper)===null||e===void 0?void 0:e.fixedFoveation)||null}set fixedFoveation(e){const t=Math.max(0,Math.min(1,e||0));this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=t)}}var Hr;(function(o){o[o.ENTERING_XR=0]="ENTERING_XR",o[o.EXITING_XR=1]="EXITING_XR",o[o.IN_XR=2]="IN_XR",o[o.NOT_IN_XR=3]="NOT_IN_XR"})(Hr||(Hr={}));var Vc;(function(o){o[o.NOT_TRACKING=0]="NOT_TRACKING",o[o.TRACKING_LOST=1]="TRACKING_LOST",o[o.TRACKING=2]="TRACKING"})(Vc||(Vc={}));function GT(o){const e=o.height||2;let t=o.diameterTop===0?0:o.diameterTop||o.diameter||1,i=o.diameterBottom===0?0:o.diameterBottom||o.diameter||1;t=t||1e-5,i=i||1e-5;const r=o.tessellation||24,s=o.subdivisions||1,n=!!o.hasRings,a=!!o.enclose,l=o.cap===0?0:o.cap||K.CAP_ALL,c=o.arc&&(o.arc<=0||o.arc>1)?1:o.arc||1,h=o.sideOrientation===0?0:o.sideOrientation||Oe.DEFAULTSIDE,u=o.faceUV||new Array(3),d=o.faceColors,f=c!==1&&a?2:0,_=n?s:1,p=2+(1+f)*_;let m;for(m=0;m<p;m++)d&&d[m]===void 0&&(d[m]=new Ye(1,1,1,1));for(m=0;m<p;m++)u&&u[m]===void 0&&(u[m]=new Tt(0,0,1,1));const T=new Array,b=new Array,y=new Array,S=new Array,C=new Array,I=Math.PI*2*c/r;let P,D,w;const L=(i-t)/2/e,U=x.Zero(),G=x.Zero(),Z=x.Zero(),he=x.Zero(),_e=x.Zero(),ne=As.Y;let Pe,Se,ce,de=1,k=1,se=0,xe=0;for(Pe=0;Pe<=s;Pe++)for(D=Pe/s,w=(D*(t-i)+i)/2,de=n&&Pe!==0&&Pe!==s?2:1,ce=0;ce<de;ce++){for(n&&(k+=ce),a&&(k+=2*ce),Se=0;Se<=r;Se++)P=Se*I,U.x=Math.cos(-P)*w,U.y=-e/2+D*e,U.z=Math.sin(-P)*w,t===0&&Pe===s?(G.x=y[y.length-(r+1)*3],G.y=y[y.length-(r+1)*3+1],G.z=y[y.length-(r+1)*3+2]):(G.x=U.x,G.z=U.z,G.y=Math.sqrt(G.x*G.x+G.z*G.z)*L,G.normalize()),Se===0&&(Z.copyFrom(U),he.copyFrom(G)),b.push(U.x,U.y,U.z),y.push(G.x,G.y,G.z),n?xe=se!==k?u[k].y:u[k].w:xe=u[k].y+(u[k].w-u[k].y)*D,S.push(u[k].x+(u[k].z-u[k].x)*Se/r,Yt.UseOpenGLOrientationForUV?1-xe:xe),d&&C.push(d[k].r,d[k].g,d[k].b,d[k].a);c!==1&&a&&(b.push(U.x,U.y,U.z),b.push(0,U.y,0),b.push(0,U.y,0),b.push(Z.x,Z.y,Z.z),x.CrossToRef(ne,G,_e),_e.normalize(),y.push(_e.x,_e.y,_e.z,_e.x,_e.y,_e.z),x.CrossToRef(he,ne,_e),_e.normalize(),y.push(_e.x,_e.y,_e.z,_e.x,_e.y,_e.z),n?xe=se!==k?u[k+1].y:u[k+1].w:xe=u[k+1].y+(u[k+1].w-u[k+1].y)*D,S.push(u[k+1].x,Yt.UseOpenGLOrientationForUV?1-xe:xe),S.push(u[k+1].z,Yt.UseOpenGLOrientationForUV?1-xe:xe),n?xe=se!==k?u[k+2].y:u[k+2].w:xe=u[k+2].y+(u[k+2].w-u[k+2].y)*D,S.push(u[k+2].x,Yt.UseOpenGLOrientationForUV?1-xe:xe),S.push(u[k+2].z,Yt.UseOpenGLOrientationForUV?1-xe:xe),d&&(C.push(d[k+1].r,d[k+1].g,d[k+1].b,d[k+1].a),C.push(d[k+1].r,d[k+1].g,d[k+1].b,d[k+1].a),C.push(d[k+2].r,d[k+2].g,d[k+2].b,d[k+2].a),C.push(d[k+2].r,d[k+2].g,d[k+2].b,d[k+2].a))),se!==k&&(se=k)}const le=c!==1&&a?r+4:r;for(Pe=0,k=0;k<s;k++){let be=0,We=0,Ct=0,_t=0;for(Se=0;Se<r;Se++)be=Pe*(le+1)+Se,We=(Pe+1)*(le+1)+Se,Ct=Pe*(le+1)+(Se+1),_t=(Pe+1)*(le+1)+(Se+1),T.push(be,We,Ct),T.push(_t,Ct,We);c!==1&&a&&(T.push(be+2,We+2,Ct+2),T.push(_t+2,Ct+2,We+2),T.push(be+4,We+4,Ct+4),T.push(_t+4,Ct+4,We+4)),Pe=n?Pe+2:Pe+1}const je=be=>{const We=be?t/2:i/2;if(We===0)return;let Ct,_t,mt;const Ge=be?u[p-1]:u[0];let Ut=null;d&&(Ut=be?d[p-1]:d[0]);const Ft=b.length/3,Zt=be?e/2:-e/2,$t=new x(0,Zt,0);b.push($t.x,$t.y,$t.z),y.push(0,be?1:-1,0);const Di=Ge.y+(Ge.w-Ge.y)*.5;S.push(Ge.x+(Ge.z-Ge.x)*.5,Yt.UseOpenGLOrientationForUV?1-Di:Di),Ut&&C.push(Ut.r,Ut.g,Ut.b,Ut.a);const Ui=new Ie(.5,.5);for(mt=0;mt<=r;mt++){Ct=Math.PI*2*mt*c/r;const ar=Math.cos(-Ct),ti=Math.sin(-Ct);_t=new x(ar*We,Zt,ti*We);const or=new Ie(ar*Ui.x+.5,ti*Ui.y+.5);b.push(_t.x,_t.y,_t.z),y.push(0,be?1:-1,0);const pi=Ge.y+(Ge.w-Ge.y)*or.y;S.push(Ge.x+(Ge.z-Ge.x)*or.x,Yt.UseOpenGLOrientationForUV?1-pi:pi),Ut&&C.push(Ut.r,Ut.g,Ut.b,Ut.a)}for(mt=0;mt<r;mt++)be?(T.push(Ft),T.push(Ft+(mt+2)),T.push(Ft+(mt+1))):(T.push(Ft),T.push(Ft+(mt+1)),T.push(Ft+(mt+2)))};(l===K.CAP_START||l===K.CAP_ALL)&&je(!1),(l===K.CAP_END||l===K.CAP_ALL)&&je(!0),Oe._ComputeSides(h,b,T,y,S,o.frontUVs,o.backUVs);const st=new Oe;return st.indices=T,st.positions=b,st.normals=y,st.uvs=S,d&&(st.colors=C),st}function Ff(o,e={},t){const i=new K(o,t);return e.sideOrientation=K._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,GT(e).applyToMesh(i,e.updatable),i}Oe.CreateCylinder=GT;K.CreateCylinder=(o,e,t,i,r,s,n,a,l)=>((n===void 0||!(n instanceof Ne))&&(n!==void 0&&(l=a||K.DEFAULTSIDE,a=n),n=s,s=1),Ff(o,{height:e,diameterTop:t,diameterBottom:i,tessellation:r,subdivisions:s,sideOrientation:l,updatable:a},n));function zT(o){const e=[],t=[],i=[],r=[],s=o.diameter||1,n=o.thickness||.5,a=o.tessellation||16,l=o.sideOrientation===0?0:o.sideOrientation||Oe.DEFAULTSIDE,c=a+1;for(let u=0;u<=a;u++){const d=u/a,f=u*Math.PI*2/a-Math.PI/2,_=H.Translation(s/2,0,0).multiply(H.RotationY(f));for(let p=0;p<=a;p++){const m=1-p/a,T=p*Math.PI*2/a+Math.PI,b=Math.cos(T),y=Math.sin(T);let S=new x(b,y,0),C=S.scale(n/2);const I=new Ie(d,m);C=x.TransformCoordinates(C,_),S=x.TransformNormal(S,_),t.push(C.x,C.y,C.z),i.push(S.x,S.y,S.z),r.push(I.x,Yt.UseOpenGLOrientationForUV?1-I.y:I.y);const P=(u+1)%c,D=(p+1)%c;e.push(u*c+p),e.push(u*c+D),e.push(P*c+p),e.push(u*c+D),e.push(P*c+D),e.push(P*c+p)}}Oe._ComputeSides(l,t,e,i,r,o.frontUVs,o.backUVs);const h=new Oe;return h.indices=e,h.positions=t,h.normals=i,h.uvs=r,h}function ah(o,e={},t){const i=new K(o,t);return e.sideOrientation=K._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,zT(e).applyToMesh(i,e.updatable),i}Oe.CreateTorus=zT;K.CreateTorus=(o,e,t,i,r,s,n)=>ah(o,{diameter:e,thickness:t,tessellation:i,sideOrientation:n,updatable:s},r);K._GroundMeshParser=(o,e)=>Vu.Parse(o,e);class Vu extends K{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);const i=this;i.createOrUpdateSubmeshesOctree&&i.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){const i=this.getWorldMatrix(),r=j.Matrix[5];i.invertToRef(r);const s=j.Vector3[8];if(x.TransformCoordinatesFromFloatsToRef(e,0,t,r,s),e=s.x,t=s.z,e<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const n=this._getFacetAt(e,t),a=-(n.x*e+n.z*t+n.w)/n.y;return x.TransformCoordinatesFromFloatsToRef(0,a,0,i,s),s.y}getNormalAtCoordinates(e,t){const i=new x(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){const r=this.getWorldMatrix(),s=j.Matrix[5];r.invertToRef(s);const n=j.Vector3[8];if(x.TransformCoordinatesFromFloatsToRef(e,0,t,s,n),e=n.x,t=n.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const a=this._getFacetAt(e,t);return x.TransformNormalFromFloatsToRef(a.x,a.y,a.z,r,i),this}updateCoordinateHeights(){return(!this._heightQuads||this._heightQuads.length==0)&&this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){const i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),r=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),s=this._heightQuads[r*this._subdivisionsX+i];let n;return t<s.slope.x*e+s.slope.y?n=s.facet1:n=s.facet2,n}_initHeightQuads(){const e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=new Array;for(let i=0;i<t;i++)for(let r=0;r<e;r++){const s={slope:Ie.Zero(),facet1:new Tt(0,0,0,0),facet2:new Tt(0,0,0,0)};this._heightQuads[i*e+r]=s}return this}_computeHeightQuads(){const e=this.getVerticesData(O.PositionKind);if(!e)return this;const t=j.Vector3[3],i=j.Vector3[2],r=j.Vector3[1],s=j.Vector3[0],n=j.Vector3[4],a=j.Vector3[5],l=j.Vector3[6],c=j.Vector3[7],h=j.Vector3[8];let u=0,d=0,f=0,_=0,p=0,m=0,T=0;const b=this._subdivisionsX,y=this._subdivisionsY;for(let S=0;S<y;S++)for(let C=0;C<b;C++){u=C*3,d=S*(b+1)*3,f=(S+1)*(b+1)*3,t.x=e[d+u],t.y=e[d+u+1],t.z=e[d+u+2],i.x=e[d+u+3],i.y=e[d+u+4],i.z=e[d+u+5],r.x=e[f+u],r.y=e[f+u+1],r.z=e[f+u+2],s.x=e[f+u+3],s.y=e[f+u+4],s.z=e[f+u+5],_=(s.z-t.z)/(s.x-t.x),p=t.z-_*t.x,i.subtractToRef(t,n),r.subtractToRef(t,a),s.subtractToRef(t,l),x.CrossToRef(l,a,c),x.CrossToRef(n,l,h),c.normalize(),h.normalize(),m=-(c.x*t.x+c.y*t.y+c.z*t.z),T=-(h.x*i.x+h.y*i.y+h.z*i.z);const I=this._heightQuads[S*b+C];I.slope.copyFromFloats(_,p),I.facet1.copyFromFloats(c.x,c.y,c.z,m),I.facet2.copyFromFloats(h.x,h.y,h.z,T)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){const i=new Vu(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}}function HT(o){const e=[],t=[],i=[],r=[];let s,n;const a=o.width||1,l=o.height||1,c=o.subdivisionsX||o.subdivisions||1,h=o.subdivisionsY||o.subdivisions||1;for(s=0;s<=h;s++)for(n=0;n<=c;n++){const d=new x(n*a/c-a/2,0,(h-s)*l/h-l/2),f=new x(0,1,0);t.push(d.x,d.y,d.z),i.push(f.x,f.y,f.z),r.push(n/c,Yt.UseOpenGLOrientationForUV?s/h:1-s/h)}for(s=0;s<h;s++)for(n=0;n<c;n++)e.push(n+1+(s+1)*(c+1)),e.push(n+1+s*(c+1)),e.push(n+s*(c+1)),e.push(n+(s+1)*(c+1)),e.push(n+1+(s+1)*(c+1)),e.push(n+s*(c+1));const u=new Oe;return u.indices=e,u.positions=t,u.normals=i,u.uvs=r,u}function WT(o){const e=o.xmin!==void 0&&o.xmin!==null?o.xmin:-1,t=o.zmin!==void 0&&o.zmin!==null?o.zmin:-1,i=o.xmax!==void 0&&o.xmax!==null?o.xmax:1,r=o.zmax!==void 0&&o.zmax!==null?o.zmax:1,s=o.subdivisions||{w:1,h:1},n=o.precision||{w:1,h:1},a=new Array,l=new Array,c=new Array,h=new Array;let u,d,f,_;s.h=s.h<1?1:s.h,s.w=s.w<1?1:s.w,n.w=n.w<1?1:n.w,n.h=n.h<1?1:n.h;const p={w:(i-e)/s.w,h:(r-t)/s.h};function m(b,y,S,C){const I=l.length/3,P=n.w+1;for(u=0;u<n.h;u++)for(d=0;d<n.w;d++){const L=[I+d+u*P,I+(d+1)+u*P,I+(d+1)+(u+1)*P,I+d+(u+1)*P];a.push(L[1]),a.push(L[2]),a.push(L[3]),a.push(L[0]),a.push(L[1]),a.push(L[3])}const D=x.Zero(),w=new x(0,1,0);for(u=0;u<=n.h;u++)for(D.z=u*(C-y)/n.h+y,d=0;d<=n.w;d++)D.x=d*(S-b)/n.w+b,D.y=0,l.push(D.x,D.y,D.z),c.push(w.x,w.y,w.z),h.push(d/n.w,u/n.h)}for(f=0;f<s.h;f++)for(_=0;_<s.w;_++)m(e+_*p.w,t+f*p.h,e+(_+1)*p.w,t+(f+1)*p.h);const T=new Oe;return T.indices=a,T.positions=l,T.normals=c,T.uvs=h,T}function XT(o){const e=[],t=[],i=[],r=[];let s,n;const a=o.colorFilter||new ge(.3,.59,.11),l=o.alphaFilter||0;let c=!1;if(o.minHeight>o.maxHeight){c=!0;const u=o.maxHeight;o.maxHeight=o.minHeight,o.minHeight=u}for(s=0;s<=o.subdivisions;s++)for(n=0;n<=o.subdivisions;n++){const u=new x(n*o.width/o.subdivisions-o.width/2,0,(o.subdivisions-s)*o.height/o.subdivisions-o.height/2),d=(u.x+o.width/2)/o.width*(o.bufferWidth-1)|0,f=(1-(u.z+o.height/2)/o.height)*(o.bufferHeight-1)|0,_=(d+f*o.bufferWidth)*4;let p=o.buffer[_]/255,m=o.buffer[_+1]/255,T=o.buffer[_+2]/255;const b=o.buffer[_+3]/255;c&&(p=1-p,m=1-m,T=1-T);const y=p*a.r+m*a.g+T*a.b;b>=l?u.y=o.minHeight+(o.maxHeight-o.minHeight)*y:u.y=o.minHeight-kt,t.push(u.x,u.y,u.z),i.push(0,0,0),r.push(n/o.subdivisions,1-s/o.subdivisions)}for(s=0;s<o.subdivisions;s++)for(n=0;n<o.subdivisions;n++){const u=n+1+(s+1)*(o.subdivisions+1),d=n+1+s*(o.subdivisions+1),f=n+s*(o.subdivisions+1),_=n+(s+1)*(o.subdivisions+1),p=t[u*3+1]>=o.minHeight,m=t[d*3+1]>=o.minHeight,T=t[f*3+1]>=o.minHeight;p&&m&&T&&(e.push(u),e.push(d),e.push(f)),t[_*3+1]>=o.minHeight&&p&&T&&(e.push(_),e.push(u),e.push(f))}Oe.ComputeNormals(t,e,i);const h=new Oe;return h.indices=e,h.positions=t,h.normals=i,h.uvs=r,h}function Tm(o,e={},t){const i=new Vu(o,t);return i._setReady(!1),i._subdivisionsX=e.subdivisionsX||e.subdivisions||1,i._subdivisionsY=e.subdivisionsY||e.subdivisions||1,i._width=e.width||1,i._height=e.height||1,i._maxX=i._width/2,i._maxZ=i._height/2,i._minX=-i._maxX,i._minZ=-i._maxZ,HT(e).applyToMesh(i,e.updatable),i._setReady(!0),i}function ZA(o,e,t=null){const i=new K(o,t);return WT(e).applyToMesh(i,e.updatable),i}function JA(o,e,t={},i=null){const r=t.width||10,s=t.height||10,n=t.subdivisions||1,a=t.minHeight||0,l=t.maxHeight||1,c=t.colorFilter||new ge(.3,.59,.11),h=t.alphaFilter||0,u=t.updatable,d=t.onReady;i=i||qe.LastCreatedScene;const f=new Vu(o,i);f._subdivisionsX=n,f._subdivisionsY=n,f._width=r,f._height=s,f._maxX=f._width/2,f._maxZ=f._height/2,f._minX=-f._maxX,f._minZ=-f._maxZ,f._setReady(!1);const _=p=>{const m=p.width,T=p.height;if(i.isDisposed)return;const b=i==null?void 0:i.getEngine().resizeImageBitmap(p,m,T);XT({width:r,height:s,subdivisions:n,minHeight:a,maxHeight:l,colorFilter:c,buffer:b,bufferWidth:m,bufferHeight:T,alphaFilter:h}).applyToMesh(f,u),d&&d(f),f._setReady(!0)};return J.LoadImage(e,_,()=>{},i.offlineProvider),f}Oe.CreateGround=HT;Oe.CreateTiledGround=WT;Oe.CreateGroundFromHeightMap=XT;K.CreateGround=(o,e,t,i,r,s)=>Tm(o,{width:e,height:t,subdivisions:i,updatable:s},r);K.CreateTiledGround=(o,e,t,i,r,s,n,a,l)=>ZA(o,{xmin:e,zmin:t,xmax:i,zmax:r,subdivisions:s,precision:n,updatable:l},a);K.CreateGroundFromHeightMap=(o,e,t,i,r,s,n,a,l,c,h)=>JA(o,e,{width:t,height:i,subdivisions:r,minHeight:s,maxHeight:n,updatable:l,onReady:c,alphaFilter:h},a);class ku{constructor(e,t=null){if(this.scene=e,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=ku._IdCounter++,t)this._gazeTracker=t.clone("gazeTracker");else{this._gazeTracker=ah("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},e),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;const i=new Be("targetMat",e);i.specularColor=ge.Black(),i.emissiveColor=new ge(.7,.7,.7),i.backFaceCulling=!1,this._gazeTracker.material=i}}_getForwardRay(e){return new Pt(x.Zero(),new x(0,0,e))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(e=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}ku._IdCounter=0;class eR extends ku{constructor(e,t,i){super(t,i),this.webVRController=e,this._laserPointer=Ff("laserPointer",{updatable:!1,height:1,diameterTop:.004,diameterBottom:2e-4,tessellation:20,subdivisions:1},t);const r=new Be("laserPointerMat",t);if(r.emissiveColor=new ge(.7,.7,.7),r.alpha=.6,this._laserPointer.material=r,this._laserPointer.rotation.x=Math.PI/2,this._laserPointer.position.z=-.5,this._laserPointer.isVisible=!1,this._laserPointer.isPickable=!1,!e.mesh){const s=new K("preloadControllerMesh",t),n=new K(xu.POINTING_POSE,t);n.rotation.x=-.7,s.addChild(n),e.attachToMesh(s)}this._setLaserPointerParent(e.mesh),this._meshAttachedObserver=e._meshAttachedObservable.add(s=>{this._setLaserPointerParent(s)})}_getForwardRay(e){return this.webVRController.getForwardRay(e)}_activatePointer(){super._activatePointer(),this._laserPointer.isVisible=!0}_deactivatePointer(){super._deactivatePointer(),this._laserPointer.isVisible=!1}_setLaserPointerColor(e){this._laserPointer.material.emissiveColor=e}_setLaserPointerLightingDisabled(e){this._laserPointer.material.disableLighting=e}_setLaserPointerParent(e){const t=s=>{s.isPickable=!1,s.getChildMeshes().forEach(n=>{t(n)})};t(e);const i=e.getChildren(void 0,!1);let r=e;this.webVRController._pointingPoseNode=null;for(let s=0;s<i.length;s++)if(i[s].name&&i[s].name.indexOf(xu.POINTING_POSE)>=0){r=i[s],this.webVRController._pointingPoseNode=r;break}this._laserPointer.parent=r}_updatePointerDistance(e=100){this._laserPointer.scaling.y=e,this._laserPointer.position.z=-e/2}dispose(){super.dispose(),this._laserPointer.dispose(),this._meshAttachedObserver&&this.webVRController._meshAttachedObservable.remove(this._meshAttachedObserver)}}class _v extends ku{constructor(e,t){super(t),this._getCamera=e}_getForwardRay(e){const t=this._getCamera();return t?t.getForwardRay(e):new Pt(x.Zero(),x.Forward())}}class oh{get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get onControllerMeshLoaded(){return this.onControllerMeshLoadedObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(e){e&&(e.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=e)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(e){e&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._leftController&&this._leftController._gazeTracker&&this._leftController._gazeTracker.dispose(),this._rightController&&this._rightController._gazeTracker&&this._rightController._gazeTracker.dispose(),this._cameraGazer._gazeTracker=e,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker",this._leftController&&(this._leftController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")),this._rightController&&(this._rightController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")))}get leftControllerGazeTrackerMesh(){return this._leftController?this._leftController._gazeTracker:null}get rightControllerGazeTrackerMesh(){return this._rightController?this._rightController._gazeTracker:null}get displayGaze(){return this._displayGaze}set displayGaze(e){this._displayGaze=e,e||(this._cameraGazer._gazeTracker.isVisible=!1,this._leftController&&(this._leftController._gazeTracker.isVisible=!1),this._rightController&&(this._rightController._gazeTracker.isVisible=!1))}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(e){this._displayLaserPointer=e,e?(this._rightController&&this._rightController._activatePointer(),this._leftController&&this._leftController._activatePointer()):(this._rightController&&(this._rightController._deactivatePointer(),this._rightController._gazeTracker.isVisible=!1),this._leftController&&(this._leftController._deactivatePointer(),this._leftController._gazeTracker.isVisible=!1))}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._webVRready?this._webVRCamera:this._scene.activeCamera}get webVRCamera(){return this._webVRCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated||this._leftController!==null&&this._leftController._teleportationRequestInitiated||this._rightController!==null&&this._rightController._teleportationRequestInitiated}constructor(e,t={}){if(this.webVROptions=t,this._webVRsupported=!1,this._webVRready=!1,this._webVRrequesting=!1,this._webVRpresenting=!1,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new Q,this.onAfterEnteringVRObservable=new Q,this.onExitingVRObservable=new Q,this.onControllerMeshLoadedObservable=new Q,this._useCustomVRButton=!1,this._teleportationRequested=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=oh.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new x(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new x(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._leftController=null,this._rightController=null,this._gazeColor=new ge(.7,.7,.7),this._laserColor=new ge(.7,.7,.7),this._pickedLaserColor=new ge(.2,.2,1),this._pickedGazeColor=new ge(0,0,1),this.onNewMeshSelected=new Q,this.onMeshSelectedWithController=new Q,this.onNewMeshPicked=new Q,this.onBeforeCameraTeleport=new Q,this.onAfterCameraTeleport=new Q,this.onSelectedMeshUnselected=new Q,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._interactionsRequested=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight(),this._fullscreenVRpresenting&&this._webVRready&&this.exitVR()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._leftController&&this._leftController._activePointer&&this._castRayAndSelectObject(this._leftController),this._rightController&&this._rightController._activePointer&&this._castRayAndSelectObject(this._rightController),this._noControllerIsActive&&(this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock)?this._castRayAndSelectObject(this._cameraGazer):this._cameraGazer._gazeTracker.isVisible=!1},this._onNewGamepadConnected=r=>{if(r.type!==Tr.POSE_ENABLED)r.leftStick&&r.onleftstickchanged(s=>{this._teleportationInitialized&&this.teleportationEnabled&&(!this._leftController&&!this._rightController||this._leftController&&!this._leftController._activePointer&&this._rightController&&!this._rightController._activePointer)&&(this._checkTeleportWithRay(s,this._cameraGazer),this._checkTeleportBackwards(s,this._cameraGazer))}),r.rightStick&&r.onrightstickchanged(s=>{this._teleportationInitialized&&this._checkRotate(s,this._cameraGazer)}),r.type===Tr.XBOX&&(r.onbuttondown(s=>{this._interactionsEnabled&&s===Xn.A&&this._cameraGazer._selectionPointerDown()}),r.onbuttonup(s=>{this._interactionsEnabled&&s===Xn.A&&this._cameraGazer._selectionPointerUp()}));else{const s=r,n=new eR(s,this._scene,this._cameraGazer._gazeTracker);s.hand==="right"||this._leftController&&this._leftController.webVRController!=s?this._rightController=n:this._leftController=n,this._tryEnableInteractionOnController(n)}},this._tryEnableInteractionOnController=r=>{this._interactionsRequested&&!r._interactionsEnabled&&this._enableInteractionOnController(r),this._teleportationRequested&&!r._teleportationEnabled&&this._enableTeleportationOnController(r)},this._onNewGamepadDisconnected=r=>{r instanceof vc&&(r.hand==="left"&&this._leftController!=null&&(this._leftController.dispose(),this._leftController=null),r.hand==="right"&&this._rightController!=null&&(this._rightController.dispose(),this._rightController=null))},this._workingVector=x.Zero(),this._workingQuaternion=oe.Identity(),this._workingMatrix=H.Identity(),X.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=e,this._inputElement=e.getEngine().getInputElement(),!("getVRDisplays"in navigator)&&t.useXR===void 0&&(t.useXR=!0),t.createFallbackVRDeviceOrientationFreeCamera===void 0&&(t.createFallbackVRDeviceOrientationFreeCamera=!0),t.createDeviceOrientationCamera===void 0&&(t.createDeviceOrientationCamera=!0),t.laserToggle===void 0&&(t.laserToggle=!0),t.defaultHeight===void 0&&(t.defaultHeight=1.7),t.useCustomVRButton&&(this._useCustomVRButton=!0,t.customVRButton&&(this._btnVR=t.customVRButton)),t.rayLength&&(this._rayLength=t.rayLength),this._defaultHeight=t.defaultHeight,t.positionScale&&(this._rayLength*=t.positionScale,this._defaultHeight*=t.positionScale),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new x(0,this._defaultHeight,0),t.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new dm("deviceOrientationVRHelper",this._position.clone(),e),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof xr&&this._scene.activeCamera.rotation)){const r=this._scene.activeCamera;r.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(r.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(oe.RotationYawPitchRoll(r.rotation.y,r.rotation.x,r.rotation.z)),this._deviceOrientationCamera.rotation=r.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?wf.IsSessionSupportedAsync("immersive-vr").then(r=>{r?(X.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),e.createDefaultXRExperienceAsync({floorMeshes:t.floorMeshes||[]}).then(s=>{this.xr=s,this.xrTestDone=!0,this._cameraGazer=new _v(()=>this.xr.baseExperience.camera,e),this.xr.baseExperience.onStateChangedObservable.add(n=>{switch(n){case Hr.ENTERING_XR:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case Hr.EXITING_XR:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case Hr.IN_XR:this._hasEnteredVR=!0;break;case Hr.NOT_IN_XR:this._hasEnteredVR=!1;break}})})):this._completeVRInit(e,t)}):this._completeVRInit(e,t)}_completeVRInit(e,t){if(this.xrTestDone=!0,t.createFallbackVRDeviceOrientationFreeCamera&&(t.useMultiview&&(t.vrDeviceOrientationCameraMetrics||(t.vrDeviceOrientationCameraMetrics=gc.GetDefault()),t.vrDeviceOrientationCameraMetrics.multiviewEnabled=!0),this._vrDeviceOrientationCamera=new pm("VRDeviceOrientationVRHelper",this._position,this._scene,!0,t.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._webVRCamera=new mm("WebVRHelper",this._position,this._scene,t),this._webVRCamera.useStandingMatrix(),this._cameraGazer=new _v(()=>this.currentVRCamera,e),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";let s=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";s+=".babylonVRicon.vrdisplaypresenting { display: none; }";const n=document.createElement("style");n.appendChild(document.createTextNode(s)),document.getElementsByTagName("head")[0].appendChild(n),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",()=>{this.isInVRMode?this._scene.getEngine().disableVR():this.enterVR()});const i=this._scene.getEngine().getHostWindow();i&&(i.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),t.createFallbackVRDeviceOrientationFreeCamera?this._displayVRButton():this._scene.getEngine().onVRDisplayChangedObservable.add(r=>{r.vrDisplay&&this._displayVRButton()}),this._onKeyDown=r=>{r.keyCode===27&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add(()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())},Qe.POINTERDOUBLETAP,!1),this._onVRDisplayChangedBind=r=>this._onVRDisplayChanged(r),this._onVrDisplayPresentChangeBind=()=>this._onVrDisplayPresentChange(),this._onVRRequestPresentStart=()=>{this._webVRrequesting=!0,this._updateButtonVisibility()},this._onVRRequestPresentComplete=()=>{this._webVRrequesting=!1,this._updateButtonVisibility()},e.getEngine().onVRDisplayChangedObservable.add(this._onVRDisplayChangedBind),e.getEngine().onVRRequestPresentStart.add(this._onVRRequestPresentStart),e.getEngine().onVRRequestPresentComplete.add(this._onVRRequestPresentComplete),i.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),e.onDisposeObservable.add(()=>{this.dispose()}),this._webVRCamera.onControllerMeshLoadedObservable.add(r=>this._onDefaultMeshLoaded(r)),this._scene.gamepadManager.onGamepadConnectedObservable.add(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.add(this._onNewGamepadDisconnected),this._updateButtonVisibility(),this._circleEase=new _S,this._circleEase.setEasingMode(xs.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,e.onPointerObservable.add(r=>{this._interactionsEnabled&&e.activeCamera===this.vrDeviceOrientationCamera&&r.event.pointerType==="mouse"&&(r.type===Qe.POINTERDOWN?this._cameraGazer._selectionPointerDown():r.type===Qe.POINTERUP&&this._cameraGazer._selectionPointerUp())}),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}_onDefaultMeshLoaded(e){this._leftController&&this._leftController.webVRController==e&&e.mesh&&this._leftController._setLaserPointerParent(e.mesh),this._rightController&&this._rightController.webVRController==e&&e.mesh&&this._rightController._setLaserPointerParent(e.mesh);try{this.onControllerMeshLoadedObservable.notifyObservers(e)}catch(t){X.Warn("Error in your custom logic onControllerMeshLoaded: "+t)}}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&this.xr.baseExperience.state===Hr.IN_XR||this._webVRpresenting||this._fullscreenVRpresenting}_onVrDisplayPresentChange(){const e=this._scene.getEngine().getVRDevice();if(e){const t=this._webVRpresenting;this._webVRpresenting=e.isPresenting,t&&!this._webVRpresenting&&this.exitVR()}else X.Warn("Detected VRDisplayPresentChange on an unknown VRDisplay. Did you can enterVR on the vrExperienceHelper?");this._updateButtonVisibility()}_onVRDisplayChanged(e){this._webVRsupported=e.vrSupported,this._webVRready=!!e.vrDisplay,this._webVRpresenting=e.vrDisplay&&e.vrDisplay.isPresenting,this._updateButtonVisibility()}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){const e=this._inputElement.getBoundingClientRect();this._btnVR.style.top=e.top+e.height-70+"px",this._btnVR.style.left=e.left+e.width-100+"px"}}_displayVRButton(){!this._useCustomVRButton&&!this._btnVRDisplayed&&this._btnVR&&(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){!this._btnVR||this._useCustomVRButton||(this._btnVR.className="babylonVRicon",this.isInVRMode?this._btnVR.className+=" vrdisplaypresenting":(this._webVRready&&(this._btnVR.className+=" vrdisplayready"),this._webVRsupported&&(this._btnVR.className+=" vrdisplaysupported"),this._webVRrequesting&&(this._btnVR.className+=" vrdisplayrequesting")))}enterVR(){if(this.xr){this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);return}if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(e){X.Warn("Error in your custom logic onEnteringVR: "+e)}if(this._scene.activeCamera){if(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=oe.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this.webVRCamera){const e=this.webVRCamera.deviceRotationQuaternion.toEulerAngles().y,i=oe.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles().y-e,r=this.webVRCamera.rotationQuaternion.toEulerAngles().y;this.webVRCamera.rotationQuaternion=oe.FromEulerAngles(0,r+i,0)}this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)}this._webVRrequesting||(this._webVRready?this._webVRpresenting||(this._scene.getEngine().onVRRequestPresentComplete.addOnce(e=>{this.onAfterEnteringVRObservable.notifyObservers({success:e})}),this._webVRCamera.position=this._position,this._scene.activeCamera=this._webVRCamera):this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce(()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})})),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._displayLaserPointer&&[this._leftController,this._rightController].forEach(e=>{e&&e._activatePointer()}),this._hasEnteredVR=!0)}exitVR(){if(this.xr){this.xr.baseExperience.exitXRAsync();return}if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(t){X.Warn("Error in your custom logic onExitingVR: "+t)}this._webVRpresenting&&this._scene.getEngine().disableVR(),this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1,this._leftController&&(this._leftController._gazeTracker.isVisible=!1),this._rightController&&(this._rightController._gazeTracker.isVisible=!1)),this._scene.getEngine().resize(),[this._leftController,this._rightController].forEach(t=>{t&&t._deactivatePointer()}),this._hasEnteredVR=!1;const e=this._scene.getEngine();e._onVrDisplayPresentChange&&e._onVrDisplayPresentChange()}}get position(){return this._position}set position(e){this._position=e,this._scene.activeCamera&&(this._scene.activeCamera.position=e)}enableInteractions(){if(!this._interactionsEnabled){if(this._interactionsRequested=!0,this.xr){this.xr.baseExperience.state===Hr.IN_XR&&this.xr.pointerSelection.attach();return}this._leftController&&this._enableInteractionOnController(this._leftController),this._rightController&&this._enableInteractionOnController(this._rightController),this.raySelectionPredicate=e=>e.isVisible&&(e.isPickable||e.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=e=>this._isTeleportationFloor(e)||e.name.indexOf("gazeTracker")===-1&&e.name.indexOf("teleportationTarget")===-1&&e.name.indexOf("torusTeleportation")===-1?this.raySelectionPredicate(e):!1,this._interactionsEnabled=!0}}get _noControllerIsActive(){return!(this._leftController&&this._leftController._activePointer)&&!(this._rightController&&this._rightController._activePointer)}_isTeleportationFloor(e){for(let t=0;t<this._floorMeshesCollection.length;t++)if(this._floorMeshesCollection[t].id===e.id)return!0;return!!(this._floorMeshName&&e.name===this._floorMeshName)}addFloorMesh(e){this._floorMeshesCollection&&(this._floorMeshesCollection.indexOf(e)>-1||this._floorMeshesCollection.push(e))}removeFloorMesh(e){if(!this._floorMeshesCollection)return;const t=this._floorMeshesCollection.indexOf(e);t!==-1&&this._floorMeshesCollection.splice(t,1)}enableTeleportation(e={}){if(!this._teleportationInitialized){if(this._teleportationRequested=!0,this.enableInteractions(),this.webVROptions.useXR&&(e.floorMeshes||e.floorMeshName)){const i=e.floorMeshes||[];if(!i.length){const r=this._scene.getMeshByName(e.floorMeshName);r&&i.push(r)}if(this.xr){i.forEach(r=>{this.xr.teleportation.addFloorMesh(r)}),this.xr.teleportation.attached||this.xr.teleportation.attach();return}else if(!this.xrTestDone){const r=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(r),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(e))};this._scene.registerBeforeRender(r);return}}e.floorMeshName&&(this._floorMeshName=e.floorMeshName),e.floorMeshes&&(this._floorMeshesCollection=e.floorMeshes),e.teleportationMode&&(this._teleportationMode=e.teleportationMode),e.teleportationTime&&e.teleportationTime>0&&(this._teleportationTime=e.teleportationTime),e.teleportationSpeed&&e.teleportationSpeed>0&&(this._teleportationSpeed=e.teleportationSpeed),e.easingFunction!==void 0&&(this._teleportationEasing=e.easingFunction),this._leftController!=null&&this._enableTeleportationOnController(this._leftController),this._rightController!=null&&this._enableTeleportationOnController(this._rightController);const t=new wt;t.vignetteColor=new Ye(0,0,0,0),t.vignetteEnabled=!0,this._postProcessMove=new Df("postProcessMove",1,this._webVRCamera,void 0,void 0,void 0,void 0,t),this._webVRCamera.detachPostProcess(this._postProcessMove),this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&(this._createTeleportationCircles(),this._teleportationTarget.scaling.scaleInPlace(this._webVRCamera.deviceScaleFactor))}}_enableInteractionOnController(e){e.webVRController.mesh&&(e._interactionsEnabled=!0,this.isInVRMode&&this._displayLaserPointer&&e._activatePointer(),this.webVROptions.laserToggle&&e.webVRController.onMainButtonStateChangedObservable.add(i=>{this._displayLaserPointer&&i.value===1&&(e._activePointer?e._deactivatePointer():e._activatePointer(),this.displayGaze&&(e._gazeTracker.isVisible=e._activePointer))}),e.webVRController.onTriggerStateChangedObservable.add(i=>{let r=e;this._noControllerIsActive&&(r=this._cameraGazer),r._pointerDownOnMeshAsked?i.value<this._padSensibilityDown&&r._selectionPointerUp():i.value>this._padSensibilityUp&&r._selectionPointerDown()}))}_checkTeleportWithRay(e,t){this._teleportationRequestInitiated&&!t._teleportationRequestInitiated||(t._teleportationRequestInitiated?Math.sqrt(e.y*e.y+e.x*e.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),t._teleportationRequestInitiated=!1):e.y<-this._padSensibilityUp&&t._dpadPressed&&(t._activatePointer(),t._teleportationRequestInitiated=!0))}_checkRotate(e,t){t._teleportationRequestInitiated||(t._rotationLeftAsked?e.x>-this._padSensibilityDown&&(t._rotationLeftAsked=!1):e.x<-this._padSensibilityUp&&t._dpadPressed&&(t._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),t._rotationRightAsked?e.x<this._padSensibilityDown&&(t._rotationRightAsked=!1):e.x>this._padSensibilityUp&&t._dpadPressed&&(t._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(e,t){if(!t._teleportationRequestInitiated)if(e.y>this._padSensibilityUp&&t._dpadPressed){if(!t._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;let i=oe.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),r=this.currentVRCamera.position;this.currentVRCamera.devicePosition&&this.currentVRCamera.deviceRotationQuaternion&&(i=this.currentVRCamera.deviceRotationQuaternion,r=this.currentVRCamera.devicePosition),i.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,oe.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),x.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);const s=new Pt(r,this._workingVector),n=this._scene.pickWithRay(s,this._raySelectionPredicate);n&&n.pickedPoint&&n.pickedMesh&&this._isTeleportationFloor(n.pickedMesh)&&n.distance<5&&this.teleportCamera(n.pickedPoint),t._teleportationBackRequestInitiated=!0}}else t._teleportationBackRequestInitiated=!1}_enableTeleportationOnController(e){e.webVRController.mesh&&(e._interactionsEnabled||this._enableInteractionOnController(e),e._interactionsEnabled=!0,e._teleportationEnabled=!0,e.webVRController.controllerType===To.VIVE&&(e._dpadPressed=!1,e.webVRController.onPadStateChangedObservable.add(i=>{e._dpadPressed=i.pressed,e._dpadPressed||(e._rotationLeftAsked=!1,e._rotationRightAsked=!1,e._teleportationBackRequestInitiated=!1)})),e.webVRController.onPadValuesChangedObservable.add(i=>{this.teleportationEnabled&&(this._checkTeleportBackwards(i,e),this._checkTeleportWithRay(i,e)),this._checkRotate(i,e)}))}_createTeleportationCircles(){this._teleportationTarget=Tm("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;const e=512,t=new za("DynamicTexture",e,this._scene,!0);t.hasAlpha=!0;const i=t.getContext(),r=e/2,s=e/2,n=200;i.beginPath(),i.arc(r,s,n,0,2*Math.PI,!1),i.fillStyle=this._teleportationFillColor,i.fill(),i.lineWidth=10,i.strokeStyle=this._teleportationBorderColor,i.stroke(),i.closePath(),t.update();const a=new Be("TextPlaneMaterial",this._scene);a.diffuseTexture=t,this._teleportationTarget.material=a;const l=ah("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);l.isPickable=!1,l.parent=this._teleportationTarget;const c=new ae("animationInnerCircle","position.y",30,ae.ANIMATIONTYPE_FLOAT,ae.ANIMATIONLOOPMODE_CYCLE),h=[];h.push({frame:0,value:0}),h.push({frame:30,value:.4}),h.push({frame:60,value:0}),c.setKeys(h);const u=new fT;u.setEasingMode(xs.EASINGMODE_EASEINOUT),c.setEasingFunction(u),l.animations=[],l.animations.push(c),this._scene.beginAnimation(l,0,60,!0),this._hideTeleportationTarget()}_displayTeleportationTarget(){this._teleportActive=!0,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!0,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!0))}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(e){if(!(this.currentVRCamera instanceof Qs))return;e?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];const t=oe.FromRotationMatrix(H.RotationY(Math.PI/4*this._rotationAngle)),i=new ae("animationRotation","rotationQuaternion",90,ae.ANIMATIONTYPE_QUATERNION,ae.ANIMATIONLOOPMODE_CONSTANT),r=[];r.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),r.push({frame:6,value:t}),i.setKeys(r),i.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(i),this._postProcessMove.animations=[];const s=new ae("animationPP","vignetteWeight",90,ae.ANIMATIONTYPE_FLOAT,ae.ANIMATIONLOOPMODE_CONSTANT),n=[];n.push({frame:0,value:0}),n.push({frame:3,value:4}),n.push({frame:6,value:0}),s.setKeys(n),s.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(s);const a=new ae("animationPP2","vignetteStretch",90,ae.ANIMATIONTYPE_FLOAT,ae.ANIMATIONLOOPMODE_CONSTANT),l=[];l.push({frame:0,value:0}),l.push({frame:3,value:10}),l.push({frame:6,value:0}),a.setKeys(l),a.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(a),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,6,!1,1,()=>{this._webVRCamera.detachPostProcess(this._postProcessMove)}),this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}_moveTeleportationSelectorTo(e,t,i){if(e.pickedPoint){t._teleportationRequestInitiated&&(this._displayTeleportationTarget(),this._haloCenter.copyFrom(e.pickedPoint),this._teleportationTarget.position.copyFrom(e.pickedPoint));const r=this._convertNormalToDirectionOfRay(e.getNormal(!0,!1),i);if(r){const s=x.Cross(As.Y,r),n=x.Cross(r,s);x.RotationFromAxisToRef(n,r,s,this._teleportationTarget.rotation)}this._teleportationTarget.position.y+=.1}}teleportCamera(e){if(!(this.currentVRCamera instanceof Qs))return;this.webVRCamera.leftCamera?(this._workingVector.copyFrom(this.webVRCamera.leftCamera.globalPosition),this._workingVector.subtractInPlace(this.webVRCamera.position),e.subtractToRef(this._workingVector,this._workingVector)):this._workingVector.copyFrom(e),this.isInVRMode?this._workingVector.y+=this.webVRCamera.deviceDistanceToRoomGround()*this._webVRCamera.deviceScaleFactor:this._workingVector.y+=this._defaultHeight,this.onBeforeCameraTeleport.notifyObservers(this._workingVector);const t=90;let i,r;if(this._teleportationMode==oh.TELEPORTATIONMODE_CONSTANTSPEED){r=t;const d=x.Distance(this.currentVRCamera.position,this._workingVector);i=this._teleportationSpeed/d}else r=Math.round(this._teleportationTime*t/1e3),i=1;this.currentVRCamera.animations=[];const s=new ae("animationCameraTeleportation","position",t,ae.ANIMATIONTYPE_VECTOR3,ae.ANIMATIONLOOPMODE_CONSTANT),n=[{frame:0,value:this.currentVRCamera.position},{frame:r,value:this._workingVector}];s.setKeys(n),s.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(s),this._postProcessMove.animations=[];const a=Math.round(r/2),l=new ae("animationPP","vignetteWeight",t,ae.ANIMATIONTYPE_FLOAT,ae.ANIMATIONLOOPMODE_CONSTANT),c=[];c.push({frame:0,value:0}),c.push({frame:a,value:8}),c.push({frame:r,value:0}),l.setKeys(c),this._postProcessMove.animations.push(l);const h=new ae("animationPP2","vignetteStretch",t,ae.ANIMATIONTYPE_FLOAT,ae.ANIMATIONLOOPMODE_CONSTANT),u=[];u.push({frame:0,value:0}),u.push({frame:a,value:10}),u.push({frame:r,value:0}),h.setKeys(u),this._postProcessMove.animations.push(h),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,r,!1,i,()=>{this._webVRCamera.detachPostProcess(this._postProcessMove)}),this._scene.beginAnimation(this.currentVRCamera,0,r,!1,i,()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)}),this._hideTeleportationTarget()}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(x.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_castRayAndSelectObject(e){if(!(this.currentVRCamera instanceof Qs))return;const t=e._getForwardRay(this._rayLength),i=this._scene.pickWithRay(t,this._raySelectionPredicate);if(i&&this._scene.simulatePointerMove(i,{pointerId:e._id}),e._currentHit=i,i&&i.pickedPoint){if(this._displayGaze){let r=1;e._gazeTracker.isVisible=!0,e._isActionableMesh&&(r=3),this.updateGazeTrackerScale&&(e._gazeTracker.scaling.x=i.distance*r,e._gazeTracker.scaling.y=i.distance*r,e._gazeTracker.scaling.z=i.distance*r);const s=this._convertNormalToDirectionOfRay(i.getNormal(),t),n=.002;if(s){const a=x.Cross(As.Y,s),l=x.Cross(s,a);x.RotationFromAxisToRef(l,s,a,e._gazeTracker.rotation)}e._gazeTracker.position.copyFrom(i.pickedPoint),e._gazeTracker.position.x<0?e._gazeTracker.position.x+=n:e._gazeTracker.position.x-=n,e._gazeTracker.position.y<0?e._gazeTracker.position.y+=n:e._gazeTracker.position.y-=n,e._gazeTracker.position.z<0?e._gazeTracker.position.z+=n:e._gazeTracker.position.z-=n}e._updatePointerDistance(i.distance)}else e._updatePointerDistance(),e._gazeTracker.isVisible=!1;if(i&&i.pickedMesh){if(this._teleportationInitialized&&this._isTeleportationFloor(i.pickedMesh)&&i.pickedPoint){e._currentMeshSelected&&!this._isTeleportationFloor(e._currentMeshSelected)&&this._notifySelectedMeshUnselected(e._currentMeshSelected),e._currentMeshSelected=null,e._teleportationRequestInitiated&&this._moveTeleportationSelectorTo(i,e,t);return}if(i.pickedMesh!==e._currentMeshSelected)if(this.meshSelectionPredicate(i.pickedMesh)){this.onNewMeshPicked.notifyObservers(i),e._currentMeshSelected=i.pickedMesh,i.pickedMesh.isPickable&&i.pickedMesh.actionManager?(this.changeGazeColor(this._pickedGazeColor),this.changeLaserColor(this._pickedLaserColor),e._isActionableMesh=!0):(this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor),e._isActionableMesh=!1);try{this.onNewMeshSelected.notifyObservers(i.pickedMesh);const r=e;r.webVRController&&this.onMeshSelectedWithController.notifyObservers({mesh:i.pickedMesh,controller:r.webVRController})}catch(r){X.Warn("Error while raising onNewMeshSelected or onMeshSelectedWithController: "+r)}}else this._notifySelectedMeshUnselected(e._currentMeshSelected),e._currentMeshSelected=null,this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor)}else this._notifySelectedMeshUnselected(e._currentMeshSelected),e._currentMeshSelected=null,this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor)}_notifySelectedMeshUnselected(e){e&&this.onSelectedMeshUnselected.notifyObservers(e)}setLaserColor(e,t=this._pickedLaserColor){this._laserColor=e,this._pickedLaserColor=t}setLaserLightingState(e=!0){this._leftController&&this._leftController._setLaserPointerLightingDisabled(!e),this._rightController&&this._rightController._setLaserPointerLightingDisabled(!e)}setGazeColor(e,t=this._pickedGazeColor){this._gazeColor=e,this._pickedGazeColor=t}changeLaserColor(e){this.updateControllerLaserColor&&(this._leftController&&this._leftController._setLaserPointerColor(e),this._rightController&&this._rightController._setLaserPointerColor(e))}changeGazeColor(e){this.updateGazeTrackerColor&&this._cameraGazer._gazeTracker.material&&(this._cameraGazer._gazeTracker.material.emissiveColor=e,this._leftController&&(this._leftController._gazeTracker.material.emissiveColor=e),this._rightController&&(this._rightController._gazeTracker.material.emissiveColor=e))}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._webVRCamera&&this._webVRCamera.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._leftController&&this._leftController.dispose(),this._rightController&&this._rightController.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.getEngine().onVRDisplayChangedObservable.removeCallback(this._onVRDisplayChangedBind),this._scene.getEngine().onVRRequestPresentStart.removeCallback(this._onVRRequestPresentStart),this._scene.getEngine().onVRRequestPresentComplete.removeCallback(this._onVRRequestPresentComplete),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.removeCallback(this._onNewGamepadDisconnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}oh.TELEPORTATIONMODE_CONSTANTTIME=0;oh.TELEPORTATIONMODE_CONSTANTSPEED=1;const tR=(o,e,t,i)=>!(o.x>t.x+i||t.x-i>e.x||o.y>t.y+i||t.y-i>e.y||o.z>t.z+i||t.z-i>e.z),Mc=function(){const o={root:0,found:!1};return function(e,t,i,r){o.root=0,o.found=!1;const s=t*t-4*e*i;if(s<0)return o;const n=Math.sqrt(s);let a=(-t-n)/(2*e),l=(-t+n)/(2*e);if(a>l){const c=l;l=a,a=c}return a>0&&a<r?(o.root=a,o.found=!0,o):(l>0&&l<r&&(o.root=l,o.found=!0),o)}}();class Lf{constructor(){this._collisionPoint=x.Zero(),this._planeIntersectionPoint=x.Zero(),this._tempVector=x.Zero(),this._tempVector2=x.Zero(),this._tempVector3=x.Zero(),this._tempVector4=x.Zero(),this._edge=x.Zero(),this._baseToVertex=x.Zero(),this._destinationPoint=x.Zero(),this._slidePlaneNormal=x.Zero(),this._displacementVector=x.Zero(),this._radius=x.One(),this._retry=0,this._basePointWorld=x.Zero(),this._velocityWorld=x.Zero(),this._normalizedVelocity=x.Zero(),this._collisionMask=-1}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}get slidePlaneNormal(){return this._slidePlaneNormal}_initialize(e,t,i){this._velocity=t,this._velocitySquaredLength=this._velocity.lengthSquared();const r=Math.sqrt(this._velocitySquaredLength);r===0||r===1?this._normalizedVelocity.copyFromFloats(t._x,t._y,t._z):t.scaleToRef(1/r,this._normalizedVelocity),this._basePoint=e,e.multiplyToRef(this._radius,this._basePointWorld),t.multiplyToRef(this._radius,this._velocityWorld),this._velocityWorldLength=this._velocityWorld.length(),this._epsilon=i,this.collisionFound=!1}_checkPointInTriangle(e,t,i,r,s){t.subtractToRef(e,this._tempVector),i.subtractToRef(e,this._tempVector2),x.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);let n=x.Dot(this._tempVector4,s);return n<0||(r.subtractToRef(e,this._tempVector3),x.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),n=x.Dot(this._tempVector4,s),n<0)?!1:(x.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),n=x.Dot(this._tempVector4,s),n>=0)}_canDoCollision(e,t,i,r){const s=x.Distance(this._basePointWorld,e),n=Math.max(this._radius.x,this._radius.y,this._radius.z);return!(s>this._velocityWorldLength+n+t||!tR(i,r,this._basePointWorld,this._velocityWorldLength+n))}_testTriangle(e,t,i,r,s,n,a){let l,c=!1;t||(t=[]),t[e]||(t[e]=new Tn(0,0,0,0),t[e].copyFromPoints(i,r,s));const h=t[e];if(!n&&!h.isFrontFacingTo(this._normalizedVelocity,0))return;const u=h.signedDistanceTo(this._basePoint),d=x.Dot(h.normal,this._velocity);if(Lf.DoubleSidedCheck&&d>1e-4)return;if(d==0){if(Math.abs(u)>=1)return;c=!0,l=0}else{l=(-1-u)/d;let p=(1-u)/d;if(l>p){const m=p;p=l,l=m}if(l>1||p<0)return;l<0&&(l=0),l>1&&(l=1)}this._collisionPoint.copyFromFloats(0,0,0);let f=!1,_=1;if(c||(this._basePoint.subtractToRef(h.normal,this._planeIntersectionPoint),this._velocity.scaleToRef(l,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,i,r,s,h.normal)&&(f=!0,_=l,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!f){let p=this._velocitySquaredLength;this._basePoint.subtractToRef(i,this._tempVector);let m=2*x.Dot(this._velocity,this._tempVector),T=this._tempVector.lengthSquared()-1,b=Mc(p,m,T,_);b.found&&(_=b.root,f=!0,this._collisionPoint.copyFrom(i)),this._basePoint.subtractToRef(r,this._tempVector),m=2*x.Dot(this._velocity,this._tempVector),T=this._tempVector.lengthSquared()-1,b=Mc(p,m,T,_),b.found&&(_=b.root,f=!0,this._collisionPoint.copyFrom(r)),this._basePoint.subtractToRef(s,this._tempVector),m=2*x.Dot(this._velocity,this._tempVector),T=this._tempVector.lengthSquared()-1,b=Mc(p,m,T,_),b.found&&(_=b.root,f=!0,this._collisionPoint.copyFrom(s)),r.subtractToRef(i,this._edge),i.subtractToRef(this._basePoint,this._baseToVertex);let y=this._edge.lengthSquared(),S=x.Dot(this._edge,this._velocity),C=x.Dot(this._edge,this._baseToVertex);if(p=y*-this._velocitySquaredLength+S*S,m=2*(y*x.Dot(this._velocity,this._baseToVertex)-S*C),T=y*(1-this._baseToVertex.lengthSquared())+C*C,b=Mc(p,m,T,_),b.found){const I=(S*b.root-C)/y;I>=0&&I<=1&&(_=b.root,f=!0,this._edge.scaleInPlace(I),i.addToRef(this._edge,this._collisionPoint))}if(s.subtractToRef(r,this._edge),r.subtractToRef(this._basePoint,this._baseToVertex),y=this._edge.lengthSquared(),S=x.Dot(this._edge,this._velocity),C=x.Dot(this._edge,this._baseToVertex),p=y*-this._velocitySquaredLength+S*S,m=2*(y*x.Dot(this._velocity,this._baseToVertex)-S*C),T=y*(1-this._baseToVertex.lengthSquared())+C*C,b=Mc(p,m,T,_),b.found){const I=(S*b.root-C)/y;I>=0&&I<=1&&(_=b.root,f=!0,this._edge.scaleInPlace(I),r.addToRef(this._edge,this._collisionPoint))}if(i.subtractToRef(s,this._edge),s.subtractToRef(this._basePoint,this._baseToVertex),y=this._edge.lengthSquared(),S=x.Dot(this._edge,this._velocity),C=x.Dot(this._edge,this._baseToVertex),p=y*-this._velocitySquaredLength+S*S,m=2*(y*x.Dot(this._velocity,this._baseToVertex)-S*C),T=y*(1-this._baseToVertex.lengthSquared())+C*C,b=Mc(p,m,T,_),b.found){const I=(S*b.root-C)/y;I>=0&&I<=1&&(_=b.root,f=!0,this._edge.scaleInPlace(I),s.addToRef(this._edge,this._collisionPoint))}}if(f){const p=_*_*this._velocitySquaredLength;(!this.collisionFound||p<this._nearestDistanceSquared)&&(a.collisionResponse&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this._nearestDistanceSquared=p,this._nearestDistance=Math.sqrt(p),this.collisionFound=!0),this.collidedMesh=a)}}_collide(e,t,i,r,s,n,a,l,c,h=!1){if(h)if(!i||i.length===0)for(let u=0;u<t.length-2;u+=1){const d=t[u],f=t[u+1],_=t[u+2];!d||!f||!_||((c?1:0)^u%2?this._testTriangle(u,e,d,f,_,a,l):this._testTriangle(u,e,f,d,_,a,l))}else for(let u=r;u<s-2;u+=1){const d=i[u],f=i[u+1],_=i[u+2];if(_===4294967295){u+=2;continue}const p=t[d],m=t[f],T=t[_];!p||!m||!T||((c?1:0)^u%2?this._testTriangle(u,e,p,m,T,a,l):this._testTriangle(u,e,m,p,T,a,l))}else if(!i||i.length===0)for(let u=0;u<t.length;u+=3){const d=t[u],f=t[u+1],_=t[u+2];c?this._testTriangle(u,e,d,f,_,a,l):this._testTriangle(u,e,_,f,d,a,l)}else for(let u=r;u<s;u+=3){const d=t[i[u]-n],f=t[i[u+1]-n],_=t[i[u+2]-n];c?this._testTriangle(u,e,d,f,_,a,l):this._testTriangle(u,e,_,f,d,a,l)}}_getResponse(e,t){e.addToRef(t,this._destinationPoint),t.scaleInPlace(this._nearestDistance/t.length()),this._basePoint.addToRef(t,e),e.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this._epsilon,this._displacementVector),e.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(Tn.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,t)}}Lf.DoubleSidedCheck=!1;class iR{constructor(){this._scaledPosition=x.Zero(),this._scaledVelocity=x.Zero(),this._finalPosition=x.Zero()}getNewPosition(e,t,i,r,s,n,a){e.divideToRef(i._radius,this._scaledPosition),t.divideToRef(i._radius,this._scaledVelocity),i.collidedMesh=null,i._retry=0,i._initialVelocity=this._scaledVelocity,i._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,this._finalPosition,s),this._finalPosition.multiplyInPlace(i._radius),n(a,this._finalPosition,i.collidedMesh)}createCollider(){return new Lf}init(e){this._scene=e}_collideWithWorld(e,t,i,r,s,n=null){const a=q.CollisionsEpsilon*10;if(i._retry>=r){s.copyFrom(e);return}const l=n?n.collisionMask:i.collisionMask;i._initialize(e,t,a);const c=n&&n.surroundingMeshes||this._scene.meshes;for(let h=0;h<c.length;h++){const u=c[h];u.isEnabled()&&u.checkCollisions&&u.subMeshes&&u!==n&&l&u.collisionGroup&&u._checkCollision(i)}if(!i.collisionFound){e.addToRef(t,s);return}if((t.x!==0||t.y!==0||t.z!==0)&&i._getResponse(e,t),t.length()<=a){s.copyFrom(e);return}i._retry++,this._collideWithWorld(e,t,i,r,s,n)}}Ne.CollisionCoordinatorFactory=()=>new iR;class lh{constructor(e,t,i,r=""){var s,n;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.uniqueId=0,this.onCompileObservable=new Q,this.onErrorObservable=new Q,this.onBindObservable=new Q,this._wasPreviouslyReady=!1,this._isReady=!1,this._compilationError="",this._key="",this._computeSourceCodeOverride="",this._pipelineContext=null,this._computeSourceCode="",this._rawComputeSourceCode="",this._shaderLanguage=Gi.WGSL,this.name=e,this._key=r,this._engine=i,this.uniqueId=lh._UniqueIdSeed++,this.defines=(s=t.defines)!==null&&s!==void 0?s:"",this.onError=t.onError,this.onCompiled=t.onCompiled,this._entryPoint=(n=t.entryPoint)!==null&&n!==void 0?n:"main",this._shaderStore=te.GetShadersStore(this._shaderLanguage),this._shaderRepository=te.GetShadersRepository(this._shaderLanguage),this._includeShaderStore=te.GetIncludesShadersStore(this._shaderLanguage);let a;const l=Ar()?this._engine.getHostDocument():null;e.computeSource?a="source:"+e.computeSource:e.computeElement?(a=l?l.getElementById(e.computeElement):null,a||(a=e.computeElement)):a=e.compute||e;const c={defines:this.defines.split(`
`),indexParameters:void 0,isFragment:!1,shouldUseHighPrecisionShader:!1,processor:null,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:this._shaderRepository,includesShadersStore:this._includeShaderStore,version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:null,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer};this._loadShader(a,"Compute","",h=>{uo.Initialize(c),uo.PreProcess(h,c,u=>{this._rawComputeSourceCode=h,t.processFinalCode&&(u=t.processFinalCode(u));const d=uo.Finalize(u,"",c);this._useFinalCode(d.vertexCode,e)},this._engine)})}_useFinalCode(e,t){if(t){const i=t.computeElement||t.compute||t.spectorName||t;this._computeSourceCode="//#define SHADER_NAME compute:"+i+`
`+e}else this._computeSourceCode=e;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getCompilationError(){return this._compilationError}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16)}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){this._processCompilationErrors(t,e);return}setTimeout(()=>{this._checkIsReady(e)},16)}_loadShader(e,t,i,r){if(typeof HTMLElement<"u"&&e instanceof HTMLElement){const n=cf(e);r(n);return}if(e.substr(0,7)==="source:"){r(e.substr(7));return}if(e.substr(0,7)==="base64:"){const n=window.atob(e.substr(7));r(n);return}if(this._shaderStore[e+t+"Shader"]){r(this._shaderStore[e+t+"Shader"]);return}if(i&&this._shaderStore[e+i+"Shader"]){r(this._shaderStore[e+i+"Shader"]);return}let s;e[0]==="."||e[0]==="/"||e.indexOf("http")>-1?s=e:s=this._shaderRepository+e,this._engine._loadFile(s+"."+t.toLowerCase()+".fx",r)}get computeSourceCode(){var e,t;return this._computeSourceCodeOverride?this._computeSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getComputeShaderCode())!==null&&t!==void 0?t:this._computeSourceCode}get rawComputeSourceCode(){return this._rawComputeSourceCode}_prepareEffect(){const e=this.defines,t=this._pipelineContext;this._isReady=!1;try{const i=this._engine;this._pipelineContext=i.createComputePipelineContext(),this._pipelineContext._name=this._key,i._prepareComputePipelineContext(this._pipelineContext,this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._computeSourceCode,this._rawComputeSourceCode,this._computeSourceCodeOverride?null:e,this._entryPoint),i._executeWhenComputeStateIsCompiled(this._pipelineContext,()=>{this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),t&&this.getEngine()._deleteComputePipelineContext(t)}),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(i){this._processCompilationErrors(i,t)}}_getShaderCodeAndErrorLine(e,t){const i=/COMPUTE SHADER ERROR: 0:(\d+?):/;let r=null;if(t&&e){const s=t.match(i);if(s&&s.length===2){const n=parseInt(s[1]),a=e.split(`
`,-1);a.length>=n&&(r=`Offending line [${n}] in compute code: ${a[n-1]}`)}}return[e,r]}_processCompilationErrors(e,t=null){var i;if(this._compilationError=e.message,X.Error("Unable to compile compute effect:"),X.Error(`Defines:\r
`+this.defines),lh.LogShaderCodeOnCompilationError){let r=null,s=null;!((i=this._pipelineContext)===null||i===void 0)&&i._getComputeShaderCode()&&([s,r]=this._getShaderCodeAndErrorLine(this._pipelineContext._getComputeShaderCode(),this._compilationError),s&&(X.Error("Compute code:"),X.Error(s))),r&&X.Error(r)}X.Error("Error: "+this._compilationError),t&&(this._pipelineContext=t,this._isReady=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this))}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseComputeEffect(this)}static RegisterShader(e,t){te.GetShadersStore(Gi.WGSL)[`${e}ComputeShader`]=t}}lh._UniqueIdSeed=0;lh.LogShaderCodeOnCompilationError=!0;var ur;(function(o){o[o.Texture=0]="Texture",o[o.StorageTexture=1]="StorageTexture",o[o.UniformBuffer=2]="UniformBuffer",o[o.StorageBuffer=3]="StorageBuffer",o[o.TextureWithoutSampler=4]="TextureWithoutSampler",o[o.Sampler=5]="Sampler"})(ur||(ur={}));ze.prototype.createComputeEffect=function(o,e){throw new Error("createComputeEffect: This engine does not support compute shaders!")};ze.prototype.createComputePipelineContext=function(){throw new Error("createComputePipelineContext: This engine does not support compute shaders!")};ze.prototype.createComputeContext=function(){};ze.prototype.computeDispatch=function(o,e,t,i,r,s,n){throw new Error("computeDispatch: This engine does not support compute shaders!")};ze.prototype.areAllComputeEffectsReady=function(){return!0};ze.prototype.releaseComputeEffects=function(){};ze.prototype._prepareComputePipelineContext=function(o,e,t,i,r){};ze.prototype._rebuildComputeEffects=function(){};ze.prototype._executeWhenComputeStateIsCompiled=function(o,e){e()};ze.prototype._releaseComputeEffect=function(o){};ze.prototype._deleteComputePipelineContext=function(o){};class Gu{get options(){return this._options}get shaderPath(){return this._shaderPath}constructor(e,t,i,r={}){if(this._bindings={},this._samplers={},this._contextIsDirty=!1,this.onCompiled=null,this.onError=null,this.name=e,this._engine=t,this.uniqueId=df.UniqueId,!this._engine.getCaps().supportComputeShaders){X.Error("This engine does not support compute shaders!");return}if(!r.bindingsMapping){X.Error("You must provide the binding mappings as browsers don't support reflection for wgsl shaders yet!");return}this._context=t.createComputeContext(),this._shaderPath=i,this._options={bindingsMapping:{},defines:[],...r}}getClassName(){return"ComputeShader"}setTexture(e,t,i=!0){const r=this._bindings[e];this._bindings[e]={type:i?ur.Texture:ur.TextureWithoutSampler,object:t,indexInGroupEntries:r==null?void 0:r.indexInGroupEntries},this._contextIsDirty||(this._contextIsDirty=!r||r.object!==t||r.type!==this._bindings[e].type)}setStorageTexture(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:ur.StorageTexture,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}setUniformBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:ur.UniformBuffer,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}setStorageBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:ur.StorageBuffer,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}setTextureSampler(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||!t.compareSampler(i.object)),this._bindings[e]={type:ur.Sampler,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}isReady(){let e=this._effect;for(const s in this._bindings){const n=this._bindings[s],a=n.type,l=n.object;switch(a){case ur.Texture:case ur.TextureWithoutSampler:case ur.StorageTexture:{if(!l.isReady())return!1;break}}}const t=[],i=this._shaderPath;if(this._options.defines)for(let s=0;s<this._options.defines.length;s++)t.push(this._options.defines[s]);const r=t.join(`
`);return this._cachedDefines!==r&&(this._cachedDefines=r,e=this._engine.createComputeEffect(i,{defines:r,entryPoint:this._options.entryPoint,onCompiled:this.onCompiled,onError:this.onError}),this._effect=e),!!e.isReady()}dispatch(e,t,i){var r;if(!this.isReady())return!1;for(const s in this._bindings){const n=this._bindings[s];if(!this._options.bindingsMapping[s])throw new Error("ComputeShader ('"+this.name+"'): No binding mapping has been provided for the property '"+s+"'");if(n.type!==ur.Texture)continue;const a=this._samplers[s],l=n.object;(!a||!l._texture||!a.compareSampler(l._texture))&&(this._samplers[s]=new sT().setParameters(l.wrapU,l.wrapV,l.wrapR,l.anisotropicFilteringLevel,l._texture.samplingMode,(r=l._texture)===null||r===void 0?void 0:r._comparisonFunction),this._contextIsDirty=!0)}return this._contextIsDirty&&(this._contextIsDirty=!1,this._context.clear()),this._engine.computeDispatch(this._effect,this._context,this._bindings,e,t,i,this._options.bindingsMapping),!0}dispatchWhenReady(e,t,i,r=10){return new Promise(s=>{const n=()=>{this.dispatch(e,t,i)?s():setTimeout(n,r)};n()})}serialize(){const e=ke.Serialize(this);e.options=this._options,e.shaderPath=this._shaderPath,e.bindings={},e.textures={};for(const t in this._bindings){const i=this._bindings[t],r=i.object;switch(i.type){case ur.Texture:case ur.TextureWithoutSampler:case ur.StorageTexture:{const s=r.serialize();s&&(e.textures[t]=s,e.bindings[t]={type:i.type});break}case ur.UniformBuffer:break}}return e}static Parse(e,t,i){const r=ke.Parse(()=>new Gu(e.name,t.getEngine(),e.shaderPath,e.options),e,t,i);for(const s in e.textures){const n=e.bindings[s],a=Y.Parse(e.textures[s],t,i);n.type===ur.Texture?r.setTexture(s,a):n.type===ur.TextureWithoutSampler?r.setTexture(s,a,!1):r.setStorageTexture(s,a)}return r}}M([F()],Gu.prototype,"name",void 0);ye("BABYLON.ComputeShader",Gu);class $d{constructor(e,t,i,r,s,n){this.entries=new Array,this._boundingVectors=new Array,this._capacity=i,this._depth=r,this._maxDepth=s,this._creationFunc=n,this._minPoint=e,this._maxPoint=t,this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors[2].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[3].y=t.y,this._boundingVectors.push(e.clone()),this._boundingVectors[4].z=t.z,this._boundingVectors.push(t.clone()),this._boundingVectors[5].z=e.z,this._boundingVectors.push(t.clone()),this._boundingVectors[6].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[7].y=e.y}get capacity(){return this._capacity}get minPoint(){return this._minPoint}get maxPoint(){return this._maxPoint}addEntry(e){if(this.blocks){for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e);return}this._creationFunc(e,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()}removeEntry(e){if(this.blocks){for(let i=0;i<this.blocks.length;i++)this.blocks[i].removeEntry(e);return}const t=this.entries.indexOf(e);t>-1&&this.entries.splice(t,1)}addEntries(e){for(let t=0;t<e.length;t++){const i=e[t];this.addEntry(i)}}select(e,t,i){if(Va.IsInFrustum(this._boundingVectors,e)){if(this.blocks){for(let r=0;r<this.blocks.length;r++)this.blocks[r].select(e,t,i);return}i?t.concat(this.entries):t.concatWithNoDuplicate(this.entries)}}intersects(e,t,i,r){if(Va.IntersectsSphere(this._minPoint,this._maxPoint,e,t)){if(this.blocks){for(let s=0;s<this.blocks.length;s++)this.blocks[s].intersects(e,t,i,r);return}r?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}}intersectsRay(e,t){if(e.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(let i=0;i<this.blocks.length;i++)this.blocks[i].intersectsRay(e,t);return}t.concatWithNoDuplicate(this.entries)}}createInnerBlocks(){$d._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc),this.entries.splice(0)}static _CreateBlocks(e,t,i,r,s,n,a,l){a.blocks=new Array;const c=new x((t.x-e.x)/2,(t.y-e.y)/2,(t.z-e.z)/2);for(let h=0;h<2;h++)for(let u=0;u<2;u++)for(let d=0;d<2;d++){const f=e.add(c.multiplyByFloats(h,u,d)),_=e.add(c.multiplyByFloats(h+1,u+1,d+1)),p=new $d(f,_,r,s+1,n,l);p.addEntries(i),a.blocks.push(p)}}}class ch{constructor(e,t,i=2){this.maxDepth=i,this.dynamicContent=new Array,this._maxBlockCapacity=t||64,this._selectionContent=new hl(1024),this._creationFunc=e}update(e,t,i){$d._CreateBlocks(e,t,i,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)}addMesh(e){for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e)}removeMesh(e){for(let t=0;t<this.blocks.length;t++)this.blocks[t].removeEntry(e)}select(e,t){this._selectionContent.reset();for(let i=0;i<this.blocks.length;i++)this.blocks[i].select(e,this._selectionContent,t);return t?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersects(e,t,i){this._selectionContent.reset();for(let r=0;r<this.blocks.length;r++)this.blocks[r].intersects(e,t,this._selectionContent,i);return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersectsRay(e){this._selectionContent.reset();for(let t=0;t<this.blocks.length;t++)this.blocks[t].intersectsRay(e,this._selectionContent);return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}}ch.CreationFuncForMeshes=(o,e)=>{const t=o.getBoundingInfo();!o.isBlocked&&t.boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(o)};ch.CreationFuncForSubMeshes=(o,e)=>{o.getBoundingInfo().boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(o)};Ne.prototype.createOrUpdateSelectionOctree=function(o=64,e=2){let t=this._getComponent(Re.NAME_OCTREE);t||(t=new $T(this),this._addComponent(t)),this._selectionOctree||(this._selectionOctree=new ch(ch.CreationFuncForMeshes,o,e));const i=this.getWorldExtends();return this._selectionOctree.update(i.min,i.max,this.meshes),this._selectionOctree};Object.defineProperty(Ne.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0});Qt.prototype.createOrUpdateSubmeshesOctree=function(o=64,e=2){const t=this.getScene();let i=t._getComponent(Re.NAME_OCTREE);i||(i=new $T(t),t._addComponent(i)),this._submeshesOctree||(this._submeshesOctree=new ch(ch.CreationFuncForSubMeshes,o,e)),this.computeWorldMatrix(!0);const s=this.getBoundingInfo().boundingBox;return this._submeshesOctree.update(s.minimumWorld,s.maximumWorld,this.subMeshes),this._submeshesOctree};class $T{constructor(e){this.name=Re.NAME_OCTREE,this.checksIsEnabled=!0,this._tempRay=new Pt(x.Zero(),new x(1,1,1)),e=e||qe.LastCreatedScene,e&&(this.scene=e,this.scene.getActiveMeshCandidates=this.getActiveMeshCandidates.bind(this),this.scene.getActiveSubMeshCandidates=this.getActiveSubMeshCandidates.bind(this),this.scene.getCollidingSubMeshCandidates=this.getCollidingSubMeshCandidates.bind(this),this.scene.getIntersectingSubMeshCandidates=this.getIntersectingSubMeshCandidates.bind(this))}register(){this.scene.onMeshRemovedObservable.add(e=>{const t=this.scene.selectionOctree;if(t!=null){const i=t.dynamicContent.indexOf(e);i!==-1&&t.dynamicContent.splice(i,1)}}),this.scene.onMeshImportedObservable.add(e=>{const t=this.scene.selectionOctree;t!=null&&t.addMesh(e)})}getActiveMeshCandidates(){var e;return((e=this.scene._selectionOctree)===null||e===void 0?void 0:e.select(this.scene.frustumPlanes))||this.scene._getDefaultMeshCandidates()}getActiveSubMeshCandidates(e){return e._submeshesOctree&&e.useOctreeForRenderingSelection?e._submeshesOctree.select(this.scene.frustumPlanes):this.scene._getDefaultSubMeshCandidates(e)}getIntersectingSubMeshCandidates(e,t){return e._submeshesOctree&&e.useOctreeForPicking?(Pt.TransformToRef(t,e.getWorldMatrix(),this._tempRay),e._submeshesOctree.intersectsRay(this._tempRay)):this.scene._getDefaultSubMeshCandidates(e)}getCollidingSubMeshCandidates(e,t){if(e._submeshesOctree&&e.useOctreeForCollisions){const i=t._velocityWorldLength+Math.max(t._radius.x,t._radius.y,t._radius.z);return e._submeshesOctree.intersects(t._basePointWorld,i)}return this.scene._getDefaultSubMeshCandidates(e)}rebuild(){}dispose(){}}class yr{getRenderCamera(e){if(this._renderCamera)return this._renderCamera;{let t;return this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?t=this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:t=this.originalScene.activeCamera,e&&t&&t.isRigCamera?t.rigParent:t}}setRenderCamera(e){this._renderCamera=e}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new kl("shared gizmo light",new x(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=ge.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return yr._DefaultUtilityLayer==null?yr._CreateDefaultUtilityLayerFromScene(qe.LastCreatedScene):yr._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(e){return yr._DefaultUtilityLayer=new yr(e),yr._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{yr._DefaultUtilityLayer=null}),yr._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return yr._DefaultKeepDepthUtilityLayer==null&&(yr._DefaultKeepDepthUtilityLayer=new yr(qe.LastCreatedScene),yr._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,yr._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{yr._DefaultKeepDepthUtilityLayer=null})),yr._DefaultKeepDepthUtilityLayer}constructor(e,t=!0){this.originalScene=e,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new Q,this.utilityLayerScene=new Ne(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add(i=>{if(!this.utilityLayerScene.activeCamera||!this.pickingEnabled||!this.processAllEvents&&i.type!==Qe.POINTERMOVE&&i.type!==Qe.POINTERUP&&i.type!==Qe.POINTERDOWN&&i.type!==Qe.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=e.pointerX,this.utilityLayerScene.pointerY=e.pointerY;const r=i.event;if(e.isPointerCaptured(r.pointerId)){this._pointerCaptures[r.pointerId]=!1;return}const s=a=>{let l=null;if(i.nearInteractionPickingInfo)i.nearInteractionPickingInfo.pickedMesh.getScene()==a?l=i.nearInteractionPickingInfo:l=new Vs;else if(a!==this.utilityLayerScene&&i.originalPickingInfo)l=i.originalPickingInfo;else{let c=null;this._renderCamera&&(c=a._activeCamera,a._activeCamera=this._renderCamera,i.ray=null),l=i.ray?a.pickWithRay(i.ray):a.pick(e.pointerX,e.pointerY),c&&(a._activeCamera=c)}return l},n=s(this.utilityLayerScene);if(!i.ray&&n&&(i.ray=n.ray),this.utilityLayerScene.onPrePointerObservable.notifyObservers(i),this.onlyCheckPointerDownEvents&&i.type!=Qe.POINTERDOWN){i.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new ao(i.type,i.event,n),i.type),i.type===Qe.POINTERUP&&this._pointerCaptures[r.pointerId]&&(this._pointerCaptures[r.pointerId]=!1);return}if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)n&&n.hit&&(i.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new ao(i.type,i.event,n),i.type),i.skipOnPointerObservable=!0);else{const a=s(e),l=i.event;a&&n&&(n.distance===0&&a.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(a.pickedMesh)?(this._notifyObservers(i,a,l),i.skipOnPointerObservable=!0):i.type===Qe.POINTERDOWN?this._pointerCaptures[l.pointerId]=!0:(i.type===Qe.POINTERMOVE||i.type===Qe.POINTERUP)&&(this._lastPointerEvents[l.pointerId]&&(this.onPointerOutObservable.notifyObservers(l.pointerId),delete this._lastPointerEvents[l.pointerId]),this._notifyObservers(i,a,l)):!this._pointerCaptures[l.pointerId]&&(n.distance<a.distance||a.distance===0)?(this._notifyObservers(i,n,l),i.skipOnPointerObservable||(i.skipOnPointerObservable=n.distance>0)):!this._pointerCaptures[l.pointerId]&&n.distance>=a.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(a.pickedMesh)?(this._notifyObservers(i,a,l),i.skipOnPointerObservable=!0):((i.type===Qe.POINTERMOVE||i.type===Qe.POINTERUP)&&this._lastPointerEvents[l.pointerId]&&(this.onPointerOutObservable.notifyObservers(l.pointerId),delete this._lastPointerEvents[l.pointerId]),this._notifyObservers(i,n,l))),i.type===Qe.POINTERUP&&this._pointerCaptures[l.pointerId]&&(this._pointerCaptures[l.pointerId]=!1))}}),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add(i=>{this.shouldRender&&i==this.getRenderCamera()&&this.render()}),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(()=>{this.dispose()}),this._updateCamera()}_notifyObservers(e,t,i){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new ao(e.type,e.event,t),e.type),this._lastPointerEvents[i.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){const e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}yr._DefaultUtilityLayer=null;yr._DefaultKeepDepthUtilityLayer=null;Object.defineProperty(Ne.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new Bf(this)),this._debugLayer},enumerable:!0,configurable:!0});var pv;(function(o){o[o.Properties=0]="Properties",o[o.Debug=1]="Debug",o[o.Statistics=2]="Statistics",o[o.Tools=3]="Tools",o[o.Settings=4]="Settings"})(pv||(pv={}));class Bf{get onPropertyChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this._onPropertyChangedObservable||(this._onPropertyChangedObservable=new Q),this._onPropertyChangedObservable)}get onSelectionChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable:(this._onSelectionChangedObservable||(this._onSelectionChangedObservable=new Q),this._onSelectionChangedObservable)}constructor(e){this.BJSINSPECTOR=this._getGlobalInspector(),this._scene=e||qe.LastCreatedScene,this._scene&&this._scene.onDisposeObservable.add(()=>{this._scene._debugLayer&&this._scene._debugLayer.hide()})}_createInspector(e){if(this.isVisible())return;if(this._onPropertyChangedObservable){for(const i of this._onPropertyChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(i);this._onPropertyChangedObservable.clear(),this._onPropertyChangedObservable=void 0}if(this._onSelectionChangedObservable){for(const i of this._onSelectionChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnSelectionChangedObservable.add(i);this._onSelectionChangedObservable.clear(),this._onSelectionChangedObservable=void 0}const t={overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0,...e};this.BJSINSPECTOR=this.BJSINSPECTOR||this._getGlobalInspector(),this.BJSINSPECTOR.Inspector.Show(this._scene,t)}select(e,t){this.BJSINSPECTOR&&(t&&(Object.prototype.toString.call(t)=="[object String]"?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(t):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(t)),this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(e))}_getGlobalInspector(){if(typeof INSPECTOR<"u")return INSPECTOR;if(typeof BABYLON<"u"&&typeof BABYLON.Inspector<"u")return BABYLON}isVisible(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible}hide(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()}setAsActiveScene(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector._SetNewScene(this._scene)}show(e){return new Promise(t=>{if(typeof this.BJSINSPECTOR>"u"){const i=e&&e.inspectorURL?e.inspectorURL:Bf.InspectorURL;J.LoadScript(i,()=>{this._createInspector(e),t(this)})}else this._createInspector(e),t(this)})}}Bf.InspectorURL=`https://unpkg.com/babylonjs-inspector@${q.Version}/babylon.inspector.bundle.js`;function Em(o){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],r=[];let s=[];const n=o.width||o.size||1,a=o.height||o.size||1,l=o.depth||o.size||1,c=o.wrap||!1;let h=o.topBaseAt===void 0?1:o.topBaseAt,u=o.bottomBaseAt===void 0?0:o.bottomBaseAt;h=(h+4)%4,u=(u+4)%4;const d=[2,0,3,1],f=[2,0,1,3];let _=d[h],p=f[u],m=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(c){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],m=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let P=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],D=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const w=[17,18,19,16],L=[22,23,20,21];for(;_>0;)P.unshift(P.pop()),w.unshift(w.pop()),_--;for(;p>0;)D.unshift(D.pop()),L.unshift(L.pop()),p--;P=P.flat(),D=D.flat(),m=m.concat(P).concat(D),t.push(w[0],w[2],w[3],w[0],w[1],w[2]),t.push(L[0],L[2],L[3],L[0],L[1],L[2])}const T=[n/2,a/2,l/2];s=m.reduce((P,D,w)=>P.concat(D*T[w%3]),[]);const b=o.sideOrientation===0?0:o.sideOrientation||Oe.DEFAULTSIDE,y=o.faceUV||new Array(6),S=o.faceColors,C=[];for(let P=0;P<6;P++)y[P]===void 0&&(y[P]=new Tt(0,0,1,1)),S&&S[P]===void 0&&(S[P]=new Ye(1,1,1,1));for(let P=0;P<6;P++)if(r.push(y[P].z,Yt.UseOpenGLOrientationForUV?1-y[P].w:y[P].w),r.push(y[P].x,Yt.UseOpenGLOrientationForUV?1-y[P].w:y[P].w),r.push(y[P].x,Yt.UseOpenGLOrientationForUV?1-y[P].y:y[P].y),r.push(y[P].z,Yt.UseOpenGLOrientationForUV?1-y[P].y:y[P].y),S)for(let D=0;D<4;D++)C.push(S[P].r,S[P].g,S[P].b,S[P].a);Oe._ComputeSides(b,s,t,i,r,o.frontUVs,o.backUVs);const I=new Oe;if(I.indices=t,I.positions=s,I.normals=i,I.uvs=r,S){const P=b===Oe.DOUBLESIDE?C.concat(C):C;I.colors=P}return I}function bm(o,e={},t=null){const i=new K(o,t);return e.sideOrientation=K._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Em(e).applyToMesh(i,e.updatable),i}Oe.CreateBox=Em;K.CreateBox=(o,e,t=null,i,r)=>bm(o,{size:e,sideOrientation:r,updatable:i},t);function YT(o){const e=o.segments||32,t=o.diameterX||o.diameter||1,i=o.diameterY||o.diameter||1,r=o.diameterZ||o.diameter||1,s=o.arc&&(o.arc<=0||o.arc>1)?1:o.arc||1,n=o.slice&&o.slice<=0?1:o.slice||1,a=o.sideOrientation===0?0:o.sideOrientation||Oe.DEFAULTSIDE,l=!!o.dedupTopBottomIndices,c=new x(t/2,i/2,r/2),h=2+e,u=2*h,d=[],f=[],_=[],p=[];for(let T=0;T<=h;T++){const b=T/h,y=b*Math.PI*n;for(let S=0;S<=u;S++){const C=S/u,I=C*Math.PI*2*s,P=H.RotationZ(-y),D=H.RotationY(I),w=x.TransformCoordinates(x.Up(),P),L=x.TransformCoordinates(w,D),U=L.multiply(c),G=L.divide(c).normalize();f.push(U.x,U.y,U.z),_.push(G.x,G.y,G.z),p.push(C,Yt.UseOpenGLOrientationForUV?1-b:b)}if(T>0){const S=f.length/3;for(let C=S-2*(u+1);C+u+2<S;C++)l?(T>1&&(d.push(C),d.push(C+1),d.push(C+u+1)),(T<h||n<1)&&(d.push(C+u+1),d.push(C+1),d.push(C+u+2))):(d.push(C),d.push(C+1),d.push(C+u+1),d.push(C+u+1),d.push(C+1),d.push(C+u+2))}}Oe._ComputeSides(a,f,d,_,p,o.frontUVs,o.backUVs);const m=new Oe;return m.indices=d,m.positions=f,m.normals=_,m.uvs=p,m}function jo(o,e={},t=null){const i=new K(o,t);return e.sideOrientation=K._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,YT(e).applyToMesh(i,e.updatable),i}Oe.CreateSphere=YT;K.CreateSphere=(o,e,t,i,r,s)=>jo(o,{segments:e,diameterX:t,diameterY:t,diameterZ:t,sideOrientation:s,updatable:r},i);function jT(o={subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){const e=Math.max(o.subdivisions?o.subdivisions:2,1),t=Math.max(o.tessellation?o.tessellation:16,3),i=Math.max(o.height?o.height:1,0),r=Math.max(o.radius?o.radius:.25,0),s=Math.max(o.capSubdivisions?o.capSubdivisions:6,1),n=t,a=e,l=Math.max(o.radiusTop?o.radiusTop:r,0),c=Math.max(o.radiusBottom?o.radiusBottom:r,0),h=i-(l+c),u=0,d=2*Math.PI,f=Math.max(o.topCapSubdivisions?o.topCapSubdivisions:s,1),_=Math.max(o.bottomCapSubdivisions?o.bottomCapSubdivisions:s,1),p=Math.acos((c-l)/i);let m=[];const T=[],b=[],y=[];let S=0;const C=[],I=h*.5,P=Math.PI*.5;let D,w;const L=x.Zero(),U=x.Zero(),G=Math.cos(p),Z=Math.sin(p),he=new Ie(l*Z,I+l*G).subtract(new Ie(c*Z,-I+c*G)).length(),_e=l*p+he+c*(P-p);let ne=0;for(w=0;w<=f;w++){const de=[],k=P-p*(w/f);ne+=l*p/f;const se=Math.cos(k),xe=Math.sin(k),le=se*l;for(D=0;D<=n;D++){const je=D/n,st=je*d+u,be=Math.sin(st),We=Math.cos(st);U.x=le*be,U.y=I+xe*l,U.z=le*We,T.push(U.x,U.y,U.z),L.set(se*be,xe,se*We),b.push(L.x,L.y,L.z),y.push(je,Yt.UseOpenGLOrientationForUV?ne/_e:1-ne/_e),de.push(S),S++}C.push(de)}const Pe=i-l-c+G*l-G*c,Se=Z*(c-l)/Pe;for(w=1;w<=a;w++){const de=[];ne+=he/a;const k=Z*(w*(c-l)/a+l);for(D=0;D<=n;D++){const se=D/n,xe=se*d+u,le=Math.sin(xe),je=Math.cos(xe);U.x=k*le,U.y=I+G*l-w*Pe/a,U.z=k*je,T.push(U.x,U.y,U.z),L.set(le,Se,je).normalize(),b.push(L.x,L.y,L.z),y.push(se,Yt.UseOpenGLOrientationForUV?ne/_e:1-ne/_e),de.push(S),S++}C.push(de)}for(w=1;w<=_;w++){const de=[],k=P-p-(Math.PI-p)*(w/_);ne+=c*p/_;const se=Math.cos(k),xe=Math.sin(k),le=se*c;for(D=0;D<=n;D++){const je=D/n,st=je*d+u,be=Math.sin(st),We=Math.cos(st);U.x=le*be,U.y=-I+xe*c,U.z=le*We,T.push(U.x,U.y,U.z),L.set(se*be,xe,se*We),b.push(L.x,L.y,L.z),y.push(je,Yt.UseOpenGLOrientationForUV?ne/_e:1-ne/_e),de.push(S),S++}C.push(de)}for(D=0;D<n;D++)for(w=0;w<f+a+_;w++){const de=C[w][D],k=C[w+1][D],se=C[w+1][D+1],xe=C[w][D+1];m.push(de),m.push(k),m.push(xe),m.push(k),m.push(se),m.push(xe)}if(m=m.reverse(),o.orientation&&!o.orientation.equals(x.Up())){const de=new H;o.orientation.clone().scale(Math.PI*.5).cross(x.Up()).toQuaternion().toRotationMatrix(de);const k=x.Zero();for(let se=0;se<T.length;se+=3)k.set(T[se],T[se+1],T[se+2]),x.TransformCoordinatesToRef(k.clone(),de,k),T[se]=k.x,T[se+1]=k.y,T[se+2]=k.z}const ce=new Oe;return ce.positions=T,ce.normals=b,ce.uvs=y,ce.indices=m,ce}function rR(o,e={orientation:x.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6,updatable:!1},t=null){const i=new K(o,t);return jT(e).applyToMesh(i,e.updatable),i}K.CreateCapsule=(o,e,t)=>rR(o,e,t);Oe.CreateCapsule=jT;const E_={effect:null,subMesh:null};class da extends Fu{constructor(e,t,i,r={},s=!0){super(e,t,s),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new H,this._cachedWorldViewProjectionMatrix=new H,this._multiview=!1,this._shaderPath=i,this._options={needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1,...r}}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){this._options.uniforms.indexOf(e)===-1&&this._options.uniforms.push(e)}setTexture(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._textures[e]=t,this}setTextureArray(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return this._options.externalTextures.indexOf(e)===-1&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);const i=new Float32Array(t.length*16);for(let r=0;r<t.length;r++)t[r].copyToArray(i,r*16);return this._matrixArrays[e]=i,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return this._options.uniformBuffers.indexOf(e)===-1&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return this._options.samplerObjects.indexOf(e)===-1&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return this._options.storageBuffers.indexOf(e)===-1&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}isReadyForSubMesh(e,t,i){return this.isReady(e,i,t)}isReady(e,t,i){var r,s,n,a;const l=i&&this._storeEffectOnSubMeshes;if(this.isFrozen)if(l){if(i.effect&&i.effect._wasPreviouslyReady)return!0}else{const w=this._drawWrapper.effect;if(w&&w._wasPreviouslyReady&&w._wasPreviouslyUsingInstances===t)return!0}const c=this.getScene(),h=c.getEngine(),u=[],d=[],f=new pc;let _=this._shaderPath,p=this._options.uniforms,m=this._options.uniformBuffers,T=this._options.samplers;h.getCaps().multiview&&c.activeCamera&&c.activeCamera.outputRenderTarget&&c.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,u.push("#define MULTIVIEW"),this._options.uniforms.indexOf("viewProjection")!==-1&&this._options.uniforms.indexOf("viewProjectionR")===-1&&this._options.uniforms.push("viewProjectionR"));for(let w=0;w<this._options.defines.length;w++){const L=this._options.defines[w].indexOf("#define")===0?this._options.defines[w]:`#define ${this._options.defines[w]}`;u.push(L)}for(let w=0;w<this._options.attributes.length;w++)d.push(this._options.attributes[w]);if(e&&e.isVerticesDataPresent(O.ColorKind)&&(d.push(O.ColorKind),u.push("#define VERTEXCOLOR")),t&&(u.push("#define INSTANCES"),Ce.PushAttributesForInstances(d),e!=null&&e.hasThinInstances&&(u.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(O.ColorInstanceKind)&&(d.push(O.ColorInstanceKind),u.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){d.push(O.MatricesIndicesKind),d.push(O.MatricesWeightsKind),e.numBoneInfluencers>4&&(d.push(O.MatricesIndicesExtraKind),d.push(O.MatricesWeightsExtraKind));const w=e.skeleton;u.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),f.addCPUSkinningFallback(0,e),w.isUsingTextureForMatrices?(u.push("#define BONETEXTURE"),this._options.uniforms.indexOf("boneTextureWidth")===-1&&this._options.uniforms.push("boneTextureWidth"),this._options.samplers.indexOf("boneSampler")===-1&&this._options.samplers.push("boneSampler")):(u.push("#define BonesPerMesh "+(w.bones.length+1)),this._options.uniforms.indexOf("mBones")===-1&&this._options.uniforms.push("mBones"))}else u.push("#define NUM_BONE_INFLUENCERS 0");let b=0;const y=e?e.morphTargetManager:null;if(y){const w=y.supportsUVs&&u.indexOf("#define UV1")!==-1,L=y.supportsTangents&&u.indexOf("#define TANGENT")!==-1,U=y.supportsNormals&&u.indexOf("#define NORMAL")!==-1;b=y.numInfluencers,w&&u.push("#define MORPHTARGETS_UV"),L&&u.push("#define MORPHTARGETS_TANGENT"),U&&u.push("#define MORPHTARGETS_NORMAL"),b>0&&u.push("#define MORPHTARGETS"),y.isUsingTextureForTargets&&(u.push("#define MORPHTARGETS_TEXTURE"),this._options.uniforms.indexOf("morphTargetTextureIndices")===-1&&this._options.uniforms.push("morphTargetTextureIndices"),this._options.samplers.indexOf("morphTargets")===-1&&this._options.samplers.push("morphTargets")),u.push("#define NUM_MORPH_INFLUENCERS "+b);for(let G=0;G<b;G++)d.push(O.PositionKind+G),U&&d.push(O.NormalKind+G),L&&d.push(O.TangentKind+G),w&&d.push(O.UVKind+"_"+G);b>0&&(p=p.slice(),p.push("morphTargetInfluences"),p.push("morphTargetTextureInfo"),p.push("morphTargetTextureIndices"))}else u.push("#define NUM_MORPH_INFLUENCERS 0");if(e){const w=e.bakedVertexAnimationManager;w&&w.isEnabled&&(u.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),this._options.uniforms.indexOf("bakedVertexAnimationSettings")===-1&&this._options.uniforms.push("bakedVertexAnimationSettings"),this._options.uniforms.indexOf("bakedVertexAnimationTextureSizeInverted")===-1&&this._options.uniforms.push("bakedVertexAnimationTextureSizeInverted"),this._options.uniforms.indexOf("bakedVertexAnimationTime")===-1&&this._options.uniforms.push("bakedVertexAnimationTime"),this._options.samplers.indexOf("bakedVertexAnimationTexture")===-1&&this._options.samplers.push("bakedVertexAnimationTexture")),Ce.PrepareAttributesForBakedVertexAnimation(d,e,u)}for(const w in this._textures)if(!this._textures[w].isReady())return!1;e&&this._shouldTurnAlphaTestOn(e)&&u.push("#define ALPHATEST"),this._options.useClipPlane!==!1&&(ja(p),Zo(this,c,u)),this.customShaderNameResolve&&(p=p.slice(),m=m.slice(),T=T.slice(),_=this.customShaderNameResolve(_,p,m,T,u,d));const S=l?i._getDrawWrapper():this._drawWrapper,C=(r=S==null?void 0:S.effect)!==null&&r!==void 0?r:null,I=(s=S==null?void 0:S.defines)!==null&&s!==void 0?s:null,P=u.join(`
`);let D=C;return I!==P&&(D=h.createEffect(_,{attributes:d,uniformsNames:p,uniformBuffersNames:m,samplers:T,defines:P,fallbacks:f,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:b},shaderLanguage:this._options.shaderLanguage},h),l?i.setEffect(D,P,this._materialContext):S&&S.setEffect(D,P),this._onEffectCreatedObservable&&(E_.effect=D,E_.subMesh=(n=i??(e==null?void 0:e.subMeshes[0]))!==null&&n!==void 0?n:null,this._onEffectCreatedObservable.notifyObservers(E_))),D._wasPreviouslyUsingInstances=!!t,!((a=!(D!=null&&D.isReady()))!==null&&a!==void 0)||a?!1:(C!==D&&c.resetCachedMaterial(),D._wasPreviouslyReady=!0,!0)}bindOnlyWorldMatrix(e,t){const i=this.getScene(),r=t??this.getEffect();r&&(this._options.uniforms.indexOf("world")!==-1&&r.setMatrix("world",e),this._options.uniforms.indexOf("worldView")!==-1&&(e.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),r.setMatrix("worldView",this._cachedWorldViewMatrix)),this._options.uniforms.indexOf("worldViewProjection")!==-1&&(e.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),r.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)))}bindForSubMesh(e,t,i){var r;this.bind(e,t,(r=i._drawWrapperOverride)===null||r===void 0?void 0:r.effect,i)}bind(e,t,i,r){var s;const n=r&&this._storeEffectOnSubMeshes,a=i??(n?r.effect:this.getEffect());if(!a)return;this._activeEffect=a,this.bindOnlyWorldMatrix(e,i);const l=this._options.uniformBuffers;let c=!1;if(a&&l&&l.length>0&&this.getScene().getEngine().supportsUniformBuffers)for(let u=0;u<l.length;++u)switch(l[u]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e));break;case"Scene":Ce.BindSceneUniformBuffer(a,this.getScene().getSceneUniformBuffer()),this.getScene().finalizeSceneUbo(),c=!0;break}const h=t&&n?this._mustRebind(this.getScene(),a,t.visibility):this.getScene().getCachedMaterial()!==this;if(a&&h){!c&&this._options.uniforms.indexOf("view")!==-1&&a.setMatrix("view",this.getScene().getViewMatrix()),!c&&this._options.uniforms.indexOf("projection")!==-1&&a.setMatrix("projection",this.getScene().getProjectionMatrix()),!c&&this._options.uniforms.indexOf("viewProjection")!==-1&&(a.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._multiview&&a.setMatrix("viewProjectionR",this.getScene()._transformMatrixR)),this.getScene().activeCamera&&this._options.uniforms.indexOf("cameraPosition")!==-1&&a.setVector3("cameraPosition",this.getScene().activeCamera.globalPosition),Ce.BindBonesParameters(t,a),Ra(a,this,this.getScene());let u;for(u in this._textures)a.setTexture(u,this._textures[u]);for(u in this._textureArrays)a.setTextureArray(u,this._textureArrays[u]);for(u in this._externalTextures)a.setExternalTexture(u,this._externalTextures[u]);for(u in this._ints)a.setInt(u,this._ints[u]);for(u in this._uints)a.setUInt(u,this._uints[u]);for(u in this._floats)a.setFloat(u,this._floats[u]);for(u in this._floatsArrays)a.setArray(u,this._floatsArrays[u]);for(u in this._colors3)a.setColor3(u,this._colors3[u]);for(u in this._colors3Arrays)a.setArray3(u,this._colors3Arrays[u]);for(u in this._colors4){const d=this._colors4[u];a.setFloat4(u,d.r,d.g,d.b,d.a)}for(u in this._colors4Arrays)a.setArray4(u,this._colors4Arrays[u]);for(u in this._vectors2)a.setVector2(u,this._vectors2[u]);for(u in this._vectors3)a.setVector3(u,this._vectors3[u]);for(u in this._vectors4)a.setVector4(u,this._vectors4[u]);for(u in this._quaternions)a.setQuaternion(u,this._quaternions[u]);for(u in this._matrices)a.setMatrix(u,this._matrices[u]);for(u in this._matrixArrays)a.setMatrices(u,this._matrixArrays[u]);for(u in this._matrices3x3)a.setMatrix3x3(u,this._matrices3x3[u]);for(u in this._matrices2x2)a.setMatrix2x2(u,this._matrices2x2[u]);for(u in this._vectors2Arrays)a.setArray2(u,this._vectors2Arrays[u]);for(u in this._vectors3Arrays)a.setArray3(u,this._vectors3Arrays[u]);for(u in this._vectors4Arrays)a.setArray4(u,this._vectors4Arrays[u]);for(u in this._quaternionsArrays)a.setArray4(u,this._quaternionsArrays[u]);for(u in this._uniformBuffers){const d=this._uniformBuffers[u].getBuffer();d&&a.bindUniformBuffer(d,u)}for(u in this._textureSamplers)a.setTextureSampler(u,this._textureSamplers[u]);for(u in this._storageBuffers)a.setStorageBuffer(u,this._storageBuffers[u])}if(a&&t&&(h||!this.isFrozen)){const u=t.morphTargetManager;u&&u.numInfluencers>0&&Ce.BindMorphTargetParameters(t,a);const d=t.bakedVertexAnimationManager;d&&d.isEnabled&&((s=t.bakedVertexAnimationManager)===null||s===void 0||s.bind(a,!!a._wasPreviouslyUsingInstances))}this._afterBind(t,a)}getActiveTextures(){const e=super.getActiveTextures();for(const t in this._textures)e.push(this._textures[t]);for(const t in this._textureArrays){const i=this._textureArrays[t];for(let r=0;r<i.length;r++)e.push(i[r])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(const t in this._textures)if(this._textures[t]===e)return!0;for(const t in this._textureArrays){const i=this._textureArrays[t];for(let r=0;r<i.length;r++)if(i[r]===e)return!0}return!1}clone(e){const t=ke.Clone(()=>new da(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes),this);t.name=e,t.id=e,typeof t._shaderPath=="object"&&(t._shaderPath={...t._shaderPath}),this._options={...this._options},Object.keys(this._options).forEach(i=>{const r=this._options[i];Array.isArray(r)&&(this._options[i]=r.slice(0))}),this.stencil.copyTo(t.stencil);for(const i in this._textures)t.setTexture(i,this._textures[i]);for(const i in this._textureArrays)t.setTextureArray(i,this._textureArrays[i]);for(const i in this._externalTextures)t.setExternalTexture(i,this._externalTextures[i]);for(const i in this._ints)t.setInt(i,this._ints[i]);for(const i in this._uints)t.setUInt(i,this._uints[i]);for(const i in this._floats)t.setFloat(i,this._floats[i]);for(const i in this._floatsArrays)t.setFloats(i,this._floatsArrays[i]);for(const i in this._colors3)t.setColor3(i,this._colors3[i]);for(const i in this._colors3Arrays)t._colors3Arrays[i]=this._colors3Arrays[i];for(const i in this._colors4)t.setColor4(i,this._colors4[i]);for(const i in this._colors4Arrays)t._colors4Arrays[i]=this._colors4Arrays[i];for(const i in this._vectors2)t.setVector2(i,this._vectors2[i]);for(const i in this._vectors3)t.setVector3(i,this._vectors3[i]);for(const i in this._vectors4)t.setVector4(i,this._vectors4[i]);for(const i in this._quaternions)t.setQuaternion(i,this._quaternions[i]);for(const i in this._quaternionsArrays)t._quaternionsArrays[i]=this._quaternionsArrays[i];for(const i in this._matrices)t.setMatrix(i,this._matrices[i]);for(const i in this._matrixArrays)t._matrixArrays[i]=this._matrixArrays[i].slice();for(const i in this._matrices3x3)t.setMatrix3x3(i,this._matrices3x3[i]);for(const i in this._matrices2x2)t.setMatrix2x2(i,this._matrices2x2[i]);for(const i in this._vectors2Arrays)t.setArray2(i,this._vectors2Arrays[i]);for(const i in this._vectors3Arrays)t.setArray3(i,this._vectors3Arrays[i]);for(const i in this._vectors4Arrays)t.setArray4(i,this._vectors4Arrays[i]);for(const i in this._uniformBuffers)t.setUniformBuffer(i,this._uniformBuffers[i]);for(const i in this._textureSamplers)t.setTextureSampler(i,this._textureSamplers[i]);for(const i in this._storageBuffers)t.setStorageBuffer(i,this._storageBuffers[i]);return t}dispose(e,t,i){if(t){let r;for(r in this._textures)this._textures[r].dispose();for(r in this._textureArrays){const s=this._textureArrays[r];for(let n=0;n<s.length;n++)s[n].dispose()}}this._textures={},super.dispose(e,t,i)}serialize(){const e=ke.Serialize(this);e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes;let t;e.stencil=this.stencil.serialize(),e.textures={};for(t in this._textures)e.textures[t]=this._textures[t].serialize();e.textureArrays={};for(t in this._textureArrays){e.textureArrays[t]=[];const i=this._textureArrays[t];for(let r=0;r<i.length;r++)e.textureArrays[t].push(i[r].serialize())}e.ints={};for(t in this._ints)e.ints[t]=this._ints[t];e.uints={};for(t in this._uints)e.uints[t]=this._uints[t];e.floats={};for(t in this._floats)e.floats[t]=this._floats[t];e.FloatArrays={};for(t in this._floatsArrays)e.FloatArrays[t]=this._floatsArrays[t];e.colors3={};for(t in this._colors3)e.colors3[t]=this._colors3[t].asArray();e.colors3Arrays={};for(t in this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];e.colors4={};for(t in this._colors4)e.colors4[t]=this._colors4[t].asArray();e.colors4Arrays={};for(t in this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];e.vectors2={};for(t in this._vectors2)e.vectors2[t]=this._vectors2[t].asArray();e.vectors3={};for(t in this._vectors3)e.vectors3[t]=this._vectors3[t].asArray();e.vectors4={};for(t in this._vectors4)e.vectors4[t]=this._vectors4[t].asArray();e.quaternions={};for(t in this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();e.matrices={};for(t in this._matrices)e.matrices[t]=this._matrices[t].asArray();e.matrixArray={};for(t in this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];e.matrices3x3={};for(t in this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];e.matrices2x2={};for(t in this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];e.vectors2Arrays={};for(t in this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];e.vectors3Arrays={};for(t in this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];e.vectors4Arrays={};for(t in this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];e.quaternionsArrays={};for(t in this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,i){const r=ke.Parse(()=>new da(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes),e,t,i);let s;e.stencil&&r.stencil.parse(e.stencil,t,i);for(s in e.textures)r.setTexture(s,Y.Parse(e.textures[s],t,i));for(s in e.textureArrays){const n=e.textureArrays[s],a=new Array;for(let l=0;l<n.length;l++)a.push(Y.Parse(n[l],t,i));r.setTextureArray(s,a)}for(s in e.ints)r.setInt(s,e.ints[s]);for(s in e.uints)r.setUInt(s,e.uints[s]);for(s in e.floats)r.setFloat(s,e.floats[s]);for(s in e.floatsArrays)r.setFloats(s,e.floatsArrays[s]);for(s in e.colors3)r.setColor3(s,ge.FromArray(e.colors3[s]));for(s in e.colors3Arrays){const n=e.colors3Arrays[s].reduce((a,l,c)=>(c%3===0?a.push([l]):a[a.length-1].push(l),a),[]).map(a=>ge.FromArray(a));r.setColor3Array(s,n)}for(s in e.colors4)r.setColor4(s,Ye.FromArray(e.colors4[s]));for(s in e.colors4Arrays){const n=e.colors4Arrays[s].reduce((a,l,c)=>(c%4===0?a.push([l]):a[a.length-1].push(l),a),[]).map(a=>Ye.FromArray(a));r.setColor4Array(s,n)}for(s in e.vectors2)r.setVector2(s,Ie.FromArray(e.vectors2[s]));for(s in e.vectors3)r.setVector3(s,x.FromArray(e.vectors3[s]));for(s in e.vectors4)r.setVector4(s,Tt.FromArray(e.vectors4[s]));for(s in e.quaternions)r.setQuaternion(s,oe.FromArray(e.quaternions[s]));for(s in e.matrices)r.setMatrix(s,H.FromArray(e.matrices[s]));for(s in e.matrixArray)r._matrixArrays[s]=new Float32Array(e.matrixArray[s]);for(s in e.matrices3x3)r.setMatrix3x3(s,e.matrices3x3[s]);for(s in e.matrices2x2)r.setMatrix2x2(s,e.matrices2x2[s]);for(s in e.vectors2Arrays)r.setArray2(s,e.vectors2Arrays[s]);for(s in e.vectors3Arrays)r.setArray3(s,e.vectors3Arrays[s]);for(s in e.vectors4Arrays)r.setArray4(s,e.vectors4Arrays[s]);for(s in e.quaternionsArrays)r.setArray4(s,e.quaternionsArrays[s]);return r}static ParseFromFileAsync(e,t,i,r=""){return new Promise((s,n)=>{const a=new gs;a.addEventListener("readystatechange",()=>{if(a.readyState==4)if(a.status==200){const l=JSON.parse(a.responseText),c=this.Parse(l,i||qe.LastCreatedScene,r);e&&(c.name=e),s(c)}else n("Unable to load the ShaderMaterial")}),a.open("GET",t),a.send()})}static ParseFromSnippetAsync(e,t,i=""){return new Promise((r,s)=>{const n=new gs;n.addEventListener("readystatechange",()=>{if(n.readyState==4)if(n.status==200){const a=JSON.parse(JSON.parse(n.responseText).jsonPayload),l=JSON.parse(a.shaderMaterial),c=this.Parse(l,t||qe.LastCreatedScene,i);c.snippetId=e,r(c)}else s("Unable to load the snippet "+e)}),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()})}}da.SnippetUrl="https://snippet.babylonjs.com";da.CreateFromSnippetAsync=da.ParseFromSnippetAsync;ye("BABYLON.ShaderMaterial",da);const sR="colorPixelShader",nR=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
#define VERTEXCOLOR
varying vec4 vColor;
#else
uniform vec4 color;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
gl_FragColor=vColor;
#else
gl_FragColor=color;
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}`;te.ShadersStore[sR]=nR;const aR="colorVertexShader",oR=`attribute vec3 position;
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
#include<clipPlaneVertex>
#include<vertexColorMixing>
#define CUSTOM_VERTEX_MAIN_END
}`;te.ShadersStore[aR]=oR;K._LinesMeshParser=(o,e)=>Eo.Parse(o,e);class Eo extends K{_isShaderMaterial(e){return e.getClassName()==="ShaderMaterial"}constructor(e,t=null,i=null,r=null,s,n,a,l){super(e,t,i,r,s),this.useVertexColor=n,this.useVertexAlpha=a,this.color=new ge(1,1,1),this.alpha=1,r&&(this.color=r.color.clone(),this.alpha=r.alpha,this.useVertexColor=r.useVertexColor,this.useVertexAlpha=r.useVertexAlpha),this.intersectionThreshold=.1;const c=[],h={attributes:[O.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:c,useClipPlane:null};a===!1?h.needAlphaBlending=!1:h.defines.push("#define VERTEXALPHA"),n?(h.defines.push("#define VERTEXCOLOR"),h.attributes.push(O.ColorKind)):(h.uniforms.push("color"),this._color4=new Ye),l?this.material=l:(this.material=new da("colorShader",this.getScene(),"color",h,!1),this.material.doNotSerialize=!0)}isReady(){return this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage)?super.isReady():!1}getClassName(){return"LinesMesh"}get material(){return this._lineMaterial}set material(e){this._lineMaterial=e,this._lineMaterial.fillMode=me.LineListDrawMode}get checkCollisions(){return!1}set checkCollisions(e){}_bind(e,t){if(!this._geometry)return this;const i=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(this._userInstancedBuffersStorage?this._geometry._bind(t,i,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(t,i),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){const{r,g:s,b:n}=this.color;this._color4.set(r,s,n,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const r=this.getScene().getEngine();return this._unIndexed?r.drawArraysType(me.LineListDrawMode,e.verticesStart,e.verticesCount,i):r.drawElementsType(me.LineListDrawMode,e.indexStart,e.indexCount,i),this}dispose(e,t=!1,i){i||this._lineMaterial.dispose(!1,!1,!0),super.dispose(e)}clone(e,t=null,i){return new Eo(e,this.getScene(),t,this,i)}createInstance(e){const t=new KT(e,this);if(this.instancedBuffers){t.instancedBuffers={};for(const i in this.instancedBuffers)t.instancedBuffers[i]=this.instancedBuffers[i]}return t}serialize(e){super.serialize(e),e.color=this.color.asArray(),e.alpha=this.alpha}static Parse(e,t){const i=new Eo(e.name,t);return i.color=ge.FromArray(e.color),i.alpha=e.alpha,i}}class KT extends $c{constructor(e,t){super(e,t),this.intersectionThreshold=t.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}}function qT(o){const e=[],t=[],i=o.lines,r=o.colors,s=[];let n=0;for(let l=0;l<i.length;l++){const c=i[l];for(let h=0;h<c.length;h++){if(t.push(c[h].x,c[h].y,c[h].z),r){const u=r[l];s.push(u[h].r,u[h].g,u[h].b,u[h].a)}h>0&&(e.push(n-1),e.push(n)),n++}}const a=new Oe;return a.indices=e,a.positions=t,r&&(a.colors=s),a}function QT(o){const e=o.dashSize||3,t=o.gapSize||1,i=o.dashNb||200,r=o.points,s=new Array,n=new Array,a=x.Zero();let l=0,c=0,h=0,u=0,d=0,f=0,_=0;for(_=0;_<r.length-1;_++)r[_+1].subtractToRef(r[_],a),l+=a.length();for(h=l/i,u=e*h/(e+t),_=0;_<r.length-1;_++){r[_+1].subtractToRef(r[_],a),c=Math.floor(a.length()/h),a.normalize();for(let m=0;m<c;m++)d=h*m,s.push(r[_].x+d*a.x,r[_].y+d*a.y,r[_].z+d*a.z),s.push(r[_].x+(d+u)*a.x,r[_].y+(d+u)*a.y,r[_].z+(d+u)*a.z),n.push(f,f+1),f+=2}const p=new Oe;return p.positions=s,p.indices=n,p}function lR(o,e,t){const i=e.instance,r=e.lines,s=e.colors;if(i){const c=i.getVerticesData(O.PositionKind);let h,u;s&&(h=i.getVerticesData(O.ColorKind));let d=0,f=0;for(let _=0;_<r.length;_++){const p=r[_];for(let m=0;m<p.length;m++)c[d]=p[m].x,c[d+1]=p[m].y,c[d+2]=p[m].z,s&&h&&(u=s[_],h[f]=u[m].r,h[f+1]=u[m].g,h[f+2]=u[m].b,h[f+3]=u[m].a,f+=4),d+=3}return i.updateVerticesData(O.PositionKind,c,!1,!1),s&&h&&i.updateVerticesData(O.ColorKind,h,!1,!1),i}const n=!!s,a=new Eo(o,t,null,void 0,void 0,n,e.useVertexAlpha,e.material);return qT(e).applyToMesh(a,e.updatable),a}function Sm(o,e,t=null){const i=e.colors?[e.colors]:null;return lR(o,{lines:[e.points],updatable:e.updatable,instance:e.instance,colors:i,useVertexAlpha:e.useVertexAlpha,material:e.material},t)}function cR(o,e,t=null){const i=e.points,r=e.instance,s=e.gapSize||1,n=e.dashSize||3;if(r){const c=h=>{const u=x.Zero(),d=h.length/6;let f=0,_=0,p=0,m=0,T=0,b=0,y=0,S=0;for(y=0;y<i.length-1;y++)i[y+1].subtractToRef(i[y],u),f+=u.length();p=f/d;const C=r._creationDataStorage.dashSize,I=r._creationDataStorage.gapSize;for(m=C*p/(C+I),y=0;y<i.length-1;y++)for(i[y+1].subtractToRef(i[y],u),_=Math.floor(u.length()/p),u.normalize(),S=0;S<_&&b<h.length;)T=p*S,h[b]=i[y].x+T*u.x,h[b+1]=i[y].y+T*u.y,h[b+2]=i[y].z+T*u.z,h[b+3]=i[y].x+(T+m)*u.x,h[b+4]=i[y].y+(T+m)*u.y,h[b+5]=i[y].z+(T+m)*u.z,b+=6,S++;for(;b<h.length;)h[b]=i[y].x,h[b+1]=i[y].y,h[b+2]=i[y].z,b+=3};return(e.dashNb||e.dashSize||e.gapSize||e.useVertexAlpha||e.material)&&X.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),r.updateMeshPositions(c,!1),r}const a=new Eo(o,t,null,void 0,void 0,void 0,e.useVertexAlpha,e.material);return QT(e).applyToMesh(a,e.updatable),a._creationDataStorage=new gT,a._creationDataStorage.dashSize=n,a._creationDataStorage.gapSize=s,a}Oe.CreateLineSystem=qT;Oe.CreateDashedLines=QT;K.CreateLines=(o,e,t=null,i=!1,r=null)=>Sm(o,{points:e,updatable:i,instance:r},t);K.CreateDashedLines=(o,e,t,i,r,s=null,n,a)=>cR(o,{points:e,dashSize:t,gapSize:i,dashNb:r,updatable:n,instance:a},s);function ZT(o){let e=o.pathArray;const t=o.closeArray||!1,i=o.closePath||!1,r=o.invertUV||!1,s=Math.floor(e[0].length/2);let n=o.offset||s;n=n>s?s:Math.floor(n);const a=o.sideOrientation===0?0:o.sideOrientation||Oe.DEFAULTSIDE,l=o.uvs,c=o.colors,h=[],u=[],d=[],f=[],_=[],p=[],m=[],T=[];let b;const y=[],S=[];let C,I,P;if(e.length<2){const mt=[],Ge=[];for(I=0;I<e[0].length-n;I++)mt.push(e[0][I]),Ge.push(e[0][I+n]);e=[mt,Ge]}let D=0;const w=i?1:0;let L,U;b=e[0].length;let G,Z;for(C=0;C<e.length;C++){for(m[C]=0,_[C]=[0],L=e[C],U=L.length,b=b<U?b:U,P=0;P<U;)h.push(L[P].x,L[P].y,L[P].z),P>0&&(G=L[P].subtract(L[P-1]).length(),Z=G+m[C],_[C].push(Z),m[C]=Z),P++;i&&(P--,h.push(L[0].x,L[0].y,L[0].z),G=L[P].subtract(L[0]).length(),Z=G+m[C],_[C].push(Z),m[C]=Z),y[C]=U+w,S[C]=D,D+=U+w}let he,_e,ne=null,Pe=null;for(I=0;I<b+w;I++){for(T[I]=0,p[I]=[0],C=0;C<e.length-1;C++)he=e[C],_e=e[C+1],I===b?(ne=he[0],Pe=_e[0]):(ne=he[I],Pe=_e[I]),G=Pe.subtract(ne).length(),Z=G+T[I],p[I].push(Z),T[I]=Z;t&&Pe&&ne&&(he=e[C],_e=e[0],I===b&&(Pe=_e[0]),G=Pe.subtract(ne).length(),Z=G+T[I],T[I]=Z)}let Se,ce;if(l)for(C=0;C<l.length;C++)f.push(l[C].x,Yt.UseOpenGLOrientationForUV?1-l[C].y:l[C].y);else for(C=0;C<e.length;C++)for(I=0;I<b+w;I++)Se=m[C]!=0?_[C][I]/m[C]:0,ce=T[I]!=0?p[I][C]/T[I]:0,r?f.push(ce,Se):f.push(Se,Yt.UseOpenGLOrientationForUV?1-ce:ce);C=0;let de=0,k=y[C]-1,se=y[C+1]-1,xe=k<se?k:se,le=S[1]-S[0];const je=t?y.length:y.length-1;for(;de<=xe&&C<je;)u.push(de,de+le,de+1),u.push(de+le+1,de+1,de+le),de+=1,de===xe&&(C++,C===y.length-1?(le=S[0]-S[C],k=y[C]-1,se=y[0]-1):(le=S[C+1]-S[C],k=y[C]-1,se=y[C+1]-1),de=S[C],xe=k<se?k+de:se+de);if(Oe.ComputeNormals(h,u,d),i){let mt=0,Ge=0;for(C=0;C<e.length;C++)mt=S[C]*3,C+1<e.length?Ge=(S[C+1]-1)*3:Ge=d.length-3,d[mt]=(d[mt]+d[Ge])*.5,d[mt+1]=(d[mt+1]+d[Ge+1])*.5,d[mt+2]=(d[mt+2]+d[Ge+2])*.5,d[Ge]=d[mt],d[Ge+1]=d[mt+1],d[Ge+2]=d[mt+2]}Oe._ComputeSides(a,h,u,d,f,o.frontUVs,o.backUVs);let st=null;if(c){st=new Float32Array(c.length*4);for(let mt=0;mt<c.length;mt++)st[mt*4]=c[mt].r,st[mt*4+1]=c[mt].g,st[mt*4+2]=c[mt].b,st[mt*4+3]=c[mt].a}const be=new Oe,We=new Float32Array(h),Ct=new Float32Array(d),_t=new Float32Array(f);return be.indices=u,be.positions=We,be.normals=Ct,be.uvs=_t,st&&be.set(st,O.ColorKind),i&&(be._idx=S),be}function hh(o,e,t=null){const i=e.pathArray,r=e.closeArray,s=e.closePath,n=K._GetDefaultSideOrientation(e.sideOrientation),a=e.instance,l=e.updatable;if(a){const c=j.Vector3[0].setAll(Number.MAX_VALUE),h=j.Vector3[1].setAll(-Number.MAX_VALUE),u=f=>{let _=i[0].length;const p=a;let m=0;const T=p._originalBuilderSideOrientation===K.DOUBLESIDE?2:1;for(let b=1;b<=T;++b)for(let y=0;y<i.length;++y){const S=i[y],C=S.length;_=_<C?_:C;for(let I=0;I<_;++I){const P=S[I];f[m]=P.x,f[m+1]=P.y,f[m+2]=P.z,c.minimizeInPlaceFromFloats(P.x,P.y,P.z),h.maximizeInPlaceFromFloats(P.x,P.y,P.z),m+=3}if(p._creationDataStorage&&p._creationDataStorage.closePath){const I=S[0];f[m]=I.x,f[m+1]=I.y,f[m+2]=I.z,m+=3}}},d=a.getVerticesData(O.PositionKind);if(u(d),a.hasBoundingInfo?a.getBoundingInfo().reConstruct(c,h,a._worldMatrix):a.buildBoundingInfo(c,h,a._worldMatrix),a.updateVerticesData(O.PositionKind,d,!1,!1),e.colors){const f=a.getVerticesData(O.ColorKind);for(let _=0,p=0;_<e.colors.length;_++,p+=4){const m=e.colors[_];f[p]=m.r,f[p+1]=m.g,f[p+2]=m.b,f[p+3]=m.a}a.updateVerticesData(O.ColorKind,f,!1,!1)}if(e.uvs){const f=a.getVerticesData(O.UVKind);for(let _=0;_<e.uvs.length;_++)f[_*2]=e.uvs[_].x,f[_*2+1]=Yt.UseOpenGLOrientationForUV?1-e.uvs[_].y:e.uvs[_].y;a.updateVerticesData(O.UVKind,f,!1,!1)}if(!a.areNormalsFrozen||a.isFacetDataEnabled){const f=a.getIndices(),_=a.getVerticesData(O.NormalKind),p=a.isFacetDataEnabled?a.getFacetDataParameters():null;if(Oe.ComputeNormals(d,f,_,p),a._creationDataStorage&&a._creationDataStorage.closePath){let m=0,T=0;for(let b=0;b<i.length;b++)m=a._creationDataStorage.idx[b]*3,b+1<i.length?T=(a._creationDataStorage.idx[b+1]-1)*3:T=_.length-3,_[m]=(_[m]+_[T])*.5,_[m+1]=(_[m+1]+_[T+1])*.5,_[m+2]=(_[m+2]+_[T+2])*.5,_[T]=_[m],_[T+1]=_[m+1],_[T+2]=_[m+2]}a.areNormalsFrozen||a.updateVerticesData(O.NormalKind,_,!1,!1)}return a}else{const c=new K(o,t);c._originalBuilderSideOrientation=n,c._creationDataStorage=new gT;const h=ZT(e);return s&&(c._creationDataStorage.idx=h._idx),c._creationDataStorage.closePath=s,c._creationDataStorage.closeArray=r,h.applyToMesh(c,l),c}}Oe.CreateRibbon=ZT;K.CreateRibbon=(o,e,t=!1,i,r,s,n=!1,a,l)=>hh(o,{pathArray:e,closeArray:t,closePath:i,offset:r,updatable:n,sideOrientation:a,instance:l},s);function JT(o,e,t=null){const i=e.path,r=e.shape,s=e.scale||1,n=e.rotation||0,a=e.cap===0?0:e.cap||K.NO_CAP,l=e.updatable,c=K._GetDefaultSideOrientation(e.sideOrientation),h=e.instance||null,u=e.invertUV||!1,d=e.closeShape||!1,f=e.closePath||!1;return eE(o,r,i,s,n,null,null,f,d,a,!1,t,!!l,c,h,u,e.frontUVs||null,e.backUVs||null,e.firstNormal||null,!!e.adjustFrame)}function hR(o,e,t=null){const i=e.path,r=e.shape,s=e.scaleFunction||(()=>1),n=e.rotationFunction||(()=>0),a=e.closePath||e.ribbonCloseArray||!1,l=e.closeShape||e.ribbonClosePath||!1,c=e.cap===0?0:e.cap||K.NO_CAP,h=e.updatable,u=e.firstNormal||null,d=e.adjustFrame||!1,f=K._GetDefaultSideOrientation(e.sideOrientation),_=e.instance,p=e.invertUV||!1;return eE(o,r,i,null,null,s,n,a,l,c,!0,t,!!h,f,_||null,p,e.frontUVs||null,e.backUVs||null,u,d)}function eE(o,e,t,i,r,s,n,a,l,c,h,u,d,f,_,p,m,T,b,y){const S=(w,L,U,G,Z,he,_e,ne,Pe,Se,ce)=>{const de=U.getTangents(),k=U.getNormals(),se=U.getBinormals(),xe=U.getDistances();if(ce){for(let Ge=0;Ge<de.length;Ge++)if(de[Ge].x==0&&de[Ge].y==0&&de[Ge].z==0&&de[Ge].copyFrom(de[Ge-1]),k[Ge].x==0&&k[Ge].y==0&&k[Ge].z==0&&k[Ge].copyFrom(k[Ge-1]),se[Ge].x==0&&se[Ge].y==0&&se[Ge].z==0&&se[Ge].copyFrom(se[Ge-1]),Ge>0){let Ut=de[Ge-1];x.Dot(Ut,de[Ge])<0&&de[Ge].scaleInPlace(-1),Ut=k[Ge-1],x.Dot(Ut,k[Ge])<0&&k[Ge].scaleInPlace(-1),Ut=se[Ge-1],x.Dot(Ut,se[Ge])<0&&se[Ge].scaleInPlace(-1)}}let le=0;const je=()=>Z!==null?Z:1,be=Se&&ne?ne:()=>he!==null?he:0,We=Se&&_e?_e:je;let Ct=Pe===K.NO_CAP||Pe===K.CAP_END?0:2;const _t=j.Matrix[0];for(let Ge=0;Ge<L.length;Ge++){const Ut=new Array,Ft=be(Ge,xe[Ge]),Zt=We(Ge,xe[Ge]);H.RotationAxisToRef(de[Ge],le,_t);for(let $t=0;$t<w.length;$t++){const Di=de[Ge].scale(w[$t].z).add(k[Ge].scale(w[$t].x)).add(se[Ge].scale(w[$t].y)),Ui=x.Zero();x.TransformCoordinatesToRef(Di,_t,Ui),Ui.scaleInPlace(Zt).addInPlace(L[Ge]),Ut[$t]=Ui}G[Ct]=Ut,le+=Ft,Ct++}const mt=Ge=>{const Ut=Array(),Ft=x.Zero();let Zt;for(Zt=0;Zt<Ge.length;Zt++)Ft.addInPlace(Ge[Zt]);for(Ft.scaleInPlace(1/Ge.length),Zt=0;Zt<Ge.length;Zt++)Ut.push(Ft);return Ut};switch(Pe){case K.NO_CAP:break;case K.CAP_START:G[0]=mt(G[2]),G[1]=G[2];break;case K.CAP_END:G[Ct]=G[Ct-1],G[Ct+1]=mt(G[Ct-1]);break;case K.CAP_ALL:G[0]=mt(G[2]),G[1]=G[2],G[Ct]=G[Ct-1],G[Ct+1]=mt(G[Ct-1]);break}return G};let C,I;if(_){const w=_._creationDataStorage;return C=b?w.path3D.update(t,b):w.path3D.update(t),I=S(e,t,w.path3D,w.pathArray,i,r,s,n,w.cap,h,y),_=hh("",{pathArray:I,closeArray:!1,closePath:!1,offset:0,updatable:!1,sideOrientation:0,instance:_},u||void 0),_}C=b?new gu(t,b):new gu(t);const P=new Array;c=c<0||c>3?0:c,I=S(e,t,C,P,i,r,s,n,c,h,y);const D=hh(o,{pathArray:I,closeArray:a,closePath:l,updatable:d,sideOrientation:f,invertUV:p,frontUVs:m||void 0,backUVs:T||void 0},u);return D._creationDataStorage.pathArray=I,D._creationDataStorage.path3D=C,D._creationDataStorage.cap=c,D}K.ExtrudeShape=(o,e,t,i,r,s,n=null,a,l,c)=>{const h={shape:e,path:t,scale:i,rotation:r,cap:s===0?0:s||K.NO_CAP,sideOrientation:l,instance:c,updatable:a};return JT(o,h,n)};K.ExtrudeShapeCustom=(o,e,t,i,r,s,n,a,l,c,h,u)=>{const d={shape:e,path:t,scaleFunction:i,rotationFunction:r,ribbonCloseArray:s,ribbonClosePath:n,cap:a===0?0:a||K.NO_CAP,sideOrientation:h,instance:u,updatable:c};return hR(o,d,l)};class ie{}ie.ALPHA_DISABLE=0;ie.ALPHA_ADD=1;ie.ALPHA_COMBINE=2;ie.ALPHA_SUBTRACT=3;ie.ALPHA_MULTIPLY=4;ie.ALPHA_MAXIMIZED=5;ie.ALPHA_ONEONE=6;ie.ALPHA_PREMULTIPLIED=7;ie.ALPHA_PREMULTIPLIED_PORTERDUFF=8;ie.ALPHA_INTERPOLATE=9;ie.ALPHA_SCREENMODE=10;ie.ALPHA_ONEONE_ONEONE=11;ie.ALPHA_ALPHATOCOLOR=12;ie.ALPHA_REVERSEONEMINUS=13;ie.ALPHA_SRC_DSTONEMINUSSRCALPHA=14;ie.ALPHA_ONEONE_ONEZERO=15;ie.ALPHA_EXCLUSION=16;ie.ALPHA_LAYER_ACCUMULATE=17;ie.ALPHA_EQUATION_ADD=0;ie.ALPHA_EQUATION_SUBSTRACT=1;ie.ALPHA_EQUATION_REVERSE_SUBTRACT=2;ie.ALPHA_EQUATION_MAX=3;ie.ALPHA_EQUATION_MIN=4;ie.ALPHA_EQUATION_DARKEN=5;ie.DELAYLOADSTATE_NONE=0;ie.DELAYLOADSTATE_LOADED=1;ie.DELAYLOADSTATE_LOADING=2;ie.DELAYLOADSTATE_NOTLOADED=4;ie.NEVER=512;ie.ALWAYS=519;ie.LESS=513;ie.EQUAL=514;ie.LEQUAL=515;ie.GREATER=516;ie.GEQUAL=518;ie.NOTEQUAL=517;ie.KEEP=7680;ie.ZERO=0;ie.REPLACE=7681;ie.INCR=7682;ie.DECR=7683;ie.INVERT=5386;ie.INCR_WRAP=34055;ie.DECR_WRAP=34056;ie.TEXTURE_CLAMP_ADDRESSMODE=0;ie.TEXTURE_WRAP_ADDRESSMODE=1;ie.TEXTURE_MIRROR_ADDRESSMODE=2;ie.TEXTURE_CREATIONFLAG_STORAGE=1;ie.TEXTUREFORMAT_ALPHA=0;ie.TEXTUREFORMAT_LUMINANCE=1;ie.TEXTUREFORMAT_LUMINANCE_ALPHA=2;ie.TEXTUREFORMAT_RGB=4;ie.TEXTUREFORMAT_RGBA=5;ie.TEXTUREFORMAT_RED=6;ie.TEXTUREFORMAT_R=6;ie.TEXTUREFORMAT_RG=7;ie.TEXTUREFORMAT_RED_INTEGER=8;ie.TEXTUREFORMAT_R_INTEGER=8;ie.TEXTUREFORMAT_RG_INTEGER=9;ie.TEXTUREFORMAT_RGB_INTEGER=10;ie.TEXTUREFORMAT_RGBA_INTEGER=11;ie.TEXTUREFORMAT_BGRA=12;ie.TEXTUREFORMAT_DEPTH24_STENCIL8=13;ie.TEXTUREFORMAT_DEPTH32_FLOAT=14;ie.TEXTUREFORMAT_DEPTH16=15;ie.TEXTUREFORMAT_DEPTH24=16;ie.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17;ie.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18;ie.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492;ie.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493;ie.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495;ie.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494;ie.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779;ie.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919;ie.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778;ie.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918;ie.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777;ie.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776;ie.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917;ie.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916;ie.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808;ie.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840;ie.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196;ie.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492;ie.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493;ie.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494;ie.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495;ie.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496;ie.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497;ie.TEXTURETYPE_UNSIGNED_BYTE=0;ie.TEXTURETYPE_UNSIGNED_INT=0;ie.TEXTURETYPE_FLOAT=1;ie.TEXTURETYPE_HALF_FLOAT=2;ie.TEXTURETYPE_BYTE=3;ie.TEXTURETYPE_SHORT=4;ie.TEXTURETYPE_UNSIGNED_SHORT=5;ie.TEXTURETYPE_INT=6;ie.TEXTURETYPE_UNSIGNED_INTEGER=7;ie.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;ie.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;ie.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;ie.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;ie.TEXTURETYPE_UNSIGNED_INT_24_8=12;ie.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;ie.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;ie.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;ie.TEXTURETYPE_UNDEFINED=16;ie.TEXTURE_NEAREST_SAMPLINGMODE=1;ie.TEXTURE_NEAREST_NEAREST=1;ie.TEXTURE_BILINEAR_SAMPLINGMODE=2;ie.TEXTURE_LINEAR_LINEAR=2;ie.TEXTURE_TRILINEAR_SAMPLINGMODE=3;ie.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;ie.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;ie.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;ie.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;ie.TEXTURE_NEAREST_LINEAR=7;ie.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;ie.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;ie.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;ie.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;ie.TEXTURE_LINEAR_NEAREST=12;ie.TEXTURE_EXPLICIT_MODE=0;ie.TEXTURE_SPHERICAL_MODE=1;ie.TEXTURE_PLANAR_MODE=2;ie.TEXTURE_CUBIC_MODE=3;ie.TEXTURE_PROJECTION_MODE=4;ie.TEXTURE_SKYBOX_MODE=5;ie.TEXTURE_INVCUBIC_MODE=6;ie.TEXTURE_EQUIRECTANGULAR_MODE=7;ie.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;ie.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;ie.TEXTURE_FILTERING_QUALITY_OFFLINE=4096;ie.TEXTURE_FILTERING_QUALITY_HIGH=64;ie.TEXTURE_FILTERING_QUALITY_MEDIUM=16;ie.TEXTURE_FILTERING_QUALITY_LOW=8;ie.SCALEMODE_FLOOR=1;ie.SCALEMODE_NEAREST=2;ie.SCALEMODE_CEILING=3;ie.MATERIAL_TextureDirtyFlag=1;ie.MATERIAL_LightDirtyFlag=2;ie.MATERIAL_FresnelDirtyFlag=4;ie.MATERIAL_AttributesDirtyFlag=8;ie.MATERIAL_MiscDirtyFlag=16;ie.MATERIAL_PrePassDirtyFlag=32;ie.MATERIAL_AllDirtyFlag=63;ie.MATERIAL_TriangleFillMode=0;ie.MATERIAL_WireFrameFillMode=1;ie.MATERIAL_PointFillMode=2;ie.MATERIAL_PointListDrawMode=3;ie.MATERIAL_LineListDrawMode=4;ie.MATERIAL_LineLoopDrawMode=5;ie.MATERIAL_LineStripDrawMode=6;ie.MATERIAL_TriangleStripDrawMode=7;ie.MATERIAL_TriangleFanDrawMode=8;ie.MATERIAL_ClockWiseSideOrientation=0;ie.MATERIAL_CounterClockWiseSideOrientation=1;ie.ACTION_NothingTrigger=0;ie.ACTION_OnPickTrigger=1;ie.ACTION_OnLeftPickTrigger=2;ie.ACTION_OnRightPickTrigger=3;ie.ACTION_OnCenterPickTrigger=4;ie.ACTION_OnPickDownTrigger=5;ie.ACTION_OnDoublePickTrigger=6;ie.ACTION_OnPickUpTrigger=7;ie.ACTION_OnPickOutTrigger=16;ie.ACTION_OnLongPressTrigger=8;ie.ACTION_OnPointerOverTrigger=9;ie.ACTION_OnPointerOutTrigger=10;ie.ACTION_OnEveryFrameTrigger=11;ie.ACTION_OnIntersectionEnterTrigger=12;ie.ACTION_OnIntersectionExitTrigger=13;ie.ACTION_OnKeyDownTrigger=14;ie.ACTION_OnKeyUpTrigger=15;ie.PARTICLES_BILLBOARDMODE_Y=2;ie.PARTICLES_BILLBOARDMODE_ALL=7;ie.PARTICLES_BILLBOARDMODE_STRETCHED=8;ie.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9;ie.MESHES_CULLINGSTRATEGY_STANDARD=0;ie.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;ie.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;ie.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;ie.SCENELOADER_NO_LOGGING=0;ie.SCENELOADER_MINIMAL_LOGGING=1;ie.SCENELOADER_SUMMARY_LOGGING=2;ie.SCENELOADER_DETAILED_LOGGING=3;ie.PREPASS_IRRADIANCE_TEXTURE_TYPE=0;ie.PREPASS_POSITION_TEXTURE_TYPE=1;ie.PREPASS_VELOCITY_TEXTURE_TYPE=2;ie.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3;ie.PREPASS_COLOR_TEXTURE_TYPE=4;ie.PREPASS_DEPTH_TEXTURE_TYPE=5;ie.PREPASS_NORMAL_TEXTURE_TYPE=6;ie.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7;ie.BUFFER_CREATIONFLAG_READ=1;ie.BUFFER_CREATIONFLAG_WRITE=2;ie.BUFFER_CREATIONFLAG_READWRITE=3;ie.BUFFER_CREATIONFLAG_UNIFORM=4;ie.BUFFER_CREATIONFLAG_VERTEX=8;ie.BUFFER_CREATIONFLAG_INDEX=16;ie.BUFFER_CREATIONFLAG_STORAGE=32;ie.RENDERPASS_MAIN=0;ie.INPUT_ALT_KEY=18;ie.INPUT_CTRL_KEY=17;ie.INPUT_META_KEY1=91;ie.INPUT_META_KEY2=92;ie.INPUT_META_KEY3=93;ie.INPUT_SHIFT_KEY=16;ie.SNAPSHOTRENDERING_STANDARD=0;ie.SNAPSHOTRENDERING_FAST=1;ie.PERSPECTIVE_CAMERA=0;ie.ORTHOGRAPHIC_CAMERA=1;ie.FOVMODE_VERTICAL_FIXED=0;ie.FOVMODE_HORIZONTAL_FIXED=1;ie.RIG_MODE_NONE=0;ie.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;ie.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;ie.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;ie.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;ie.RIG_MODE_STEREOSCOPIC_INTERLACED=14;ie.RIG_MODE_VR=20;ie.RIG_MODE_WEBVR=21;ie.RIG_MODE_CUSTOM=22;ie.MAX_SUPPORTED_UV_SETS=6;ie.GL_ALPHA_EQUATION_ADD=32774;ie.GL_ALPHA_EQUATION_MIN=32775;ie.GL_ALPHA_EQUATION_MAX=32776;ie.GL_ALPHA_EQUATION_SUBTRACT=32778;ie.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779;ie.GL_ALPHA_FUNCTION_SRC=768;ie.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769;ie.GL_ALPHA_FUNCTION_SRC_ALPHA=770;ie.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771;ie.GL_ALPHA_FUNCTION_DST_ALPHA=772;ie.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773;ie.GL_ALPHA_FUNCTION_DST_COLOR=774;ie.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775;ie.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776;ie.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769;ie.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770;ie.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771;ie.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772;ie.SnippetUrl="https://snippet.babylonjs.com";ze.prototype._debugPushGroup=function(o,e){};ze.prototype._debugPopGroup=function(o){};ze.prototype._debugInsertMarker=function(o,e){};ze.prototype._debugFlushPendingCommands=function(){};class uR{constructor(){this._timeElapsedQueryEnded=!1}}class dR{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=Qt.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=Qt.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}}q.prototype.createQuery=function(){const o=this._gl.createQuery();if(!o)throw new Error("Unable to create Occlusion Query");return o};q.prototype.deleteQuery=function(o){return this._gl.deleteQuery(o),this};q.prototype.isQueryResultAvailable=function(o){return this._gl.getQueryParameter(o,this._gl.QUERY_RESULT_AVAILABLE)};q.prototype.getQueryResult=function(o){return this._gl.getQueryParameter(o,this._gl.QUERY_RESULT)};q.prototype.beginOcclusionQuery=function(o,e){const t=this._getGlAlgorithmType(o);return this._gl.beginQuery(t,e),!0};q.prototype.endOcclusionQuery=function(o){const e=this._getGlAlgorithmType(o);return this._gl.endQuery(e),this};q.prototype._createTimeQuery=function(){const o=this.getCaps().timerQuery;return o.createQueryEXT?o.createQueryEXT():this.createQuery()};q.prototype._deleteTimeQuery=function(o){const e=this.getCaps().timerQuery;if(e.deleteQueryEXT){e.deleteQueryEXT(o);return}this.deleteQuery(o)};q.prototype._getTimeQueryResult=function(o){const e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(o,e.QUERY_RESULT_EXT):this.getQueryResult(o)};q.prototype._getTimeQueryAvailability=function(o){const e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(o,e.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(o)};q.prototype.startTimeQuery=function(){const o=this.getCaps(),e=o.timerQuery;if(!e)return null;const t=new uR;if(this._gl.getParameter(e.GPU_DISJOINT_EXT),o.canUseTimestampForTimerQuery)t._startTimeQuery=this._createTimeQuery(),e.queryCounterEXT(t._startTimeQuery,e.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;t._timeElapsedQuery=this._createTimeQuery(),e.beginQueryEXT?e.beginQueryEXT(e.TIME_ELAPSED_EXT,t._timeElapsedQuery):this._gl.beginQuery(e.TIME_ELAPSED_EXT,t._timeElapsedQuery),this._currentNonTimestampToken=t}return t};q.prototype.endTimeQuery=function(o){const e=this.getCaps(),t=e.timerQuery;if(!t||!o)return-1;if(e.canUseTimestampForTimerQuery){if(!o._startTimeQuery)return-1;o._endTimeQuery||(o._endTimeQuery=this._createTimeQuery(),t.queryCounterEXT(o._endTimeQuery,t.TIMESTAMP_EXT))}else if(!o._timeElapsedQueryEnded){if(!o._timeElapsedQuery)return-1;t.endQueryEXT?t.endQueryEXT(t.TIME_ELAPSED_EXT):(this._gl.endQuery(t.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),o._timeElapsedQueryEnded=!0}const i=this._gl.getParameter(t.GPU_DISJOINT_EXT);let r=!1;if(o._endTimeQuery?r=this._getTimeQueryAvailability(o._endTimeQuery):o._timeElapsedQuery&&(r=this._getTimeQueryAvailability(o._timeElapsedQuery)),r&&!i){let s=0;if(e.canUseTimestampForTimerQuery){if(!o._startTimeQuery||!o._endTimeQuery)return-1;const n=this._getTimeQueryResult(o._startTimeQuery);s=this._getTimeQueryResult(o._endTimeQuery)-n,this._deleteTimeQuery(o._startTimeQuery),this._deleteTimeQuery(o._endTimeQuery),o._startTimeQuery=null,o._endTimeQuery=null}else{if(!o._timeElapsedQuery)return-1;s=this._getTimeQueryResult(o._timeElapsedQuery),this._deleteTimeQuery(o._timeElapsedQuery),o._timeElapsedQuery=null,o._timeElapsedQueryEnded=!1}return s}return-1};q.prototype._captureGPUFrameTime=!1;q.prototype._gpuFrameTime=new ya;q.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime};q.prototype.captureGPUFrameTime=function(o){o!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=o,o?(this._onBeginFrameObserver=this.onBeginFrameObservable.add(()=>{this._gpuFrameTimeToken||(this._gpuFrameTimeToken=this.startTimeQuery())}),this._onEndFrameObserver=this.onEndFrameObservable.add(()=>{if(!this._gpuFrameTimeToken)return;const e=this.endTimeQuery(this._gpuFrameTimeToken);e>-1&&(this._gpuFrameTimeToken=null,this._gpuFrameTime.fetchNewFrame(),this._gpuFrameTime.addCount(e,!0))})):(this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null))};q.prototype._getGlAlgorithmType=function(o){return o===Qt.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED};Object.defineProperty(Qt.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(o){this._occlusionDataStorage.isOcclusionQueryInProgress=o},enumerable:!1,configurable:!0});Object.defineProperty(Qt.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new dR),this.__occlusionDataStorage},enumerable:!1,configurable:!0});Object.defineProperty(Qt.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(o){this._occlusionDataStorage.isOccluded=o},enumerable:!0,configurable:!0});Object.defineProperty(Qt.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(o){this._occlusionDataStorage.occlusionQueryAlgorithmType=o},enumerable:!0,configurable:!0});Object.defineProperty(Qt.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(o){this._occlusionDataStorage.occlusionType=o},enumerable:!0,configurable:!0});Object.defineProperty(Qt.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(o){this._occlusionDataStorage.occlusionRetryCount=o},enumerable:!0,configurable:!0});Object.defineProperty(Qt.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(o){this._occlusionDataStorage.forceRenderingWhenOccluded=o},enumerable:!0,configurable:!0});Qt.prototype._checkOcclusionQuery=function(){const o=this._occlusionDataStorage;if(o.occlusionType===Qt.OCCLUSION_TYPE_NONE)return o.isOccluded=!1,!1;const e=this.getEngine();if(!e.getCaps().supportOcclusionQuery||!e.isQueryResultAvailable)return o.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this._occlusionQuery)if(e.isQueryResultAvailable(this._occlusionQuery)){const r=e.getQueryResult(this._occlusionQuery);o.isOcclusionQueryInProgress=!1,o.occlusionInternalRetryCounter=0,o.isOccluded=!(r>0)}else if(o.occlusionInternalRetryCounter++,o.occlusionRetryCount!==-1&&o.occlusionInternalRetryCounter>o.occlusionRetryCount)o.isOcclusionQueryInProgress=!1,o.occlusionInternalRetryCounter=0,o.isOccluded=o.occlusionType===Qt.OCCLUSION_TYPE_OPTIMISTIC?!1:o.isOccluded;else return o.occlusionType===Qt.OCCLUSION_TYPE_OPTIMISTIC?!1:o.isOccluded;const t=this.getScene();if(t.getBoundingBoxRenderer){const i=t.getBoundingBoxRenderer();this._occlusionQuery===null&&(this._occlusionQuery=e.createQuery()),e.beginOcclusionQuery(o.occlusionQueryAlgorithmType,this._occlusionQuery)&&(i.renderOcclusionBoundingBox(this),e.endOcclusionQuery(o.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return o.isOccluded};q.prototype.createTransformFeedback=function(){const o=this._gl.createTransformFeedback();if(!o)throw new Error("Unable to create Transform Feedback");return o};q.prototype.deleteTransformFeedback=function(o){this._gl.deleteTransformFeedback(o)};q.prototype.bindTransformFeedback=function(o){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,o)};q.prototype.beginTransformFeedback=function(o=!0){this._gl.beginTransformFeedback(o?this._gl.POINTS:this._gl.TRIANGLES)};q.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()};q.prototype.setTranformFeedbackVaryings=function(o,e){this._gl.transformFeedbackVaryings(o,e,this._gl.INTERLEAVED_ATTRIBS)};q.prototype.bindTransformFeedbackBuffer=function(o){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,o?o.underlyingResource:null)};ze.prototype.createExternalTexture=function(o){return null};ze.prototype.setExternalTexture=function(o,e){throw new Error("setExternalTexture: This engine does not support external textures!")};ze.prototype.updateVideoTexture=function(o,e,t){if(!o||o._isDisabled)return;const i=this._getInternalFormat(o.format),r=this._getRGBABufferInternalSizedFormat(0,o.format),s=this._bindTextureDirectly(this._gl.TEXTURE_2D,o,!0);this._unpackFlipY(!t);try{if(this._videoTextureSupported===void 0&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,i,this._gl.UNSIGNED_BYTE,e),this._gl.getError()!==0?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,i,this._gl.UNSIGNED_BYTE,e);else{if(!o._workingCanvas){o._workingCanvas=this.createCanvas(o.width,o.height);const n=o._workingCanvas.getContext("2d");if(!n)throw new Error("Unable to get 2d context");o._workingContext=n,o._workingCanvas.width=o.width,o._workingCanvas.height=o.height}o._workingContext.clearRect(0,0,o.width,o.height),o._workingContext.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,o.width,o.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,i,this._gl.UNSIGNED_BYTE,o._workingCanvas)}o.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),s||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),o.isReady=!0}catch{o._isDisabled=!0}};ze.prototype.restoreSingleAttachment=function(){const o=this._gl;this.bindAttachments([o.BACK])};ze.prototype.restoreSingleAttachmentForRenderTarget=function(){const o=this._gl;this.bindAttachments([o.COLOR_ATTACHMENT0])};ze.prototype.buildTextureLayout=function(o){const e=this._gl,t=[];for(let i=0;i<o.length;i++)o[i]?t.push(e["COLOR_ATTACHMENT"+i]):t.push(e.NONE);return t};ze.prototype.bindAttachments=function(o){this._gl.drawBuffers(o)};ze.prototype.unBindMultiColorAttachmentFramebuffer=function(o,e=!1,t){this._currentRenderTarget=null;const i=this._gl,r=o._attachments,s=r.length;if(o._MSAAFramebuffer){i.bindFramebuffer(i.READ_FRAMEBUFFER,o._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,o._framebuffer);for(let n=0;n<s;n++){const a=o.textures[n];for(let l=0;l<s;l++)r[l]=i.NONE;r[n]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+n:"COLOR_ATTACHMENT"+n+"_WEBGL"],i.readBuffer(r[n]),i.drawBuffers(r),i.blitFramebuffer(0,0,a.width,a.height,0,0,a.width,a.height,i.COLOR_BUFFER_BIT,i.NEAREST)}for(let n=0;n<s;n++)r[n]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+n:"COLOR_ATTACHMENT"+n+"_WEBGL"];i.drawBuffers(r)}for(let n=0;n<s;n++){const a=o.textures[n];a.generateMipMaps&&!e&&!a.isCube&&(this._bindTextureDirectly(i.TEXTURE_2D,a,!0),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null))}t&&(o._MSAAFramebuffer&&this._bindUnboundFramebuffer(o._framebuffer),t()),this._bindUnboundFramebuffer(null)};ze.prototype.createMultipleRenderTarget=function(o,e,t=!0){let i=!1,r=!0,s=!1,n=!1,a=15,l=1;const c=0,h=3,u=!1;let d=new Array,f=new Array,_=new Array;const p=this._createHardwareRenderTargetWrapper(!0,!1,o);e!==void 0&&(i=e.generateMipMaps===void 0?!1:e.generateMipMaps,r=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,s=e.generateStencilBuffer===void 0?!1:e.generateStencilBuffer,n=e.generateDepthTexture===void 0?!1:e.generateDepthTexture,l=e.textureCount||1,e.types&&(d=e.types),e.samplingModes&&(f=e.samplingModes),e.useSRGBBuffers&&(_=e.useSRGBBuffers),this.webGLVersion>1&&(e.depthTextureFormat===13||e.depthTextureFormat===17||e.depthTextureFormat===16||e.depthTextureFormat===14||e.depthTextureFormat===18)&&(a=e.depthTextureFormat));const m=this._gl,T=m.createFramebuffer();this._bindUnboundFramebuffer(T);const b=o.width||o,y=o.height||o,S=[],C=[],I=this.webGLVersion>1&&n&&(e.depthTextureFormat===13||e.depthTextureFormat===17||e.depthTextureFormat===18),P=this._setupFramebufferDepthAttachments(!I&&s,!n&&r,b,y);p._framebuffer=T,p._depthStencilBuffer=P,p._generateDepthBuffer=!n&&r,p._generateStencilBuffer=!I&&s,p._attachments=C;for(let D=0;D<l;D++){let w=f[D]||h,L=d[D]||c,U=_[D]||u;(L===1&&!this._caps.textureFloatLinearFiltering||L===2&&!this._caps.textureHalfFloatLinearFiltering)&&(w=1);const G=this._getSamplingParameters(w,i);L===1&&!this._caps.textureFloat&&(L=0,X.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),U=U&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const Z=new hi(this,bt.MultiRenderTarget),he=m[this.webGLVersion>1?"COLOR_ATTACHMENT"+D:"COLOR_ATTACHMENT"+D+"_WEBGL"];S.push(Z),C.push(he),m.activeTexture(m["TEXTURE"+D]),m.bindTexture(m.TEXTURE_2D,Z._hardwareTexture.underlyingResource),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,G.mag),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,G.min),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.CLAMP_TO_EDGE),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.CLAMP_TO_EDGE);const _e=this._getRGBABufferInternalSizedFormat(L,5,U);m.texImage2D(m.TEXTURE_2D,0,_e,b,y,0,m.RGBA,this._getWebGLTextureType(L),null),m.framebufferTexture2D(m.DRAW_FRAMEBUFFER,he,m.TEXTURE_2D,Z._hardwareTexture.underlyingResource,0),i&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(m.TEXTURE_2D,null),Z.baseWidth=b,Z.baseHeight=y,Z.width=b,Z.height=y,Z.isReady=!0,Z.samples=1,Z.generateMipMaps=i,Z.samplingMode=w,Z.type=L,Z._useSRGBBuffer=U,this._internalTexturesCache.push(Z)}if(n&&this._caps.depthTextureExtension){const D=new hi(this,bt.Depth);let w=5,L=m.DEPTH_COMPONENT16,U=m.DEPTH_COMPONENT,G=m.UNSIGNED_SHORT,Z=m.DEPTH_ATTACHMENT;this.webGLVersion<2?L=m.DEPTH_COMPONENT:a===14?(w=1,G=m.FLOAT,L=m.DEPTH_COMPONENT32F):a===18?(w=0,G=m.FLOAT_32_UNSIGNED_INT_24_8_REV,L=m.DEPTH32F_STENCIL8,U=m.DEPTH_STENCIL,Z=m.DEPTH_STENCIL_ATTACHMENT):a===16?(w=0,G=m.UNSIGNED_INT,L=m.DEPTH_COMPONENT24,Z=m.DEPTH_ATTACHMENT):(a===13||a===17)&&(w=12,G=m.UNSIGNED_INT_24_8,L=m.DEPTH24_STENCIL8,U=m.DEPTH_STENCIL,Z=m.DEPTH_STENCIL_ATTACHMENT),m.activeTexture(m.TEXTURE0),m.bindTexture(m.TEXTURE_2D,D._hardwareTexture.underlyingResource),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,m.NEAREST),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.NEAREST),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.CLAMP_TO_EDGE),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.CLAMP_TO_EDGE),m.texImage2D(m.TEXTURE_2D,0,L,b,y,0,U,G,null),m.framebufferTexture2D(m.FRAMEBUFFER,Z,m.TEXTURE_2D,D._hardwareTexture.underlyingResource,0),D.baseWidth=b,D.baseHeight=y,D.width=b,D.height=y,D.isReady=!0,D.samples=1,D.generateMipMaps=i,D.samplingMode=1,D.format=a,D.type=w,S.push(D),this._internalTexturesCache.push(D)}return p.setTextures(S),t&&m.drawBuffers(C),this._bindUnboundFramebuffer(null),this.resetTextureCache(),p};ze.prototype.updateMultipleRenderTargetTextureSampleCount=function(o,e,t=!0){if(this.webGLVersion<2||!o||!o.texture)return 1;if(o.samples===e)return e;const i=o._attachments.length;if(i===0)return 1;const r=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples);const s=!!o._depthStencilBuffer;if(s&&(r.deleteRenderbuffer(o._depthStencilBuffer),o._depthStencilBuffer=null),o._MSAAFramebuffer&&(r.deleteFramebuffer(o._MSAAFramebuffer),o._MSAAFramebuffer=null),e>1&&typeof r.renderbufferStorageMultisample=="function"){const n=r.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");o._MSAAFramebuffer=n,this._bindUnboundFramebuffer(n);const a=[];for(let l=0;l<i;l++){const c=o.textures[l],h=c._hardwareTexture,u=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+l:"COLOR_ATTACHMENT"+l+"_WEBGL"],d=h._MSAARenderBuffer?this._updateRenderBuffer(h._MSAARenderBuffer,c.width,c.height,e,-1,this._getRGBAMultiSampleBufferFormat(c.type),u):this._createRenderBuffer(c.width,c.height,e,-1,this._getRGBAMultiSampleBufferFormat(c.type),u);if(!d)throw new Error("Unable to create multi sampled framebuffer");h._MSAARenderBuffer=d,c.samples=e,a.push(u)}t&&r.drawBuffers(a)}else this._bindUnboundFramebuffer(o._framebuffer);return s&&(o._depthStencilBuffer=this._setupFramebufferDepthAttachments(o._generateStencilBuffer,o._generateDepthBuffer,o.texture.width,o.texture.height,e)),this._bindUnboundFramebuffer(null),e};ze.prototype._createDepthStencilCubeTexture=function(o,e,t){const i=new hi(this,bt.DepthStencil);if(i.isCube=!0,this.webGLVersion===1)return X.Error("Depth cube texture is not supported by WebGL 1."),i;const r={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e},s=this._gl;this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,i,!0),this._setupDepthStencilTexture(i,o,r.generateStencil,r.bilinearFiltering,r.comparisonFunction),t._depthStencilTexture=i,t._depthStencilTextureWithStencil=r.generateStencil;for(let n=0;n<6;n++)r.generateStencil?s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,s.DEPTH24_STENCIL8,o,o,0,s.DEPTH_STENCIL,s.UNSIGNED_INT_24_8,null):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,s.DEPTH_COMPONENT24,o,o,0,s.DEPTH_COMPONENT,s.UNSIGNED_INT,null);return this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(i),i};ze.prototype._partialLoadFile=function(o,e,t,i,r=null){const s=a=>{t[e]=a,t._internalCount++,t._internalCount===6&&i(t)},n=(a,l)=>{r&&a&&r(a.status+" "+a.statusText,l)};this._loadFile(o,s,void 0,void 0,!0,n)};ze.prototype._cascadeLoadFiles=function(o,e,t,i=null){const r=[];r._internalCount=0;for(let s=0;s<6;s++)this._partialLoadFile(t[s],s,r,e,i)};ze.prototype._cascadeLoadImgs=function(o,e,t,i,r=null,s){const n=[];n._internalCount=0;for(let a=0;a<6;a++)this._partialLoadImg(i[a],a,n,o,e,t,r,s)};ze.prototype._partialLoadImg=function(o,e,t,i,r,s,n=null,a){const l=rm();Nu(o,u=>{t[e]=u,t._internalCount++,i&&i.removePendingData(l),t._internalCount===6&&s&&s(r,t)},(u,d)=>{i&&i.removePendingData(l),n&&n(u,d)},i?i.offlineProvider:null,a),i&&i.addPendingData(l)};ze.prototype._setCubeMapTextureParams=function(o,e,t){const i=this._gl;i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,e?i.LINEAR_MIPMAP_LINEAR:i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),o.samplingMode=e?3:2,e&&this.getCaps().textureMaxLevel&&t!==void 0&&t>0&&(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_LEVEL,t),o._maxLodLevel=t),this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)};ze.prototype.createCubeTextureBase=function(o,e,t,i,r=null,s=null,n,a=null,l=!1,c=0,h=0,u=null,d=null,f=null,_=!1){const p=u||new hi(this,bt.Cube);p.isCube=!0,p.url=o,p.generateMipMaps=!i,p._lodGenerationScale=c,p._lodGenerationOffset=h,p._useSRGBBuffer=!!_&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||!!i),this._doNotHandleContextLost||(p._extension=a,p._files=t);const m=o;this._transformTextureUrl&&!u&&(o=this._transformTextureUrl(o));const T=o.split("?")[0],b=T.lastIndexOf("."),y=a||(b>-1?T.substring(b).toLowerCase():"");let S=null;for(const I of ze._TextureLoaders)if(I.canLoad(y)){S=I;break}const C=(I,P)=>{o===m?s&&I&&s(I.status+" "+I.statusText,P):(X.Warn(`Failed to load ${o}, falling back to the ${m}`),this.createCubeTextureBase(m,e,t,!!i,r,s,n,a,l,c,h,p,d,f,_))};if(S){const I=P=>{d&&d(p,P),S.loadCubeData(P,p,l,r,s)};t&&t.length===6?S.supportCascades?this._cascadeLoadFiles(e,P=>I(P.map(D=>new Uint8Array(D))),t,s):s?s("Textures type does not support cascades."):X.Warn("Texture loader does not support cascades."):this._loadFile(o,P=>I(new Uint8Array(P)),void 0,void 0,!0,C)}else{if(!t)throw new Error("Cannot load cubemap because files were not defined");this._cascadeLoadImgs(e,p,(I,P)=>{f&&f(I,P)},t,s)}return this._internalTexturesCache.push(p),p};ze.prototype.createCubeTexture=function(o,e,t,i,r=null,s=null,n,a=null,l=!1,c=0,h=0,u=null,d,f=!1){const _=this._gl;return this.createCubeTextureBase(o,e,t,!!i,r,s,n,a,l,c,h,u,p=>this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,p,!0),(p,m)=>{const T=this.needPOTTextures?ze.GetExponentOfTwo(m[0].width,this._caps.maxCubemapTextureSize):m[0].width,b=T,y=[_.TEXTURE_CUBE_MAP_POSITIVE_X,_.TEXTURE_CUBE_MAP_POSITIVE_Y,_.TEXTURE_CUBE_MAP_POSITIVE_Z,_.TEXTURE_CUBE_MAP_NEGATIVE_X,_.TEXTURE_CUBE_MAP_NEGATIVE_Y,_.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,p,!0),this._unpackFlipY(!1);const S=n?this._getInternalFormat(n,p._useSRGBBuffer):p._useSRGBBuffer?_.SRGB8_ALPHA8:_.RGBA;let C=n?this._getInternalFormat(n):_.RGBA;p._useSRGBBuffer&&this.webGLVersion===1&&(C=S);for(let I=0;I<y.length;I++)if(m[I].width!==T||m[I].height!==b){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext){X.Warn("Cannot create canvas to resize texture.");return}this._workingCanvas.width=T,this._workingCanvas.height=b,this._workingContext.drawImage(m[I],0,0,m[I].width,m[I].height,0,0,T,b),_.texImage2D(y[I],0,S,C,_.UNSIGNED_BYTE,this._workingCanvas)}else _.texImage2D(y[I],0,S,C,_.UNSIGNED_BYTE,m[I]);i||_.generateMipmap(_.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(p,!i),p.width=T,p.height=b,p.isReady=!0,n&&(p.format=n),p.onLoadedObservable.notifyObservers(p),p.onLoadedObservable.clear(),r&&r()},!!f)};ze.prototype.setTextureSampler=function(o,e){throw new Error("setTextureSampler: This engine does not support separate texture sampler objects!")};const tE=new Q,iE=new Q;Object.defineProperty(q.prototype,"onBeforeViewRenderObservable",{get:function(){return tE}});Object.defineProperty(q.prototype,"onAfterViewRenderObservable",{get:function(){return iE}});Object.defineProperty(q.prototype,"inputElement",{get:function(){return this._inputElement},set:function(o){var e;this._inputElement!==o&&(this._inputElement=o,(e=this._onEngineViewChanged)===null||e===void 0||e.call(this))}});q.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()};q.prototype.registerView=function(o,e,t){this.views||(this.views=[]);for(const s of this.views)if(s.target===o)return s;const i=this.getRenderingCanvas();i&&(o.width=i.width,o.height=i.height);const r={target:o,camera:e,clearBeforeCopy:t,enabled:!0,id:(Math.random()*1e5).toFixed()};return this.views.push(r),e&&e.onDisposeObservable.add(()=>{this.unRegisterView(o)}),r};q.prototype.unRegisterView=function(o){if(!this.views||this.views.length===0)return this;for(const e of this.views)if(e.target===o){const t=this.views.indexOf(e);t!==-1&&this.views.splice(t,1);break}return this};q.prototype._renderViewStep=function(o){const e=o.target,t=e.getContext("2d");if(!t)return!0;const i=this.getRenderingCanvas();tE.notifyObservers(o);const r=o.camera;let s=null,n=null;if(r){if(n=r.getScene(),!n||n.activeCameras&&n.activeCameras.length)return!0;this.activeView=o,s=n.activeCamera,n.activeCamera=r}if(o.customResize)o.customResize(e);else{const a=Math.floor(e.clientWidth/this._hardwareScalingLevel),l=Math.floor(e.clientHeight/this._hardwareScalingLevel),c=a!==e.width||i.width!==e.width||l!==e.height||i.height!==e.height;e.clientWidth&&e.clientHeight&&c&&(e.width=a,e.height=l,this.setSize(a,l))}return!i.width||!i.height?!1:(this._renderFrame(),this.flushFramebuffer(),o.clearBeforeCopy&&t.clearRect(0,0,i.width,i.height),t.drawImage(i,0,0),s&&n&&(n.activeCamera=s),iE.notifyObservers(o),!0)};q.prototype._renderViews=function(){if(!this.views||this.views.length===0||!this.getRenderingCanvas())return!1;let e;for(const t of this.views){if(!t.enabled)continue;if(t.target===this.inputElement){e=t;continue}if(!this._renderViewStep(t))return!1}return e&&!this._renderViewStep(e)?!1:(this.activeView=null,!0)};ze.prototype.createStorageBuffer=function(o,e){throw new Error("createStorageBuffer: Unsupported method in this engine!")};ze.prototype.updateStorageBuffer=function(o,e,t,i){};ze.prototype.readFromStorageBuffer=function(o,e,t,i){throw new Error("readFromStorageBuffer: Unsupported method in this engine!")};ze.prototype.setStorageBuffer=function(o,e){throw new Error("setStorageBuffer: Unsupported method in this engine!")};function fR(o){const e=s=>{const n="\\b"+s+"\\b";return o&&(o===s||o.match(new RegExp(n,"g")))};if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some(e))return o;const t=o.lastIndexOf("."),i=o.lastIndexOf("?"),r=i>-1?o.substring(i,o.length):"";return(t>-1?o.substring(0,t):o)+this._textureFormatInUse+r}Object.defineProperty(q.prototype,"texturesSupported",{get:function(){const o=new Array;return this._caps.astc&&o.push("-astc.ktx"),this._caps.s3tc&&o.push("-dxt.ktx"),this._caps.pvrtc&&o.push("-pvrtc.ktx"),this._caps.etc2&&o.push("-etc2.ktx"),this._caps.etc1&&o.push("-etc1.ktx"),o},enumerable:!0,configurable:!0});Object.defineProperty(q.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0});q.prototype.setCompressedTextureExclusions=function(o){this._excludedCompressedTextures=o};q.prototype.setTextureFormatToUse=function(o){const e=this.texturesSupported;for(let t=0,i=e.length;t<i;t++)for(let r=0,s=o.length;r<s;r++)if(e[t]===o[r].toLowerCase())return this._transformTextureUrl=fR.bind(this),this._textureFormatInUse=e[t];return this._textureFormatInUse="",this._transformTextureUrl=null,null};class uc{constructor(){const e=new ArrayBuffer(uc.DEFAULT_BUFFER_SIZE);this._uint32s=new Uint32Array(e),this._int32s=new Int32Array(e),this._float32s=new Float32Array(e),this._length=uc.DEFAULT_BUFFER_SIZE/4,this._position=0,this._nativeDataStream=new _native.NativeDataStream(()=>{this._flush()})}writeUint32(e){this._flushIfNecessary(1),this._uint32s[this._position++]=e}writeInt32(e){this._flushIfNecessary(1),this._int32s[this._position++]=e}writeFloat32(e){this._flushIfNecessary(1),this._float32s[this._position++]=e}writeUint32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._uint32s.set(e,this._position),this._position+=e.length}writeInt32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._int32s.set(e,this._position),this._position+=e.length}writeFloat32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._float32s.set(e,this._position),this._position+=e.length}writeNativeData(e){this._flushIfNecessary(e.length),this._uint32s.set(e,this._position),this._position+=e.length}writeBoolean(e){this.writeUint32(e?1:0)}_flushIfNecessary(e){this._position+e>this._length&&this._flush()}_flush(){this._nativeDataStream.writeBuffer(this._uint32s.buffer,this._position),this._position=0}}uc.DEFAULT_BUFFER_SIZE=65536;const ro=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],_R=[()=>1,o=>o.y,o=>o.z,o=>o.x,o=>o.x*o.y,o=>o.y*o.z,o=>3*o.z*o.z-1,o=>o.x*o.z,o=>o.x*o.x-o.y*o.y],Do=(o,e)=>ro[o]*_R[o](e),No=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class dc{constructor(){this.preScaled=!1,this.l00=x.Zero(),this.l1_1=x.Zero(),this.l10=x.Zero(),this.l11=x.Zero(),this.l2_2=x.Zero(),this.l2_1=x.Zero(),this.l20=x.Zero(),this.l21=x.Zero(),this.l22=x.Zero()}addLight(e,t,i){j.Vector3[0].set(t.r,t.g,t.b);const r=j.Vector3[0],s=j.Vector3[1];r.scaleToRef(i,s),s.scaleToRef(Do(0,e),j.Vector3[2]),this.l00.addInPlace(j.Vector3[2]),s.scaleToRef(Do(1,e),j.Vector3[2]),this.l1_1.addInPlace(j.Vector3[2]),s.scaleToRef(Do(2,e),j.Vector3[2]),this.l10.addInPlace(j.Vector3[2]),s.scaleToRef(Do(3,e),j.Vector3[2]),this.l11.addInPlace(j.Vector3[2]),s.scaleToRef(Do(4,e),j.Vector3[2]),this.l2_2.addInPlace(j.Vector3[2]),s.scaleToRef(Do(5,e),j.Vector3[2]),this.l2_1.addInPlace(j.Vector3[2]),s.scaleToRef(Do(6,e),j.Vector3[2]),this.l20.addInPlace(j.Vector3[2]),s.scaleToRef(Do(7,e),j.Vector3[2]),this.l21.addInPlace(j.Vector3[2]),s.scaleToRef(Do(8,e),j.Vector3[2]),this.l22.addInPlace(j.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(No[0]),this.l1_1.scaleInPlace(No[1]),this.l10.scaleInPlace(No[2]),this.l11.scaleInPlace(No[3]),this.l2_2.scaleInPlace(No[4]),this.l2_1.scaleInPlace(No[5]),this.l20.scaleInPlace(No[6]),this.l21.scaleInPlace(No[7]),this.l22.scaleInPlace(No[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(ro[0]),this.l1_1.scaleInPlace(ro[1]),this.l10.scaleInPlace(ro[2]),this.l11.scaleInPlace(ro[3]),this.l2_2.scaleInPlace(ro[4]),this.l2_1.scaleInPlace(ro[5]),this.l20.scaleInPlace(ro[6]),this.l21.scaleInPlace(ro[7]),this.l22.scaleInPlace(ro[8])}updateFromArray(e){return x.FromArrayToRef(e[0],0,this.l00),x.FromArrayToRef(e[1],0,this.l1_1),x.FromArrayToRef(e[2],0,this.l10),x.FromArrayToRef(e[3],0,this.l11),x.FromArrayToRef(e[4],0,this.l2_2),x.FromArrayToRef(e[5],0,this.l2_1),x.FromArrayToRef(e[6],0,this.l20),x.FromArrayToRef(e[7],0,this.l21),x.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return x.FromFloatsToRef(e[0],e[1],e[2],this.l00),x.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),x.FromFloatsToRef(e[6],e[7],e[8],this.l10),x.FromFloatsToRef(e[9],e[10],e[11],this.l11),x.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),x.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),x.FromFloatsToRef(e[18],e[19],e[20],this.l20),x.FromFloatsToRef(e[21],e[22],e[23],this.l21),x.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return new dc().updateFromArray(e)}static FromPolynomial(e){const t=new dc;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}}class Ko{constructor(){this.x=x.Zero(),this.y=x.Zero(),this.z=x.Zero(),this.xx=x.Zero(),this.yy=x.Zero(),this.zz=x.Zero(),this.xy=x.Zero(),this.yz=x.Zero(),this.zx=x.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=dc.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){j.Vector3[0].copyFromFloats(e.r,e.g,e.b);const t=j.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),j.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),j.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(j.Vector3[0]).addInPlace(j.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(j.Vector3[0]).subtractInPlace(j.Vector3[1]),this.zz.copyFrom(e.l00),j.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(j.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return new Ko().updateFromHarmonics(e)}static FromArray(e){const t=new Ko;return x.FromArrayToRef(e[0],0,t.x),x.FromArrayToRef(e[1],0,t.y),x.FromArrayToRef(e[2],0,t.z),x.FromArrayToRef(e[3],0,t.xx),x.FromArrayToRef(e[4],0,t.yy),x.FromArrayToRef(e[5],0,t.zz),x.FromArrayToRef(e[6],0,t.yz),x.FromArrayToRef(e[7],0,t.zx),x.FromArrayToRef(e[8],0,t.xy),t}}const pR="rgbdDecodePixelShader",mR=`varying vec2 vUV;
uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);
}`;te.ShadersStore[pR]=mR;function gR(o,e,t,i=!0){const r=o.getScene(),s=r.getEngine(),n=new Zi("resized"+o.name,{width:e,height:t},r,!o.noMipmap,!0,o._texture.type,!1,o.samplingMode,!1);n.wrapU=o.wrapU,n.wrapV=o.wrapV,n.uOffset=o.uOffset,n.vOffset=o.vOffset,n.uScale=o.uScale,n.vScale=o.vScale,n.uAng=o.uAng,n.vAng=o.vAng,n.wAng=o.wAng,n.coordinatesIndex=o.coordinatesIndex,n.level=o.level,n.anisotropicFilteringLevel=o.anisotropicFilteringLevel,n._texture.isReady=!1,o.wrapU=Y.CLAMP_ADDRESSMODE,o.wrapV=Y.CLAMP_ADDRESSMODE;const a=new So("pass",1,null,i?Y.BILINEAR_SAMPLINGMODE:Y.NEAREST_SAMPLINGMODE,s,!1,0);return a.externalTextureSamplerBinding=!0,a.getEffect().executeWhenCompiled(()=>{a.onApply=function(c){c.setTexture("textureSampler",o)};const l=n.renderTarget;l&&(r.postProcessManager.directRender([a],l),s.unBindFramebuffer(l),n.disposeFramebufferObjects(),a.dispose(),n.getInternalTexture().isReady=!0)}),n}function rE(o,e,t,i,r,s){const n=e.getEngine();return e.isReady=!1,r=r??e.samplingMode,i=i??e.type,s=s??e.format,i===-1&&(i=0),new Promise(a=>{const l=new et("postprocess",o,null,null,1,null,r,n,!1,void 0,i,void 0,null,!1,s);l.externalTextureSamplerBinding=!0;const c=n.createRenderTargetTexture({width:e.width,height:e.height},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:r,type:i,format:s});l.getEffect().executeWhenCompiled(()=>{l.onApply=h=>{h._bindTexture("textureSampler",e),h.setFloat2("scale",1,1)},t.postProcessManager.directRender([l],c,!0),n.restoreDefaultFramebuffer(),n._releaseTexture(e),l&&l.dispose(),c._swapAndDie(e),e.type=i,e.format=5,e.isReady=!0,a(e)})})}let yd,mv;function lo(o){yd||(yd=new Float32Array(1),mv=new Int32Array(yd.buffer)),yd[0]=o;const e=mv[0];let t=e>>16&32768,i=e>>12&2047;const r=e>>23&255;return r<103?t:r>142?(t|=31744,t|=(r==255?0:1)&&e&8388607,t):r<113?(i|=2048,t|=(i>>114-r)+(i>>113-r&1),t):(t|=r-112<<10|i>>1,t+=i&1,t)}function so(o){const e=(o&32768)>>15,t=(o&31744)>>10,i=o&1023;return t===0?(e?-1:1)*Math.pow(2,-14)*(i/Math.pow(2,10)):t==31?i?NaN:(e?-1:1)*(1/0):(e?-1:1)*Math.pow(2,t-15)*(1+i/Math.pow(2,10))}const b_={CreateResizedCopy:gR,ApplyPostProcess:rE,ToHalfFloat:lo,FromHalfFloat:so};class gv{static ExpandRGBDTexture(e){const t=e._texture;if(!t||!e.isRGBD)return;const i=t.getEngine(),r=i.getCaps(),s=t.isReady;let n=!1;r.textureHalfFloatRender&&r.textureHalfFloatLinearFiltering?(n=!0,t.type=2):r.textureFloatRender&&r.textureFloatLinearFiltering&&(n=!0,t.type=1),n&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);const a=()=>{if(n){const l=new et("rgbdDecode","rgbdDecode",null,null,1,null,3,i,!1,void 0,t.type,void 0,null,!1);l.externalTextureSamplerBinding=!0;const c=i.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});l.getEffect().executeWhenCompiled(()=>{l.onApply=h=>{h._bindTexture("textureSampler",t),h.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([l],c,!0),i.restoreDefaultFramebuffer(),i._releaseTexture(t),l&&l.dispose(),c._swapAndDie(t),t.isReady=!0})}};s?a():e.onLoadObservable.addOnce(a)}static EncodeTextureToRGBD(e,t,i=0){return rE("rgbdEncode",e,t,i,1,5)}}class Oc{constructor(e,t,i,r){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=i,this.worldAxisForFileY=r}}class Uf{static ConvertCubeMapTextureToSphericalPolynomial(e){var t;if(!e.isCube)return null;(t=e.getScene())===null||t===void 0||t.getEngine().flushFramebuffer();const i=e.getSize().width,r=e.readPixels(0,void 0,void 0,!1),s=e.readPixels(1,void 0,void 0,!1);let n,a;e.isRenderTarget?(n=e.readPixels(3,void 0,void 0,!1),a=e.readPixels(2,void 0,void 0,!1)):(n=e.readPixels(2,void 0,void 0,!1),a=e.readPixels(3,void 0,void 0,!1));const l=e.readPixels(4,void 0,void 0,!1),c=e.readPixels(5,void 0,void 0,!1),h=e.gammaSpace,u=5;let d=0;return(e.textureType==1||e.textureType==2)&&(d=1),new Promise(f=>{Promise.all([s,r,n,a,l,c]).then(([_,p,m,T,b,y])=>{const S={size:i,right:p,left:_,up:m,down:T,front:b,back:y,format:u,type:d,gammaSpace:h};f(this.ConvertCubeMapToSphericalPolynomial(S))})})}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new dc;let i=0;const r=2/e.size,s=r,n=.5*r,a=n-1;for(let d=0;d<6;d++){const f=this._FileFaces[d],_=e[f.name];let p=a;const m=e.format===5?4:3;for(let T=0;T<e.size;T++){let b=a;for(let y=0;y<e.size;y++){const S=f.worldAxisForFileX.scale(b).add(f.worldAxisForFileY.scale(p)).add(f.worldAxisForNormal);S.normalize();const C=this._AreaElement(b-n,p-n)-this._AreaElement(b-n,p+n)-this._AreaElement(b+n,p-n)+this._AreaElement(b+n,p+n);let I=_[T*e.size*m+y*m+0],P=_[T*e.size*m+y*m+1],D=_[T*e.size*m+y*m+2];isNaN(I)&&(I=0),isNaN(P)&&(P=0),isNaN(D)&&(D=0),e.type===0&&(I/=255,P/=255,D/=255),e.gammaSpace&&(I=Math.pow(Ee.Clamp(I),Ho),P=Math.pow(Ee.Clamp(P),Ho),D=Math.pow(Ee.Clamp(D),Ho));const w=4096;I=Ee.Clamp(I,0,w),P=Ee.Clamp(P,0,w),D=Ee.Clamp(D,0,w);const L=new ge(I,P,D);t.addLight(S,L,C),i+=C,b+=r}p+=s}}const u=4*Math.PI*6/6/i;return t.scaleInPlace(u),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),Ko.FromHarmonics(t)}}Uf._FileFaces=[new Oc("right",new x(1,0,0),new x(0,0,-1),new x(0,-1,0)),new Oc("left",new x(-1,0,0),new x(0,0,1),new x(0,-1,0)),new Oc("up",new x(0,1,0),new x(1,0,0),new x(0,0,1)),new Oc("down",new x(0,-1,0),new x(1,0,0),new x(0,0,-1)),new Oc("front",new x(0,0,1),new x(1,0,0),new x(0,-1,0)),new Oc("back",new x(0,0,-1),new x(-1,0,0),new x(0,-1,0))];ni.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(ni.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=Uf.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(o=>{this._texture._sphericalPolynomial=o,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(o){this._texture&&(this._texture._sphericalPolynomial=o)},enumerable:!0,configurable:!0});const vR="rgbdEncodePixelShader",xR=`varying vec2 vUV;
uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);
}`;te.ShadersStore[vR]=xR;const sE="image/png",vv=2,xv=[134,22,135,150,246,214,150,54];function nE(o){const e=new DataView(o.buffer,o.byteOffset,o.byteLength);let t=0;for(let n=0;n<xv.length;n++)if(e.getUint8(t++)!==xv[n])return X.Error("Not a babylon environment map"),null;let i="",r=0;for(;r=e.getUint8(t++);)i+=String.fromCharCode(r);let s=JSON.parse(i);return s=Vf(s),s.specular&&(s.specular.specularDataPosition=t,s.specular.lodGenerationScale=s.specular.lodGenerationScale||.8),s}function Vf(o){if(o.version>vv)throw new Error(`Unsupported babylon environment map version "${o.version}". Latest supported version is "${vv}".`);return o.version===2||(o={...o,version:2,imageType:sE}),o}function aE(o,e){e=Vf(e);const t=e.specular;let i=Ee.Log2(e.width);if(i=Math.round(i)+1,t.mipmaps.length!==6*i)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);const r=new Array(i);for(let s=0;s<i;s++){r[s]=new Array(6);for(let n=0;n<6;n++){const a=t.mipmaps[s*6+n];r[s][n]=new Uint8Array(o.buffer,o.byteOffset+t.specularDataPosition+a.position,a.length)}}return r}function TR(o,e,t){t=Vf(t);const i=t.specular;if(!i)return Promise.resolve();o._lodGenerationScale=i.lodGenerationScale;const r=aE(e,t);return j_(o,r,t.imageType)}function Tv(o,e,t,i,r,s,n,a,l,c,h){return new Promise((u,d)=>{if(t){const f=e.createTexture(null,!0,!0,null,1,null,_=>{d(_)},o);i.getEffect().executeWhenCompiled(()=>{i.externalTextureSamplerBinding=!0,i.onApply=_=>{_._bindTexture("textureSampler",f),_.setFloat2("scale",1,e._features.needsInvertingBitmap&&o instanceof ImageBitmap?-1:1)},e.scenes.length&&(e.scenes[0].postProcessManager.directRender([i],c,!0,s,n),e.restoreDefaultFramebuffer(),f.dispose(),URL.revokeObjectURL(r),u())})}else{if(e._uploadImageToTexture(h,o,s,n),a){const f=l[n];f&&e._uploadImageToTexture(f._texture,o,s,0)}u()}})}function j_(o,e,t=sE){if(!J.IsExponentOfTwo(o.width))throw new Error("Texture size must be a power of two");const i=Ee.ILog2(o.width)+1,r=o.getEngine();let s=!1,n=!1,a=null,l=null,c=null;const h=r.getCaps();if(o.format=5,o.type=0,o.generateMipMaps=!0,o._cachedAnisotropicFilteringLevel=null,r.updateTextureSamplingMode(3,o),h.textureLOD?r._features.supportRenderAndCopyToLodForFloatTextures?h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?(s=!0,o.type=2):h.textureFloatRender&&h.textureFloatLinearFiltering&&(s=!0,o.type=1):s=!1:(s=!1,n=!0,c={}),s)a=new et("rgbdDecode","rgbdDecode",null,null,1,null,3,r,!1,void 0,o.type,void 0,null,!1),o._isRGBD=!1,o.invertY=!1,l=r.createRenderTargetCubeTexture(o.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:o.type,format:5});else if(o._isRGBD=!0,o.invertY=!0,n){const f=o._lodGenerationScale,_=o._lodGenerationOffset;for(let p=0;p<3;p++){const T=1-p/2,b=_,y=(i-1)*f+_,S=b+(y-b)*T,C=Math.round(Math.min(Math.max(S,0),y)),I=new hi(r,bt.Temp);I.isCube=!0,I.invertY=!0,I.generateMipMaps=!1,r.updateTextureSamplingMode(2,I);const P=new ni(null);switch(P._isCube=!0,P._texture=I,c[C]=P,p){case 0:o._lodTextureLow=P;break;case 1:o._lodTextureMid=P;break;case 2:o._lodTextureHigh=P;break}}}const u=[];for(let d=0;d<e.length;d++)for(let f=0;f<6;f++){const _=e[d][f],p=new Blob([_],{type:t}),m=URL.createObjectURL(p);let T;if(typeof Image>"u"||r._features.forceBitmapOverHTMLImageElement)T=r.createImageBitmap(p,{premultiplyAlpha:"none"}).then(b=>Tv(b,r,s,a,m,f,d,n,c,l,o));else{const b=new Image;b.src=m,T=new Promise((y,S)=>{b.onload=()=>{Tv(b,r,s,a,m,f,d,n,c,l,o).then(()=>y()).catch(C=>{S(C)})},b.onerror=C=>{S(C)}})}u.push(T)}if(e.length<i){let d;const f=Math.pow(2,i-1-e.length),_=f*f*4;switch(o.type){case 0:{d=new Uint8Array(_);break}case 2:{d=new Uint16Array(_);break}case 1:{d=new Float32Array(_);break}}for(let p=e.length;p<i;p++)for(let m=0;m<6;m++)r._uploadArrayBufferViewToTexture(o,d,m,p)}return Promise.all(u).then(()=>{l&&(r._releaseTexture(o),l._swapAndDie(o)),a&&a.dispose(),n&&(o._lodTextureHigh&&o._lodTextureHigh._texture&&(o._lodTextureHigh._texture.isReady=!0),o._lodTextureMid&&o._lodTextureMid._texture&&(o._lodTextureMid._texture.isReady=!0),o._lodTextureLow&&o._lodTextureLow._texture&&(o._lodTextureLow._texture.isReady=!0))})}function oE(o,e){e=Vf(e);const t=e.irradiance;if(!t)return;const i=new Ko;x.FromArrayToRef(t.x,0,i.x),x.FromArrayToRef(t.y,0,i.y),x.FromArrayToRef(t.z,0,i.z),x.FromArrayToRef(t.xx,0,i.xx),x.FromArrayToRef(t.yy,0,i.yy),x.FromArrayToRef(t.zz,0,i.zz),x.FromArrayToRef(t.yz,0,i.yz),x.FromArrayToRef(t.zx,0,i.zx),x.FromArrayToRef(t.xy,0,i.xy),o._sphericalPolynomial=i}function ER(o,e,t,i,r){const s=o.getEngine().createRawCubeTexture(null,o.width,o.format,o.type,o.generateMipMaps,o.invertY,o.samplingMode,o._compression),n=j_(s,e).then(()=>o);return o.onRebuildCallback=a=>({proxy:n,isReady:!0,isAsync:!0}),o._source=bt.CubeRawRGBD,o._bufferViewArrayArray=e,o._lodGenerationScale=i,o._lodGenerationOffset=r,o._sphericalPolynomial=t,j_(o,e).then(()=>(o.isReady=!0,o))}function Cd(o,e,t,i){let r=i,s=0,n="";for(;r<t.length;){const a=t.charAt(r);if(n)a===n?n==='"'||n==="'"?t.charAt(r-1)!=="\\"&&(n=""):n="":n==="*/"&&a==="*"&&r+1<t.length&&(t.charAt(r+1)==="/"&&(n=""),n===""&&r++);else switch(a){case o:s++;break;case e:s--;break;case'"':case"'":case"`":n=a;break;case"/":if(r+1<t.length){const l=t.charAt(r+1);l==="/"?n=`
`:l==="*"&&(n="*/")}break}if(r++,s===0)break}return s===0?r-1:-1}function Ev(o,e){for(;e<o.length;){const t=o[e];if(t!==" "&&t!==`
`&&t!=="\r"&&t!=="	"&&t!==`
`&&t!==" ")break;e++}return e}function S_(o){const e=o.charCodeAt(0);return e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||e==95}function K_(o){let e=0,t="",i=!1;const r=[];for(;e<o.length;){const s=o.charAt(e);if(t)s===t?t==='"'||t==="'"?(o.charAt(e-1)!=="\\"&&(t=""),r.push(s)):(t="",i=!1):t==="*/"&&s==="*"&&e+1<o.length?(o.charAt(e+1)==="/"&&(t=""),t===""&&(i=!1,e++)):i||r.push(s);else{switch(s){case'"':case"'":case"`":t=s;break;case"/":if(e+1<o.length){const n=o.charAt(e+1);n==="/"?(t=`
`,i=!0):n==="*"&&(t="*/",i=!0)}break}i||r.push(s)}e++}return r.join("")}function bR(o,e,t){for(;e>=0&&o.charAt(e)!==t;)e--;return e}function SR(o){return o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}class ac{get code(){return this._sourceCode}constructor(e,t=20){this.debug=!1,this._sourceCode=e,this._numMaxIterations=t,this._functionDescr=[],this.inlineToken="#define inline"}processCode(){this.debug&&console.log(`Start inlining process (code size=${this._sourceCode.length})...`),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&console.log("End of inlining process.")}_collectFunctions(){let e=0;for(;e<this._sourceCode.length;){const t=this._sourceCode.indexOf(this.inlineToken,e);if(t<0)break;const i=this._sourceCode.indexOf("(",t+this.inlineToken.length);if(i<0){this.debug&&console.warn(`Could not find the opening parenthesis after the token. startIndex=${e}`),e=t+this.inlineToken.length;continue}const r=ac._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(t+this.inlineToken.length,i));if(!r){this.debug&&console.warn(`Could not extract the name/type of the function from: ${this._sourceCode.substring(t+this.inlineToken.length,i)}`),e=t+this.inlineToken.length;continue}const[s,n]=[r[3],r[4]],a=Cd("(",")",this._sourceCode,i);if(a<0){this.debug&&console.warn(`Could not extract the parameters the function '${n}' (type=${s}). funcParamsStartIndex=${i}`),e=t+this.inlineToken.length;continue}const l=this._sourceCode.substring(i+1,a),c=Ev(this._sourceCode,a+1);if(c===this._sourceCode.length){this.debug&&console.warn(`Could not extract the body of the function '${n}' (type=${s}). funcParamsEndIndex=${a}`),e=t+this.inlineToken.length;continue}const h=Cd("{","}",this._sourceCode,c);if(h<0){this.debug&&console.warn(`Could not extract the body of the function '${n}' (type=${s}). funcBodyStartIndex=${c}`),e=t+this.inlineToken.length;continue}const u=this._sourceCode.substring(c,h+1),d=K_(l).split(","),f=[];for(let m=0;m<d.length;++m){const T=d[m].trim(),b=T.lastIndexOf(" ");b>=0&&f.push(T.substring(b+1))}s!=="void"&&f.push("return"),this._functionDescr.push({name:n,type:s,parameters:f,body:u,callIndex:0}),e=h+1;const _=t>0?this._sourceCode.substring(0,t):"",p=h+1<this._sourceCode.length-1?this._sourceCode.substring(h+1):"";this._sourceCode=_+p,e-=h+1-t}this.debug&&console.log(`Collect functions: ${this._functionDescr.length} functions found. functionDescr=`,this._functionDescr)}_processInlining(e=20){for(;e-->=0&&this._replaceFunctionCallsByCode(););return this.debug&&console.log(`numMaxIterations is ${e} after inlining process`),e>=0}_replaceFunctionCallsByCode(){let e=!1;for(const t of this._functionDescr){const{name:i,type:r,parameters:s,body:n}=t;let a=0;for(;a<this._sourceCode.length;){const l=this._sourceCode.indexOf(i,a);if(l<0)break;if(l===0||S_(this._sourceCode.charAt(l-1))){a=l+i.length;continue}const c=Ev(this._sourceCode,l+i.length);if(c===this._sourceCode.length||this._sourceCode.charAt(c)!=="("){a=l+i.length;continue}const h=Cd("(",")",this._sourceCode,c);if(h<0){this.debug&&console.warn(`Could not extract the parameters of the function call. Function '${i}' (type=${r}). callParamsStartIndex=${c}`),a=l+i.length;continue}const u=this._sourceCode.substring(c+1,h),f=(y=>{const S=[];let C=0,I=0;for(;C<y.length;){if(y.charAt(C)==="("){const P=Cd("(",")",y,C);if(P<0)return null;C=P}else y.charAt(C)===","&&(S.push(y.substring(I,C)),I=C+1);C++}return I<C&&S.push(y.substring(I,C)),S})(K_(u));if(f===null){this.debug&&console.warn(`Invalid function call: can't extract the parameters of the function call. Function '${i}' (type=${r}). callParamsStartIndex=${c}, callParams=`+u),a=l+i.length;continue}const _=[];for(let y=0;y<f.length;++y){const S=f[y].trim();_.push(S)}const p=r!=="void"?i+"_"+t.callIndex++:null;if(p&&_.push(p+" ="),_.length!==s.length){this.debug&&console.warn(`Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '${i}' (type=${r}). function parameters=${s}, call parameters=${_}`),a=l+i.length;continue}a=h+1;const m=this._replaceNames(n,s,_);let T=l>0?this._sourceCode.substring(0,l):"";const b=h+1<this._sourceCode.length-1?this._sourceCode.substring(h+1):"";if(p){const y=bR(this._sourceCode,l-1,`
`);T=this._sourceCode.substring(0,y+1);const S=this._sourceCode.substring(y+1,l);this._sourceCode=T+r+" "+p+`;
`+m+`
`+S+p+b,this.debug&&console.log(`Replace function call by code. Function '${i}' (type=${r}). injectDeclarationIndex=${y}, call parameters=${_}`)}else this._sourceCode=T+m+b,a+=m.length-(h+1-l),this.debug&&console.log(`Replace function call by code. Function '${i}' (type=${r}). functionCallIndex=${l}, call parameters=${_}`);e=!0}}return e}_replaceNames(e,t,i){for(let r=0;r<t.length;++r){const s=new RegExp(SR(t[r]),"g"),n=t[r].length,a=i[r];e=e.replace(s,(l,...c)=>{const h=c[0];return S_(e.charAt(h-1))||S_(e.charAt(h+n))?t[r]:a})}return e}}ac._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/;class yR{_getVertexShaderCode(){return null}_getFragmentShaderCode(){return null}_handlesSpectorRebuildCallback(e){throw new Error("Not implemented")}constructor(e){this.isAsync=!1,this.isReady=!1,this._valueCache={},this._engine=e}_fillEffectInformation(e,t,i,r,s,n,a,l){const c=this._engine;if(c.supportsUniformBuffers)for(const d in t)e.bindUniformBlock(d,t[d]);this._engine.getUniforms(this,i).forEach((d,f)=>{r[i[f]]=d}),this._uniforms=r;let u;for(u=0;u<s.length;u++)e.getUniform(s[u])==null&&(s.splice(u,1),u--);s.forEach((d,f)=>{n[d]=f}),l.push(...c.getAttributes(this,a))}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],r=t.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[e]=r,!0)}_cacheFloat2(e,t,i){let r=this._valueCache[e];if(!r)return r=[t,i],this._valueCache[e]=r,!0;let s=!1;return r[0]!==t&&(r[0]=t,s=!0),r[1]!==i&&(r[1]=i,s=!0),s}_cacheFloat3(e,t,i,r){let s=this._valueCache[e];if(!s)return s=[t,i,r],this._valueCache[e]=s,!0;let n=!1;return s[0]!==t&&(s[0]=t,n=!0),s[1]!==i&&(s[1]=i,n=!0),s[2]!==r&&(s[2]=r,n=!0),n}_cacheFloat4(e,t,i,r,s){let n=this._valueCache[e];if(!n)return n=[t,i,r,s],this._valueCache[e]=n,!0;let a=!1;return n[0]!==t&&(n[0]=t,a=!0),n[1]!==i&&(n[1]=i,a=!0),n[2]!==r&&(n[2]=r,a=!0),n[3]!==s&&(n[3]=s,a=!0),a}setInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this._engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this._engine.setInt4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this._engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this._engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this._engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this._engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this._engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setUInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setUInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this._engine.setUInt4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this._engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this._engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this._engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this._engine.setUIntArray4(this._uniforms[e],t)}setFloatArray(e,t){this._valueCache[e]=null,this._engine.setFloatArray(this._uniforms[e],t)}setFloatArray2(e,t){this._valueCache[e]=null,this._engine.setFloatArray2(this._uniforms[e],t)}setFloatArray3(e,t){this._valueCache[e]=null,this._engine.setFloatArray3(this._uniforms[e],t)}setFloatArray4(e,t){this._valueCache[e]=null,this._engine.setFloatArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this._engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this._engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this._engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this._engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this._engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setBool(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this._engine.setInt(this._uniforms[e],t?1:0)&&(this._valueCache[e]=t?1:0)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this._engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this._engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setFloat3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this._engine.setFloat4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this._engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}}class CR extends lm{get _framebuffer(){return this.__framebuffer}set _framebuffer(e){this.__framebuffer&&this._engine._releaseFramebufferObjects(this.__framebuffer),this.__framebuffer=e}get _framebufferDepthStencil(){return this.__framebufferDepthStencil}set _framebufferDepthStencil(e){this.__framebufferDepthStencil&&this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil),this.__framebufferDepthStencil=e}constructor(e,t,i,r){super(e,t,i,r),this.__framebuffer=null,this.__framebufferDepthStencil=null,this._engine=r}dispose(e=!1){this._framebuffer=null,this._framebufferDepthStencil=null,super.dispose(e)}}class bv{get underlyingResource(){return this._nativeTexture}constructor(e,t){this._engine=t,this.set(e)}setUsage(){}set(e){this._nativeTexture=e}reset(){this._nativeTexture=null}release(){this._nativeTexture&&this._engine.deleteTexture(this._nativeTexture),this.reset()}}const lE=new Q;if(typeof self<"u"&&!Object.prototype.hasOwnProperty.call(self,"_native")){let o;Object.defineProperty(self,"_native",{get:()=>o,set:e=>{o=e,o&&lE.notifyObservers(o)}})}function AR(){return new Promise(o=>{typeof _native>"u"?lE.addOnce(e=>o(e)):o(_native)})}async function RR(o,e){(await AR())[o]=e}class Sv extends _c{}class IR{constructor(e){this._engine=e,this._pending=new Array,this._isCommandBufferScopeActive=!1,this._commandStream=uh._createNativeDataStream(),this._engine.setCommandDataStream(this._commandStream)}beginCommandScope(){if(this._isCommandBufferScopeActive)throw new Error("Command scope already active.");this._isCommandBufferScopeActive=!0}endCommandScope(){if(!this._isCommandBufferScopeActive)throw new Error("Command scope is not active.");this._isCommandBufferScopeActive=!1,this._submit()}startEncodingCommand(e){this._commandStream.writeNativeData(e)}encodeCommandArgAsUInt32(e){this._commandStream.writeUint32(e)}encodeCommandArgAsUInt32s(e){this._commandStream.writeUint32Array(e)}encodeCommandArgAsInt32(e){this._commandStream.writeInt32(e)}encodeCommandArgAsInt32s(e){this._commandStream.writeInt32Array(e)}encodeCommandArgAsFloat32(e){this._commandStream.writeFloat32(e)}encodeCommandArgAsFloat32s(e){this._commandStream.writeFloat32Array(e)}encodeCommandArgAsNativeData(e){this._commandStream.writeNativeData(e),this._pending.push(e)}finishEncodingCommand(){this._isCommandBufferScopeActive||this._submit()}_submit(){this._engine.submitCommands(),this._pending.length=0}}class uh extends q{getHardwareScalingLevel(){return this._engine.getHardwareScalingLevel()}setHardwareScalingLevel(e){this._engine.setHardwareScalingLevel(e)}constructor(e={}){if(super(null,!1,void 0,e.adaptToDeviceRatio),this._engine=new _native.Engine,this._camera=_native.Camera?new _native.Camera:null,this._commandBufferEncoder=new IR(this._engine),this._boundBuffersVertexArray=null,this._currentDepthTest=_native.Engine.DEPTH_TEST_LEQUAL,this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=519,this._stencilFuncRef=0,this._stencilFuncMask=255,this._stencilOpStencilFail=7680,this._stencilOpDepthFail=7680,this._stencilOpStencilDepthPass=7681,this._zOffset=0,this._zOffsetUnits=0,this._depthWrite=!0,_native.Engine.PROTOCOL_VERSION!==uh.PROTOCOL_VERSION)throw new Error(`Protocol version mismatch: ${_native.Engine.PROTOCOL_VERSION} (Native) !== ${uh.PROTOCOL_VERSION} (JS)`);this._webGLVersion=2,this.disableUniformBuffers=!0,this._shaderPlatformName="NATIVE",this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_SIZE,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,textureFloat:!0,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloat:!1,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!1,textureLOD:!0,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!0,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:1,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!1,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_LAYERS},this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!1,supportSSAO2:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,_collectUbosUpdatedInFrame:!1},J.Log("Babylon Native (v"+q.Version+") launched"),J.LoadScript=function(r,s,n,a){J.LoadFile(r,l=>{Function(l).apply(null),s&&s()},void 0,void 0,!1,(l,c)=>{n&&n("LoadScript Error",c)})},typeof URL>"u"&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),typeof Blob>"u"&&(window.Blob=function(r){return r}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function r(){const s=isNaN(arguments[0])?1:Number(arguments[0]);return s?Array.prototype.reduce.call(this,function(n,a){return Array.isArray(a)?n.push.apply(n,r.call(a,s-1)):n.push(a),n},[]):Array.prototype.slice.call(this)},writable:!0});const t=window&&window.devicePixelRatio||1;this._hardwareScalingLevel=e.adaptToDeviceRatio?t:1,this.resize();const i=this.getDepthFunction();i&&this.setDepthFunction(i),this._shaderProcessor=new nT,this.onNewSceneAddedObservable.add(r=>{const s=r.render;r.render=(...n)=>{this._commandBufferEncoder.beginCommandScope(),s.apply(r,n),this._commandBufferEncoder.endCommandScope()}})}dispose(){super.dispose(),this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._engine.dispose()}static _createNativeDataStream(){return new uc}_queueNewFrame(e,t){return t.requestAnimationFrame&&t!==window?t.requestAnimationFrame(e):this._engine.requestAnimationFrame(e),0}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._currentFramebuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(this._currentFramebuffer),this._commandBufferEncoder.finishEncodingCommand()),e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()),this._currentFramebuffer=e)}getHostDocument(){return null}clear(e,t,i,r=!1){if(this.useReverseDepthBuffer)throw new Error("reverse depth buffer is not currently implemented");this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_CLEAR),this._commandBufferEncoder.encodeCommandArgAsUInt32(t&&e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.r:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.g:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.b:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.a:1),this._commandBufferEncoder.encodeCommandArgAsUInt32(i?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(1),this._commandBufferEncoder.encodeCommandArgAsUInt32(r?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(0),this._commandBufferEncoder.finishEncodingCommand()}createIndexBuffer(e,t){const i=this._normalizeIndexData(e),r=new Sv;return r.references=1,r.is32Bits=i.BYTES_PER_ELEMENT===4,i.byteLength&&(r.nativeIndexBuffer=this._engine.createIndexBuffer(i.buffer,i.byteOffset,i.byteLength,r.is32Bits,t??!1)),r}createVertexBuffer(e,t){const i=ArrayBuffer.isView(e)?e:new Float32Array(e),r=new Sv;return r.references=1,i.byteLength&&(r.nativeVertexBuffer=this._engine.createVertexBuffer(i.buffer,i.byteOffset,i.byteLength,t??!1)),r}_recordVertexArrayObject(e,t,i,r,s){i&&this._engine.recordIndexBuffer(e,i.nativeIndexBuffer);const n=r.getAttributesNames();for(let a=0;a<n.length;a++){const l=r.getAttributeLocation(a);if(l>=0){const c=n[a];let h=null;if(s&&(h=s[c]),h||(h=t[c]),h){const u=h.getBuffer();u&&u.nativeVertexBuffer&&this._engine.recordVertexBuffer(e,u.nativeVertexBuffer,l,h.byteOffset,h.byteStride,h.getSize(),this._getNativeAttribType(h.type),h.normalized,h.getInstanceDivisor())}}}}bindBuffers(e,t,i){this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._boundBuffersVertexArray=this._engine.createVertexArray(),this._recordVertexArrayObject(this._boundBuffersVertexArray,e,t,i),this.bindVertexArrayObject(this._boundBuffersVertexArray)}recordVertexArrayObject(e,t,i,r){const s=this._engine.createVertexArray();return this._recordVertexArrayObject(s,e,t,i,r),s}_deleteVertexArray(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}bindVertexArrayObject(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}releaseVertexArrayObject(e){this._deleteVertexArray(e)}getAttributes(e,t){const i=e;return this._engine.getAttributes(i.nativeProgram,t)}drawElementsType(e,t,i,r){this._drawCalls.addCount(1,!1),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand()}drawArraysType(e,t,i,r){this._drawCalls.addCount(1,!1),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAW),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand()}createPipelineContext(){return new yR(this)}createMaterialContext(){}createDrawContext(){}_preparePipelineContext(e,t,i,r,s,n,a,l){const c=e;r?c.nativeProgram=this.createRawShaderProgram():c.nativeProgram=this.createShaderProgram(e,t,i,l)}_isRenderingStateCompiled(e){return!0}_executeWhenRenderingStateIsCompiled(e,t){t()}createRawShaderProgram(){throw new Error("Not Supported")}createShaderProgram(e,t,i,r){this.onBeforeShaderCompilationObservable.notifyObservers(this);const s=new ac(t);s.processCode(),t=s.code;const n=new ac(i);n.processCode(),i=n.code,t=ze._ConcatenateShader(t,r),i=ze._ConcatenateShader(i,r);const a=this._engine.createProgram(t,i);return this.onAfterShaderCompilationObservable.notifyObservers(this),a}inlineShaderCode(e){const t=new ac(e);return t.debug=!1,t.processCode(),t.code}_setProgram(e){this._currentProgram!==e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand(),this._currentProgram=e)}_deletePipelineContext(e){const t=e;t&&t.nativeProgram&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.nativeProgram),this._commandBufferEncoder.finishEncodingCommand())}getUniforms(e,t){const i=e;return this._engine.getUniforms(i.nativeProgram,t)}bindUniformBlock(e,t,i){throw new Error("Not Implemented")}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.nativeProgram);const i=e.getSamplers();for(let r=0;r<i.length;r++){const s=e.getUniform(i[r]);s&&(this._boundUniforms[r]=s)}this._currentEffect=null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._engine.getRenderWidth()}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._engine.getRenderHeight()}setViewport(e,t,i){this._cachedViewport=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETVIEWPORT),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.x),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.y),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.width),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.height),this._commandBufferEncoder.finishEncodingCommand()}setState(e,t=0,i,r=!1,s,n,a=0){var l,c;this._zOffset=t,this._zOffsetUnits=a,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTATE),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(a),this._commandBufferEncoder.encodeCommandArgAsUInt32(!((c=(l=this.cullBackFaces)!==null&&l!==void 0?l:s)!==null&&c!==void 0)||c?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(r?1:0),this._commandBufferEncoder.finishEncodingCommand()}getInputElementClientRect(){return{bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth(),x:0,y:0,toJSON:()=>{}}}setZOffset(e){e!==this._zOffset&&(this._zOffset=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffset(){return this._zOffset}setZOffsetUnits(e){e!==this._zOffsetUnits&&(this._zOffsetUnits=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffsetUnits(){return this._zOffsetUnits}setDepthBuffer(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?this._currentDepthTest:_native.Engine.DEPTH_TEST_ALWAYS),this._commandBufferEncoder.finishEncodingCommand()}getDepthWrite(){return this._depthWrite}getDepthFunction(){switch(this._currentDepthTest){case _native.Engine.DEPTH_TEST_NEVER:return 512;case _native.Engine.DEPTH_TEST_ALWAYS:return 519;case _native.Engine.DEPTH_TEST_GREATER:return 516;case _native.Engine.DEPTH_TEST_GEQUAL:return 518;case _native.Engine.DEPTH_TEST_NOTEQUAL:return 517;case _native.Engine.DEPTH_TEST_EQUAL:return 514;case _native.Engine.DEPTH_TEST_LESS:return 513;case _native.Engine.DEPTH_TEST_LEQUAL:return 515}return null}setDepthFunction(e){let t=0;switch(e){case 512:t=_native.Engine.DEPTH_TEST_NEVER;break;case 519:t=_native.Engine.DEPTH_TEST_ALWAYS;break;case 516:t=_native.Engine.DEPTH_TEST_GREATER;break;case 518:t=_native.Engine.DEPTH_TEST_GEQUAL;break;case 517:t=_native.Engine.DEPTH_TEST_NOTEQUAL;break;case 514:t=_native.Engine.DEPTH_TEST_EQUAL;break;case 513:t=_native.Engine.DEPTH_TEST_LESS;break;case 515:t=_native.Engine.DEPTH_TEST_LEQUAL;break}this._currentDepthTest=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(this._currentDepthTest),this._commandBufferEncoder.finishEncodingCommand()}setDepthWrite(e){this._depthWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}setColorWrite(e){this._colorWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}getColorWrite(){return this._colorWrite}applyStencil(){this._setStencil(this._stencilMask,this._getStencilOpFail(this._stencilOpStencilFail),this._getStencilDepthFail(this._stencilOpDepthFail),this._getStencilDepthPass(this._stencilOpStencilDepthPass),this._getStencilFunc(this._stencilFunc),this._stencilFuncRef)}_setStencil(e,t,i,r,s,n){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand()}setStencilBuffer(e){this._stencilTest=e,e?this.applyStencil():this._setStencil(255,_native.Engine.STENCIL_OP_FAIL_S_KEEP,_native.Engine.STENCIL_OP_FAIL_Z_KEEP,_native.Engine.STENCIL_OP_PASS_Z_KEEP,_native.Engine.STENCIL_TEST_ALWAYS,0)}getStencilBuffer(){return this._stencilTest}getStencilOperationPass(){return this._stencilOpStencilDepthPass}setStencilOperationPass(e){this._stencilOpStencilDepthPass=e,this.applyStencil()}setStencilMask(e){this._stencilMask=e,this.applyStencil()}setStencilFunction(e){this._stencilFunc=e,this.applyStencil()}setStencilFunctionReference(e){this._stencilFuncRef=e,this.applyStencil()}setStencilFunctionMask(e){this._stencilFuncMask=e}setStencilOperationFail(e){this._stencilOpStencilFail=e,this.applyStencil()}setStencilOperationDepthFail(e){this._stencilOpDepthFail=e,this.applyStencil()}getStencilMask(){return this._stencilMask}getStencilFunction(){return this._stencilFunc}getStencilFunctionReference(){return this._stencilFuncRef}getStencilFunctionMask(){return this._stencilFuncMask}getStencilOperationFail(){return this._stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilOpDepthFail}setAlphaConstants(e,t,i,r){throw new Error("Setting alpha blend constant color not yet implemented.")}setAlphaMode(e,t=!1){if(this._alphaMode===e)return;const i=this._getNativeAlphaMode(e);this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t||this.setDepthWrite(e===0),this._alphaMode=e}getAlphaMode(){return this._alphaMode}setInt(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray2(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray3(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray4(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray2(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray3(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray4(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setArray(e,t){return e?this.setFloatArray(e,new Float32Array(t)):!1}setArray2(e,t){return e?this.setFloatArray2(e,new Float32Array(t)):!1}setArray3(e,t){return e?this.setFloatArray3(e,new Float32Array(t)):!1}setArray4(e,t){return e?this.setFloatArray4(e,new Float32Array(t)):!1}setMatrices(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setMatrix3x3(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setMatrix2x2(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat2(e,t,i){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat3(e,t,i,r){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat4(e,t,i,r,s){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setColor3(e,t){return e?(this.setFloat3(e,t.r,t.g,t.b),!0):!1}setColor4(e,t,i){return e?(this.setFloat4(e,t.r,t.g,t.b,i),!0):!1}wipeCaches(e){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,e&&(this._currentProgram=null,this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}_createTexture(){return this._engine.createTexture()}_deleteTexture(e){e&&this._engine.deleteTexture(e)}updateDynamicTexture(e,t,i,r=!1,s){if(r===void 0&&(r=!1),e&&e._hardwareTexture){const n=t.getCanvasTexture(),a=e._hardwareTexture.underlyingResource;this._engine.copyTexture(a,n),e.isReady=!0}}createDynamicTexture(e,t,i,r){return e=Math.max(e,1),t=Math.max(t,1),this.createRawTexture(new Uint8Array(e*t*4),e,t,5,!1,!1,r)}createVideoElement(e){return this._camera?this._camera.createVideo(e):null}updateVideoTexture(e,t,i){if(e&&e._hardwareTexture&&this._camera){const r=e._hardwareTexture.underlyingResource;this._camera.updateVideoTexture(r,t,i)}}createRawTexture(e,t,i,r,s,n,a,l=null,c=0,h=0,u=!1){const d=new hi(this,bt.Raw);if(d.format=r,d.generateMipMaps=s,d.samplingMode=a,d.invertY=n,d.baseWidth=t,d.baseHeight=i,d.width=d.baseWidth,d.height=d.baseHeight,d._compression=l,d.type=c,d._useSRGBBuffer=this._getUseSRGBBuffer(u,!s),this.updateRawTexture(d,e,r,n,l,c,d._useSRGBBuffer),d._hardwareTexture){const f=d._hardwareTexture.underlyingResource,_=this._getNativeSamplingMode(a);this._setTextureSampling(f,_)}return this._internalTexturesCache.push(d),d}createRawTexture2DArray(e,t,i,r,s,n,a,l,c=null,h=0){const u=new hi(this,bt.Raw2DArray);if(u.baseWidth=t,u.baseHeight=i,u.baseDepth=r,u.width=t,u.height=i,u.depth=r,u.format=s,u.type=h,u.generateMipMaps=n,u.samplingMode=l,u.is2DArray=!0,u._hardwareTexture){const d=u._hardwareTexture.underlyingResource;this._engine.loadRawTexture2DArray(d,e,t,i,r,this._getNativeTextureFormat(s,h),n,a);const f=this._getNativeSamplingMode(l);this._setTextureSampling(d,f)}return u.isReady=!0,this._internalTexturesCache.push(u),u}updateRawTexture(e,t,i,r,s=null,n=0,a=!1){if(e){if(t&&e._hardwareTexture){const l=e._hardwareTexture.underlyingResource;this._engine.loadRawTexture(l,t,e.width,e.height,this._getNativeTextureFormat(i,n),e.generateMipMaps,e.invertY)}e.isReady=!0}}createTexture(e,t,i,r,s=3,n=null,a=null,l=null,c=null,h=null,u=null,d,f,_,p=!1){e=e||"";const m=e.substr(0,5)==="data:",T=m&&e.indexOf(";base64,")!==-1,b=c||new hi(this,bt.Url),y=e;this._transformTextureUrl&&!T&&!c&&!l&&(e=this._transformTextureUrl(e));const S=e.lastIndexOf("."),C=u||(S>-1?e.substring(S).toLowerCase():"");let I=null;for(const w of q._TextureLoaders)if(w.canLoad(C)){I=w;break}r&&r.addPendingData(b),b.url=e,b.generateMipMaps=!t,b.samplingMode=s,b.invertY=i,b._useSRGBBuffer=this._getUseSRGBBuffer(p,t),this.doNotHandleContextLost||(b._buffer=l);let P=null;n&&!c&&(P=b.onLoadedObservable.add(n)),c||this._internalTexturesCache.push(b);const D=(w,L)=>{r&&r.removePendingData(b),e===y?(P&&b.onLoadedObservable.remove(P),qe.UseFallbackTexture&&this.createTexture(qe.FallbackTexture,t,b.invertY,r,s,null,a,l,b),a&&a((w||"Unknown error")+(qe.UseFallbackTexture?" - Fallback texture was used":""),L)):(X.Warn(`Failed to load ${e}, falling back to ${y}`),this.createTexture(y,t,b.invertY,r,s,n,a,l,b,h,u,d,f))};if(I)throw new Error("Loading textures from IInternalTextureLoader not yet implemented.");{const w=L=>{if(!b._hardwareTexture){r&&r.removePendingData(b);return}const U=b._hardwareTexture.underlyingResource;this._engine.loadTexture(U,L,!t,i,p,()=>{b.baseWidth=this._engine.getTextureWidth(U),b.baseHeight=this._engine.getTextureHeight(U),b.width=b.baseWidth,b.height=b.baseHeight,b.isReady=!0;const G=this._getNativeSamplingMode(s);this._setTextureSampling(U,G),r&&r.removePendingData(b),b.onLoadedObservable.notifyObservers(b),b.onLoadedObservable.clear()},()=>{throw new Error("Could not load a native texture.")})};if(m&&l)if(l instanceof ArrayBuffer)w(new Uint8Array(l));else if(ArrayBuffer.isView(l))w(l);else if(typeof l=="string")w(new Uint8Array(J.DecodeBase64(l)));else throw new Error("Unsupported buffer type");else T?w(new Uint8Array(J.DecodeBase64(e))):this._loadFile(e,L=>w(new Uint8Array(L)),void 0,void 0,!0,(L,U)=>{D("Unable to load "+(L&&L.responseURL,U))})}return b}wrapNativeTexture(e){const t=new bv(e,this._engine),i=new hi(this,bt.Unknown,!0);return i._hardwareTexture=t,i.isReady=!0,i}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapNativeTexture instead.")}_createDepthStencilTexture(e,t,i){const r=i,s=new hi(this,bt.DepthStencil),n=e.width||e,a=e.height||e,l=this._engine.createFrameBuffer(s._hardwareTexture.underlyingResource,n,a,!0,!0);return r._framebufferDepthStencil=l,s}_releaseFramebufferObjects(e){e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand())}_createImageBitmapFromSource(e,t){return new Promise((r,s)=>{const n=this.createCanvasImage();n.onload=()=>{try{const a=this._engine.createImageBitmap(n);r(a)}catch(a){s(`Error loading image ${n.src} with exception: ${a}`)}},n.onerror=a=>{s(`Error loading image ${n.src} with exception: ${a}`)},n.src=e})}createImageBitmap(e,t){return new Promise((i,r)=>{if(Array.isArray(e)){const s=e;if(s.length){const n=this._engine.createImageBitmap(s[0]);if(n){i(n);return}}}r("Unsupported data for createImageBitmap.")})}resizeImageBitmap(e,t,i){return this._engine.resizeImageBitmap(e,t,i)}createCubeTexture(e,t,i,r,s=null,n=null,a,l=null,c=!1,h=0,u=0,d=null,f,_=!1){const p=d||new hi(this,bt.Cube);p.isCube=!0,p.url=e,p.generateMipMaps=!r,p._lodGenerationScale=h,p._lodGenerationOffset=u,this._doNotHandleContextLost||(p._extension=l,p._files=i);const m=e.lastIndexOf(".");if((l||(m>-1?e.substring(m).toLowerCase():""))===".env"){const b=y=>{const S=nE(y);p.width=S.width,p.height=S.width,oE(p,S);const C=S.specular;if(!C)throw new Error("Nothing else parsed so far");p._lodGenerationScale=C.lodGenerationScale;const I=aE(y,S);p.format=5,p.type=0,p.generateMipMaps=!0,p.getEngine().updateTextureSamplingMode(Y.TRILINEAR_SAMPLINGMODE,p),p._isRGBD=!0,p.invertY=!0,this._engine.loadCubeTextureWithMips(p._hardwareTexture.underlyingResource,I,!1,_,()=>{p.isReady=!0,s&&s()},()=>{throw new Error("Could not load a native cube texture.")})};if(i&&i.length===6)throw new Error("Multi-file loading not allowed on env files.");{const y=(S,C)=>{n&&S&&n(S.status+" "+S.statusText,C)};this._loadFile(e,S=>b(new Uint8Array(S)),void 0,void 0,!0,y)}}else{if(!i||i.length!==6)throw new Error("Cannot load cubemap because 6 files were not defined");const b=[i[0],i[3],i[1],i[4],i[2],i[5]];Promise.all(b.map(y=>J.LoadFileAsync(y).then(S=>new Uint8Array(S)))).then(y=>new Promise((S,C)=>{this._engine.loadCubeTexture(p._hardwareTexture.underlyingResource,y,!r,!0,_,S,C)})).then(()=>{p.isReady=!0,s&&s()},y=>{n&&n(`Failed to load cubemap: ${y.message}`,y)})}return this._internalTexturesCache.push(p),p}_createHardwareTexture(){return new bv(this._createTexture(),this._engine)}_createHardwareRenderTargetWrapper(e,t,i){const r=new CR(e,t,i,this);return this._renderTargetWrapperCache.push(r),r}_createInternalTexture(e,t,i=!0,r=bt.Unknown){var s;let n=!1,a=0,l=3,c=5,h=!1,u=1;t!==void 0&&typeof t=="object"?(n=!!t.generateMipMaps,a=t.type===void 0?0:t.type,l=t.samplingMode===void 0?3:t.samplingMode,c=t.format===void 0?5:t.format,h=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer,u=(s=t.samples)!==null&&s!==void 0?s:1):n=!!t,h&&(h=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(a===1&&!this._caps.textureFloatLinearFiltering||a===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l=1),a===1&&!this._caps.textureFloat&&(a=0,X.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const d=new hi(this,r),f=e.width||e,_=e.height||e,p=e.layers||0;if(p!==0)throw new Error("Texture layers are not supported in Babylon Native");const m=d._hardwareTexture.underlyingResource,T=this._getNativeTextureFormat(c,a);return this._engine.initializeTexture(m,f,_,n,T,!0,h),this._setTextureSampling(m,this._getNativeSamplingMode(l)),d._useSRGBBuffer=h,d.baseWidth=f,d.baseHeight=_,d.width=f,d.height=_,d.depth=p,d.isReady=!0,d.samples=u,d.generateMipMaps=n,d.samplingMode=l,d.type=a,d.format=c,this._internalTexturesCache.push(d),d}createRenderTargetTexture(e,t){var i;const r=this._createHardwareRenderTargetWrapper(!1,!1,e);let s=!0,n=!1,a=!1,l;t!==void 0&&typeof t=="object"&&(s=(i=t.generateDepthBuffer)!==null&&i!==void 0?i:!0,n=!!t.generateStencilBuffer,a=!!t.noColorAttachment,l=t.colorAttachment);const c=l||(a?null:this._createInternalTexture(e,t,!0,bt.RenderTarget)),h=e.width||e,u=e.height||e,d=this._engine.createFrameBuffer(c?c._hardwareTexture.underlyingResource:null,h,u,n,s);return r._framebuffer=d,r._generateDepthBuffer=s,r._generateStencilBuffer=n,r.setTextures(c),r}updateTextureSamplingMode(e,t){if(t._hardwareTexture){const i=this._getNativeSamplingMode(e);this._setTextureSampling(t._hardwareTexture.underlyingResource,i)}t.samplingMode=e}bindFramebuffer(e,t,i,r,s){const n=e;if(this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,t)throw new Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(i||r)throw new Error("Required width/height for frame buffers not yet supported in NativeEngine.");n._framebufferDepthStencil?this._bindUnboundFramebuffer(n._framebufferDepthStencil):this._bindUnboundFramebuffer(n._framebuffer)}unBindFramebuffer(e,t=!1,i){this._currentRenderTarget=null,i&&i(),this._bindUnboundFramebuffer(null)}createDynamicVertexBuffer(e){return this.createVertexBuffer(e,!0)}updateDynamicIndexBuffer(e,t,i=0){const r=e,s=this._normalizeIndexData(t);r.is32Bits=s.BYTES_PER_ELEMENT===4,this._engine.updateDynamicIndexBuffer(r.nativeIndexBuffer,s.buffer,s.byteOffset,s.byteLength,i)}updateDynamicVertexBuffer(e,t,i,r){const s=e,n=ArrayBuffer.isView(t)?t:new Float32Array(t);this._engine.updateDynamicVertexBuffer(s.nativeVertexBuffer,n.buffer,n.byteOffset+(i??0),r??n.byteLength)}_setTexture(e,t,i=!1,r=!1){const s=this._boundUniforms[e];if(!s)return!1;if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._boundTexturesCache[e]=null),!1;if(t.video)this._activeChannel=e,t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;let n;return r?n=t.depthStencilTexture:t.isReady()?n=t.getInternalTexture():t.isCube?n=this.emptyCubeTexture:t.is3D?n=this.emptyTexture3D:t.is2DArray?n=this.emptyTexture2DArray:n=this.emptyTexture,this._activeChannel=e,!n||!n._hardwareTexture?!1:(this._setTextureWrapMode(n._hardwareTexture.underlyingResource,this._getAddressMode(t.wrapU),this._getAddressMode(t.wrapV),this._getAddressMode(t.wrapR)),this._updateAnisotropicLevel(t),this._setTextureCore(s,n._hardwareTexture.underlyingResource),!0)}_setTextureSampling(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.finishEncodingCommand()}_setTextureWrapMode(e,t,i,r){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.finishEncodingCommand()}_setTextureCore(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()}_updateAnisotropicLevel(e){const t=e.getInternalTexture(),i=e.anisotropicFilteringLevel;!t||!t._hardwareTexture||t._cachedAnisotropicFilteringLevel!==i&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL),this._commandBufferEncoder.encodeCommandArgAsNativeData(t._hardwareTexture.underlyingResource),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t._cachedAnisotropicFilteringLevel=i)}_getAddressMode(e){switch(e){case 1:return _native.Engine.ADDRESS_MODE_WRAP;case 0:return _native.Engine.ADDRESS_MODE_CLAMP;case 2:return _native.Engine.ADDRESS_MODE_MIRROR;default:throw new Error("Unexpected wrap mode: "+e+".")}}_bindTexture(e,t){const i=this._boundUniforms[e];if(i&&t&&t._hardwareTexture){const r=t._hardwareTexture.underlyingResource;this._setTextureCore(i,r)}}_deleteBuffer(e){e.nativeIndexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeIndexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeIndexBuffer),e.nativeVertexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeVertexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeVertexBuffer)}createCanvas(e,t){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");const i=new _native.Canvas;return i.width=e,i.height=t,i}createCanvasImage(){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");return new _native.Image}updateTextureData(e,t,i,r,s,n,a=0,l=0,c=!1){throw new Error("updateTextureData not implemented.")}_uploadCompressedDataToTextureDirectly(e,t,i,r,s,n=0,a=0){throw new Error("_uploadCompressedDataToTextureDirectly not implemented.")}_uploadDataToTextureDirectly(e,t,i=0,r=0){throw new Error("_uploadDataToTextureDirectly not implemented.")}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_uploadImageToTexture(e,t,i=0,r=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_getNativeSamplingMode(e){switch(e){case 1:return _native.Engine.TEXTURE_NEAREST_NEAREST;case 2:return _native.Engine.TEXTURE_LINEAR_LINEAR;case 3:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return _native.Engine.TEXTURE_NEAREST_LINEAR;case 8:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return _native.Engine.TEXTURE_LINEAR_NEAREST;default:throw new Error(`Unsupported sampling mode: ${e}.`)}}_getStencilFunc(e){switch(e){case 513:return _native.Engine.STENCIL_TEST_LESS;case 515:return _native.Engine.STENCIL_TEST_LEQUAL;case 514:return _native.Engine.STENCIL_TEST_EQUAL;case 518:return _native.Engine.STENCIL_TEST_GEQUAL;case 516:return _native.Engine.STENCIL_TEST_GREATER;case 517:return _native.Engine.STENCIL_TEST_NOTEQUAL;case 512:return _native.Engine.STENCIL_TEST_NEVER;case 519:return _native.Engine.STENCIL_TEST_ALWAYS;default:throw new Error(`Unsupported stencil func mode: ${e}.`)}}_getStencilOpFail(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_S_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_S_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_S_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_S_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_S_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;default:throw new Error(`Unsupported stencil OpFail mode: ${e}.`)}}_getStencilDepthFail(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;default:throw new Error(`Unsupported stencil depthFail mode: ${e}.`)}}_getStencilDepthPass(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_PASS_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_PASS_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_PASS_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_PASS_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_PASS_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;default:throw new Error(`Unsupported stencil opPass mode: ${e}.`)}}_getNativeTextureFormat(e,t){if(e==4&&t==0)return _native.Engine.TEXTURE_FORMAT_RGB8;if(e==5&&t==0)return _native.Engine.TEXTURE_FORMAT_RGBA8;if(e==5&&t==2)return _native.Engine.TEXTURE_FORMAT_RGBA16F;if(e==5&&t==1)return _native.Engine.TEXTURE_FORMAT_RGBA32F;throw new Wa(`Unsupported texture format or type: format ${e}, type ${t}.`,Wo.UnsupportedTextureError)}_getNativeAlphaMode(e){switch(e){case 0:return _native.Engine.ALPHA_DISABLE;case 1:return _native.Engine.ALPHA_ADD;case 2:return _native.Engine.ALPHA_COMBINE;case 3:return _native.Engine.ALPHA_SUBTRACT;case 4:return _native.Engine.ALPHA_MULTIPLY;case 5:return _native.Engine.ALPHA_MAXIMIZED;case 6:return _native.Engine.ALPHA_ONEONE;case 7:return _native.Engine.ALPHA_PREMULTIPLIED;case 8:return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return _native.Engine.ALPHA_INTERPOLATE;case 10:return _native.Engine.ALPHA_SCREENMODE;default:throw new Error(`Unsupported alpha mode: ${e}.`)}}_getNativeAttribType(e){switch(e){case O.BYTE:return _native.Engine.ATTRIB_TYPE_INT8;case O.UNSIGNED_BYTE:return _native.Engine.ATTRIB_TYPE_UINT8;case O.SHORT:return _native.Engine.ATTRIB_TYPE_INT16;case O.UNSIGNED_SHORT:return _native.Engine.ATTRIB_TYPE_UINT16;case O.FLOAT:return _native.Engine.ATTRIB_TYPE_FLOAT;default:throw new Error(`Unsupported attribute type: ${e}.`)}}getFontOffset(e){return{ascent:0,height:0,descent:0}}_readTexturePixels(e,t,i,r,s,n,a,l,c,h){var u,d,f,_;if(r!==void 0&&r!==-1)throw new Error(`Reading cubemap faces is not supported, but faceIndex is ${r}.`);return this._engine.readTexture((u=e._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,s??0,c??0,h??0,t,i,(d=n==null?void 0:n.buffer)!==null&&d!==void 0?d:null,(f=n==null?void 0:n.byteOffset)!==null&&f!==void 0?f:0,(_=n==null?void 0:n.byteLength)!==null&&_!==void 0?_:0).then(p=>(n||(n=new Uint8Array(p)),n))}}uh.PROTOCOL_VERSION=8;uh._createNativeDataStream=function(){return _native.NativeDataStream.VALIDATION_ENABLED?new PR:new uc};class PR extends uc{constructor(){super()}writeUint32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32),super.writeUint32(e)}writeInt32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32),super.writeInt32(e)}writeFloat32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32),super.writeFloat32(e)}writeUint32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32_ARRAY),super.writeUint32Array(e)}writeInt32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32_ARRAY),super.writeInt32Array(e)}writeFloat32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32_ARRAY),super.writeFloat32Array(e)}writeNativeData(e){super.writeUint32(_native.NativeDataStream.VALIDATION_NATIVE_DATA),super.writeNativeData(e)}writeBoolean(e){super.writeUint32(_native.NativeDataStream.VALIDATION_BOOLEAN),super.writeBoolean(e)}}var yv;(function(o){o.SRGB="srgb"})(yv||(yv={}));var Cv;(function(o){o.LowPower="low-power",o.HighPerformance="high-performance"})(Cv||(Cv={}));var Jl;(function(o){o.DepthClipControl="depth-clip-control",o.Depth24UnormStencil8="depth24unorm-stencil8",o.Depth32FloatStencil8="depth32float-stencil8",o.TextureCompressionBC="texture-compression-bc",o.TextureCompressionETC2="texture-compression-etc2",o.TextureCompressionASTC="texture-compression-astc",o.TimestampQuery="timestamp-query",o.IndirectFirstInstance="indirect-first-instance",o.ShaderF16="shader-f16",o.BGRA8UnormStorage="bgra8unorm-storage"})(Jl||(Jl={}));var Mi;(function(o){o[o.MapRead=1]="MapRead",o[o.MapWrite=2]="MapWrite",o[o.CopySrc=4]="CopySrc",o[o.CopyDst=8]="CopyDst",o[o.Index=16]="Index",o[o.Vertex=32]="Vertex",o[o.Uniform=64]="Uniform",o[o.Storage=128]="Storage",o[o.Indirect=256]="Indirect",o[o.QueryResolve=512]="QueryResolve"})(Mi||(Mi={}));var oc;(function(o){o[o.Read=1]="Read",o[o.Write=2]="Write"})(oc||(oc={}));var Tl;(function(o){o.E1d="1d",o.E2d="2d",o.E3d="3d"})(Tl||(Tl={}));var Li;(function(o){o[o.CopySrc=1]="CopySrc",o[o.CopyDst=2]="CopyDst",o[o.TextureBinding=4]="TextureBinding",o[o.StorageBinding=8]="StorageBinding",o[o.RenderAttachment=16]="RenderAttachment"})(Li||(Li={}));var Ai;(function(o){o.E1d="1d",o.E2d="2d",o.E2dArray="2d-array",o.Cube="cube",o.CubeArray="cube-array",o.E3d="3d"})(Ai||(Ai={}));var ho;(function(o){o.All="all",o.StencilOnly="stencil-only",o.DepthOnly="depth-only"})(ho||(ho={}));var z;(function(o){o.R8Unorm="r8unorm",o.R8Snorm="r8snorm",o.R8Uint="r8uint",o.R8Sint="r8sint",o.R16Uint="r16uint",o.R16Sint="r16sint",o.R16Float="r16float",o.RG8Unorm="rg8unorm",o.RG8Snorm="rg8snorm",o.RG8Uint="rg8uint",o.RG8Sint="rg8sint",o.R32Uint="r32uint",o.R32Sint="r32sint",o.R32Float="r32float",o.RG16Uint="rg16uint",o.RG16Sint="rg16sint",o.RG16Float="rg16float",o.RGBA8Unorm="rgba8unorm",o.RGBA8UnormSRGB="rgba8unorm-srgb",o.RGBA8Snorm="rgba8snorm",o.RGBA8Uint="rgba8uint",o.RGBA8Sint="rgba8sint",o.BGRA8Unorm="bgra8unorm",o.BGRA8UnormSRGB="bgra8unorm-srgb",o.RGB9E5UFloat="rgb9e5ufloat",o.RGB10A2Unorm="rgb10a2unorm",o.RG11B10UFloat="rg11b10ufloat",o.RG32Uint="rg32uint",o.RG32Sint="rg32sint",o.RG32Float="rg32float",o.RGBA16Uint="rgba16uint",o.RGBA16Sint="rgba16sint",o.RGBA16Float="rgba16float",o.RGBA32Uint="rgba32uint",o.RGBA32Sint="rgba32sint",o.RGBA32Float="rgba32float",o.Stencil8="stencil8",o.Depth16Unorm="depth16unorm",o.Depth24Plus="depth24plus",o.Depth24PlusStencil8="depth24plus-stencil8",o.Depth32Float="depth32float",o.BC1RGBAUnorm="bc1-rgba-unorm",o.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",o.BC2RGBAUnorm="bc2-rgba-unorm",o.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",o.BC3RGBAUnorm="bc3-rgba-unorm",o.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",o.BC4RUnorm="bc4-r-unorm",o.BC4RSnorm="bc4-r-snorm",o.BC5RGUnorm="bc5-rg-unorm",o.BC5RGSnorm="bc5-rg-snorm",o.BC6HRGBUFloat="bc6h-rgb-ufloat",o.BC6HRGBFloat="bc6h-rgb-float",o.BC7RGBAUnorm="bc7-rgba-unorm",o.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",o.ETC2RGB8Unorm="etc2-rgb8unorm",o.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",o.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",o.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",o.ETC2RGBA8Unorm="etc2-rgba8unorm",o.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",o.EACR11Unorm="eac-r11unorm",o.EACR11Snorm="eac-r11snorm",o.EACRG11Unorm="eac-rg11unorm",o.EACRG11Snorm="eac-rg11snorm",o.ASTC4x4Unorm="astc-4x4-unorm",o.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",o.ASTC5x4Unorm="astc-5x4-unorm",o.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",o.ASTC5x5Unorm="astc-5x5-unorm",o.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",o.ASTC6x5Unorm="astc-6x5-unorm",o.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",o.ASTC6x6Unorm="astc-6x6-unorm",o.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",o.ASTC8x5Unorm="astc-8x5-unorm",o.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",o.ASTC8x6Unorm="astc-8x6-unorm",o.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",o.ASTC8x8Unorm="astc-8x8-unorm",o.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",o.ASTC10x5Unorm="astc-10x5-unorm",o.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",o.ASTC10x6Unorm="astc-10x6-unorm",o.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",o.ASTC10x8Unorm="astc-10x8-unorm",o.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",o.ASTC10x10Unorm="astc-10x10-unorm",o.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",o.ASTC12x10Unorm="astc-12x10-unorm",o.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",o.ASTC12x12Unorm="astc-12x12-unorm",o.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",o.Depth24UnormStencil8="depth24unorm-stencil8",o.Depth32FloatStencil8="depth32float-stencil8"})(z||(z={}));var kc;(function(o){o.ClampToEdge="clamp-to-edge",o.Repeat="repeat",o.MirrorRepeat="mirror-repeat"})(kc||(kc={}));var Wt;(function(o){o.Nearest="nearest",o.Linear="linear"})(Wt||(Wt={}));var ps;(function(o){o.Never="never",o.Less="less",o.Equal="equal",o.LessEqual="less-equal",o.Greater="greater",o.NotEqual="not-equal",o.GreaterEqual="greater-equal",o.Always="always"})(ps||(ps={}));var fl;(function(o){o[o.Vertex=1]="Vertex",o[o.Fragment=2]="Fragment",o[o.Compute=4]="Compute"})(fl||(fl={}));var Sl;(function(o){o.Uniform="uniform",o.Storage="storage",o.ReadOnlyStorage="read-only-storage"})(Sl||(Sl={}));var Dl;(function(o){o.Filtering="filtering",o.NonFiltering="non-filtering",o.Comparison="comparison"})(Dl||(Dl={}));var Kn;(function(o){o.Float="float",o.UnfilterableFloat="unfilterable-float",o.Depth="depth",o.Sint="sint",o.Uint="uint"})(Kn||(Kn={}));var q_;(function(o){o.WriteOnly="write-only"})(q_||(q_={}));var Av;(function(o){o.Error="error",o.Warning="warning",o.Info="info"})(Av||(Av={}));var Tu;(function(o){o.Auto="auto"})(Tu||(Tu={}));var $n;(function(o){o.PointList="point-list",o.LineList="line-list",o.LineStrip="line-strip",o.TriangleList="triangle-list",o.TriangleStrip="triangle-strip"})($n||($n={}));var Yd;(function(o){o.CCW="ccw",o.CW="cw"})(Yd||(Yd={}));var $h;(function(o){o.None="none",o.Front="front",o.Back="back"})($h||($h={}));var Rv;(function(o){o[o.Red=1]="Red",o[o.Green=2]="Green",o[o.Blue=4]="Blue",o[o.Alpha=8]="Alpha",o[o.All=15]="All"})(Rv||(Rv={}));var $s;(function(o){o.Zero="zero",o.One="one",o.Src="src",o.OneMinusSrc="one-minus-src",o.SrcAlpha="src-alpha",o.OneMinusSrcAlpha="one-minus-src-alpha",o.Dst="dst",o.OneMinusDst="one-minus-dst",o.DstAlpha="dst-alpha",o.OneMinusDstAlpha="one-minus-dst-alpha",o.SrcAlphaSaturated="src-alpha-saturated",o.Constant="constant",o.OneMinusConstant="one-minus-constant"})($s||($s={}));var _l;(function(o){o.Add="add",o.Subtract="subtract",o.ReverseSubtract="reverse-subtract",o.Min="min",o.Max="max"})(_l||(_l={}));var La;(function(o){o.Keep="keep",o.Zero="zero",o.Replace="replace",o.Invert="invert",o.IncrementClamp="increment-clamp",o.DecrementClamp="decrement-clamp",o.IncrementWrap="increment-wrap",o.DecrementWrap="decrement-wrap"})(La||(La={}));var Nl;(function(o){o.Uint16="uint16",o.Uint32="uint32"})(Nl||(Nl={}));var Wi;(function(o){o.Uint8x2="uint8x2",o.Uint8x4="uint8x4",o.Sint8x2="sint8x2",o.Sint8x4="sint8x4",o.Unorm8x2="unorm8x2",o.Unorm8x4="unorm8x4",o.Snorm8x2="snorm8x2",o.Snorm8x4="snorm8x4",o.Uint16x2="uint16x2",o.Uint16x4="uint16x4",o.Sint16x2="sint16x2",o.Sint16x4="sint16x4",o.Unorm16x2="unorm16x2",o.Unorm16x4="unorm16x4",o.Snorm16x2="snorm16x2",o.Snorm16x4="snorm16x4",o.Float16x2="float16x2",o.Float16x4="float16x4",o.Float32="float32",o.Float32x2="float32x2",o.Float32x3="float32x3",o.Float32x4="float32x4",o.Uint32="uint32",o.Uint32x2="uint32x2",o.Uint32x3="uint32x3",o.Uint32x4="uint32x4",o.Sint32="sint32",o.Sint32x2="sint32x2",o.Sint32x3="sint32x3",o.Sint32x4="sint32x4"})(Wi||(Wi={}));var jd;(function(o){o.Vertex="vertex",o.Instance="instance"})(jd||(jd={}));var Iv;(function(o){o.Beginning="beginning",o.End="end"})(Iv||(Iv={}));var Pv;(function(o){o.Beginning="beginning",o.End="end"})(Pv||(Pv={}));var zr;(function(o){o.Load="load",o.Clear="clear"})(zr||(zr={}));var na;(function(o){o.Store="store",o.Discard="discard"})(na||(na={}));var Kd;(function(o){o.Occlusion="occlusion",o.Timestamp="timestamp"})(Kd||(Kd={}));var qd;(function(o){o.Opaque="opaque",o.Premultiplied="premultiplied"})(qd||(qd={}));var Mv;(function(o){o.Destroyed="destroyed"})(Mv||(Mv={}));var Ov;(function(o){o.OutOfMemory="out-of-memory",o.Validation="validation"})(Ov||(Ov={}));class ki{constructor(){this.shaderLanguage=Gi.GLSL}_addUniformToLeftOverUBO(e,t,i){let r=0;[e,t,r]=this._getArraySize(e,t,i);for(let s=0;s<this._webgpuProcessingContext.leftOverUniforms.length;s++)if(this._webgpuProcessingContext.leftOverUniforms[s].name===e)return;this._webgpuProcessingContext.leftOverUniforms.push({name:e,type:t,length:r})}_buildLeftOverUBO(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return"";const e=ki.LeftOvertUBOName;let t=this._webgpuProcessingContext.availableBuffers[e];return t||(t={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[e]=t,this._addBufferBindingDescription(e,t,Sl.Uniform,!0),this._addBufferBindingDescription(e,t,Sl.Uniform,!1)),this._generateLeftOverUBOCode(e,t)}_collectBindingNames(){for(let e=0;e<this._webgpuProcessingContext.bindGroupLayoutEntries.length;e++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e];if(t===void 0){this._webgpuProcessingContext.bindGroupLayoutEntries[e]=[];continue}for(let i=0;i<t.length;i++){const r=this._webgpuProcessingContext.bindGroupLayoutEntries[e][i],s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][r.binding].name,n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][r.binding].nameInArrayOfTexture;r&&(r.texture||r.externalTexture||r.storageTexture?this._webgpuProcessingContext.textureNames.push(n):r.sampler?this._webgpuProcessingContext.samplerNames.push(s):r.buffer&&this._webgpuProcessingContext.bufferNames.push(s))}}}_preCreateBindGroupEntries(){const e=this._webgpuProcessingContext.bindGroupEntries;for(let t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){const i=this._webgpuProcessingContext.bindGroupLayoutEntries[t],r=[];for(let s=0;s<i.length;s++){const n=this._webgpuProcessingContext.bindGroupLayoutEntries[t][s];n.sampler||n.texture||n.storageTexture||n.externalTexture?r.push({binding:n.binding,resource:void 0}):n.buffer&&r.push({binding:n.binding,resource:{buffer:void 0,offset:0,size:0}})}e[t]=r}}_addTextureBindingDescription(e,t,i,r,s,n){let{groupIndex:a,bindingIndex:l}=t.textures[i];if(this._webgpuProcessingContext.bindGroupLayoutEntries[a]||(this._webgpuProcessingContext.bindGroupLayoutEntries[a]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][l]){let c;r===null?c=this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:l,visibility:0,externalTexture:{}}):s?c=this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:l,visibility:0,storageTexture:{access:q_.WriteOnly,format:s,viewDimension:r}}):c=this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:l,visibility:0,texture:{sampleType:t.sampleType,viewDimension:r,multisampled:!1}});const h=t.isTextureArray?e+i:e;this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][l]={name:e,index:c-1,nameInArrayOfTexture:h}}l=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][l].index,n?this._webgpuProcessingContext.bindGroupLayoutEntries[a][l].visibility|=fl.Vertex:this._webgpuProcessingContext.bindGroupLayoutEntries[a][l].visibility|=fl.Fragment}_addSamplerBindingDescription(e,t,i){let{groupIndex:r,bindingIndex:s}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[r]||(this._webgpuProcessingContext.bindGroupLayoutEntries[r]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][s]){const n=this._webgpuProcessingContext.bindGroupLayoutEntries[r].push({binding:s,visibility:0,sampler:{type:t.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][s]={name:e,index:n-1}}s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][s].index,i?this._webgpuProcessingContext.bindGroupLayoutEntries[r][s].visibility|=fl.Vertex:this._webgpuProcessingContext.bindGroupLayoutEntries[r][s].visibility|=fl.Fragment}_addBufferBindingDescription(e,t,i,r){let{groupIndex:s,bindingIndex:n}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[s]||(this._webgpuProcessingContext.bindGroupLayoutEntries[s]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][n]){const a=this._webgpuProcessingContext.bindGroupLayoutEntries[s].push({binding:n,visibility:0,buffer:{type:i}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][n]={name:e,index:a-1}}n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][n].index,r?this._webgpuProcessingContext.bindGroupLayoutEntries[s][n].visibility|=fl.Vertex:this._webgpuProcessingContext.bindGroupLayoutEntries[s][n].visibility|=fl.Fragment}_injectStartingAndEndingCode(e,t,i,r){let s=e.indexOf(t);if(s<0)return console.error('No "main" function found in shader code! Processing aborted.'),e;if(i){for(;s++<e.length&&e.charAt(s)!="{";);if(s<e.length){const n=e.substring(0,s+1),a=e.substring(s+1);e=n+i+a}}if(r){const n=e.lastIndexOf("}");e=e.substring(0,n),e+=r+`
}`}return e}}ki.AutoSamplerSuffix="Sampler";ki.LeftOvertUBOName="LeftOver";ki.InternalsUBOName="Internals";ki.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,vec3:3,ivec3:3,vec4:4,ivec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16};ki._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"};ki._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"};ki._GpuTextureViewDimensionByWebGPUTextureType={textureCube:Ai.Cube,textureCubeArray:Ai.CubeArray,texture2D:Ai.E2d,texture2DArray:Ai.E2dArray,texture3D:Ai.E3d};ki._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"};ki._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1};class MR{get isAsync(){return!1}get isReady(){return!!this.stages}constructor(e,t){this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t}_handlesSpectorRebuildCallback(){}_fillEffectInformation(e,t,i,r,s,n,a,l){const c=this.engine;e._fragmentSourceCode="",e._vertexSourceCode="";const h=this.shaderProcessingContext.availableTextures;let u;for(u=0;u<s.length;u++){const _=s[u],p=h[s[u]];p==null||p==null?(s.splice(u,1),u--):n[_]=u}for(const _ of c.getAttributes(this,a))l.push(_);this.buildUniformLayout();const d=[],f=[];for(u=0;u<a.length;u++){const _=l[u];_>=0&&(d.push(a[u]),f.push(_))}this.shaderProcessingContext.attributeNamesFromEffect=d,this.shaderProcessingContext.attributeLocationsFromEffect=f}buildUniformLayout(){if(this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer=new $e(this.engine,void 0,void 0,"leftOver-"+this._name);for(const e of this.shaderProcessingContext.leftOverUniforms){const t=e.type.replace(/^(.*?)(<.*>)?$/,"$1"),i=ki.UniformSizes[t];this.uniformBuffer.addUniform(e.name,i,e.length),this._leftOverUniformsByName[e.name]=e.type}this.uniformBuffer.create()}}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose()}setInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt(e,t)}setInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt2(e,t,i)}setInt3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt3(e,t,i,r)}setInt4(e,t,i,r,s){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt4(e,t,i,r,s)}setIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateIntArray(e,t)}setIntArray2(e,t){this.setIntArray(e,t)}setIntArray3(e,t){this.setIntArray(e,t)}setIntArray4(e,t){this.setIntArray(e,t)}setUInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt(e,t)}setUInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt2(e,t,i)}setUInt3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt3(e,t,i,r)}setUInt4(e,t,i,r,s){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt4(e,t,i,r,s)}setUIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUIntArray(e,t)}setUIntArray2(e,t){this.setUIntArray(e,t)}setUIntArray3(e,t){this.setUIntArray(e,t)}setUIntArray4(e,t){this.setUIntArray(e,t)}setArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateArray(e,t)}setArray2(e,t){this.setArray(e,t)}setArray3(e,t){this.setArray(e,t)}setArray4(e,t){this.setArray(e,t)}setMatrices(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrices(e,t)}setMatrix(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix(e,t)}setMatrix3x3(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix3x3(e,t)}setMatrix2x2(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix2x2(e,t)}setFloat(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat(e,t)}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setFloat2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat2(e,t,i)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setFloat3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat3(e,t,i,r)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setFloat4(e,t,i,r,s){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat4(e,t,i,r,s)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){var e;return(e=this.sources)===null||e===void 0?void 0:e.vertex}_getFragmentShaderCode(){var e;return(e=this.sources)===null||e===void 0?void 0:e.fragment}}const OR=4,DR=65536,Dv={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4};class ca{static get KnownUBOs(){return ca._SimplifiedKnownBindings?ca._SimplifiedKnownUBOs:ca._KnownUBOs}constructor(e){this.shaderLanguage=e,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],this._findStartingGroupBinding()}_findStartingGroupBinding(){const e=ca.KnownUBOs,t=[];for(const i in e){const r=e[i].binding;r.groupIndex!==-1&&(t[r.groupIndex]===void 0?t[r.groupIndex]=r.bindingIndex:t[r.groupIndex]=Math.max(t[r.groupIndex],r.bindingIndex))}this.freeGroupIndex=t.length-1,this.freeGroupIndex===0?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=t[t.length-1]+1}getAttributeNextLocation(e,t=0){var i;const r=this._attributeNextLocation;return this._attributeNextLocation+=((i=Dv[e])!==null&&i!==void 0?i:1)*(t||1),r}getVaryingNextLocation(e,t=0){var i;const r=this._varyingNextLocation;return this._varyingNextLocation+=((i=Dv[e])!==null&&i!==void 0?i:1)*(t||1),r}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(e){if(this.freeBindingIndex>DR-e&&(this.freeGroupIndex++,this.freeBindingIndex=0),this.freeGroupIndex===OR)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";const t={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=e,t}}ca._SimplifiedKnownBindings=!0;ca._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}};ca._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}};class NR extends ki{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this._vertexIsGLES3=!1,this._fragmentIsGLES3=!1,this.shaderLanguage=Gi.GLSL,this.parseGLES3=!0}_getArraySize(e,t,i){let r=0;const s=e.indexOf("["),n=e.indexOf("]");if(s>0&&n>0){const a=e.substring(s+1,n);r=+a,isNaN(r)&&(r=+i[a.trim()]),e=e.substr(0,s)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0}preProcessShaderCode(e,t){const i=`// Internals UBO\r
uniform ${ki.InternalsUBOName} {
float yFactor_;
float textureOutputHeight_;
};
`,r=e.indexOf("// Internals UBO")!==-1;return t?(this._fragmentIsGLES3=e.indexOf("#version 3")!==-1,this._fragmentIsGLES3&&(this.varyingFragmentKeywordName="in"),r?e:i+`##INJECTCODE##
`+e):(this._vertexIsGLES3=e.indexOf("#version 3")!==-1,this._vertexIsGLES3&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),r?e:i+e)}varyingProcessor(e,t,i){this._preProcessors=i;const r=/\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,s=/\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,n=/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,l=(t&&this._fragmentIsGLES3?s:!t&&this._vertexIsGLES3?r:n).exec(e);if(l!==null){const c=l[1],h=l[2];let u;t?(u=this._webgpuProcessingContext.availableVaryings[h],this._missingVaryings[u]="",u===void 0&&X.Warn(`Invalid fragment shader: The varying named "${h}" is not declared in the vertex shader! This declaration will be ignored.`)):(u=this._webgpuProcessingContext.getVaryingNextLocation(c,this._getArraySize(h,c,i)[2]),this._webgpuProcessingContext.availableVaryings[h]=u,this._missingVaryings[u]=`layout(location = ${u}) in ${c} ${h};`),e=e.replace(l[0],u===void 0?"":`layout(location = ${u}) ${t?"in":"out"} ${c} ${h};`)}return e}attributeProcessor(e,t){this._preProcessors=t;const i=/\s*in\s+(\S+)\s+(\S+)\s*;/gm,r=/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm,n=(this._vertexIsGLES3?i:r).exec(e);if(n!==null){const a=n[1],l=n[2],c=this._webgpuProcessingContext.getAttributeNextLocation(a,this._getArraySize(l,a,t)[2]);this._webgpuProcessingContext.availableAttributes[l]=c,this._webgpuProcessingContext.orderedAttributes[c]=l,e=e.replace(n[0],`layout(location = ${c}) in ${a} ${l};`)}return e}uniformProcessor(e,t,i){var r;this._preProcessors=i;const n=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(n!==null){let a=n[1],l=n[2];if(a.indexOf("sampler")===0||a.indexOf("sampler")===1){let c=0;[l,a,c]=this._getArraySize(l,a,i);let h=this._webgpuProcessingContext.availableTextures[l];if(!h){h={autoBindSampler:!0,isTextureArray:c>0,isStorageTexture:!1,textures:[],sampleType:Kn.Float};for(let D=0;D<(c||1);++D)h.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}const u=(r=ki._SamplerTypeByWebGLSamplerType[a])!==null&&r!==void 0?r:"sampler",d=!!ki._IsComparisonSamplerByWebGPUSamplerType[u],f=d?Dl.Comparison:Dl.Filtering,_=l+ki.AutoSamplerSuffix;let p=this._webgpuProcessingContext.availableSamplers[_];p||(p={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:f});const m=a.charAt(0)==="u"?"u":a.charAt(0)==="i"?"i":"";m&&(a=a.substr(1));const T=d?Kn.Depth:m==="u"?Kn.Uint:m==="i"?Kn.Sint:Kn.Float;h.sampleType=T;const b=c>0,y=p.binding.groupIndex,S=p.binding.bindingIndex,C=ki._SamplerFunctionByWebGLSamplerType[a],I=ki._TextureTypeByWebGLSamplerType[a],P=ki._GpuTextureViewDimensionByWebGPUTextureType[I];if(!b)c=1,e=`layout(set = ${y}, binding = ${S}) uniform ${m}${u} ${_};
                        layout(set = ${h.textures[0].groupIndex}, binding = ${h.textures[0].bindingIndex}) uniform ${I} ${l}Texture;
                        #define ${l} ${m}${C}(${l}Texture, ${_})`;else{const D=[];D.push(`layout(set = ${y}, binding = ${S}) uniform ${m}${u} ${_};`),e=`\r
`;for(let w=0;w<c;++w){const L=h.textures[w].groupIndex,U=h.textures[w].bindingIndex;D.push(`layout(set = ${L}, binding = ${U}) uniform ${I} ${l}Texture${w};`),e+=`${w>0?`\r
`:""}#define ${l}${w} ${m}${C}(${l}Texture${w}, ${_})`}e=D.join(`\r
`)+e,this._textureArrayProcessing.push(l)}this._webgpuProcessingContext.availableTextures[l]=h,this._webgpuProcessingContext.availableSamplers[_]=p,this._addSamplerBindingDescription(_,p,!t);for(let D=0;D<c;++D)this._addTextureBindingDescription(l,h,D,P,null,!t)}else this._addUniformToLeftOverUBO(l,a,i),e=""}return e}uniformBufferProcessor(e,t){const r=/uniform\s+(\w+)/gm.exec(e);if(r!==null){const s=r[1];let n=this._webgpuProcessingContext.availableBuffers[s];if(!n){const a=ca.KnownUBOs[s];let l;a&&a.binding.groupIndex!==-1?l=a.binding:l=this._webgpuProcessingContext.getNextFreeUBOBinding(),n={binding:l},this._webgpuProcessingContext.availableBuffers[s]=n}this._addBufferBindingDescription(s,n,Sl.Uniform,!t),e=e.replace("uniform",`layout(set = ${n.binding.groupIndex}, binding = ${n.binding.bindingIndex}) uniform`)}return e}postProcessor(e,t,i,r,s){const n=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,a=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(a,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){const l=e.indexOf("gl_FragCoord")>=0,c=`
                glFragCoord_ = gl_FragCoord;
                if (yFactor_ == 1.) {
                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;
                }
            `,h=l?`vec4 glFragCoord_;
`:"";if(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/gl_FragCoord/g,"glFragCoord_"),!this._fragmentIsGLES3)e=e.replace(/void\s+?main\s*\(/g,(n?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(");else{const u=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(e);u!==null&&(e=e.substring(0,u.index)+"layout(location = 0) "+e.substring(u.index))}e=e.replace(/dFdy/g,"(-yFactor_)*dFdy"),e=e.replace("##INJECTCODE##",h),l&&(e=this._injectStartingAndEndingCode(e,"void main",c))}else if(e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex"),e=e.replace(/gl_VertexID/g,"gl_VertexIndex"),t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;if(!i){const l=e.lastIndexOf("}");e=e.substring(0,l),e+=`gl_Position.y *= yFactor_;
`,s.isNDCHalfZRange||(e+=`gl_Position.z = (gl_Position.z + gl_Position.w) / 2.0;
`),e+="}"}return e}_applyTextureArrayProcessing(e,t){const i=new RegExp(t+"\\s*\\[(.+)?\\]","gm");let r=i.exec(e);for(;r!==null;){const s=r[1];let n=+s;this._preProcessors&&isNaN(n)&&(n=+this._preProcessors[s.trim()]),e=e.replace(r[0],t+n),r=i.exec(e)}return e}_generateLeftOverUBOCode(e,t){let i=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {
    `;for(const r of this._webgpuProcessingContext.leftOverUniforms)r.length>0?i+=`    ${r.type} ${r.name}[${r.length}];
`:i+=`    ${r.type} ${r.name};
`;return i+=`};

`,i}finalizeShaders(e,t){for(let r=0;r<this._textureArrayProcessing.length;++r){const s=this._textureArrayProcessing[r];e=this._applyTextureArrayProcessing(e,s),t=this._applyTextureArrayProcessing(t,s)}for(let r=0;r<this._missingVaryings.length;++r){const s=this._missingVaryings[r];s&&s.length>0&&(t=s+`
`+t)}const i=this._buildLeftOverUBO();return e=i+e,t=i+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,{vertexCode:e,fragmentCode:t}}}const wR="bonesDeclaration",FR=`#if NUM_BONE_INFLUENCERS>0
attribute matricesIndices : vec4<f32>;
attribute matricesWeights : vec4<f32>;
#if NUM_BONE_INFLUENCERS>4
attribute matricesIndicesExtra : vec4<f32>;
attribute matricesWeightsExtra : vec4<f32>;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
var boneSampler : texture_2d<f32>;
uniform boneTextureWidth : f32;
#else
uniform mBones : array<mat4x4,BonesPerMesh>;
#ifdef BONES_VELOCITY_ENABLED
uniform mPreviousBones : array<mat4x4,BonesPerMesh>;
#endif
#endif
#ifdef BONETEXTURE
fn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>
{
let offset=i32(index) *4; 
let m0=textureLoad(smp,vec2<i32>(offset+0,0),0);
let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);
let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);
let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);
return mat4x4<f32>(m0,m1,m2,m3);
}
#endif
#endif
#endif
`;te.IncludesShadersStoreWGSL[wR]=FR;const LR="bonesVertex",BR=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
var influence : mat4x4<f32>;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];
#endif 
#else 
influence=uniforms.mBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+uniforms.mBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+uniforms.mBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+uniforms.mBones[int(matricesIndices[3])]*matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
influence=influence+uniforms.mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
influence=influence+uniforms.mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+uniforms.mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+uniforms.mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif 
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;te.IncludesShadersStoreWGSL[LR]=BR;const UR="bakedVertexAnimationDeclaration",VR=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform bakedVertexAnimationTime: f32;
uniform bakedVertexAnimationTextureSizeInverted: vec2<f32>;
uniform bakedVertexAnimationSettings: vec4<f32>;
var bakedVertexAnimationTexture : texture_2d<f32>;
#ifdef INSTANCES
attribute bakedVertexAnimationSettingsInstanced : vec4<f32>;
#endif
fn readMatrixFromRawSamplerVAT(smp : texture_2d<f32>,index : f32,frame : f32)->mat4x4<f32>
{
let offset=i32(index)*4;
let frameUV=i32(frame);
let m0=textureLoad(smp,vec2<i32>(offset+0,frameUV),0);
let m1=textureLoad(smp,vec2<i32>(offset+1,frameUV),0);
let m2=textureLoad(smp,vec2<i32>(offset+2,frameUV),0);
let m3=textureLoad(smp,vec2<i32>(offset+3,frameUV),0);
return mat4x4<f32>(m0,m1,m2,m3);
}
#endif
`;te.IncludesShadersStoreWGSL[UR]=VR;const kR="bakedVertexAnimation",GR=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
let VATStartFrame: f32=bakedVertexAnimationSettingsInstanced.x;
let VATEndFrame: f32=bakedVertexAnimationSettingsInstanced.y;
let VATOffsetFrame: f32=bakedVertexAnimationSettingsInstanced.z;
let VATSpeed: f32=bakedVertexAnimationSettingsInstanced.w;
#else
let VATStartFrame: f32=uniforms.bakedVertexAnimationSettings.x;
let VATEndFrame: f32=uniforms.bakedVertexAnimationSettings.y;
let VATOffsetFrame: f32=uniforms.bakedVertexAnimationSettings.z;
let VATSpeed: f32=uniforms.bakedVertexAnimationSettings.w;
#endif
let totalFrames: f32=VATEndFrame-VATStartFrame+1.0;
let time: f32=uniforms.bakedVertexAnimationTime*VATSpeed/totalFrames;
let frameCorrection: f32=select(1.0,0.0,time<1.0);
let numOfFrames: f32=totalFrames-frameCorrection;
var VATFrameNum: f32=fract(time)*numOfFrames;
VATFrameNum=(VATFrameNum+VATOffsetFrame) % numOfFrames;
VATFrameNum=floor(VATFrameNum);
VATFrameNum=VATFrameNum+VATStartFrame+frameCorrection;
var VATInfluence : mat4x4<f32>;
VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;
}
#endif
`;te.IncludesShadersStoreWGSL[kR]=GR;const zR="clipPlaneFragment",HR=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fClipDistance>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE2
else if (fClipDistance2>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE3
else if (fClipDistance3>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE4
else if (fClipDistance4>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE5
else if (fClipDistance5>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE6
else if (fClipDistance6>0.0)
{
discard;
}
#endif
`;te.IncludesShadersStoreWGSL[zR]=HR;const WR="clipPlaneFragmentDeclaration",XR=`#ifdef CLIPPLANE
varying fClipDistance: f32;
#endif
#ifdef CLIPPLANE2
varying fClipDistance2: f32;
#endif
#ifdef CLIPPLANE3
varying fClipDistance3: f32;
#endif
#ifdef CLIPPLANE4
varying fClipDistance4: f32;
#endif
#ifdef CLIPPLANE5
varying fClipDistance5: f32;
#endif
#ifdef CLIPPLANE6
varying fClipDistance6: f32;
#endif
`;te.IncludesShadersStoreWGSL[WR]=XR;const $R="clipPlaneVertex",YR=`#ifdef CLIPPLANE
fClipDistance=dot(worldPos,uniforms.vClipPlane);
#endif
#ifdef CLIPPLANE2
fClipDistance2=dot(worldPos,uniforms.vClipPlane2);
#endif
#ifdef CLIPPLANE3
fClipDistance3=dot(worldPos,uniforms.vClipPlane3);
#endif
#ifdef CLIPPLANE4
fClipDistance4=dot(worldPos,uniforms.vClipPlane4);
#endif
#ifdef CLIPPLANE5
fClipDistance5=dot(worldPos,uniforms.vClipPlane5);
#endif
#ifdef CLIPPLANE6
fClipDistance6=dot(worldPos,uniforms.vClipPlane6);
#endif
`;te.IncludesShadersStoreWGSL[$R]=YR;const jR="clipPlaneVertexDeclaration",KR=`#ifdef CLIPPLANE
uniform vClipPlane: vec4<f32>;
varying fClipDistance: f32;
#endif
#ifdef CLIPPLANE2
uniform vClipPlane2: vec4<f32>;
varying fClipDistance2: f32;
#endif
#ifdef CLIPPLANE3
uniform vClipPlane3: vec4<f32>;
varying fClipDistance3: f32;
#endif
#ifdef CLIPPLANE4
uniform vClipPlane4: vec4<f32>;
varying fClipDistance4: f32;
#endif
#ifdef CLIPPLANE5
uniform vClipPlane5: vec4<f32>;
varying fClipDistance5: f32;
#endif
#ifdef CLIPPLANE6
uniform vClipPlane6: vec4<f32>;
varying fClipDistance6: f32;
#endif
`;te.IncludesShadersStoreWGSL[jR]=KR;const qR="instancesDeclaration",QR=`#ifdef INSTANCES
attribute world0 : vec4<f32>;
attribute world1 : vec4<f32>;
attribute world2 : vec4<f32>;
attribute world3 : vec4<f32>;
#ifdef INSTANCESCOLOR
attribute instanceColor : vec4<f32>;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform world : mat4x4<f32>;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
attribute previousWorld0 : vec4<f32>;
attribute previousWorld1 : vec4<f32>;
attribute previousWorld2 : vec4<f32>;
attribute previousWorld3 : vec4<f32>;
#ifdef THIN_INSTANCES
uniform previousWorld : mat4x4<f32>;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform world : mat4x4<f32>;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
uniform previousWorld : mat4x4<f32>;
#endif
#endif
`;te.IncludesShadersStoreWGSL[qR]=QR;const ZR="instancesVertex",JR=`#ifdef INSTANCES
var finalWorld=mat4x4<f32>(world0,world1,world2,world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
var finalPreviousWorld=mat4x4<f32>(previousWorld0,previousWorld1,previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
#if !defined(WORLD_UBO)
finalWorld=uniforms.world*finalWorld;
#else
finalWorld=mesh.world*finalWorld;
#endif
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
var finalWorld=uniforms.world;
#else
var finalWorld=mesh.world;
#endif
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
var finalPreviousWorld=previousWorld;
#endif
#endif
`;te.IncludesShadersStoreWGSL[ZR]=JR;const eI="meshUboDeclaration",tI=`struct Mesh {
world : mat4x4<f32>,
visibility : f32,
};
var<uniform> mesh : Mesh;
#define WORLD_UBO
`;te.IncludesShadersStoreWGSL[eI]=tI;const iI="morphTargetsVertex",rI=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE 
vertexID=f32(gl_VertexID)*uniforms.morphTargetTextureInfo.x;
positionUpdated=positionUpdated+(readVector3FromRawSampler({X},vertexID)-position)*uniforms.morphTargetInfluences[{X}];
vertexID=vertexID+1.0;
#ifdef MORPHTARGETS_NORMAL
normalUpdated=normalUpdated+(readVector3FromRawSampler({X},vertexID) -normal)*uniforms.morphTargetInfluences[{X}];
vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated=uvUpdated+(readVector3FromRawSampler({X},vertexID).xy-uv)*uniforms.morphTargetInfluences[{X}];
vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz=tangentUpdated.xyz+(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*uniforms.morphTargetInfluences[{X}];
#endif
#else
positionUpdated=positionUpdated+(position{X}-position)*uniforms.morphTargetInfluences[{X}];
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(normal{X}-normal)*uniforms.morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz=tangentUpdated.xyz+(tangent{X}-tangent.xyz)*uniforms.morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV
uvUpdated=uvUpdated+(uv_{X}-uv)*uniforms.morphTargetInfluences[{X}];
#endif
#endif
#endif
`;te.IncludesShadersStoreWGSL[iI]=rI;const sI="morphTargetsVertexDeclaration",nI=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
attribute position{X} : vec3<f32>;
#ifdef MORPHTARGETS_NORMAL
attribute normal{X} : vec3<f32>;
#endif
#ifdef MORPHTARGETS_TANGENT
attribute tangent{X} : vec3<f32>;
#endif
#ifdef MORPHTARGETS_UV
attribute uv_{X} : vec2<f32>;
#endif
#endif
#endif
`;te.IncludesShadersStoreWGSL[sI]=nI;const aI="morphTargetsVertexGlobal",oI=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
var vertexID : f32;
#endif
#endif
`;te.IncludesShadersStoreWGSL[aI]=oI;const lI="morphTargetsVertexGlobalDeclaration",cI=`#ifdef MORPHTARGETS
uniform morphTargetInfluences : array<f32,NUM_MORPH_INFLUENCERS>;
#ifdef MORPHTARGETS_TEXTURE 
uniform morphTargetTextureIndices : array<f32,NUM_MORPH_INFLUENCERS>;
uniform morphTargetTextureInfo : vec3<f32>;
var morphTargets : texture_2d_array<f32>;
var morphTargetsSampler : sampler;
fn readVector3FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec3<f32>
{ 
let y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);
let x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;
let textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);
return textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0).xyz;
}
#endif
#endif
`;te.IncludesShadersStoreWGSL[lI]=cI;const hI="sceneUboDeclaration",uI=`struct Scene {
viewProjection : mat4x4<f32>,
#ifdef MULTIVIEW
viewProjectionR : mat4x4<f32>,
#endif 
view : mat4x4<f32>,
projection : mat4x4<f32>,
vEyePosition : vec4<f32>,
};
var<uniform> scene : Scene;
`;te.IncludesShadersStoreWGSL[hI]=uI;const Nv="gl_VertexID",wv="gl_InstanceID",Fv="gl_Position",Lv="gl_FragCoord",Bv="gl_FrontFacing",Ad="gl_FragDepth",Uv="gl_FragColor",dI="uniforms",fI="internals",_I={texture_1d:Ai.E1d,texture_2d:Ai.E2d,texture_2d_array:Ai.E2dArray,texture_3d:Ai.E3d,texture_cube:Ai.Cube,texture_cube_array:Ai.CubeArray,texture_multisampled_2d:Ai.E2d,texture_depth_2d:Ai.E2d,texture_depth_2d_array:Ai.E2dArray,texture_depth_cube:Ai.Cube,texture_depth_cube_array:Ai.CubeArray,texture_depth_multisampled_2d:Ai.E2d,texture_storage_1d:Ai.E1d,texture_storage_2d:Ai.E2d,texture_storage_2d_array:Ai.E2dArray,texture_storage_3d:Ai.E3d,texture_external:null};class pI extends ki{constructor(){super(...arguments),this.shaderLanguage=Gi.WGSL,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0}_getArraySize(e,t,i){let r=0;const s=t.lastIndexOf(">");if(t.indexOf("array")>=0&&s>0){let n=s;for(;n>0&&t.charAt(n)!==" "&&t.charAt(n)!==",";)n--;const a=t.substring(n+1,s);for(r=+a,isNaN(r)&&(r=+i[a.trim()]);n>0&&(t.charAt(n)===" "||t.charAt(n)===",");)n--;t=t.substring(t.indexOf("<")+1,n+1)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesWGSL=[],this._attributesDeclWGSL=[],this._attributeNamesWGSL=[],this._varyingsWGSL=[],this._varyingsDeclWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]}preProcessShaderCode(e){return`struct ${ki.InternalsUBOName} {
yFactor_: f32,
textureOutputHeight_: f32,
};
var<uniform> ${fI} : ${ki.InternalsUBOName};
`+K_(e)}varyingProcessor(e,t,i){const s=/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(s!==null){const n=s[2],a=s[1];let l;t?(l=this._webgpuProcessingContext.availableVaryings[a],l===void 0&&X.Warn(`Invalid fragment shader: The varying named "${a}" is not declared in the vertex shader! This declaration will be ignored.`)):(l=this._webgpuProcessingContext.getVaryingNextLocation(n,this._getArraySize(a,n,i)[2]),this._webgpuProcessingContext.availableVaryings[a]=l,this._varyingsWGSL.push(`@location(${l}) ${a} : ${n},`),this._varyingsDeclWGSL.push(`var<private> ${a} : ${n};`),this._varyingNamesWGSL.push(a)),e=""}return e}attributeProcessor(e,t){const r=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(r!==null){const s=r[2],n=r[1],a=this._webgpuProcessingContext.getAttributeNextLocation(s,this._getArraySize(n,s,t)[2]);this._webgpuProcessingContext.availableAttributes[n]=a,this._webgpuProcessingContext.orderedAttributes[a]=n,this._attributesWGSL.push(`@location(${a}) ${n} : ${s},`),this._attributesDeclWGSL.push(`var<private> ${n} : ${s};`),this._attributeNamesWGSL.push(n),e=""}return e}uniformProcessor(e,t,i){const r=this.uniformRegexp.exec(e);if(r!==null){const s=r[2],n=r[1];this._addUniformToLeftOverUBO(n,s,i),e=""}return e}textureProcessor(e,t,i){const r=this.textureRegexp.exec(e);if(r!==null){const s=r[1],n=r[2],a=!!r[3],l=r[4],c=l.indexOf("storage")>0,h=r[6],u=c?h.substring(0,h.indexOf(",")).trim():null;let d=a?this._getArraySize(s,n,i)[2]:0,f=this._webgpuProcessingContext.availableTextures[s];if(f)d=f.textures.length;else{f={isTextureArray:d>0,isStorageTexture:c,textures:[],sampleType:Kn.Float},d=d||1;for(let T=0;T<d;++T)f.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[s]=f;const _=l.indexOf("depth")>0,p=_I[l],m=_?Kn.Depth:h==="u32"?Kn.Uint:h==="i32"?Kn.Sint:Kn.Float;if(f.sampleType=m,p===void 0)throw`Can't get the texture dimension corresponding to the texture function "${l}"!`;for(let T=0;T<d;++T){const{groupIndex:b,bindingIndex:y}=f.textures[T];T===0&&(e=`@group(${b}) @binding(${y}) ${e}`),this._addTextureBindingDescription(s,f,T,p,u,!t)}}return e}postProcessor(e){return e}finalizeShaders(e,t){const i=t.indexOf("gl_FragCoord")>=0?`
            if (internals.yFactor_ == 1.) {
                gl_FragCoord.y = internals.textureOutputHeight_ - gl_FragCoord.y;
            }
        `:"";e=this._processSamplers(e,!0),t=this._processSamplers(t,!1),e=this._processCustomBuffers(e,!0),t=this._processCustomBuffers(t,!1);const r=this._buildLeftOverUBO();e=r+e,t=r+t,e=e.replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);const s=this._varyingsDeclWGSL.join(`
`)+`
`,n=`var<private> ${Nv} : u32;
var<private> ${wv} : u32;
var<private> ${Fv} : vec4<f32>;
`,a=this._attributesDeclWGSL.join(`
`)+`
`;let l=`struct VertexInputs {
  @builtin(vertex_index) vertexIndex : u32,
  @builtin(instance_index) instanceIndex : u32,
`;this._attributesWGSL.length>0&&(l+=this._attributesWGSL.join(`
`)),l+=`
};
`;let c=`struct FragmentInputs {
  @builtin(position) position : vec4<f32>,
`;this._varyingsWGSL.length>0&&(c+=this._varyingsWGSL.join(`
`)),c+=`
};
`,e=n+l+a+c+s+e;let h=`  var output : FragmentInputs;
  ${Nv} = input.vertexIndex;
  ${wv} = input.instanceIndex;
`;for(let y=0;y<this._attributeNamesWGSL.length;++y){const S=this._attributeNamesWGSL[y];h+=`  ${S} = input.${S};
`}let u=`  output.position = ${Fv};
  output.position.y = output.position.y * internals.yFactor_;
`;for(let y=0;y<this._varyingNamesWGSL.length;++y){const S=this._varyingNamesWGSL[y];u+=`  output.${S} = ${S};
`}u+="  return output;",e=this._injectStartingAndEndingCode(e,"fn main",h,u),t=t.replace(/#define /g,"//#define "),t=this._processStridedUniformArrays(t),t=t.replace(/dpdy/g,"(-internals.yFactor_)*dpdy");const d=`var<private> ${Lv} : vec4<f32>;
var<private> ${Bv} : bool;
var<private> ${Uv} : vec4<f32>;
var<private> ${Ad} : f32;
`;let f=`struct FragmentInputs {
  @builtin(position) position : vec4<f32>,
  @builtin(front_facing) frontFacing : bool,
`;this._varyingsWGSL.length>0&&(f+=this._varyingsWGSL.join(`
`)),f+=`
};
`;let _=`struct FragmentOutputs {
  @location(0) color : vec4<f32>,
`,p=!1,m=0;for(;!p&&(m=t.indexOf(Ad,m),!(m<0));){const y=m;for(p=!0;m>1&&t.charAt(m)!==`
`;){if(t.charAt(m)==="/"&&t.charAt(m-1)==="/"){p=!1;break}m--}m=y+Ad.length}p&&(_+=`  @builtin(frag_depth) fragDepth: f32,
`),_+=`};
`,t=d+f+s+_+t;let T=`  var output : FragmentOutputs;
  ${Lv} = input.position;
  ${Bv} = input.frontFacing;
`+i;for(let y=0;y<this._varyingNamesWGSL.length;++y){const S=this._varyingNamesWGSL[y];T+=`  ${S} = input.${S};
`}let b=`  output.color = ${Uv};
`;return p&&(b+=`  output.fragDepth = ${Ad};
`),b+="  return output;",t=this._injectStartingAndEndingCode(t,"fn main",T,b),this._collectBindingNames(),this._preCreateBindGroupEntries(),{vertexCode:e,fragmentCode:t}}_generateLeftOverUBOCode(e,t){let i="",r=`struct ${e} {
`;for(const s of this._webgpuProcessingContext.leftOverUniforms){const n=s.type.replace(/^(.*?)(<.*>)?$/,"$1"),a=ki.UniformSizes[n];if(s.length>0)if(a<=2){const l=`${e}_${this._stridedUniformArrays.length}_strided_arr`;i+=`struct ${l} {
                        @size(16)
                        el: ${n},
                    }`,this._stridedUniformArrays.push(s.name),r+=` @align(16) ${s.name} : array<${l}, ${s.length}>,
`}else r+=` ${s.name} : array<${s.type}, ${s.length}>,
`;else r+=`  ${s.name} : ${s.type},
`}return r+=`};
`,r=`${i}
${r}`,r+=`@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> ${dI} : ${e};
`,r}_processSamplers(e,t){const i=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){const r=i.exec(e);if(r===null)break;const s=r[1],n=r[2],a=s.indexOf(ki.AutoSamplerSuffix)===s.length-ki.AutoSamplerSuffix.length?s.substring(0,s.indexOf(ki.AutoSamplerSuffix)):null,l=n==="sampler_comparison"?Dl.Comparison:Dl.Filtering;if(a){const f=this._webgpuProcessingContext.availableTextures[a];f&&(f.autoBindSampler=!0)}let c=this._webgpuProcessingContext.availableSamplers[s];c||(c={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:l},this._webgpuProcessingContext.availableSamplers[s]=c),this._addSamplerBindingDescription(s,c,t);const h=e.substring(0,r.index),u=`@group(${c.binding.groupIndex}) @binding(${c.binding.bindingIndex}) `,d=e.substring(r.index);e=h+u+d,i.lastIndex+=u.length}return e}_processCustomBuffers(e,t){const i=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){const r=i.exec(e);if(r===null)break;const s=r[1],n=r[3];let a=r[4];const l=r[5];let c=this._webgpuProcessingContext.availableBuffers[a];if(!c){const p=s==="uniform"?ca.KnownUBOs[l]:null;let m;p?(a=l,m=p.binding,m.groupIndex===-1&&(m=this._webgpuProcessingContext.getNextFreeUBOBinding())):m=this._webgpuProcessingContext.getNextFreeUBOBinding(),c={binding:m},this._webgpuProcessingContext.availableBuffers[a]=c}this._addBufferBindingDescription(a,this._webgpuProcessingContext.availableBuffers[a],n==="read_write"?Sl.Storage:s==="storage"?Sl.ReadOnlyStorage:Sl.Uniform,t);const h=c.binding.groupIndex,u=c.binding.bindingIndex,d=e.substring(0,r.index),f=`@group(${h}) @binding(${u}) `,_=e.substring(r.index);e=d+f+_,i.lastIndex+=f.length}return e}_processStridedUniformArrays(e){for(const t of this._stridedUniformArrays)e=e.replace(new RegExp(`${t}\\s*\\[(.*)\\]`,"g"),`${t}[$1].el`);return e}}class Ld{get underlyingResource(){return this._webgpuTexture}get msaaTexture(){return this._webgpuMSAATexture}set msaaTexture(e){this._webgpuMSAATexture=e}constructor(e=null){this.format=z.RGBA8Unorm,this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=e,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}set(e){this._webgpuTexture=e}setUsage(e,t,i,r,s){t=e===bt.RenderTarget?!1:t,this.createView({format:this.format,dimension:i?Ai.Cube:Ai.E2d,mipLevelCount:t?Ee.ILog2(Math.max(r,s))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:i?6:1,aspect:ho.All})}createView(e,t=!1){if(this.view=this._webgpuTexture.createView(e),t&&e){const i=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=i}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}release(){var e,t,i;(e=this._webgpuTexture)===null||e===void 0||e.destroy(),(t=this._webgpuMSAATexture)===null||t===void 0||t.destroy(),(i=this._copyInvertYTempTexture)===null||i===void 0||i.destroy(),this.reset()}}const mI=`
    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));
    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));

    layout(location = 0) out vec2 vTex;

    void main() {
        vTex = tex[gl_VertexIndex];
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,gI=`
    layout(set = 0, binding = 0) uniform sampler imgSampler;
    layout(set = 0, binding = 1) uniform texture2D img;

    layout(location = 0) in vec2 vTex;
    layout(location = 0) out vec4 outColor;

    void main() {
        outColor = texture(sampler2D(img, imgSampler), vTex);
    }
    `,cE=`
    #extension GL_EXT_samplerless_texture_functions : enable

    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));
    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));

    layout(set = 0, binding = 0) uniform texture2D img;

    #ifdef INVERTY
        layout(location = 0) out flat ivec2 vTextureSize;
    #endif

    void main() {
        #ifdef INVERTY
            vTextureSize = textureSize(img, 0);
        #endif
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,vI=`
    #extension GL_EXT_samplerless_texture_functions : enable

    layout(set = 0, binding = 0) uniform texture2D img;

    #ifdef INVERTY
        layout(location = 0) in flat ivec2 vTextureSize;
    #endif
    layout(location = 0) out vec4 outColor;

    void main() {
    #ifdef INVERTY
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, vTextureSize.y - gl_FragCoord.y), 0);
    #else
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color.rgb *= color.a;
    #endif
        outColor = color;
    }
    `,xI=cE,TI=`
    #extension GL_EXT_samplerless_texture_functions : enable

    layout(set = 0, binding = 0) uniform texture2D img;
    layout(set = 0, binding = 1) uniform Params {
        float ofstX;
        float ofstY;
        float width;
        float height;
    };

    #ifdef INVERTY
        layout(location = 0) in flat ivec2 vTextureSize;
    #endif
    layout(location = 0) out vec4 outColor;

    void main() {
        if (gl_FragCoord.x < ofstX || gl_FragCoord.x >= ofstX + width) {
            discard;
        }
        if (gl_FragCoord.y < ofstY || gl_FragCoord.y >= ofstY + height) {
            discard;
        }
    #ifdef INVERTY
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, ofstY + height - (gl_FragCoord.y - ofstY)), 0);
    #else
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color.rgb *= color.a;
    #endif
        outColor = color;
    }
    `,EI=`
    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));

    void main() {
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,bI=`
    layout(set = 0, binding = 0) uniform Uniforms {
        uniform vec4 color;
    };

    layout(location = 0) out vec4 outColor;

    void main() {
        outColor = color;
    }
    `,SI=`
    struct VertexOutput {
        @builtin(position) Position : vec4<f32>,
        @location(0) fragUV : vec2<f32>
    }
  
    @vertex
    fn main(
        @builtin(vertex_index) VertexIndex : u32
    ) -> VertexOutput {
        var pos = array<vec2<f32>, 4>(
            vec2(-1.0,  1.0),
            vec2( 1.0,  1.0),
            vec2(-1.0, -1.0),
            vec2( 1.0, -1.0)
        );
        var tex = array<vec2<f32>, 4>(
            vec2(0.0, 0.0),
            vec2(1.0, 0.0),
            vec2(0.0, 1.0),
            vec2(1.0, 1.0)
        );

        var output: VertexOutput;

        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);
        output.fragUV = tex[VertexIndex];

        return output;
    }
    `,yI=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);
    }
    `,CI=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));
    }
    `;var Ea;(function(o){o[o.MipMap=0]="MipMap",o[o.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",o[o.Clear=2]="Clear",o[o.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst"})(Ea||(Ea={}));var Gc;(function(o){o[o.DontInvertY=0]="DontInvertY",o[o.InvertY=1]="InvertY"})(Gc||(Gc={}));const Vv=[{vertex:mI,fragment:gI},{vertex:cE,fragment:vI},{vertex:EI,fragment:bI},{vertex:xI,fragment:TI}],Yh={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2unorm:22,rg32uint:23,rg32sint:24,rg32float:25,rgba16uint:26,rgba16sint:27,rgba16float:28,rgba32uint:29,rgba32sint:30,rgba32float:31,stencil8:32,depth16unorm:33,depth24plus:34,"depth24plus-stencil8":35,depth32float:36,"depth24unorm-stencil8":37,"depth32float-stencil8":38};class Bi{static ComputeNumMipmapLevels(e,t){return Ee.ILog2(Math.max(e,t))+1}constructor(e,t,i,r){this._pipelines={},this._compiledShaders=[],this._videoPipelines={},this._videoCompiledShaders=[],this._deferredReleaseTextures=[],this._device=e,this._glslang=t,this._tintWASM=i,this._bufferManager=r,this._mipmapSampler=e.createSampler({minFilter:Wt.Linear}),this._videoSampler=e.createSampler({minFilter:Wt.Linear}),this._ubCopyWithOfst=this._bufferManager.createBuffer(4*4,Mi.Uniform|Mi.CopyDst).underlyingResource,this._getPipeline(z.RGBA8Unorm),this._getVideoPipeline(z.RGBA8Unorm)}_getPipeline(e,t=Ea.MipMap,i){const r=t===Ea.MipMap?1:t===Ea.InvertYPremultiplyAlpha?((i.invertY?1:0)<<1)+((i.premultiplyAlpha?1:0)<<2):t===Ea.Clear?8:t===Ea.InvertYPremultiplyAlphaWithOfst?((i.invertY?1:0)<<4)+((i.premultiplyAlpha?1:0)<<5):0;this._pipelines[e]||(this._pipelines[e]=[]);let s=this._pipelines[e][r];if(!s){let n=`#version 450\r
`;(t===Ea.InvertYPremultiplyAlpha||t===Ea.InvertYPremultiplyAlphaWithOfst)&&(i.invertY&&(n+=`#define INVERTY\r
`),i.premultiplyAlpha&&(n+=`#define PREMULTIPLYALPHA\r
`));let a=this._compiledShaders[r];if(!a){let c=this._glslang.compileGLSL(n+Vv[t].vertex,"vertex"),h=this._glslang.compileGLSL(n+Vv[t].fragment,"fragment");this._tintWASM&&(c=this._tintWASM.convertSpirV2WGSL(c),h=this._tintWASM.convertSpirV2WGSL(h));const u=this._device.createShaderModule({code:c}),d=this._device.createShaderModule({code:h});a=this._compiledShaders[r]=[u,d]}const l=this._device.createRenderPipeline({layout:Tu.Auto,vertex:{module:a[0],entryPoint:"main"},fragment:{module:a[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:$n.TriangleStrip,stripIndexFormat:Nl.Uint16}});s=this._pipelines[e][r]=[l,l.getBindGroupLayout(0)]}return s}_getVideoPipeline(e,t=Gc.DontInvertY){const i=t===Gc.InvertY?1:0;this._videoPipelines[e]||(this._videoPipelines[e]=[]);let r=this._videoPipelines[e][i];if(!r){let s=this._videoCompiledShaders[i];if(!s){const a=this._device.createShaderModule({code:SI}),l=this._device.createShaderModule({code:i===0?yI:CI});s=this._videoCompiledShaders[i]=[a,l]}const n=this._device.createRenderPipeline({label:`CopyVideoToTexture_${e}_${i===0?"DontInvertY":"InvertY"}`,layout:Tu.Auto,vertex:{module:s[0],entryPoint:"main"},fragment:{module:s[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:$n.TriangleStrip,stripIndexFormat:Nl.Uint16}});r=this._videoPipelines[e][i]=[n,n.getBindGroupLayout(0)]}return r}static _GetTextureTypeFromFormat(e){switch(e){case z.R8Unorm:case z.R8Snorm:case z.R8Uint:case z.R8Sint:case z.RG8Unorm:case z.RG8Snorm:case z.RG8Uint:case z.RG8Sint:case z.RGBA8Unorm:case z.RGBA8UnormSRGB:case z.RGBA8Snorm:case z.RGBA8Uint:case z.RGBA8Sint:case z.BGRA8Unorm:case z.BGRA8UnormSRGB:case z.RGB10A2Unorm:case z.RGB9E5UFloat:case z.RG11B10UFloat:case z.Depth24UnormStencil8:case z.Depth32FloatStencil8:case z.BC7RGBAUnorm:case z.BC7RGBAUnormSRGB:case z.BC6HRGBUFloat:case z.BC6HRGBFloat:case z.BC5RGUnorm:case z.BC5RGSnorm:case z.BC3RGBAUnorm:case z.BC3RGBAUnormSRGB:case z.BC2RGBAUnorm:case z.BC2RGBAUnormSRGB:case z.BC4RUnorm:case z.BC4RSnorm:case z.BC1RGBAUnorm:case z.BC1RGBAUnormSRGB:case z.ETC2RGB8Unorm:case z.ETC2RGB8UnormSRGB:case z.ETC2RGB8A1Unorm:case z.ETC2RGB8A1UnormSRGB:case z.ETC2RGBA8Unorm:case z.ETC2RGBA8UnormSRGB:case z.EACR11Unorm:case z.EACR11Snorm:case z.EACRG11Unorm:case z.EACRG11Snorm:case z.ASTC4x4Unorm:case z.ASTC4x4UnormSRGB:case z.ASTC5x4Unorm:case z.ASTC5x4UnormSRGB:case z.ASTC5x5Unorm:case z.ASTC5x5UnormSRGB:case z.ASTC6x5Unorm:case z.ASTC6x5UnormSRGB:case z.ASTC6x6Unorm:case z.ASTC6x6UnormSRGB:case z.ASTC8x5Unorm:case z.ASTC8x5UnormSRGB:case z.ASTC8x6Unorm:case z.ASTC8x6UnormSRGB:case z.ASTC8x8Unorm:case z.ASTC8x8UnormSRGB:case z.ASTC10x5Unorm:case z.ASTC10x5UnormSRGB:case z.ASTC10x6Unorm:case z.ASTC10x6UnormSRGB:case z.ASTC10x8Unorm:case z.ASTC10x8UnormSRGB:case z.ASTC10x10Unorm:case z.ASTC10x10UnormSRGB:case z.ASTC12x10Unorm:case z.ASTC12x10UnormSRGB:case z.ASTC12x12Unorm:case z.ASTC12x12UnormSRGB:return 0;case z.R16Uint:case z.R16Sint:case z.RG16Uint:case z.RG16Sint:case z.RGBA16Uint:case z.RGBA16Sint:case z.Depth16Unorm:return 5;case z.R16Float:case z.RG16Float:case z.RGBA16Float:return 2;case z.R32Uint:case z.R32Sint:case z.RG32Uint:case z.RG32Sint:case z.RGBA32Uint:case z.RGBA32Sint:return 7;case z.R32Float:case z.RG32Float:case z.RGBA32Float:case z.Depth32Float:return 1;case z.Stencil8:throw"No fixed size for Stencil8 format!";case z.Depth24Plus:throw"No fixed size for Depth24Plus format!";case z.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!"}return 0}static _GetBlockInformationFromFormat(e){switch(e){case z.R8Unorm:case z.R8Snorm:case z.R8Uint:case z.R8Sint:return{width:1,height:1,length:1};case z.R16Uint:case z.R16Sint:case z.R16Float:case z.RG8Unorm:case z.RG8Snorm:case z.RG8Uint:case z.RG8Sint:return{width:1,height:1,length:2};case z.R32Uint:case z.R32Sint:case z.R32Float:case z.RG16Uint:case z.RG16Sint:case z.RG16Float:case z.RGBA8Unorm:case z.RGBA8UnormSRGB:case z.RGBA8Snorm:case z.RGBA8Uint:case z.RGBA8Sint:case z.BGRA8Unorm:case z.BGRA8UnormSRGB:case z.RGB9E5UFloat:case z.RGB10A2Unorm:case z.RG11B10UFloat:return{width:1,height:1,length:4};case z.RG32Uint:case z.RG32Sint:case z.RG32Float:case z.RGBA16Uint:case z.RGBA16Sint:case z.RGBA16Float:return{width:1,height:1,length:8};case z.RGBA32Uint:case z.RGBA32Sint:case z.RGBA32Float:return{width:1,height:1,length:16};case z.Stencil8:throw"No fixed size for Stencil8 format!";case z.Depth16Unorm:return{width:1,height:1,length:2};case z.Depth24Plus:throw"No fixed size for Depth24Plus format!";case z.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!";case z.Depth32Float:return{width:1,height:1,length:4};case z.Depth24UnormStencil8:return{width:1,height:1,length:4};case z.Depth32FloatStencil8:return{width:1,height:1,length:5};case z.BC7RGBAUnorm:case z.BC7RGBAUnormSRGB:case z.BC6HRGBUFloat:case z.BC6HRGBFloat:case z.BC5RGUnorm:case z.BC5RGSnorm:case z.BC3RGBAUnorm:case z.BC3RGBAUnormSRGB:case z.BC2RGBAUnorm:case z.BC2RGBAUnormSRGB:return{width:4,height:4,length:16};case z.BC4RUnorm:case z.BC4RSnorm:case z.BC1RGBAUnorm:case z.BC1RGBAUnormSRGB:return{width:4,height:4,length:8};case z.ETC2RGB8Unorm:case z.ETC2RGB8UnormSRGB:case z.ETC2RGB8A1Unorm:case z.ETC2RGB8A1UnormSRGB:case z.EACR11Unorm:case z.EACR11Snorm:return{width:4,height:4,length:8};case z.ETC2RGBA8Unorm:case z.ETC2RGBA8UnormSRGB:case z.EACRG11Unorm:case z.EACRG11Snorm:return{width:4,height:4,length:16};case z.ASTC4x4Unorm:case z.ASTC4x4UnormSRGB:return{width:4,height:4,length:16};case z.ASTC5x4Unorm:case z.ASTC5x4UnormSRGB:return{width:5,height:4,length:16};case z.ASTC5x5Unorm:case z.ASTC5x5UnormSRGB:return{width:5,height:5,length:16};case z.ASTC6x5Unorm:case z.ASTC6x5UnormSRGB:return{width:6,height:5,length:16};case z.ASTC6x6Unorm:case z.ASTC6x6UnormSRGB:return{width:6,height:6,length:16};case z.ASTC8x5Unorm:case z.ASTC8x5UnormSRGB:return{width:8,height:5,length:16};case z.ASTC8x6Unorm:case z.ASTC8x6UnormSRGB:return{width:8,height:6,length:16};case z.ASTC8x8Unorm:case z.ASTC8x8UnormSRGB:return{width:8,height:8,length:16};case z.ASTC10x5Unorm:case z.ASTC10x5UnormSRGB:return{width:10,height:5,length:16};case z.ASTC10x6Unorm:case z.ASTC10x6UnormSRGB:return{width:10,height:6,length:16};case z.ASTC10x8Unorm:case z.ASTC10x8UnormSRGB:return{width:10,height:8,length:16};case z.ASTC10x10Unorm:case z.ASTC10x10UnormSRGB:return{width:10,height:10,length:16};case z.ASTC12x10Unorm:case z.ASTC12x10UnormSRGB:return{width:12,height:10,length:16};case z.ASTC12x12Unorm:case z.ASTC12x12UnormSRGB:return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static _IsHardwareTexture(e){return!!e.release}static _IsInternalTexture(e){return!!e.dispose}static IsImageBitmap(e){return e.close!==void 0}static IsImageBitmapArray(e){return Array.isArray(e)&&e[0].close!==void 0}setCommandEncoder(e){this._commandEncoderForCreation=e}static IsCompressedFormat(e){switch(e){case z.BC7RGBAUnormSRGB:case z.BC7RGBAUnorm:case z.BC6HRGBFloat:case z.BC6HRGBUFloat:case z.BC5RGSnorm:case z.BC5RGUnorm:case z.BC4RSnorm:case z.BC4RUnorm:case z.BC3RGBAUnormSRGB:case z.BC3RGBAUnorm:case z.BC2RGBAUnormSRGB:case z.BC2RGBAUnorm:case z.BC1RGBAUnormSRGB:case z.BC1RGBAUnorm:case z.ETC2RGB8Unorm:case z.ETC2RGB8UnormSRGB:case z.ETC2RGB8A1Unorm:case z.ETC2RGB8A1UnormSRGB:case z.ETC2RGBA8Unorm:case z.ETC2RGBA8UnormSRGB:case z.EACR11Unorm:case z.EACR11Snorm:case z.EACRG11Unorm:case z.EACRG11Snorm:case z.ASTC4x4Unorm:case z.ASTC4x4UnormSRGB:case z.ASTC5x4Unorm:case z.ASTC5x4UnormSRGB:case z.ASTC5x5Unorm:case z.ASTC5x5UnormSRGB:case z.ASTC6x5Unorm:case z.ASTC6x5UnormSRGB:case z.ASTC6x6Unorm:case z.ASTC6x6UnormSRGB:case z.ASTC8x5Unorm:case z.ASTC8x5UnormSRGB:case z.ASTC8x6Unorm:case z.ASTC8x6UnormSRGB:case z.ASTC8x8Unorm:case z.ASTC8x8UnormSRGB:case z.ASTC10x5Unorm:case z.ASTC10x5UnormSRGB:case z.ASTC10x6Unorm:case z.ASTC10x6UnormSRGB:case z.ASTC10x8Unorm:case z.ASTC10x8UnormSRGB:case z.ASTC10x10Unorm:case z.ASTC10x10UnormSRGB:case z.ASTC12x10Unorm:case z.ASTC12x10UnormSRGB:case z.ASTC12x12Unorm:case z.ASTC12x12UnormSRGB:return!0}return!1}static GetWebGPUTextureFormat(e,t,i=!1){switch(t){case 15:return z.Depth16Unorm;case 16:return z.Depth24Plus;case 13:return z.Depth24PlusStencil8;case 14:return z.Depth32Float;case 17:return z.Depth24UnormStencil8;case 18:return z.Depth32FloatStencil8;case 36492:return i?z.BC7RGBAUnormSRGB:z.BC7RGBAUnorm;case 36495:return z.BC6HRGBUFloat;case 36494:return z.BC6HRGBFloat;case 33779:return i?z.BC3RGBAUnormSRGB:z.BC3RGBAUnorm;case 33778:return i?z.BC2RGBAUnormSRGB:z.BC2RGBAUnorm;case 33777:case 33776:return i?z.BC1RGBAUnormSRGB:z.BC1RGBAUnorm;case 37808:return i?z.ASTC4x4UnormSRGB:z.ASTC4x4Unorm;case 36196:case 37492:return i?z.ETC2RGB8UnormSRGB:z.ETC2RGB8Unorm;case 37496:return i?z.ETC2RGBA8UnormSRGB:z.ETC2RGBA8Unorm}switch(e){case 3:switch(t){case 6:return z.R8Snorm;case 7:return z.RG8Snorm;case 4:throw"RGB format not supported in WebGPU";case 8:return z.R8Sint;case 9:return z.RG8Sint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return z.RGBA8Sint;default:return z.RGBA8Snorm}case 0:switch(t){case 6:return z.R8Unorm;case 7:return z.RG8Unorm;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return i?z.RGBA8UnormSRGB:z.RGBA8Unorm;case 12:return i?z.BGRA8UnormSRGB:z.BGRA8Unorm;case 8:return z.R8Uint;case 9:return z.RG8Uint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return z.RGBA8Uint;case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return z.RGBA8Unorm}case 4:switch(t){case 8:return z.R16Sint;case 9:return z.RG16Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return z.RGBA16Sint;default:return z.RGBA16Sint}case 5:switch(t){case 8:return z.R16Uint;case 9:return z.RG16Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return z.RGBA16Uint;default:return z.RGBA16Uint}case 6:switch(t){case 8:return z.R32Sint;case 9:return z.RG32Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return z.RGBA32Sint;default:return z.RGBA32Sint}case 7:switch(t){case 8:return z.R32Uint;case 9:return z.RG32Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return z.RGBA32Uint;default:return z.RGBA32Uint}case 1:switch(t){case 6:return z.R32Float;case 7:return z.RG32Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return z.RGBA32Float;default:return z.RGBA32Float}case 2:switch(t){case 6:return z.R16Float;case 7:return z.RG16Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return z.RGBA16Float;default:return z.RGBA16Float}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:throw"TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV format not supported in WebGPU";case 14:throw"TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV format not supported in WebGPU";case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:return z.RGB10A2Unorm;case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV";default:return z.RGB10A2Unorm}}return i?z.RGBA8UnormSRGB:z.RGBA8Unorm}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case z.R8Unorm:case z.R8Snorm:case z.R8Uint:case z.R8Sint:case z.BC4RUnorm:case z.BC4RSnorm:case z.R16Uint:case z.R16Sint:case z.Depth16Unorm:case z.R16Float:case z.R32Uint:case z.R32Sint:case z.R32Float:case z.Depth32Float:case z.Stencil8:case z.Depth24Plus:case z.EACR11Unorm:case z.EACR11Snorm:return 1;case z.RG8Unorm:case z.RG8Snorm:case z.RG8Uint:case z.RG8Sint:case z.Depth24UnormStencil8:case z.Depth32FloatStencil8:case z.BC5RGUnorm:case z.BC5RGSnorm:case z.RG16Uint:case z.RG16Sint:case z.RG16Float:case z.RG32Uint:case z.RG32Sint:case z.RG32Float:case z.Depth24PlusStencil8:case z.EACRG11Unorm:case z.EACRG11Snorm:return 2;case z.RGB9E5UFloat:case z.RG11B10UFloat:case z.BC6HRGBUFloat:case z.BC6HRGBFloat:case z.ETC2RGB8Unorm:case z.ETC2RGB8UnormSRGB:return 3;case z.RGBA8Unorm:case z.RGBA8UnormSRGB:case z.RGBA8Snorm:case z.RGBA8Uint:case z.RGBA8Sint:case z.BGRA8Unorm:case z.BGRA8UnormSRGB:case z.RGB10A2Unorm:case z.BC7RGBAUnorm:case z.BC7RGBAUnormSRGB:case z.BC3RGBAUnorm:case z.BC3RGBAUnormSRGB:case z.BC2RGBAUnorm:case z.BC2RGBAUnormSRGB:case z.BC1RGBAUnorm:case z.BC1RGBAUnormSRGB:case z.RGBA16Uint:case z.RGBA16Sint:case z.RGBA16Float:case z.RGBA32Uint:case z.RGBA32Sint:case z.RGBA32Float:case z.ETC2RGB8A1Unorm:case z.ETC2RGB8A1UnormSRGB:case z.ETC2RGBA8Unorm:case z.ETC2RGBA8UnormSRGB:case z.ASTC4x4Unorm:case z.ASTC4x4UnormSRGB:case z.ASTC5x4Unorm:case z.ASTC5x4UnormSRGB:case z.ASTC5x5Unorm:case z.ASTC5x5UnormSRGB:case z.ASTC6x5Unorm:case z.ASTC6x5UnormSRGB:case z.ASTC6x6Unorm:case z.ASTC6x6UnormSRGB:case z.ASTC8x5Unorm:case z.ASTC8x5UnormSRGB:case z.ASTC8x6Unorm:case z.ASTC8x6UnormSRGB:case z.ASTC8x8Unorm:case z.ASTC8x8UnormSRGB:case z.ASTC10x5Unorm:case z.ASTC10x5UnormSRGB:case z.ASTC10x6Unorm:case z.ASTC10x6UnormSRGB:case z.ASTC10x8Unorm:case z.ASTC10x8UnormSRGB:case z.ASTC10x10Unorm:case z.ASTC10x10UnormSRGB:case z.ASTC12x10Unorm:case z.ASTC12x10UnormSRGB:case z.ASTC12x12Unorm:case z.ASTC12x12UnormSRGB:return 4}throw`Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case z.Stencil8:case z.Depth24UnormStencil8:case z.Depth32FloatStencil8:case z.Depth24PlusStencil8:return!0}return!1}static HasDepthAndStencilAspects(e){switch(e){case z.Depth24UnormStencil8:case z.Depth32FloatStencil8:case z.Depth24PlusStencil8:return!0}return!1}copyVideoToTexture(e,t,i,r=!1,s){var n,a,l,c;const h=s===void 0,[u,d]=this._getVideoPipeline(i,r?Gc.InvertY:Gc.DontInvertY);h&&(s=this._device.createCommandEncoder({})),(a=(n=s).pushDebugGroup)===null||a===void 0||a.call(n,`copy video to texture - invertY=${r}`);const _={colorAttachments:[{view:t._hardwareTexture.underlyingResource.createView({format:i,dimension:Ai.E2d,mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:ho.All}),loadOp:zr.Load,storeOp:na.Store}]},p=s.beginRenderPass(_),m={layout:d,entries:[{binding:0,resource:this._videoSampler},{binding:1,resource:this._device.importExternalTexture({source:e.underlyingResource})}]},T=this._device.createBindGroup(m);p.setPipeline(u),p.setBindGroup(0,T),p.draw(4,1,0,0),p.end(),(c=(l=s).popDebugGroup)===null||c===void 0||c.call(l),h&&(this._device.queue.submit([s.finish()]),s=null)}invertYPreMultiplyAlpha(e,t,i,r,s=!1,n=!1,a=0,l=0,c=1,h=0,u=0,d=0,f=0,_,p){var m,T,b,y,S,C;const I=d!==0,P=_===void 0,[D,w]=this._getPipeline(r,I?Ea.InvertYPremultiplyAlphaWithOfst:Ea.InvertYPremultiplyAlpha,{invertY:s,premultiplyAlpha:n});a=Math.max(a,0),P&&(_=this._device.createCommandEncoder({})),(T=(m=_).pushDebugGroup)===null||T===void 0||T.call(m,`internal process texture - invertY=${s} premultiplyAlpha=${n}`);let L;if(Bi._IsHardwareTexture(e)?(L=e.underlyingResource,s&&!n&&c===1&&a===0||(e=void 0)):(L=e,e=void 0),!L)return;I&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([h,u,d,f]),0,4*4);const U=e,G=(b=U==null?void 0:U._copyInvertYTempTexture)!==null&&b!==void 0?b:this.createTexture({width:t,height:i,layers:1},!1,!1,!1,!1,!1,r,1,_,Li.CopySrc|Li.RenderAttachment|Li.TextureBinding),Z=(y=U==null?void 0:U._copyInvertYRenderPassDescr)!==null&&y!==void 0?y:{colorAttachments:[{view:G.createView({format:r,dimension:Ai.E2d,baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:zr.Load,storeOp:na.Store}]},he=_.beginRenderPass(Z);let _e=I?U==null?void 0:U._copyInvertYBindGroupWithOfst:U==null?void 0:U._copyInvertYBindGroup;if(!_e){const ne={layout:w,entries:[{binding:0,resource:L.createView({format:r,dimension:Ai.E2d,baseMipLevel:l,mipLevelCount:1,arrayLayerCount:c,baseArrayLayer:a})}]};I&&ne.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),_e=this._device.createBindGroup(ne)}he.setPipeline(D),he.setBindGroup(0,_e),he.draw(4,1,0,0),he.end(),_.copyTextureToTexture({texture:G},{texture:L,mipLevel:l,origin:{x:0,y:0,z:a}},{width:t,height:i,depthOrArrayLayers:1}),U?(U._copyInvertYTempTexture=G,U._copyInvertYRenderPassDescr=Z,I?U._copyInvertYBindGroupWithOfst=_e:U._copyInvertYBindGroup=_e):this._deferredReleaseTextures.push([G,null]),(C=(S=_).popDebugGroup)===null||C===void 0||C.call(S),P&&(this._device.queue.submit([_.finish()]),_=null)}copyWithInvertY(e,t,i,r){var s,n,a,l;const c=r===void 0,[h,u]=this._getPipeline(t,Ea.InvertYPremultiplyAlpha,{invertY:!0,premultiplyAlpha:!1});c&&(r=this._device.createCommandEncoder({})),(n=(s=r).pushDebugGroup)===null||n===void 0||n.call(s,"internal copy texture with invertY");const d=r.beginRenderPass(i),f=this._device.createBindGroup({layout:u,entries:[{binding:0,resource:e}]});d.setPipeline(h),d.setBindGroup(0,f),d.draw(4,1,0,0),d.end(),(l=(a=r).popDebugGroup)===null||l===void 0||l.call(a),c&&(this._device.queue.submit([r.finish()]),r=null)}createTexture(e,t=!1,i=!1,r=!1,s=!1,n=!1,a=z.RGBA8Unorm,l=1,c,h=-1,u=0){l>1&&(l=4);const d=e.layers||1,f={width:e.width,height:e.height,depthOrArrayLayers:d},_=Bi.IsCompressedFormat(a),p=t?Bi.ComputeNumMipmapLevels(e.width,e.height):1,m=h>=0?h:Li.CopySrc|Li.CopyDst|Li.TextureBinding;u|=t&&!_?Li.CopySrc|Li.RenderAttachment:0,!_&&!n&&(u|=Li.RenderAttachment|Li.CopyDst);const T=this._device.createTexture({label:`Texture_${f.width}x${f.height}x${f.depthOrArrayLayers}_${t?"wmips":"womips"}_${a}_samples${l}`,size:f,dimension:n?Tl.E3d:Tl.E2d,format:a,usage:m|u,sampleCount:l,mipLevelCount:p});return Bi.IsImageBitmap(e)&&(this.updateTexture(e,T,e.width,e.height,d,a,0,0,r,s,0,0),t&&i&&this.generateMipmaps(T,a,p,0,c)),T}createCubeTexture(e,t=!1,i=!1,r=!1,s=!1,n=z.RGBA8Unorm,a=1,l,c=-1,h=0){a>1&&(a=4);const u=Bi.IsImageBitmapArray(e)?e[0].width:e.width,d=Bi.IsImageBitmapArray(e)?e[0].height:e.height,f=Bi.IsCompressedFormat(n),_=t?Bi.ComputeNumMipmapLevels(u,d):1,p=c>=0?c:Li.CopySrc|Li.CopyDst|Li.TextureBinding;h|=t&&!f?Li.CopySrc|Li.RenderAttachment:0,f||(h|=Li.RenderAttachment|Li.CopyDst);const m=this._device.createTexture({label:`TextureCube_${u}x${d}x6_${t?"wmips":"womips"}_${n}_samples${a}`,size:{width:u,height:d,depthOrArrayLayers:6},dimension:Tl.E2d,format:n,usage:p|h,sampleCount:a,mipLevelCount:_});return Bi.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,m,u,d,n,r,s,0,0),t&&i&&this.generateCubeMipmaps(m,n,_,l)),m}generateCubeMipmaps(e,t,i,r){var s,n,a,l;const c=r===void 0;c&&(r=this._device.createCommandEncoder({})),(n=(s=r).pushDebugGroup)===null||n===void 0||n.call(s,`create cube mipmaps - ${i} levels`);for(let h=0;h<6;++h)this.generateMipmaps(e,t,i,h,r);(l=(a=r).popDebugGroup)===null||l===void 0||l.call(a),c&&(this._device.queue.submit([r.finish()]),r=null)}generateMipmaps(e,t,i,r=0,s){var n,a,l,c,h,u,d,f;const _=s===void 0,[p,m]=this._getPipeline(t);r=Math.max(r,0),_&&(s=this._device.createCommandEncoder({})),(a=(n=s).pushDebugGroup)===null||a===void 0||a.call(n,`create mipmaps for face #${r} - ${i} levels`);let T;if(Bi._IsHardwareTexture(e)?(T=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(T=e,e=void 0),!T)return;const b=e;for(let y=1;y<i;++y){const S=(c=(l=b==null?void 0:b._mipmapGenRenderPassDescr[r])===null||l===void 0?void 0:l[y-1])!==null&&c!==void 0?c:{colorAttachments:[{view:T.createView({format:t,dimension:Ai.E2d,baseMipLevel:y,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r}),loadOp:zr.Load,storeOp:na.Store}]};b&&(b._mipmapGenRenderPassDescr[r]=b._mipmapGenRenderPassDescr[r]||[],b._mipmapGenRenderPassDescr[r][y-1]=S);const C=s.beginRenderPass(S),I=(u=(h=b==null?void 0:b._mipmapGenBindGroup[r])===null||h===void 0?void 0:h[y-1])!==null&&u!==void 0?u:this._device.createBindGroup({layout:m,entries:[{binding:0,resource:this._mipmapSampler},{binding:1,resource:T.createView({format:t,dimension:Ai.E2d,baseMipLevel:y-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r})}]});b&&(b._mipmapGenBindGroup[r]=b._mipmapGenBindGroup[r]||[],b._mipmapGenBindGroup[r][y-1]=I),C.setPipeline(p),C.setBindGroup(0,I),C.draw(4,1,0,0),C.end()}(f=(d=s).popDebugGroup)===null||f===void 0||f.call(d),_&&(this._device.queue.submit([s.finish()]),s=null)}createGPUTextureForInternalTexture(e,t,i,r,s){e._hardwareTexture||(e._hardwareTexture=new Ld),t===void 0&&(t=e.width),i===void 0&&(i=e.height),r===void 0&&(r=e.depth);const n=e._hardwareTexture,a=((s??0)&1)!==0;n.format=Bi.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),n.textureUsages=e._source===bt.RenderTarget||e.source===bt.MultiRenderTarget?Li.TextureBinding|Li.CopySrc|Li.RenderAttachment:e._source===bt.DepthStencil?Li.TextureBinding|Li.RenderAttachment:-1,n.textureAdditionalUsages=a?Li.StorageBinding:0;const l=e.generateMipMaps,c=r||1;let h;if(e._maxLodLevel!==null?h=e._maxLodLevel:h=l?Bi.ComputeNumMipmapLevels(t,i):1,e.isCube){const u=this.createCubeTexture({width:t,height:i},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,n.format,1,this._commandEncoderForCreation,n.textureUsages,n.textureAdditionalUsages);n.set(u),n.createView({format:n.format,dimension:Ai.Cube,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:Bi.HasDepthAndStencilAspects(n.format)?ho.DepthOnly:ho.All},a)}else{const u=this.createTexture({width:t,height:i,layers:c},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,n.format,1,this._commandEncoderForCreation,n.textureUsages,n.textureAdditionalUsages);n.set(u),n.createView({format:n.format,dimension:e.is2DArray?Ai.E2dArray:e.is3D?Tl.E3d:Ai.E2d,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:e.is3D?1:c,aspect:Bi.HasDepthAndStencilAspects(n.format)?ho.DepthOnly:ho.All},a)}return e.width=e.baseWidth=t,e.height=e.baseHeight=i,e.depth=e.baseDepth=r,this.createMSAATexture(e,e.samples),n}createMSAATexture(e,t){const i=e._hardwareTexture;if(i!=null&&i.msaaTexture&&(this.releaseTexture(i.msaaTexture),i.msaaTexture=null),!i||(t??1)<=1)return;const r=e.width,s=e.height,n=e.depth||1;if(e.isCube){const a=this.createCubeTexture({width:r,height:s},!1,!1,e.invertY,!1,i.format,t,this._commandEncoderForCreation,i.textureUsages,i.textureAdditionalUsages);i.msaaTexture=a}else{const a=this.createTexture({width:r,height:s,layers:n},!1,!1,e.invertY,!1,e.is3D,i.format,t,this._commandEncoderForCreation,i.textureUsages,i.textureAdditionalUsages);i.msaaTexture=a}}updateCubeTextures(e,t,i,r,s,n=!1,a=!1,l=0,c=0){const h=[0,3,1,4,2,5];for(let u=0;u<h.length;++u){const d=e[h[u]];this.updateTexture(d,t,i,r,1,s,u,0,n,a,l,c)}}updateTexture(e,t,i,r,s,n,a=0,l=0,c=!1,h=!1,u=0,d=0,f){const _=Bi._IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,p=Bi._GetBlockInformationFromFormat(n),m=Bi._IsInternalTexture(t)?t._hardwareTexture:t,T={texture:_,origin:{x:u,y:d,z:Math.max(a,0)},mipLevel:l,premultipliedAlpha:h},b={width:Math.ceil(i/p.width)*p.width,height:Math.ceil(r/p.height)*p.height,depthOrArrayLayers:s||1};if(e.byteLength!==void 0){e=e;const y=Math.ceil(i/p.width)*p.length;if(Math.ceil(y/256)*256===y){const C=this._device.createCommandEncoder({}),I=this._bufferManager.createRawBuffer(e.byteLength,Mi.MapWrite|Mi.CopySrc,!0),P=I.getMappedRange();new Uint8Array(P).set(e),I.unmap(),C.copyBufferToTexture({buffer:I,offset:0,bytesPerRow:y,rowsPerImage:r},T,b),this._device.queue.submit([C.finish()]),this._bufferManager.releaseBuffer(I)}else this._device.queue.writeTexture(T,e,{offset:0,bytesPerRow:y,rowsPerImage:r},b);if(c||h)if(Bi._IsInternalTexture(t)){const C=u===0&&d===0&&i===t.width&&r===t.height;this.invertYPreMultiplyAlpha(m,t.width,t.height,n,c,h,a,l,s||1,u,d,C?0:i,C?0:r,void 0,f)}else throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!"}else if(e=e,c)if(T.premultipliedAlpha=!1,Bi._IsInternalTexture(t)&&u===0&&d===0&&i===t.width&&r===t.height)this._device.queue.copyExternalImageToTexture({source:e},T,b),this.invertYPreMultiplyAlpha(m,i,r,n,c,h,a,l,s||1,0,0,0,0,void 0,f);else{const y=this._device.createCommandEncoder({}),S=this.createTexture({width:i,height:r,layers:1},!1,!1,!1,!1,!1,n,1,y,Li.CopySrc|Li.TextureBinding);this._deferredReleaseTextures.push([S,null]),b.depthOrArrayLayers=1,this._device.queue.copyExternalImageToTexture({source:e},{texture:S},b),b.depthOrArrayLayers=s||1,this.invertYPreMultiplyAlpha(S,i,r,n,c,h,a,l,s||1,0,0,0,0,y,f),y.copyTextureToTexture({texture:S},T,b),this._device.queue.submit([y.finish()])}else this._device.queue.copyExternalImageToTexture({source:e},T,b)}readPixels(e,t,i,r,s,n,a=0,l=0,c=null,h=!1){const u=Bi._GetBlockInformationFromFormat(n),d=Math.ceil(r/u.width)*u.length,f=Math.ceil(d/256)*256,_=f*s,p=this._bufferManager.createRawBuffer(_,Mi.MapRead|Mi.CopyDst),m=this._device.createCommandEncoder({});return m.copyTextureToBuffer({texture:e,mipLevel:l,origin:{x:t,y:i,z:Math.max(a,0)}},{buffer:p,offset:0,bytesPerRow:f},{width:r,height:s,depthOrArrayLayers:1}),this._device.queue.submit([m.finish()]),this._bufferManager.readDataFromBuffer(p,_,r,s,d,f,Bi._GetTextureTypeFromFormat(n),0,c,!0,h)}releaseTexture(e){if(Bi._IsInternalTexture(e)){const t=e._hardwareTexture,i=e._irradianceTexture;this._deferredReleaseTextures.push([t,i])}else this._deferredReleaseTextures.push([e,null])}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){const[t,i]=this._deferredReleaseTextures[e];t&&(Bi._IsHardwareTexture(t)?t.release():t.destroy()),i==null||i.dispose()}this._deferredReleaseTextures.length=0}}class AI extends _c{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}class ym{static _IsGPUBuffer(e){return e.underlyingResource===void 0}constructor(e){this._deferredReleaseBuffers=[],this._device=e}createRawBuffer(e,t,i=!1){const r=e.byteLength!==void 0?e.byteLength+3&-4:e+3&-4,s={mappedAtCreation:i,size:r,usage:t};return this._device.createBuffer(s)}createBuffer(e,t){const i=e.byteLength!==void 0,r=this.createRawBuffer(e,t),s=new AI(r);return s.references=1,s.capacity=i?e.byteLength:e,i&&this.setSubData(s,0,e),s}setRawData(e,t,i,r,s){this._device.queue.writeBuffer(e,t,i.buffer,r,s)}setSubData(e,t,i,r=0,s=0){const n=e.underlyingResource;s=s||i.byteLength,s=Math.min(s,e.capacity-t);let a=i.byteOffset+r,l=a+s;const c=s+3&-4;if(c!==s){const d=new Uint8Array(i.buffer.slice(a,l));i=new Uint8Array(c),i.set(d),r=0,a=0,l=c,s=c}const h=1024*1024*15;let u=0;for(;l-(a+u)>h;)this._device.queue.writeBuffer(n,t+u,i.buffer,a+u,h),u+=h;this._device.queue.writeBuffer(n,t+u,i.buffer,a+u,s-u)}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,i){i||(i=new Float32Array(e));const r=new Uint16Array(t);for(;e--;)i[e]=so(r[e]);return i}readDataFromBuffer(e,t,i,r,s,n,a=0,l=0,c=null,h=!0,u=!1){const d=a===1?2:a===2?1:0;return new Promise((f,_)=>{e.mapAsync(oc.Read,l,t).then(()=>{const p=e.getMappedRange(l,t);let m=c;if(u)m===null?m=W_(a,t,!0,p):m=W_(a,m.buffer,void 0,p);else if(m===null)switch(d){case 0:m=new Uint8Array(t),m.set(new Uint8Array(p));break;case 1:m=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,p);break;case 2:m=new Float32Array(t/4),m.set(new Float32Array(p));break}else switch(d){case 0:m=new Uint8Array(m.buffer),m.set(new Uint8Array(p));break;case 1:m=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,p,c);break;case 2:m=new Float32Array(m.buffer),m.set(new Float32Array(p));break}if(s!==n){d===1&&!u&&(s*=2,n*=2);const T=new Uint8Array(m.buffer);let b=s,y=0;for(let S=1;S<r;++S){y=S*n;for(let C=0;C<s;++C)T[b++]=T[y++]}d!==0&&!u?m=new Float32Array(T.buffer,0,b/4):m=new Uint8Array(T.buffer,0,b)}e.unmap(),h&&this.releaseBuffer(e),f(m)},p=>_(p))})}releaseBuffer(e){return ym._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,e.references===0?(this._deferredReleaseBuffers.push(e.underlyingResource),!0):!1)}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0}}class kv{constructor(){this.colorAttachmentGPUTextures=[],this.reset()}reset(e=!1){this.renderPass=null,e&&(this.renderPassDescriptor=null,this.colorAttachmentViewDescriptor=null,this.depthAttachmentViewDescriptor=null,this.colorAttachmentGPUTextures=[],this.depthTextureFormat=void 0)}}const RI=[0,0,3,7,0,2,6,2,4,1,5,3,1],II=[0,64,32,96,16,80,48,112,8],PI=[0,128,128,0,0,0,0,128,0,0,0,0,128];class ic{constructor(e){this._samplers={},this._device=e,this.disabled=!1}static GetSamplerHashCode(e){var t,i,r;const s=e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1;return RI[e.samplingMode]+II[(e._comparisonFunction||514)-512+1]+PI[e.samplingMode]+(((t=e._cachedWrapU)!==null&&t!==void 0?t:1)<<8)+(((i=e._cachedWrapV)!==null&&i!==void 0?i:1)<<10)+(((r=e._cachedWrapR)!==null&&r!==void 0?r:1)<<12)+((e.useMipMaps?1:0)<<14)+(s<<15)}static _GetSamplerFilterDescriptor(e,t){let i,r,s,n,a;const l=e.useMipMaps;switch(e.samplingMode){case 11:i=Wt.Linear,r=Wt.Linear,s=Wt.Nearest,l||(n=a=0);break;case 3:case 3:i=Wt.Linear,r=Wt.Linear,l?s=Wt.Linear:(s=Wt.Nearest,n=a=0);break;case 8:i=Wt.Nearest,r=Wt.Nearest,l?s=Wt.Linear:(s=Wt.Nearest,n=a=0);break;case 4:i=Wt.Nearest,r=Wt.Nearest,s=Wt.Nearest,l||(n=a=0);break;case 5:i=Wt.Nearest,r=Wt.Linear,s=Wt.Nearest,l||(n=a=0);break;case 6:i=Wt.Nearest,r=Wt.Linear,l?s=Wt.Linear:(s=Wt.Nearest,n=a=0);break;case 7:i=Wt.Nearest,r=Wt.Linear,s=Wt.Nearest,n=a=0;break;case 1:case 1:i=Wt.Nearest,r=Wt.Nearest,s=Wt.Nearest,n=a=0;break;case 9:i=Wt.Linear,r=Wt.Nearest,s=Wt.Nearest,l||(n=a=0);break;case 10:i=Wt.Linear,r=Wt.Nearest,l?s=Wt.Linear:(s=Wt.Nearest,n=a=0);break;case 2:case 2:i=Wt.Linear,r=Wt.Linear,s=Wt.Nearest,n=a=0;break;case 12:i=Wt.Linear,r=Wt.Nearest,s=Wt.Nearest,n=a=0;break;default:i=Wt.Nearest,r=Wt.Nearest,s=Wt.Nearest,n=a=0;break}return t>1&&(n!==0||a!==0)?{magFilter:Wt.Linear,minFilter:Wt.Linear,mipmapFilter:Wt.Linear,anisotropyEnabled:!0}:{magFilter:i,minFilter:r,mipmapFilter:s,lodMinClamp:n,lodMaxClamp:a}}static _GetWrappingMode(e){switch(e){case 1:return kc.Repeat;case 0:return kc.ClampToEdge;case 2:return kc.MirrorRepeat}return kc.Repeat}static _GetSamplerWrappingDescriptor(e){return{addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}}static _GetSamplerDescriptor(e){const t=e.useMipMaps&&e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1,i=this._GetSamplerFilterDescriptor(e,t);return{...i,...this._GetSamplerWrappingDescriptor(e),compare:e._comparisonFunction?ic.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:i.anisotropyEnabled?t:1}}static GetCompareFunction(e){switch(e){case 519:return ps.Always;case 514:return ps.Equal;case 516:return ps.Greater;case 518:return ps.GreaterEqual;case 513:return ps.Less;case 515:return ps.LessEqual;case 512:return ps.Never;case 517:return ps.NotEqual;default:return ps.Less}}getSampler(e,t=!1,i=0){if(this.disabled)return this._device.createSampler(ic._GetSamplerDescriptor(e));t?i=0:i===0&&(i=ic.GetSamplerHashCode(e));let r=t?void 0:this._samplers[i];return r||(r=this._device.createSampler(ic._GetSamplerDescriptor(e)),t||(this._samplers[i]=r)),r}}var mr;(function(o){o[o.StencilReadMask=0]="StencilReadMask",o[o.StencilWriteMask=1]="StencilWriteMask",o[o.DepthBias=2]="DepthBias",o[o.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",o[o.DepthStencilState=4]="DepthStencilState",o[o.MRTAttachments1=5]="MRTAttachments1",o[o.MRTAttachments2=6]="MRTAttachments2",o[o.RasterizationState=7]="RasterizationState",o[o.ColorStates=8]="ColorStates",o[o.ShaderStage=9]="ShaderStage",o[o.TextureStage=10]="TextureStage",o[o.VertexState=11]="VertexState",o[o.NumStates=12]="NumStates"})(mr||(mr={}));const Rd={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:12,32772:13},Dc={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7};class Xi{constructor(e,t,i){this.mrtTextureCount=0,this._device=e,this._useTextureStage=i,this._states=new Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=t,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this._kMaxVertexBufferStride=e.limits.maxVertexBufferArrayStride||2048,this.reset()}reset(){this._isDirty=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this._webgpuColorFormat=[z.BGRA8Unorm],this.setColorFormat(z.BGRA8Unorm),this.setMRT([]),this.setAlphaBlendEnabled(!1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat(z.Depth24PlusStencil8),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0)}get colorFormats(){return this._mrtAttachments1>0?this._mrtFormats:this._webgpuColorFormat}getRenderPipeline(e,t,i,r=0){if(i>1&&(i=4),this.disabled){const n=Xi._GetTopology(e);return this._setVertexState(t),this._parameter.pipeline=this._createRenderPipeline(t,n,i),Xi.NumCacheMiss++,Xi._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(t.uniqueId),this._setRasterizationState(e,i),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(t),this._setTextureState(r),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,Xi.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return Xi.NumCacheHitWithHash++,this._parameter.pipeline;const s=Xi._GetTopology(e);return this._parameter.pipeline=this._createRenderPipeline(t,s,i),this._setRenderPipeline(this._parameter),Xi.NumCacheMiss++,Xi._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}endFrame(){Xi.NumPipelineCreationLastFrame=Xi._NumPipelineCreationCurrentFrame,Xi._NumPipelineCreationCurrentFrame=0}setAlphaToCoverage(e){this._alphaToCoverageEnabled=e}setFrontFace(e){this._frontFace=e}setCullEnabled(e){this._cullEnabled=e}setCullFace(e){this._cullFace=e}setClampDepth(e){this._clampDepth=e}resetDepthCullingState(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)}setDepthCullingState(e,t,i,r,s,n,a,l){this._depthWriteEnabled=a,this._depthTestEnabled=n,this._depthCompare=(l??519)-512,this._cullFace=i,this._cullEnabled=e,this._frontFace=t,this.setDepthBiasSlopeScale(r),this.setDepthBias(s)}setDepthBias(e){this._depthBias!==e&&(this._depthBias=e,this._states[mr.DepthBias]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,mr.DepthBias))}setDepthBiasSlopeScale(e){this._depthBiasSlopeScale!==e&&(this._depthBiasSlopeScale=e,this._states[mr.DepthBiasSlopeScale]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,mr.DepthBiasSlopeScale))}setColorFormat(e){this._webgpuColorFormat[0]=e,this._colorFormat=Yh[e??""]}setMRTAttachments(e){this.mrtAttachments=e;let t=0;for(let i=0;i<e.length;++i)e[i]!==0&&(t+=1<<i);this._mrtEnabledMask!==t&&(this._mrtEnabledMask=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,mr.MRTAttachments1))}setMRT(e,t){var i,r;if(t=t??e.length,t>10)throw"Can't handle more than 10 attachments for a MRT in cache render pipeline!";this.mrtTextureArray=e,this.mrtTextureCount=t,this._mrtEnabledMask=65535;const s=[0,0];let n=0,a=0,l=0;for(let c=0;c<t;++c){const h=e[c],u=h==null?void 0:h._hardwareTexture;this._mrtFormats[l]=(i=u==null?void 0:u.format)!==null&&i!==void 0?i:this._webgpuColorFormat[0],s[n]+=Yh[(r=this._mrtFormats[l])!==null&&r!==void 0?r:""]<<a,a+=6,l++,a>=32&&(a=0,n++)}this._mrtFormats.length=l,(this._mrtAttachments1!==s[0]||this._mrtAttachments2!==s[1])&&(this._mrtAttachments1=s[0],this._mrtAttachments2=s[1],this._states[mr.MRTAttachments1]=s[0],this._states[mr.MRTAttachments2]=s[1],this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,mr.MRTAttachments1))}setAlphaBlendEnabled(e){this._alphaBlendEnabled=e}setAlphaBlendFactors(e,t){this._alphaBlendFuncParams=e,this._alphaBlendEqParams=t}setWriteMask(e){this._writeMask=e}setDepthStencilFormat(e){this._webgpuDepthStencilFormat=e,this._depthStencilFormat=e===void 0?0:Yh[e]}setDepthTestEnabled(e){this._depthTestEnabled=e}setDepthWriteEnabled(e){this._depthWriteEnabled=e}setDepthCompare(e){this._depthCompare=(e??519)-512}setStencilEnabled(e){this._stencilEnabled=e}setStencilCompare(e){this._stencilFrontCompare=(e??519)-512}setStencilDepthFailOp(e){this._stencilFrontDepthFailOp=e===null?1:Dc[e]}setStencilPassOp(e){this._stencilFrontPassOp=e===null?2:Dc[e]}setStencilFailOp(e){this._stencilFrontFailOp=e===null?1:Dc[e]}setStencilReadMask(e){this._stencilReadMask!==e&&(this._stencilReadMask=e,this._states[mr.StencilReadMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,mr.StencilReadMask))}setStencilWriteMask(e){this._stencilWriteMask!==e&&(this._stencilWriteMask=e,this._states[mr.StencilWriteMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,mr.StencilWriteMask))}resetStencilState(){this.setStencilState(!1,519,7680,7681,7680,255,255)}setStencilState(e,t,i,r,s,n,a){this._stencilEnabled=e,this._stencilFrontCompare=(t??519)-512,this._stencilFrontDepthFailOp=i===null?1:Dc[i],this._stencilFrontPassOp=r===null?2:Dc[r],this._stencilFrontFailOp=s===null?1:Dc[s],this.setStencilReadMask(n),this.setStencilWriteMask(a)}setBuffers(e,t,i){this._vertexBuffers=e,this._overrideVertexBuffers=i,this._indexBuffer=t}static _GetTopology(e){switch(e){case 0:return $n.TriangleList;case 2:return $n.PointList;case 1:return $n.LineList;case 3:return $n.PointList;case 4:return $n.LineList;case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return $n.LineStrip;case 7:return $n.TriangleStrip;case 8:throw"TriangleFan is an unsupported fillmode in WebGPU";default:return $n.TriangleList}}static _GetAphaBlendOperation(e){switch(e){case 32774:return _l.Add;case 32778:return _l.Subtract;case 32779:return _l.ReverseSubtract;case 32775:return _l.Min;case 32776:return _l.Max;default:return _l.Add}}static _GetAphaBlendFactor(e){switch(e){case 0:return $s.Zero;case 1:return $s.One;case 768:return $s.Src;case 769:return $s.OneMinusSrc;case 770:return $s.SrcAlpha;case 771:return $s.OneMinusSrcAlpha;case 772:return $s.DstAlpha;case 773:return $s.OneMinusDstAlpha;case 774:return $s.Dst;case 775:return $s.OneMinusDst;case 776:return $s.SrcAlphaSaturated;case 32769:return $s.Constant;case 32770:return $s.OneMinusConstant;case 32771:return $s.Constant;case 32772:return $s.OneMinusConstant;default:return $s.One}}static _GetCompareFunction(e){switch(e){case 0:return ps.Never;case 1:return ps.Less;case 2:return ps.Equal;case 3:return ps.LessEqual;case 4:return ps.Greater;case 5:return ps.NotEqual;case 6:return ps.GreaterEqual;case 7:return ps.Always}return ps.Never}static _GetStencilOpFunction(e){switch(e){case 0:return La.Zero;case 1:return La.Keep;case 2:return La.Replace;case 3:return La.IncrementClamp;case 4:return La.DecrementClamp;case 5:return La.Invert;case 6:return La.IncrementWrap;case 7:return La.DecrementWrap}return La.Keep}static _GetVertexInputDescriptorFormat(e){const t=e.type,i=e.normalized,r=e.getSize();switch(t){case O.BYTE:switch(r){case 1:case 2:return i?Wi.Snorm8x2:Wi.Sint8x2;case 3:case 4:return i?Wi.Snorm8x4:Wi.Sint8x4}break;case O.UNSIGNED_BYTE:switch(r){case 1:case 2:return i?Wi.Unorm8x2:Wi.Uint8x2;case 3:case 4:return i?Wi.Unorm8x4:Wi.Uint8x4}break;case O.SHORT:switch(r){case 1:case 2:return i?Wi.Snorm16x2:Wi.Sint16x2;case 3:case 4:return i?Wi.Snorm16x4:Wi.Sint16x4}break;case O.UNSIGNED_SHORT:switch(r){case 1:case 2:return i?Wi.Unorm16x2:Wi.Uint16x2;case 3:case 4:return i?Wi.Unorm16x4:Wi.Uint16x4}break;case O.INT:switch(r){case 1:return Wi.Sint32;case 2:return Wi.Sint32x2;case 3:return Wi.Sint32x3;case 4:return Wi.Sint32x4}break;case O.UNSIGNED_INT:switch(r){case 1:return Wi.Uint32;case 2:return Wi.Uint32x2;case 3:return Wi.Uint32x3;case 4:return Wi.Uint32x4}break;case O.FLOAT:switch(r){case 1:return Wi.Float32;case 2:return Wi.Float32x2;case 3:return Wi.Float32x3;case 4:return Wi.Float32x4}break}throw new Error(`Invalid Format '${e.getKind()}' - type=${t}, normalized=${i}, size=${r}`)}_getAphaBlendState(){return this._alphaBlendEnabled?{srcFactor:Xi._GetAphaBlendFactor(this._alphaBlendFuncParams[2]),dstFactor:Xi._GetAphaBlendFactor(this._alphaBlendFuncParams[3]),operation:Xi._GetAphaBlendOperation(this._alphaBlendEqParams[1])}:null}_getColorBlendState(){return this._alphaBlendEnabled?{srcFactor:Xi._GetAphaBlendFactor(this._alphaBlendFuncParams[0]),dstFactor:Xi._GetAphaBlendFactor(this._alphaBlendFuncParams[1]),operation:Xi._GetAphaBlendOperation(this._alphaBlendEqParams[0])}:null}_setShaderStage(e){this._shaderId!==e&&(this._shaderId=e,this._states[mr.ShaderStage]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,mr.ShaderStage))}_setRasterizationState(e,t){const i=this._frontFace,r=this._cullEnabled?this._cullFace:0,s=this._clampDepth?1:0,n=this._alphaToCoverageEnabled?1:0,a=i-1+(r<<1)+(s<<3)+(n<<4)+(e<<5)+(t<<8);this._rasterizationState!==a&&(this._rasterizationState=a,this._states[mr.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,mr.RasterizationState))}_setColorStates(){let e=((this._writeMask?1:0)<<22)+(this._colorFormat<<23)+((this._depthWriteEnabled?1:0)<<29);this._alphaBlendEnabled&&(e+=((this._alphaBlendFuncParams[0]===null?2:Rd[this._alphaBlendFuncParams[0]])<<0)+((this._alphaBlendFuncParams[1]===null?2:Rd[this._alphaBlendFuncParams[1]])<<4)+((this._alphaBlendFuncParams[2]===null?2:Rd[this._alphaBlendFuncParams[2]])<<8)+((this._alphaBlendFuncParams[3]===null?2:Rd[this._alphaBlendFuncParams[3]])<<12)+((this._alphaBlendEqParams[0]===null?1:this._alphaBlendEqParams[0]-32773)<<16)+((this._alphaBlendEqParams[1]===null?1:this._alphaBlendEqParams[1]-32773)<<19)),e!==this._colorStates&&(this._colorStates=e,this._states[mr.ColorStates]=this._colorStates,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,mr.ColorStates))}_setDepthStencilState(){const e=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9):591,t=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+(e<<10);this._depthStencilState!==t&&(this._depthStencilState=t,this._states[mr.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,mr.DepthStencilState))}_setVertexState(e){var t,i;const r=this._statesLength;let s=mr.VertexState;const n=e._pipelineContext,a=n.shaderProcessingContext.attributeNamesFromEffect,l=n.shaderProcessingContext.attributeLocationsFromEffect;let c,h=0;for(let u=0;u<a.length;u++){const d=l[u];let f=(t=this._overrideVertexBuffers&&this._overrideVertexBuffers[a[u]])!==null&&t!==void 0?t:this._vertexBuffers[a[u]];f||(f=this._emptyVertexBuffer);const _=(i=f.getBuffer())===null||i===void 0?void 0:i.underlyingResource;if(f._validOffsetRange===void 0){const m=f.byteOffset,T=f.getSize(!0),b=f.byteStride;f._validOffsetRange=m<=this._kMaxVertexBufferStride-T&&(b===0||m+T<=b)}c&&c===_&&f._validOffsetRange||(this.vertexBuffers[h++]=f,c=f._validOffsetRange?_:null);const p=f.hashCode+(d<<7);this._isDirty=this._isDirty||this._states[s]!==p,this._states[s++]=p}this.vertexBuffers.length=h,this._statesLength=s,this._isDirty=this._isDirty||s!==r,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,mr.VertexState))}_setTextureState(e){this._textureState!==e&&(this._textureState=e,this._states[mr.TextureStage]=this._textureState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,mr.TextureStage))}_createPipelineLayout(e){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(e);const t=[],i=e.shaderProcessingContext.bindGroupLayoutEntries;for(let r=0;r<i.length;r++){const s=i[r];t[r]=this._device.createBindGroupLayout({entries:s})}return e.bindGroupLayouts=t,this._device.createPipelineLayout({bindGroupLayouts:t})}_createPipelineLayoutWithTextureStage(e){var t;const i=e.shaderProcessingContext,r=i.bindGroupLayoutEntries;let s=1;for(let a=0;a<r.length;a++){const l=r[a];for(let c=0;c<l.length;c++){const h=r[a][c];if(h.texture){const u=i.bindGroupLayoutEntryInfo[a][h.binding].name,d=i.availableTextures[u],f=d.autoBindSampler?i.availableSamplers[u+ki.AutoSamplerSuffix]:null;let _=d.sampleType,p=(t=f==null?void 0:f.type)!==null&&t!==void 0?t:Dl.Filtering;if(this._textureState&s&&_!==Kn.Depth&&(d.autoBindSampler&&(p=Dl.NonFiltering),_=Kn.UnfilterableFloat),h.texture.sampleType=_,f){const m=i.bindGroupLayoutEntryInfo[f.binding.groupIndex][f.binding.bindingIndex].index;r[f.binding.groupIndex][m].sampler.type=p}s=s<<1}}}const n=[];for(let a=0;a<r.length;++a)n[a]=this._device.createBindGroupLayout({entries:r[a]});return e.bindGroupLayouts=n,this._device.createPipelineLayout({bindGroupLayouts:n})}_getVertexInputDescriptor(e){var t,i;const r=[],s=e._pipelineContext,n=s.shaderProcessingContext.attributeNamesFromEffect,a=s.shaderProcessingContext.attributeLocationsFromEffect;let l,c;for(let h=0;h<n.length;h++){const u=a[h];let d=(t=this._overrideVertexBuffers&&this._overrideVertexBuffers[n[h]])!==null&&t!==void 0?t:this._vertexBuffers[n[h]];d||(d=this._emptyVertexBuffer);let f=(i=d.getBuffer())===null||i===void 0?void 0:i.underlyingResource,_=d.byteOffset;const p=!d._validOffsetRange;if(!(l&&c&&l===f)||p){const m={arrayStride:d.byteStride,stepMode:d.getIsInstanced()?jd.Instance:jd.Vertex,attributes:[]};r.push(m),c=m.attributes,p&&(_=0,f=null)}c.push({shaderLocation:u,offset:_,format:Xi._GetVertexInputDescriptorFormat(d)}),l=f}return r}_createRenderPipeline(e,t,i){var r,s,n;const a=e._pipelineContext,l=this._getVertexInputDescriptor(e),c=this._createPipelineLayout(a),h=[],u=this._getAphaBlendState(),d=this._getColorBlendState();if(this._mrtAttachments1>0)for(let m=0;m<this._mrtFormats.length;++m){const T=this._mrtFormats[m];if(T){const b={format:T,writeMask:this._mrtEnabledMask&1<<m?this._writeMask:0};u&&d&&(b.blend={alpha:u,color:d}),h.push(b)}else h.push(null)}else if(this._webgpuColorFormat[0]){const m={format:this._webgpuColorFormat[0],writeMask:this._writeMask};u&&d&&(m.blend={alpha:u,color:d}),h.push(m)}else h.push(null);const f={compare:Xi._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:Xi._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:Xi._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:Xi._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)};let _;(t===$n.LineStrip||t===$n.TriangleStrip)&&(_=!this._indexBuffer||this._indexBuffer.is32Bits?Nl.Uint32:Nl.Uint16);const p=this._webgpuDepthStencilFormat?Bi.HasStencilAspect(this._webgpuDepthStencilFormat):!1;return this._device.createRenderPipeline({label:`RenderPipeline_${(s=(r=h[0])===null||r===void 0?void 0:r.format)!==null&&s!==void 0?s:"nooutput"}_${(n=this._webgpuDepthStencilFormat)!==null&&n!==void 0?n:"nodepth"}_samples${i}`,layout:c,vertex:{module:a.stages.vertexStage.module,entryPoint:a.stages.vertexStage.entryPoint,buffers:l},primitive:{topology:t,stripIndexFormat:_,frontFace:this._frontFace===1?Yd.CCW:Yd.CW,cullMode:this._cullEnabled?this._cullFace===2?$h.Front:$h.Back:$h.None},fragment:a.stages.fragmentStage?{module:a.stages.fragmentStage.module,entryPoint:a.stages.fragmentStage.entryPoint,targets:h}:void 0,multisample:{count:i},depthStencil:this._webgpuDepthStencilFormat===void 0?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?Xi._GetCompareFunction(this._depthCompare):ps.Always,format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&p?f:void 0,stencilBack:this._stencilEnabled&&p?f:void 0,stencilReadMask:this._stencilEnabled&&p?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&p?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:this._depthBiasClamp,depthBiasSlopeScale:this._depthBiasSlopeScale}})}}Xi.NumCacheHitWithoutHash=0;Xi.NumCacheHitWithHash=0;Xi.NumCacheMiss=0;Xi.NumPipelineCreationLastFrame=0;Xi._NumPipelineCreationCurrentFrame=0;class hE{constructor(){this.values={}}count(){let e=0,t=this.pipeline?1:0;for(const i in this.values){const r=this.values[i],[s,n]=r.count();e+=s,t+=n,e++}return[e,t]}}class Vo extends Xi{static GetNodeCounts(){const e=Vo._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}}static _GetPipelines(e,t,i,r){if(e.pipeline){const s=i.slice();s.length=r,t.push(s)}for(const s in e.values){const n=e.values[s];i[r]=parseInt(s),Vo._GetPipelines(n,t,i,r+1)}}static GetPipelines(){const e=[];return Vo._GetPipelines(Vo._Cache,e,[],0),e}constructor(e,t,i){super(e,t,i),this._nodeStack=[],this._nodeStack[0]=Vo._Cache}_getRenderPipeline(e){let t=this._nodeStack[this._stateDirtyLowestIndex];for(let i=this._stateDirtyLowestIndex;i<this._statesLength;++i){let r=t.values[this._states[i]];r||(r=new hE,t.values[this._states[i]]=r),t=r,this._nodeStack[i+1]=t}e.token=t,e.pipeline=t.pipeline}_setRenderPipeline(e){e.token.pipeline=e.pipeline}}Vo._Cache=new hE;class MI extends aT{constructor(e){super(!1),this._cache=e,this.reset()}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e))}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e))}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e))}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e))}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e))}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e))}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e))}reset(){super.reset(),this._cache.resetStencilState()}apply(){var e;const t=(e=this.stencilMaterial)===null||e===void 0?void 0:e.enabled;this.enabled=t?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.func=t?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=t?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=t?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=t?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=t?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=t?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=t?this.stencilMaterial.mask:this.stencilGlobal.mask)}}class OI extends rT{constructor(e){super(!1),this._cache=e,this.reset()}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0,this._cache.setDepthBias(e))}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(e??1))}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(e??2))}reset(){super.reset(),this._cache.resetDepthCullingState()}apply(){}}class uE{static IsExternalTexture(e){return e.underlyingResource!==void 0}getClassName(){return"ExternalTexture"}get underlyingResource(){return this._video}constructor(e){this.useMipMaps=!1,this.type=16,this._video=e,this.uniqueId=hi._Counter++}isReady(){return this._video.readyState>=this._video.HAVE_CURRENT_DATA}dispose(){}}class kf{get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatTextures(){return this._numFloatTextures>0}constructor(){this.uniqueId=kf._Counter++,this.updateId=0,this.reset()}reset(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatTextures=0,this._numExternalTextures=0}setSampler(e,t){let i=this.samplers[e],r=-1;i?r=i.hashCode:this.samplers[e]=i={sampler:t,hashCode:0},i.sampler=t,i.hashCode=t?ic.GetSamplerHashCode(t):0;const s=r!==i.hashCode;s&&this.updateId++,this.isDirty||(this.isDirty=s)}setTexture(e,t){var i,r,s;let n=this.textures[e],a=-1;n?a=(r=(i=n.texture)===null||i===void 0?void 0:i.uniqueId)!==null&&r!==void 0?r:-1:this.textures[e]=n={texture:t,isFloatTexture:!1,isExternalTexture:!1},n.isExternalTexture&&this._numExternalTextures--,n.isFloatTexture&&this._numFloatTextures--,t?(n.isFloatTexture=t.type===1,n.isExternalTexture=uE.IsExternalTexture(t),n.isFloatTexture&&this._numFloatTextures++,n.isExternalTexture&&this._numExternalTextures++):(n.isFloatTexture=!1,n.isExternalTexture=!1),n.texture=t;const l=a!==((s=t==null?void 0:t.uniqueId)!==null&&s!==void 0?s:-1);l&&this.updateId++,this.isDirty||(this.isDirty=l)}}kf._Counter=0;class Gf{isDirty(e){return this._isDirty||this._materialContextUpdateId!==e}resetIsDirty(e){this._isDirty=!1,this._materialContextUpdateId=e}get useInstancing(){return this._useInstancing}set useInstancing(e){this._useInstancing!==e&&(e?(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(40,Mi.CopyDst|Mi.Indirect),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0):(this.indirectDrawBuffer&&this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this._useInstancing=e,this._currentInstanceCount=-1)}constructor(e){this._bufferManager=e,this.uniqueId=Gf._Counter++,this._useInstancing=!1,this._currentInstanceCount=0,this.reset()}reset(){this.buffers={},this._isDirty=!0,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0}setBuffer(e,t){var i;this._isDirty||(this._isDirty=(t==null?void 0:t.uniqueId)!==((i=this.buffers[e])===null||i===void 0?void 0:i.uniqueId)),this.buffers[e]=t}setIndirectData(e,t,i){t===this._currentInstanceCount||!this.indirectDrawBuffer||!this._indirectDrawData||(this._currentInstanceCount=t,this._indirectDrawData[0]=e,this._indirectDrawData[1]=t,this._indirectDrawData[2]=i,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20))}dispose(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0}}Gf._Counter=0;class Bd{constructor(){this.values={}}}class ir{static get Statistics(){return{totalCreated:ir.NumBindGroupsCreatedTotal,lastFrameCreated:ir.NumBindGroupsCreatedLastFrame,lookupLastFrame:ir.NumBindGroupsLookupLastFrame,noLookupLastFrame:ir.NumBindGroupsNoLookupLastFrame}}constructor(e,t,i){this.disabled=!1,this._device=e,this._cacheSampler=t,this._engine=i}endFrame(){ir.NumBindGroupsCreatedLastFrame=ir._NumBindGroupsCreatedCurrentFrame,ir.NumBindGroupsLookupLastFrame=ir._NumBindGroupsLookupCurrentFrame,ir.NumBindGroupsNoLookupLastFrame=ir._NumBindGroupsNoLookupCurrentFrame,ir._NumBindGroupsCreatedCurrentFrame=0,ir._NumBindGroupsLookupCurrentFrame=0,ir._NumBindGroupsNoLookupCurrentFrame=0}getBindGroups(e,t,i){var r,s,n,a,l,c,h,u,d,f;let _,p=ir._Cache;const m=this.disabled||i.forceBindGroupCreation;if(!m){if(!t.isDirty(i.updateId)&&!i.isDirty)return ir._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(const b of e.shaderProcessingContext.bufferNames){const y=(s=(r=t.buffers[b])===null||r===void 0?void 0:r.uniqueId)!==null&&s!==void 0?s:0;let S=p.values[y];S||(S=new Bd,p.values[y]=S),p=S}for(const b of e.shaderProcessingContext.samplerNames){const y=(a=(n=i.samplers[b])===null||n===void 0?void 0:n.hashCode)!==null&&a!==void 0?a:0;let S=p.values[y];S||(S=new Bd,p.values[y]=S),p=S}for(const b of e.shaderProcessingContext.textureNames){const y=(h=(c=(l=i.textures[b])===null||l===void 0?void 0:l.texture)===null||c===void 0?void 0:c.uniqueId)!==null&&h!==void 0?h:0;let S=p.values[y];S||(S=new Bd,p.values[y]=S),p=S}_=p.bindGroups}if(t.resetIsDirty(i.updateId),i.isDirty=!1,_)return t.bindGroups=_,ir._NumBindGroupsLookupCurrentFrame++,_;_=[],t.bindGroups=_,m||(p.bindGroups=_),ir.NumBindGroupsCreatedTotal++,ir._NumBindGroupsCreatedCurrentFrame++;const T=e.bindGroupLayouts;for(let b=0;b<e.shaderProcessingContext.bindGroupLayoutEntries.length;b++){const y=e.shaderProcessingContext.bindGroupLayoutEntries[b],S=e.shaderProcessingContext.bindGroupEntries[b];for(let I=0;I<y.length;I++){const P=e.shaderProcessingContext.bindGroupLayoutEntries[b][I],D=e.shaderProcessingContext.bindGroupLayoutEntryInfo[b][P.binding],w=(u=D.nameInArrayOfTexture)!==null&&u!==void 0?u:D.name;if(P.sampler){const L=i.samplers[w];if(L){const U=L.sampler;if(!U){this._engine.dbgSanityChecks&&X.Error(`Trying to bind a null sampler! entry=${JSON.stringify(P)}, name=${w}, bindingInfo=${JSON.stringify(L,(G,Z)=>G==="texture"?"<no dump>":Z)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}S[I].resource=this._cacheSampler.getSampler(U,!1,L.hashCode)}else X.Error(`Sampler "${w}" could not be bound. entry=${JSON.stringify(P)}, materialContext=${JSON.stringify(i,(U,G)=>U==="texture"||U==="sampler"?"<no dump>":G)}`,50)}else if(P.texture||P.storageTexture){const L=i.textures[w];if(L){if(this._engine.dbgSanityChecks&&L.texture===null){X.Error(`Trying to bind a null texture! entry=${JSON.stringify(P)}, bindingInfo=${JSON.stringify(L,(G,Z)=>G==="texture"?"<no dump>":Z)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const U=L.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!U||P.texture&&!U.view||P.storageTexture&&!U.viewForWriting)){X.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(P)}, name=${w}, bindingInfo=${JSON.stringify(L,(G,Z)=>G==="texture"?"<no dump>":Z)}, isReady=${(d=L.texture)===null||d===void 0?void 0:d.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}S[I].resource=P.storageTexture?U.viewForWriting:U.view}else X.Error(`Texture "${w}" could not be bound. entry=${JSON.stringify(P)}, materialContext=${JSON.stringify(i,(U,G)=>U==="texture"||U==="sampler"?"<no dump>":G)}`,50)}else if(P.externalTexture){const L=i.textures[w];if(L){if(this._engine.dbgSanityChecks&&L.texture===null){X.Error(`Trying to bind a null external texture! entry=${JSON.stringify(P)}, name=${w}, bindingInfo=${JSON.stringify(L,(G,Z)=>G==="texture"?"<no dump>":Z)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const U=L.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!U){X.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(P)}, name=${w}, bindingInfo=${JSON.stringify(L,(G,Z)=>G==="texture"?"<no dump>":Z)}, isReady=${(f=L.texture)===null||f===void 0?void 0:f.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}S[I].resource=this._device.importExternalTexture({source:U})}else X.Error(`Texture "${w}" could not be bound. entry=${JSON.stringify(P)}, materialContext=${JSON.stringify(i,(U,G)=>U==="texture"||U==="sampler"?"<no dump>":G)}`,50)}else if(P.buffer){const L=t.buffers[w];if(L){const U=L.underlyingResource;S[I].resource.buffer=U,S[I].resource.size=L.capacity}else X.Error(`Can't find buffer "${w}". entry=${JSON.stringify(P)}, buffers=${JSON.stringify(t.buffers)}, drawContext.uniqueId=${t.uniqueId}`,50)}}const C=T[b];_[b]=this._device.createBindGroup({layout:C,entries:S})}return _}}ir.NumBindGroupsCreatedTotal=0;ir.NumBindGroupsCreatedLastFrame=0;ir.NumBindGroupsLookupLastFrame=0;ir.NumBindGroupsNoLookupLastFrame=0;ir._Cache=new Bd;ir._NumBindGroupsCreatedCurrentFrame=0;ir._NumBindGroupsLookupCurrentFrame=0;ir._NumBindGroupsNoLookupCurrentFrame=0;const DI="clearQuadVertexShader",NI=`uniform float depthValue;
const vec2 pos[4]={
vec2(-1.0,1.0),
vec2(1.0,1.0),
vec2(-1.0,-1.0),
vec2(1.0,-1.0)
};
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
gl_Position=vec4(pos[gl_VertexID],depthValue,1.0);
#define CUSTOM_VERTEX_MAIN_END
}
`;te.ShadersStore[DI]=NI;const wI="clearQuadPixelShader",FI=`uniform vec4 color;
void main() {
gl_FragColor=color;
}
`;te.ShadersStore[wI]=FI;class LI{setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e)}setMRTAttachments(e,t,i){this._cacheRenderPipeline.setMRT(t,i),this._cacheRenderPipeline.setMRTAttachments(e)}constructor(e,t,i){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new Vo(this._device,i,!t._caps.textureFloatLinearFiltering),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"])}clear(e,t,i,r,s=1){var n,a;let l,c=null,h;const u=!!this._engine._currentRenderTarget;if(e)l=e;else{let b=0;this._keyTemp.length=0;for(let S=0;S<this._cacheRenderPipeline.colorFormats.length;++S)this._keyTemp[b++]=Yh[(n=this._cacheRenderPipeline.colorFormats[S])!==null&&n!==void 0?n:""];const y=Yh[(a=this._depthTextureFormat)!==null&&a!==void 0?a:0];if(this._keyTemp[b]=(t?t.r+t.g*256+t.b*256*256+t.a*256*256*256:0)+(i?2**32:0)+(r?2**33:0)+(this._engine.useReverseDepthBuffer?2**34:0)+(u?2**35:0)+(s>1?2**36:0)+y*2**37,h=this._keyTemp.join("_"),c=this._bundleCache[h],c)return c;l=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:s})}this._cacheRenderPipeline.setDepthWriteEnabled(!!i),this._cacheRenderPipeline.setStencilEnabled(!!r&&!!this._depthTextureFormat&&Bi.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(r?255:0),this._cacheRenderPipeline.setStencilCompare(r?519:512),this._cacheRenderPipeline.setStencilPassOp(r?7681:7680),this._cacheRenderPipeline.setWriteMask(t?15:0);const d=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,s),f=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),f.uniformBuffer.update();const _=u?this._engine._ubInvertY:this._engine._ubDontInvertY,p=f.uniformBuffer.getBuffer(),m=p.uniqueId+"-"+_.uniqueId;let T=this._bindGroups[m];if(!T){const b=f.bindGroupLayouts;T=this._bindGroups[m]=[],T.push(this._device.createBindGroup({layout:b[0],entries:[]})),ca._SimplifiedKnownBindings||T.push(this._device.createBindGroup({layout:b[1],entries:[]})),T.push(this._device.createBindGroup({layout:b[ca._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:_.underlyingResource,size:_.capacity}},{binding:1,resource:{buffer:p.underlyingResource,size:p.capacity}}]}))}l.setPipeline(d);for(let b=0;b<T.length;++b)l.setBindGroup(b,T[b]);return l.draw(4,1,0,0),e||(c=l.finish(),this._bundleCache[h]=c),c}}class Cm{constructor(e,t,i,r){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(i),this.h=Math.floor(r)}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new Cm(this.x,this.y,this.w,this.h)}}class jh{constructor(e,t,i,r){this.x=e,this.y=t,this.w=i,this.h=r}run(e){e.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new jh(this.x,this.y,this.w,this.h)}}class Kh{constructor(e){this.ref=e}run(e){e.setStencilReference(this.ref)}clone(){return new Kh(this.ref)}}class Am{constructor(e){this.color=e}run(e){e.setBlendConstant(this.color)}clone(){return new Am(this.color)}}class Rm{constructor(e){this.query=e}run(e){e.beginOcclusionQuery(this.query)}clone(){return new Rm(this.query)}}class Im{constructor(){}run(e){e.endOcclusionQuery()}clone(){return new Im}}class Pm{constructor(){this.bundles=[]}run(e){e.executeBundles(this.bundles)}clone(){const e=new Pm;return e.bundles=this.bundles,e}}class Qd{constructor(e){this.numDrawCalls=0,this._device=e,this._list=new Array(10),this._listLength=0}addBundle(e){if(!this._currentItemIsBundle){const t=new Pm;this._list[this._listLength++]=t,this._currentBundleList=t.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1}getBundleEncoder(e,t,i){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:i})),this._bundleEncoder}close(){this._finishBundle()}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e)}reset(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0}clone(){this.close();const e=new Qd(this._device);e._list=new Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}}class dE{get querySet(){return this._querySet}constructor(e,t,i,r,s=!0){this._dstBuffers=[],this._device=i,this._bufferManager=r,this._count=e,this._canUseMultipleBuffers=s,this._querySet=i.createQuerySet({type:t,count:e}),this._queryBuffer=r.createRawBuffer(8*e,Mi.QueryResolve|Mi.CopySrc),s||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,Mi.MapRead|Mi.CopyDst))}_getBuffer(e,t){if(!this._canUseMultipleBuffers&&this._dstBuffers.length===0)return null;const i=this._device.createCommandEncoder();let r;return this._dstBuffers.length===0?r=this._bufferManager.createRawBuffer(8*this._count,Mi.MapRead|Mi.CopyDst):(r=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),i.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),i.copyBufferToBuffer(this._queryBuffer,0,r,0,8*t),this._device.queue.submit([i.finish()]),r}async readValues(e=0,t=1){const i=this._getBuffer(e,t);if(i===null)return null;await i.mapAsync(oc.Read);const r=new BigUint64Array(i.getMappedRange()).slice();return i.unmap(),this._dstBuffers[this._dstBuffers.length]=i,r}async readValue(e=0){const t=this._getBuffer(e,1);if(t===null)return null;await t.mapAsync(oc.Read);const i=new BigUint64Array(t.getMappedRange()),r=Number(i[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,r}async readTwoValuesAndSubtract(e=0){const t=this._getBuffer(e,2);if(t===null)return null;await t.mapAsync(oc.Read);const i=new BigUint64Array(t.getMappedRange()),r=Number(i[1]-i[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,r}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])}}class BI{get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}constructor(e,t){this._enabled=!1,this._gpuFrameTimeCounter=new ya,this._measureDurationState=0,this._device=e,this._bufferManager=t}get enable(){return this._enabled}set enable(e){this._enabled!==e&&(this._enabled=e,this._measureDurationState=0,e?this._measureDuration=new UI(this._device,this._bufferManager):this._measureDuration.dispose())}startFrame(e){this._enabled&&this._measureDurationState===0&&(this._measureDuration.start(e),this._measureDurationState=1)}endFrame(e){this._measureDurationState===1&&(this._measureDurationState=2,this._measureDuration.stop(e).then(t=>{t!==null&&t>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(t,!0)),this._measureDurationState=0}))}}class UI{constructor(e,t){this._querySet=new dE(2,Kd.Timestamp,e,t)}start(e){e.writeTimestamp(this._querySet.querySet,0)}async stop(e){return e.writeTimestamp(this._querySet.querySet,1),this._querySet.readTwoValuesAndSubtract(0)}dispose(){this._querySet.dispose()}}class VI{get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}get canBeginQuery(){switch(this._engine._getCurrentRenderPassIndex()){case 0:return this._engine._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet!==void 0;case 1:return this._engine._rttRenderPassWrapper.renderPassDescriptor.occlusionQuerySet!==void 0}return!1}constructor(e,t,i,r=50,s=100){this._availableIndices=[],this._engine=e,this._device=t,this._bufferManager=i,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=s,this._allocateNewIndices(r)}createQuery(){this._availableIndices.length===0&&this._allocateNewIndices();const e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length-1]=e}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){var t,i;return Number((i=(t=this._lastBuffer)===null||t===void 0?void 0:t[e])!==null&&i!==void 0?i:-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then(e=>{this._lastBuffer=e}))}_allocateNewIndices(e){e=e??this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new dE(this._currentTotalIndices,Kd.Occlusion,this._device,this._bufferManager,!1)}_delayQuerySetDispose(){const e=this._querySet;e&&setTimeout(()=>e.dispose,1e3)}dispose(){var e;(e=this._querySet)===null||e===void 0||e.dispose(),this._availableIndices.length=0}}class dh{constructor(){this._twgsl=null}async initTwgsl(e){return e=e||{},e={...dh._TWgslDefaultOptions,...e},e.twgsl?(this._twgsl=e.twgsl,Promise.resolve()):(e.jsPath&&e.wasmPath&&(Ar()?await J.LoadScriptAsync(e.jsPath):importScripts(e.jsPath)),self.twgsl?(this._twgsl=await self.twgsl(e.wasmPath),Promise.resolve()):Promise.reject("twgsl is not available."))}convertSpirV2WGSL(e){const t=this._twgsl.convertSpirV2WGSL(e);return dh.ShowWGSLShaderCode&&(console.log(t),console.log("***********************************************")),t}}dh._TWgslDefaultOptions={jsPath:"https://preview.babylonjs.com/twgsl/twgsl.js",wasmPath:"https://preview.babylonjs.com/twgsl/twgsl.wasm"};dh.ShowWGSLShaderCode=!1;class kI{constructor(e,t,i,r){this._record=!1,this._play=!1,this._mainPassBundleList=[],this._enabled=!1,this._engine=e,this._mode=t,this._bundleList=i,this._bundleListRenderTarget=r}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._mainPassBundleList.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e}endMainRenderPass(){this._record&&this._mainPassBundleList.push(this._bundleList.clone())}endRenderTargetPass(e,t){var i,r,s,n;if(this._play)(r=(i=t._bundleLists)===null||i===void 0?void 0:i[t._currentLayer])===null||r===void 0||r.run(e),this._mode===1&&this._engine._reportDrawCall((n=(s=t._bundleLists)===null||s===void 0?void 0:s[t._currentLayer])===null||n===void 0?void 0:n.numDrawCalls);else if(this._record)t._bundleLists||(t._bundleLists=[]),t._bundleLists[t._currentLayer]=this._bundleListRenderTarget.clone(),t._bundleLists[t._currentLayer].run(e),this._bundleListRenderTarget.reset();else return!1;return!0}endFrame(e){if(this._record&&(this._mainPassBundleList.push(this._bundleList.clone()),this._record=!1,this._play=!0,this._mode=this._modeSaved),e!==null&&this._play)for(let t=0;t<this._mainPassBundleList.length;++t)this._mainPassBundleList[t].run(e),this._mode===1&&this._engine._reportDrawCall(this._mainPassBundleList[t].numDrawCalls)}reset(){this.enabled=!1,this.enabled=!0}}class vt extends q{get snapshotRenderingMode(){return this._snapshotRendering.mode}set snapshotRenderingMode(e){this._snapshotRendering.mode=e}snapshotRenderingReset(){this._snapshotRendering.reset()}get snapshotRendering(){return this._snapshotRendering.enabled}set snapshotRendering(e){this._snapshotRendering.enabled=e}get disableCacheSamplers(){return this._cacheSampler?this._cacheSampler.disabled:!1}set disableCacheSamplers(e){this._cacheSampler&&(this._cacheSampler.disabled=e)}get disableCacheRenderPipelines(){return this._cacheRenderPipeline?this._cacheRenderPipeline.disabled:!1}set disableCacheRenderPipelines(e){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=e)}get disableCacheBindGroups(){return this._cacheBindGroups?this._cacheBindGroups.disabled:!1}set disableCacheBindGroups(e){this._cacheBindGroups&&(this._cacheBindGroups.disabled=e)}static get IsSupportedAsync(){return navigator.gpu?navigator.gpu.requestAdapter().then(e=>!!e,()=>!1).catch(()=>!1):Promise.resolve(!1)}static get IsSupported(){return X.Warn("You must call IsSupportedAsync for WebGPU!"),!1}get supportsUniformBuffers(){return!0}get supportedExtensions(){return this._adapterSupportedExtensions}get enabledExtensions(){return this._deviceEnabledExtensions}get description(){return this.name+this.version}get version(){return 1}getInfo(){return{vendor:"unknown vendor",renderer:"unknown renderer",version:"unknown version"}}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=e}get currentSampleCount(){return this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount}static CreateAsync(e,t={}){const i=new vt(e,t);return new Promise(r=>{i.initAsync(t.glslangOptions,t.twgslOptions).then(()=>r(i))})}constructor(e,t={}){var i,r;if(super(null,(i=t.antialias)!==null&&i!==void 0?i:!0,t),this._uploadEncoderDescriptor={label:"upload"},this._renderEncoderDescriptor={label:"render"},this._renderTargetEncoderDescriptor={label:"renderTarget"},this._clearDepthValue=1,this._clearReverseDepthValue=0,this._clearStencilValue=0,this._defaultSampleCount=4,this._glslang=null,this._tintWASM=null,this._compiledComputeEffects={},this._counters={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.countersLastFrame={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.numMaxUncapturedErrors=20,this._commandBuffers=[null,null,null],this._currentRenderPass=null,this._mainRenderPassWrapper=new kv,this._rttRenderPassWrapper=new kv,this._pendingDebugCommands=[],this._onAfterUnbindFrameBufferObservable=new Q,this._currentOverrideVertexBuffers=null,this._currentIndexBuffer=null,this._colorWriteLocal=!0,this._forceEnableEffect=!1,this.dbgShowShaderCode=!1,this.dbgSanityChecks=!0,this.dbgVerboseLogsForFirstFrames=!1,this.dbgVerboseLogsNumFrames=10,this.dbgLogIfNotDrawWrapper=!0,this.dbgShowEmptyEnableEffectCalls=!0,this.isNDCHalfZRange=!0,this.hasOriginBottomLeft=!1,this._viewportsCurrent=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],this._scissorsCurrent=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],this._scissorCached={x:0,y:0,z:0,w:0},this._stencilRefsCurrent=[-1,-1],this._blendColorsCurrent=[[null,null,null,null],[null,null,null,null]],this._name="WebGPU",t.deviceDescriptor=t.deviceDescriptor||{},t.enableGPUDebugMarkers=(r=t.enableGPUDebugMarkers)!==null&&r!==void 0?r:!1,X.Log(`Babylon.js v${q.Version} - ${this.description} engine`),!navigator.gpu){X.Error("WebGPU is not supported by your browser.");return}t.swapChainFormat=t.swapChainFormat||navigator.gpu.getPreferredCanvasFormat(),this._isWebGPU=!0,this._shaderPlatformName="WEBGPU",this._canvas=e,this._options=t,this._mainPassSampleCount=t.antialias?this._defaultSampleCount:1,this._setupMobileChecks(),this._sharedInit(e),this._shaderProcessor=new NR,this._shaderProcessorWGSL=new pI}initAsync(e,t){var i;return this._initGlslang(e??((i=this._options)===null||i===void 0?void 0:i.glslangOptions)).then(r=>{var s;return this._glslang=r,this._tintWASM=vt.UseTWGSL?new dh:null,this._tintWASM?this._tintWASM.initTwgsl(t??((s=this._options)===null||s===void 0?void 0:s.twgslOptions)).then(()=>navigator.gpu.requestAdapter(this._options),n=>{throw X.Error("Can not initialize twgsl!"),X.Error(n),Error("WebGPU initializations stopped.")}):navigator.gpu.requestAdapter(this._options)},r=>{throw X.Error("Can not initialize glslang!"),X.Error(r),Error("WebGPU initializations stopped.")}).then(r=>{var s;if(r){this._adapter=r,this._adapterSupportedExtensions=[],(s=this._adapter.features)===null||s===void 0||s.forEach(a=>this._adapterSupportedExtensions.push(a));const n=this._options.deviceDescriptor;if(n!=null&&n.requiredFeatures){const a=n.requiredFeatures,l=[];for(const c of a)this._adapterSupportedExtensions.indexOf(c)!==-1&&l.push(c);n.requiredFeatures=l}return this._adapter.requestDevice(this._options.deviceDescriptor)}else throw"Could not retrieve a WebGPU adapter (adapter is null)."}).then(r=>{var s,n;this._device=r,this._deviceEnabledExtensions=[],(s=this._device.features)===null||s===void 0||s.forEach(l=>this._deviceEnabledExtensions.push(l));let a=-1;this._device.addEventListener("uncapturederror",l=>{++a<this.numMaxUncapturedErrors?X.Warn(`WebGPU uncaptured error (${a+1}): ${l.error} - ${l.error.message}`):a++===this.numMaxUncapturedErrors&&X.Warn(`WebGPU uncaptured error: too many warnings (${this.numMaxUncapturedErrors}), no more warnings will be reported to the console for this engine.`)}),this._doNotHandleContextLost||(n=this._device.lost)===null||n===void 0||n.then(l=>{this._contextWasLost=!0,X.Warn("WebGPU context lost. "+l),this.onContextLostObservable.notifyObservers(this),this._restoreEngineAfterContextLost(this.initAsync.bind(this))})},r=>{X.Error("Could not retrieve a WebGPU device."),X.Error(r)}).then(()=>{this._bufferManager=new ym(this._device),this._textureHelper=new Bi(this._device,this._glslang,this._tintWASM,this._bufferManager),this._cacheSampler=new ic(this._device),this._cacheBindGroups=new ir(this._device,this._cacheSampler,this),this._timestampQuery=new BI(this._device,this._bufferManager),this._occlusionQuery=this._device.createQuerySet?new VI(this,this._device,this._bufferManager):void 0,this._bundleList=new Qd(this._device),this._bundleListRenderTarget=new Qd(this._device),this._snapshotRendering=new kI(this,this._snapshotRenderingMode,this._bundleList,this._bundleListRenderTarget),this._ubInvertY=this._bufferManager.createBuffer(new Float32Array([-1,0]),Mi.Uniform|Mi.CopyDst),this._ubDontInvertY=this._bufferManager.createBuffer(new Float32Array([1,0]),Mi.Uniform|Mi.CopyDst),this.dbgVerboseLogsForFirstFrames&&this._count===void 0&&(this._count=0,console.log("%c frame #"+this._count+" - begin","background: #ffff00")),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._renderTargetEncoder=this._device.createCommandEncoder(this._renderTargetEncoderDescriptor),this._emptyVertexBuffer=new O(this,[0],"",!1,!1,1,!1,0,1),this._initializeLimits(),this._cacheRenderPipeline=new Vo(this._device,this._emptyVertexBuffer,!this._caps.textureFloatLinearFiltering),this._depthCullingState=new OI(this._cacheRenderPipeline),this._stencilStateComposer=new MI(this._cacheRenderPipeline),this._stencilStateComposer.stencilGlobal=this._stencilState,this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=515,this._depthCullingState.depthMask=!0,this._textureHelper.setCommandEncoder(this._uploadEncoder),this._clearQuad=new LI(this._device,this,this._emptyVertexBuffer),this._defaultDrawContext=this.createDrawContext(),this._currentDrawContext=this._defaultDrawContext,this._defaultMaterialContext=this.createMaterialContext(),this._currentMaterialContext=this._defaultMaterialContext,this._initializeContextAndSwapChain(),this._initializeMainAttachments(),this.resize()}).catch(r=>{X.Error("Can not create WebGPU Device and/or context."),X.Error(r),console.trace&&console.trace()})}_initGlslang(e){return e=e||{},e={...vt._GLSLslangDefaultOptions,...e},e.glslang?Promise.resolve(e.glslang):self.glslang?self.glslang(e.wasmPath):e.jsPath&&e.wasmPath?Ar()?J.LoadScriptAsync(e.jsPath).then(()=>self.glslang(e.wasmPath)):(importScripts(e.jsPath),self.glslang(e.wasmPath)):Promise.reject("gslang is not available.")}_initializeLimits(){this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:8192,maxCubemapTextureSize:2048,maxRenderTextureSize:8192,maxVertexAttribs:16,maxVaryingVectors:15,maxFragmentUniformVectors:1024,maxVertexUniformVectors:1024,standardDerivatives:!0,astc:this._deviceEnabledExtensions.indexOf(Jl.TextureCompressionASTC)>=0?!0:void 0,s3tc:this._deviceEnabledExtensions.indexOf(Jl.TextureCompressionBC)>=0?!0:void 0,pvrtc:null,etc1:null,etc2:this._deviceEnabledExtensions.indexOf(Jl.TextureCompressionETC2)>=0?!0:void 0,bptc:this._deviceEnabledExtensions.indexOf(Jl.TextureCompressionBC)>=0?!0:void 0,maxAnisotropy:4,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,textureFloat:!0,textureFloatLinearFiltering:!1,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:typeof BigUint64Array<"u"&&this.enabledExtensions.indexOf(Jl.TimestampQuery)!==-1?!0:void 0,supportOcclusionQuery:typeof BigUint64Array<"u",canUseTimestampForTimerQuery:!0,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!0,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!0,texture2DArrayMaxLayerCount:2048},this._caps.parallelShaderCompile=null,this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!0,trackUbosInFrame:!0,checkUbosContentBeforeUpload:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!0,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!0,supportRenderPasses:!0,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}}_initializeContextAndSwapChain(){this._context=this._canvas.getContext("webgpu"),this._configureContext(),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new Ld],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat}_initializeMainAttachments(){if(!this._bufferManager)return;this.flushFramebuffer(!1),this._mainTextureExtends={width:this.getRenderWidth(),height:this.getRenderHeight(),depthOrArrayLayers:1};const e=new Float32Array([this.getRenderHeight()]);this._bufferManager.setSubData(this._ubInvertY,4,e),this._bufferManager.setSubData(this._ubDontInvertY,4,e);let t;if(this._options.antialias){const s={label:"Texture_MainColor_antialiasing",size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:Tl.E2d,format:this._options.swapChainFormat,usage:Li.RenderAttachment};this._mainTexture&&this._textureHelper.releaseTexture(this._mainTexture),this._mainTexture=this._device.createTexture(s),t=[{view:this._mainTexture.createView(),clearValue:new Ye(0,0,0,1),loadOp:zr.Clear,storeOp:na.Store}]}else t=[{view:void 0,clearValue:new Ye(0,0,0,1),loadOp:zr.Clear,storeOp:na.Store}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?z.Depth24PlusStencil8:z.Depth32Float,this._setDepthTextureFormat(this._mainRenderPassWrapper);const i={label:"Texture_MainDepthStencil",size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:Tl.E2d,format:this._mainRenderPassWrapper.depthTextureFormat,usage:Li.RenderAttachment};this._depthTexture&&this._textureHelper.releaseTexture(this._depthTexture),this._depthTexture=this._device.createTexture(i);const r={view:this._depthTexture.createView(),depthClearValue:this._clearDepthValue,depthLoadOp:zr.Clear,depthStoreOp:na.Store,stencilClearValue:this._clearStencilValue,stencilLoadOp:this.isStencilEnable?zr.Clear:void 0,stencilStoreOp:this.isStencilEnable?na.Store:void 0};this._mainRenderPassWrapper.renderPassDescriptor={colorAttachments:t,depthStencilAttachment:r}}_configureContext(){this._context.configure({device:this._device,format:this._options.swapChainFormat,usage:Li.RenderAttachment|Li.CopySrc,alphaMode:this.premultipliedAlpha?qd.Premultiplied:qd.Opaque})}setSize(e,t,i=!1){return super.setSize(e,t,i)?(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - setSize called -",e,t)),this._initializeMainAttachments(),this.snapshotRendering&&this.snapshotRenderingReset(),!0):!1}_getShaderProcessor(e){return e===Gi.WGSL?this._shaderProcessorWGSL:this._shaderProcessor}_getShaderProcessingContext(e){return new ca(e)}applyStates(){this._stencilStateComposer.apply(),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend)}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._forceEnableEffect=!0,this._currentIndexBuffer=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),e&&(this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=515,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(!1),this.setColorWrite(!0)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}setColorWrite(e){this._colorWriteLocal=e,this._cacheRenderPipeline.setWriteMask(e?15:0)}getColorWrite(){return this._colorWriteLocal}_resetCurrentViewport(e){this._viewportsCurrent[e].x=0,this._viewportsCurrent[e].y=0,this._viewportsCurrent[e].w=0,this._viewportsCurrent[e].h=0,e===1&&(this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0)}_mustUpdateViewport(e){const t=e===this._mainRenderPassWrapper.renderPass?0:1,i=this._viewportCached.x,r=this._viewportCached.y,s=this._viewportCached.z,n=this._viewportCached.w,a=this._viewportsCurrent[t].x!==i||this._viewportsCurrent[t].y!==r||this._viewportsCurrent[t].w!==s||this._viewportsCurrent[t].h!==n;return a&&(this._viewportsCurrent[t].x=this._viewportCached.x,this._viewportsCurrent[t].y=this._viewportCached.y,this._viewportsCurrent[t].w=this._viewportCached.z,this._viewportsCurrent[t].h=this._viewportCached.w),a}_applyViewport(e){let t=Math.floor(this._viewportCached.y);const i=Math.floor(this._viewportCached.w);this._currentRenderTarget||(t=this.getRenderHeight()-t-i),e.setViewport(Math.floor(this._viewportCached.x),t,Math.floor(this._viewportCached.z),i,0,1),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - viewport applied - (",this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w,") current pass is main pass="+(e===this._mainRenderPassWrapper.renderPass)))}_viewport(e,t,i,r){this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=r}_resetCurrentScissor(e){this._scissorsCurrent[e].x=0,this._scissorsCurrent[e].y=0,this._scissorsCurrent[e].w=0,this._scissorsCurrent[e].h=0}_mustUpdateScissor(e){const t=e===this._mainRenderPassWrapper.renderPass?0:1,i=this._scissorCached.x,r=this._scissorCached.y,s=this._scissorCached.z,n=this._scissorCached.w,a=this._scissorsCurrent[t].x!==i||this._scissorsCurrent[t].y!==r||this._scissorsCurrent[t].w!==s||this._scissorsCurrent[t].h!==n;return a&&(this._scissorsCurrent[t].x=this._scissorCached.x,this._scissorsCurrent[t].y=this._scissorCached.y,this._scissorsCurrent[t].w=this._scissorCached.z,this._scissorsCurrent[t].h=this._scissorCached.w),a}_applyScissor(e){e.setScissorRect(this._scissorCached.x,this._currentRenderTarget?this._scissorCached.y:this.getRenderHeight()-this._scissorCached.w-this._scissorCached.y,this._scissorCached.z,this._scissorCached.w),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - scissor applied - (",this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w,") current pass is main pass="+(e===this._mainRenderPassWrapper.renderPass)))}_scissorIsActive(){return this._scissorCached.x!==0||this._scissorCached.y!==0||this._scissorCached.z!==0||this._scissorCached.w!==0}enableScissor(e,t,i,r){this._scissorCached.x=e,this._scissorCached.y=t,this._scissorCached.z=i,this._scissorCached.w=r}disableScissor(){this._scissorCached.x=0,this._scissorCached.y=0,this._scissorCached.z=0,this._scissorCached.w=0,this._resetCurrentScissor(0),this._resetCurrentScissor(1)}_resetCurrentStencilRef(e){this._stencilRefsCurrent[e]=-1}_mustUpdateStencilRef(e){const t=e===this._mainRenderPassWrapper.renderPass?0:1,i=this._stencilStateComposer.funcRef!==this._stencilRefsCurrent[t];return i&&(this._stencilRefsCurrent[t]=this._stencilStateComposer.funcRef),i}_applyStencilRef(e){var t;e.setStencilReference((t=this._stencilStateComposer.funcRef)!==null&&t!==void 0?t:0)}_resetCurrentColorBlend(e){this._blendColorsCurrent[e][0]=this._blendColorsCurrent[e][1]=this._blendColorsCurrent[e][2]=this._blendColorsCurrent[e][3]=null}_mustUpdateBlendColor(e){const t=e===this._mainRenderPassWrapper.renderPass?0:1,i=this._alphaState._blendConstants,r=i[0]!==this._blendColorsCurrent[t][0]||i[1]!==this._blendColorsCurrent[t][1]||i[2]!==this._blendColorsCurrent[t][2]||i[3]!==this._blendColorsCurrent[t][3];return r&&(this._blendColorsCurrent[t][0]=i[0],this._blendColorsCurrent[t][1]=i[1],this._blendColorsCurrent[t][2]=i[2],this._blendColorsCurrent[t][3]=i[3]),r}_applyBlendColor(e){e.setBlendConstant(this._alphaState._blendConstants)}clear(e,t,i,r=!1){e&&e.a===void 0&&(e.a=1);const s=this._scissorIsActive();this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - clear called - backBuffer=",t," depth=",i," stencil=",r," scissor is active=",s)),this._currentRenderTarget?s?(this._rttRenderPassWrapper.renderPass||this._startRenderTargetRenderPass(this._currentRenderTarget,!1,t?e:null,i,r),this.compatibilityMode?this._applyScissor(this._currentRenderPass):this._bundleListRenderTarget.addItem(new jh(this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w)),this._clearFullQuad(t?e:null,i,r)):(this._currentRenderPass&&this._endRenderTargetRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,!0,t?e:null,i,r)):((!this._mainRenderPassWrapper.renderPass||!s)&&this._startMainRenderPass(!s,t?e:null,i,r),s&&(this.compatibilityMode?this._applyScissor(this._currentRenderPass):this._bundleList.addItem(new jh(this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w)),this._clearFullQuad(t?e:null,i,r)))}_clearFullQuad(e,t,i){var r,s,n;const a=this.compatibilityMode?this._getCurrentRenderPass():null,c=this._getCurrentRenderPassIndex()===0?this._bundleList:this._bundleListRenderTarget;this._clearQuad.setColorFormat(this._colorFormat),this._clearQuad.setDepthStencilFormat(this._depthTextureFormat),this._clearQuad.setMRTAttachments((r=this._cacheRenderPipeline.mrtAttachments)!==null&&r!==void 0?r:[],(s=this._cacheRenderPipeline.mrtTextureArray)!==null&&s!==void 0?s:[],this._cacheRenderPipeline.mrtTextureCount),this.compatibilityMode?a.setStencilReference(this._clearStencilValue):c.addItem(new Kh(this._clearStencilValue));const h=this._clearQuad.clear(a,e,t,i,this.currentSampleCount);this.compatibilityMode?this._applyStencilRef(a):(c.addBundle(h),c.addItem(new Kh((n=this._stencilStateComposer.funcRef)!==null&&n!==void 0?n:0)),this._reportDrawCall())}createVertexBuffer(e){let t;return e instanceof Array?t=new Float32Array(e):e instanceof ArrayBuffer?t=new Uint8Array(e):t=e,this._bufferManager.createBuffer(t,Mi.Vertex|Mi.CopyDst)}createDynamicVertexBuffer(e){return this.createVertexBuffer(e)}createIndexBuffer(e){let t=!0,i;e instanceof Uint32Array||e instanceof Int32Array?i=e:e instanceof Uint16Array?(i=e,t=!1):e.length>65535?i=new Uint32Array(e):(i=new Uint16Array(e),t=!1);const r=this._bufferManager.createBuffer(i,Mi.Index|Mi.CopyDst);return r.is32Bits=t,r}_createBuffer(e,t){let i;e instanceof Array?i=new Float32Array(e):e instanceof ArrayBuffer?i=new Uint8Array(e):i=e;let r=0;return t&1&&(r|=Mi.CopySrc),t&2&&(r|=Mi.CopyDst),t&4&&(r|=Mi.Uniform),t&8&&(r|=Mi.Vertex),t&16&&(r|=Mi.Index),t&32&&(r|=Mi.Storage),this._bufferManager.createBuffer(i,r)}bindBuffersDirectly(){throw"Not implemented on WebGPU"}updateAndBindInstancesBuffer(){throw"Not implemented on WebGPU"}bindBuffers(e,t,i,r){this._currentIndexBuffer=t,this._currentOverrideVertexBuffers=r??null,this._cacheRenderPipeline.setBuffers(e,t,this._currentOverrideVertexBuffers)}_releaseBuffer(e){return this._bufferManager.releaseBuffer(e)}createEffect(e,t,i,r,s,n,a,l,c,h=Gi.GLSL){var u;const d=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,f=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,_=this._getGlobalDefines();let p=(u=s??t.defines)!==null&&u!==void 0?u:"";_&&(p+=`
`+_);const m=d+"+"+f+"@"+p;if(this._compiledEffects[m]){const b=this._compiledEffects[m];return a&&b.isReady()&&a(b),b}const T=new ri(e,t,i,r,this,s,n,a,l,c,m,h);return this._compiledEffects[m]=T,T}_compileRawShaderToSpirV(e,t){return this._glslang.compileGLSL(e,t)}_compileShaderToSpirV(e,t,i,r){return this._compileRawShaderToSpirV(r+(i?i+`
`:"")+e,t)}_getWGSLShader(e,t,i){return i?i="//"+i.split(`
`).join(`
//`)+`
`:i="",i+e}_createPipelineStageDescriptor(e,t,i){return this._tintWASM&&i===Gi.GLSL&&(e=this._tintWASM.convertSpirV2WGSL(e),t=this._tintWASM.convertSpirV2WGSL(t)),{vertexStage:{module:this._device.createShaderModule({code:e}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({code:t}),entryPoint:"main"}}}_compileRawPipelineStageDescriptor(e,t,i){const r=i===Gi.GLSL?this._compileRawShaderToSpirV(e,"vertex"):e,s=i===Gi.GLSL?this._compileRawShaderToSpirV(t,"fragment"):t;return this._createPipelineStageDescriptor(r,s,i)}_compilePipelineStageDescriptor(e,t,i,r){this.onBeforeShaderCompilationObservable.notifyObservers(this);const s=`#version 450
`,n=r===Gi.GLSL?this._compileShaderToSpirV(e,"vertex",i,s):this._getWGSLShader(e,"vertex",i),a=r===Gi.GLSL?this._compileShaderToSpirV(t,"fragment",i,s):this._getWGSLShader(t,"fragment",i),l=this._createPipelineStageDescriptor(n,a,r);return this.onAfterShaderCompilationObservable.notifyObservers(this),l}createRawShaderProgram(){throw"Not available on WebGPU"}createShaderProgram(){throw"Not available on WebGPU"}inlineShaderCode(e){const t=new ac(e);return t.debug=!1,t.processCode(),t.code}createPipelineContext(e){return new MR(e,this)}createMaterialContext(){return new kf}createDrawContext(){return new Gf(this._bufferManager)}_preparePipelineContext(e,t,i,r,s,n,a,l){const c=e,h=c.shaderProcessingContext.shaderLanguage;this.dbgShowShaderCode&&(console.log(l),console.log(t),console.log(i),console.log("***********************************************")),c.sources={fragment:i,vertex:t,rawVertex:s,rawFragment:n},r?c.stages=this._compileRawPipelineStageDescriptor(t,i,h):c.stages=this._compilePipelineStageDescriptor(t,i,l,h)}getAttributes(e,t){const i=new Array(t.length),r=e;for(let s=0;s<t.length;s++){const n=t[s],a=r.shaderProcessingContext.availableAttributes[n];a!==void 0&&(i[s]=a)}return i}enableEffect(e){if(!e)return;let t=!0;if(!vs.IsWrapper(e))t=e!==this._currentEffect,this._currentEffect=e,this._currentMaterialContext=this._defaultMaterialContext,this._currentDrawContext=this._defaultDrawContext,this._counters.numEnableEffects++,this.dbgLogIfNotDrawWrapper&&X.Warn(`enableEffect has been called with an Effect and not a Wrapper! effect.uniqueId=${e.uniqueId}, effect.name=${e.name}, effect.name.vertex=${e.name.vertex}, effect.name.fragment=${e.name.fragment}`,10);else if(!e.effect||e.effect===this._currentEffect&&e.materialContext===this._currentMaterialContext&&e.drawContext===this._currentDrawContext&&!this._forceEnableEffect){if(!e.effect&&this.dbgShowEmptyEnableEffectCalls)throw console.error("drawWrapper=",e),"Invalid call to enableEffect: the effect property is empty!";return}else if(t=e.effect!==this._currentEffect,this._currentEffect=e.effect,this._currentMaterialContext=e.materialContext,this._currentDrawContext=e.drawContext,this._counters.numEnableDrawWrapper++,!this._currentMaterialContext)throw console.error("drawWrapper=",e),"Invalid call to enableEffect: the materialContext property is empty!";this._stencilStateComposer.stencilMaterial=void 0,this._forceEnableEffect=t||this._forceEnableEffect?!1:this._forceEnableEffect,t&&(this._currentEffect.onBind&&this._currentEffect.onBind(this._currentEffect),this._currentEffect._onBindObservable&&this._currentEffect._onBindObservable.notifyObservers(this._currentEffect))}_releaseEffect(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],this._deletePipelineContext(e.getPipelineContext()))}releaseEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}_deletePipelineContext(e){e&&e.dispose()}get needPOTTextures(){return!1}_createHardwareTexture(){return new Ld}_releaseTexture(e){const t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),this._textureHelper.releaseTexture(e)}_getRGBABufferInternalSizedFormat(){return 5}updateTextureComparisonFunction(e,t){e._comparisonFunction=t}_createInternalTexture(e,t,i=!0,r=bt.Unknown){var s,n,a;const l={};t!==void 0&&typeof t=="object"?(l.generateMipMaps=t.generateMipMaps,l.type=t.type===void 0?0:t.type,l.samplingMode=t.samplingMode===void 0?3:t.samplingMode,l.format=t.format===void 0?5:t.format,l.samples=(s=t.samples)!==null&&s!==void 0?s:1,l.creationFlags=(n=t.creationFlags)!==null&&n!==void 0?n:0,l.useSRGBBuffer=(a=t.useSRGBBuffer)!==null&&a!==void 0?a:!1):(l.generateMipMaps=t,l.type=0,l.samplingMode=3,l.format=5,l.samples=1,l.creationFlags=0,l.useSRGBBuffer=!1),(l.type===1&&!this._caps.textureFloatLinearFiltering||l.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l.samplingMode=1),l.type===1&&!this._caps.textureFloat&&(l.type=0,X.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const c=new hi(this,r),h=e.width||e,u=e.height||e,d=e.layers||0;return c.baseWidth=h,c.baseHeight=u,c.width=h,c.height=u,c.depth=d,c.isReady=!0,c.samples=l.samples,c.generateMipMaps=!!l.generateMipMaps,c.samplingMode=l.samplingMode,c.type=l.type,c.format=l.format,c.is2DArray=d>0,c._cachedWrapU=0,c._cachedWrapV=0,c._useSRGBBuffer=l.useSRGBBuffer,this._internalTexturesCache.push(c),i||this._textureHelper.createGPUTextureForInternalTexture(c,h,u,d||1,l.creationFlags),c}createTexture(e,t,i,r,s=3,n=null,a=null,l=null,c=null,h=null,u=null,d,f,_,p){return this._createTextureBase(e,t,i,r,s,n,a,(m,T,b,y,S,C,I,P)=>{var D;const w=y;if(m.baseWidth=w.width,m.baseHeight=w.height,m.width=w.width,m.height=w.height,m.format=h??-1,P(m.width,m.height,w,T,m,()=>{}),!((D=m._hardwareTexture)===null||D===void 0)&&D.underlyingResource)!C&&!I&&this._generateMipmaps(m,this._uploadEncoder);else{const L=this._textureHelper.createGPUTextureForInternalTexture(m,w.width,w.height,void 0,_);Bi.IsImageBitmap(w)&&(this._textureHelper.updateTexture(w,m,w.width,w.height,m.depth,L.format,0,0,S,!1,0,0),!C&&!I&&this._generateMipmaps(m,this._uploadEncoder))}b&&b.removePendingData(m),m.isReady=!0,m.onLoadedObservable.notifyObservers(m),m.onLoadedObservable.clear()},()=>!1,l,c,h,u,d,f,p)}wrapWebGPUTexture(e){const t=new Ld(e),i=new hi(this,bt.Unknown,!0);return i._hardwareTexture=t,i.isReady=!0,i}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapWebGPUTexture instead.")}generateMipMapsForCubemap(e){var t;e.generateMipMaps&&(!((t=e._hardwareTexture)===null||t===void 0)&&t.underlyingResource||this._textureHelper.createGPUTextureForInternalTexture(e),this._generateMipmaps(e,e.source===bt.RenderTarget||e.source===bt.MultiRenderTarget?this._renderTargetEncoder:void 0))}updateTextureSamplingMode(e,t,i=!1){i&&(t.generateMipMaps=!0,this._generateMipmaps(t)),t.samplingMode=e}updateTextureWrappingMode(e,t,i=null,r=null){t!==null&&(e._cachedWrapU=t),i!==null&&(e._cachedWrapV=i),(e.is2DArray||e.is3D)&&r!==null&&(e._cachedWrapR=r)}updateTextureDimensions(e,t,i,r=1){if(!e._hardwareTexture||e.width===t&&e.height===i&&e.depth===r)return;const s=e._hardwareTexture.textureAdditionalUsages;e._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(e,t,i,r,s)}_setInternalTexture(e,t,i){if(i=i??e,this._currentEffect){const s=this._currentEffect._pipelineContext.shaderProcessingContext.availableTextures[i];if(this._currentMaterialContext.setTexture(e,t),s&&s.autoBindSampler){const n=i+ki.AutoSamplerSuffix;this._currentMaterialContext.setSampler(n,t)}}}setTexture(e,t,i,r){this._setTexture(e,i,!1,!1,r,r)}setTextureArray(e,t,i,r){for(let s=0;s<i.length;s++)this._setTexture(-1,i[s],!0,!1,r+s.toString(),r)}_setTexture(e,t,i=!1,r=!1,s="",n){if(n=n??s,this._currentEffect){if(!t)return this._currentMaterialContext.setTexture(s,null),!1;if(t.video)t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;let a=null;if(r?a=t.depthStencilTexture:t.isReady()?a=t.getInternalTexture():t.isCube?a=this.emptyCubeTexture:t.is3D?a=this.emptyTexture3D:t.is2DArray?a=this.emptyTexture2DArray:a=this.emptyTexture,a&&!a.isMultiview){if(a.isCube&&a._cachedCoordinatesMode!==t.coordinatesMode){a._cachedCoordinatesMode=t.coordinatesMode;const l=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=l,t.wrapV=l}a._cachedWrapU=t.wrapU,a._cachedWrapV=t.wrapV,a.is3D&&(a._cachedWrapR=t.wrapR),this._setAnisotropicLevel(0,a,t.anisotropicFilteringLevel)}this._setInternalTexture(s,a,n)}else this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",t));return!0}_setAnisotropicLevel(e,t,i){t._cachedAnisotropicFilteringLevel!==i&&(t._cachedAnisotropicFilteringLevel=Math.min(i,this._caps.maxAnisotropy))}_bindTexture(e,t,i){e!==void 0&&this._setInternalTexture(i,t)}generateMipmaps(e){this._generateMipmaps(e,this._renderTargetEncoder)}_generateMipmaps(e,t){const i=e._hardwareTexture;if(!i)return;t=t??(this._currentRenderTarget&&!this._currentRenderPass?this._renderTargetEncoder:this._currentRenderPass?this._uploadEncoder:this._renderEncoder);const r=e._hardwareTexture.format,s=Bi.ComputeNumMipmapLevels(e.width,e.height);this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - generate mipmaps called - width=",e.width,"height=",e.height,"isCube=",e.isCube)),e.isCube?this._textureHelper.generateCubeMipmaps(i,r,s,t):this._textureHelper.generateMipmaps(i,r,s,0,t)}updateTextureData(e,t,i,r,s,n,a=0,l=0,c=!1){var h;let u=e._hardwareTexture;!((h=e._hardwareTexture)===null||h===void 0)&&h.underlyingResource||(u=this._textureHelper.createGPUTextureForInternalTexture(e));const d=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(d,e,s,n,e.depth,u.format,a,l,e.invertY,!1,i,r),c&&this._generateMipmaps(e,this._renderTargetEncoder)}_uploadCompressedDataToTextureDirectly(e,t,i,r,s,n=0,a=0){var l;let c=e._hardwareTexture;!((l=e._hardwareTexture)===null||l===void 0)&&l.underlyingResource||(e.format=t,c=this._textureHelper.createGPUTextureForInternalTexture(e,i,r));const h=new Uint8Array(s.buffer,s.byteOffset,s.byteLength);this._textureHelper.updateTexture(h,e,i,r,e.depth,c.format,n,a,!1,!1,0,0)}_uploadDataToTextureDirectly(e,t,i=0,r=0,s,n=!1){var a;const l=Math.round(Math.log(e.width)*Math.LOG2E),c=Math.round(Math.log(e.height)*Math.LOG2E),h=n?e.width:Math.pow(2,Math.max(l-r,0)),u=n?e.height:Math.pow(2,Math.max(c-r,0));let d=e._hardwareTexture;!((a=e._hardwareTexture)===null||a===void 0)&&a.underlyingResource||(d=this._textureHelper.createGPUTextureForInternalTexture(e,h,u));const f=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(f,e,h,u,e.depth,d.format,i,r,e.invertY,!1,0,0)}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){this._uploadDataToTextureDirectly(e,t,i,r)}_uploadImageToTexture(e,t,i=0,r=0){var s;let n=e._hardwareTexture;if(!((s=e._hardwareTexture)===null||s===void 0)&&s.underlyingResource||(n=this._textureHelper.createGPUTextureForInternalTexture(e)),t instanceof HTMLImageElement)throw"WebGPU engine: HTMLImageElement not supported in _uploadImageToTexture!";const a=t,l=Math.ceil(e.width/(1<<r)),c=Math.ceil(e.height/(1<<r));this._textureHelper.updateTexture(a,e,l,c,e.depth,n.format,i,r,e.invertY,!1,0,0)}readPixels(e,t,i,r,s=!0,n=!0){const l=(this._rttRenderPassWrapper.renderPass?this._rttRenderPassWrapper:this._mainRenderPassWrapper).colorAttachmentGPUTextures[0];if(!l)return Promise.resolve(new Uint8Array(0));const c=l.underlyingResource,h=l.format;return c?(n&&this.flushFramebuffer(),this._textureHelper.readPixels(c,e,t,i,r,h)):Promise.resolve(new Uint8Array(0))}beginFrame(){super.beginFrame()}endFrame(){if(this._snapshotRendering.endFrame(this._mainRenderPassWrapper.renderPass),this._endMainRenderPass(),this._timestampQuery.endFrame(this._renderEncoder),this.flushFramebuffer(!1),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - counters")),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const e=[];for(const t in $e._UpdatedUbosInFrame)e.push(t+":"+$e._UpdatedUbosInFrame[t]);console.log("frame #"+this._count+" - updated ubos -",e.join(", "))}$e._UpdatedUbosInFrame={}}this.countersLastFrame.numEnableEffects=this._counters.numEnableEffects,this.countersLastFrame.numEnableDrawWrapper=this._counters.numEnableDrawWrapper,this.countersLastFrame.numBundleCreationNonCompatMode=this._counters.numBundleCreationNonCompatMode,this.countersLastFrame.numBundleReuseNonCompatMode=this._counters.numBundleReuseNonCompatMode,this._counters.numEnableEffects=0,this._counters.numEnableDrawWrapper=0,this._counters.numBundleCreationNonCompatMode=0,this._counters.numBundleReuseNonCompatMode=0,this._cacheRenderPipeline.endFrame(),this._cacheBindGroups.endFrame(),this._pendingDebugCommands.length=0,super.endFrame(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - end","background: #ffff00"),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - begin","background: #ffff00")))}flushFramebuffer(e=!0){const t=!this._currentRenderPass;let i=0;this._currentRenderPass&&this._currentRenderTarget&&(i|=1,this._endRenderTargetRenderPass()),this._mainRenderPassWrapper.renderPass&&(i|=2,this._endMainRenderPass()),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderTargetEncoder.finish(),this._commandBuffers[2]=this._renderEncoder.finish(),this._device.queue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._renderTargetEncoder=this._device.createCommandEncoder(this._renderTargetEncoderDescriptor),this._timestampQuery.startFrame(this._uploadEncoder),this._textureHelper.setCommandEncoder(this._uploadEncoder),this._bundleList.reset(),this._bundleListRenderTarget.reset(),e&&(i&2&&this._startMainRenderPass(!1),i&1&&this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1),t&&this._currentRenderTarget&&(this._currentRenderPass=null))}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentRenderTarget===null}_startRenderTargetRenderPass(e,t,i,r,s){var n,a,l;const c=e,h=c._depthStencilTexture,u=h==null?void 0:h._hardwareTexture,d=u==null?void 0:u.underlyingResource,f=u==null?void 0:u.msaaTexture,_=d==null?void 0:d.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),p=f==null?void 0:f.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),m=u?Bi.HasStencilAspect(u.format):!1,T=[];this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const b=t&&i,y=t&&r,S=t&&s;if(c._attachments&&c.isMulti){(!this._mrtAttachments||this._mrtAttachments.length===0)&&(this._mrtAttachments=c._defaultAttachments);for(let C=0;C<this._mrtAttachments.length;++C){const I=this._mrtAttachments[C],P=c.textures[C],D=P==null?void 0:P._hardwareTexture,w=D==null?void 0:D.underlyingResource;if(D&&w){const L={...this._rttRenderPassWrapper.colorAttachmentViewDescriptor,format:D.format},U=D.msaaTexture,G=w.createView(L),Z=U==null?void 0:U.createView(L);T.push({view:Z||G,resolveTarget:U?G:void 0,clearValue:I!==0&&b?i:void 0,loadOp:I!==0&&b?zr.Clear:zr.Load,storeOp:na.Store})}}this._cacheRenderPipeline.setMRT(c.textures,this._mrtAttachments.length),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}else{const C=c.texture;if(C){const I=C._hardwareTexture,P=I.underlyingResource,D=I.msaaTexture,w=P.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),L=D==null?void 0:D.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor);T.push({view:L||w,resolveTarget:D?w:void 0,clearValue:b?i:void 0,loadOp:b?zr.Clear:zr.Load,storeOp:na.Store})}else T.push(null)}if((n=this._debugPushGroup)===null||n===void 0||n.call(this,"render target pass",1),this._rttRenderPassWrapper.renderPassDescriptor={colorAttachments:T,depthStencilAttachment:h&&d?{view:p||_,depthClearValue:y?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,depthLoadOp:y?zr.Clear:zr.Load,depthStoreOp:na.Store,stencilClearValue:c._depthStencilTextureWithStencil&&S?this._clearStencilValue:void 0,stencilLoadOp:m?c._depthStencilTextureWithStencil&&S?zr.Clear:zr.Load:void 0,stencilStoreOp:m?na.Store:void 0}:void 0,occlusionQuerySet:!((a=this._occlusionQuery)===null||a===void 0)&&a.hasQueries?this._occlusionQuery.querySet:void 0},this._rttRenderPassWrapper.renderPass=this._renderTargetEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const C=c.texture;console.log("frame #"+this._count+" - render target begin pass - internalTexture.uniqueId=",C.uniqueId,"width=",C.width,"height=",C.height,this._rttRenderPassWrapper.renderPassDescriptor)}this._currentRenderPass=this._rttRenderPassWrapper.renderPass,(l=this._debugFlushPendingCommands)===null||l===void 0||l.call(this),this._resetCurrentViewport(1),this._resetCurrentScissor(1),this._resetCurrentStencilRef(1),this._resetCurrentColorBlend(1),(!u||!Bi.HasStencilAspect(u.format))&&(this._stencilStateComposer.enabled=!1)}_endRenderTargetRenderPass(){var e,t,i,r;if(this._currentRenderPass){const s=(e=this._currentRenderTarget.texture)===null||e===void 0?void 0:e._hardwareTexture;s&&!this._snapshotRendering.endRenderTargetPass(this._currentRenderPass,s)&&!this.compatibilityMode&&(this._bundleListRenderTarget.run(this._currentRenderPass),this._bundleListRenderTarget.reset()),this._currentRenderPass.end(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - render target end pass - internalTexture.uniqueId=",(i=(t=this._currentRenderTarget)===null||t===void 0?void 0:t.texture)===null||i===void 0?void 0:i.uniqueId)),(r=this._debugPopGroup)===null||r===void 0||r.call(this,1),this._resetCurrentViewport(1),this._resetCurrentScissor(1),this._resetCurrentStencilRef(1),this._resetCurrentColorBlend(1),this._currentRenderPass=null,this._rttRenderPassWrapper.reset()}}_getCurrentRenderPass(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1):this._currentRenderPass||this._startMainRenderPass(!1),this._currentRenderPass}_getCurrentRenderPassIndex(){return this._currentRenderPass===null?-1:this._currentRenderPass===this._mainRenderPassWrapper.renderPass?0:1}_startMainRenderPass(e,t,i,r){var s,n,a;this._mainRenderPassWrapper.renderPass&&this.flushFramebuffer(!1),this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const l=e&&t,c=e&&i,h=e&&r;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].clearValue=l?t:void 0,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadOp=l?zr.Clear:zr.Load,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthClearValue=c?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadOp=c?zr.Clear:zr.Load,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilClearValue=h?this._clearStencilValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadOp=this.isStencilEnable?h?zr.Clear:zr.Load:void 0,this._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet=!((s=this._occlusionQuery)===null||s===void 0)&&s.hasQueries?this._occlusionQuery.querySet:void 0;const u=this._context.getCurrentTexture();this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(u),this._options.antialias?this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=u.createView():this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].view=u.createView(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height,this._mainRenderPassWrapper.renderPassDescriptor)),(n=this._debugPushGroup)===null||n===void 0||n.call(this,"main pass",0),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._mainRenderPassWrapper.renderPass=this._currentRenderPass,(a=this._debugFlushPendingCommands)===null||a===void 0||a.call(this),this._resetCurrentViewport(0),this._resetCurrentScissor(0),this._resetCurrentStencilRef(0),this._resetCurrentColorBlend(0),this._isStencilEnable||(this._stencilStateComposer.enabled=!1)}_endMainRenderPass(){var e;this._mainRenderPassWrapper.renderPass!==null&&(this._snapshotRendering.endMainRenderPass(),!this.compatibilityMode&&!this._snapshotRendering.play&&(this._bundleList.run(this._mainRenderPassWrapper.renderPass),this._bundleList.reset()),this._mainRenderPassWrapper.renderPass.end(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - main end pass")),(e=this._debugPopGroup)===null||e===void 0||e.call(this,0),this._resetCurrentViewport(0),this._resetCurrentScissor(0),this._resetCurrentStencilRef(0),this._resetCurrentColorBlend(0),this._mainRenderPassWrapper.renderPass===this._currentRenderPass&&(this._currentRenderPass=null),this._mainRenderPassWrapper.reset(!1))}bindFramebuffer(e,t=0,i,r,s,n=0,a=0){var l,c;const h=(l=e.texture)===null||l===void 0?void 0:l._hardwareTexture;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,h&&(h._currentLayer=e.isCube?a*6+t:a),this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=h,this._rttRenderPassWrapper.depthTextureFormat=this._currentRenderTarget._depthStencilTexture?Bi.GetWebGPUTextureFormat(-1,this._currentRenderTarget._depthStencilTexture.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={format:this._colorFormat,dimension:Ai.E2d,mipLevelCount:1,baseArrayLayer:e.isCube?a*6+t:a,baseMipLevel:n,arrayLayerCount:1,aspect:ho.All},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={format:this._depthTextureFormat,dimension:Ai.E2d,mipLevelCount:1,baseArrayLayer:e.isCube?a*6+t:a,baseMipLevel:0,arrayLayerCount:1,aspect:ho.All},this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - bindFramebuffer called - internalTexture.uniqueId=",(c=e.texture)===null||c===void 0?void 0:c.uniqueId,"face=",t,"lodLevel=",n,"layer=",a,this._rttRenderPassWrapper.colorAttachmentViewDescriptor,this._rttRenderPassWrapper.depthAttachmentViewDescriptor)),this._currentRenderPass=null,this.snapshotRendering&&this.snapshotRenderingMode===1&&this._getCurrentRenderPass(),this._cachedViewport&&!s?this.setViewport(this._cachedViewport,i,r):(i||(i=e.width,n&&(i=i/Math.pow(2,n))),r||(r=e.height,n&&(r=r/Math.pow(2,n))),this._viewport(0,0,i,r)),this.wipeCaches()}unBindFramebuffer(e,t=!1,i){var r,s;const n=this._currentRenderTarget;this._currentRenderTarget=null,i&&i(),this._currentRenderTarget=n,this._currentRenderPass&&this._currentRenderPass!==this._mainRenderPassWrapper.renderPass&&this._endRenderTargetRenderPass(),!((r=e.texture)===null||r===void 0)&&r.generateMipMaps&&!t&&!e.isCube&&this._generateMipmaps(e.texture),this._currentRenderTarget=null,this._onAfterUnbindFrameBufferObservable.notifyObservers(this),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - unBindFramebuffer called - internalTexture.uniqueId=",(s=e.texture)===null||s===void 0?void 0:s.uniqueId)),this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments),this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):(this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)),this._currentRenderPass&&this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_setColorFormat(e){var t,i;const r=(i=(t=e.colorAttachmentGPUTextures[0])===null||t===void 0?void 0:t.format)!==null&&i!==void 0?i:null;this._cacheRenderPipeline.setColorFormat(r),this._colorFormat!==r&&(this._colorFormat=r)}_setDepthTextureFormat(e){this._cacheRenderPipeline.setDepthStencilFormat(e.depthTextureFormat),this._depthTextureFormat!==e.depthTextureFormat&&(this._depthTextureFormat=e.depthTextureFormat)}setDitheringState(){}setRasterizerState(){}setState(e,t=0,i,r=!1,s,n,a=0){var l,c;(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);const h=!((c=(l=this.cullBackFaces)!==null&&l!==void 0?l:s)!==null&&c!==void 0)||c?1:2;(this._depthCullingState.cullFace!==h||i)&&(this._depthCullingState.cullFace=h),this.setZOffset(t),this.setZOffsetUnits(a);const u=r?this._currentRenderTarget?1:2:this._currentRenderTarget?2:1;(this._depthCullingState.frontFace!==u||i)&&(this._depthCullingState.frontFace=u),this._stencilStateComposer.stencilMaterial=n}_applyRenderPassChanges(e,t){var i;const r=this._mustUpdateViewport(e),s=this._mustUpdateScissor(e),n=this._stencilStateComposer.enabled?this._mustUpdateStencilRef(e):!1,a=this._alphaState.alphaBlend?this._mustUpdateBlendColor(e):!1;t?(r&&t.addItem(new Cm(this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w)),s&&t.addItem(new jh(this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w)),n&&t.addItem(new Kh((i=this._stencilStateComposer.funcRef)!==null&&i!==void 0?i:0)),a&&t.addItem(new Am(this._alphaState._blendConstants.slice()))):(r&&this._applyViewport(e),s&&this._applyScissor(e),n&&this._applyStencilRef(e),a&&this._applyBlendColor(e))}_draw(e,t,i,r,s){var n;const a=this._getCurrentRenderPass(),c=this._getCurrentRenderPassIndex()===0?this._bundleList:this._bundleListRenderTarget;this.applyStates();const h=this._currentEffect._pipelineContext;if(this.bindUniformBufferBase(this._currentRenderTarget?this._ubInvertY:this._ubDontInvertY,0,ki.InternalsUBOName),h.uniformBuffer&&(h.uniformBuffer.update(),this.bindUniformBufferBase(h.uniformBuffer.getBuffer(),0,ki.LeftOvertUBOName)),this._snapshotRendering.play){this._reportDrawCall();return}!this.compatibilityMode&&(this._currentDrawContext.isDirty(this._currentMaterialContext.updateId)||this._currentMaterialContext.isDirty||this._currentMaterialContext.forceBindGroupCreation)&&(this._currentDrawContext.fastBundle=void 0);const u=!this.compatibilityMode&&this._currentDrawContext.fastBundle;let d=a;if(u||this._snapshotRendering.record){if(this._applyRenderPassChanges(a,c),!this._snapshotRendering.record){this._counters.numBundleReuseNonCompatMode++,this._currentDrawContext.indirectDrawBuffer&&this._currentDrawContext.setIndirectData(r,s||1,i),c.addBundle(this._currentDrawContext.fastBundle),this._reportDrawCall();return}d=c.getBundleEncoder(this._cacheRenderPipeline.colorFormats,this._depthTextureFormat,this.currentSampleCount),c.numDrawCalls++}let f=0;if(!this._caps.textureFloatLinearFiltering&&this._currentMaterialContext.hasFloatTextures){let b=1;for(let y=0;y<h.shaderProcessingContext.textureNames.length;++y){const S=h.shaderProcessingContext.textureNames[y],C=(n=this._currentMaterialContext.textures[S])===null||n===void 0?void 0:n.texture;(C==null?void 0:C.type)===1&&(f|=b),b=b<<1}}const _=this._cacheRenderPipeline.getRenderPipeline(t,this._currentEffect,this.currentSampleCount,f),p=this._cacheBindGroups.getBindGroups(h,this._currentDrawContext,this._currentMaterialContext);this._snapshotRendering.record||(this._applyRenderPassChanges(a,this.compatibilityMode?null:c),this.compatibilityMode||(this._counters.numBundleCreationNonCompatMode++,d=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:this.currentSampleCount}))),d.setPipeline(_),this._currentIndexBuffer&&d.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?Nl.Uint32:Nl.Uint16,0);const m=this._cacheRenderPipeline.vertexBuffers;for(let b=0;b<m.length;b++){const y=m[b],S=y.getBuffer();S&&d.setVertexBuffer(b,S.underlyingResource,y._validOffsetRange?0:y.byteOffset)}for(let b=0;b<p.length;b++)d.setBindGroup(b,p[b]);const T=!this.compatibilityMode&&!this._snapshotRendering.record;T&&this._currentDrawContext.indirectDrawBuffer?(this._currentDrawContext.setIndirectData(r,s||1,i),e===0?d.drawIndexedIndirect(this._currentDrawContext.indirectDrawBuffer,0):d.drawIndirect(this._currentDrawContext.indirectDrawBuffer,0)):e===0?d.drawIndexed(r,s||1,i,0,0):d.draw(r,s||1,i,0),T&&(this._currentDrawContext.fastBundle=d.finish(),c.addBundle(this._currentDrawContext.fastBundle)),this._reportDrawCall()}drawElementsType(e,t,i,r=1){this._draw(0,e,t,i,r)}drawArraysType(e,t,i,r=1){this._currentIndexBuffer=null,this._draw(1,e,t,i,r)}dispose(){var e,t;(e=this._mainTexture)===null||e===void 0||e.destroy(),(t=this._depthTexture)===null||t===void 0||t.destroy(),super.dispose()}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._canvas.width}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._canvas.height}getRenderingCanvas(){return this._canvas}getError(){return 0}bindSamplers(){}_bindTextureDirectly(){return!1}areAllEffectsReady(){return!0}_executeWhenRenderingStateIsCompiled(e,t){t()}_isRenderingStateCompiled(){return!0}_getUnpackAlignement(){return 1}_unpackFlipY(){}_bindUnboundFramebuffer(){throw"_bindUnboundFramebuffer is not implementedin WebGPU! You probably want to use restoreDefaultFramebuffer or unBindFramebuffer instead"}_getSamplingParameters(){throw"_getSamplingParameters is not available in WebGPU"}getUniforms(){return[]}setIntArray(){return!1}setIntArray2(){return!1}setIntArray3(){return!1}setIntArray4(){return!1}setArray(){return!1}setArray2(){return!1}setArray3(){return!1}setArray4(){return!1}setMatrices(){return!1}setMatrix3x3(){return!1}setMatrix2x2(){return!1}setFloat(){return!1}setFloat2(){return!1}setFloat3(){return!1}setFloat4(){return!1}}vt._GLSLslangDefaultOptions={jsPath:"https://preview.babylonjs.com/glslang/glslang.js",wasmPath:"https://preview.babylonjs.com/glslang/glslang.wasm"};vt.UseTWGSL=!0;vt.prototype.setAlphaMode=function(o,e=!1){if(this._alphaMode===o&&(o===0&&!this._alphaState.alphaBlend||o!==0&&this._alphaState.alphaBlend)){if(!e){const t=o===0;this.depthCullingState.depthMask!==t&&(this.setDepthWrite(t),this._cacheRenderPipeline.setDepthWriteEnabled(t))}return}switch(o){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,1),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,1),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(1,1,0,1),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(770,1,0,1),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(0,769,1,1),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(774,0,1,1),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(770,769,1,1),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(32769,32770,32771,32772),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(1,769,1,771),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,1),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(772,1,0,0),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(775,769,773,771),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,0),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(775,769,0,1),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,771),this._alphaState.alphaBlend=!0;break}e||(this.setDepthWrite(o===q.ALPHA_DISABLE),this._cacheRenderPipeline.setDepthWriteEnabled(o===q.ALPHA_DISABLE)),this._alphaMode=o,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};vt.prototype.setAlphaEquation=function(o){q.prototype.setAlphaEquation.call(this,o),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};class zf{getBindGroups(e,t,i){if(!i)throw new Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(this._bindGroups.length===0){const r=this._bindGroupEntries.length>0;for(const s in e){const n=e[s],a=i[s],l=a.group,c=a.binding,h=n.type,u=n.object;let d=n.indexInGroupEntries,f=this._bindGroupEntries[l];switch(f||(f=this._bindGroupEntries[l]=[]),h){case ur.Sampler:{const _=u;d!==void 0&&r?f[d].resource=this._cacheSampler.getSampler(_):(n.indexInGroupEntries=f.length,f.push({binding:c,resource:this._cacheSampler.getSampler(_)}));break}case ur.Texture:case ur.TextureWithoutSampler:{const _=u,p=_._texture._hardwareTexture;d!==void 0&&r?(h===ur.Texture&&(f[d++].resource=this._cacheSampler.getSampler(_._texture)),f[d].resource=p.view):(n.indexInGroupEntries=f.length,h===ur.Texture&&f.push({binding:c-1,resource:this._cacheSampler.getSampler(_._texture)}),f.push({binding:c,resource:p.view}));break}case ur.StorageTexture:{const _=u,p=_._texture._hardwareTexture;p.textureAdditionalUsages&Li.StorageBinding||X.Error(`computeDispatch: The texture (name=${_.name}, uniqueId=${_.uniqueId}) is not a storage texture!`,50),d!==void 0&&r?f[d].resource=p.viewForWriting:(n.indexInGroupEntries=f.length,f.push({binding:c,resource:p.viewForWriting}));break}case ur.UniformBuffer:case ur.StorageBuffer:{const p=(h===ur.UniformBuffer,u).getBuffer(),m=p.underlyingResource;d!==void 0&&r?(f[d].resource.buffer=m,f[d].resource.size=p.capacity):(n.indexInGroupEntries=f.length,f.push({binding:c,resource:{buffer:m,offset:0,size:p.capacity}}));break}}}for(let s=0;s<this._bindGroupEntries.length;++s){const n=this._bindGroupEntries[s];if(!n){this._bindGroups[s]=void 0;continue}this._bindGroups[s]=this._device.createBindGroup({layout:t.getBindGroupLayout(s),entries:n})}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups}constructor(e,t){this._device=e,this._cacheSampler=t,this.uniqueId=zf._Counter++,this._bindGroupEntries=[],this.clear()}clear(){this._bindGroups=[]}}zf._Counter=0;class GI{get isAsync(){return!1}get isReady(){return!!this.stage}constructor(e){this._name="unnamed",this.engine=e}_getComputeShaderCode(){var e;return(e=this.sources)===null||e===void 0?void 0:e.compute}dispose(){}}vt.prototype.createComputeContext=function(){return new zf(this._device,this._cacheSampler)};vt.prototype.createComputeEffect=function(o,e){const i=(o.computeElement||o.compute||o.computeToken||o.computeSource||o)+"@"+e.defines;if(this._compiledComputeEffects[i]){const s=this._compiledComputeEffects[i];return e.onCompiled&&s.isReady()&&e.onCompiled(s),s}const r=new lh(o,e,this,i);return this._compiledComputeEffects[i]=r,r};vt.prototype.createComputePipelineContext=function(){return new GI(this)};vt.prototype.areAllComputeEffectsReady=function(){for(const o in this._compiledComputeEffects)if(!this._compiledComputeEffects[o].isReady())return!1;return!0};vt.prototype.computeDispatch=function(o,e,t,i,r,s,n){if(this._currentRenderTarget){this._onAfterUnbindFrameBufferObservable.addOnce(()=>{this.computeDispatch(o,e,t,i,r,s,n)});return}const a=o._pipelineContext,l=e;a.computePipeline||(a.computePipeline=this._device.createComputePipeline({layout:Tu.Auto,compute:a.stage}));const h=this._renderTargetEncoder.beginComputePass();h.setPipeline(a.computePipeline);const u=l.getBindGroups(t,a.computePipeline,n);for(let d=0;d<u.length;++d){const f=u[d];f&&h.setBindGroup(d,f)}h.dispatchWorkgroups(i,r,s),h.end()};vt.prototype.releaseComputeEffects=function(){for(const o in this._compiledComputeEffects){const e=this._compiledComputeEffects[o].getPipelineContext();this._deleteComputePipelineContext(e)}this._compiledComputeEffects={}};vt.prototype._prepareComputePipelineContext=function(o,e,t,i,r){const s=o;this.dbgShowShaderCode&&(console.log(i),console.log(e)),s.sources={compute:e,rawCompute:t},s.stage=this._createComputePipelineStageDescriptor(e,i,r)};vt.prototype._releaseComputeEffect=function(o){this._compiledComputeEffects[o._key]&&(delete this._compiledComputeEffects[o._key],this._deleteComputePipelineContext(o.getPipelineContext()))};vt.prototype._rebuildComputeEffects=function(){for(const o in this._compiledComputeEffects){const e=this._compiledComputeEffects[o];e._pipelineContext=null,e._wasPreviouslyReady=!1,e._prepareEffect()}};vt.prototype._deleteComputePipelineContext=function(o){o&&o.dispose()};vt.prototype._createComputePipelineStageDescriptor=function(o,e,t){return e?e="//"+e.split(`
`).join(`
//`)+`
`:e="",{module:this._device.createShaderModule({code:e+o}),entryPoint:t}};vt.prototype._createDepthStencilCubeTexture=function(o,e){const t=new hi(this,bt.DepthStencil);t.isCube=!0;const i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,...e};return t.format=i.generateStencil?13:14,this._setupDepthStencilTexture(t,o,i.generateStencil,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t),this._internalTexturesCache.push(t),t};vt.prototype.createCubeTexture=function(o,e,t,i,r=null,s=null,n,a=null,l=!1,c=0,h=0,u=null,d=!1){return this.createCubeTextureBase(o,e,t,!!i,r,s,n,a,l,c,h,u,null,(f,_)=>{const p=_,m=p[0].width,T=m;this._setCubeMapTextureParams(f,!i),f.format=n??-1;const b=this._textureHelper.createGPUTextureForInternalTexture(f,m,T);this._textureHelper.updateCubeTextures(p,b.underlyingResource,m,T,b.format,!1,!1,0,0),i||this._generateMipmaps(f,this._uploadEncoder),f.isReady=!0,f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),r&&r()},!!d)};vt.prototype._setCubeMapTextureParams=function(o,e,t){o.samplingMode=e?3:2,o._cachedWrapU=0,o._cachedWrapV=0,t&&(o._maxLodLevel=t)};vt.prototype._debugPushGroup=function(o,e){this._options.enableGPUDebugMarkers&&(e===0||e===1?(e===0?this._renderEncoder:this._renderTargetEncoder).pushDebugGroup(o):this._currentRenderPass?this._currentRenderPass.pushDebugGroup(o):this._pendingDebugCommands.push(["push",o]))};vt.prototype._debugPopGroup=function(o){this._options.enableGPUDebugMarkers&&(o===0||o===1?(o===0?this._renderEncoder:this._renderTargetEncoder).popDebugGroup():this._currentRenderPass?this._currentRenderPass.popDebugGroup():this._pendingDebugCommands.push(["pop",null]))};vt.prototype._debugInsertMarker=function(o,e){this._options.enableGPUDebugMarkers&&(e===0||e===1?(e===0?this._renderEncoder:this._renderTargetEncoder).insertDebugMarker(o):this._currentRenderPass?this._currentRenderPass.insertDebugMarker(o):this._pendingDebugCommands.push(["insert",o]))};vt.prototype._debugFlushPendingCommands=function(){for(let o=0;o<this._pendingDebugCommands.length;++o){const[e,t]=this._pendingDebugCommands[o];switch(e){case"push":this._debugPushGroup(t);break;case"pop":this._debugPopGroup();break;case"insert":this._debugInsertMarker(t);break}}this._pendingDebugCommands.length=0};vt.prototype.updateDynamicIndexBuffer=function(o,e,t=0){const i=o;let r;o.is32Bits?r=e instanceof Uint32Array?e:new Uint32Array(e):r=e instanceof Uint16Array?e:new Uint16Array(e),this._bufferManager.setSubData(i,t,r)};vt.prototype.updateDynamicVertexBuffer=function(o,e,t,i){const r=o;t===void 0&&(t=0);let s;i===void 0?(e instanceof Array?s=new Float32Array(e):e instanceof ArrayBuffer?s=new Uint8Array(e):s=e,i=s.byteLength):e instanceof Array?s=new Float32Array(e):e instanceof ArrayBuffer?s=new Uint8Array(e):s=e,this._bufferManager.setSubData(r,t,s,0,i)};vt.prototype.updateDynamicTexture=function(o,e,t,i=!1,r,s,n){var a;if(!o)return;const l=e.width,c=e.height;let h=o._hardwareTexture;!((a=o._hardwareTexture)===null||a===void 0)&&a.underlyingResource||(h=this._textureHelper.createGPUTextureForInternalTexture(o,l,c)),this._textureHelper.updateTexture(e,o,l,c,o.depth,h.format,0,0,t,i,0,0,n),o.generateMipMaps&&this._generateMipmaps(o,this._uploadEncoder),o.isReady=!0};class zI extends uE{constructor(e){super(e)}}ri.prototype.setExternalTexture=function(o,e){this._engine.setExternalTexture(o,e)};vt.prototype.createExternalTexture=function(o){return new zI(o)};vt.prototype.setExternalTexture=function(o,e){if(!e){this._currentMaterialContext.setTexture(o,null);return}this._setInternalTexture(o,e)};vt.prototype.unBindMultiColorAttachmentFramebuffer=function(o,e=!1,t){t&&t();const r=o._attachments.length;this._currentRenderPass&&this._currentRenderPass!==this._mainRenderPassWrapper.renderPass&&this._endRenderTargetRenderPass();for(let s=0;s<r;s++){const n=o.textures[s];n.generateMipMaps&&!e&&!n.isCube&&this._generateMipmaps(n)}this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments),this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)};vt.prototype.createMultipleRenderTarget=function(o,e,t){var i;let r=!1,s=!0,n=!1,a=!1,l=15,c=1;const h=0,u=3,d=!1;let f=new Array,_=new Array,p=new Array;const m=this._createHardwareRenderTargetWrapper(!0,!1,o);e!==void 0&&(r=e.generateMipMaps===void 0?!1:e.generateMipMaps,s=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,n=e.generateStencilBuffer===void 0?!1:e.generateStencilBuffer,a=e.generateDepthTexture===void 0?!1:e.generateDepthTexture,c=e.textureCount||1,l=(i=e.depthTextureFormat)!==null&&i!==void 0?i:15,e.types&&(f=e.types),e.samplingModes&&(_=e.samplingModes),e.useSRGBBuffers&&(p=e.useSRGBBuffers));const T=o.width||o,b=o.height||o;let y=null;(s||n||a)&&(y=m.createDepthStencilTexture(0,!1,n,1,l));const S=[],C=[],I=[];m._generateDepthBuffer=s,m._generateStencilBuffer=n,m._attachments=C,m._defaultAttachments=I;for(let P=0;P<c;P++){let D=_[P]||u,w=f[P]||h;const L=p[P]||d;(w===1&&!this._caps.textureFloatLinearFiltering||w===2&&!this._caps.textureHalfFloatLinearFiltering)&&(D=1),w===1&&!this._caps.textureFloat&&(w=0,X.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));const U=new hi(this,bt.MultiRenderTarget);S.push(U),C.push(P+1),I.push(t?P+1:P===0?1:0),U.baseWidth=T,U.baseHeight=b,U.width=T,U.height=b,U.isReady=!0,U.samples=1,U.generateMipMaps=r,U.samplingMode=D,U.type=w,U._cachedWrapU=0,U._cachedWrapV=0,U._useSRGBBuffer=L,this._internalTexturesCache.push(U),this._textureHelper.createGPUTextureForInternalTexture(U)}return y&&(y.incrementReferences(),S.push(y),this._internalTexturesCache.push(y)),m.setTextures(S),m};vt.prototype.updateMultipleRenderTargetTextureSampleCount=function(o,e){if(!o||!o.textures||o.textures[0].samples===e)return e;const t=o.textures.length;if(t===0)return 1;e=Math.min(e,this.getCaps().maxMSAASamples);for(let i=0;i<t;++i){const r=o.textures[i];this._textureHelper.createMSAATexture(r,e),r.samples=e}return o._depthStencilTexture&&o._depthStencilTexture!==o.textures[o.textures.length-1]&&(this._textureHelper.createMSAATexture(o._depthStencilTexture,e),o._depthStencilTexture.samples=e),e};vt.prototype.bindAttachments=function(o){o.length===0||!this._currentRenderTarget||(this._mrtAttachments=o,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(o))};vt.prototype.buildTextureLayout=function(o){const e=[];for(let t=0;t<o.length;t++)o[t]?e.push(t+1):e.push(0);return e};vt.prototype.restoreSingleAttachment=function(){};vt.prototype.restoreSingleAttachmentForRenderTarget=function(){};vt.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter};vt.prototype.captureGPUFrameTime=function(o){this._timestampQuery.enable=o&&!!this._caps.timerQuery};vt.prototype.createQuery=function(){return this._occlusionQuery.createQuery()};vt.prototype.deleteQuery=function(o){return this._occlusionQuery.deleteQuery(o),this};vt.prototype.isQueryResultAvailable=function(o){return this._occlusionQuery.isQueryResultAvailable(o)};vt.prototype.getQueryResult=function(o){return this._occlusionQuery.getQueryResult(o)};vt.prototype.beginOcclusionQuery=function(o,e){var t;if(this.compatibilityMode){if(this._occlusionQuery.canBeginQuery)return(t=this._currentRenderPass)===null||t===void 0||t.beginOcclusionQuery(e),!0}else return(this._getCurrentRenderPassIndex()===0?this._bundleList:this._bundleListRenderTarget).addItem(new Rm(e)),!0;return!1};vt.prototype.endOcclusionQuery=function(){var o;return this.compatibilityMode?(o=this._currentRenderPass)===null||o===void 0||o.endOcclusionQuery():(this._getCurrentRenderPassIndex()===0?this._bundleList:this._bundleListRenderTarget).addItem(new Im),this};vt.prototype.createRawTexture=function(o,e,t,i,r,s,n,a=null,l=0,c=0,h=!1){const u=new hi(this,bt.Raw);return u.baseWidth=e,u.baseHeight=t,u.width=e,u.height=t,u.format=i,u.generateMipMaps=r,u.samplingMode=n,u.invertY=s,u._compression=a,u.type=l,u._useSRGBBuffer=h,this._doNotHandleContextLost||(u._bufferView=o),this._textureHelper.createGPUTextureForInternalTexture(u,e,t,void 0,c),this.updateRawTexture(u,o,i,s,a,l,h),this._internalTexturesCache.push(u),u};vt.prototype.updateRawTexture=function(o,e,t,i,r=null,s=0,n=!1){if(o){if(this._doNotHandleContextLost||(o._bufferView=e,o.invertY=i,o._compression=r,o._useSRGBBuffer=n),e){const a=o._hardwareTexture;t===4&&(e=zu(e,o.width,o.height,s));const c=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(c,o,o.width,o.height,o.depth,a.format,0,0,i,!1,0,0),o.generateMipMaps&&this._generateMipmaps(o,this._uploadEncoder)}o.isReady=!0}};vt.prototype.createRawCubeTexture=function(o,e,t,i,r,s,n,a=null){const l=new hi(this,bt.CubeRaw);return i===1&&!this._caps.textureFloatLinearFiltering?(r=!1,n=1,X.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===2&&!this._caps.textureHalfFloatLinearFiltering?(r=!1,n=1,X.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===1&&!this._caps.textureFloatRender?(r=!1,X.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):i===2&&!this._caps.colorBufferFloat&&(r=!1,X.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")),l.isCube=!0,l.format=t===4?5:t,l.type=i,l.generateMipMaps=r,l.width=e,l.height=e,l.samplingMode=n,this._doNotHandleContextLost||(l._bufferViewArray=o),l.invertY=s,l._compression=a,l._cachedWrapU=0,l._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(l),o&&this.updateRawCubeTexture(l,o,t,i,s,a),l.isReady=!0,l};vt.prototype.updateRawCubeTexture=function(o,e,t,i,r,s=null){o._bufferViewArray=e,o.invertY=r,o._compression=s;const n=o._hardwareTexture,a=t===4,l=[];for(let c=0;c<e.length;++c){let h=e[c];a&&(h=zu(e[c],o.width,o.height,i)),l.push(new Uint8Array(h.buffer,h.byteOffset,h.byteLength))}this._textureHelper.updateCubeTextures(l,n.underlyingResource,o.width,o.height,n.format,r,!1,0,0),o.generateMipMaps&&this._generateMipmaps(o,this._uploadEncoder),o.isReady=!0};vt.prototype.createRawCubeTextureFromUrl=function(o,e,t,i,r,s,n,a,l=null,c=null,h=3,u=!1){const d=this.createRawCubeTexture(null,t,i,r,!s,u,h,null);e==null||e.addPendingData(d),d.url=o,this._internalTexturesCache.push(d);const f=(p,m)=>{e==null||e.removePendingData(d),c&&p&&c(p.status+" "+p.statusText,m)},_=p=>{const m=d.width,T=n(p);if(!T)return;const b=[0,2,4,1,3,5];if(a){const y=i===4,S=a(T),C=d._hardwareTexture,I=[0,1,2,3,4,5];for(let P=0;P<S.length;P++){const D=m>>P,w=[];for(let L=0;L<6;L++){let U=S[P][I[L]];y&&(U=zu(U,D,D,r)),w.push(new Uint8Array(U.buffer,U.byteOffset,U.byteLength))}this._textureHelper.updateCubeTextures(w,C.underlyingResource,D,D,C.format,u,!1,0,0)}}else{const y=[];for(let S=0;S<6;S++)y.push(T[b[S]]);this.updateRawCubeTexture(d,y,i,r,u)}d.isReady=!0,e==null||e.removePendingData(d),l&&l()};return this._loadFile(o,p=>{_(p)},void 0,e==null?void 0:e.offlineProvider,!0,f),d};vt.prototype.createRawTexture3D=function(o,e,t,i,r,s,n,a,l=null,c=0,h=0){const u=bt.Raw3D,d=new hi(this,u);return d.baseWidth=e,d.baseHeight=t,d.baseDepth=i,d.width=e,d.height=t,d.depth=i,d.format=r,d.type=c,d.generateMipMaps=s,d.samplingMode=a,d.is3D=!0,this._doNotHandleContextLost||(d._bufferView=o),this._textureHelper.createGPUTextureForInternalTexture(d,e,t,void 0,h),this.updateRawTexture3D(d,o,r,n,l,c),this._internalTexturesCache.push(d),d};vt.prototype.updateRawTexture3D=function(o,e,t,i,r=null,s=0){if(this._doNotHandleContextLost||(o._bufferView=e,o.format=t,o.invertY=i,o._compression=r),e){const n=o._hardwareTexture;t===4&&(e=zu(e,o.width,o.height,s));const l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,o,o.width,o.height,o.depth,n.format,0,0,i,!1,0,0),o.generateMipMaps&&this._generateMipmaps(o,this._uploadEncoder)}o.isReady=!0};vt.prototype.createRawTexture2DArray=function(o,e,t,i,r,s,n,a,l=null,c=0,h=0){const u=bt.Raw2DArray,d=new hi(this,u);return d.baseWidth=e,d.baseHeight=t,d.baseDepth=i,d.width=e,d.height=t,d.depth=i,d.format=r,d.type=c,d.generateMipMaps=s,d.samplingMode=a,d.is2DArray=!0,this._doNotHandleContextLost||(d._bufferView=o),this._textureHelper.createGPUTextureForInternalTexture(d,e,t,i,h),this.updateRawTexture2DArray(d,o,r,n,l,c),this._internalTexturesCache.push(d),d};vt.prototype.updateRawTexture2DArray=function(o,e,t,i,r=null,s=0){if(this._doNotHandleContextLost||(o._bufferView=e,o.format=t,o.invertY=i,o._compression=r),e){const n=o._hardwareTexture;t===4&&(e=zu(e,o.width,o.height,s));const l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,o,o.width,o.height,o.depth,n.format,0,0,i,!1,0,0),o.generateMipMaps&&this._generateMipmaps(o,this._uploadEncoder)}o.isReady=!0};function zu(o,e,t,i){let r,s=1;i===1?r=new Float32Array(e*t*4):i===2?(r=new Uint16Array(e*t*4),s=15360):i===7?r=new Uint32Array(e*t*4):r=new Uint8Array(e*t*4);for(let n=0;n<e;n++)for(let a=0;a<t;a++){const l=(a*e+n)*3,c=(a*e+n)*4;r[c+0]=o[l+0],r[c+1]=o[l+1],r[c+2]=o[l+2],r[c+3]=s}return r}vt.prototype._readTexturePixels=function(o,e,t,i=-1,r=0,s=null,n=!0,a=!1,l=0,c=0){const h=o._hardwareTexture;return n&&this.flushFramebuffer(),this._textureHelper.readPixels(h.underlyingResource,l,c,e,t,h.format,i,r,s,a)};vt.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"};class HI extends lm{}vt.prototype._createHardwareRenderTargetWrapper=function(o,e,t){const i=new HI(o,e,t,this);return this._renderTargetWrapperCache.push(i),i};vt.prototype.createRenderTargetTexture=function(o,e){var t,i;const r=this._createHardwareRenderTargetWrapper(!1,!1,o),s={};e!==void 0&&typeof e=="object"?(s.generateMipMaps=e.generateMipMaps,s.generateDepthBuffer=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,s.generateStencilBuffer=s.generateDepthBuffer&&e.generateStencilBuffer,s.samplingMode=e.samplingMode===void 0?3:e.samplingMode,s.creationFlags=(t=e.creationFlags)!==null&&t!==void 0?t:0,s.noColorAttachment=!!e.noColorAttachment,s.samples=e.samples):(s.generateMipMaps=e,s.generateDepthBuffer=!0,s.generateStencilBuffer=!1,s.samplingMode=3,s.creationFlags=0,s.noColorAttachment=!1);const n=s.noColorAttachment?null:this._createInternalTexture(o,e,!0,bt.RenderTarget);return r._samples=(i=s.samples)!==null&&i!==void 0?i:1,r._generateDepthBuffer=s.generateDepthBuffer,r._generateStencilBuffer=!!s.generateStencilBuffer,r.setTextures(n),(r._generateDepthBuffer||r._generateStencilBuffer)&&r.createDepthStencilTexture(0,this._caps.textureFloatLinearFiltering&&(s.samplingMode===void 0||s.samplingMode===2||s.samplingMode===2||s.samplingMode===3||s.samplingMode===3||s.samplingMode===5||s.samplingMode===6||s.samplingMode===7||s.samplingMode===11),r._generateStencilBuffer,r.samples,s.generateStencilBuffer?13:14),n&&(e!==void 0&&typeof e=="object"&&e.createMipMaps&&!s.generateMipMaps&&(n.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(n,void 0,void 0,void 0,s.creationFlags),e!==void 0&&typeof e=="object"&&e.createMipMaps&&!s.generateMipMaps&&(n.generateMipMaps=!1)),r};vt.prototype._createDepthStencilTexture=function(o,e){const t=new hi(this,bt.DepthStencil),i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:e.generateStencil?13:14,...e};return t.format=i.depthTextureFormat,this._setupDepthStencilTexture(t,o,i.generateStencil,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t),this._internalTexturesCache.push(t),t};vt.prototype._setupDepthStencilTexture=function(o,e,t,i,r,s=1){const n=e.width||e,a=e.height||e,l=e.layers||0;o.baseWidth=n,o.baseHeight=a,o.width=n,o.height=a,o.is2DArray=l>0,o.depth=l,o.isReady=!0,o.samples=s,o.generateMipMaps=!1,o.samplingMode=i?2:1,o.type=1,o._comparisonFunction=r,o._cachedWrapU=0,o._cachedWrapV=0};vt.prototype.updateRenderTargetTextureSampleCount=function(o,e){return!o||!o.texture||o.samples===e||(e=Math.min(e,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(o.texture,e),o._depthStencilTexture&&(this._textureHelper.createMSAATexture(o._depthStencilTexture,e),o._depthStencilTexture.samples=e),o._samples=e,o.texture.samples=e),e};vt.prototype.createRenderTargetCubeTexture=function(o,e){const t=this._createHardwareRenderTargetWrapper(!1,!0,o),i={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1,...e};i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer;const r=new hi(this,bt.RenderTarget);return r.width=o,r.height=o,r.depth=0,r.isReady=!0,r.isCube=!0,r.samples=i.samples,r.generateMipMaps=i.generateMipMaps,r.samplingMode=i.samplingMode,r.type=i.type,r.format=i.format,this._internalTexturesCache.push(r),t.setTextures(r),(t._generateDepthBuffer||t._generateStencilBuffer)&&t.createDepthStencilTexture(0,i.samplingMode===void 0||i.samplingMode===2||i.samplingMode===2||i.samplingMode===3||i.samplingMode===3||i.samplingMode===5||i.samplingMode===6||i.samplingMode===7||i.samplingMode===11,t._generateStencilBuffer,t.samples),e&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(r),e&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!1),t};ri.prototype.setTextureSampler=function(o,e){this._engine.setTextureSampler(o,e)};vt.prototype.setTextureSampler=function(o,e){var t;(t=this._currentMaterialContext)===null||t===void 0||t.setSampler(o,e)};ri.prototype.setStorageBuffer=function(o,e){this._engine.setStorageBuffer(o,e)};vt.prototype.createStorageBuffer=function(o,e){return this._createBuffer(o,e|32)};vt.prototype.updateStorageBuffer=function(o,e,t,i){const r=o;t===void 0&&(t=0);let s;i===void 0?(e instanceof Array?s=new Float32Array(e):e instanceof ArrayBuffer?s=new Uint8Array(e):s=e,i=s.byteLength):e instanceof Array?s=new Float32Array(e):e instanceof ArrayBuffer?s=new Uint8Array(e):s=e,this._bufferManager.setSubData(r,t,s,0,i)};vt.prototype.readFromStorageBuffer=function(o,e,t,i){t=t||o.capacity;const r=this._bufferManager.createRawBuffer(t,Mi.MapRead|Mi.CopyDst);return this._renderTargetEncoder.copyBufferToBuffer(o.underlyingResource,e??0,r,0,t),new Promise((s,n)=>{this.onEndFrameObservable.addOnce(()=>{r.mapAsync(oc.Read,0,t).then(()=>{const a=r.getMappedRange(0,t);let l=i;if(l===void 0)l=new Uint8Array(t),l.set(new Uint8Array(a));else{const c=l.constructor;l=new c(l.buffer),l.set(new c(a))}r.unmap(),this._bufferManager.releaseBuffer(r),s(l)},a=>n(a))})})};vt.prototype.setStorageBuffer=function(o,e){var t,i;(t=this._currentDrawContext)===null||t===void 0||t.setBuffer(o,(i=e==null?void 0:e.getBuffer())!==null&&i!==void 0?i:null)};vt.prototype.createUniformBuffer=function(o){let e;return o instanceof Array?e=new Float32Array(o):e=o,this._bufferManager.createBuffer(e,Mi.Uniform|Mi.CopyDst)};vt.prototype.createDynamicUniformBuffer=function(o){return this.createUniformBuffer(o)};vt.prototype.updateUniformBuffer=function(o,e,t,i){t===void 0&&(t=0);const r=o;let s;i===void 0?(e instanceof Float32Array?s=e:s=new Float32Array(e),i=s.byteLength):e instanceof Float32Array?s=e:s=new Float32Array(e),this._bufferManager.setSubData(r,t,s,0,i)};vt.prototype.bindUniformBufferBase=function(o,e,t){this._currentDrawContext.setBuffer(t,o)};vt.prototype.bindUniformBlock=function(){};function WI(o){return!!(o&&o.underlyingResource!==void 0)}vt.prototype.updateVideoTexture=function(o,e,t){var i;if(!o||o._isDisabled)return;this._videoTextureSupported===void 0&&(this._videoTextureSupported=!0);let r=o._hardwareTexture;!((i=o._hardwareTexture)===null||i===void 0)&&i.underlyingResource||(r=this._textureHelper.createGPUTextureForInternalTexture(o)),WI(e)?(this._textureHelper.copyVideoToTexture(e,o,r.format,!t),o.generateMipMaps&&this._generateMipmaps(o,this._uploadEncoder),o.isReady=!0):e&&this.createImageBitmap(e).then(s=>{this._textureHelper.updateTexture(s,o,o.width,o.height,o.depth,r.format,0,0,!t,!1,0,0),o.generateMipMaps&&this._generateMipmaps(o,this._uploadEncoder),o.isReady=!0}).catch(()=>{o.isReady=!0})};class wl extends vc{constructor(e){super(e),this.controllerType=To.DAYDREAM}initControllerMesh(e,t){ft.ImportMesh("",wl.MODEL_BASE_URL,wl.MODEL_FILENAME,e,i=>{this._defaultModel=i[1],this.attachToMesh(this._defaultModel),t&&t(this._defaultModel)})}_handleButtonChange(e,t){if(e===0){const i=this.onTriggerStateChangedObservable;i&&i.notifyObservers(t)}else X.Warn(`Unrecognized Daydream button index: ${e}`)}}wl.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/";wl.MODEL_FILENAME="generic.babylon";wl.GAMEPAD_ID_PREFIX="Daydream";el._ControllerFactories.push({canCreate:o=>o.id.indexOf(wl.GAMEPAD_ID_PREFIX)===0,create:o=>new wl(o)});class Fl extends vc{constructor(e){super(e),this._buttonIndexToObservableNameMap=["onPadStateChangedObservable","onTriggerStateChangedObservable"],this.controllerType=To.GEAR_VR,this._calculatedPosition=new x(this.hand=="left"?-.15:.15,-.5,.25),this._disableTrackPosition(this._calculatedPosition)}initControllerMesh(e,t){ft.ImportMesh("",Fl.MODEL_BASE_URL,Fl.MODEL_FILENAME,e,i=>{const r=new K("",e);i[1].parent=r,i[1].position.z=-.15,this._defaultModel=r,this.attachToMesh(this._defaultModel),t&&t(this._defaultModel)})}_handleButtonChange(e,t){if(e<this._buttonIndexToObservableNameMap.length){const i=this._buttonIndexToObservableNameMap[e],r=this[i];r&&r.notifyObservers(t)}}}Fl.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/";Fl.MODEL_FILENAME="generic.babylon";Fl.GAMEPAD_ID_PREFIX="Gear VR";el._ControllerFactories.push({canCreate:o=>o.id.indexOf(Fl.GAMEPAD_ID_PREFIX)===0||o.id.indexOf("Oculus Go")!==-1||o.id.indexOf("Vive Focus")!==-1,create:o=>new Fl(o)});class Ll extends vc{constructor(e){super(e)}initControllerMesh(e,t){ft.ImportMesh("",Ll.MODEL_BASE_URL,Ll.MODEL_FILENAME,e,i=>{this._defaultModel=i[1],this.attachToMesh(this._defaultModel),t&&t(this._defaultModel)})}_handleButtonChange(e,t){console.log("Button id: "+e+"state: "),console.dir(t)}}Ll.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/";Ll.MODEL_FILENAME="generic.babylon";el._DefaultControllerFactory=o=>new Ll(o);class js extends vc{constructor(e){super(e),this.onSecondaryTriggerStateChangedObservable=new Q,this.onThumbRestChangedObservable=new Q,this.controllerType=To.OCULUS}initControllerMesh(e,t){let i;this.hand==="left"?i=js.MODEL_LEFT_FILENAME:i=js.MODEL_RIGHT_FILENAME,ft.ImportMesh("",js._IsQuest?js.QUEST_MODEL_BASE_URL:js.MODEL_BASE_URL,i,e,r=>{this._defaultModel=js._IsQuest?r[0]:r[1],this.attachToMesh(this._defaultModel),t&&t(this._defaultModel)})}get onAButtonStateChangedObservable(){if(this.hand==="right")return this.onMainButtonStateChangedObservable;throw new Error("No A button on left hand")}get onBButtonStateChangedObservable(){if(this.hand==="right")return this.onSecondaryButtonStateChangedObservable;throw new Error("No B button on left hand")}get onXButtonStateChangedObservable(){if(this.hand==="left")return this.onMainButtonStateChangedObservable;throw new Error("No X button on right hand")}get onYButtonStateChangedObservable(){if(this.hand==="left")return this.onSecondaryButtonStateChangedObservable;throw new Error("No Y button on right hand")}_handleButtonChange(e,t){const i=t,r=this.hand==="right"?-1:1;switch(e){case 0:this.onPadStateChangedObservable.notifyObservers(i);return;case 1:!js._IsQuest&&this._defaultModel&&(this._defaultModel.getChildren()[3].rotation.x=-i.value*.2,this._defaultModel.getChildren()[3].position.y=-i.value*.005,this._defaultModel.getChildren()[3].position.z=-i.value*.005),this.onTriggerStateChangedObservable.notifyObservers(i);return;case 2:!js._IsQuest&&this._defaultModel&&(this._defaultModel.getChildren()[4].position.x=r*i.value*.0035),this.onSecondaryTriggerStateChangedObservable.notifyObservers(i);return;case 3:!js._IsQuest&&this._defaultModel&&(i.pressed?this._defaultModel.getChildren()[1].position.y=-.001:this._defaultModel.getChildren()[1].position.y=0),this.onMainButtonStateChangedObservable.notifyObservers(i);return;case 4:!js._IsQuest&&this._defaultModel&&(i.pressed?this._defaultModel.getChildren()[2].position.y=-.001:this._defaultModel.getChildren()[2].position.y=0),this.onSecondaryButtonStateChangedObservable.notifyObservers(i);return;case 5:this.onThumbRestChangedObservable.notifyObservers(i);return}}}js.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/";js.MODEL_LEFT_FILENAME="left.babylon";js.MODEL_RIGHT_FILENAME="right.babylon";js.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/";js._IsQuest=!1;el._ControllerFactories.push({canCreate:o=>(qe.LastCreatedEngine&&qe.LastCreatedEngine._vrDisplay&&qe.LastCreatedEngine._vrDisplay.displayName==="Oculus Quest"&&(js._IsQuest=!0),o.id.indexOf("Oculus Touch")!==-1),create:o=>new js(o)});class fh extends vc{constructor(e){super(e),this.controllerType=To.VIVE,this._invertLeftStickY=!0}initControllerMesh(e,t){ft.ImportMesh("",fh.MODEL_BASE_URL,fh.MODEL_FILENAME,e,i=>{this._defaultModel=i[1],this.attachToMesh(this._defaultModel),t&&t(this._defaultModel)})}get onLeftButtonStateChangedObservable(){return this.onMainButtonStateChangedObservable}get onRightButtonStateChangedObservable(){return this.onMainButtonStateChangedObservable}get onMenuButtonStateChangedObservable(){return this.onSecondaryButtonStateChangedObservable}_handleButtonChange(e,t){const i=t;switch(e){case 0:this.onPadStateChangedObservable.notifyObservers(i);return;case 1:this._defaultModel&&(this._defaultModel.getChildren()[6].rotation.x=-i.value*.15),this.onTriggerStateChangedObservable.notifyObservers(i);return;case 2:this.onMainButtonStateChangedObservable.notifyObservers(i);return;case 3:this._defaultModel&&(i.pressed?this._defaultModel.getChildren()[2].position.y=-.001:this._defaultModel.getChildren()[2].position.y=0),this.onSecondaryButtonStateChangedObservable.notifyObservers(i);return}}}fh.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/";fh.MODEL_FILENAME="wand.babylon";el._ControllerFactories.push({canCreate:o=>o.id.toLowerCase().indexOf("openvr")!==-1,create:o=>new fh(o)});class XI{constructor(){this.buttonMeshes={},this.axisMeshes={}}}class Ca extends vc{constructor(e){super(e),this._mapping={buttons:["thumbstick","trigger","grip","menu","trackpad"],buttonMeshNames:{trigger:"SELECT",menu:"MENU",grip:"GRASP",thumbstick:"THUMBSTICK_PRESS",trackpad:"TOUCHPAD_PRESS"},buttonObservableNames:{trigger:"onTriggerStateChangedObservable",menu:"onSecondaryButtonStateChangedObservable",grip:"onMainButtonStateChangedObservable",thumbstick:"onPadStateChangedObservable",trackpad:"onTrackpadChangedObservable"},axisMeshNames:["THUMBSTICK_X","THUMBSTICK_Y","TOUCHPAD_TOUCH_X","TOUCHPAD_TOUCH_Y"],pointingPoseMeshName:xu.POINTING_POSE},this.onTrackpadChangedObservable=new Q,this.onTrackpadValuesChangedObservable=new Q,this.trackpad={x:0,y:0},this.controllerType=To.WINDOWS,this._loadedMeshInfo=null}get onTriggerButtonStateChangedObservable(){return this.onTriggerStateChangedObservable}get onMenuButtonStateChangedObservable(){return this.onSecondaryButtonStateChangedObservable}get onGripButtonStateChangedObservable(){return this.onMainButtonStateChangedObservable}get onThumbstickButtonStateChangedObservable(){return this.onPadStateChangedObservable}get onTouchpadButtonStateChangedObservable(){return this.onTrackpadChangedObservable}get onTouchpadValuesChangedObservable(){return this.onTrackpadValuesChangedObservable}_updateTrackpad(){this.browserGamepad.axes&&(this.browserGamepad.axes[2]!=this.trackpad.x||this.browserGamepad.axes[3]!=this.trackpad.y)&&(this.trackpad.x=this.browserGamepad.axes[this._mapping.axisMeshNames.indexOf("TOUCHPAD_TOUCH_X")],this.trackpad.y=this.browserGamepad.axes[this._mapping.axisMeshNames.indexOf("TOUCHPAD_TOUCH_Y")],this.onTrackpadValuesChangedObservable.notifyObservers(this.trackpad))}update(){if(super.update(),this.browserGamepad.axes&&(this._updateTrackpad(),this._loadedMeshInfo))for(let e=0;e<this._mapping.axisMeshNames.length;e++)this._lerpAxisTransform(e,this.browserGamepad.axes[e])}_handleButtonChange(e,t){const i=this._mapping.buttons[e];if(!i)return;this._updateTrackpad();const r=this[this._mapping.buttonObservableNames[i]];r&&r.notifyObservers(t),this._lerpButtonTransform(i,t.value)}_lerpButtonTransform(e,t){if(!this._loadedMeshInfo)return;const i=this._loadedMeshInfo.buttonMeshes[e];!i||!i.unpressed.rotationQuaternion||!i.pressed.rotationQuaternion||!i.value.rotationQuaternion||(oe.SlerpToRef(i.unpressed.rotationQuaternion,i.pressed.rotationQuaternion,t,i.value.rotationQuaternion),x.LerpToRef(i.unpressed.position,i.pressed.position,t,i.value.position))}_lerpAxisTransform(e,t){if(!this._loadedMeshInfo)return;const i=this._loadedMeshInfo.axisMeshes[e];if(!i||!i.min.rotationQuaternion||!i.max.rotationQuaternion||!i.value.rotationQuaternion)return;const r=t*.5+.5;oe.SlerpToRef(i.min.rotationQuaternion,i.max.rotationQuaternion,r,i.value.rotationQuaternion),x.LerpToRef(i.min.position,i.max.position,r,i.value.position)}initControllerMesh(e,t,i=!1){let r,s;if(ft.IsPluginForExtensionAvailable(".glb")){let n="default";if(this.id&&!i){const a=this.id.match(Ca.GAMEPAD_ID_PATTERN);n=a&&a[0]||n}this.hand==="left"?s=Ca.MODEL_LEFT_FILENAME:s=Ca.MODEL_RIGHT_FILENAME,r=Ca.MODEL_BASE_URL+n+"/"}else X.Warn("You need to reference GLTF loader to load Windows Motion Controllers model. Falling back to generic models"),r=Ll.MODEL_BASE_URL,s=Ll.MODEL_FILENAME;ft.ImportMesh("",r,s,e,n=>{this._loadedMeshInfo=this._processModel(e,n),this._loadedMeshInfo&&(this._defaultModel=this._loadedMeshInfo.rootNode,this.attachToMesh(this._defaultModel),t&&t(this._defaultModel))},null,(n,a)=>{X.Log(a),X.Warn("Failed to retrieve controller model from the remote server: "+r+s),i||this.initControllerMesh(n,t,!0)})}_processModel(e,t){let i=null;const r=new K(this.id+" "+this.hand,e);let s=null;for(let n=0;n<t.length;n++){const a=t[n];if(!a.parent){a.isPickable=!1,s=a;break}}return s?(s.setParent(r),i=this._createMeshInfo(r)):X.Warn("Could not find root node in model file."),i}_createMeshInfo(e){const t=new XI;let i;for(t.rootNode=e,t.buttonMeshes={},t.axisMeshes={},i=0;i<this._mapping.buttons.length;i++){const n=this._mapping.buttonMeshNames[this._mapping.buttons[i]];if(!n){X.Log("Skipping unknown button at index: "+i+" with mapped name: "+this._mapping.buttons[i]);continue}const a=r(e,n);if(!a){X.Warn("Missing button mesh with name: "+n);continue}const l={index:i,value:s(a,"VALUE"),pressed:s(a,"PRESSED"),unpressed:s(a,"UNPRESSED")};l.value&&l.pressed&&l.unpressed?t.buttonMeshes[this._mapping.buttons[i]]=l:X.Warn("Missing button submesh under mesh with name: "+n+"(VALUE: "+!!l.value+", PRESSED: "+!!l.pressed+", UNPRESSED:"+!!l.unpressed+")")}for(i=0;i<this._mapping.axisMeshNames.length;i++){const n=this._mapping.axisMeshNames[i];if(!n){X.Log("Skipping unknown axis at index: "+i);continue}const a=r(e,n);if(!a){X.Warn("Missing axis mesh with name: "+n);continue}const l={index:i,value:s(a,"VALUE"),min:s(a,"MIN"),max:s(a,"MAX")};l.value&&l.min&&l.max?t.axisMeshes[i]=l:X.Warn("Missing axis submesh under mesh with name: "+n+"(VALUE: "+!!l.value+", MIN: "+!!l.min+", MAX:"+!!l.max+")")}return t.pointingPoseNode=r(e,this._mapping.pointingPoseMeshName),t.pointingPoseNode?this._pointingPoseNode=t.pointingPoseNode:X.Warn("Missing pointing pose mesh with name: "+this._mapping.pointingPoseMeshName),t;function r(n,a){return n.getChildren(l=>l.name===a,!1)[0]}function s(n,a){return n.getChildren(l=>l.name==a,!0)[0]}}getForwardRay(e=100){if(!(this._loadedMeshInfo&&this._loadedMeshInfo.pointingPoseNode))return super.getForwardRay(e);const t=this._loadedMeshInfo.pointingPoseNode.getWorldMatrix(),i=t.getTranslation(),r=new x(0,0,-1),s=x.TransformNormal(r,t),n=x.Normalize(s);return new Pt(i,n,e)}dispose(){super.dispose(),this.onTrackpadChangedObservable.clear(),this.onTrackpadValuesChangedObservable.clear()}}Ca.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/";Ca.MODEL_LEFT_FILENAME="left.glb";Ca.MODEL_RIGHT_FILENAME="right.glb";Ca.GAMEPAD_ID_PREFIX="Spatial Controller (Spatial Interaction Source) ";Ca.GAMEPAD_ID_PATTERN=/([0-9a-zA-Z]+-[0-9a-zA-Z]+)$/;el._ControllerFactories.push({canCreate:o=>o.id.indexOf(Ca.GAMEPAD_ID_PREFIX)===0,create:o=>new Ca(o)});function fE(o){const e=[];e[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},e[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},e[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},e[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},e[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},e[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},e[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},e[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},e[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},e[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},e[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},e[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},e[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},e[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},e[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};const t=o.type&&(o.type<0||o.type>=e.length)?0:o.type||0,i=o.size,r=o.sizeX||i||1,s=o.sizeY||i||1,n=o.sizeZ||i||1,a=o.custom||e[t],l=a.face.length,c=o.faceUV||new Array(l),h=o.faceColors,u=o.flat===void 0?!0:o.flat,d=o.sideOrientation===0?0:o.sideOrientation||Oe.DEFAULTSIDE,f=new Array,_=new Array,p=new Array,m=new Array,T=new Array;let b=0,y=0;const S=new Array;let C=0,I=0,P,D,w,L,U,G;if(u)for(I=0;I<l;I++)h&&h[I]===void 0&&(h[I]=new Ye(1,1,1,1)),c&&c[I]===void 0&&(c[I]=new Tt(0,0,1,1));if(u)for(I=0;I<l;I++){const he=a.face[I].length;for(w=2*Math.PI/he,L=.5*Math.tan(w/2),U=.5,C=0;C<he;C++)f.push(a.vertex[a.face[I][C]][0]*r,a.vertex[a.face[I][C]][1]*s,a.vertex[a.face[I][C]][2]*n),S.push(b),b++,P=c[I].x+(c[I].z-c[I].x)*(.5+L),D=c[I].y+(c[I].w-c[I].y)*(U-.5),m.push(P,Yt.UseOpenGLOrientationForUV?1-D:D),G=L*Math.cos(w)-U*Math.sin(w),U=L*Math.sin(w)+U*Math.cos(w),L=G,h&&T.push(h[I].r,h[I].g,h[I].b,h[I].a);for(C=0;C<he-2;C++)_.push(S[0+y],S[C+2+y],S[C+1+y]);y+=he}else{for(C=0;C<a.vertex.length;C++)f.push(a.vertex[C][0]*r,a.vertex[C][1]*s,a.vertex[C][2]*n),m.push(0,Yt.UseOpenGLOrientationForUV?1:0);for(I=0;I<l;I++)for(C=0;C<a.face[I].length-2;C++)_.push(a.face[I][0],a.face[I][C+2],a.face[I][C+1])}Oe.ComputeNormals(f,_,p),Oe._ComputeSides(d,f,_,p,m,o.frontUVs,o.backUVs);const Z=new Oe;return Z.positions=f,Z.indices=_,Z.normals=p,Z.uvs=m,h&&u&&(Z.colors=T),Z}function $I(o,e={},t=null){const i=new K(o,t);return e.sideOrientation=K._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,fE(e).applyToMesh(i,e.updatable),i}Oe.CreatePolyhedron=fE;K.CreatePolyhedron=(o,e,t)=>$I(o,e,t);class zl extends St{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=x.Zero()),x.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=x.Zero()),x.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=x.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const e=x.Cross(this.direction,As.Y),t=x.Cross(e,this.direction);return x.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=x.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=H.Identity()),H.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ}getDepthMaxZ(e){return this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)}}M([Zs()],zl.prototype,"position",null);M([Zs()],zl.prototype,"direction",null);M([F()],zl.prototype,"shadowMinZ",null);M([F()],zl.prototype,"shadowMaxZ",null);ii.AddNodeConstructor("Light_Type_1",(o,e)=>()=>new Bn(o,x.Zero(),e));class Bn extends zl{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return St.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){const t=this.getScene().activeCamera;t&&H.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==void 0?this.shadowMinZ:t.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(!r)return;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const h=x.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE;let u=Number.MAX_VALUE,d=Number.MIN_VALUE;for(let f=0;f<i.length;f++){const _=i[f];if(!_)continue;const m=_.getBoundingInfo().boundingBox;for(let T=0;T<m.vectorsWorld.length;T++)x.TransformCoordinatesToRef(m.vectorsWorld[T],t,h),h.x<this._orthoLeft&&(this._orthoLeft=h.x),h.y<this._orthoBottom&&(this._orthoBottom=h.y),h.x>this._orthoRight&&(this._orthoRight=h.x),h.y>this._orthoTop&&(this._orthoTop=h.y),this.autoCalcShadowZBounds&&(h.z<u&&(u=h.z),h.z>d&&(d=h.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=u,this._shadowMaxZ=d)}const s=this._orthoRight-this._orthoLeft,n=this._orthoTop-this._orthoBottom,a=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,l=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,c=this.getScene().getEngine().useReverseDepthBuffer;H.OrthoOffCenterLHToRef(this._orthoLeft-s*this.shadowOrthoScale,this._orthoRight+s*this.shadowOrthoScale,this._orthoBottom-n*this.shadowOrthoScale,this._orthoTop+n*this.shadowOrthoScale,c?l:a,c?a:l,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}}M([F()],Bn.prototype,"shadowFrustumSize",null);M([F()],Bn.prototype,"shadowOrthoScale",null);M([F()],Bn.prototype,"autoUpdateExtends",void 0);M([F()],Bn.prototype,"autoCalcShadowZBounds",void 0);M([F("orthoLeft")],Bn.prototype,"_orthoLeft",void 0);M([F("orthoRight")],Bn.prototype,"_orthoRight",void 0);M([F("orthoTop")],Bn.prototype,"_orthoTop",void 0);M([F("orthoBottom")],Bn.prototype,"_orthoBottom",void 0);function _E(o){const e=new Array,t=new Array,i=new Array,r=new Array,s=o.radius||.5,n=o.tessellation||64,a=o.arc&&(o.arc<=0||o.arc>1)?1:o.arc||1,l=o.sideOrientation===0?0:o.sideOrientation||Oe.DEFAULTSIDE;e.push(0,0,0),r.push(.5,.5);const c=Math.PI*2*a,h=a===1?c/n:c/(n-1);let u=0;for(let _=0;_<n;_++){const p=Math.cos(u),m=Math.sin(u),T=(p+1)/2,b=(1-m)/2;e.push(s*p,s*m,0),r.push(T,Yt.UseOpenGLOrientationForUV?1-b:b),u+=h}a===1&&(e.push(e[3],e[4],e[5]),r.push(r[2],Yt.UseOpenGLOrientationForUV?1-r[3]:r[3]));const d=e.length/3;for(let _=1;_<d-1;_++)t.push(_+1,0,_);Oe.ComputeNormals(e,t,i),Oe._ComputeSides(l,e,t,i,r,o.frontUVs,o.backUVs);const f=new Oe;return f.indices=t,f.positions=e,f.normals=i,f.uvs=r,f}function pE(o,e={},t=null){const i=new K(o,t);return e.sideOrientation=K._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,_E(e).applyToMesh(i,e.updatable),i}Oe.CreateDisc=_E;K.CreateDisc=(o,e,t,i=null,r,s)=>pE(o,{radius:e,tessellation:t,sideOrientation:s,updatable:r},i);function YI(o,e={},t){e.diameter||(e.diameter=1),e.segments||(e.segments=16);const i=jo("",{slice:.5,diameter:e.diameter,segments:e.segments},t),r=pE("",{radius:e.diameter/2,tessellation:e.segments*3+(4-e.segments)},t);r.rotation.x=-Math.PI/2,r.parent=i;const s=K.MergeMeshes([r,i],!0);return s.name=o,s}K.CreateHemisphere=(o,e,t,i)=>YI(o,{segments:e,diameter:t},i);ii.AddNodeConstructor("Light_Type_2",(o,e)=>()=>new wn(o,x.Zero(),x.Zero(),0,0,e));class wn extends zl{get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(e*.5),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(wn._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(()=>{this._markMeshesAsLightDirty()}):wn._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()})))}static _IsProceduralTexture(e){return e.onGeneratedObservable!==void 0}static _IsTexture(e){return e.onLoadObservable!==void 0}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,t,i,r,s,n){super(e,n),this._innerAngle=0,this._projectionTextureMatrix=H.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=x.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=x.Zero(),this._projectionTextureViewLightMatrix=H.Zero(),this._projectionTextureProjectionLightMatrix=H.Zero(),this._projectionTextureScalingMatrix=H.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=i,this.angle=r,this.exponent=s}getClassName(){return"SpotLight"}getTypeID(){return St.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(!r)return;this._shadowAngleScale=this._shadowAngleScale||1;const s=this._shadowAngleScale*this._angle,n=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,a=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;H.PerspectiveFovLHToRef(s,1,l?a:n,l?n:a,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,l)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.position.addToRef(this.direction,this._projectionTextureViewTargetVector),H.LookAtLHToRef(this.position,this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;const e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),r=-i*t,s=1/Math.tan(this._angle/2),n=1;H.FromValuesToRef(s/n,0,0,0,0,s,0,0,0,0,i,1,0,0,r,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof Y){const e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;H.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(this._innerAngle*.5)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightSampler"+t,this.projectionTexture)),this}transferToEffect(e,t){let i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),i=x.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),i=x.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let i;return this.computeTransformedInformation()?i=x.Normalize(this.transformedDirection):i=x.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose()}getDepthMinZ(e){const t=this._scene.getEngine(),i=this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){const t=this._scene.getEngine(),i=this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:i}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!!(this.projectionTexture&&this.projectionTexture.isReady())}}M([F()],wn.prototype,"angle",null);M([F()],wn.prototype,"innerAngle",null);M([F()],wn.prototype,"shadowAngleScale",null);M([F()],wn.prototype,"exponent",void 0);M([F()],wn.prototype,"projectionTextureLightNear",null);M([F()],wn.prototype,"projectionTextureLightFar",null);M([F()],wn.prototype,"projectionTextureUpDirection",null);M([Bt("projectedLightTexture")],wn.prototype,"_projectionTexture",void 0);const jI="kernelBlurVaryingDeclaration",KI="varying vec2 sampleCoord{X};";te.IncludesShadersStore[jI]=KI;const qI="packingFunctions",QI=`vec4 pack(float depth)
{
const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);
const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);
vec4 res=fract(depth*bit_shift);
res-=res.xxyz*bit_mask;
return res;
}
float unpack(vec4 color)
{
const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);
return dot(color,bit_shift);
}`;te.IncludesShadersStore[qI]=QI;const ZI="kernelBlurFragment",JI=`#ifdef DOF
factor=sampleCoC(sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;
#endif
`;te.IncludesShadersStore[ZI]=JI;const eP="kernelBlurFragment2",tP=`#ifdef DOF
factor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});
computedWeight=KERNEL_DEP_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;te.IncludesShadersStore[eP]=tP;const iP="kernelBlurPixelShader",rP=`uniform sampler2D textureSampler;
uniform vec2 delta;
varying vec2 sampleCenter;
#ifdef DOF
uniform sampler2D circleOfConfusionSampler;
float sampleCoC(in vec2 offset) {
float coc=texture2D(circleOfConfusionSampler,offset).r;
return coc; 
}
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
float computedWeight=0.0;
#ifdef PACKEDFLOAT
float blend=0.;
#else
vec4 blend=vec4(0.);
#endif
#ifdef DOF
float sumOfWeights=CENTER_WEIGHT; 
float factor=0.0;
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;
#else
blend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
gl_FragColor=pack(blend);
#else
gl_FragColor=blend;
#endif
#ifdef DOF
gl_FragColor/=sumOfWeights;
#endif
}`;te.ShadersStore[iP]=rP;const sP="kernelBlurVertex",nP="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";te.IncludesShadersStore[sP]=nP;const aP="kernelBlurVertexShader",oP=`attribute vec2 position;
uniform vec2 delta;
varying vec2 sampleCenter;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
sampleCenter=(position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;te.ShadersStore[aP]=oP;class Yr extends et{set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this._blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this._blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,i,r,s,n=Y.BILINEAR_SAMPLINGMODE,a,l,c=0,h="",u=!1,d=5){super(e,"kernelBlur",["delta","direction"],["circleOfConfusionSampler"],r,s,n,a,l,null,c,"kernelBlur",{varyingCount:0,depCount:0},!0,d),this._blockCompilation=u,this._packedFloat=!1,this._staticDefines="",this._staticDefines=h,this.direction=t,this.onApplyObservable.add(f=>{this._outputTexture?f.setFloat2("delta",1/this._outputTexture.width*this.direction.x,1/this._outputTexture.height*this.direction.y):f.setFloat2("delta",1/this.width*this.direction.x,1/this.height*this.direction.y)}),this.kernel=i}updateEffect(e=null,t=null,i=null,r,s,n){this._updateParameters(s,n)}_updateParameters(e,t){const i=this._kernel,r=(i-1)/2;let s=[],n=[],a=0;for(let m=0;m<i;m++){const T=m/(i-1),b=this._gaussianWeight(T*2-1);s[m]=m-r,n[m]=b,a+=b}for(let m=0;m<n.length;m++)n[m]/=a;const l=[],c=[],h=[];for(let m=0;m<=r;m+=2){const T=Math.min(m+1,Math.floor(r));if(m===T)h.push({o:s[m],w:n[m]});else{const y=T===r,S=n[m]+n[T]*(y?.5:1),C=s[m]+1/(1+n[m]/n[T]);C===0?(h.push({o:s[m],w:n[m]}),h.push({o:s[m+1],w:n[m+1]})):(h.push({o:C,w:S}),h.push({o:-C,w:S}))}}for(let m=0;m<h.length;m++)c[m]=h[m].o,l[m]=h[m].w;s=c,n=l;const u=this.getEngine().getCaps().maxVaryingVectors,d=Math.max(u,0)-1;let f=Math.min(s.length,d),_="";_+=this._staticDefines,this._staticDefines.indexOf("DOF")!=-1&&(_+=`#define CENTER_WEIGHT ${this._glslFloat(n[f-1])}\r
`,f--);for(let m=0;m<f;m++)_+=`#define KERNEL_OFFSET${m} ${this._glslFloat(s[m])}\r
`,_+=`#define KERNEL_WEIGHT${m} ${this._glslFloat(n[m])}\r
`;let p=0;for(let m=d;m<s.length;m++)_+=`#define KERNEL_DEP_OFFSET${p} ${this._glslFloat(s[m])}\r
`,_+=`#define KERNEL_DEP_WEIGHT${p} ${this._glslFloat(n[m])}\r
`,p++;this.packedFloat&&(_+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,super.updateEffect(_,null,null,{varyingCount:f,depCount:p},e,t)}_nearestBestKernel(e){const t=Math.round(e);for(const i of[t,t-1,t+1,t-2,t+2])if(i%2!==0&&Math.floor(i/2)%2===0&&i>0)return Math.max(i,3);return Math.max(t,3)}_gaussianWeight(e){const t=.3333333333333333,i=Math.sqrt(2*Math.PI)*t,r=-(e*e/(2*t*t));return 1/i*Math.exp(r)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}static _Parse(e,t,i,r){return ke.Parse(()=>new Yr(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1),e,i,r)}}M([F("kernel")],Yr.prototype,"_kernel",void 0);M([F("packedFloat")],Yr.prototype,"_packedFloat",void 0);M([Zp()],Yr.prototype,"direction",void 0);ye("BABYLON.BlurPostProcess",Yr);class Hf extends Zi{set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){const e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){const e=this.getScene();e&&(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,t,i,r,s=0,n=Y.BILINEAR_SAMPLINGMODE,a=!0){if(super(e,t,i,r,!0,s,!1,n,a),this.mirrorPlane=new Tn(0,1,0,1),this._transformMatrix=H.Zero(),this._mirrorMatrix=H.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,i=this.getScene(),!i)return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateGammaSpace()});const l=i.getEngine();l.supportsUniformBuffers&&(this._sceneUBO=i.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`)),this.onBeforeBindObservable.add(()=>{var h;(h=l._debugPushGroup)===null||h===void 0||h.call(l,`mirror generation for ${e}`,1)}),this.onAfterUnbindObservable.add(()=>{var h;(h=l._debugPopGroup)===null||h===void 0||h.call(l,1)});let c;this.onBeforeRenderObservable.add(()=>{this._sceneUBO&&(this._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(this._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),H.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(i.getViewMatrix(),this._transformMatrix),i.setTransformMatrix(this._transformMatrix,i.getProjectionMatrix()),c=i.clipPlane,i.clipPlane=this.mirrorPlane,i._mirroredCameraPosition=x.TransformCoordinates(i.activeCamera.globalPosition,this._mirrorMatrix)}),this.onAfterRenderObservable.add(()=>{this._sceneUBO&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(),i._mirroredCameraPosition=null,i.clipPlane=c})}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){const e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new Yr("horizontal blur",new Ie(1,0),this._blurKernelX,this._blurRatio,null,Y.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,this._blurRatio===1&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new Yr("vertical blur",new Ie(0,1),this._blurKernelY,this._blurRatio,null,Y.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=this._blurRatio!==1,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new Hf(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){var e;super.dispose();const t=this.getScene();t&&t.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),(e=this._sceneUBO)===null||e===void 0||e.dispose()}}Y._CreateMirror=(o,e,t,i)=>new Hf(o,e,t,i);class ns extends ni{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(H.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let r="";return e.forEach(s=>r+=s),new ns(r,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,r=!0){const s=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const n=new ns(e,t,null,!1,null,null,null,void 0,!0,i,r);return t.useDelayedTextureLoading=s,n}constructor(e,t,i=null,r=!1,s=null,n=null,a=null,l=5,c=!1,h=null,u=!1,d=.8,f=0,_,p){var m;super(t),this._lodScale=.8,this._lodOffset=0,this.onLoadObservable=new Q,this.boundingBoxPosition=x.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this.name=e,this.url=e,this._noMipmap=r,this.hasAlpha=!1,this._format=l,this.isCube=!0,this._textureMatrix=H.Identity(),this._createPolynomials=u,this.coordinatesMode=Y.CUBIC_MODE,this._extensions=i,this._files=s,this._forcedExtension=h,this._loaderOptions=_,this._useSRGBBuffer=p,this._lodScale=d,this._lodOffset=f,!(!e&&!s)&&this.updateURL(e,h,n,c,a,i,(m=this.getScene())===null||m===void 0?void 0:m.useDelayedTextureLoading,s)}getClassName(){return"CubeTexture"}updateURL(e,t,i=null,r=!1,s=null,n=null,a=!1,l=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);const c=e.lastIndexOf("."),h=t||(c>-1?e.substring(c).toLowerCase():""),u=h.indexOf(".dds")===0,d=h.indexOf(".env")===0,f=h.indexOf(".basis")===0;if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=r,r&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(!f&&!d&&!u&&!n&&(n=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,n){for(let _=0;_<n.length;_++)this._files.push(e+n[_]);this._extensions=n}a?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=s):this._loadTexture(i,s)}delayLoad(e){this.delayLoadState===4&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t;e.updateFlag!==this._textureMatrix.updateFlag&&(e.isIdentity()!==this._textureMatrix.isIdentity()&&((t=this.getScene())===null||t===void 0||t.markAllMaterialsAsDirty(1,i=>i.getActiveTextures().indexOf(this)!==-1)),this._textureMatrix=e)}_loadTexture(e=null,t=null){var i;const r=this.getScene(),s=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const n=()=>{var l;this.onLoadObservable.notifyObservers(this),s&&(s.dispose(),(l=this.getScene())===null||l===void 0||l.markAllMaterialsAsDirty(1)),e&&e()},a=(l,c)=>{this._loadingError=!0,this._errorObject={message:l,exception:c},t&&t(l,c),Y.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?J.SetImmediate(()=>n()):this._texture.onLoadedObservable.add(()=>n()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,r,this._lodScale,this._lodOffset,e,a,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,r,this._files,this._noMipmap,e,a,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer),(i=this._texture)===null||i===void 0||i.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,i){const r=ke.Parse(()=>{let s=!1;return e.prefiltered&&(s=e.prefiltered),new ns(i+e.name,t,e.extensions,!1,e.files||null,null,null,void 0,s,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(r.boundingBoxPosition=x.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=x.FromArray(e.boundingBoxSize)),e.animations)for(let s=0;s<e.animations.length;s++){const n=e.animations[s],a=Xr("BABYLON.Animation");a&&r.animations.push(a.Parse(n))}return r}clone(){let e=0;const t=ke.Clone(()=>{const i=new ns(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=i.uniqueId,i},this);return t.uniqueId=e,t}}M([F()],ns.prototype,"url",void 0);M([F("rotationY")],ns.prototype,"rotationY",null);M([F("files")],ns.prototype,"_files",void 0);M([F("forcedExtension")],ns.prototype,"_forcedExtension",void 0);M([F("extensions")],ns.prototype,"_extensions",void 0);M([Zx("textureMatrix")],ns.prototype,"_textureMatrix",void 0);Y._CubeTextureParser=ns.Parse;ye("BABYLON.CubeTexture",ns);const lP="backgroundFragmentDeclaration",cP=`uniform vec4 vEyePosition;
uniform vec4 vPrimaryColor;
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
uniform vec4 vPrimaryColorShadow;
#endif
uniform float shadowLevel;
uniform float alpha;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
#endif
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)
uniform mat4 view;
#endif
`;te.IncludesShadersStore[lP]=cP;const hP="backgroundUboDeclaration",uP=`layout(std140,column_major) uniform;
uniform Material
{
uniform vec4 vPrimaryColor;
uniform vec4 vPrimaryColorShadow;
uniform vec2 vDiffuseInfos;
uniform vec2 vReflectionInfos;
uniform mat4 diffuseMatrix;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
uniform float fFovMultiplier;
uniform float pointSize;
uniform float shadowLevel;
uniform float alpha;
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
};
#include<sceneUboDeclaration>
`;te.IncludesShadersStore[hP]=uP;const dP="backgroundPixelShader",fP=`#ifdef TEXTURELODSUPPORT
#extension GL_EXT_shader_texture_lod : enable
#endif
precision highp float;
#include<__decl__backgroundFragment>
#include<helperFunctions>
#define RECIPROCAL_PI2 0.15915494
varying vec3 vPositionW;
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif 
#ifdef MAINUV2 
varying vec2 vMainUV2; 
#endif 
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vec2 vDiffuseUV;
#endif
uniform sampler2D diffuseSampler;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
vec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{
float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);
return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));
}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=vec3(0.0,1.0,0.0);
#endif
float shadow=1.;
float globalShadow=0.;
float shadowLightCount=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
vec4 reflectionColor=vec4(1.,1.,1.,1.);
#ifdef REFLECTION
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=reflectionVector;
#else
vec2 reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
float reflectionLOD=vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#else
float lodReflectionNormalized=saturate(reflectionLOD);
float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;
vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);
if(lodReflectionNormalizedDoubled<1.0){
reflectionColor=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);
} else {
reflectionColor=mix(
reflectionSpecularMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);
}
#endif
#else
vec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);
reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef GAMMAREFLECTION
reflectionColor.rgb=toLinearSpace(reflectionColor.rgb);
#endif
#ifdef REFLECTIONBGR
reflectionColor.rgb=reflectionColor.bgr;
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#endif
vec3 diffuseColor=vec3(1.,1.,1.);
float finalAlpha=alpha;
#ifdef DIFFUSE
vec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap.rgb=toLinearSpace(diffuseMap.rgb);
#endif
diffuseMap.rgb*=vDiffuseInfos.y;
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
vec3 colorBase=diffuseColor;
#else
vec3 colorBase=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,0.0);
#ifdef USERGBCOLOR
vec3 finalColor=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
vec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);
#else
vec3 mainColor=vPrimaryColor.rgb;
#endif
vec3 finalColor=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
vec3 reflectionAmount=vReflectionControl.xxx;
vec3 reflectionReflectance0=vReflectionControl.yyy;
vec3 reflectionReflectance90=vReflectionControl.zzz;
float VdotN=dot(normalize(vEyePosition.xyz),normalW);
vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);
reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
float reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);
reflectionDistanceFalloff*=reflectionDistanceFalloff;
reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
float viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));
const float startAngle=0.1;
float fadeFactor=saturate(viewAngleToFloor/startAngle);
finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);
#endif
vec4 color=vec4(finalColor,finalAlpha);
#else
vec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);
#endif
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color.rgb=clamp(color.rgb,0.,30.0);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#ifdef NOISE
color.rgb+=dither(vPositionW.xy,0.5);
color=max(color,0.0);
#endif
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;te.ShadersStore[dP]=fP;const _P="backgroundVertexDeclaration",pP=`uniform mat4 view;
uniform mat4 viewProjection;
uniform float shadowLevel;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
uniform float fFovMultiplier;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
`;te.IncludesShadersStore[_P]=pP;const mP="backgroundVertexShader",gP=`precision highp float;
#include<__decl__backgroundVertex>
#include<helperFunctions>
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vec2 vDiffuseUV;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
} else {
gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);
}
#else
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#endif
vec4 worldPos=finalWorld*vec4(position,1.0);
vPositionW=vec3(worldPos);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
mat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));
vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));
if (fFovMultiplier<=1.0) {
vDirectionW=normalize(segment);
} else {
vDirectionW=normalize(vDirectionW+(vDirectionW-segment));
}
#endif
#endif
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uv;
#endif
#ifdef MAINUV2
vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (vDiffuseInfos.x==0.)
{
vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));
}
else
{
vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vColor=color;
#endif
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#define CUSTOM_VERTEX_MAIN_END
}
`;te.ShadersStore[mP]=gP;class vP extends Aa{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class Gt extends Fu{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t=t*2,this.reflectionReflectance0=Gt.StandardReflectance0*t,this.reflectionReflectance90=Gt.StandardReflectance90*t):(t=t*2-1,this.reflectionReflectance0=Gt.StandardReflectance0+(1-Gt.StandardReflectance0)*t,this.reflectionReflectance90=Gt.StandardReflectance90+(1-Gt.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()})))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}constructor(e,t){super(e,t),this.primaryColor=ge.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=x.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._renderTargets=new Lr(16),this._reflectionControls=Tt.Zero(),this._white=ge.White(),this._primaryShadowColor=ge.Black(),this._primaryHighlightColor=ge.Black(),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,i=!1){if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new vP);const r=this.getScene(),s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=r.getEngine();if(Ce.PrepareDefinesForLights(r,e,s,!1,this._maxSimultaneousLights),s._needNormals=!0,Ce.PrepareDefinesForMultiview(r,s),s._areTexturesDirty){if(s._needUVs=!1,r.texturesEnabled){if(r.getEngine().getCaps().textureLOD&&(s.TEXTURELODSUPPORT=!0),this._diffuseTexture&&Me.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;Ce.PrepareDefinesForMergedUV(this._diffuseTexture,s,"DIFFUSE"),s.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,s.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,s.OPACITYFRESNEL=this._opacityFresnel}else s.DIFFUSE=!1,s.DIFFUSEDIRECTUV=0,s.DIFFUSEHASALPHA=!1,s.GAMMADIFFUSE=!1,s.OPACITYFRESNEL=!1;const a=this._reflectionTexture;if(a&&Me.ReflectionTextureEnabled){if(!a.isReadyOrNotBlocking())return!1;switch(s.REFLECTION=!0,s.GAMMAREFLECTION=a.gammaSpace,s.RGBDREFLECTION=a.isRGBD,s.REFLECTIONBLUR=this._reflectionBlur>0,s.LODINREFLECTIONALPHA=a.lodLevelInAlpha,s.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,s.REFLECTIONBGR=this.switchToBGR,a.coordinatesMode===Y.INVCUBIC_MODE&&(s.INVERTCUBICMAP=!0),s.REFLECTIONMAP_3D=a.isCube,s.REFLECTIONMAP_OPPOSITEZ=s.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!a.invertZ:a.invertZ,a.coordinatesMode){case Y.EXPLICIT_MODE:s.REFLECTIONMAP_EXPLICIT=!0;break;case Y.PLANAR_MODE:s.REFLECTIONMAP_PLANAR=!0;break;case Y.PROJECTION_MODE:s.REFLECTIONMAP_PROJECTION=!0;break;case Y.SKYBOX_MODE:s.REFLECTIONMAP_SKYBOX=!0;break;case Y.SPHERICAL_MODE:s.REFLECTIONMAP_SPHERICAL=!0;break;case Y.EQUIRECTANGULAR_MODE:s.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case Y.FIXED_EQUIRECTANGULAR_MODE:s.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case Y.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:s.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case Y.CUBIC_MODE:case Y.INVCUBIC_MODE:default:s.REFLECTIONMAP_CUBIC=!0;break}this.reflectionFresnel?(s.REFLECTIONFRESNEL=!0,s.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(s.REFLECTIONFRESNEL=!1,s.REFLECTIONFALLOFF=!1)}else s.REFLECTION=!1,s.REFLECTIONFRESNEL=!1,s.REFLECTIONFALLOFF=!1,s.REFLECTIONBLUR=!1,s.REFLECTIONMAP_3D=!1,s.REFLECTIONMAP_SPHERICAL=!1,s.REFLECTIONMAP_PLANAR=!1,s.REFLECTIONMAP_CUBIC=!1,s.REFLECTIONMAP_PROJECTION=!1,s.REFLECTIONMAP_SKYBOX=!1,s.REFLECTIONMAP_EXPLICIT=!1,s.REFLECTIONMAP_EQUIRECTANGULAR=!1,s.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,s.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,s.INVERTCUBICMAP=!1,s.REFLECTIONMAP_OPPOSITEZ=!1,s.LODINREFLECTIONALPHA=!1,s.GAMMAREFLECTION=!1,s.RGBDREFLECTION=!1}s.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,s.USERGBCOLOR=this._useRGBColor,s.NOISE=this._enableNoise}if(s._areLightsDirty&&(s.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(this._primaryColorShadowLevel!==0||this._primaryColorHighlightLevel!==0),s.BACKMAT_SHADOWONLY=this._shadowOnly),s._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(s)}if(Ce.PrepareDefinesForMisc(e,r,!1,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),s),Ce.PrepareDefinesForFrameBoundValues(r,n,this,s,i,null,t.getRenderingMesh().hasThinInstances),Ce.PrepareDefinesForAttributes(e,s,!1,!0,!1)&&e&&!r.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(O.NormalKind)&&(e.createNormals(!0),X.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),s.isDirty){s.markAsProcessed(),r.resetCachedMaterial();const a=new pc;s.FOG&&a.addFallback(0,"FOG"),s.POINTSIZE&&a.addFallback(1,"POINTSIZE"),s.MULTIVIEW&&a.addFallback(0,"MULTIVIEW"),Ce.HandleFallbacksForShadows(s,a,this._maxSimultaneousLights);const l=[O.PositionKind];s.NORMAL&&l.push(O.NormalKind),s.UV1&&l.push(O.UVKind),s.UV2&&l.push(O.UV2Kind),Ce.PrepareAttributesForBones(l,e,s,a),Ce.PrepareAttributesForInstances(l,s);const c=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix"];ja(c);const h=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],u=["Material","Scene"];wt&&(wt.PrepareUniforms(c,s),wt.PrepareSamplers(h,s)),Ce.PrepareUniformsAndSamplersList({uniformsNames:c,uniformBuffersNames:u,samplers:h,defines:s,maxSimultaneousLights:this._maxSimultaneousLights});const d=s.toString(),f=r.getEngine().createEffect("background",{attributes:l,uniformsNames:c,uniformBuffersNames:u,samplers:h,defines:d,fallbacks:a,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights}},n);t.setEffect(f,s,this._materialContext),this.buildUniformLayout()}return!t.effect||!t.effect.isReady()?!1:(s._renderId=r.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,r.performancePriority!==la.BackwardCompatible&&(this.checkReadyOnlyOnce=!0),!0)}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){this._primaryColorShadowLevel===0&&this._primaryColorHighlightLevel===0||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){const r=this.getScene(),s=i.materialDefines;if(!s)return;const n=i.effect;if(!n)return;this._activeEffect=n,this.bindOnlyWorldMatrix(e),Ce.BindBonesParameters(t,this._activeEffect);const a=this._mustRebind(r,n,t.visibility);if(a){this._uniformBuffer.bindToEffect(n,"Material"),this.bindViewProjection(n);const l=this._reflectionTexture;(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync)&&(r.texturesEnabled&&(this._diffuseTexture&&Me.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),Ce.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse")),l&&Me.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",l.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",l.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),s.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),r.texturesEnabled&&(this._diffuseTexture&&Me.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),l&&Me.ReflectionTextureEnabled&&(s.REFLECTIONBLUR&&s.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",l):s.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",l._lodTextureMid||l),this._uniformBuffer.setTexture("reflectionSamplerLow",l._lodTextureLow||l),this._uniformBuffer.setTexture("reflectionSamplerHigh",l._lodTextureHigh||l)):this._uniformBuffer.setTexture("reflectionSampler",l),s.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w)))),Ra(this._activeEffect,this,r),r.bindEyePosition(n)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(n,"Material"),this._needToBindSceneUbo=!0);(a||!this.isFrozen)&&(r.lightsEnabled&&Ce.BindLights(r,t,this._activeEffect,s,this._maxSimultaneousLights),this.bindView(n),Ce.BindFogParameters(r,t,this._activeEffect,!0),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),this._uniformBuffer.update()}hasTexture(e){return!!(super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e)}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return ke.Clone(()=>new Gt(e,this.getScene()),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return ke.Parse(()=>new Gt(e.name,t),e,t,i)}}Gt.StandardReflectance0=.05;Gt.StandardReflectance90=.5;M([Kr()],Gt.prototype,"_primaryColor",void 0);M([Te("_markAllSubMeshesAsLightsDirty")],Gt.prototype,"primaryColor",void 0);M([Kr()],Gt.prototype,"__perceptualColor",void 0);M([F()],Gt.prototype,"_primaryColorShadowLevel",void 0);M([F()],Gt.prototype,"_primaryColorHighlightLevel",void 0);M([Te("_markAllSubMeshesAsLightsDirty")],Gt.prototype,"primaryColorHighlightLevel",null);M([Bt()],Gt.prototype,"_reflectionTexture",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Gt.prototype,"reflectionTexture",void 0);M([F()],Gt.prototype,"_reflectionBlur",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Gt.prototype,"reflectionBlur",void 0);M([Bt()],Gt.prototype,"_diffuseTexture",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Gt.prototype,"diffuseTexture",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Gt.prototype,"shadowLights",void 0);M([F()],Gt.prototype,"_shadowLevel",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Gt.prototype,"shadowLevel",void 0);M([Zs()],Gt.prototype,"_sceneCenter",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Gt.prototype,"sceneCenter",void 0);M([F()],Gt.prototype,"_opacityFresnel",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Gt.prototype,"opacityFresnel",void 0);M([F()],Gt.prototype,"_reflectionFresnel",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Gt.prototype,"reflectionFresnel",void 0);M([F()],Gt.prototype,"_reflectionFalloffDistance",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Gt.prototype,"reflectionFalloffDistance",void 0);M([F()],Gt.prototype,"_reflectionAmount",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Gt.prototype,"reflectionAmount",void 0);M([F()],Gt.prototype,"_reflectionReflectance0",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Gt.prototype,"reflectionReflectance0",void 0);M([F()],Gt.prototype,"_reflectionReflectance90",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Gt.prototype,"reflectionReflectance90",void 0);M([F()],Gt.prototype,"_useRGBColor",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Gt.prototype,"useRGBColor",void 0);M([F()],Gt.prototype,"_enableNoise",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Gt.prototype,"enableNoise",void 0);M([F()],Gt.prototype,"_maxSimultaneousLights",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],Gt.prototype,"maxSimultaneousLights",void 0);M([F()],Gt.prototype,"_shadowOnly",void 0);M([Te("_markAllSubMeshesAsLightsDirty")],Gt.prototype,"shadowOnly",void 0);M([Qx()],Gt.prototype,"_imageProcessingConfiguration",void 0);ye("BABYLON.BackgroundMaterial",Gt);class fc{static _GetDefaultOptions(){return{createGround:!0,groundSize:15,groundTexture:this._GroundTextureCDNUrl,groundColor:new ge(.2,.2,.3).toLinearSpace().scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this._SkyboxTextureCDNUrl,skyboxColor:new ge(.2,.2,.3).toLinearSpace().scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:x.Zero(),setupImageProcessing:!0,environmentTexture:this._EnvironmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this._rootMesh}get skybox(){return this._skybox}get skyboxTexture(){return this._skyboxTexture}get skyboxMaterial(){return this._skyboxMaterial}get ground(){return this._ground}get groundTexture(){return this._groundTexture}get groundMirror(){return this._groundMirror}get groundMirrorRenderList(){return this._groundMirror?this._groundMirror.renderList:null}get groundMaterial(){return this._groundMaterial}constructor(e,t){this._errorHandler=(i,r)=>{this.onErrorObservable.notifyObservers({message:i,exception:r})},this._options={...fc._GetDefaultOptions(),...e},this._scene=t,this.onErrorObservable=new Q,this._setupBackground(),this._setupImageProcessing()}updateOptions(e){const t={...this._options,...e};this._ground&&!t.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!t.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=t.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!t.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!t.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=t.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!t.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=t.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=t,this._setupBackground(),this._setupImageProcessing()}setMainColor(e){this.groundMaterial&&(this.groundMaterial.primaryColor=e),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=e),this.groundMirror&&(this.groundMirror.clearColor=new Ye(e.r,e.g,e.b,1))}_setupImageProcessing(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())}_setupEnvironmentTexture(){if(this._scene.environmentTexture)return;if(this._options.environmentTexture instanceof ni){this._scene.environmentTexture=this._options.environmentTexture;return}const e=ns.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=e}_setupBackground(){this._rootMesh||(this._rootMesh=new K("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;const e=this._getSceneSize();this._options.createGround&&(this._setupGround(e),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(e),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(e),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=e.rootPosition.x,this._rootMesh.position.z=e.rootPosition.z,this._rootMesh.position.y=e.rootPosition.y}_getSceneSize(){let e=this._options.groundSize,t=this._options.skyboxSize,i=this._options.rootPosition;if(!this._scene.meshes||this._scene.meshes.length===1)return{groundSize:e,skyboxSize:t,rootPosition:i};const r=this._scene.getWorldExtends(n=>n!==this._ground&&n!==this._rootMesh&&n!==this._skybox),s=r.max.subtract(r.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof Ei&&this._scene.activeCamera.upperRadiusLimit&&(e=this._scene.activeCamera.upperRadiusLimit*2,t=e);const n=s.length();n>e&&(e=n*2,t=e),e*=1.1,t*=1.5,i=r.min.add(s.scale(.5)),i.y=r.min.y-this._options.groundYBias}return{groundSize:e,skyboxSize:t,rootPosition:i}}_setupGround(e){(!this._ground||this._ground.isDisposed())&&(this._ground=om("BackgroundPlane",{size:e.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add(()=>{this._ground=null})),this._ground.receiveShadows=this._options.enableGroundShadow}_setupGroundMaterial(){this._groundMaterial||(this._groundMaterial=new Gt("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)}_setupGroundDiffuseTexture(){if(this._groundMaterial&&!this._groundTexture){if(this._options.groundTexture instanceof ni){this._groundMaterial.diffuseTexture=this._options.groundTexture;return}this._groundTexture=new Y(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture}}_setupGroundMirrorTexture(e){const t=Y.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new Hf("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,Y.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new Tn(0,-1,0,e.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=t,this._groundMirror.wrapV=t,this._groundMirror.renderList))for(let r=0;r<this._scene.meshes.length;r++){const s=this._scene.meshes[r];s!==this._ground&&s!==this._skybox&&s!==this._rootMesh&&this._groundMirror.renderList.push(s)}const i=this._options.groundColor.toGammaSpace();this._groundMirror.clearColor=new Ye(i.r,i.g,i.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel}_setupMirrorInGroundMaterial(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)}_setupSkybox(e){(!this._skybox||this._skybox.isDisposed())&&(this._skybox=bm("BackgroundSkybox",{size:e.skyboxSize,sideOrientation:K.BACKSIDE},this._scene),this._skybox.onDisposeObservable.add(()=>{this._skybox=null})),this._skybox.parent=this._rootMesh}_setupSkyboxMaterial(){this._skybox&&(this._skyboxMaterial||(this._skyboxMaterial=new Gt("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)}_setupSkyboxReflectionTexture(){if(this._skyboxMaterial&&!this._skyboxTexture){if(this._options.skyboxTexture instanceof ni){this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture;return}this._skyboxTexture=new ns(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=Y.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture}}dispose(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)}}fc._GroundTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundGround.png";fc._SkyboxTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundSkybox.dds";fc._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/environments/environmentSpecular.env";class En extends gt{get texture(){return this._texture}set texture(e){this._texture!==e&&(this._texture=e,this._useDirectMapping?(this._texture.wrapU=Y.CLAMP_ADDRESSMODE,this._texture.wrapV=Y.CLAMP_ADDRESSMODE,this._material.diffuseTexture=this._texture):(this._texture.coordinatesMode=Y.FIXED_EQUIRECTANGULAR_MIRRORED_MODE,this._texture.wrapV=Y.CLAMP_ADDRESSMODE,this._material.reflectionTexture=this._texture),this._changeTextureMode(this._textureMode))}get mesh(){return this._mesh}get fovMultiplier(){return this._material.fovMultiplier}set fovMultiplier(e){this._material.fovMultiplier=e}get textureMode(){return this._textureMode}set textureMode(e){this._textureMode!==e&&this._changeTextureMode(e)}get halfDome(){return this._halfDome}set halfDome(e){this._halfDome=e,this._halfDomeMask.setEnabled(e),this._changeTextureMode(this._textureMode)}set crossEye(e){this._crossEye=e,this._changeTextureMode(this._textureMode)}get crossEye(){return this._crossEye}get material(){return this._material}constructor(e,t,i,r,s=null){super(e,r),this.onError=s,this._halfDome=!1,this._crossEye=!1,this._useDirectMapping=!1,this._textureMode=En.MODE_MONOSCOPIC,this._onBeforeCameraRenderObserver=null,this.onLoadErrorObservable=new Q,this.onLoadObservable=new Q,r=this.getScene(),e=e||"textureDome",i.resolution=Math.abs(i.resolution)|0||32,i.clickToPlay=!!i.clickToPlay,i.autoPlay=i.autoPlay===void 0?!0:!!i.autoPlay,i.loop=i.loop===void 0?!0:!!i.loop,i.size=Math.abs(i.size)||(r.activeCamera?r.activeCamera.maxZ*.48:1e3),i.useDirectMapping===void 0?this._useDirectMapping=!0:this._useDirectMapping=i.useDirectMapping,i.faceForward===void 0&&(i.faceForward=!0),this._setReady(!1),i.mesh?this._mesh=i.mesh:this._mesh=jo(e+"_mesh",{segments:i.resolution,diameter:i.size,updatable:!1,sideOrientation:K.BACKSIDE},r);const n=this._material=new Gt(e+"_material",r);n.useEquirectangularFOV=!0,n.fovMultiplier=1,n.opacityFresnel=!1;const a=this._initTexture(t,r,i);if(this.texture=a,this._mesh.material=n,this._mesh.parent=this,this._halfDomeMask=jo("",{slice:.5,diameter:i.size*.98,segments:i.resolution*2,sideOrientation:K.BACKSIDE},r),this._halfDomeMask.rotate(As.X,-Math.PI/2),this._halfDomeMask.parent=this._mesh,this._halfDome=!!i.halfDomeMode,this._halfDomeMask.setEnabled(this._halfDome),this._crossEye=!!i.crossEyeMode,this._texture.anisotropicFilteringLevel=1,this._texture.onLoadObservable.addOnce(()=>{this._setReady(!0)}),i.faceForward&&r.activeCamera){const l=r.activeCamera,c=x.Forward(),h=x.TransformNormal(c,l.getViewMatrix());h.normalize(),this.rotation.y=Math.acos(x.Dot(c,h))}this._changeTextureMode(this._textureMode)}_changeTextureMode(e){switch(this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._textureMode=e,this._texture.uScale=1,this._texture.vScale=1,this._texture.uOffset=0,this._texture.vOffset=0,this._texture.vAng=0,e){case En.MODE_MONOSCOPIC:this._halfDome&&(this._texture.uScale=2,this._texture.uOffset=-1);break;case En.MODE_SIDEBYSIDE:{this._texture.uScale=this._halfDome?.99999:.5;const t=this._halfDome?0:.5,i=this._halfDome?-.5:0;this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(r=>{let s=r.isRightCamera;this._crossEye&&(s=!s),s?this._texture.uOffset=t:this._texture.uOffset=i});break}case En.MODE_TOPBOTTOM:this._texture.vScale=this._halfDome?.99999:.5,this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(t=>{let i=t.isRightCamera;this._crossEye&&(i=!i),this._texture.vOffset=i?.5:0});break}}dispose(e,t=!1){this._texture.dispose(),this._mesh.dispose(),this._material.dispose(),this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this.onLoadErrorObservable.clear(),this.onLoadObservable.clear(),super.dispose(e,t)}}En.MODE_MONOSCOPIC=0;En.MODE_TOPBOTTOM=1;En.MODE_SIDEBYSIDE=2;class Mm extends En{get photoTexture(){return this.texture}set photoTexture(e){this.texture=e}get imageMode(){return this.textureMode}set imageMode(e){this.textureMode=e}_initTexture(e,t,i){return new Y(e,t,!i.generateMipMaps,!this._useDirectMapping,void 0,()=>{this.onLoadObservable.notifyObservers()},(r,s)=>{this.onLoadErrorObservable.notifyObservers(r||"Unknown error occured"),this.onError&&this.onError(r,s)})}}Mm.MODE_MONOSCOPIC=En.MODE_MONOSCOPIC;Mm.MODE_TOPBOTTOM=En.MODE_TOPBOTTOM;Mm.MODE_SIDEBYSIDE=En.MODE_SIDEBYSIDE;const xP="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==";let TP=0;const Om=o=>{if(!o.environmentBRDFTexture){const e=o.useDelayedTextureLoading;o.useDelayedTextureLoading=!1;const t=o._blockEntityCollection;o._blockEntityCollection=!1;const i=Y.CreateFromBase64String(xP,"EnvironmentBRDFTexture"+TP++,o,!0,!1,Y.BILINEAR_SAMPLINGMODE);o._blockEntityCollection=t;const r=o.getEngine().getLoadedTexturesCache(),s=r.indexOf(i.getInternalTexture());s!==-1&&r.splice(s,1),i.isRGBD=!0,i.wrapU=Y.CLAMP_ADDRESSMODE,i.wrapV=Y.CLAMP_ADDRESSMODE,o.environmentBRDFTexture=i,o.useDelayedTextureLoading=e,gv.ExpandRGBDTexture(i);const n=o.getEngine().onContextRestoredObservable.add(()=>{i.isRGBD=!0;const a=()=>{i.isReady()?gv.ExpandRGBDTexture(i):J.SetImmediate(a)};a()});o.onDisposeObservable.add(()=>{o.getEngine().onContextRestoredObservable.remove(n)})}return o.environmentBRDFTexture};class EP extends Aa{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1}}class Ks extends yo{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}constructor(e,t=!0){super(e,"PBRBRDF",90,new EP,t),this._useEnergyConservation=Ks.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=Ks.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=Ks.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=Ks.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=Ks.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=Ks.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=Ks.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=Ks.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation}getClassName(){return"PBRBRDFConfiguration"}}Ks.DEFAULT_USE_ENERGY_CONSERVATION=!0;Ks.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0;Ks.DEFAULT_USE_SPHERICAL_HARMONICS=!0;Ks.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0;M([F(),Te("_markAllSubMeshesAsMiscDirty")],Ks.prototype,"useEnergyConservation",void 0);M([F(),Te("_markAllSubMeshesAsMiscDirty")],Ks.prototype,"useSmithVisibilityHeightCorrelated",void 0);M([F(),Te("_markAllSubMeshesAsMiscDirty")],Ks.prototype,"useSphericalHarmonics",void 0);M([F(),Te("_markAllSubMeshesAsMiscDirty")],Ks.prototype,"useSpecularGlossinessInputEnergyConservation",void 0);const bP="pbrFragmentDeclaration",SP=`uniform vec4 vEyePosition;
uniform vec3 vReflectionColor;
uniform vec4 vAlbedoColor;
uniform vec4 vLightingIntensity;
uniform vec4 vReflectivityColor;
uniform vec4 vMetallicReflectanceFactors;
uniform vec3 vEmissiveColor;
uniform float visibility;
uniform vec3 vAmbientColor;
#ifdef ALBEDO
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform vec4 vAmbientInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#ifdef OPACITY
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;
uniform vec3 vReflectionSize; 
#endif
#endif
#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)
uniform vec3 vRefractionPosition;
uniform vec3 vRefractionSize; 
#endif
#ifdef CLEARCOAT
uniform vec2 vClearCoatParams;
uniform vec4 vClearCoatRefractionParams;
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;
uniform vec2 vClearCoatTangentSpaceParams;
uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT
uniform vec4 vClearCoatTintParams;
uniform float clearCoatColorAtDistance;
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;
uniform mat4 clearCoatTintMatrix;
#endif
#endif
#endif
#ifdef IRIDESCENCE
uniform vec4 vIridescenceParams;
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
uniform vec3 vAnisotropy;
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;
uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
uniform vec4 vSheenColor;
#ifdef SHEEN_ROUGHNESS
uniform float vSheenRoughness;
#endif
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionMicrosurfaceInfos;
uniform vec4 vRefractionInfos;
uniform mat4 refractionMatrix;
#ifdef REALTIME_FILTERING
uniform vec2 vRefractionFilteringInfo;
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;
uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;
uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;
uniform mat4 translucencyIntensityMatrix;
#endif
uniform vec2 vThicknessParam;
uniform vec3 vDiffusionDistance;
uniform vec4 vTintColor;
uniform vec3 vSubSurfaceIntensity;
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;
uniform vec3 vSphericalL1_1;
uniform vec3 vSphericalL10;
uniform vec3 vSphericalL11;
uniform vec3 vSphericalL2_2;
uniform vec3 vSphericalL2_1;
uniform vec3 vSphericalL20;
uniform vec3 vSphericalL21;
uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;
uniform vec3 vSphericalY;
uniform vec3 vSphericalZ;
uniform vec3 vSphericalXX_ZZ;
uniform vec3 vSphericalYY_ZZ;
uniform vec3 vSphericalZZ;
uniform vec3 vSphericalXY;
uniform vec3 vSphericalYZ;
uniform vec3 vSphericalZX;
#endif
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;te.IncludesShadersStore[bP]=SP;const yP="pbrUboDeclaration",CP=`layout(std140,column_major) uniform;
uniform Material {
vec2 vAlbedoInfos;
vec4 vAmbientInfos;
vec2 vOpacityInfos;
vec2 vEmissiveInfos;
vec2 vLightmapInfos;
vec3 vReflectivityInfos;
vec2 vMicroSurfaceSamplerInfos;
vec2 vReflectionInfos;
vec2 vReflectionFilteringInfo;
vec3 vReflectionPosition;
vec3 vReflectionSize;
vec3 vBumpInfos;
mat4 albedoMatrix;
mat4 ambientMatrix;
mat4 opacityMatrix;
mat4 emissiveMatrix;
mat4 lightmapMatrix;
mat4 reflectivityMatrix;
mat4 microSurfaceSamplerMatrix;
mat4 bumpMatrix;
vec2 vTangentSpaceParams;
mat4 reflectionMatrix;
vec3 vReflectionColor;
vec4 vAlbedoColor;
vec4 vLightingIntensity;
vec3 vReflectionMicrosurfaceInfos;
float pointSize;
vec4 vReflectivityColor;
vec3 vEmissiveColor;
vec3 vAmbientColor;
vec2 vDebugMode;
vec4 vMetallicReflectanceFactors;
vec2 vMetallicReflectanceInfos;
mat4 metallicReflectanceMatrix;
vec2 vReflectanceInfos;
mat4 reflectanceMatrix;
vec3 vSphericalL00;
vec3 vSphericalL1_1;
vec3 vSphericalL10;
vec3 vSphericalL11;
vec3 vSphericalL2_2;
vec3 vSphericalL2_1;
vec3 vSphericalL20;
vec3 vSphericalL21;
vec3 vSphericalL22;
vec3 vSphericalX;
vec3 vSphericalY;
vec3 vSphericalZ;
vec3 vSphericalXX_ZZ;
vec3 vSphericalYY_ZZ;
vec3 vSphericalZZ;
vec3 vSphericalXY;
vec3 vSphericalYZ;
vec3 vSphericalZX;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;te.IncludesShadersStore[yP]=CP;const AP="pbrFragmentExtraDeclaration",RP=`varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
`;te.IncludesShadersStore[AP]=RP;const IP="samplerFragmentAlternateDeclaration",PP=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
#endif
`;te.IncludesShadersStore[IP]=PP;const MP="pbrFragmentSamplersDeclaration",OP=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D clearCoatRoughnessSampler;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D sheenRoughnessSampler;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;
uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
#define sampleRefraction(s,c) textureCube(s,c)
uniform samplerCube refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube refractionSamplerLow;
uniform samplerCube refractionSamplerHigh;
#endif
#else
#define sampleRefraction(s,c) texture2D(s,c)
uniform sampler2D refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D refractionSamplerLow;
uniform sampler2D refractionSamplerHigh;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#endif
`;te.IncludesShadersStore[MP]=OP;const DP="subSurfaceScatteringFunctions",NP=`bool testLightingForSSS(float diffusionProfile)
{
return diffusionProfile<1.;
}`;te.IncludesShadersStore[DP]=NP;const wP="importanceSampling",FP=`vec3 hemisphereCosSample(vec2 u) {
float phi=2.*PI*u.x;
float cosTheta2=1.-u.y;
float cosTheta=sqrt(cosTheta2);
float sinTheta=sqrt(1.-cosTheta2);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}
vec3 hemisphereImportanceSampleDggx(vec2 u,float a) {
float phi=2.*PI*u.x;
float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));
float cosTheta=sqrt(cosTheta2);
float sinTheta=sqrt(1.-cosTheta2);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}
vec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { 
float phi=2.*PI*u.x;
float sinTheta=pow(u.y,a/(2.*a+1.));
float cosTheta=sqrt(1.-sinTheta*sinTheta);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}`;te.IncludesShadersStore[wP]=FP;const LP="pbrHelperFunctions",BP=`#define RECIPROCAL_PI2 0.15915494
#define RECIPROCAL_PI 0.31830988618
#define MINIMUMVARIANCE 0.0005
float convertRoughnessToAverageSlope(float roughness)
{
return square(roughness)+MINIMUMVARIANCE;
}
float fresnelGrazingReflectance(float reflectance0) {
float reflectance90=saturate(reflectance0*25.0);
return reflectance90;
}
vec2 getAARoughnessFactors(vec3 normalVector) {
#ifdef SPECULARAA
vec3 nDfdx=dFdx(normalVector.xyz);
vec3 nDfdy=dFdy(normalVector.xyz);
float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));
float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);
float geometricAlphaGFactor=sqrt(slopeSquare);
geometricAlphaGFactor*=0.75;
return vec2(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2(0.);
#endif
}
#ifdef ANISOTROPIC
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {
float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);
float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);
return vec2(alphaT,alphaB);
}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy) {
vec3 anisotropicFrameDirection=anisotropy>=0.0 ? B : T;
vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);
vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);
vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));
return anisotropicNormal;
}
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
vec3 cocaLambert(vec3 alpha,float distance) {
return exp(-alpha*distance);
}
vec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {
return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));
}
vec3 computeColorAtDistanceInMedia(vec3 color,float distance) {
return -log(color)/distance;
}
vec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {
vec3 clearCoatAbsorption=mix(vec3(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);
return clearCoatAbsorption;
}
#endif
#ifdef MICROSURFACEAUTOMATIC
float computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)
{
const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;
float reflectivityLuminance=getLuminance(reflectivityColor);
float reflectivityLuma=sqrt(reflectivityLuminance);
microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;
return microSurface;
}
#endif
`;te.IncludesShadersStore[LP]=BP;const UP="harmonicsFunctions",VP=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
vec3 computeEnvironmentIrradiance(vec3 normal) {
return vSphericalL00
+ vSphericalL1_1*(normal.y)
+ vSphericalL10*(normal.z)
+ vSphericalL11*(normal.x)
+ vSphericalL2_2*(normal.y*normal.x)
+ vSphericalL2_1*(normal.y*normal.z)
+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ vSphericalL21*(normal.z*normal.x)
+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));
}
#else
vec3 computeEnvironmentIrradiance(vec3 normal) {
float Nx=normal.x;
float Ny=normal.y;
float Nz=normal.z;
vec3 C1=vSphericalZZ.rgb;
vec3 Cx=vSphericalX.rgb;
vec3 Cy=vSphericalY.rgb;
vec3 Cz=vSphericalZ.rgb;
vec3 Cxx_zz=vSphericalXX_ZZ.rgb;
vec3 Cyy_zz=vSphericalYY_ZZ.rgb;
vec3 Cxy=vSphericalXY.rgb;
vec3 Cyz=vSphericalYZ.rgb;
vec3 Czx=vSphericalZX.rgb;
vec3 a1=Cyy_zz*Ny+Cy;
vec3 a2=Cyz*Nz+a1;
vec3 b1=Czx*Nz+Cx;
vec3 b2=Cxy*Ny+b1;
vec3 b3=Cxx_zz*Nx+b2;
vec3 t1=Cz *Nz+C1;
vec3 t2=a2 *Ny+t1;
vec3 t3=b3 *Nx+t2;
return t3;
}
#endif
#endif
`;te.IncludesShadersStore[UP]=VP;const kP="pbrDirectLightingSetupFunctions",GP=`struct preLightingInfo
{
vec3 lightOffset;
float lightDistanceSquared;
float lightDistance;
float attenuation;
vec3 L;
vec3 H;
float NdotV;
float NdotLUnclamped;
float NdotL;
float VdotH;
float roughness;
#ifdef IRIDESCENCE
float iridescenceIntensity;
#endif
};
preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;
result.lightOffset=lightData.xyz-vPositionW;
result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);
result.lightDistance=sqrt(result.lightDistanceSquared);
result.L=normalize(result.lightOffset);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
result.NdotLUnclamped=dot(N,result.L);
result.NdotL=saturateEps(result.NdotLUnclamped);
return result;
}
preLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;
result.lightDistance=length(-lightData.xyz);
result.L=normalize(-lightData.xyz);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
result.NdotLUnclamped=dot(N,result.L);
result.NdotL=saturateEps(result.NdotLUnclamped);
return result;
}
preLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;
result.NdotL=dot(N,lightData.xyz)*0.5+0.5;
result.NdotL=saturateEps(result.NdotL);
result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
#endif
return result;
}`;te.IncludesShadersStore[kP]=GP;const zP="pbrDirectLightingFalloffFunctions",HP=`float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)
{
return max(0.,1.0-length(lightOffset)/range);
}
float computeDistanceLightFalloff_Physical(float lightDistanceSquared)
{
return 1.0/maxEps(lightDistanceSquared);
}
float computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)
{
float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);
float factor=lightDistanceSquared*inverseSquaredRange;
float attenuation=saturate(1.0-factor*factor);
attenuation*=attenuation;
lightDistanceFalloff*=attenuation;
return lightDistanceFalloff;
}
float computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
float computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)
{
float falloff=0.0;
float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));
if (cosAngle>=cosHalfAngle)
{
falloff=max(0.,pow(cosAngle,exponent));
}
return falloff;
}
float computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)
{
const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; 
float concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);
vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);
float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));
return falloff;
}
float computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)
{
float cd=dot(-lightDirection,directionToLightCenterW);
float falloff=saturate(cd*lightAngleScale+lightAngleOffset);
falloff*=falloff;
return falloff;
}
float computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;te.IncludesShadersStore[zP]=HP;const WP="pbrBRDFFunctions",XP=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);
}
#endif
#ifdef ENVIRONMENTBRDF
vec3 getBRDFLookup(float NdotV,float perceptualRoughness) {
vec2 UV=vec2(NdotV,perceptualRoughness);
vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup.rgb=fromRGBD(brdfLookup.rgba);
#endif
return brdfLookup.rgb;
}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;
}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;
}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
float getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)
{
float c=1.0-NdotV;
float c3=c*c*c;
return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));
}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
vec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{
float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);
return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));
}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
vec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {
vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;
return sheenEnvironmentReflectance;
}
#endif
vec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)
{
return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);
}
float fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)
{
return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);
}
#ifdef CLEARCOAT
vec3 getR0RemappedForClearCoat(vec3 f0) {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturate(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
vec3 s=sqrt(f0);
vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);
return square(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const mat3 XYZ_TO_REC709=mat3(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);
vec3 getIORTfromAirToSurfaceR0(vec3 f0) {
vec3 sqrtF0=sqrt(f0);
return (1.+sqrtF0)/(1.-sqrtF0);
}
vec3 getR0fromIORs(vec3 iorT,float iorI) {
return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));
}
float getR0fromIORs(float iorT,float iorI) {
return square((iorT-iorI)/(iorT+iorI));
}
vec3 evalSensitivity(float opd,vec3 shift) {
float phase=2.0*PI*opd*1.0e-9;
const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);
const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);
const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);
vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);
xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));
xyz/=1.0685e-7;
vec3 srgb=XYZ_TO_REC709*xyz;
return srgb;
}
vec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {
vec3 I=vec3(1.0);
float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));
float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));
float cosTheta2Sq=1.0-sinTheta2Sq;
if (cosTheta2Sq<0.0) {
return I;
}
float cosTheta2=sqrt(cosTheta2Sq);
float R0=getR0fromIORs(iridescenceIOR,outsideIOR);
float R12=fresnelSchlickGGX(cosTheta1,R0,1.);
float R21=R12;
float T121=1.0-R12;
float phi12=0.0;
if (iridescenceIOR<outsideIOR) phi12=PI;
float phi21=PI-phi12;
vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); 
vec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);
vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));
vec3 phi23=vec3(0.0);
if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;
if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;
if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;
float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;
vec3 phi=vec3(phi21)+phi23;
vec3 R123=clamp(R12*R23,1e-5,0.9999);
vec3 r123=sqrt(R123);
vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);
vec3 C0=R12+Rs;
I=C0;
vec3 Cm=Rs-T121;
for (int m=1; m<=2; ++m)
{
Cm*=r123;
vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);
I+=Cm*Sm;
}
return max(I,vec3(0.0));
}
#endif
float normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)
{
float a2=square(alphaG);
float d=NdotH*NdotH*(a2-1.0)+1.0;
return a2/(PI*d*d);
}
#ifdef SHEEN
float normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)
{
float invR=1./alphaG;
float cos2h=NdotH*NdotH;
float sin2h=1.-cos2h;
return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);
}
#endif
#ifdef ANISOTROPIC
float normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {
float a2=alphaTB.x*alphaTB.y;
vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);
float v2=dot(v,v);
float w2=a2/v2;
return a2*w2*w2*RECIPROCAL_PI;
}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {
#ifdef MOBILE
float GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);
float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);
return 0.5/(GGXV+GGXL);
#else
float a2=alphaG*alphaG;
float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);
float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);
return 0.5/(GGXV+GGXL);
#endif
}
#else
float smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
float alphaSquared=alphaG*alphaG;
return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
float smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)
{
float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);
return visibility;
}
#endif
#ifdef ANISOTROPIC
float smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {
float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));
float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));
float v=0.5/(lambdaV+lambdaL);
return v;
}
#endif
#ifdef CLEARCOAT
float visibility_Kelemen(float VdotH) {
return 0.25/(VdotH*VdotH); 
}
#endif
#ifdef SHEEN
float visibility_Ashikhmin(float NdotL,float NdotV)
{
return 1./(4.*(NdotL+NdotV-NdotL*NdotV));
}
/* NOT USED
#ifdef SHEEN_SOFTER
float l(float x,float alphaG)
{
float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);
float a=mix(21.5473,25.3245,oneMinusAlphaSq);
float b=mix(3.82987,3.32435,oneMinusAlphaSq);
float c=mix(0.19823,0.16801,oneMinusAlphaSq);
float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);
float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);
return a/(1.0+b*pow(x,c))+d*x+e;
}
float lambdaSheen(float cosTheta,float alphaG)
{
return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));
}
float visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)
{
float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));
return G/(4.0*NdotV*NdotL);
}
#endif
*/
#endif
float diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {
float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));
float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));
float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;
float fresnel =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);
return fresnel/PI;
}
#ifdef SS_TRANSLUCENCY
vec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {
vec3 S=1./maxEps(diffusionDistance);
vec3 temp=exp((-0.333333333*thickness)*S);
return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);
}
float computeWrappedDiffuseNdotL(float NdotL,float w) {
float t=1.0+w;
float invt2=1.0/square(t);
return saturate((NdotL+w)*invt2);
}
#endif
`;te.IncludesShadersStore[WP]=XP;const $P="hdrFilteringFunctions",YP=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
float radicalInverse_VdC(uint bits) 
{
bits=(bits<<16u) | (bits>>16u);
bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);
bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);
bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);
bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);
return float(bits)*2.3283064365386963e-10; 
}
vec2 hammersley(uint i,uint N)
{
return vec2(float(i)/float(N),radicalInverse_VdC(i));
}
#else
float vanDerCorpus(int n,int base)
{
float invBase=1.0/float(base);
float denom =1.0;
float result =0.0;
for(int i=0; i<32; ++i)
{
if(n>0)
{
denom =mod(float(n),2.0);
result+=denom*invBase;
invBase=invBase/2.0;
n =int(float(n)/2.0);
}
}
return result;
}
vec2 hammersley(int i,int N)
{
return vec2(float(i)/float(N),vanDerCorpus(i,2));
}
#endif
float log4(float x) {
return log2(x)/2.;
}
const float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);
const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;
const float K=4.;
#define inline
vec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{
vec3 n=normalize(inputN);
vec3 result=vec3(0.0);
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);
tangent=normalize(cross(tangent,n));
vec3 bitangent=cross(n,tangent);
mat3 tbn=mat3(tangent,bitangent,n);
float maxLevel=filteringInfo.y;
float dim0=filteringInfo.x;
float omegaP=(4.*PI)/(6.*dim0*dim0);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{
vec2 Xi=hammersley(i,NUM_SAMPLES);
vec3 Ls=hemisphereCosSample(Xi);
Ls=normalize(Ls);
vec3 Ns=vec3(0.,0.,1.);
float NoL=dot(Ns,Ls);
if (NoL>0.) {
float pdf_inversed=PI/NoL;
float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;
float l=log4(omegaS)-log4(omegaP)+log4(K);
float mipLevel=clamp(l,0.0,maxLevel);
vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c;
}
}
result=result*NUM_SAMPLES_FLOAT_INVERSED;
return result;
}
#define inline
vec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{
vec3 n=normalize(inputN);
if (alphaG==0.) {
vec3 c=textureCube(inputTexture,n).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;
} else {
vec3 result=vec3(0.);
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);
tangent=normalize(cross(tangent,n));
vec3 bitangent=cross(n,tangent);
mat3 tbn=mat3(tangent,bitangent,n);
float maxLevel=filteringInfo.y;
float dim0=filteringInfo.x;
float omegaP=(4.*PI)/(6.*dim0*dim0);
float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{
vec2 Xi=hammersley(i,NUM_SAMPLES);
vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);
float NoV=1.;
float NoH=H.z;
float NoH2=H.z*H.z;
float NoL=2.*NoH2-1.;
vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);
L=normalize(L);
if (NoL>0.) {
float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);
float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;
float l=log4(omegaS)-log4(omegaP)+log4(K);
float mipLevel=clamp(float(l),0.0,maxLevel);
weight+=NoL;
vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;
}
}
result=result/weight;
return result;
}
}
#endif
#endif
`;te.IncludesShadersStore[$P]=YP;const jP="pbrDirectLightingFunctions",KP=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{
vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef CLEARCOAT
vec4 clearCoat;
#endif
#ifdef SHEEN
vec3 sheen;
#endif
};
float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
float lightRoughness=lightRadius/lightDistance;
float totalRoughness=saturate(lightRoughness+roughness);
return totalRoughness;
#else
return roughness;
#endif
}
vec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {
return mix(groundColor,lightColor,info.NdotL);
}
vec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {
float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);
return diffuseTerm*info.attenuation*info.NdotL*lightColor;
}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){
vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);
strq/=strq.w;
vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;
return toLinearSpace(textureColor);
}
#ifdef SS_TRANSLUCENCY
vec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {
float NdotL=absEps(info.NdotLUnclamped);
float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);
float trAdapt=step(0.,info.NdotLUnclamped);
vec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);
float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);
return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;
}
#endif
#ifdef SPECULARTERM
vec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float roughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(roughness);
vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
float smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
vec3 specTerm=fresnel*distribution*smithVisibility;
return specTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
#ifdef ANISOTROPIC
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float TdotH=dot(T,info.H);
float BdotH=dot(B,info.H);
float TdotV=dot(T,V);
float BdotV=dot(B,V);
float TdotL=dot(T,info.L);
float BdotL=dot(B,info.L);
float alphaG=convertRoughnessToAverageSlope(info.roughness);
vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);
alphaTB=max(alphaTB,square(geometricRoughnessFactor));
vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);
float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);
vec3 specTerm=fresnel*distribution*smithVisibility;
return specTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
#ifdef CLEARCOAT
vec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {
float NccdotL=saturateEps(dot(Ncc,info.L));
float NccdotH=saturateEps(dot(Ncc,info.H));
float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);
fresnel*=clearCoatIntensity;
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);
float kelemenVisibility=visibility_Kelemen(info.VdotH);
float clearCoatTerm=fresnel*distribution*kelemenVisibility;
return vec4(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);
}
vec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {
vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);
float NdotLRefract=saturateEps(dot(Ncc,LRefract));
vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);
return absorption;
}
#endif
#ifdef SHEEN
vec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float roughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(roughness);
float fresnel=1.;
float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);
/*#ifdef SHEEN_SOFTER
float visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
float visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);
/* #endif */
float sheenTerm=fresnel*distribution*visibility;
return sheenTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
`;te.IncludesShadersStore[jP]=KP;const qP="pbrIBLFunctions",QP=`#if defined(REFLECTION) || defined(SS_REFRACTION)
float getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {
float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;
float lod=log2(microsurfaceAverageSlopeTexels);
return lod;
}
float getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {
float lod=log2(cubeMapDimensionPixels)*roughness;
return lod;
}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
float environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {
float temp=NdotVUnclamped+ambientOcclusion;
return saturate(square(temp)-1.0+ambientOcclusion);
}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
float environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {
vec3 reflection=reflect(view,normal);
float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));
return square(temp);
}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
#define UNPACK_LOD(x) (1.0-x)*255.0
float getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {
float microsurfaceAverageSlope=alphaG;
microsurfaceAverageSlope*=sqrt(abs(NdotV));
return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);
}
#endif
`;te.IncludesShadersStore[qP]=QP;const ZP="pbrBlockAlbedoOpacity",JP=`struct albedoOpacityOutParams
{
vec3 surfaceAlbedo;
float alpha;
};
#define pbr_inline
void albedoOpacityBlock(
in vec4 vAlbedoColor,
#ifdef ALBEDO
in vec4 albedoTexture,
in vec2 albedoInfos,
#endif
#ifdef OPACITY
in vec4 opacityMap,
in vec2 vOpacityInfos,
#endif
#ifdef DETAIL
in vec4 detailColor,
in vec4 vDetailInfos,
#endif
out albedoOpacityOutParams outParams
)
{
vec3 surfaceAlbedo=vAlbedoColor.rgb;
float alpha=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpace(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=vColor.rgb;
#endif
#ifdef DETAIL
float detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);
surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST
if (alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;
outParams.alpha=alpha;
}
`;te.IncludesShadersStore[ZP]=JP;const eM="pbrBlockReflectivity",tM=`struct reflectivityOutParams
{
float microSurface;
float roughness;
vec3 surfaceReflectivityColor;
#ifdef METALLICWORKFLOW
vec3 surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
vec3 ambientOcclusionColor;
#endif
#if DEBUGMODE>0
vec4 surfaceMetallicColorMap;
vec4 surfaceReflectivityColorMap;
vec2 metallicRoughness;
vec3 metallicF0;
#endif
};
#define pbr_inline
void reflectivityBlock(
in vec4 vReflectivityColor,
#ifdef METALLICWORKFLOW
in vec3 surfaceAlbedo,
in vec4 metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
in vec3 reflectivityInfos,
in vec4 surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
in vec3 ambientOcclusionColorIn,
#endif
#ifdef MICROSURFACEMAP
in vec4 microSurfaceTexel,
#endif
#ifdef DETAIL
in vec4 detailColor,
in vec4 vDetailInfos,
#endif
out reflectivityOutParams outParams
)
{
float microSurface=vReflectivityColor.a;
vec3 surfaceReflectivityColor=vReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec2 metallicRoughness=surfaceReflectivityColor.rg;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
vec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);
outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);
float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);
float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);
metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#if DEBUGMODE>0
outParams.metallicRoughness=metallicRoughness;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;
vec3 baseColor=surfaceAlbedo;
#ifdef FROSTBITE_REFLECTANCE
outParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);
surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);
#else
vec3 metallicF0=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=metallicF0;
#endif
outParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);
surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;
microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
#endif
microSurface=saturate(microSurface);
float roughness=1.-microSurface;
outParams.microSurface=microSurface;
outParams.roughness=roughness;
outParams.surfaceReflectivityColor=surfaceReflectivityColor;
}
`;te.IncludesShadersStore[eM]=tM;const iM="pbrBlockAmbientOcclusion",rM=`struct ambientOcclusionOutParams
{
vec3 ambientOcclusionColor;
#if DEBUGMODE>0
vec3 ambientOcclusionColorMap;
#endif
};
#define pbr_inline
void ambientOcclusionBlock(
#ifdef AMBIENT
in vec3 ambientOcclusionColorMap_,
in vec4 vAmbientInfos,
#endif
out ambientOcclusionOutParams outParams
)
{
vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;
}
`;te.IncludesShadersStore[iM]=rM;const sM="pbrBlockAlphaFresnel",nM=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{
float alpha;
};
#define pbr_inline
void alphaFresnelBlock(
in vec3 normalW,
in vec3 viewDirectionW,
in float alpha,
in float microSurface,
out alphaFresnelOutParams outParams
)
{
float opacityPerceptual=alpha;
#ifdef LINEARALPHAFRESNEL
float opacity0=opacityPerceptual;
#else
float opacity0=opacityPerceptual*opacityPerceptual;
#endif
float opacity90=fresnelGrazingReflectance(opacity0);
vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);
outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
}
#endif
#endif
`;te.IncludesShadersStore[sM]=nM;const aM="pbrBlockAnisotropic",oM=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{
float anisotropy;
vec3 anisotropicTangent;
vec3 anisotropicBitangent;
vec3 anisotropicNormal;
#if DEBUGMODE>0
vec3 anisotropyMapData;
#endif
};
#define pbr_inline
void anisotropicBlock(
in vec3 vAnisotropy,
#ifdef ANISOTROPIC_TEXTURE
in vec3 anisotropyMapData,
#endif
in mat3 TBN,
in vec3 normalW,
in vec3 viewDirectionW,
out anisotropicOutParams outParams
)
{
float anisotropy=vAnisotropy.b;
vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
anisotropy*=anisotropyMapData.b;
anisotropyDirection.rg*=anisotropyMapData.rg*2.0-1.0;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
#endif
mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));
vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);
vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));
outParams.anisotropy=anisotropy;
outParams.anisotropicTangent=anisotropicTangent;
outParams.anisotropicBitangent=anisotropicBitangent;
outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy);
}
#endif
`;te.IncludesShadersStore[aM]=oM;const lM="pbrBlockReflection",cM=`#ifdef REFLECTION
struct reflectionOutParams
{
vec4 environmentRadiance;
vec3 environmentIrradiance;
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords;
#else
vec2 reflectionCoords;
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
vec3 irradianceVector;
#endif
#endif
#endif
};
#define pbr_inline
void createReflectionCoords(
in vec3 vPositionW,
in vec3 normalW,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REFLECTIONMAP_3D
out vec3 reflectionCoords
#else
out vec2 reflectionCoords
#endif
)
{
#ifdef ANISOTROPIC
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
}
#define pbr_inline
#define inline
void sampleReflectionTexture(
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
const vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
const vec2 reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out vec4 environmentRadiance
)
{
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
float automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);
float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);
#else
float requestedReflectionLOD=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#else
float lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));
float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;
vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);
if (lodReflectionNormalizedDoubled<1.0){
environmentRadiance=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);
} else {
environmentRadiance=mix(
environmentMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);
}
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
environmentRadiance.rgb*=vReflectionInfos.x;
environmentRadiance.rgb*=vReflectionColor.rgb;
}
#define pbr_inline
#define inline
void reflectionBlock(
in vec3 vPositionW,
in vec3 normalW,
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
#else
in sampler2D reflectionSampler,
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
in vec3 vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
in mat4 reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
in samplerCube irradianceSampler,
#else
in sampler2D irradianceSampler,
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out reflectionOutParams outParams
)
{
vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.);
#else
vec2 reflectionCoords=vec2(0.);
#endif
createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
reflectionCoords
);
sampleReflectionTexture(
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
#ifdef REFLECTIONMAP_3D
reflectionSampler,
reflectionCoords,
#else
reflectionSampler,
reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentRadiance
);
vec3 environmentIrradiance=vec3(0.,0.,0.);
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#ifdef ANISOTROPIC
vec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;
#else
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);
environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb;
outParams.environmentRadiance=environmentRadiance;
outParams.environmentIrradiance=environmentIrradiance;
outParams.reflectionCoords=reflectionCoords;
}
#endif
`;te.IncludesShadersStore[lM]=cM;const hM="pbrBlockSheen",uM=`#ifdef SHEEN
struct sheenOutParams
{
float sheenIntensity;
vec3 sheenColor;
float sheenRoughness;
#ifdef SHEEN_LINKWITHALBEDO
vec3 surfaceAlbedo;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
float sheenAlbedoScaling;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 finalSheenRadianceScaled;
#endif
#if DEBUGMODE>0
vec4 sheenMapData;
vec3 sheenEnvironmentReflectance;
#endif
};
#define pbr_inline
#define inline
void sheenBlock(
in vec4 vSheenColor,
#ifdef SHEEN_ROUGHNESS
in float vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
in vec4 sheenMapRoughnessData,
#endif
#endif
in float roughness,
#ifdef SHEEN_TEXTURE
in vec4 sheenMapData,
in float sheenMapLevel,
#endif
in float reflectance,
#ifdef SHEEN_LINKWITHALBEDO
in vec3 baseColor,
in vec3 surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
in float NdotV,
in vec3 environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
in vec2 AARoughnessFactors,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
in vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
in vec2 reflectionCoords,
#endif
in float NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
in float seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
in float eho,
#endif
#endif
out sheenOutParams outParams
)
{
float sheenIntensity=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
float sheenFactor=pow5(1.0-sheenIntensity);
vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);
float sheenRoughness=sheenIntensity;
outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
vec3 sheenColor=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor.rgb*=toLinearSpace(sheenMapData.rgb);
#else
sheenColor.rgb*=sheenMapData.rgb;
#endif
sheenColor.rgb*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
float sheenRoughness=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
#ifdef SHEEN_TEXTURE_ROUGHNESS_IDENTICAL
sheenRoughness*=sheenMapData.a;
#else
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#endif
#else
float sheenRoughness=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
vec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
vec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);
#else
vec3 environmentSheenBrdf=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
float sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
vec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);
sampleReflectionTexture(
sheenAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
sheenRoughness,
#endif
reflectionSampler,
reflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentSheenRadiance
);
vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;
outParams.sheenColor=sheenColor;
outParams.sheenRoughness=sheenRoughness;
}
#endif
`;te.IncludesShadersStore[hM]=uM;const dM="pbrBlockClearcoat",fM=`struct clearcoatOutParams
{
vec3 specularEnvironmentR0;
float conservationFactor;
vec3 clearCoatNormalW;
vec2 clearCoatAARoughnessFactors;
float clearCoatIntensity;
float clearCoatRoughness;
#ifdef REFLECTION
vec3 finalClearCoatRadianceScaled;
#endif
#ifdef CLEARCOAT_TINT
vec3 absorption;
float clearCoatNdotVRefract;
vec3 clearCoatColor;
float clearCoatThickness;
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
vec3 energyConservationFactorClearCoat;
#endif
#if DEBUGMODE>0
mat3 TBNClearCoat;
vec2 clearCoatMapData;
vec4 clearCoatTintMapData;
vec4 environmentClearCoatRadiance;
float clearCoatNdotV;
vec3 clearCoatEnvironmentReflectance;
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
#define inline
void clearcoatBlock(
in vec3 vPositionW,
in vec3 geometricNormalW,
in vec3 viewDirectionW,
in vec2 vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
in vec4 clearCoatMapRoughnessData,
#endif
in vec3 specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
in vec2 clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
in vec4 vClearCoatTintParams,
in float clearCoatColorAtDistance,
in vec4 vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
in vec4 clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
in vec2 vClearCoatBumpInfos,
in vec4 clearCoatBumpMapData,
in vec2 vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
in mat3 vTBN,
#else
in vec2 vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
in mat4 normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
in vec3 faceNormal,
#endif
#ifdef REFLECTION
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
#else
in sampler2D reflectionSampler,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
in float ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
in float frontFacingMultiplier,
#endif
out clearcoatOutParams outParams
)
{
float clearCoatIntensity=vClearCoatParams.x;
float clearCoatRoughness=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL
clearCoatRoughness*=clearCoatMapData.y;
#else
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
#endif
outParams.clearCoatIntensity=clearCoatIntensity;
outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
vec3 clearCoatColor=vClearCoatTintParams.rgb;
float clearCoatThickness=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);
outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
vec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
vec3 specularEnvironmentR0Updated=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);
vec3 clearCoatNormalW=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
float clearCoatNormalScale=1.0;
#else
float clearCoatNormalScale=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBNClearCoat=vTBN;
#else
vec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;
mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);
clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;
outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);
float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);
float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
vec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);
outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
vec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
float clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
vec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);
vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 clearCoatReflectionCoords=clearCoatReflectionVector;
#else
vec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
sampleReflectionTexture(
clearCoatAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
clearCoatNdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
clearCoatRoughness,
#endif
reflectionSampler,
clearCoatReflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentClearCoatRadiance
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);
clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
vec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
float fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);
fresnelIBLClearCoat*=clearCoatIntensity;
outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
}
#endif
`;te.IncludesShadersStore[dM]=fM;const _M="pbrBlockIridescence",pM=`struct iridescenceOutParams
{
float iridescenceIntensity;
float iridescenceIOR;
float iridescenceThickness;
vec3 specularEnvironmentR0;
};
#ifdef IRIDESCENCE
#define pbr_inline
#define inline
void iridescenceBlock(
in vec4 vIridescenceParams,
in float viewAngle,
in vec3 specularEnvironmentR0,
#ifdef IRIDESCENCE_TEXTURE
in vec2 iridescenceMapData,
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
in vec2 iridescenceThicknessMapData,
#endif
#ifdef CLEARCOAT
in float NdotVUnclamped,
#ifdef CLEARCOAT_TEXTURE
in vec2 clearCoatMapData,
#endif
#endif
out iridescenceOutParams outParams
)
{
float iridescenceIntensity=vIridescenceParams.x;
float iridescenceIOR=vIridescenceParams.y;
float iridescenceThicknessMin=vIridescenceParams.z;
float iridescenceThicknessMax=vIridescenceParams.w;
float iridescenceThicknessWeight=1.;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#ifdef IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE
iridescenceThicknessWeight=iridescenceMapData.g;
#endif
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
float iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);
float topIor=1.; 
#ifdef CLEARCOAT
float clearCoatIntensity=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);
viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));
#endif
vec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);
outParams.iridescenceIntensity=iridescenceIntensity;
outParams.iridescenceThickness=iridescenceThickness;
outParams.iridescenceIOR=iridescenceIOR;
}
#endif
`;te.IncludesShadersStore[_M]=pM;const mM="pbrBlockSubSurface",gM=`struct subSurfaceOutParams
{
vec3 specularEnvironmentReflectance;
#ifdef SS_REFRACTION
vec3 finalRefraction;
vec3 surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
float alpha;
#endif
#ifdef REFLECTION
float refractionFactorForIrradiance;
#endif
#endif
#ifdef SS_TRANSLUCENCY
vec3 transmittance;
float translucencyIntensity;
#ifdef REFLECTION
vec3 refractionIrradiance;
#endif
#endif
#if DEBUGMODE>0
vec4 thicknessMap;
vec4 environmentRefraction;
vec3 refractionTransmittance;
#endif
};
#ifdef SUBSURFACE
#define pbr_inline
#define inline
void subSurfaceBlock(
in vec3 vSubSurfaceIntensity,
in vec2 vThicknessParam,
in vec4 vTintColor,
in vec3 normalW,
in vec3 specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
in vec4 thicknessMap,
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
in vec4 refractionIntensityMap,
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
in vec4 translucencyIntensityMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
in mat4 reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
in vec3 irradianceVector_,
#endif
#if defined(REALTIME_FILTERING)
in samplerCube reflectionSampler,
in vec2 vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
in samplerCube irradianceSampler,
#else
in sampler2D irradianceSampler,
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
in vec3 surfaceAlbedo,
#endif
#ifdef SS_REFRACTION
in vec3 vPositionW,
in vec3 viewDirectionW,
in mat4 view,
in vec4 vRefractionInfos,
in mat4 refractionMatrix,
in vec4 vRefractionMicrosurfaceInfos,
in vec4 vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
in float alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
in float NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
in float roughness,
#endif
in float alphaG,
#ifdef SS_REFRACTIONMAP_3D
in samplerCube refractionSampler,
#ifndef LODBASEDMICROSFURACE
in samplerCube refractionSamplerLow,
in samplerCube refractionSamplerHigh,
#endif
#else
in sampler2D refractionSampler,
#ifndef LODBASEDMICROSFURACE
in sampler2D refractionSamplerLow,
in sampler2D refractionSamplerHigh,
#endif
#endif
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
in vec2 vRefractionFilteringInfo,
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
in vec3 refractionPosition,
in vec3 refractionSize,
#endif
#endif
#ifdef SS_TRANSLUCENCY
in vec3 vDiffusionDistance,
#endif
out subSurfaceOutParams outParams
)
{
outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
float refractionIntensity=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);
outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
float translucencyIntensity=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#if defined(SS_USE_GLTF_TEXTURES)
float thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
float thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#ifdef SS_MASK_FROM_THICKNESS_TEXTURE
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE)
#if defined(SS_USE_GLTF_TEXTURES)
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE)
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
float thickness=vThicknessParam.y;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);
vec3 transmittance=transmittanceBRDF_Burley(vTintColor.rgb,vDiffusionDistance,thickness);
transmittance*=translucencyIntensity;
outParams.transmittance=transmittance;
outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef ANISOTROPIC
vec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,vRefractionInfos.y);
#else
vec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;
vec3 refractionCoords=refractionVector;
refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
#endif
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;
refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef SS_HAS_THICKNESS
float ior=vRefractionInfos.y;
#else
float ior=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
float refractionAlphaG=alphaG;
refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));
float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
float refractionRoughness=alphaG;
refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));
float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
float refractionAlphaG=alphaG;
refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));
float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
#ifdef LODBASEDMICROSFURACE
refractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
float automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);
float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);
#else
float requestedRefractionLOD=refractionLOD;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
float lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));
float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;
vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);
if (lodRefractionNormalizedDoubled<1.0){
environmentRefraction=mix(
sampleRefraction(refractionSamplerHigh,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);
} else {
environmentRefraction=mix(
environmentRefractionMid,
sampleRefraction(refractionSamplerLow,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);
}
#endif
#ifdef SS_RGBDREFRACTION
environmentRefraction.rgb=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
environmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);
#endif
environmentRefraction.rgb*=vRefractionInfos.x;
#endif
#ifdef SS_REFRACTION
vec3 refractionTransmittance=vec3(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);
refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
float maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);
vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);
environmentRefraction.rgb*=volumeAlbedo;
#else
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);
refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction.rgb*=surfaceAlbedo.rgb;
#endif
outParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);
#ifdef REFLECTION
outParams.refractionFactorForIrradiance=(1.-refractionIntensity);
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
vec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);
outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
refractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
vec3 irradianceVector=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
vec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);
#else
vec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec3 irradianceCoords=irradianceVector;
#else
vec2 irradianceCoords=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
vec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);
#ifdef RGBDREFLECTION
refractionIrradiance.rgb=fromRGBD(refractionIrradiance);
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);
#endif
#else
vec4 refractionIrradiance=vec4(0.);
#endif
refractionIrradiance.rgb*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance.rgb*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance.rgb;
#endif
}
#endif
`;te.IncludesShadersStore[mM]=gM;const vM="pbrBlockNormalGeometric",xM=`vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
vec3 geometricNormalW=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;
#endif
`;te.IncludesShadersStore[vM]=xM;const TM="pbrBlockNormalFinal",EM=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
`;te.IncludesShadersStore[TM]=EM;const bM="pbrBlockLightmapInit",SM=`#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor.rgb=toLinearSpace(lightmapColor.rgb);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
`;te.IncludesShadersStore[bM]=SM;const yM="pbrBlockGeometryInfo",CM=`float NdotVUnclamped=dot(normalW,viewDirectionW);
float NdotV=absEps(NdotVUnclamped);
float alphaG=convertRoughnessToAverageSlope(roughness);
vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
vec3 environmentBrdf=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
float ambientMonochrome=aoOut.ambientOcclusionColor.r;
#else
float ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);
#endif
float seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;te.IncludesShadersStore[yM]=CM;const AM="pbrBlockReflectance0",RM=`float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);
vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);
#else 
vec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);
#endif
#ifdef ALPHAFRESNEL
float reflectance90=fresnelGrazingReflectance(reflectance);
specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;te.IncludesShadersStore[AM]=RM;const IM="pbrBlockReflectance",PM=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);
#ifdef RADIANCEOCCLUSION
specularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
specularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
vec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
specularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
specularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;te.IncludesShadersStore[IM]=PM;const MM="pbrBlockDirectLighting",OM=`vec3 diffuseBase=vec3(0.,0.,0.);
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
#ifdef CLEARCOAT
vec3 clearCoatBase=vec3(0.,0.,0.);
#endif
#ifdef SHEEN
vec3 sheenBase=vec3(0.,0.,0.);
#endif
preLightingInfo preInfo;
lightingInfo info;
float shadow=1.; 
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
vec3 absorption=vec3(0.);
#endif
`;te.IncludesShadersStore[MM]=OM;const DM="pbrBlockFinalLitComponents",NM=`#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef REFLECTION
vec3 finalIrradiance=reflectionOut.environmentIrradiance;
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);
finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
finalIrradiance*=surfaceAlbedo.rgb;
finalIrradiance*=vLightingIntensity.z;
finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase;
finalSpecular=max(finalSpecular,0.0);
vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
vec3 finalRadiance=reflectionOut.environmentRadiance.rgb;
finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;
vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
vec3 finalSheen=sheenBase*sheenOut.sheenColor;
finalSheen=max(finalSheen,0.0);
vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
vec3 finalClearCoat=clearCoatBase;
finalClearCoat=max(finalClearCoat,0.0);
vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
float luminanceOverAlpha=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;te.IncludesShadersStore[DM]=NM;const wM="pbrBlockFinalUnlitComponents",FM=`vec3 finalDiffuse=diffuseBase;
finalDiffuse*=surfaceAlbedo.rgb;
finalDiffuse=max(finalDiffuse,0.0);
finalDiffuse*=vLightingIntensity.x;
vec3 finalAmbient=vAmbientColor;
finalAmbient*=surfaceAlbedo.rgb;
vec3 finalEmissive=vEmissiveColor;
#ifdef EMISSIVE
vec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpace(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= vEmissiveInfos.y;
#endif
finalEmissive*=vLightingIntensity.y;
#ifdef AMBIENT
vec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);
#else
vec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;
finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;te.IncludesShadersStore[wM]=FM;const LM="pbrBlockFinalColorComposition",BM=`vec4 finalColor=vec4(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor.rgb*=lightmapColor.rgb;
#else
finalColor.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
finalColor.rgb+=finalEmissive;
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,0.0);
`;te.IncludesShadersStore[LM]=BM;const UM="pbrBlockImageProcessing",VM=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor.rgb=clamp(finalColor.rgb,0.,30.0);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor.a*=visibility;
#ifdef PREMULTIPLYALPHA
finalColor.rgb*=finalColor.a;
#endif
`;te.IncludesShadersStore[UM]=VM;const kM="pbrDebug",GM=`#if DEBUGMODE>0
if (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {
#if DEBUGMODE==1
gl_FragColor.rgb=vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
gl_FragColor.rgb=vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
gl_FragColor.rgb=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
gl_FragColor.rgb=vec3(vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
gl_FragColor.rgb=vec3(vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
gl_FragColor.rgb=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
gl_FragColor.rgb=albedoTexture.rgb;
#elif DEBUGMODE==21 && defined(AMBIENT)
gl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
gl_FragColor.rgb=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
gl_FragColor.rgb=emissiveColorTex.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==24 && defined(LIGHTMAP)
gl_FragColor.rgb=lightmapColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
gl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
gl_FragColor.rgb=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
gl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
gl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
gl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
gl_FragColor.rgb=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
gl_FragColor.rgb=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
gl_FragColor.rgb=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
gl_FragColor.rgb=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==60
gl_FragColor.rgb=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
gl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
gl_FragColor.rgb=vec3(roughness);
#elif DEBUGMODE==64
gl_FragColor.rgb=vec3(alphaG);
#elif DEBUGMODE==65
gl_FragColor.rgb=vec3(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
gl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
gl_FragColor.rgb=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
gl_FragColor.rgb=vec3(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION)
gl_FragColor.rgb=vec3(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
gl_FragColor.rgb=vec3(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=specularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
gl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
gl_FragColor.rgb=vec3(luminanceOverAlpha);
#elif DEBUGMODE==87
gl_FragColor.rgb=vec3(alpha);
#endif
gl_FragColor.rgb*=vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
gl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
gl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);
#endif
gl_FragColor.a=1.0;
#ifdef PREPASS
gl_FragData[0]=toLinearSpace(gl_FragColor); 
gl_FragData[1]=vec4(0.,0.,0.,0.); 
#endif
return;
}
#endif
`;te.IncludesShadersStore[kM]=GM;const zM="pbrPixelShader",HM=`#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
precision highp float;
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<__decl__pbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
albedoOpacityOutParams albedoOpacityOut;
#ifdef ALBEDO
vec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
albedoOpacityBlock(
vAlbedoColor,
#ifdef ALBEDO
albedoTexture,
vAlbedoInfos,
#endif
#ifdef OPACITY
opacityMap,
vOpacityInfos,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
albedoOpacityOut
);
vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;
float alpha=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
ambientOcclusionOutParams aoOut;
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;
#endif
ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
vAmbientInfos,
#endif
aoOut
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
vec3 diffuseBase=vec3(1.,1.,1.);
#else
vec3 baseColor=surfaceAlbedo;
reflectivityOutParams reflectivityOut;
#if defined(REFLECTIVITY)
vec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);
vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;
#endif
#endif
#if defined(MICROSURFACEMAP)
vec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
vec4 metallicReflectanceFactors=vMetallicReflectanceFactors;
#ifdef REFLECTANCE
vec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);
#endif
metallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;
#endif
#ifdef METALLIC_REFLECTANCE
vec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;
#endif
metallicReflectanceFactors*=metallicReflectanceFactorsMap.a;
#endif
#endif
reflectivityBlock(
vReflectivityColor,
#ifdef METALLICWORKFLOW
surfaceAlbedo,
metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
vReflectivityInfos,
surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor,
#endif
#ifdef MICROSURFACEMAP
microSurfaceTexel,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
reflectivityOut
);
float microSurface=reflectivityOut.microSurface;
float roughness=reflectivityOut.roughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
alphaFresnelOutParams alphaFresnelOut;
alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface,
alphaFresnelOut
);
alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
anisotropicOutParams anisotropicOut;
#ifdef ANISOTROPIC_TEXTURE
vec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;
#endif
anisotropicBlock(
vAnisotropy,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW,
anisotropicOut
);
#endif
#ifdef REFLECTION
reflectionOutParams reflectionOut;
#ifndef USE_CUSTOM_REFLECTION
reflectionBlock(
vPositionW,
normalW,
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
reflectionSampler,
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
reflectionOut
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
sheenOutParams sheenOut;
#ifdef SHEEN_TEXTURE
vec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;
#endif
sheenBlock(
vSheenColor,
#ifdef SHEEN_ROUGHNESS
vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
sheenMapRoughnessData,
#endif
#endif
roughness,
#ifdef SHEEN_TEXTURE
sheenMapData,
vSheenInfos.y,
#endif
reflectance,
#ifdef SHEEN_LINKWITHALBEDO
baseColor,
surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
NdotV,
environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
AARoughnessFactors,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
reflectionOut.reflectionCoords,
NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
eho,
#endif
#endif
sheenOut
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
iridescenceOutParams iridescenceOut;
#ifdef IRIDESCENCE_TEXTURE
vec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
vec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;
#endif
iridescenceBlock(
vIridescenceParams,
NdotV,
specularEnvironmentR0,
#ifdef IRIDESCENCE_TEXTURE
iridescenceMapData,
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
iridescenceThicknessMapData,
#endif
#ifdef CLEARCOAT
NdotVUnclamped,
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData,
#endif
#endif
iridescenceOut
);
float iridescenceIntensity=iridescenceOut.iridescenceIntensity;
specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
clearcoatOutParams clearcoatOut;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
vec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);
#endif
clearcoatBlock(
vPositionW,
geometricNormalW,
viewDirectionW,
vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatMapRoughnessData,
#endif
specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
vClearCoatTintParams,
clearCoatColorAtDistance,
vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
vClearCoatBumpInfos,
clearCoatBumpMapData,
vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
vTBN,
#else
vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
faceNormal,
#endif
#ifdef REFLECTION
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
(gl_FrontFacing ? 1. : -1.),
#endif
clearcoatOut
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
subSurfaceOutParams subSurfaceOut;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
vec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
vec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);
#endif
subSurfaceBlock(
vSubSurfaceIntensity,
vThicknessParam,
vTintColor,
normalW,
specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
thicknessMap,
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
refractionIntensityMap,
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
translucencyIntensityMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionOut.irradianceVector,
#endif
#if defined(REALTIME_FILTERING)
reflectionSampler,
vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
surfaceAlbedo,
#endif
#ifdef SS_REFRACTION
vPositionW,
viewDirectionW,
view,
vRefractionInfos,
refractionMatrix,
vRefractionMicrosurfaceInfos,
vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
roughness,
#endif
alphaG,
refractionSampler,
#ifndef LODBASEDMICROSFURACE
refractionSamplerLow,
refractionSamplerHigh,
#endif
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
vRefractionFilteringInfo,
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
vRefractionPosition,
vRefractionSize,
#endif
#endif
#ifdef SS_TRANSLUCENCY
vDiffusionDistance,
#endif
subSurfaceOut
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=finalColor.a>0.4 ? 1.0 : 0.0;
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
vec3 sqAlbedo=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
vec3 irradiance=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
gl_FragData[0]=vec4(finalColor.rgb-irradiance,finalColor.a); 
irradiance/=sqAlbedo;
#else
gl_FragData[0]=finalColor; 
float scatteringDiffusionProfile=255.;
#endif
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); 
#else
gl_FragData[0]=vec4(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {
frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;
frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);
} else {
backColor+=finalColor;
}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;te.ShadersStore[zM]=HM;const WM="pbrVertexDeclaration",XM=`uniform mat4 view;
uniform mat4 viewProjection;
#ifdef ALBEDO
uniform mat4 albedoMatrix;
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;
uniform vec4 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
uniform mat4 lightmapMatrix;
#endif
#ifdef REFLECTIVITY 
uniform vec3 vReflectivityInfos;
uniform mat4 reflectivityMatrix;
#endif
#ifdef METALLIC_REFLECTANCE
uniform vec2 vMetallicReflectanceInfos;
uniform mat4 metallicReflectanceMatrix;
#endif
#ifdef REFLECTANCE
uniform vec2 vReflectanceInfos;
uniform mat4 reflectanceMatrix;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
uniform mat4 microSurfaceSamplerMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform mat4 bumpMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;
uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;
uniform mat4 clearCoatTintMatrix;
#endif
#endif
#ifdef IRIDESCENCE
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;
uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionInfos;
uniform mat4 refractionMatrix;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;
uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;
uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;
uniform mat4 translucencyIntensityMatrix;
#endif
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;
uniform vec3 vSphericalL1_1;
uniform vec3 vSphericalL10;
uniform vec3 vSphericalL11;
uniform vec3 vSphericalL2_2;
uniform vec3 vSphericalL2_1;
uniform vec3 vSphericalL20;
uniform vec3 vSphericalL21;
uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;
uniform vec3 vSphericalY;
uniform vec3 vSphericalZ;
uniform vec3 vSphericalXX_ZZ;
uniform vec3 vSphericalYY_ZZ;
uniform vec3 vSphericalZZ;
uniform vec3 vSphericalXY;
uniform vec3 vSphericalYZ;
uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
uniform mat4 detailMatrix;
#endif
#define ADDITIONAL_VERTEX_DECLARATION
`;te.IncludesShadersStore[WM]=XM;const $M="pbrVertexShader",YM=`precision highp float;
#include<__decl__pbrVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#endif
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
vPositionW=vec3(worldPos);
#include<prePassVertex>
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));
vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;te.ShadersStore[$M]=YM;class jM extends Aa{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class as extends yo{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRClearCoat",100,new jM,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=as._DefaultIndexOfRefraction,this.indexOfRefraction=as._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=ge.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;const r=this._material._disableBumpMap;return!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Me.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&Me.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||i.getCaps().standardDerivatives&&this._bumpTexture&&Me.ClearCoatBumpTextureEnabled&&!r&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&Me.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((i=this._textureRoughness)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Me.ClearCoatTextureEnabled?Ce.PrepareDefinesForMergedUV(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&Me.ClearCoatTextureEnabled?Ce.PrepareDefinesForMergedUV(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&Me.ClearCoatBumpTextureEnabled?Ce.PrepareDefinesForMergedUV(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===as._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&Me.ClearCoatTintTextureEnabled?(Ce.PrepareDefinesForMergedUV(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,r){var s,n,a,l,c,h,u,d;if(!this._isEnabled)return;const f=r.materialDefines,_=this._material.isFrozen,p=this._material._disableBumpMap,m=this._material._invertNormalMapX,T=this._material._invertNormalMapY,b=f.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL;if(!e.useUbo||!_||!e.isSync){b&&Me.ClearCoatTextureEnabled?(e.updateFloat4("vClearCoatInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),Ce.BindTextureMatrix(this._texture,e,"clearCoat")):(this._texture||this._textureRoughness)&&Me.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",(n=(s=this._texture)===null||s===void 0?void 0:s.coordinatesIndex)!==null&&n!==void 0?n:0,(l=(a=this._texture)===null||a===void 0?void 0:a.level)!==null&&l!==void 0?l:0,(h=(c=this._textureRoughness)===null||c===void 0?void 0:c.coordinatesIndex)!==null&&h!==void 0?h:0,(d=(u=this._textureRoughness)===null||u===void 0?void 0:u.level)!==null&&d!==void 0?d:0),this._texture&&Ce.BindTextureMatrix(this._texture,e,"clearCoat"),this._textureRoughness&&!b&&!f.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&Ce.BindTextureMatrix(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&Me.ClearCoatTextureEnabled&&!p&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),Ce.BindTextureMatrix(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",m?1:-1,T?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",m?-1:1,T?-1:1)),this._tintTexture&&Me.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),Ce.BindTextureMatrix(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const y=1-this._indexOfRefraction,S=1+this._indexOfRefraction,C=Math.pow(-y/S,2),I=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",C,I,y,S),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&Me.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!b&&!f.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&Me.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&Me.ClearCoatBumpTextureEnabled&&!p&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&Me.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){var t,i,r,s;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._textureRoughness)===null||i===void 0||i.dispose(),(r=this._bumpTexture)===null||r===void 0||r.dispose(),(s=this._tintTexture)===null||s===void 0||s.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}as._DefaultIndexOfRefraction=1.5;M([F(),Te("_markAllSubMeshesAsTexturesDirty")],as.prototype,"isEnabled",void 0);M([F()],as.prototype,"intensity",void 0);M([F()],as.prototype,"roughness",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],as.prototype,"indexOfRefraction",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],as.prototype,"texture",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],as.prototype,"useRoughnessFromMainTexture",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],as.prototype,"textureRoughness",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],as.prototype,"remapF0OnInterfaceChange",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],as.prototype,"bumpTexture",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],as.prototype,"isTintEnabled",void 0);M([Kr()],as.prototype,"tintColor",void 0);M([F()],as.prototype,"tintColorAtDistance",void 0);M([F()],as.prototype,"tintThickness",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],as.prototype,"tintTexture",void 0);class KM extends Aa{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0,this.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1}}class ln extends yo{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRIridescence",110,new KM,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=ln._DefaultMinimumThickness,this.maximumThickness=ln._DefaultMaximumThickness,this.indexOfRefraction=ln._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Me.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._thicknessTexture&&Me.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.IRIDESCENCE=!0,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=this._texture!==null&&this._texture._texture===((i=this._thicknessTexture)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._thicknessTexture),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Me.IridescenceTextureEnabled?Ce.PrepareDefinesForMergedUV(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,!e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&this._thicknessTexture&&Me.IridescenceTextureEnabled?Ce.PrepareDefinesForMergedUV(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t,i,r){var s,n,a,l,c,h,u,d;if(!this._isEnabled)return;const f=r.materialDefines,_=this._material.isFrozen,p=f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE;(!e.useUbo||!_||!e.isSync)&&(p&&Me.IridescenceTextureEnabled?(e.updateFloat4("vIridescenceInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),Ce.BindTextureMatrix(this._texture,e,"iridescence")):(this._texture||this._thicknessTexture)&&Me.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",(n=(s=this._texture)===null||s===void 0?void 0:s.coordinatesIndex)!==null&&n!==void 0?n:0,(l=(a=this._texture)===null||a===void 0?void 0:a.level)!==null&&l!==void 0?l:0,(h=(c=this._thicknessTexture)===null||c===void 0?void 0:c.coordinatesIndex)!==null&&h!==void 0?h:0,(d=(u=this._thicknessTexture)===null||u===void 0?void 0:u.level)!==null&&d!==void 0?d:0),this._texture&&Ce.BindTextureMatrix(this._texture,e,"iridescence"),this._thicknessTexture&&!p&&!f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&Ce.BindTextureMatrix(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&Me.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&!p&&!f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&Me.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){var t,i;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._thicknessTexture)===null||i===void 0||i.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}ln._DefaultMinimumThickness=100;ln._DefaultMaximumThickness=400;ln._DefaultIndexOfRefraction=1.3;M([F(),Te("_markAllSubMeshesAsTexturesDirty")],ln.prototype,"isEnabled",void 0);M([F()],ln.prototype,"intensity",void 0);M([F()],ln.prototype,"minimumThickness",void 0);M([F()],ln.prototype,"maximumThickness",void 0);M([F()],ln.prototype,"indexOfRefraction",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],ln.prototype,"texture",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],ln.prototype,"thicknessTexture",void 0);class qM extends Aa{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.MAINUV1=!1}}class Hu extends yo{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new qM,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new Ie(1,0),this._texture=null,this.texture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&Me.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking()):!0}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(O.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Me.AnisotropicTextureEnabled?Ce.PrepareDefinesForMergedUV(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.MAINUV1=!1)}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&(this._texture&&Me.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),Ce.BindTextureMatrix(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&Me.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}}M([F(),Te("_markAllSubMeshesAsTexturesDirty")],Hu.prototype,"isEnabled",void 0);M([F()],Hu.prototype,"intensity",void 0);M([Zp()],Hu.prototype,"direction",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],Hu.prototype,"texture",void 0);class QM extends Aa{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1}}class Co extends yo{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"Sheen",120,new QM,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=ge.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Me.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&Me.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=this._roughness!==null,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((i=this._textureRoughness)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Me.SheenTextureEnabled?(Ce.PrepareDefinesForMergedUV(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&Me.SheenTextureEnabled?Ce.PrepareDefinesForMergedUV(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,r){var s,n,a,l,c,h,u,d;if(!this._isEnabled)return;const f=r.materialDefines,_=this._material.isFrozen,p=f.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;(!e.useUbo||!_||!e.isSync)&&(p&&Me.SheenTextureEnabled?(e.updateFloat4("vSheenInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),Ce.BindTextureMatrix(this._texture,e,"sheen")):(this._texture||this._textureRoughness)&&Me.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",(n=(s=this._texture)===null||s===void 0?void 0:s.coordinatesIndex)!==null&&n!==void 0?n:0,(l=(a=this._texture)===null||a===void 0?void 0:a.level)!==null&&l!==void 0?l:0,(h=(c=this._textureRoughness)===null||c===void 0?void 0:c.coordinatesIndex)!==null&&h!==void 0?h:0,(d=(u=this._textureRoughness)===null||u===void 0?void 0:u.level)!==null&&d!==void 0?d:0),this._texture&&Ce.BindTextureMatrix(this._texture,e,"sheen"),this._textureRoughness&&!p&&!f.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&Ce.BindTextureMatrix(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),this._roughness!==null&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&Me.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!p&&!f.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&Me.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){var t,i;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._textureRoughness)===null||i===void 0||i.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}M([F(),Te("_markAllSubMeshesAsTexturesDirty")],Co.prototype,"isEnabled",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],Co.prototype,"linkSheenWithAlbedo",void 0);M([F()],Co.prototype,"intensity",void 0);M([Kr()],Co.prototype,"color",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],Co.prototype,"texture",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],Co.prototype,"useRoughnessFromMainTexture",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],Co.prototype,"roughness",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],Co.prototype,"textureRoughness",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],Co.prototype,"albedoScaling",void 0);class ZM extends Aa{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_SCATTERING=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_MASK_FROM_THICKNESS_TEXTURE=!1,this.SS_USE_GLTF_TEXTURES=!1}}class br extends yo{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){e>=1?this._volumeIndexOfRefraction=e:this._volumeIndexOfRefraction=-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}constructor(e,t=!0){super(e,"PBRSubSurface",130,new ZM,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=ge.White(),this.tintColorAtDistance=1,this.diffusionDistance=ge.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this._useGltfStyleTextures=!1,this.useGltfStyleTextures=!1,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&Me.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;const i=this._getRefractionTexture(t);if(i&&Me.RefractionTextureEnabled&&!i.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled){e.SUBSURFACE=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1;return}if(e._areTexturesDirty){e.SUBSURFACE=!0,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1;const i=!!this._thicknessTexture&&!!this._refractionIntensityTexture&&this._refractionIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._refractionIntensityTexture._texture===this._thicknessTexture._texture,r=!!this._thicknessTexture&&!!this._translucencyIntensityTexture&&this._translucencyIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._translucencyIntensityTexture._texture===this._thicknessTexture._texture,s=(i||!this._refractionIntensityTexture)&&(r||!this._translucencyIntensityTexture);if(e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&Me.ThicknessTextureEnabled&&Ce.PrepareDefinesForMergedUV(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&Me.RefractionIntensityTextureEnabled&&!s&&Ce.PrepareDefinesForMergedUV(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&Me.TranslucencyIntensityTextureEnabled&&!s&&Ce.PrepareDefinesForMergedUV(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!==0,e.SS_MASK_FROM_THICKNESS_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture||!!this._translucencyIntensityTexture)&&s,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture)&&s,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._translucencyIntensityTexture)&&s,this._isRefractionEnabled&&t.texturesEnabled){const n=this._getRefractionTexture(t);n&&Me.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=n.isCube,e.SS_GAMMAREFRACTION=n.gammaSpace,e.SS_RGBDREFRACTION=n.isRGBD,e.SS_LINEARSPECULARREFRACTION=n.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=n.invertZ,e.SS_LODINREFRACTIONALPHA=n.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=n.isCube&&n.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,r){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;r.getRenderingMesh().getWorldMatrix().decompose(j.Vector3[0]);const s=Math.max(Math.abs(j.Vector3[0].x),Math.abs(j.Vector3[0].y),Math.abs(j.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*s,(this.maximumThickness-this.minimumThickness)*s)}bindForSubMesh(e,t,i,r){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const s=r.materialDefines,n=this._material.isFrozen,a=this._material.realTimeFiltering,l=s.LODBASEDMICROSFURACE,c=this._getRefractionTexture(t);if(!e.useUbo||!n||!e.isSync){if(this._thicknessTexture&&Me.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),Ce.BindTextureMatrix(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&Me.RefractionIntensityTextureEnabled&&s.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),Ce.BindTextureMatrix(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyIntensityTexture&&Me.TranslucencyIntensityTextureEnabled&&s.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),Ce.BindTextureMatrix(this._translucencyIntensityTexture,e,"translucencyIntensity")),c&&Me.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",c.getReflectionTextureMatrix());let h=1;c.isCube||c.depth&&(h=c.depth);const u=c.getSize().width,d=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",c.level,1/d,h,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",u,c.lodGenerationScale,c.lodGenerationOffset,1/this.indexOfRefraction),a&&e.updateFloat2("vRefractionFilteringInfo",u,Ee.Log2(u)),c.boundingBoxSize){const f=c;e.updateVector3("vRefractionPosition",f.boundingBoxPosition),e.updateVector3("vRefractionSize",f.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0)}t.texturesEnabled&&(this._thicknessTexture&&Me.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&Me.RefractionIntensityTextureEnabled&&s.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&Me.TranslucencyIntensityTextureEnabled&&s.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),c&&Me.RefractionTextureEnabled&&(l?e.setTexture("refractionSampler",c):(e.setTexture("refractionSampler",c._lodTextureMid||c),e.setTexture("refractionSamplerLow",c._lodTextureLow||c),e.setTexture("refractionSamplerHigh",c._lodTextureHigh||c))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){Me.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e}hasRenderTargetTextures(){return!!(Me.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"}]}}}M([F(),Te("_markAllSubMeshesAsTexturesDirty")],br.prototype,"isRefractionEnabled",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],br.prototype,"isTranslucencyEnabled",void 0);M([F(),Te("_markScenePrePassDirty")],br.prototype,"isScatteringEnabled",void 0);M([F()],br.prototype,"_scatteringDiffusionProfileIndex",void 0);M([F()],br.prototype,"refractionIntensity",void 0);M([F()],br.prototype,"translucencyIntensity",void 0);M([F()],br.prototype,"useAlbedoToTintRefraction",void 0);M([F()],br.prototype,"useAlbedoToTintTranslucency",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],br.prototype,"thicknessTexture",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],br.prototype,"refractionTexture",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],br.prototype,"indexOfRefraction",void 0);M([F()],br.prototype,"_volumeIndexOfRefraction",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],br.prototype,"volumeIndexOfRefraction",null);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],br.prototype,"invertRefractionY",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],br.prototype,"linkRefractionWithTransparency",void 0);M([F()],br.prototype,"minimumThickness",void 0);M([F()],br.prototype,"maximumThickness",void 0);M([F()],br.prototype,"useThicknessAsDepth",void 0);M([Kr()],br.prototype,"tintColor",void 0);M([F()],br.prototype,"tintColorAtDistance",void 0);M([Kr()],br.prototype,"diffusionDistance",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],br.prototype,"useMaskFromThicknessTexture",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],br.prototype,"refractionIntensityTexture",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],br.prototype,"translucencyIntensityTexture",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],br.prototype,"useGltfStyleTextures",void 0);const Nc={effect:null,subMesh:null};class Gv extends Aa{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class ei extends Fu{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}constructor(e,t){super(e,t),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new Tt(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=ei.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=ge.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new ge(0,0,0),this._albedoColor=new ge(1,1,1),this._reflectivityColor=new ge(1,1,1),this._reflectionColor=new ge(1,1,1),this._emissiveColor=new ge(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=ei.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._forceAlphaTest=!1,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new Lr(16),this._globalAmbientColor=new ge(0,0,0),this._useLogarithmicDepth=!1,this._unlit=!1,this._debugMode=0,this.debugMode=0,this._debugLimit=-1,this._debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new Ks(this),this.clearCoat=new as(this),this.iridescence=new ln(this),this.anisotropy=new Hu(this),this.sheen=new Co(this),this.subSurface=new br(this),this.detailMap=new Gl(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),Me.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=Om(this.getScene()),this.prePassConfiguration=new Xd}get hasRenderTargetTextures(){return Me.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}get _disableAlphaBlending(){var e;return this._transparencyMode===ei.PBRMATERIAL_OPAQUE||this._transparencyMode===ei.PBRMATERIAL_ALPHATEST||((e=this.subSurface)===null||e===void 0?void 0:e.disableAlphaBlending)}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()}needAlphaTesting(){var e;return this._forceAlphaTest?!0:!((e=this.subSurface)===null||e===void 0)&&e.disableAlphaBlending?!1:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===ei.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==ei.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(Cs.GetDefineNames,this._eventInfo),t.materialDefines=new Gv(this._eventInfo.defineNames));const r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const s=this.getScene(),n=s.getEngine();if(r._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,s.texturesEnabled)){if(this._albedoTexture&&Me.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._ambientTexture&&Me.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&Me.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;const u=this._getReflectionTexture();if(u&&Me.ReflectionTextureEnabled&&(!u.isReadyOrNotBlocking()||u.irradianceTexture&&!u.irradianceTexture.isReadyOrNotBlocking())||this._lightmapTexture&&Me.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&Me.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(Me.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(n.getCaps().standardDerivatives&&this._bumpTexture&&Me.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&Me.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||r._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;!n.getCaps().standardDerivatives&&!e.isVerticesDataPresent(O.NormalKind)&&(e.createNormals(!0),X.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const a=t.effect,l=r._areLightsDisposed;let c=this._prepareEffect(e,r,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances),h=!1;if(c)if(this._onEffectCreatedObservable&&(Nc.effect=c,Nc.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Nc)),this.allowShaderHotSwapping&&a&&!c.isReady()){if(c=a,r.markAsUnprocessed(),h=this.isFrozen,l)return r._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(c,r,this._materialContext);return!t.effect||!t.effect.isReady()?!1:(r._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!h,t.effect._wasPreviouslyUsingInstances=!!i,s.performancePriority!==la.BackwardCompatible&&(this.checkReadyOnlyOnce=!0),!0)}isMetallicWorkflow(){return!!(this._metallic!=null||this._roughness!=null||this._metallicTexture)}_prepareEffect(e,t,i=null,r=null,s=null,n=null,a){if(this._prepareDefines(e,t,s,n,a),!t.isDirty)return null;t.markAsProcessed();const c=this.getScene().getEngine(),h=new pc;let u=0;t.USESPHERICALINVERTEX&&h.addFallback(u++,"USESPHERICALINVERTEX"),t.FOG&&h.addFallback(u,"FOG"),t.SPECULARAA&&h.addFallback(u,"SPECULARAA"),t.POINTSIZE&&h.addFallback(u,"POINTSIZE"),t.LOGARITHMICDEPTH&&h.addFallback(u,"LOGARITHMICDEPTH"),t.PARALLAX&&h.addFallback(u,"PARALLAX"),t.PARALLAXOCCLUSION&&h.addFallback(u++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&h.addFallback(u++,"ENVIRONMENTBRDF"),t.TANGENT&&h.addFallback(u++,"TANGENT"),t.BUMP&&h.addFallback(u++,"BUMP"),u=Ce.HandleFallbacksForShadows(t,h,this._maxSimultaneousLights,u++),t.SPECULARTERM&&h.addFallback(u++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&h.addFallback(u++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&h.addFallback(u++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&h.addFallback(u++,"LIGHTMAP"),t.NORMAL&&h.addFallback(u++,"NORMAL"),t.AMBIENT&&h.addFallback(u++,"AMBIENT"),t.EMISSIVE&&h.addFallback(u++,"EMISSIVE"),t.VERTEXCOLOR&&h.addFallback(u++,"VERTEXCOLOR"),t.MORPHTARGETS&&h.addFallback(u++,"MORPHTARGETS"),t.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");const d=[O.PositionKind];t.NORMAL&&d.push(O.NormalKind),t.TANGENT&&d.push(O.TangentKind);for(let S=1;S<=6;++S)t["UV"+S]&&d.push(`uv${S===1?"":S}`);t.VERTEXCOLOR&&d.push(O.ColorKind),t.INSTANCESCOLOR&&d.push(O.ColorInstanceKind),Ce.PrepareAttributesForBones(d,e,t,h),Ce.PrepareAttributesForInstances(d,t),Ce.PrepareAttributesForMorphTargets(d,e,t),Ce.PrepareAttributesForBakedVertexAnimation(d,e,t);let f="pbr";const _=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],p=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],m=["Material","Scene","Mesh"];this._eventInfo.fallbacks=h,this._eventInfo.fallbackRank=u,this._eventInfo.defines=t,this._eventInfo.uniforms=_,this._eventInfo.attributes=d,this._eventInfo.samplers=p,this._eventInfo.uniformBuffersNames=m,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._callbackPluginEventGeneric(Cs.PrepareEffect,this._eventInfo),Xd.AddUniforms(_),ja(_),wt&&(wt.PrepareUniforms(_,t),wt.PrepareSamplers(p,t)),Ce.PrepareUniformsAndSamplersList({uniformsNames:_,uniformBuffersNames:m,samplers:p,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});const T={};this.customShaderNameResolve&&(f=this.customShaderNameResolve(f,_,m,p,t,d,T));const b=t.toString(),y=c.createEffect(f,{attributes:d,uniformsNames:_,uniformBuffersNames:m,samplers:p,defines:b,fallbacks:h,onCompiled:i,onError:r,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS},processFinalCode:T.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS},c);return this._eventInfo.customCode=void 0,y}_prepareDefines(e,t,i=null,r=null,s=!1){var n;const a=this.getScene(),l=a.getEngine();Ce.PrepareDefinesForLights(a,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,Ce.PrepareDefinesForMultiview(a,t);const c=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(Ce.PrepareDefinesForPrePass(a,t,this.canRenderToMRT&&!c),Ce.PrepareDefinesForOIT(a,t,c),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){if(t._needUVs=!1,a.texturesEnabled){t.ALBEDODIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,l.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&Me.DiffuseTextureEnabled?(Ce.PrepareDefinesForMergedUV(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._ambientTexture&&Me.AmbientTextureEnabled?(Ce.PrepareDefinesForMergedUV(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&Me.OpacityTextureEnabled?(Ce.PrepareDefinesForMergedUV(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;const h=this._getReflectionTexture();if(h&&Me.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=h.gammaSpace,t.RGBDREFLECTION=h.isRGBD,t.LODINREFLECTIONALPHA=h.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=h.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,l._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0):t.REALTIME_FILTERING=!1,t.INVERTCUBICMAP=h.coordinatesMode===Y.INVCUBIC_MODE,t.REFLECTIONMAP_3D=h.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!h.invertZ:h.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,h.coordinatesMode){case Y.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case Y.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case Y.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case Y.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case Y.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case Y.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case Y.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case Y.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case Y.CUBIC_MODE:case Y.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!h.boundingBoxSize;break}h.coordinatesMode!==Y.SKYBOX_MODE&&(h.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1):h.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||l.getCaps().maxVaryingVectors<=8?t.USESPHERICALINVERTEX=!1:t.USESPHERICALINVERTEX=!0))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;if(this._lightmapTexture&&Me.LightmapTextureEnabled?(Ce.PrepareDefinesForMergedUV(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&Me.EmissiveTextureEnabled?(Ce.PrepareDefinesForMergedUV(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,Me.SpecularTextureEnabled){if(this._metallicTexture?(Ce.PrepareDefinesForMergedUV(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(Ce.PrepareDefinesForMergedUV(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture){const u=this._metallicReflectanceTexture!==null&&this._metallicReflectanceTexture._texture===((n=this._reflectanceTexture)===null||n===void 0?void 0:n._texture)&&this._metallicReflectanceTexture.checkTransformsAreIdentical(this._reflectanceTexture);t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture&&!u,this._metallicReflectanceTexture?(Ce.PrepareDefinesForMergedUV(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&!u&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(Ce.PrepareDefinesForMergedUV(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1}else t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1;this._microSurfaceTexture?Ce.PrepareDefinesForMergedUV(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1}else t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1;l.getCaps().standardDerivatives&&this._bumpTexture&&Me.BumpTextureEnabled&&!this._disableBumpMap?(Ce.PrepareDefinesForMergedUV(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&Me.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAXOCCLUSION=!1,t.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&Me.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?t.ALPHAFROMALBEDO=!0:t.ALPHAFROMALBEDO=!1}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===ei.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===ei.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?t.TWOSIDEDLIGHTING=!0:t.TWOSIDEDLIGHTING=!1,t.SPECULARAA=l.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1===0?".":""}`,t.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&(Ce.PrepareDefinesForMisc(e,a,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(O.NormalKind),t.DEBUGMODE=this._debugMode),Ce.PrepareDefinesForFrameBoundValues(a,l,this,t,!!i,r,s),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),Ce.PrepareDefinesForAttributes(e,t,!0,!0,!0,this._transparencyMode!==ei.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){const r={clipPlane:!1,useInstances:!1,...i};this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(Cs.GetDefineNames,this._eventInfo);const s=new Gv(this._eventInfo.defineNames),n=this._prepareEffect(e,s,void 0,void 0,r.useInstances,r.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(Nc.effect=n,Nc.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Nc)),n.isReady()?t&&t(this):n.onCompileObservable.add(()=>{t&&t(this)})}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var r,s,n,a;const l=this.getScene(),c=i.materialDefines;if(!c)return;const h=i.effect;if(!h)return;this._activeEffect=h,t.getMeshUniformBuffer().bindToEffect(h,"Mesh"),t.transferToEffect(e);const u=l.getEngine();this._uniformBuffer.bindToEffect(h,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,l,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),c.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const d=h._forceRebindOnNextCall||this._mustRebind(l,h,t.visibility);Ce.BindBonesParameters(t,this._activeEffect,this.prePassConfiguration);let f=null;const _=this._uniformBuffer;if(d){if(this.bindViewProjection(h),f=this._getReflectionTexture(),!_.useUbo||!this.isFrozen||!_.isSync||h._forceRebindOnNextCall){if(l.texturesEnabled){if(this._albedoTexture&&Me.DiffuseTextureEnabled&&(_.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),Ce.BindTextureMatrix(this._albedoTexture,_,"albedo")),this._ambientTexture&&Me.AmbientTextureEnabled&&(_.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),Ce.BindTextureMatrix(this._ambientTexture,_,"ambient")),this._opacityTexture&&Me.OpacityTextureEnabled&&(_.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),Ce.BindTextureMatrix(this._opacityTexture,_,"opacity")),f&&Me.ReflectionTextureEnabled){if(_.updateMatrix("reflectionMatrix",f.getReflectionTextureMatrix()),_.updateFloat2("vReflectionInfos",f.level,0),f.boundingBoxSize){const p=f;_.updateVector3("vReflectionPosition",p.boundingBoxPosition),_.updateVector3("vReflectionSize",p.boundingBoxSize)}if(this.realTimeFiltering){const p=f.getSize().width;_.updateFloat2("vReflectionFilteringInfo",p,Ee.Log2(p))}if(!c.USEIRRADIANCEMAP){const p=f.sphericalPolynomial;if(c.USESPHERICALFROMREFLECTIONMAP&&p)if(c.SPHERICAL_HARMONICS){const m=p.preScaledHarmonics;_.updateVector3("vSphericalL00",m.l00),_.updateVector3("vSphericalL1_1",m.l1_1),_.updateVector3("vSphericalL10",m.l10),_.updateVector3("vSphericalL11",m.l11),_.updateVector3("vSphericalL2_2",m.l2_2),_.updateVector3("vSphericalL2_1",m.l2_1),_.updateVector3("vSphericalL20",m.l20),_.updateVector3("vSphericalL21",m.l21),_.updateVector3("vSphericalL22",m.l22)}else _.updateFloat3("vSphericalX",p.x.x,p.x.y,p.x.z),_.updateFloat3("vSphericalY",p.y.x,p.y.y,p.y.z),_.updateFloat3("vSphericalZ",p.z.x,p.z.y,p.z.z),_.updateFloat3("vSphericalXX_ZZ",p.xx.x-p.zz.x,p.xx.y-p.zz.y,p.xx.z-p.zz.z),_.updateFloat3("vSphericalYY_ZZ",p.yy.x-p.zz.x,p.yy.y-p.zz.y,p.yy.z-p.zz.z),_.updateFloat3("vSphericalZZ",p.zz.x,p.zz.y,p.zz.z),_.updateFloat3("vSphericalXY",p.xy.x,p.xy.y,p.xy.z),_.updateFloat3("vSphericalYZ",p.yz.x,p.yz.y,p.yz.z),_.updateFloat3("vSphericalZX",p.zx.x,p.zx.y,p.zx.z)}_.updateFloat3("vReflectionMicrosurfaceInfos",f.getSize().width,f.lodGenerationScale,f.lodGenerationOffset)}this._emissiveTexture&&Me.EmissiveTextureEnabled&&(_.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),Ce.BindTextureMatrix(this._emissiveTexture,_,"emissive")),this._lightmapTexture&&Me.LightmapTextureEnabled&&(_.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),Ce.BindTextureMatrix(this._lightmapTexture,_,"lightmap")),Me.SpecularTextureEnabled&&(this._metallicTexture?(_.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),Ce.BindTextureMatrix(this._metallicTexture,_,"reflectivity")):this._reflectivityTexture&&(_.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),Ce.BindTextureMatrix(this._reflectivityTexture,_,"reflectivity")),this._metallicReflectanceTexture&&(_.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),Ce.BindTextureMatrix(this._metallicReflectanceTexture,_,"metallicReflectance")),this._reflectanceTexture&&c.REFLECTANCE&&(_.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),Ce.BindTextureMatrix(this._reflectanceTexture,_,"reflectance")),this._microSurfaceTexture&&(_.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),Ce.BindTextureMatrix(this._microSurfaceTexture,_,"microSurfaceSampler"))),this._bumpTexture&&u.getCaps().standardDerivatives&&Me.BumpTextureEnabled&&!this._disableBumpMap&&(_.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),Ce.BindTextureMatrix(this._bumpTexture,_,"bump"),l._mirroredCameraPosition?_.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):_.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&_.updateFloat("pointSize",this.pointSize),c.METALLICWORKFLOW){Jt.Color3[0].r=this._metallic===void 0||this._metallic===null?1:this._metallic,Jt.Color3[0].g=this._roughness===void 0||this._roughness===null?1:this._roughness,_.updateColor4("vReflectivityColor",Jt.Color3[0],1);const p=(s=(r=this.subSurface)===null||r===void 0?void 0:r._indexOfRefraction)!==null&&s!==void 0?s:1.5,m=1,T=Math.pow((p-m)/(p+m),2);this._metallicReflectanceColor.scaleToRef(T*this._metallicF0Factor,Jt.Color3[0]);const b=this._metallicF0Factor;_.updateColor4("vMetallicReflectanceFactors",Jt.Color3[0],b)}else _.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);_.updateColor3("vEmissiveColor",Me.EmissiveTextureEnabled?this._emissiveColor:ge.BlackReadOnly),_.updateColor3("vReflectionColor",this._reflectionColor),!c.SS_REFRACTION&&(!((n=this.subSurface)===null||n===void 0)&&n._linkRefractionWithTransparency)?_.updateColor4("vAlbedoColor",this._albedoColor,1):_.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*l.environmentIntensity,this._lightingInfos.w=this._specularIntensity,_.updateVector4("vLightingIntensity",this._lightingInfos),l.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),_.updateColor3("vAmbientColor",this._globalAmbientColor),_.updateFloat2("vDebugMode",this._debugLimit,this._debugFactor)}l.texturesEnabled&&(this._albedoTexture&&Me.DiffuseTextureEnabled&&_.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&Me.AmbientTextureEnabled&&_.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&Me.OpacityTextureEnabled&&_.setTexture("opacitySampler",this._opacityTexture),f&&Me.ReflectionTextureEnabled&&(c.LODBASEDMICROSFURACE?_.setTexture("reflectionSampler",f):(_.setTexture("reflectionSampler",f._lodTextureMid||f),_.setTexture("reflectionSamplerLow",f._lodTextureLow||f),_.setTexture("reflectionSamplerHigh",f._lodTextureHigh||f)),c.USEIRRADIANCEMAP&&_.setTexture("irradianceSampler",f.irradianceTexture)),c.ENVIRONMENTBRDF&&_.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&Me.EmissiveTextureEnabled&&_.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&Me.LightmapTextureEnabled&&_.setTexture("lightmapSampler",this._lightmapTexture),Me.SpecularTextureEnabled&&(this._metallicTexture?_.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&_.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&_.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&c.REFLECTANCE&&_.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&_.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&u.getCaps().standardDerivatives&&Me.BumpTextureEnabled&&!this._disableBumpMap&&_.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(h),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Ra(this._activeEffect,this,l),this.bindEyePosition(h)}else l.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(d||!this.isFrozen)&&(l.lightsEnabled&&!this._disableLighting&&Ce.BindLights(l,t,this._activeEffect,c,this._maxSimultaneousLights),(l.fogEnabled&&t.applyFog&&l.fogMode!==Ne.FOGMODE_NONE||f||t.receiveShadows||c.PREPASS)&&this.bindView(h),Ce.BindFogParameters(l,t,this._activeEffect,!0),c.NUM_MORPH_INFLUENCERS&&Ce.BindMorphTargetParameters(t,this._activeEffect),c.BAKED_VERTEX_ANIMATION_TEXTURE&&((a=t.bakedVertexAnimationManager)===null||a===void 0||a.bind(h,c.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),Ce.BindLogDepth(c,this._activeEffect,l)),this._afterBind(t,this._activeEffect),_.update()}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._albedoTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e)}setPrePassRenderer(){var e;if(!(!((e=this.subSurface)===null||e===void 0)&&e.isScatteringEnabled))return!1;const t=this.getScene().enableSubSurfaceForPrePass();return t&&(t.enabled=!0),!0}dispose(e,t){var i,r,s,n,a,l,c,h,u,d,f,_;t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),(i=this._albedoTexture)===null||i===void 0||i.dispose(),(r=this._ambientTexture)===null||r===void 0||r.dispose(),(s=this._opacityTexture)===null||s===void 0||s.dispose(),(n=this._reflectionTexture)===null||n===void 0||n.dispose(),(a=this._emissiveTexture)===null||a===void 0||a.dispose(),(l=this._metallicTexture)===null||l===void 0||l.dispose(),(c=this._reflectivityTexture)===null||c===void 0||c.dispose(),(h=this._bumpTexture)===null||h===void 0||h.dispose(),(u=this._lightmapTexture)===null||u===void 0||u.dispose(),(d=this._metallicReflectanceTexture)===null||d===void 0||d.dispose(),(f=this._reflectanceTexture)===null||f===void 0||f.dispose(),(_=this._microSurfaceTexture)===null||_===void 0||_.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}}ei.PBRMATERIAL_OPAQUE=me.MATERIAL_OPAQUE;ei.PBRMATERIAL_ALPHATEST=me.MATERIAL_ALPHATEST;ei.PBRMATERIAL_ALPHABLEND=me.MATERIAL_ALPHABLEND;ei.PBRMATERIAL_ALPHATESTANDBLEND=me.MATERIAL_ALPHATESTANDBLEND;ei.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0;ei.LIGHTFALLOFF_PHYSICAL=0;ei.LIGHTFALLOFF_GLTF=1;ei.LIGHTFALLOFF_STANDARD=2;M([Qx()],ei.prototype,"_imageProcessingConfiguration",void 0);M([Te("_markAllSubMeshesAsMiscDirty")],ei.prototype,"debugMode",void 0);M([F()],ei.prototype,"useLogarithmicDepth",null);class He extends ei{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===ei.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=ei.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=ei.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===ei.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=ei.LIGHTFALLOFF_GLTF:this._lightFalloff=ei.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}constructor(e,t){super(e,t),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=He.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=ge.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new ge(0,0,0),this.albedoColor=new ge(1,1,1),this.reflectivityColor=new ge(1,1,1),this.reflectionColor=new ge(1,1,1),this.emissiveColor=new ge(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this._environmentBRDFTexture=Om(this.getScene())}getClassName(){return"PBRMaterial"}clone(e){const t=ke.Clone(()=>new He(e,this.getScene()),this);return t.id=e,t.name=e,this.stencil.copyTo(t.stencil),this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const r=ke.Parse(()=>new He(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}He.PBRMATERIAL_OPAQUE=ei.PBRMATERIAL_OPAQUE;He.PBRMATERIAL_ALPHATEST=ei.PBRMATERIAL_ALPHATEST;He.PBRMATERIAL_ALPHABLEND=ei.PBRMATERIAL_ALPHABLEND;He.PBRMATERIAL_ALPHATESTANDBLEND=ei.PBRMATERIAL_ALPHATESTANDBLEND;He.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=ei.DEFAULT_AO_ON_ANALYTICAL_LIGHTS;M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"directIntensity",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"emissiveIntensity",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"environmentIntensity",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"specularIntensity",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"disableBumpMap",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"albedoTexture",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"ambientTexture",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"ambientTextureStrength",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"ambientTextureImpactOnAnalyticalLights",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesAndMiscDirty")],He.prototype,"opacityTexture",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"reflectionTexture",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"emissiveTexture",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"reflectivityTexture",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"metallicTexture",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"metallic",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"roughness",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"metallicF0Factor",void 0);M([Kr(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"metallicReflectanceColor",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"metallicReflectanceTexture",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"reflectanceTexture",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"microSurfaceTexture",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"bumpTexture",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty",null)],He.prototype,"lightmapTexture",void 0);M([Kr("ambient"),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"ambientColor",void 0);M([Kr("albedo"),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"albedoColor",void 0);M([Kr("reflectivity"),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"reflectivityColor",void 0);M([Kr("reflection"),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"reflectionColor",void 0);M([Kr("emissive"),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"emissiveColor",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"microSurface",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useLightmapAsShadowmap",void 0);M([F(),Te("_markAllSubMeshesAsTexturesAndMiscDirty")],He.prototype,"useAlphaFromAlbedoTexture",void 0);M([F(),Te("_markAllSubMeshesAsTexturesAndMiscDirty")],He.prototype,"forceAlphaTest",void 0);M([F(),Te("_markAllSubMeshesAsTexturesAndMiscDirty")],He.prototype,"alphaCutOff",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useSpecularOverAlpha",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useRoughnessFromMetallicTextureAlpha",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useRoughnessFromMetallicTextureGreen",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useMetallnessFromMetallicTextureBlue",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useAmbientInGrayScale",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0);M([F()],He.prototype,"usePhysicalLightFalloff",null);M([F()],He.prototype,"useGLTFLightFalloff",null);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useRadianceOverAlpha",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useObjectSpaceNormalMap",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useParallax",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useParallaxOcclusion",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"parallaxScaleBias",void 0);M([F(),Te("_markAllSubMeshesAsLightsDirty")],He.prototype,"disableLighting",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"forceIrradianceInFragment",void 0);M([F(),Te("_markAllSubMeshesAsLightsDirty")],He.prototype,"maxSimultaneousLights",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"invertNormalMapX",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"invertNormalMapY",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"twoSidedLighting",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useAlphaFresnel",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useLinearAlphaFresnel",void 0);M([Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"environmentBRDFTexture",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"forceNormalForward",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"enableSpecularAntiAliasing",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useHorizonOcclusion",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],He.prototype,"useRadianceOcclusion",void 0);M([F(),Te("_markAllSubMeshesAsMiscDirty")],He.prototype,"unlit",void 0);ye("BABYLON.PBRMaterial",He);const JM=542327876,zv=131072,Hv=512,Wv=4,Xv=64,$v=131072;function Wf(o){return o.charCodeAt(0)+(o.charCodeAt(1)<<8)+(o.charCodeAt(2)<<16)+(o.charCodeAt(3)<<24)}function eO(o){return String.fromCharCode(o&255,o>>8&255,o>>16&255,o>>24&255)}const Yv=Wf("DXT1"),jv=Wf("DXT3"),Kv=Wf("DXT5"),y_=Wf("DX10"),qv=113,Qv=116,Zv=2,Jv=10,tO=88,C_=31,iO=0,rO=1,ex=2,tx=3,A_=4,ix=7,R_=20,rx=21,sO=22,nO=23,aO=24,oO=25,lO=26,cO=28,hO=32;class xi{static GetDDSInfo(e){const t=new Int32Array(e.buffer,e.byteOffset,C_),i=new Int32Array(e.buffer,e.byteOffset,C_+4);let r=1;t[ex]&zv&&(r=Math.max(1,t[ix]));const s=t[rx],n=s===y_?i[hO]:0;let a=0;switch(s){case qv:a=2;break;case Qv:a=1;break;case y_:if(n===Jv){a=2;break}if(n===Zv){a=1;break}}return{width:t[A_],height:t[tx],mipmapCount:r,isFourCC:(t[R_]&Wv)===Wv,isRGB:(t[R_]&Xv)===Xv,isLuminance:(t[R_]&$v)===$v,isCube:(t[cO]&Hv)===Hv,isCompressed:s===Yv||s===jv||s===Kv,dxgiFormat:n,textureType:a}}static _GetHalfFloatAsFloatRGBAArrayBuffer(e,t,i,r,s,n){const a=new Float32Array(r),l=new Uint16Array(s,i);let c=0;for(let h=0;h<t;h++)for(let u=0;u<e;u++){const d=(u+h*e)*4;a[c]=so(l[d]),a[c+1]=so(l[d+1]),a[c+2]=so(l[d+2]),xi.StoreLODInAlphaChannel?a[c+3]=n:a[c+3]=so(l[d+3]),c+=4}return a}static _GetHalfFloatRGBAArrayBuffer(e,t,i,r,s,n){if(xi.StoreLODInAlphaChannel){const a=new Uint16Array(r),l=new Uint16Array(s,i);let c=0;for(let h=0;h<t;h++)for(let u=0;u<e;u++){const d=(u+h*e)*4;a[c]=l[d],a[c+1]=l[d+1],a[c+2]=l[d+2],a[c+3]=lo(n),c+=4}return a}return new Uint16Array(s,i,r)}static _GetFloatRGBAArrayBuffer(e,t,i,r,s,n){if(xi.StoreLODInAlphaChannel){const a=new Float32Array(r),l=new Float32Array(s,i);let c=0;for(let h=0;h<t;h++)for(let u=0;u<e;u++){const d=(u+h*e)*4;a[c]=l[d],a[c+1]=l[d+1],a[c+2]=l[d+2],a[c+3]=n,c+=4}return a}return new Float32Array(s,i,r)}static _GetFloatAsHalfFloatRGBAArrayBuffer(e,t,i,r,s,n){const a=new Uint16Array(r),l=new Float32Array(s,i);let c=0;for(let h=0;h<t;h++)for(let u=0;u<e;u++)a[c]=lo(l[c]),a[c+1]=lo(l[c+1]),a[c+2]=lo(l[c+2]),xi.StoreLODInAlphaChannel?a[c+3]=lo(n):a[c+3]=lo(l[c+3]),c+=4;return a}static _GetFloatAsUIntRGBAArrayBuffer(e,t,i,r,s,n){const a=new Uint8Array(r),l=new Float32Array(s,i);let c=0;for(let h=0;h<t;h++)for(let u=0;u<e;u++){const d=(u+h*e)*4;a[c]=Ee.Clamp(l[d])*255,a[c+1]=Ee.Clamp(l[d+1])*255,a[c+2]=Ee.Clamp(l[d+2])*255,xi.StoreLODInAlphaChannel?a[c+3]=n:a[c+3]=Ee.Clamp(l[d+3])*255,c+=4}return a}static _GetHalfFloatAsUIntRGBAArrayBuffer(e,t,i,r,s,n){const a=new Uint8Array(r),l=new Uint16Array(s,i);let c=0;for(let h=0;h<t;h++)for(let u=0;u<e;u++){const d=(u+h*e)*4;a[c]=Ee.Clamp(so(l[d]))*255,a[c+1]=Ee.Clamp(so(l[d+1]))*255,a[c+2]=Ee.Clamp(so(l[d+2]))*255,xi.StoreLODInAlphaChannel?a[c+3]=n:a[c+3]=Ee.Clamp(so(l[d+3]))*255,c+=4}return a}static _GetRGBAArrayBuffer(e,t,i,r,s,n,a,l,c){const h=new Uint8Array(r),u=new Uint8Array(s,i);let d=0;for(let f=0;f<t;f++)for(let _=0;_<e;_++){const p=(_+f*e)*4;h[d]=u[p+n],h[d+1]=u[p+a],h[d+2]=u[p+l],h[d+3]=u[p+c],d+=4}return h}static _ExtractLongWordOrder(e){return e===0||e===255||e===-16777216?0:1+xi._ExtractLongWordOrder(e>>8)}static _GetRGBArrayBuffer(e,t,i,r,s,n,a,l){const c=new Uint8Array(r),h=new Uint8Array(s,i);let u=0;for(let d=0;d<t;d++)for(let f=0;f<e;f++){const _=(f+d*e)*3;c[u]=h[_+n],c[u+1]=h[_+a],c[u+2]=h[_+l],u+=3}return c}static _GetLuminanceArrayBuffer(e,t,i,r,s){const n=new Uint8Array(r),a=new Uint8Array(s,i);let l=0;for(let c=0;c<t;c++)for(let h=0;h<e;h++){const u=h+c*e;n[l]=a[u],l++}return n}static UploadDDSLevels(e,t,i,r,s,n,a=-1,l,c=!0){let h=null;r.sphericalPolynomial&&(h=new Array);const u=!!e.getCaps().s3tc;t.generateMipMaps=s;const d=new Int32Array(i.buffer,i.byteOffset,C_);let f,_,p,m=0,T,b,y,S,C=0,I=1;if(d[iO]!==JM){X.Error("Invalid magic number in DDS header");return}if(!r.isFourCC&&!r.isRGB&&!r.isLuminance){X.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");return}if(r.isCompressed&&!u){X.Error("Compressed textures are not supported on this platform.");return}let P=d[sO];T=d[rO]+4;let D=!1;if(r.isFourCC)switch(f=d[rx],f){case Yv:I=8,C=33777;break;case jv:I=16,C=33778;break;case Kv:I=16,C=33779;break;case qv:D=!0,P=64;break;case Qv:D=!0,P=128;break;case y_:{T+=5*4;let _e=!1;switch(r.dxgiFormat){case Jv:D=!0,P=64,_e=!0;break;case Zv:D=!0,P=128,_e=!0;break;case tO:r.isRGB=!0,r.isFourCC=!1,P=32,_e=!0;break}if(_e)break}default:console.error("Unsupported FourCC code:",eO(f));return}const w=xi._ExtractLongWordOrder(d[nO]),L=xi._ExtractLongWordOrder(d[aO]),U=xi._ExtractLongWordOrder(d[oO]),G=xi._ExtractLongWordOrder(d[lO]);D&&(C=e._getRGBABufferInternalSizedFormat(r.textureType)),y=1,d[ex]&zv&&s!==!1&&(y=Math.max(1,d[ix]));const Z=l||0,he=e.getCaps();for(let _e=Z;_e<n;_e++){for(_=d[A_],p=d[tx],S=0;S<y;++S){if(a===-1||a===S){const ne=a===-1?S:0;if(!r.isCompressed&&r.isFourCC){t.format=5,m=_*p*4;let Pe=null;if(e._badOS||e._badDesktopOS||!he.textureHalfFloat&&!he.textureFloat)P===128?(Pe=xi._GetFloatAsUIntRGBAArrayBuffer(_,p,i.byteOffset+T,m,i.buffer,ne),h&&ne==0&&h.push(xi._GetFloatRGBAArrayBuffer(_,p,i.byteOffset+T,m,i.buffer,ne))):P===64&&(Pe=xi._GetHalfFloatAsUIntRGBAArrayBuffer(_,p,i.byteOffset+T,m,i.buffer,ne),h&&ne==0&&h.push(xi._GetHalfFloatAsFloatRGBAArrayBuffer(_,p,i.byteOffset+T,m,i.buffer,ne))),t.type=0;else{const Se=he.textureFloat&&(c&&he.textureFloatLinearFiltering||!c),ce=he.textureHalfFloat&&(c&&he.textureHalfFloatLinearFiltering||!c),de=(P===128||P===64&&!ce)&&Se?1:(P===64||P===128&&!Se)&&ce?2:0;let k,se=null;switch(P){case 128:{switch(de){case 1:k=xi._GetFloatRGBAArrayBuffer,se=null;break;case 2:k=xi._GetFloatAsHalfFloatRGBAArrayBuffer,se=xi._GetFloatRGBAArrayBuffer;break;case 0:k=xi._GetFloatAsUIntRGBAArrayBuffer,se=xi._GetFloatRGBAArrayBuffer;break}break}default:{switch(de){case 1:k=xi._GetHalfFloatAsFloatRGBAArrayBuffer,se=null;break;case 2:k=xi._GetHalfFloatRGBAArrayBuffer,se=xi._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:k=xi._GetHalfFloatAsUIntRGBAArrayBuffer,se=xi._GetHalfFloatAsFloatRGBAArrayBuffer;break}break}}t.type=de,Pe=k(_,p,i.byteOffset+T,m,i.buffer,ne),h&&ne==0&&h.push(se?se(_,p,i.byteOffset+T,m,i.buffer,ne):Pe)}Pe&&e._uploadDataToTextureDirectly(t,Pe,_e,ne)}else if(r.isRGB)t.type=0,P===24?(t.format=4,m=_*p*3,b=xi._GetRGBArrayBuffer(_,p,i.byteOffset+T,m,i.buffer,w,L,U),e._uploadDataToTextureDirectly(t,b,_e,ne)):(t.format=5,m=_*p*4,b=xi._GetRGBAArrayBuffer(_,p,i.byteOffset+T,m,i.buffer,w,L,U,G),e._uploadDataToTextureDirectly(t,b,_e,ne));else if(r.isLuminance){const Pe=e._getUnpackAlignement(),Se=_;m=Math.floor((_+Pe-1)/Pe)*Pe*(p-1)+Se,b=xi._GetLuminanceArrayBuffer(_,p,i.byteOffset+T,m,i.buffer),t.format=1,t.type=0,e._uploadDataToTextureDirectly(t,b,_e,ne)}else m=Math.max(4,_)/4*Math.max(4,p)/4*I,b=new Uint8Array(i.buffer,i.byteOffset+T,m),t.type=0,e._uploadCompressedDataToTextureDirectly(t,C,_,p,b,_e,ne)}T+=P?_*p*(P/8):m,_*=.5,p*=.5,_=Math.max(1,_),p=Math.max(1,p)}if(l!==void 0)break}h&&h.length>0?r.sphericalPolynomial=Uf.ConvertCubeMapToSphericalPolynomial({size:d[A_],right:h[0],left:h[1],up:h[2],down:h[3],front:h[4],back:h[5],format:5,type:1,gammaSpace:!1}):r.sphericalPolynomial=void 0}}xi.StoreLODInAlphaChannel=!1;ze.prototype.createPrefilteredCubeTexture=function(o,e,t,i,r=null,s=null,n,a=null,l=!0){const c=h=>{if(!h){r&&r(null);return}const u=h.texture;if(l?h.info.sphericalPolynomial&&(u._sphericalPolynomial=h.info.sphericalPolynomial):u._sphericalPolynomial=new Ko,u._source=bt.CubePrefiltered,this.getCaps().textureLOD){r&&r(u);return}const d=3,f=this._gl,_=h.width;if(!_)return;const p=[];for(let m=0;m<d;m++){const b=1-m/(d-1),y=i,S=Ee.Log2(_)*t+i,C=y+(S-y)*b,I=Math.round(Math.min(Math.max(C,0),S)),P=new hi(this,bt.Temp);if(P.type=u.type,P.format=u.format,P.width=Math.pow(2,Math.max(Ee.Log2(_)-I,0)),P.height=P.width,P.isCube=!0,P._cachedWrapU=0,P._cachedWrapV=0,this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,P,!0),P.samplingMode=2,f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MIN_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),h.isDDS){const w=h.info,L=h.data;this._unpackFlipY(w.isCompressed),xi.UploadDDSLevels(this,P,L,w,!0,6,I)}else X.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,null);const D=new ni(e);D._isCube=!0,D._texture=P,P.isReady=!0,p.push(D)}u._lodTextureHigh=p[2],u._lodTextureMid=p[1],u._lodTextureLow=p[0],r&&r(u)};return this.createCubeTexture(o,e,null,!1,c,s,n,a,l,t,i)};class uO{constructor(){this.supportCascades=!0}canLoad(e){return e.endsWith(".dds")}loadCubeData(e,t,i,r){const s=t.getEngine();let n,a=!1,l=1e3;if(Array.isArray(e))for(let c=0;c<e.length;c++){const h=e[c];n=xi.GetDDSInfo(h),t.width=n.width,t.height=n.height,a=(n.isRGB||n.isLuminance||n.mipmapCount>1)&&t.generateMipMaps,s._unpackFlipY(n.isCompressed),xi.UploadDDSLevels(s,t,h,n,a,6,-1,c),!n.isFourCC&&n.mipmapCount===1?s.generateMipMapsForCubemap(t):l=n.mipmapCount-1}else{const c=e;n=xi.GetDDSInfo(c),t.width=n.width,t.height=n.height,i&&(n.sphericalPolynomial=new Ko),a=(n.isRGB||n.isLuminance||n.mipmapCount>1)&&t.generateMipMaps,s._unpackFlipY(n.isCompressed),xi.UploadDDSLevels(s,t,c,n,a,6),!n.isFourCC&&n.mipmapCount===1?s.generateMipMapsForCubemap(t,!1):l=n.mipmapCount-1}s._setCubeMapTextureParams(t,a,l),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r({isDDS:!0,width:t.width,info:n,data:e,texture:t})}loadData(e,t,i){const r=xi.GetDDSInfo(e),s=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&t.generateMipMaps&&r.width>>r.mipmapCount-1===1;i(r.width,r.height,s,r.isFourCC,()=>{xi.UploadDDSLevels(t.getEngine(),t,e,r,s,1)})}}q._TextureLoaders.push(new uO);class dO{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".env")}loadCubeData(e,t,i,r,s){if(Array.isArray(e))return;const n=nE(e);if(n){t.width=n.width,t.height=n.width;try{oE(t,n),TR(t,e,n).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r()},a=>{s==null||s("Can not upload environment levels",a)})}catch(a){s==null||s("Can not upload environment file",a)}}else s&&s("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}q._TextureLoaders.push(new dO);class ha{constructor(e,t){if(this.data=e,this.isInvalid=!1,!ha.IsValid(e)){this.isInvalid=!0,X.Error("texture missing KTX identifier");return}const i=Uint32Array.BYTES_PER_ELEMENT,r=new DataView(this.data.buffer,this.data.byteOffset+12,13*i),n=r.getUint32(0,!0)===67305985;if(this.glType=r.getUint32(1*i,n),this.glTypeSize=r.getUint32(2*i,n),this.glFormat=r.getUint32(3*i,n),this.glInternalFormat=r.getUint32(4*i,n),this.glBaseInternalFormat=r.getUint32(5*i,n),this.pixelWidth=r.getUint32(6*i,n),this.pixelHeight=r.getUint32(7*i,n),this.pixelDepth=r.getUint32(8*i,n),this.numberOfArrayElements=r.getUint32(9*i,n),this.numberOfFaces=r.getUint32(10*i,n),this.numberOfMipmapLevels=r.getUint32(11*i,n),this.bytesOfKeyValueData=r.getUint32(12*i,n),this.glType!==0){X.Error("only compressed formats currently supported");return}else this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels);if(this.pixelHeight===0||this.pixelDepth!==0){X.Error("only 2D textures currently supported");return}if(this.numberOfArrayElements!==0){X.Error("texture arrays not currently supported");return}if(this.numberOfFaces!==t){X.Error("number of faces expected"+t+", but found "+this.numberOfFaces);return}this.loadType=ha.COMPRESSED_2D}uploadLevels(e,t){switch(this.loadType){case ha.COMPRESSED_2D:this._upload2DCompressedLevels(e,t);break}}_upload2DCompressedLevels(e,t){let i=ha.HEADER_LEN+this.bytesOfKeyValueData,r=this.pixelWidth,s=this.pixelHeight;const n=t?this.numberOfMipmapLevels:1;for(let a=0;a<n;a++){const l=new Int32Array(this.data.buffer,this.data.byteOffset+i,1)[0];i+=4;for(let c=0;c<this.numberOfFaces;c++){const h=new Uint8Array(this.data.buffer,this.data.byteOffset+i,l);e.getEngine()._uploadCompressedDataToTextureDirectly(e,e.format,r,s,h,c,a),i+=l,i+=3-(l+3)%4}r=Math.max(1,r*.5),s=Math.max(1,s*.5)}}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(t[0]===171&&t[1]===75&&t[2]===84&&t[3]===88&&t[4]===32&&t[5]===49&&t[6]===49&&t[7]===187&&t[8]===13&&t[9]===10&&t[10]===26&&t[11]===10)return!0}return!1}}ha.HEADER_LEN=12+13*4;ha.COMPRESSED_2D=0;ha.COMPRESSED_3D=1;ha.TEX_2D=2;ha.TEX_3D=3;class fO{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map(t=>({workerPromise:Promise.resolve(t),idle:!0}))}dispose(){for(const e of this._workerInfos)e.workerPromise.then(t=>{t.terminate()});this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(const t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then(i=>{t(i,()=>{const r=this._pendingActions.shift();r?this._execute(e,r):e.idle=!0})})}}class Wu extends fO{constructor(e,t,i=Wu.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=t,this._options=i}push(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){const t={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(t),this._execute(t,e)}else this._pendingActions.push(e)}_execute(e,t){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,(i,r)=>{t(i,()=>{r(),e.idle&&(e.timeoutId=setTimeout(()=>{e.workerPromise.then(n=>{n.terminate()});const s=this._workerInfos.indexOf(e);s!==-1&&this._workerInfos.splice(s,1)},this._options.idleTimeElapsedBeforeRelease))})})}}Wu.DefaultOptions={idleTimeElapsedBeforeRelease:1e3};var sx;(function(o){o[o.ETC1S=0]="ETC1S",o[o.UASTC4x4=1]="UASTC4x4"})(sx||(sx={}));var qh;(function(o){o[o.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",o[o.BC7_RGBA=1]="BC7_RGBA",o[o.BC3_RGBA=2]="BC3_RGBA",o[o.BC1_RGB=3]="BC1_RGB",o[o.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",o[o.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",o[o.ETC2_RGBA=6]="ETC2_RGBA",o[o.ETC1_RGB=7]="ETC1_RGB",o[o.RGBA32=8]="RGBA32",o[o.R8=9]="R8",o[o.RG8=10]="RG8"})(qh||(qh={}));var Q_;(function(o){o[o.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",o[o.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",o[o.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",o[o.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",o[o.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",o[o.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",o[o.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",o[o.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",o[o.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",o[o.RGBA8Format=32856]="RGBA8Format",o[o.R8Format=33321]="R8Format",o[o.RG8Format=33323]="RG8Format"})(Q_||(Q_={}));function wo(o){return o?J.GetAbsoluteUrl(o):null}function Z_(o){o.wasmUASTCToASTC!==null&&(KTX2DECODER.LiteTranscoder_UASTC_ASTC.WasmModuleURL=o.wasmUASTCToASTC),o.wasmUASTCToBC7!==null&&(KTX2DECODER.LiteTranscoder_UASTC_BC7.WasmModuleURL=o.wasmUASTCToBC7),o.wasmUASTCToRGBA_UNORM!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=o.wasmUASTCToRGBA_UNORM),o.wasmUASTCToRGBA_SRGB!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=o.wasmUASTCToRGBA_SRGB),o.wasmUASTCToR8_UNORM!==null&&(KTX2DECODER.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=o.wasmUASTCToR8_UNORM),o.wasmUASTCToRG8_UNORM!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=o.wasmUASTCToRG8_UNORM),o.jsMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.JSModuleURL=o.jsMSCTranscoder),o.wasmMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.WasmModuleURL=o.wasmMSCTranscoder),o.wasmZSTDDecoder!==null&&(KTX2DECODER.ZSTDDecoder.WasmModuleURL=o.wasmZSTDDecoder)}class _O{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const e={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[qh.BC1_RGB,qh.BC3_RGBA],yes:{transcodeFormat:qh.RGBA32,engineFormat:Q_.RGBA8Format,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=e,e}}class Ss{static GetDefaultNumWorkers(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}static _Initialize(e){if(Ss._WorkerPoolPromise||Ss._DecoderModulePromise)return;const t={jsDecoderModule:J.GetAbsoluteUrl(this.URLConfig.jsDecoderModule),wasmUASTCToASTC:wo(this.URLConfig.wasmUASTCToASTC),wasmUASTCToBC7:wo(this.URLConfig.wasmUASTCToBC7),wasmUASTCToRGBA_UNORM:wo(this.URLConfig.wasmUASTCToRGBA_UNORM),wasmUASTCToRGBA_SRGB:wo(this.URLConfig.wasmUASTCToRGBA_SRGB),wasmUASTCToR8_UNORM:wo(this.URLConfig.wasmUASTCToR8_UNORM),wasmUASTCToRG8_UNORM:wo(this.URLConfig.wasmUASTCToRG8_UNORM),jsMSCTranscoder:wo(this.URLConfig.jsMSCTranscoder),wasmMSCTranscoder:wo(this.URLConfig.wasmMSCTranscoder),wasmZSTDDecoder:wo(this.URLConfig.wasmZSTDDecoder)};e&&typeof Worker=="function"&&typeof URL<"u"?Ss._WorkerPoolPromise=new Promise(i=>{const r=`${Z_}(${pO})()`,s=URL.createObjectURL(new Blob([r],{type:"application/javascript"}));i(new Wu(e,()=>new Promise((n,a)=>{const l=new Worker(s),c=u=>{l.removeEventListener("error",c),l.removeEventListener("message",h),a(u)},h=u=>{u.data.action==="init"&&(l.removeEventListener("error",c),l.removeEventListener("message",h),n(l))};l.addEventListener("error",c),l.addEventListener("message",h),l.postMessage({action:"init",urls:t})})))}):typeof KTX2DECODER>"u"?Ss._DecoderModulePromise=J.LoadScriptAsync(t.jsDecoderModule).then(()=>(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,Z_(t),new KTX2DECODER.KTX2Decoder)):(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,Ss._DecoderModulePromise=Promise.resolve(new KTX2DECODER.KTX2Decoder))}constructor(e,t=Ss.DefaultNumWorkers){this._engine=e,Ss._Initialize(t)}uploadAsync(e,t,i){const r=this._engine.getCaps(),s={astc:!!r.astc,bptc:!!r.bptc,s3tc:!!r.s3tc,pvrtc:!!r.pvrtc,etc2:!!r.etc2,etc1:!!r.etc1};if(Ss._WorkerPoolPromise)return Ss._WorkerPoolPromise.then(n=>new Promise((a,l)=>{n.push((c,h)=>{const u=_=>{c.removeEventListener("error",u),c.removeEventListener("message",d),l(_),h()},d=_=>{if(_.data.action==="decoded"){if(c.removeEventListener("error",u),c.removeEventListener("message",d),!_.data.success)l({message:_.data.msg});else try{this._createTexture(_.data.decodedData,t,i),a()}catch(p){l({message:p})}h()}};c.addEventListener("error",u),c.addEventListener("message",d),Ss.DefaultDecoderOptions.isDirty&&c.postMessage({action:"setDefaultDecoderOptions",options:Ss.DefaultDecoderOptions._getKTX2DecoderOptions()});const f=new Uint8Array(e.byteLength);f.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),c.postMessage({action:"decode",data:f,caps:s,options:i},[f.buffer])})}));if(Ss._DecoderModulePromise)return Ss._DecoderModulePromise.then(n=>new Promise((a,l)=>{n.decode(e,r).then(c=>{this._createTexture(c,t),a()}).catch(c=>{l({message:c})})}));throw new Error("KTX2 decoder module is not available")}_createTexture(e,t,i){this._engine._bindTextureDirectly(3553,t),i&&(i.transcodedFormat=e.transcodedFormat,i.isInGammaSpace=e.isInGammaSpace,i.hasAlpha=e.hasAlpha,i.transcoderName=e.transcoderName);let s=!0;switch(e.transcodedFormat){case 32856:t.type=0,t.format=5;break;case 33321:t.type=0,t.format=6;break;case 33323:t.type=0,t.format=7;break;default:t.format=e.transcodedFormat,s=!1;break}if(t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let n=0;n<e.mipmaps.length;++n){const a=e.mipmaps[n];if(!a||!a.data)throw new Error("KTX2 container - could not transcode one of the image");s?(t.width=a.width,t.height=a.height,this._engine._uploadDataToTextureDirectly(t,a.data,0,n,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,a.width,a.height,a.data,0,n)}t._extension=".ktx2",t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,t.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(t[0]===171&&t[1]===75&&t[2]===84&&t[3]===88&&t[4]===32&&t[5]===50&&t[6]===48&&t[7]===187&&t[8]===13&&t[9]===10&&t[10]===26&&t[11]===10)return!0}return!1}}Ss.URLConfig={jsDecoderModule:"https://preview.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null};Ss.DefaultNumWorkers=Ss.GetDefaultNumWorkers();Ss.DefaultDecoderOptions=new _O;function pO(){let o;onmessage=e=>{if(e.data)switch(e.data.action){case"init":{const t=e.data.urls;importScripts(t.jsDecoderModule),Z_(t),o=new KTX2DECODER.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":{KTX2DECODER.KTX2Decoder.DefaultDecoderOptions=e.data.options;break}case"decode":o.decode(e.data.data,e.data.caps,e.data.options).then(t=>{const i=[];for(let r=0;r<t.mipmaps.length;++r){const s=t.mipmaps[r];s&&s.data&&i.push(s.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:t},i)}).catch(t=>{postMessage({action:"decoded",success:!1,msg:t})});break}}}function mO(o){switch(o){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}class gO{constructor(){this.supportCascades=!1}canLoad(e,t){return e.endsWith(".ktx")||e.endsWith(".ktx2")||t==="image/ktx"||t==="image/ktx2"}loadCubeData(e,t,i,r){if(Array.isArray(e))return;t._invertVScale=!t.invertY;const s=t.getEngine(),n=new ha(e,6),a=n.numberOfMipmapLevels>1&&t.generateMipMaps;s._unpackFlipY(!0),n.uploadLevels(t,t.generateMipMaps),t.width=n.pixelWidth,t.height=n.pixelHeight,s._setCubeMapTextureParams(t,a,n.numberOfMipmapLevels-1),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r()}loadData(e,t,i,r){if(ha.IsValid(e)){t._invertVScale=!t.invertY;const s=new ha(e,1),n=mO(s.glInternalFormat);n?(t.format=n,t._useSRGBBuffer=t.getEngine()._getUseSRGBBuffer(!0,t.generateMipMaps),t._gammaSpace=!0):t.format=s.glInternalFormat,i(s.pixelWidth,s.pixelHeight,t.generateMipMaps,!0,()=>{s.uploadLevels(t,t.generateMipMaps)},s.isInvalid)}else Ss.IsValid(e)?new Ss(t.getEngine()).uploadAsync(e,t,r).then(()=>{i(t.width,t.height,t.generateMipMaps,!0,()=>{},!1)},n=>{X.Warn(`Failed to load KTX2 texture data: ${n.message}`),i(0,0,!1,!1,()=>{},!0)}):(X.Error("texture missing KTX identifier"),i(0,0,!1,!1,()=>{},!0))}}q._TextureLoaders.unshift(new gO);class Eu extends Qs{constructor(e,t,i){super(e,x.Zero(),t),this._xrSessionManager=i,this._firstFrame=!1,this._referenceQuaternion=oe.Identity(),this._referencedPosition=new x,this._trackingState=Vc.NOT_TRACKING,this.onBeforeCameraTeleport=new Q,this.onAfterCameraTeleport=new Q,this.onTrackingStateChanged=new Q,this.compensateOnFirstFrame=!0,this.minZ=.1,this.rotationQuaternion=new oe,this.cameraRigMode=Ve.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this._updateNumberOfRigCameras(1),this.freezeProjectionMatrix(),this._xrSessionManager.onXRSessionInit.add(()=>{this._referencedPosition.copyFromFloats(0,0,0),this._referenceQuaternion.copyFromFloats(0,0,0,1),this._firstFrame=this.compensateOnFirstFrame}),this._xrSessionManager.onXRFrameObservable.add(()=>{this._firstFrame&&this._updateFromXRSession(),this._updateReferenceSpace(),this._updateFromXRSession()},void 0,!0)}get trackingState(){return this._trackingState}_setTrackingState(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))}get realWorldHeight(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y:0}_updateForDualEyeDebugging(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new Dn(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new Dn(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(e=this.getScene().activeCamera,t=!0){if(!e||e===this)return;e.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,oe.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,t&&this._xrSessionManager.resetReferenceSpace()}getClassName(){return"WebXRCamera"}setTarget(e){const t=j.Vector3[1];e.subtractToRef(this.position,t),t.y=0,t.normalize();const i=Math.atan2(t.x,t.z);this.rotationQuaternion.toEulerAnglesToRef(t),oe.FromEulerAnglesToRef(t.x,i,t.z,this.rotationQuaternion)}dispose(){super.dispose(),this._lastXRViewerPose=void 0}_updateFromXRSession(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=e||void 0,!e){this._setTrackingState(Vc.NOT_TRACKING);return}const t=e.emulatedPosition?Vc.TRACKING_LOST:Vc.TRACKING;if(this._setTrackingState(t),this.minZ!==this._cache.minZ||this.maxZ!==this._cache.maxZ){const i={depthFar:this.maxZ||1e4,depthNear:this.minZ};this._xrSessionManager.updateRenderState(i),this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ}if(e.transform){const i=e.transform.orientation;if(e.transform.orientation.x===void 0)return;const r=e.transform.position;this._referencedPosition.set(r.x,r.y,r.z),this._referenceQuaternion.set(i.x,i.y,i.z,i.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length),e.views.forEach((i,r)=>{var s;const n=this.rigCameras[r];!n.isLeftCamera&&!n.isRightCamera&&(i.eye==="right"?n._isRightCamera=!0:i.eye==="left"&&(n._isLeftCamera=!0));const a=i.transform.position,l=i.transform.orientation;n.parent=this.parent,n.position.set(a.x,a.y,a.z),n.rotationQuaternion.set(l.x,l.y,l.z,l.w),this._scene.useRightHandedSystem||(n.position.z*=-1,n.rotationQuaternion.z*=-1,n.rotationQuaternion.w*=-1),H.FromFloat32ArrayToRefScaled(i.projectionMatrix,0,1,n._projectionMatrix),this._scene.useRightHandedSystem||n._projectionMatrix.toggleProjectionMatrixHandInPlace(),r===0&&this._projectionMatrix.copyFrom(n._projectionMatrix);const c=this._xrSessionManager.getRenderTargetTextureForView(i);this._renderingMultiview=((s=c==null?void 0:c._texture)===null||s===void 0?void 0:s.isMultiview)||!1,this._renderingMultiview?r==0&&(this._xrSessionManager.trySetViewportForView(this.viewport,i),this.outputRenderTarget=c):(this._xrSessionManager.trySetViewportForView(n.viewport,i),n.outputRenderTarget=c||this._xrSessionManager.getRenderTargetTextureForView(i)),n.layerMask=this.layerMask})}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){const t=new xr("XR-RigCamera: "+this.rigCameras.length,x.Zero(),this.getScene());t.minZ=.1,t.rotationQuaternion=new oe,t.updateUpVectorFromRotation=!0,t.isRigCamera=!0,t.rigParent=this,t.freezeProjectionMatrix(),this.rigCameras.push(t)}for(;this.rigCameras.length>e;){const t=this.rigCameras.pop();t&&t.dispose()}}_updateReferenceSpace(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){const e=j.Matrix[0],t=j.Matrix[1],i=j.Matrix[2];H.ComposeToRef(Eu._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),H.ComposeToRef(Eu._ScaleReadOnly,this.rotationQuaternion,this.position,t),e.invert().multiplyToRef(t,i),i.invert(),this._scene.useRightHandedSystem||i.toggleModelMatrixHandInPlace(),i.decompose(void 0,this._referenceQuaternion,this._referencedPosition);const r=new XRRigidTransform({x:this._referencedPosition.x,y:this._referencedPosition.y,z:this._referencedPosition.z},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(r)}}}Eu._ScaleReadOnly=x.One();class Dm{constructor(e){this._scene=e,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this._lastTimestamp=0,this.onInitialXRPoseSetObservable=new Q,this.onStateChangedObservable=new Q,this.state=Hr.NOT_IN_XR,this.sessionManager=new wf(e),this.camera=new Eu("webxr",e,this.sessionManager),this.featuresManager=new dr(this.sessionManager),e.onDisposeObservable.addOnce(()=>{this.dispose()})}static CreateAsync(e){const t=new Dm(e);return t.sessionManager.initializeAsync().then(()=>(t._supported=!0,t)).catch(i=>{throw t._setState(Hr.NOT_IN_XR),t.dispose(),i})}dispose(){var e;this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),(e=this._spectatorCamera)===null||e===void 0||e.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)}async enterXRAsync(e,t,i=this.sessionManager.getWebXRRenderTarget(),r={}){var s,n,a;if(!this._supported)throw"WebXR not supported in this browser or environment";this._setState(Hr.ENTERING_XR),t!=="viewer"&&t!=="local"&&(r.optionalFeatures=r.optionalFeatures||[],r.optionalFeatures.push(t)),r=await this.featuresManager._extendXRSessionInitObject(r),e==="immersive-ar"&&t!=="unbounded"&&X.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{await this.sessionManager.initializeSessionAsync(e,r),await this.sessionManager.setReferenceSpaceTypeAsync(t);const l=await i.initializeXRLayerAsync(this.sessionManager.session),c={depthFar:this.camera.maxZ||1e4,depthNear:this.camera.minZ};return this.featuresManager.getEnabledFeature(si.LAYERS)||(c.baseLayer=l),this.sessionManager.updateRenderState(c),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this._scene.autoClear,this._nonVRCamera=this._scene.activeCamera,this._attachedToElement=!!(!((n=(s=this._nonVRCamera)===null||s===void 0?void 0:s.inputs)===null||n===void 0)&&n.attachedToElement),(a=this._nonVRCamera)===null||a===void 0||a.detachControl(),this._scene.activeCamera=this.camera,e!=="immersive-ar"?this._nonXRToXRCamera():(this._scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1)),this.sessionManager.onXRSessionEnded.addOnce(()=>{this.state!==Hr.EXITING_XR&&this._setState(Hr.EXITING_XR),this.camera.rigCameras.forEach(h=>{h.outputRenderTarget=null}),this._scene.autoClear=this._originalSceneAutoClear,this._scene.activeCamera=this._nonVRCamera,this._attachedToElement&&this._nonVRCamera&&this._nonVRCamera.attachControl(!!this._nonVRCamera.inputs.noPreventDefault),e!=="immersive-ar"&&this.camera.compensateOnFirstFrame&&(this._nonVRCamera.setPosition?this._nonVRCamera.setPosition(this.camera.position):this._nonVRCamera.position.copyFrom(this.camera.position)),this._setState(Hr.NOT_IN_XR)}),this.sessionManager.onXRFrameObservable.addOnce(()=>{this._setState(Hr.IN_XR)}),this.sessionManager}catch(l){throw console.log(l),console.log(l.message),this._setState(Hr.NOT_IN_XR),l}}exitXRAsync(){return this.state!==Hr.IN_XR?Promise.resolve():(this._setState(Hr.EXITING_XR),this.sessionManager.exitXRAsync())}enableSpectatorMode(e){this._spectatorMode||(this._spectatorMode=!0,this._switchSpectatorMode(e))}disableSpecatatorMode(){this._spectatorMode&&(this._spectatorMode=!1,this._switchSpectatorMode())}_switchSpectatorMode(e){const i=1/(e!=null&&e.fps?e.fps:1e3)*1e3,r=e!=null&&e.preferredCameraIndex?e==null?void 0:e.preferredCameraIndex:0,s=()=>{this._spectatorCamera&&this.sessionManager.currentTimestamp-this._lastTimestamp>=i&&(this._lastTimestamp=this.sessionManager.currentTimestamp,this._spectatorCamera.position.copyFrom(this.camera.rigCameras[r].globalPosition),this._spectatorCamera.rotationQuaternion.copyFrom(this.camera.rigCameras[r].absoluteRotation))};if(this._spectatorMode){if(r>=this.camera.rigCameras.length)throw new Error("the preferred camera index is beyond the length of rig camera array.");const n=()=>{this.state===Hr.IN_XR?(this._spectatorCamera=new Th("webxr-spectator",x.Zero(),this._scene),this._spectatorCamera.rotationQuaternion=new oe,this._scene.activeCameras=[this.camera,this._spectatorCamera],this.sessionManager.onXRFrameObservable.add(s),this._scene.onAfterRenderCameraObservable.add(a=>{a===this.camera&&(this._scene.getEngine().framebufferDimensionsObject=null)})):this.state===Hr.EXITING_XR&&(this.sessionManager.onXRFrameObservable.removeCallback(s),this._scene.activeCameras=null)};this.onStateChangedObservable.add(n),n()}else this.sessionManager.onXRFrameObservable.removeCallback(s),this._scene.activeCameras=[this.camera]}_nonXRToXRCamera(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}_setState(e){this.state!==e&&(this.state=e,this.onStateChangedObservable.notifyObservers(this.state))}}class qn{constructor(e,t,i=-1,r=[]){this.id=e,this.type=t,this._buttonIndex=i,this._axesIndices=r,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new Q,this.onButtonStateChangedObservable=new Q}get axes(){return this._axes}get changes(){return this._changes}get hasChanges(){return this._hasChanges}get pressed(){return this._pressed}get touched(){return this._touched}get value(){return this._currentValue}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return this._axesIndices.length!==0}isButton(){return this._buttonIndex!==-1}update(e){let t=!1,i=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){const r=e.buttons[this._buttonIndex];if(!r)return;this._currentValue!==r.value&&(this.changes.value={current:r.value,previous:this._currentValue},t=!0,this._currentValue=r.value),this._touched!==r.touched&&(this.changes.touched={current:r.touched,previous:this._touched},t=!0,this._touched=r.touched),this._pressed!==r.pressed&&(this.changes.pressed={current:r.pressed,previous:this._pressed},t=!0,this._pressed=r.pressed)}this.isAxes()&&(this._axes.x!==e.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:e.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=e.axes[this._axesIndices[0]],i=!0),this._axes.y!==e.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=e.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:e.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=e.axes[this._axesIndices[1]],i=!0)),t&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),i&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))}}qn.BUTTON_TYPE="button";qn.SQUEEZE_TYPE="squeeze";qn.THUMBSTICK_TYPE="thumbstick";qn.TOUCHPAD_TYPE="touchpad";qn.TRIGGER_TYPE="trigger";class Eh{constructor(e,t,i,r,s=!1,n){this.scene=e,this.layout=t,this.gamepadObject=i,this.handedness=r,this._doNotLoadControllerMesh=s,this._controllerCache=n,this._initComponent=a=>{if(!a)return;const l=this.layout.components[a],c=l.type,h=l.gamepadIndices.button,u=[];l.gamepadIndices.xAxis!==void 0&&l.gamepadIndices.yAxis!==void 0&&u.push(l.gamepadIndices.xAxis,l.gamepadIndices.yAxis),this.components[a]=new qn(a,c,h,u)},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new Q,t.components&&Object.keys(t.components).forEach(this._initComponent)}dispose(){this.getComponentIds().forEach(e=>this.getComponent(e).dispose()),this.rootMesh&&(this.rootMesh.getChildren(void 0,!0).forEach(e=>{e.setEnabled(!1)}),this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache))}getAllComponentsOfType(e){return this.getComponentIds().map(t=>this.components[t]).filter(t=>t.type===e)}getComponent(e){return this.components[e]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(e){return this.getAllComponentsOfType(e)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}async loadModel(){const e=!this._getModelLoadingConstraints();let t=this._getGenericFilenameAndPath();return e?X.Warn("Falling back to generic models"):t=this._getFilenameAndPath(),new Promise((i,r)=>{const s=n=>{e?this._getGenericParentMesh(n):this._setRootMesh(n),this._processLoadedModel(n),this._modelReady=!0,this.onModelLoadedObservable.notifyObservers(this),i(!0)};if(this._controllerCache){const n=this._controllerCache.filter(a=>a.filename===t.filename&&a.path===t.path);if(n[0]){n[0].meshes.forEach(a=>a.setEnabled(!0)),s(n[0].meshes);return}}ft.ImportMesh("",t.path,t.filename,this.scene,n=>{this._controllerCache&&this._controllerCache.push({...t,meshes:n}),s(n)},null,(n,a)=>{X.Log(a),X.Warn(`Failed to retrieve controller model of type ${this.profileId} from the remote server: ${t.path}${t.filename}`),r(a)})})}updateFromXRFrame(e){this.getComponentIds().forEach(t=>this.getComponent(t).update(this.gamepadObject)),this.updateModel(e)}get handness(){return this.handedness}pulse(e,t,i=0){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[i]?this.gamepadObject.hapticActuators[i].pulse(e,t):Promise.resolve(!1)}_getChildByName(e,t){return e.getChildren(i=>i.name===t,!1)[0]}_getImmediateChildByName(e,t){return e.getChildren(i=>i.name==t,!0)[0]}_lerpTransform(e,t,i){if(!e.minMesh||!e.maxMesh||!e.valueMesh||!e.minMesh.rotationQuaternion||!e.maxMesh.rotationQuaternion||!e.valueMesh.rotationQuaternion)return;const r=i?t*.5+.5:t;oe.SlerpToRef(e.minMesh.rotationQuaternion,e.maxMesh.rotationQuaternion,r,e.valueMesh.rotationQuaternion),x.LerpToRef(e.minMesh.position,e.maxMesh.position,r,e.valueMesh.position)}updateModel(e){this._modelReady&&this._updateModel(e)}_getGenericFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getGenericParentMesh(e){this.rootMesh=new K(this.profileId+" "+this.handedness,this.scene),e.forEach(t=>{t.parent||(t.isPickable=!1,t.setParent(this.rootMesh))}),this.rootMesh.rotationQuaternion=oe.FromEulerAngles(0,Math.PI,0)}}class bu extends Eh{constructor(e,t,i){super(e,vO[i],t,i),this.profileId=bu.ProfileId}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){this.rootMesh=new K(this.profileId+" "+this.handedness,this.scene),e.forEach(t=>{t.isPickable=!1,t.parent||t.setParent(this.rootMesh)}),this.rootMesh.rotationQuaternion=oe.FromEulerAngles(0,Math.PI,0)}_updateModel(){}}bu.ProfileId="generic-trigger";const vO={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};class xO extends Eh{constructor(e,t,i,r,s){super(e,i.layouts[t.handedness||"none"],t.gamepad,t.handedness,void 0,s),this._repositoryUrl=r,this.controllerCache=s,this._buttonMeshMapping={},this._touchDots={},this.profileId=i.profileId}dispose(){super.dispose(),this.controllerCache||Object.keys(this._touchDots).forEach(e=>{this._touchDots[e].dispose()})}_getFilenameAndPath(){return{filename:this.layout.assetPath,path:`${this._repositoryUrl}/profiles/${this.profileId}/`}}_getModelLoadingConstraints(){const e=ft.IsPluginForExtensionAvailable(".glb");return e||X.Warn("glTF / glb loader was not registered, using generic controller instead"),e}_processLoadedModel(e){this.getComponentIds().forEach(t=>{const i=this.layout.components[t];this._buttonMeshMapping[t]={mainMesh:this._getChildByName(this.rootMesh,i.rootNodeName),states:{}},Object.keys(i.visualResponses).forEach(r=>{const s=i.visualResponses[r];if(s.valueNodeProperty==="transform")this._buttonMeshMapping[t].states[r]={valueMesh:this._getChildByName(this.rootMesh,s.valueNodeName),minMesh:this._getChildByName(this.rootMesh,s.minNodeName),maxMesh:this._getChildByName(this.rootMesh,s.maxNodeName)};else{const n=i.type===qn.TOUCHPAD_TYPE&&i.touchPointNodeName?i.touchPointNodeName:s.valueNodeName;if(this._buttonMeshMapping[t].states[r]={valueMesh:this._getChildByName(this.rootMesh,n)},i.type===qn.TOUCHPAD_TYPE&&!this._touchDots[r]){const a=jo(r+"dot",{diameter:.0015,segments:8},this.scene);a.material=new Be(r+"mat",this.scene),a.material.diffuseColor=ge.Red(),a.parent=this._buttonMeshMapping[t].states[r].valueMesh||null,a.isVisible=!1,this._touchDots[r]=a}}})})}_setRootMesh(e){this.rootMesh=new K(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;let t;for(let i=0;i<e.length;i++){const r=e[i];r.isPickable=!1,r.parent||(t=r)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(As.Y,Math.PI,Kt.WORLD)}_updateModel(e){this.disableAnimation||this.getComponentIds().forEach(t=>{const i=this.getComponent(t);if(!i.hasChanges)return;const r=this._buttonMeshMapping[t],s=this.layout.components[t];Object.keys(s.visualResponses).forEach(n=>{const a=s.visualResponses[n];let l=i.value;if(a.componentProperty==="xAxis"?l=i.axes.x:a.componentProperty==="yAxis"&&(l=i.axes.y),a.valueNodeProperty==="transform")this._lerpTransform(r.states[n],l,a.componentProperty!=="button");else{const c=r.states[n].valueMesh;c&&(c.isVisible=i.touched||i.pressed),this._touchDots[n]&&(this._touchDots[n].isVisible=i.touched||i.pressed)}})})}}const I_=[];class rs{static ClearProfilesCache(){this._ProfilesList=null,this._ProfileLoadingPromises={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"])}static FindFallbackWithProfileId(e){const t=this._Fallbacks[e]||[];return t.unshift(e),t}static GetMotionControllerWithXRInput(e,t,i){const r=[];if(i&&r.push(i),r.push(...e.profiles||[]),r.length&&!r[0]&&r.pop(),e.gamepad&&e.gamepad.id)switch(e.gamepad.id){case(e.gamepad.id.match(/oculus touch/gi)?e.gamepad.id:void 0):r.push("oculus-touch-v2");break}const s=r.indexOf("windows-mixed-reality");if(s!==-1&&r.splice(s,0,"microsoft-mixed-reality"),r.length||r.push("generic-trigger"),this.UseOnlineRepository){const n=this.PrioritizeOnlineRepository?this._LoadProfileFromRepository:this._LoadProfilesFromAvailableControllers,a=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllers:this._LoadProfileFromRepository;return n.call(this,r,e,t).catch(()=>a.call(this,r,e,t))}else return this._LoadProfilesFromAvailableControllers(r,e,t)}static RegisterController(e,t){this._AvailableControllers[e]=t}static RegisterFallbacksForProfileId(e,t){this._Fallbacks[e]?this._Fallbacks[e].push(...t):this._Fallbacks[e]=t}static UpdateProfilesList(){return this._ProfilesList=J.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then(e=>JSON.parse(e.toString())),this._ProfilesList}static ClearControllerCache(){I_.forEach(e=>{e.meshes.forEach(t=>{t.dispose(!1,!0)})}),I_.length=0}static _LoadProfileFromRepository(e,t,i){return Promise.resolve().then(()=>this._ProfilesList?this._ProfilesList:this.UpdateProfilesList()).then(r=>{for(let s=0;s<e.length;++s)if(e[s]&&r[e[s]])return e[s];throw new Error(`neither controller ${e[0]} nor all fallbacks were found in the repository,`)}).then(r=>(this._ProfileLoadingPromises[r]||(this._ProfileLoadingPromises[r]=J.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${r}/profile.json`,!1).then(s=>JSON.parse(s))),this._ProfileLoadingPromises[r])).then(r=>new xO(i,t,r,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:I_))}static _LoadProfilesFromAvailableControllers(e,t,i){for(let r=0;r<e.length;++r){if(!e[r])continue;const s=this.FindFallbackWithProfileId(e[r]);for(let n=0;n<s.length;++n){const a=this._AvailableControllers[s[n]];if(a)return Promise.resolve(a(t,i))}}throw new Error("no controller requested was found in the available controllers list")}}rs._AvailableControllers={};rs._Fallbacks={};rs._ProfileLoadingPromises={};rs.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist";rs.PrioritizeOnlineRepository=!0;rs.UseOnlineRepository=!0;rs.DisableControllerCache=!0;rs.RegisterController(bu.ProfileId,(o,e)=>new bu(e,o.gamepad,o.handedness));rs.DefaultFallbacks();let TO=0;class EO{constructor(e,t,i={}){this._scene=e,this.inputSource=t,this._options=i,this._tmpVector=new x,this._disposed=!1,this.onDisposeObservable=new Q,this.onMeshLoadedObservable=new Q,this.onMotionControllerInitObservable=new Q,this._uniqueId=`controller-${TO++}-${t.targetRayMode}-${t.handedness}`,this.pointer=new Qt(`${this._uniqueId}-pointer`,e),this.pointer.rotationQuaternion=new oe,this.inputSource.gripSpace&&(this.grip=new Qt(`${this._uniqueId}-grip`,this._scene),this.grip.rotationQuaternion=new oe),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&this.inputSource.targetRayMode==="tracked-pointer"&&rs.GetMotionControllerWithXRInput(t,e,this._options.forceControllerProfile).then(r=>{this.motionController=r,this.onMotionControllerInitObservable.notifyObservers(r),!this._options.doNotLoadControllerMesh&&!this.motionController._doNotLoadControllerMesh&&this.motionController.loadModel().then(s=>{var n;s&&this.motionController&&this.motionController.rootMesh&&(this._options.renderingGroupId&&(this.motionController.rootMesh.renderingGroupId=this._options.renderingGroupId,this.motionController.rootMesh.getChildMeshes(!1).forEach(a=>a.renderingGroupId=this._options.renderingGroupId)),this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this._options.disableMotionControllerAnimation),this._disposed&&((n=this.motionController)===null||n===void 0||n.dispose())})},()=>{J.Warn("Could not find a matching motion controller for the registered input source")})}get uniqueId(){return this._uniqueId}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0}getWorldPointerRayToRef(e,t=!1){const i=t&&this.grip?this.grip:this.pointer;x.TransformNormalToRef(this._tmpVector,i.getWorldMatrix(),e.direction),e.direction.normalize(),e.origin.copyFrom(i.absolutePosition),e.length=1e3}updateFromXRFrame(e,t,i){const r=e.getPose(this.inputSource.targetRaySpace,t);if(this._lastXRPose=r,r){const s=r.transform.position;this.pointer.position.set(s.x,s.y,s.z);const n=r.transform.orientation;this.pointer.rotationQuaternion.set(n.x,n.y,n.z,n.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=i.parent}if(this.inputSource.gripSpace&&this.grip){const s=e.getPose(this.inputSource.gripSpace,t);if(s){const n=s.transform.position,a=s.transform.orientation;this.grip.position.set(n.x,n.y,n.z),this.grip.rotationQuaternion.set(a.x,a.y,a.z,a.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=i.parent}this.motionController&&this.motionController.updateFromXRFrame(e)}}class bO{constructor(e,t,i={}){if(this.xrSessionManager=e,this.xrCamera=t,this._options=i,this.controllers=[],this.onControllerAddedObservable=new Q,this.onControllerRemovedObservable=new Q,this._onInputSourcesChange=r=>{this._addAndRemoveControllers(r.added,r.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add(()=>{this._addAndRemoveControllers([],this.controllers.map(r=>r.inputSource))}),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add(r=>{r.addEventListener("inputsourceschange",this._onInputSourcesChange)}),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add(r=>{this.controllers.forEach(s=>{s.updateFromXRFrame(r,this.xrSessionManager.referenceSpace,this.xrCamera)})}),this._options.customControllersRepositoryURL&&(rs.BaseRepositoryUrl=this._options.customControllersRepositoryURL),rs.UseOnlineRepository=!this._options.disableOnlineControllerRepository,rs.UseOnlineRepository)try{rs.UpdateProfilesList().catch(()=>{rs.UseOnlineRepository=!1})}catch{rs.UseOnlineRepository=!1}}_addAndRemoveControllers(e,t){const i=this.controllers.map(n=>n.inputSource);for(const n of e)if(i.indexOf(n)===-1){const a=new EO(this.xrSessionManager.scene,n,{...this._options.controllerOptions||{},forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation});this.controllers.push(a),this.onControllerAddedObservable.notifyObservers(a)}const r=[],s=[];this.controllers.forEach(n=>{t.indexOf(n.inputSource)===-1?r.push(n):s.push(n)}),this.controllers=r,s.forEach(n=>{this.onControllerRemovedObservable.notifyObservers(n),n.dispose()})}dispose(){this.controllers.forEach(e=>{e.dispose()}),this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),rs.ClearControllerCache()}}class go extends Gs{constructor(e,t){super(e),this._options=t,this._attachController=i=>{if(this._controllers[i.uniqueId])return;const{laserPointer:r,selectionMesh:s}=this._generateNewMeshPair(i.pointer);switch(this._controllers[i.uniqueId]={xrController:i,laserPointer:r,selectionMesh:s,meshUnderPointer:null,pick:null,tmpRay:new Pt(new x,new x),disabledByNearInteraction:!1,id:go._IdCounter++},this._attachedController?!this._options.enablePointerSelectionOnAllControllers&&this._options.preferredHandedness&&i.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=i.uniqueId):this._options.enablePointerSelectionOnAllControllers||(this._attachedController=i.uniqueId),i.inputSource.targetRayMode){case"tracked-pointer":return this._attachTrackedPointerRayMode(i);case"gaze":return this._attachGazeMode(i);case"screen":return this._attachScreenRayMode(i)}},this._controllers={},this._tmpVectorForPickCompare=new x,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new ge(.9,.9,.9),this.laserPointerDefaultColor=new ge(.7,.7,.7),this.selectionMeshDefaultColor=new ge(.8,.8,.8),this.selectionMeshPickedColor=new ge(.3,.3,1),this._identityMatrix=H.Identity(),this._screenCoordinatesRef=x.Zero(),this._viewportRef=new Dn(0,0,0,0),this._scene=this._xrSessionManager.scene}attach(){if(!super.attach())return!1;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){const e=this._options.gazeCamera,{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(e);this._controllers.camera={webXRCamera:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new Pt(new x,new x),disabledByNearInteraction:!1,id:go._IdCounter++},this._attachGazeMode()}return!0}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),!0):!1}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}_getPointerSelectionDisabledByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].disabledByNearInteraction;return!0}_setPointerSelectionDisabledByPointerId(e,t){const i=Object.keys(this._controllers);for(let r=0;r<i.length;++r)if(this._controllers[i[r]].id===e){this._controllers[i[r]].disabledByNearInteraction=t;return}}_onXRFrame(e){Object.keys(this._controllers).forEach(t=>{const i=this._controllers[t];if(!this._options.enablePointerSelectionOnAllControllers&&t!==this._attachedController||i.disabledByNearInteraction){i.selectionMesh.isVisible=!1,i.laserPointer.isVisible=!1,i.pick=null;return}i.laserPointer.isVisible=this.displayLaserPointer;let r;if(i.xrController)r=i.xrController.pointer.position,i.xrController.getWorldPointerRayToRef(i.tmpRay);else if(i.webXRCamera)r=i.webXRCamera.position,i.webXRCamera.getForwardRayToRef(i.tmpRay);else return;if(this._options.maxPointerDistance&&(i.tmpRay.length=this._options.maxPointerDistance),!this._options.disableScenePointerVectorUpdate&&r){const l=this._xrSessionManager.scene,c=this._options.xrInput.xrCamera;c&&(c.viewport.toGlobalToRef(l.getEngine().getRenderWidth(),l.getEngine().getRenderHeight(),this._viewportRef),x.ProjectToRef(r,this._identityMatrix,l.getTransformMatrix(),this._viewportRef,this._screenCoordinatesRef),typeof this._screenCoordinatesRef.x=="number"&&typeof this._screenCoordinatesRef.y=="number"&&!isNaN(this._screenCoordinatesRef.x)&&!isNaN(this._screenCoordinatesRef.y)&&(l.pointerX=this._screenCoordinatesRef.x,l.pointerY=this._screenCoordinatesRef.y,i.screenCoordinates={x:this._screenCoordinatesRef.x,y:this._screenCoordinatesRef.y}))}let s=null;this._utilityLayerScene&&(s=this._utilityLayerScene.pickWithRay(i.tmpRay,this._utilityLayerScene.pointerMovePredicate||this.raySelectionPredicate));const n=this._scene.pickWithRay(i.tmpRay,this._scene.pointerMovePredicate||this.raySelectionPredicate);!s||!s.hit?i.pick=n:!n||!n.hit||s.distance<n.distance?i.pick=s:i.pick=n,i.pick&&i.xrController&&(i.pick.aimTransform=i.xrController.pointer,i.pick.gripTransform=i.xrController.grip||null);const a=i.pick;if(a&&a.pickedPoint&&a.hit){this._updatePointerDistance(i.laserPointer,a.distance),i.selectionMesh.position.copyFrom(a.pickedPoint),i.selectionMesh.scaling.x=Math.sqrt(a.distance),i.selectionMesh.scaling.y=Math.sqrt(a.distance),i.selectionMesh.scaling.z=Math.sqrt(a.distance);const l=this._convertNormalToDirectionOfRay(a.getNormal(!0),i.tmpRay),c=.001;if(i.selectionMesh.position.copyFrom(a.pickedPoint),l){const h=x.Cross(As.Y,l),u=x.Cross(l,h);x.RotationFromAxisToRef(u,l,h,i.selectionMesh.rotation),i.selectionMesh.position.addInPlace(l.scale(c))}i.selectionMesh.isVisible=this.displaySelectionMesh,i.meshUnderPointer=a.pickedMesh}else i.selectionMesh.isVisible=!1,this._updatePointerDistance(i.laserPointer,1),i.meshUnderPointer=null})}get _utilityLayerScene(){return this._options.customUtilityLayerScene||yr.DefaultUtilityLayer.utilityLayerScene}_attachGazeMode(e){const t=this._controllers[e&&e.uniqueId||"camera"],i=this._options.timeToSelect||3e3,r=this._options.useUtilityLayer?this._utilityLayerScene:this._scene;let s=new Vs;const n=ah("selection",{diameter:.0035*15,thickness:.0025*6,tessellation:20},r);n.isVisible=!1,n.isPickable=!1,n.parent=t.selectionMesh;let a=0,l=!1;const c={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{if(t.pick){if(this._augmentPointerInit(c,t.id,t.screenCoordinates),t.laserPointer.material.alpha=0,n.isVisible=!1,t.pick.hit)if(this._pickingMoved(s,t.pick))l&&(this._options.disablePointerUpOnTouchOut||this._scene.simulatePointerUp(t.pick,c)),l=!1,a=0;else if(a>i/10&&(n.isVisible=!0),a+=this._scene.getEngine().getDeltaTime(),a>=i)this._scene.simulatePointerDown(t.pick,c),l=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,c),n.isVisible=!1;else{const h=1-a/i;n.scaling.set(h,h,h)}else l=!1,a=0;this._scene.simulatePointerMove(t.pick,c),s=t.pick}}),this._options.renderingGroupId!==void 0&&(n.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce(()=>{t.pick&&!this._options.disablePointerUpOnTouchOut&&l&&(this._scene.simulatePointerUp(t.pick,c),t.finalPointerUpTriggered=!0),n.dispose()})}_attachScreenRayMode(e){const t=this._controllers[e.uniqueId];let i=!1;const r={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),!(!t.pick||this._options.disablePointerUpOnTouchOut&&i)&&(i?this._scene.simulatePointerMove(t.pick,r):(this._scene.simulatePointerDown(t.pick,r),t.pointerDownTriggered=!0,i=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,r)))}),e.onDisposeObservable.addOnce(()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),this._xrSessionManager.runInXRFrame(()=>{t.pick&&!t.finalPointerUpTriggered&&i&&!this._options.disablePointerUpOnTouchOut&&(this._scene.simulatePointerUp(t.pick,r),t.finalPointerUpTriggered=!0)})})}_attachTrackedPointerRayMode(e){const t=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);const i={pointerId:t.id,pointerType:"xr"};if(t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{t.laserPointer.material.disableLighting=this.disablePointerLighting,t.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,t.pick&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerMove(t.pick,i))}),e.inputSource.gamepad){const r=s=>{this._options.overrideButtonId&&(t.selectionComponent=s.getComponent(this._options.overrideButtonId)),t.selectionComponent||(t.selectionComponent=s.getMainComponent()),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(n=>{if(n.changes.pressed){const a=n.changes.pressed.current;t.pick?(this._options.enablePointerSelectionOnAllControllers||e.uniqueId===this._attachedController)&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),a?(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)):a&&!this._options.enablePointerSelectionOnAllControllers&&!this._options.disableSwitchOnClick&&(this._attachedController=e.uniqueId)}})};e.motionController?r(e.motionController):e.onMotionControllerInitObservable.add(r)}else{const r=n=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&n.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor)},s=n=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&n.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)};t.eventListeners={selectend:s,selectstart:r},this._xrSessionManager.session.addEventListener("selectstart",r),this._xrSessionManager.session.addEventListener("selectend",s)}}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(x.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_detachController(e){const t=this._controllers[e];if(t){if(t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach(i=>{const r=t.eventListeners&&t.eventListeners[i];r&&this._xrSessionManager.session.removeEventListener(i,r)}),!t.finalPointerUpTriggered&&t.pointerDownTriggered){const i={pointerId:t.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerUp(t.pick||new Vs,i),t.finalPointerUpTriggered=!0})}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce(()=>{try{if(t.selectionMesh.dispose(),t.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e){const i=Object.keys(this._controllers);i.length?this._attachedController=i[0]:this._attachedController=""}}catch{J.Warn("controller already detached.")}})}}_generateNewMeshPair(e){const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||yr.DefaultUtilityLayer.utilityLayerScene:this._scene,i=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():Ff("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},t);i.parent=e;const r=new Be("laserPointerMat",t);r.emissiveColor=this.laserPointerDefaultColor,r.alpha=.7,i.material=r,i.rotation.x=Math.PI/2,this._updatePointerDistance(i,1),i.isPickable=!1,i.isVisible=!1;const s=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():ah("gazeTracker",{diameter:.0035*3,thickness:.0025*3,tessellation:20},t);s.bakeCurrentTransformIntoVertices(),s.isPickable=!1,s.isVisible=!1;const n=new Be("targetMat",t);return n.specularColor=ge.Black(),n.emissiveColor=this.selectionMeshDefaultColor,n.backFaceCulling=!1,s.material=n,this._options.renderingGroupId!==void 0&&(i.renderingGroupId=this._options.renderingGroupId,s.renderingGroupId=this._options.renderingGroupId),{laserPointer:i,selectionMesh:s}}_pickingMoved(e,t){var i;if(!e.hit||!t.hit||!e.pickedMesh||!e.pickedPoint||!t.pickedMesh||!t.pickedPoint||e.pickedMesh!==t.pickedMesh)return!0;(i=e.pickedPoint)===null||i===void 0||i.subtractToRef(t.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));const r=(this._options.gazeModePointerMovedFactor||1)*.01*t.distance;return this._tmpVectorForPickCompare.length()>r}_updatePointerDistance(e,t=100){e.scaling.y=t,this._scene.useRightHandedSystem&&(t*=-1),e.position.z=t/2+.05}_augmentPointerInit(e,t,i){e.pointerId=t,e.pointerType="xr",i&&(e.screenX=i.x,e.screenY=i.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}}go._IdCounter=200;go.Name=si.POINTER_SELECTION;go.Version=1;dr.AddWebXRFeature(go.Name,(o,e)=>()=>new go(o,e),go.Version,!0);qs.prototype._projectOnTrianglesToRef=function(o,e,t,i,r,s){const n=j.Vector3[0],a=j.Vector3[1];let l=1/0;for(let c=this.indexStart;c<this.indexStart+this.indexCount-(3-i);c+=i){const h=t[c],u=t[c+1],d=t[c+2];if(r&&d===4294967295){c+=2;continue}const f=e[h],_=e[u],p=e[d];if(!f||!_||!p)continue;const m=x.ProjectOnTriangleToRef(o,f,_,p,a);m<l&&(n.copyFrom(a),l=m)}return s.copyFrom(n),l};qs.prototype._projectOnUnIndexedTrianglesToRef=function(o,e,t,i){const r=j.Vector3[0],s=j.Vector3[1];let n=1/0;for(let a=this.verticesStart;a<this.verticesStart+this.verticesCount;a+=3){const l=e[a],c=e[a+1],h=e[a+2],u=x.ProjectOnTriangleToRef(o,l,c,h,s);u<n&&(r.copyFrom(s),n=u)}return i.copyFrom(r),n};qs.prototype.projectToRef=function(o,e,t,i){const r=this.getMaterial();if(!r)return-1;let s=3,n=!1;switch(r.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:s=1,n=!0;break}return r.fillMode===4?-1:!t.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(o,e,t,i):this._projectOnTrianglesToRef(o,e,t,s,n,i)};var zn;(function(o){o[o.DEHYDRATED=0]="DEHYDRATED",o[o.HOVER=1]="HOVER",o[o.TOUCH=2]="TOUCH"})(zn||(zn={}));var ec;(function(o){o[o.DISABLED=0]="DISABLED",o[o.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",o[o.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT"})(ec||(ec={}));class vo extends Gs{constructor(e,t){super(e),this._options=t,this._tmpRay=new Pt(new x,new x),this._attachController=i=>{if(this._controllers[i.uniqueId])return;const{touchCollisionMesh:r,touchCollisionMeshFunction:s,hydrateCollisionMeshFunction:n}=this._generateNewTouchPointMesh(),a=this._generateVisualCue();switch(this._controllers[i.uniqueId]={xrController:i,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:r,touchCollisionMeshFunction:s,hydrateCollisionMeshFunction:n,currentAnimationState:zn.DEHYDRATED,grabRay:new Pt(new x,new x),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,id:vo._IdCounter++,pickedPointVisualCue:a},this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&i.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=i.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=i.uniqueId),i.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(i);case"gaze":return null;case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new ge(.8,.8,.8),this.selectionMeshPickedColor=new ge(.3,.3,1),this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,this._options.nearInteractionControllerMode===void 0&&(this._options.nearInteractionControllerMode=ec.CENTERED_IN_FRONT),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){return super.attach()?(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,!0):!1}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),!0):!1}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,t){let i=e;for(;i;){if(i.reservedDataStore&&i.reservedDataStore.nearInteraction&&i.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;i=i.parent}return!0}_handleTransitionAnimation(e,t){var i;if(!(e.currentAnimationState===t||this._options.nearInteractionControllerMode!==ec.CENTERED_IN_FRONT||!((i=e.xrController)===null||i===void 0)&&i.inputSource.hand)){if(t>e.currentAnimationState)switch(e.currentAnimationState){case zn.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===zn.HOVER)break;case zn.HOVER:if(e.touchCollisionMeshFunction(!0),t===zn.TOUCH)break}else switch(e.currentAnimationState){case zn.TOUCH:if(e.touchCollisionMeshFunction(!1),t===zn.HOVER)break;case zn.HOVER:if(e.hydrateCollisionMeshFunction(!1),t===zn.DEHYDRATED)break}e.currentAnimationState=t}}_processTouchPoint(e,t,i){var r;const s=this._controllers[e];s.grabRay.origin.copyFrom(t),i.toEulerAnglesToRef(j.Vector3[0]),s.grabRay.direction.copyFrom(j.Vector3[0]),this._options.nearInteractionControllerMode===ec.CENTERED_IN_FRONT&&!(!((r=s.xrController)===null||r===void 0)&&r.inputSource.hand)&&(s.xrController.getWorldPointerRayToRef(this._tmpRay),s.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),s.grabRay.length=this._nearGrabLengthScale*this._hoverRadius,s.touchCollisionMesh.position.copyFrom(s.grabRay.origin)}_onXRFrame(e){Object.keys(this._controllers).forEach(t=>{var i;const r=this._controllers[t],s=(i=r.xrController)===null||i===void 0?void 0:i.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&t!==this._attachedController||!r.xrController||!s&&(!this._options.nearInteractionControllerMode||!r.xrController.inputSource.gamepad)){r.pick=null;return}if(r.hoverInteraction=!1,r.nearInteraction=!1,r.xrController){if(s){const c=s.get("index-finger-tip");if(c){const h=e.getJointPose(c,this._xrSessionManager.referenceSpace);if(h&&h.transform){const u=this._scene.useRightHandedSystem?1:-1;j.Vector3[0].set(h.transform.position.x,h.transform.position.y,h.transform.position.z*u),j.Quaternion[0].set(h.transform.orientation.x,h.transform.orientation.y,h.transform.orientation.z*u,h.transform.orientation.w*u),this._processTouchPoint(t,j.Vector3[0],j.Quaternion[0])}}}else if(r.xrController.inputSource.gamepad&&this._options.nearInteractionControllerMode!==ec.DISABLED){let c=r.xrController.pointer;r.xrController.grip&&this._options.nearInteractionControllerMode===ec.CENTERED_ON_CONTROLLER&&(c=r.xrController.grip),this._processTouchPoint(t,c.position,c.rotationQuaternion)}}else return;const n=(c,h)=>{let u=null;return!h||!h.hit?u=c:!c||!c.hit||h.distance<c.distance?u=h:u=c,u},a=c=>{let h=new Vs,u=!1;const d=c&&c.pickedPoint&&c.hit;return c!=null&&c.pickedPoint&&(u=c.pickedPoint.x===0&&c.pickedPoint.y===0&&c.pickedPoint.z===0),d&&!u&&(h=c),h};if(!r.grabInteraction){let c=null,h=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(h=this._pickWithSphere(r,this._hoverRadius,this._utilityLayerScene,f=>this._nearInteractionPredicate(f)));const u=this._pickWithSphere(r,this._hoverRadius,this._scene,f=>this._nearInteractionPredicate(f)),d=n(u,h);if(d&&d.hit&&(c=a(d),c.hit&&(r.hoverInteraction=!0)),r.hoverInteraction){let f=null;const _=s?this._pickRadius:this._controllerPickRadius;this._options.useUtilityLayer&&this._utilityLayerScene&&(f=this._pickWithSphere(r,_,this._utilityLayerScene,b=>this._nearPickPredicate(b)));const p=this._pickWithSphere(r,_,this._scene,b=>this._nearPickPredicate(b)),m=n(p,f),T=a(m);T.hit&&(c=T,r.nearInteraction=!0)}r.stalePick=r.pick,r.pick=c,r.pick&&r.pick.pickedPoint&&r.pick.hit?(r.meshUnderPointer=r.pick.pickedMesh,r.pickedPointVisualCue.position.copyFrom(r.pick.pickedPoint),r.pickedPointVisualCue.isVisible=!0,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(r.id,!0)):(r.meshUnderPointer=null,r.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(r.id,!1))}let l=zn.DEHYDRATED;r.grabInteraction||r.nearInteraction?l=zn.TOUCH:r.hoverInteraction&&(l=zn.HOVER),this._handleTransitionAnimation(r,l)})}get _utilityLayerScene(){return this._options.customUtilityLayerScene||yr.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||yr.DefaultUtilityLayer.utilityLayerScene:this._scene,t=jo("nearInteraction",{diameter:.0035*3},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=oe.Identity();const i=new Be("targetMat",e);return i.specularColor=ge.Black(),i.emissiveColor=this.selectionMeshDefaultColor,i.backFaceCulling=!1,t.material=i,t}_isControllerReadyForNearInteraction(e){return this._farInteractionFeature?this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e):!0}_attachNearInteractionMode(e){const t=this._controllers[e.uniqueId],i={pointerId:t.id,pointerType:"xr-near"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{!this._options.enableNearInteractionOnAllControllers&&e.uniqueId!==this._attachedController||!t.xrController||!t.xrController.inputSource.hand&&(!this._options.nearInteractionControllerMode||!t.xrController.inputSource.gamepad)||(t.pick&&(t.pick.ray=t.grabRay),t.pick&&this._isControllerReadyForNearInteraction(t.id)&&this._scene.simulatePointerMove(t.pick,i),t.nearInteraction&&t.pick&&t.pick.hit?t.nearInteractionTargetMesh||(this._scene.simulatePointerDown(t.pick,i),t.nearInteractionTargetMesh=t.meshUnderPointer):t.nearInteractionTargetMesh&&t.stalePick&&(this._scene.simulatePointerUp(t.stalePick,i),t.nearInteractionTargetMesh=null))});const r=s=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(t.id)?(t.pick&&(t.pick.ray=t.grabRay),s&&t.pick&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)?(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i)):!s&&t.pick&&t.grabInteraction&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)):s&&!this._options.enableNearInteractionOnAllControllers&&!this._options.disableSwitchOnClick&&(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){const s=n=>{t.squeezeComponent=n.getComponent("grasp"),t.squeezeComponent?t.onSqueezeButtonChangedObserver=t.squeezeComponent.onButtonStateChangedObservable.add(a=>{if(a.changes.pressed){const l=a.changes.pressed.current;r(l)}}):(t.selectionComponent=n.getMainComponent(),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(a=>{if(a.changes.pressed){const l=a.changes.pressed.current;r(l)}}))};e.motionController?s(e.motionController):e.onMotionControllerInitObservable.add(s)}else{const s=a=>{t.xrController&&a.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)&&(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i))},n=a=>{t.xrController&&a.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)};t.eventListeners={selectend:n,selectstart:s},this._xrSessionManager.session.addEventListener("selectstart",s),this._xrSessionManager.session.addEventListener("selectend",n)}}_detachController(e){const t=this._controllers[e];if(t&&(t.squeezeComponent&&t.onSqueezeButtonChangedObserver&&t.squeezeComponent.onButtonStateChangedObservable.remove(t.onSqueezeButtonChangedObserver),t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach(i=>{const r=t.eventListeners&&t.eventListeners[i];r&&this._xrSessionManager.session.removeEventListener(i,r)}),t.touchCollisionMesh.dispose(),t.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame(()=>{const i={pointerId:t.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new Vs,i)}),delete this._controllers[e],this._attachedController===e)){const i=Object.keys(this._controllers);i.length?this._attachedController=i[0]:this._attachedController=""}}_generateNewTouchPointMesh(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||yr.DefaultUtilityLayer.utilityLayerScene:this._scene,t=jo("PickSphere",{diameter:1},e);t.isVisible=!1,this._options.motionControllerOrbMaterial?t.material=this._options.motionControllerOrbMaterial:sr.ParseFromSnippetAsync("8RUNKL#3",e).then(P=>{t.material=P});const i=new gS;i.setEasingMode(xs.EASINGMODE_EASEINOUT);const r=new x(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius),s=this._controllerPickRadius*(4/3),n=new x(s,s,s),a=this._controllerPickRadius*(7/6),l=new x(a,a,a),c=this._controllerPickRadius*(4/5),h=new x(c,c,c),u=this._controllerPickRadius*(3/2),d=new x(u,u,u),f=[{frame:0,value:r},{frame:10,value:d},{frame:18,value:n}],_=[{frame:0,value:n},{frame:10,value:h},{frame:18,value:r}],p=[{frame:0,value:x.ZeroReadOnly},{frame:12,value:l},{frame:15,value:r}],m=[{frame:0,value:r},{frame:10,value:x.ZeroReadOnly},{frame:15,value:x.ZeroReadOnly}],T=new ae("touch","scaling",60,ae.ANIMATIONTYPE_VECTOR3,ae.ANIMATIONLOOPMODE_CONSTANT),b=new ae("release","scaling",60,ae.ANIMATIONTYPE_VECTOR3,ae.ANIMATIONLOOPMODE_CONSTANT),y=new ae("hydrate","scaling",60,ae.ANIMATIONTYPE_VECTOR3,ae.ANIMATIONLOOPMODE_CONSTANT),S=new ae("dehydrate","scaling",60,ae.ANIMATIONTYPE_VECTOR3,ae.ANIMATIONLOOPMODE_CONSTANT);return T.setEasingFunction(i),b.setEasingFunction(i),y.setEasingFunction(i),S.setEasingFunction(i),T.setKeys(f),b.setKeys(_),y.setKeys(p),S.setKeys(m),{touchCollisionMesh:t,touchCollisionMeshFunction:P=>{const D=P?T:b;e.beginDirectAnimation(t,[D],0,18,!1,1)},hydrateCollisionMeshFunction:P=>{const D=P?y:S;P&&(t.isVisible=!0),e.beginDirectAnimation(t,[D],0,15,!1,1,()=>{P||(t.isVisible=!1)})}}}_pickWithSphere(e,t,i,r){const s=new Vs;if(s.distance=1/0,e.touchCollisionMesh&&e.xrController){const n=e.touchCollisionMesh.position,a=Xo.CreateFromCenterAndRadius(n,t);for(let l=0;l<i.meshes.length;l++){const c=i.meshes[l];if(!r(c)||!this._controllerAvailablePredicate(c,e.xrController.uniqueId))continue;const h=vo.PickMeshWithSphere(c,a);h&&h.hit&&h.distance<s.distance&&(s.hit=h.hit,s.pickedMesh=c,s.pickedPoint=h.pickedPoint,s.aimTransform=e.xrController.pointer,s.gripTransform=e.xrController.grip||null,s.originMesh=e.touchCollisionMesh,s.distance=h.distance)}}return s}static PickMeshWithSphere(e,t,i=!1){const r=e.subMeshes,s=new Vs,n=e.getBoundingInfo();if(!e._generatePointsArray()||!e.subMeshes||!n||!i&&!Xo.Intersects(n.boundingSphere,t))return s;const a=j.Vector3[0],l=j.Vector3[1];let c=1/0,h,u,d;const f=j.Vector3[2],_=j.Matrix[0];_.copyFrom(e.getWorldMatrix()),_.invert(),x.TransformCoordinatesToRef(t.center,_,f);for(let p=0;p<r.length;p++)r[p].projectToRef(f,e._positions,e.getIndices(),l),x.TransformCoordinatesToRef(l,e.getWorldMatrix(),l),h=x.Distance(l,t.center),d=x.Distance(l,e.getAbsolutePosition()),u=x.Distance(t.center,e.getAbsolutePosition()),u!==-1&&d!==-1&&d>u&&(h=0,l.copyFrom(t.center)),h!==-1&&h<c&&(c=h,a.copyFrom(l));return c<t.radius&&(s.hit=!0,s.distance=c,s.pickedMesh=e,s.pickedPoint=a.clone()),s}}vo._IdCounter=200;vo.Name=si.NEAR_INTERACTION;vo.Version=1;dr.AddWebXRFeature(vo.Name,(o,e)=>()=>new vo(o,e),vo.Version,!0);class SO{constructor(e,t,i){this.element=e,this.sessionMode=t,this.referenceSpaceType=i}update(e){}}class Nm{constructor(e,t){if(this._scene=e,this.options=t,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new Q,this._onSessionGranted=r=>{this._helper&&this._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!t.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),typeof window<"u"&&window.location&&window.location.protocol==="http:"&&window.location.hostname!=="localhost")throw J.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(t.customButtons)this._buttons=t.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";const r=t.sessionMode||"immersive-vr",s=t.referenceSpaceType||"local-floor";let a=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(typeof SVGSVGElement>"u"?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";a+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';const l=document.createElement("style");l.appendChild(document.createTextNode(a)),document.getElementsByTagName("head")[0].appendChild(l);const c=document.createElement("button");c.className="babylonVRicon",c.title=`${r} - ${s}`,this._buttons.push(new SO(c,r,s)),this._buttons[this._buttons.length-1].update=function(h){this.element.style.display=h===null||h===this?"":"none",c.className="babylonVRicon"+(h===this?" vrdisplaypresenting":"")},this._updateButtons(null)}const i=e.getEngine().getInputElement();i&&i.parentNode&&(i.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce(()=>{this.dispose()}))}async setHelperAsync(e,t){this._helper=e,this._renderTarget=t;const i=this._buttons.map(s=>e.sessionManager.isSessionSupportedAsync(s.sessionMode));e.onStateChangedObservable.add(s=>{s==Hr.NOT_IN_XR&&this._updateButtons(null)}),(await Promise.all(i)).forEach((s,n)=>{s?(this.overlay.appendChild(this._buttons[n].element),this._buttons[n].element.onclick=this._enterXRWithButtonIndex.bind(this,n)):J.Warn(`Session mode "${this._buttons[n].sessionMode}" not supported in browser`)})}static async CreateAsync(e,t,i){const r=new Nm(e,i);return await r.setHelperAsync(t,i.renderTarget||void 0),r}async _enterXRWithButtonIndex(e=0){if(this._helper.state==Hr.IN_XR)await this._helper.exitXRAsync(),this._updateButtons(null);else if(this._helper.state==Hr.NOT_IN_XR)try{await this._helper.enterXRAsync(this._buttons[e].sessionMode,this._buttons[e].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this._updateButtons(this._buttons[e])}catch(t){this._updateButtons(null);const i=this._buttons[e].element,r=i.title;i.title="Error entering XR session : "+r,i.classList.add("xr-error"),this.options.onError&&this.options.onError(t)}}dispose(){const e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e,this._buttons.forEach(t=>{t.update(this._activeButton)}),this.activeButtonChangedObservable.notifyObservers(this._activeButton)}}var nx;(function(o){o[o.INIT=0]="INIT",o[o.STARTED=1]="STARTED",o[o.ENDED=2]="ENDED"})(nx||(nx={}));function ax(o){var e;let t=0;const i=Date.now();o.observableParameters=(e=o.observableParameters)!==null&&e!==void 0?e:{};const r=o.contextObservable.add(s=>{const n=Date.now();t=n-i;const a={startTime:i,currentTime:n,deltaTime:t,completeRate:t/o.timeout,payload:s};o.onTick&&o.onTick(a),o.breakCondition&&o.breakCondition()&&(o.contextObservable.remove(r),o.onAborted&&o.onAborted(a)),t>=o.timeout&&(o.contextObservable.remove(r),o.onEnded&&o.onEnded(a))},o.observableParameters.mask,o.observableParameters.insertFirst,o.observableParameters.scope);return r}class Yc extends Gs{get rotationEnabled(){return this._rotationEnabled}set rotationEnabled(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){const t=this._options.teleportationTargetMesh.getChildMeshes(!1,i=>i.name==="rotationCone");t[0]&&t[0].setEnabled(e)}}get teleportationTargetMesh(){return this._options.teleportationTargetMesh||null}constructor(e,t){super(e),this._options=t,this._controllers={},this._snappedToPoint=!1,this._tmpRay=new Pt(new x,new x),this._tmpVector=new x,this._tmpQuaternion=new oe,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new Q,this.teleportationEnabled=!0,this._rotationEnabled=!0,this._attachController=i=>{if(this._controllers[i.uniqueId]||this._options.forceHandedness&&i.inputSource.handedness!==this._options.forceHandedness)return;this._controllers[i.uniqueId]={xrController:i,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0}};const r=this._controllers[i.uniqueId];if(r.xrController.inputSource.targetRayMode==="tracked-pointer"&&r.xrController.inputSource.gamepad){const s=()=>{if(i.motionController){const n=i.motionController.getComponentOfType(qn.THUMBSTICK_TYPE)||i.motionController.getComponentOfType(qn.TOUCHPAD_TYPE);if(!n||this._options.useMainComponentOnly){const a=i.motionController.getMainComponent();if(!a)return;r.teleportationComponent=a,r.onButtonChangedObserver=a.onButtonStateChangedObservable.add(()=>{if(this.teleportationEnabled&&a.changes.pressed)if(a.changes.pressed.current){r.teleportationState.forward=!0,this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,r.teleportationState.currentRotation=0;const l=this._options.timeToTeleport||3e3;ax({timeout:l,contextObservable:this._xrSessionManager.onXRFrameObservable,breakCondition:()=>!a.pressed,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&r.teleportationState.forward&&this._teleportForward(i.uniqueId)}})}else r.teleportationState.forward=!1,this._currentTeleportationControllerId=""})}else r.teleportationComponent=n,r.onAxisChangedObserver=n.onAxisValueChangedObservable.add(a=>{if(a.y<=.7&&r.teleportationState.backwards&&(r.teleportationState.backwards=!1),a.y>.7&&!r.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!r.teleportationState.backwards){r.teleportationState.backwards=!0,this._tmpQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion),this._tmpQuaternion.toEulerAnglesToRef(this._tmpVector),this._tmpVector.x=0,this._tmpVector.z=0,oe.FromEulerVectorToRef(this._tmpVector,this._tmpQuaternion),this._tmpVector.set(0,0,this.backwardsTeleportationDistance*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),this._tmpVector.rotateByQuaternionToRef(this._tmpQuaternion,this._tmpVector),this._tmpVector.addInPlace(this._options.xrInput.xrCamera.position),this._tmpRay.origin.copyFrom(this._tmpVector),this._tmpRay.length=this._options.xrInput.xrCamera.realWorldHeight+.1,this._tmpRay.direction.set(0,-1,0);const l=this._xrSessionManager.scene.pickWithRay(this._tmpRay,c=>this._floorMeshes.indexOf(c)!==-1);l&&l.pickedPoint&&(this._options.xrInput.xrCamera.position.x=l.pickedPoint.x,this._options.xrInput.xrCamera.position.z=l.pickedPoint.z)}if(a.y<-.7&&!this._currentTeleportationControllerId&&!r.teleportationState.rotating&&this.teleportationEnabled&&(r.teleportationState.forward=!0,this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),a.x){if(r.teleportationState.forward)this._currentTeleportationControllerId===r.xrController.uniqueId&&(this.rotationEnabled?setTimeout(()=>{r.teleportationState.currentRotation=Math.atan2(a.x,a.y*(this._xrSessionManager.scene.useRightHandedSystem?1:-1))}):r.teleportationState.currentRotation=0);else if(!r.teleportationState.rotating&&Math.abs(a.x)>.7){r.teleportationState.rotating=!0;const l=this.rotationAngle*(a.x>0?1:-1)*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);oe.FromEulerAngles(0,l,0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion)}}else r.teleportationState.rotating=!1;a.x===0&&a.y===0&&r.teleportationState.forward&&this._teleportForward(i.uniqueId)})}};i.motionController?s():i.onMotionControllerInitObservable.addOnce(()=>{s()})}else this._xrSessionManager.scene.onPointerObservable.add(s=>{if(s.type===Qe.POINTERDOWN){r.teleportationState.forward=!0,this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,r.teleportationState.currentRotation=0;const n=this._options.timeToTeleport||3e3;ax({timeout:n,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&r.teleportationState.forward&&this._teleportForward(i.uniqueId)}})}else s.type===Qe.POINTERUP&&(r.teleportationState.forward=!1,this._currentTeleportationControllerId="")})},this._options.teleportationTargetMesh||this._createDefaultTargetMesh(),this._floorMeshes=this._options.floorMeshes||[],this._snapToPositions=this._options.snapPositions||[],this._setTargetMeshVisibility(!1)}get snapPointsOnly(){return!!this._options.snapPointsOnly}set snapPointsOnly(e){this._options.snapPointsOnly=e}addFloorMesh(e){this._floorMeshes.push(e)}addBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)}addSnapPoint(e){this._snapToPositions.push(e)}attach(){return super.attach()?(this._currentTeleportationControllerId="",this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0):!1}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0):!1}dispose(){super.dispose(),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0)}removeFloorMesh(e){const t=this._floorMeshes.indexOf(e);t!==-1&&this._floorMeshes.splice(t,1)}removeBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];const t=this._options.pickBlockerMeshes.indexOf(e);t!==-1&&this._options.pickBlockerMeshes.splice(t,1)}removeFloorMeshByName(e){const t=this._xrSessionManager.scene.getMeshByName(e);t&&this.removeFloorMesh(t)}removeSnapPoint(e){let t=this._snapToPositions.indexOf(e);if(t===-1){for(let i=0;i<this._snapToPositions.length;++i)if(this._snapToPositions[i].equals(e)){t=i;break}}return t!==-1?(this._snapToPositions.splice(t,1),!0):!1}setSelectionFeature(e){this._selectionFeature=e}_onXRFrame(e){const t=this._xrSessionManager.currentFrame,i=this._xrSessionManager.scene;if(!this.attach||!t)return;const r=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!r)return;r.rotationQuaternion=r.rotationQuaternion||new oe;const s=this._controllers[this._currentTeleportationControllerId];if(s&&s.teleportationState.forward){oe.RotationYawPitchRollToRef(s.teleportationState.currentRotation+s.teleportationState.baseRotation,0,0,r.rotationQuaternion);let n=!1;if(s.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){const a=i.pickWithRay(this._tmpRay,l=>{if(this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(l)!==-1)return!0;const c=this._floorMeshes.indexOf(l);return c===-1?!1:this._floorMeshes[c].absolutePosition.y<this._options.xrInput.xrCamera.globalPosition.y});if(a&&a.pickedMesh&&this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(a.pickedMesh)!==-1)return;a&&a.pickedPoint&&(n=!0,this._setTargetMeshPosition(a),this._setTargetMeshVisibility(!0),this._showParabolicPath(a))}if(this.parabolicRayEnabled&&!n){const a=s.xrController.pointer.rotationQuaternion.toEulerAngles().x,l=1+(Math.PI/2-Math.abs(a)),c=this.parabolicCheckRadius*l;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(c*2),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(c)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();const h=i.pickWithRay(this._tmpRay,u=>this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(u)!==-1?!0:this._floorMeshes.indexOf(u)!==-1);if(h&&h.pickedMesh&&this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(h.pickedMesh)!==-1)return;h&&h.pickedPoint&&(n=!0,this._setTargetMeshPosition(h),this._setTargetMeshVisibility(!0),this._showParabolicPath(h))}this._setTargetMeshVisibility(n)}else this._setTargetMeshVisibility(!1)}else this._setTargetMeshVisibility(!1)}_createDefaultTargetMesh(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||yr.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,t=Tm("teleportationTarget",{width:2,height:2,subdivisions:2},e);if(t.isPickable=!1,this._options.defaultTargetMeshOptions.teleportationCircleMaterial)t.material=this._options.defaultTargetMeshOptions.teleportationCircleMaterial;else{const n=new za("teleportationPlaneDynamicTexture",512,e,!0);n.hasAlpha=!0;const a=n.getContext(),l=512/2,c=512/2,h=200;a.beginPath(),a.arc(l,c,h,0,2*Math.PI,!1),a.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",a.fill(),a.lineWidth=10,a.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",a.stroke(),a.closePath(),n.update();const u=new Be("teleportationPlaneMaterial",e);u.diffuseTexture=n,t.material=u}const i=ah("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(i.isPickable=!1,i.parent=t,!this._options.defaultTargetMeshOptions.disableAnimation){const s=new ae("animationInnerCircle","position.y",30,ae.ANIMATIONTYPE_FLOAT,ae.ANIMATIONLOOPMODE_CYCLE),n=[];n.push({frame:0,value:0}),n.push({frame:30,value:.4}),n.push({frame:60,value:0}),s.setKeys(n);const a=new fT;a.setEasingMode(xs.EASINGMODE_EASEINOUT),s.setEasingFunction(a),i.animations=[],i.animations.push(s),e.beginAnimation(i,0,60,!0)}const r=Ff("rotationCone",{diameterTop:0,tessellation:4},e);if(r.isPickable=!1,r.scaling.set(.5,.12,.2),r.rotate(As.X,Math.PI/2),r.position.z=.6,r.parent=i,this._options.defaultTargetMeshOptions.torusArrowMaterial)i.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,r.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{const s=new Be("torusConsMat",e);s.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,s.disableLighting?s.emissiveColor=new ge(.3,.3,1):s.diffuseColor=new ge(.3,.3,1),s.alpha=.9,i.material=s,r.material=s,this._teleportationRingMaterial=s}this._options.renderingGroupId!==void 0&&(t.renderingGroupId=this._options.renderingGroupId,i.renderingGroupId=this._options.renderingGroupId,r.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=t,this._setTargetMeshVisibility(!1)}_detachController(e){const t=this._controllers[e];t&&(t.teleportationComponent&&(t.onAxisChangedObserver&&t.teleportationComponent.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.teleportationComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver)),delete this._controllers[e])}_findClosestSnapPointWithRadius(e,t=this._options.snapToPositionRadius||.8){let i=null,r=Number.MAX_VALUE;if(this._snapToPositions.length){const s=t*t;this._snapToPositions.forEach(n=>{const a=x.DistanceSquared(n,e);a<=s&&a<r&&(r=a,i=n)})}return i}_setTargetMeshPosition(e){const t=e.pickedPoint;if(!this._options.teleportationTargetMesh||!t)return;const i=this._findClosestSnapPointWithRadius(t);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||t),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}_setTargetMeshVisibility(e){this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible!==e&&(this._options.teleportationTargetMesh.isVisible=e,this._options.teleportationTargetMesh.getChildren(void 0,!1).forEach(t=>{t.isVisible=e}),e?this._selectionFeature&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&this._selectionFeature.attach()))}_showParabolicPath(e){if(!e.pickedPoint||!this._currentTeleportationControllerId)return;const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||yr.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=this._controllers[this._currentTeleportationControllerId],r=Lo.CreateQuadraticBezier(i.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25);this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(r.getPoints(),e):this._quadraticBezierCurve=Sm("teleportation path line",{points:r.getPoints(),instance:this._quadraticBezierCurve,updatable:!0},t),this._quadraticBezierCurve.isPickable=!1,this._options.renderingGroupId!==void 0&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}_teleportForward(e){const t=this._controllers[e];if(!(!t||!t.teleportationState.forward||!this.teleportationEnabled)&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="",!(this.snapPointsOnly&&!this._snappedToPoint))){if(this.skipNextTeleportation){this.skipNextTeleportation=!1;return}if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){const i=this._options.xrInput.xrCamera.realWorldHeight;this._options.xrInput.xrCamera.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=i,oe.FromEulerAngles(0,t.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this._options.xrInput.xrCamera.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}}}Yc.Name=si.TELEPORTATION;Yc.Version=1;dr.AddWebXRFeature(Yc.Name,(o,e)=>()=>new Yc(o,e),Yc.Version,!0);class wm{constructor(){}static CreateAsync(e,t={}){const i=new wm;if(e.onDisposeObservable.addOnce(()=>{i.dispose()}),!t.disableDefaultUI){const r={renderTarget:i.renderTarget,...t.uiOptions||{}};t.optionalFeatures&&(typeof t.optionalFeatures=="boolean"?r.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:r.optionalFeatures=t.optionalFeatures),i.enterExitUI=new Nm(e,r)}return Dm.CreateAsync(e).then(r=>{if(i.baseExperience=r,t.ignoreNativeCameraTransformation&&(i.baseExperience.camera.compensateOnFirstFrame=!1),i.input=new bO(r.sessionManager,r.camera,{controllerOptions:{renderingGroupId:t.renderingGroupId},...t.inputOptions||{}}),!t.disablePointerSelection){const s={...t.pointerSelectionOptions,xrInput:i.input,renderingGroupId:t.renderingGroupId};i.pointerSelection=i.baseExperience.featuresManager.enableFeature(go.Name,t.useStablePlugins?"stable":"latest",s),t.disableTeleportation||(i.teleportation=i.baseExperience.featuresManager.enableFeature(Yc.Name,t.useStablePlugins?"stable":"latest",{floorMeshes:t.floorMeshes,xrInput:i.input,renderingGroupId:t.renderingGroupId,...t.teleportationOptions}),i.teleportation.setSelectionFeature(i.pointerSelection))}if(t.disableNearInteraction||(i.nearInteraction=i.baseExperience.featuresManager.enableFeature(vo.Name,t.useStablePlugins?"stable":"latest",{xrInput:i.input,farInteractionFeature:i.pointerSelection,renderingGroupId:t.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0,...t.nearInteractionOptions})),i.renderTarget=i.baseExperience.sessionManager.getWebXRRenderTarget(t.outputCanvasOptions),!t.disableDefaultUI)return i.enterExitUI.setHelperAsync(i.baseExperience,i.renderTarget)}).then(()=>i).catch(r=>(X.Error("Error initializing XR"),X.Error(r),i))}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}}Ne.prototype.createDefaultLight=function(o=!1){if(o&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();this.lights.length===0&&new kl("default light",x.Up(),this)};Ne.prototype.createDefaultCamera=function(o=!1,e=!1,t=!1){if(e&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){const i=this.getWorldExtends(l=>l.isVisible&&l.isEnabled()),r=i.max.subtract(i.min),s=i.min.add(r.scale(.5));let n,a=r.length()*1.5;if(isFinite(a)||(a=1,s.copyFromFloats(0,0,0)),o){const l=new Ei("default camera",-(Math.PI/2),Math.PI/2,a,s,this);l.lowerRadiusLimit=a*.01,l.wheelPrecision=100/a,n=l}else{const l=new Qs("default camera",new x(s.x,s.y,-a),this);l.setTarget(s),n=l}n.minZ=a*.01,n.maxZ=a*1e3,n.speed=a*.2,this.activeCamera=n,t&&n.attachControl()}};Ne.prototype.createDefaultCameraOrLight=function(o=!1,e=!1,t=!1){this.createDefaultLight(e),this.createDefaultCamera(o,e,t)};Ne.prototype.createDefaultSkybox=function(o,e=!1,t=1e3,i=0,r=!0){if(!o)return X.Warn("Can not create default skybox without environment texture."),null;r&&o&&(this.environmentTexture=o);const s=bm("hdrSkyBox",{size:t},this);if(e){const n=new He("skyBox",this);n.backFaceCulling=!1,n.reflectionTexture=o.clone(),n.reflectionTexture&&(n.reflectionTexture.coordinatesMode=Y.SKYBOX_MODE),n.microSurface=1-i,n.disableLighting=!0,n.twoSidedLighting=!0,s.material=n}else{const n=new Be("skyBox",this);n.backFaceCulling=!1,n.reflectionTexture=o.clone(),n.reflectionTexture&&(n.reflectionTexture.coordinatesMode=Y.SKYBOX_MODE),n.disableLighting=!0,s.material=n}return s.isPickable=!1,s.infiniteDistance=!0,s.ignoreCameraMaxZ=!0,s};Ne.prototype.createDefaultEnvironment=function(o){return fc?new fc(o,this):null};Ne.prototype.createDefaultVRExperience=function(o={}){return new oh(this,o)};Ne.prototype.createDefaultXRExperienceAsync=function(o={}){return wm.CreateAsync(this,o).then(e=>e)};function ox(o){for(;o.firstChild;)o.removeChild(o.firstChild);o.srcObject=null,o.src="",o.removeAttribute("src")}class Zd extends Y{get onUserActionRequestedObservable(){return this._onUserActionRequestedObservable||(this._onUserActionRequestedObservable=new Q),this._onUserActionRequestedObservable}_processError(e){this._errorFound=!0,this._onError?this._onError(e==null?void 0:e.message):X.Error(e==null?void 0:e.message)}_handlePlay(){this._errorFound=!1,this.video.play().catch(e=>{if((e==null?void 0:e.name)==="NotAllowedError"){if(this._onUserActionRequestedObservable&&this._onUserActionRequestedObservable.hasObservers()){this._onUserActionRequestedObservable.notifyObservers(this);return}else if(!this.video.muted){X.Warn("Unable to autoplay a video with sound. Trying again with muted turned true"),this.video.muted=!0,this._errorFound=!1,this.video.play().catch(t=>{this._processError(t)});return}}this._processError(e)})}constructor(e,t,i,r=!1,s=!1,n=Y.TRILINEAR_SAMPLINGMODE,a={},l,c=5){var h,u;super(null,i,!r,s),this._onUserActionRequestedObservable=null,this._stillImageCaptured=!1,this._displayingPosterTexture=!1,this._frameId=-1,this._currentSrc=null,this._errorFound=!1,this._resizeInternalTexture=()=>{var f;this._texture!=null&&this._texture.dispose(),!this._getEngine().needPOTTextures||J.IsExponentOfTwo(this.video.videoWidth)&&J.IsExponentOfTwo(this.video.videoHeight)?(this.wrapU=Y.WRAP_ADDRESSMODE,this.wrapV=Y.WRAP_ADDRESSMODE):(this.wrapU=Y.CLAMP_ADDRESSMODE,this.wrapV=Y.CLAMP_ADDRESSMODE,this._generateMipMaps=!1),this._texture=this._getEngine().createDynamicTexture(this.video.videoWidth,this.video.videoHeight,this._generateMipMaps,this.samplingMode),this._texture.format=(f=this._format)!==null&&f!==void 0?f:5,this._frameId=-1,this._updateInternalTexture()},this._createInternalTexture=()=>{if(this._texture!=null)if(this._displayingPosterTexture)this._displayingPosterTexture=!1;else return;if(this.video.addEventListener("resize",this._resizeInternalTexture),this._resizeInternalTexture(),!this.video.autoplay&&!this._settings.poster&&!this._settings.independentVideoSource){const f=this.video.onplaying,_=this.video.muted;this.video.muted=!0,this.video.onplaying=()=>{this.video.muted=_,this.video.onplaying=f,this._updateInternalTexture(),this._errorFound||this.video.pause(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._handlePlay()}else this._updateInternalTexture(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._reset=()=>{this._texture!=null&&(this._displayingPosterTexture||(this._texture.dispose(),this._texture=null))},this._updateInternalTexture=()=>{if(this._texture==null||this.video.readyState<this.video.HAVE_CURRENT_DATA||this._displayingPosterTexture)return;const f=this.getScene().getFrameId();this._frameId!==f&&(this._frameId=f,this._getEngine().updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:this.video,this._invertY))},this._settings={autoPlay:!0,loop:!0,autoUpdateTexture:!0,...a},this._onError=l,this._generateMipMaps=r,this._initialSamplingMode=n,this.autoUpdateTexture=this._settings.autoUpdateTexture,this._currentSrc=t,this.name=e||this._getName(t),this.video=this._getVideo(t),this._externalTexture=(u=(h=this._engine)===null||h===void 0?void 0:h.createExternalTexture(this.video))!==null&&u!==void 0?u:null,this._settings.independentVideoSource||(this._settings.poster&&(this.video.poster=this._settings.poster),this._settings.autoPlay!==void 0&&(this.video.autoplay=this._settings.autoPlay),this._settings.loop!==void 0&&(this.video.loop=this._settings.loop),this._settings.muted!==void 0&&(this.video.muted=this._settings.muted),this.video.setAttribute("playsinline",""),this.video.addEventListener("paused",this._updateInternalTexture),this.video.addEventListener("seeked",this._updateInternalTexture),this.video.addEventListener("emptied",this._reset),this._settings.autoPlay&&this._handlePlay()),this._createInternalTextureOnEvent=this._settings.poster&&!this._settings.autoPlay?"play":"canplay",this.video.addEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._format=c;const d=this.video.readyState>=this.video.HAVE_CURRENT_DATA;this._settings.poster&&(!this._settings.autoPlay||!d)?(this._texture=this._getEngine().createTexture(this._settings.poster,!1,!this.invertY,i),this._displayingPosterTexture=!0):d&&this._createInternalTexture()}getClassName(){return"VideoTexture"}_getName(e){return e instanceof HTMLVideoElement?e.currentSrc:typeof e=="object"?e.toString():e}_getVideo(e){if(e.isNative)return e;if(e instanceof HTMLVideoElement)return J.SetCorsBehavior(e.currentSrc,e),e;const t=document.createElement("video");return typeof e=="string"?(J.SetCorsBehavior(e,t),t.src=e):(J.SetCorsBehavior(e[0],t),e.forEach(i=>{const r=document.createElement("source");r.src=i,t.appendChild(r)})),this.onDisposeObservable.addOnce(()=>{ox(t)}),t}_rebuild(){this.update()}update(){this.autoUpdateTexture&&this.updateTexture(!0)}updateTexture(e){e&&(this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture()))}updateURL(e){this.video.src=e,this._currentSrc=e}clone(){return new Zd(this.name,this._currentSrc,this.getScene(),this._generateMipMaps,this.invertY,this.samplingMode,this._settings)}dispose(){var e;super.dispose(),this._currentSrc=null,this._onUserActionRequestedObservable&&(this._onUserActionRequestedObservable.clear(),this._onUserActionRequestedObservable=null),this.video.removeEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._settings.independentVideoSource||(this.video.removeEventListener("paused",this._updateInternalTexture),this.video.removeEventListener("seeked",this._updateInternalTexture),this.video.removeEventListener("emptied",this._reset),this.video.removeEventListener("resize",this._resizeInternalTexture),this.video.pause()),(e=this._externalTexture)===null||e===void 0||e.dispose()}static CreateFromStreamAsync(e,t,i,r=!0){const s=e.getEngine().createVideoElement(i);return e.getEngine()._badOS&&(document.body.appendChild(s),s.style.transform="scale(0.0001, 0.0001)",s.style.opacity="0",s.style.position="fixed",s.style.bottom="0px",s.style.right="0px"),s.setAttribute("autoplay",""),s.setAttribute("muted","true"),s.setAttribute("playsinline",""),s.muted=!0,s.isNative||(s.mozSrcObject!==void 0?s.mozSrcObject=t:typeof s.srcObject=="object"?s.srcObject=t:s.src=window.URL&&window.URL.createObjectURL(t)),new Promise(n=>{const a=()=>{const l=new Zd("video",s,e,!0,r,void 0,void 0,void 0,4);e.getEngine()._badOS&&l.onDisposeObservable.addOnce(()=>{s.remove()}),l.onDisposeObservable.addOnce(()=>{ox(s)}),n(l),s.removeEventListener("playing",a)};s.addEventListener("playing",a),s.play()})}static async CreateFromWebCamAsync(e,t,i=!1,r=!0){if(navigator.mediaDevices){const s=await navigator.mediaDevices.getUserMedia({video:t,audio:i}),n=await this.CreateFromStreamAsync(e,s,t,r);return n.onDisposeObservable.addOnce(()=>{s.getTracks().forEach(a=>{a.stop()})}),n}return Promise.reject("No support for userMedia on this device")}static CreateFromWebCam(e,t,i,r=!1,s=!0){this.CreateFromWebCamAsync(e,i,r,s).then(function(n){t&&t(n)}).catch(function(n){X.Error(n.name)})}}class Fm extends En{get videoTexture(){return this._texture}get videoMode(){return this.textureMode}set videoMode(e){this.textureMode=e}_initTexture(e,t,i){const r={loop:i.loop,autoPlay:i.autoPlay,autoUpdateTexture:!0,poster:i.poster},s=new Zd((this.name||"videoDome")+"_texture",e,t,i.generateMipMaps,this._useDirectMapping,Y.TRILINEAR_SAMPLINGMODE,r);return i.clickToPlay&&(this._pointerObserver=t.onPointerObservable.add(n=>{var a;((a=n.pickInfo)===null||a===void 0?void 0:a.pickedMesh)===this.mesh&&this._texture.video.play()},Qe.POINTERDOWN)),this._textureObserver=s.onLoadObservable.add(()=>{this.onLoadObservable.notifyObservers()}),s}dispose(e,t=!1){this._texture.onLoadObservable.remove(this._textureObserver),this._scene.onPointerObservable.remove(this._pointerObserver),super.dispose(e,t)}}Fm.MODE_MONOSCOPIC=En.MODE_MONOSCOPIC;Fm.MODE_TOPBOTTOM=En.MODE_TOPBOTTOM;Fm.MODE_SIDEBYSIDE=En.MODE_SIDEBYSIDE;const yO="glowMapGenerationPixelShader",CO=`#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)
#include<helperFunctions>
#endif
#ifdef DIFFUSE
varying vec2 vUVDiffuse;
uniform sampler2D diffuseSampler;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;
uniform sampler2D opacitySampler;
uniform float opacityIntensity;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;
uniform sampler2D emissiveSampler;
#endif
#ifdef VERTEXALPHA
varying vec4 vColor;
#endif
uniform vec4 glowColor;
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
vec4 finalColor=glowColor;
#ifdef DIFFUSE
vec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);
#ifdef DIFFUSE_ISLINEAR
albedoTexture=toGammaSpace(albedoTexture);
#endif
#ifdef GLOW
finalColor.a*=albedoTexture.a;
#endif
#ifdef HIGHLIGHT
finalColor.a=albedoTexture.a;
#endif
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vUVOpacity);
#ifdef OPACITYRGB
finalColor.a*=getLuminance(opacityMap.rgb);
#else
finalColor.a*=opacityMap.a;
#endif
finalColor.a*=opacityIntensity;
#endif
#ifdef VERTEXALPHA
finalColor.a*=vColor.a;
#endif
#ifdef ALPHATEST
if (finalColor.a<ALPHATESTVALUE)
discard;
#endif
#ifdef EMISSIVE
vec4 emissive=texture2D(emissiveSampler,vUVEmissive);
#ifdef EMISSIVE_ISLINEAR
emissive=toGammaSpace(emissive);
#endif
gl_FragColor=emissive*finalColor;
#else
gl_FragColor=finalColor;
#endif
#ifdef HIGHLIGHT
gl_FragColor.a=glowColor.a;
#endif
}`;te.ShadersStore[yO]=CO;const AO="glowMapGenerationVertexShader",RO=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;
varying vec4 vPosition;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef DIFFUSE
varying vec2 vUVDiffuse;
uniform mat4 diffuseMatrix;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;
uniform mat4 opacityMatrix;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;
uniform mat4 emissiveMatrix;
#endif
#ifdef VERTEXALPHA
attribute vec4 color;
varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef CUBEMAP
vPosition=worldPos;
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#else
vPosition=viewProjection*worldPos;
gl_Position=vPosition;
#endif
#ifdef DIFFUSE
#ifdef DIFFUSEUV1
vUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef DIFFUSEUV2
vUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef OPACITY
#ifdef OPACITYUV1
vUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef OPACITYUV2
vUVOpacity=vec2(opacityMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef EMISSIVE
#ifdef EMISSIVEUV1
vUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef EMISSIVEUV2
vUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef VERTEXALPHA
vColor=color;
#endif
#include<clipPlaneVertex>
}`;te.ShadersStore[AO]=RO;class pa{get camera(){return this._effectLayerOptions.camera}get renderingGroupId(){return this._effectLayerOptions.renderingGroupId}set renderingGroupId(e){this._effectLayerOptions.renderingGroupId=e}get mainTexture(){return this._mainTexture}setMaterialForRendering(e,t){if(this._mainTexture.setMaterialForRendering(e,t),Array.isArray(e))for(let i=0;i<e.length;++i){const r=e[i];t?this._materialForRendering[r.uniqueId]=[r,t]:delete this._materialForRendering[r.uniqueId]}else t?this._materialForRendering[e.uniqueId]=[e,t]:delete this._materialForRendering[e.uniqueId]}constructor(e,t){this._vertexBuffers={},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._shouldRender=!0,this._postProcesses=[],this._textures=[],this._emissiveTextureAndColor={texture:null,color:new Ye},this.neutralColor=new Ye,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new Q,this.onBeforeRenderMainTextureObservable=new Q,this.onBeforeComposeObservable=new Q,this.onBeforeRenderMeshToEffect=new Q,this.onAfterRenderMeshToEffect=new Q,this.onAfterComposeObservable=new Q,this.onSizeChangedObservable=new Q,this._materialForRendering={},this.name=e,this._scene=t||qe.LastCreatedScene,pa._SceneComponentInitialization(this._scene),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.effectLayers.push(this),this._mergeDrawWrapper=[],this._generateIndexBuffer(),this._generateVertexBuffer()}_numInternalDraws(){return 1}_init(e){this._effectLayerOptions={mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,...e},this._setMainTextureSize(),this._createMainTexture(),this._createTextureAndPostProcesses()}_generateIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._engine.createIndexBuffer(e)}_generateVertexBuffer(){const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1);const t=new O(this._engine,e,O.PositionKind,!1,!1,2);this._vertexBuffers[O.PositionKind]=t}_setMainTextureSize(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?q.GetExponentOfTwo(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?q.GetExponentOfTwo(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)}_createMainTexture(){this._mainTexture=new Zi("EffectLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,this._effectLayerOptions.mainTextureType),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=Y.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=Y.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(Y.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0;for(const e in this._materialForRendering){const[t,i]=this._materialForRendering[e];this._mainTexture.setMaterialForRendering(t,i)}if(this._mainTexture.customIsReadyFunction=(e,t,i)=>{if((i||t===0)&&e.subMeshes)for(let r=0;r<e.subMeshes.length;++r){const s=e.subMeshes[r],n=s.getMaterial(),a=s.getRenderingMesh();if(!n)continue;const c=a._getInstancesRenderList(s._id,!!s.getReplacementMesh()).hardwareInstancedRendering[s._id]||a.hasThinInstances;if(this._setEmissiveTextureAndColor(a,s,n),!this._isReady(s,c,this._emissiveTextureAndColor.texture))return!1}return!0},this._mainTexture.customRenderFunction=(e,t,i,r)=>{this.onBeforeRenderMainTextureObservable.notifyObservers(this);let s;const n=this._scene.getEngine();if(r.length){for(n.setColorWrite(!1),s=0;s<r.length;s++)this._renderSubMesh(r.data[s]);n.setColorWrite(!0)}for(s=0;s<e.length;s++)this._renderSubMesh(e.data[s]);for(s=0;s<t.length;s++)this._renderSubMesh(t.data[s]);const a=n.getAlphaMode();for(s=0;s<i.length;s++)this._renderSubMesh(i.data[s],!0);n.setAlphaMode(a)},this._mainTexture.onClearObservable.add(e=>{e.clear(this.neutralColor,!0,!0,!0)}),this._scene.getBoundingBoxRenderer){const e=this._scene.getBoundingBoxRenderer().enabled;this._mainTexture.onBeforeBindObservable.add(()=>{this._scene.getBoundingBoxRenderer().enabled=!this.disableBoundingBoxesFromEffectLayer&&e}),this._mainTexture.onAfterUnbindObservable.add(()=>{this._scene.getBoundingBoxRenderer().enabled=e})}}_addCustomEffectDefines(e){}_isReady(e,t,i){var r;const s=this._scene.getEngine(),n=e.getMesh(),a=(r=n._internalAbstractMeshDataInfo._materialForRenderPass)===null||r===void 0?void 0:r[s.currentRenderPassId];if(a)return a.isReadyForSubMesh(n,e,t);const l=e.getMaterial();if(!l)return!1;if(this._useMeshMaterial(e.getRenderingMesh()))return l.isReadyForSubMesh(e.getMesh(),e,t);const c=[],h=[O.PositionKind];let u=!1,d=!1;if(l){const y=l.needAlphaTesting(),S=l.getAlphaTestTexture(),C=S&&S.hasAlpha&&(l.useAlphaFromDiffuseTexture||l._useAlphaFromAlbedoTexture);S&&(y||C)&&(c.push("#define DIFFUSE"),n.isVerticesDataPresent(O.UV2Kind)&&S.coordinatesIndex===1?(c.push("#define DIFFUSEUV2"),d=!0):n.isVerticesDataPresent(O.UVKind)&&(c.push("#define DIFFUSEUV1"),u=!0),y&&(c.push("#define ALPHATEST"),c.push("#define ALPHATESTVALUE 0.4")),S.gammaSpace||c.push("#define DIFFUSE_ISLINEAR"));const I=l.opacityTexture;I&&(c.push("#define OPACITY"),n.isVerticesDataPresent(O.UV2Kind)&&I.coordinatesIndex===1?(c.push("#define OPACITYUV2"),d=!0):n.isVerticesDataPresent(O.UVKind)&&(c.push("#define OPACITYUV1"),u=!0))}i&&(c.push("#define EMISSIVE"),n.isVerticesDataPresent(O.UV2Kind)&&i.coordinatesIndex===1?(c.push("#define EMISSIVEUV2"),d=!0):n.isVerticesDataPresent(O.UVKind)&&(c.push("#define EMISSIVEUV1"),u=!0),i.gammaSpace||c.push("#define EMISSIVE_ISLINEAR")),n.useVertexColors&&n.isVerticesDataPresent(O.ColorKind)&&n.hasVertexAlpha&&l.transparencyMode!==me.MATERIAL_OPAQUE&&(h.push(O.ColorKind),c.push("#define VERTEXALPHA")),u&&(h.push(O.UVKind),c.push("#define UV1")),d&&(h.push(O.UV2Kind),c.push("#define UV2"));const f=new pc;if(n.useBones&&n.computeBonesUsingShaders){h.push(O.MatricesIndicesKind),h.push(O.MatricesWeightsKind),n.numBoneInfluencers>4&&(h.push(O.MatricesIndicesExtraKind),h.push(O.MatricesWeightsExtraKind)),c.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers);const y=n.skeleton;y&&y.isUsingTextureForMatrices?c.push("#define BONETEXTURE"):c.push("#define BonesPerMesh "+(y?y.bones.length+1:0)),n.numBoneInfluencers>0&&f.addCPUSkinningFallback(0,n)}else c.push("#define NUM_BONE_INFLUENCERS 0");const _=n.morphTargetManager;let p=0;_&&_.numInfluencers>0&&(c.push("#define MORPHTARGETS"),p=_.numInfluencers,c.push("#define NUM_MORPH_INFLUENCERS "+p),_.isUsingTextureForTargets&&c.push("#define MORPHTARGETS_TEXTURE"),Ce.PrepareAttributesForMorphTargetsInfluencers(h,n,p)),t&&(c.push("#define INSTANCES"),Ce.PushAttributesForInstances(h),e.getRenderingMesh().hasThinInstances&&c.push("#define THIN_INSTANCES")),Zo(l,this._scene,c),this._addCustomEffectDefines(c);const m=e._getDrawWrapper(void 0,!0),T=m.defines,b=c.join(`
`);if(T!==b){const y=["world","mBones","viewProjection","glowColor","morphTargetInfluences","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices"];ja(y),m.setEffect(this._engine.createEffect("glowMapGeneration",h,y,["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],b,f,void 0,void 0,{maxSimultaneousMorphTargets:p}),b)}return m.effect.isReady()}render(){for(let n=0;n<this._postProcesses.length;n++)if(!this._postProcesses[n].isReady())return;const e=this._scene.getEngine(),t=this._numInternalDraws();let i=!0;for(let n=0;n<t;++n){let a=this._mergeDrawWrapper[n];a||(a=this._mergeDrawWrapper[n]=new vs(this._engine),a.setEffect(this._createMergeEffect())),i=i&&a.effect.isReady()}if(!i)return;this.onBeforeComposeObservable.notifyObservers(this);const r=e.getAlphaMode();for(let n=0;n<t;++n){const a=this._mergeDrawWrapper[n];e.enableEffect(a),e.setState(!1),e.bindBuffers(this._vertexBuffers,this._indexBuffer,a.effect),e.setAlphaMode(this._effectLayerOptions.alphaBlendingMode),this._internalRender(a.effect,n)}e.setAlphaMode(r),this.onAfterComposeObservable.notifyObservers(this);const s=this._mainTexture.getSize();this._setMainTextureSize(),(s.width!==this._mainTextureDesiredSize.width||s.height!==this._mainTextureDesiredSize.height)&&this._mainTextureDesiredSize.width!==0&&this._mainTextureDesiredSize.height!==0&&(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses())}hasMesh(e){return this.renderingGroupId===-1||e.renderingGroupId===this.renderingGroupId}shouldRender(){return this.isEnabled&&this._shouldRender}_shouldRenderMesh(e){return!0}_canRenderMesh(e,t){return!t.needAlphaBlendingForMesh(e)}_shouldRenderEmissiveTextureForMesh(){return!0}_renderSubMesh(e,t=!1){var i,r;if(!this.shouldRender())return;const s=e.getMaterial(),n=e.getMesh(),a=e.getReplacementMesh(),l=e.getRenderingMesh(),c=e.getEffectiveMesh(),h=this._scene,u=h.getEngine();if(c._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!s||!this._canRenderMesh(l,s))return;let d=(i=l.overrideMaterialSideOrientation)!==null&&i!==void 0?i:s.sideOrientation;c._getWorldMatrixDeterminant()<0&&(d=d===me.ClockWiseSideOrientation?me.CounterClockWiseSideOrientation:me.ClockWiseSideOrientation);const _=d===me.ClockWiseSideOrientation;u.setState(s.backFaceCulling,s.zOffset,void 0,_,s.cullBackFaces,void 0,s.zOffsetUnits);const p=l._getInstancesRenderList(e._id,!!a);if(p.mustReturn||!this._shouldRenderMesh(l))return;const m=p.hardwareInstancedRendering[e._id]||l.hasThinInstances;if(this._setEmissiveTextureAndColor(l,e,s),this.onBeforeRenderMeshToEffect.notifyObservers(n),this._useMeshMaterial(l))l.render(e,t,a||void 0);else if(this._isReady(e,m,this._emissiveTextureAndColor.texture)){const T=(r=c._internalAbstractMeshDataInfo._materialForRenderPass)===null||r===void 0?void 0:r[u.currentRenderPassId];let b=e._getDrawWrapper();if(!b&&T&&(b=T._getDrawWrapper()),!b)return;const y=b.effect;if(u.enableEffect(b),!m){const S=h.forcePointsCloud?me.PointFillMode:h.forceWireframe?me.WireFrameFillMode:s.fillMode;l._bind(e,y,S)}if(T?T.bindForSubMesh(c.getWorldMatrix(),c,e):(y.setMatrix("viewProjection",h.getTransformMatrix()),y.setMatrix("world",c.getWorldMatrix()),y.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a)),!T){const S=s.needAlphaTesting(),C=s.getAlphaTestTexture(),I=C&&C.hasAlpha&&(s.useAlphaFromDiffuseTexture||s._useAlphaFromAlbedoTexture);if(C&&(S||I)){y.setTexture("diffuseSampler",C);const D=C.getTextureMatrix();D&&y.setMatrix("diffuseMatrix",D)}const P=s.opacityTexture;if(P){y.setTexture("opacitySampler",P),y.setFloat("opacityIntensity",P.level);const D=P.getTextureMatrix();D&&y.setMatrix("opacityMatrix",D)}if(this._emissiveTextureAndColor.texture&&(y.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),y.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),l.useBones&&l.computeBonesUsingShaders&&l.skeleton){const D=l.skeleton;if(D.isUsingTextureForMatrices){const w=D.getTransformMatrixTexture(l);if(!w)return;y.setTexture("boneSampler",w),y.setFloat("boneTextureWidth",4*(D.bones.length+1))}else y.setMatrices("mBones",D.getTransformMatrices(l))}Ce.BindMorphTargetParameters(l,y),l.morphTargetManager&&l.morphTargetManager.isUsingTextureForTargets&&l.morphTargetManager._bind(y),t&&u.setAlphaMode(s.alphaMode),Ra(y,s,h)}l._processRendering(c,e,y,s.fillMode,p,m,(S,C)=>y.setMatrix("world",C))}else this._mainTexture.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(n)}_useMeshMaterial(e){return!1}_rebuild(){const e=this._vertexBuffers[O.PositionKind];e&&e._rebuild(),this._generateIndexBuffer()}_disposeTextureAndPostProcesses(){this._mainTexture.dispose();for(let e=0;e<this._postProcesses.length;e++)this._postProcesses[e]&&this._postProcesses[e].dispose();this._postProcesses=[];for(let e=0;e<this._textures.length;e++)this._textures[e]&&this._textures[e].dispose();this._textures=[]}dispose(){const e=this._vertexBuffers[O.PositionKind];e&&(e.dispose(),this._vertexBuffers[O.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(const i of this._mergeDrawWrapper)i.dispose();this._mergeDrawWrapper=[],this._disposeTextureAndPostProcesses();const t=this._scene.effectLayers.indexOf(this,0);t>-1&&this._scene.effectLayers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()}getClassName(){return"EffectLayer"}static Parse(e,t,i){return J.Instantiate(e.customType).Parse(e,t,i)}}pa._SceneComponentInitialization=o=>{throw pt("EffectLayerSceneComponent")};M([F()],pa.prototype,"name",void 0);M([Jp()],pa.prototype,"neutralColor",void 0);M([F()],pa.prototype,"isEnabled",void 0);M([Mb()],pa.prototype,"camera",null);M([F()],pa.prototype,"renderingGroupId",null);M([F()],pa.prototype,"disableBoundingBoxesFromEffectLayer",void 0);Er.AddParser(Re.NAME_EFFECTLAYER,(o,e,t,i)=>{if(o.effectLayers){t.effectLayers||(t.effectLayers=new Array);for(let r=0;r<o.effectLayers.length;r++){const s=pa.Parse(o.effectLayers[r],e,i);t.effectLayers.push(s)}}});Er.prototype.removeEffectLayer=function(o){const e=this.effectLayers.indexOf(o);return e!==-1&&this.effectLayers.splice(e,1),e};Er.prototype.addEffectLayer=function(o){this.effectLayers.push(o)};class IO{constructor(e){this.name=Re.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||qe.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine(),this.scene.effectLayers=new Array)}register(){this.scene._isReadyForMeshStage.registerStep(Re.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(Re.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(Re.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(Re.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(Re.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(Re.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)}rebuild(){const e=this.scene.effectLayers;for(const t of e)t._rebuild()}serialize(e){e.effectLayers=[];const t=this.scene.effectLayers;for(const i of t)i.serialize&&e.effectLayers.push(i.serialize())}addFromContainer(e){e.effectLayers&&e.effectLayers.forEach(t=>{this.scene.addEffectLayer(t)})}removeFromContainer(e,t){e.effectLayers&&e.effectLayers.forEach(i=>{this.scene.removeEffectLayer(i),t&&i.dispose()})}dispose(){const e=this.scene.effectLayers;for(;e.length;)e[0].dispose()}_isReadyForMesh(e,t){const i=this._engine.currentRenderPassId,r=this.scene.effectLayers;for(const s of r){if(!s.hasMesh(e))continue;const n=s._mainTexture;this._engine.currentRenderPassId=n.renderPassId;for(const a of e.subMeshes)if(!s.isReady(a,t))return this._engine.currentRenderPassId=i,!1}return this._engine.currentRenderPassId=i,!0}_renderMainTexture(e){this._renderEffects=!1,this._needStencil=!1;let t=!1;const i=this.scene.effectLayers;if(i&&i.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(const r of i)if(r.shouldRender()&&(!r.camera||r.camera.cameraRigMode===Ve.RIG_MODE_NONE&&e===r.camera||r.camera.cameraRigMode!==Ve.RIG_MODE_NONE&&r.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||r.needStencil();const s=r._mainTexture;s._shouldRender()&&(this.scene.incrementRenderId(),s.render(!1,!1),t=!0)}this.scene.incrementRenderId()}return t}_setStencil(){this._needStencil&&this._engine.setStencilBuffer(!0)}_setStencilBack(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)}_draw(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);const t=this.scene.effectLayers;for(let i=0;i<t.length;i++){const r=t[i];r.renderingGroupId===e&&r.shouldRender()&&r.render()}this._engine.setDepthBuffer(!0)}}_drawCamera(){this._renderEffects&&this._draw(-1)}_drawRenderingGroup(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)}}pa._SceneComponentInitialization=o=>{let e=o._getComponent(Re.NAME_EFFECTLAYER);e||(e=new IO(o),o._addComponent(e))};const PO="glowMapMergePixelShader",MO=`varying vec2 vUV;
uniform sampler2D textureSampler;
#ifdef EMISSIVE
uniform sampler2D textureSampler2;
#endif
uniform float offset;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);
#ifdef EMISSIVE
baseColor+=texture2D(textureSampler2,vUV);
baseColor*=offset;
#else
baseColor.a=abs(offset-baseColor.a);
#ifdef STROKE
float alpha=smoothstep(.0,.1,baseColor.a);
baseColor.a=alpha;
baseColor.rgb=baseColor.rgb*alpha;
#endif
#endif
#if LDR
baseColor=clamp(baseColor,0.,1.0);
#endif
gl_FragColor=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;te.ShadersStore[PO]=MO;const OO="glowMapMergeVertexShader",DO=`attribute vec2 position;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=position*madd+madd;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;te.ShadersStore[OO]=DO;Er.prototype.getGlowLayerByName=function(o){var e;for(let t=0;t<((e=this.effectLayers)===null||e===void 0?void 0:e.length);t++)if(this.effectLayers[t].name===o&&this.effectLayers[t].getEffectName()===ua.EffectName)return this.effectLayers[t];return null};class ua extends pa{set blurKernelSize(e){if(e===this._options.blurKernelSize)return;this._options.blurKernelSize=e;const t=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1.kernel=t,this._verticalBlurPostprocess1.kernel=t,this._horizontalBlurPostprocess2.kernel=t,this._verticalBlurPostprocess2.kernel=t}get blurKernelSize(){return this._options.blurKernelSize}set intensity(e){this._intensity=e}get intensity(){return this._intensity}constructor(e,t,i){super(e,t),this._intensity=1,this._includedOnlyMeshes=[],this._excludedMeshes=[],this._meshesUsingTheirOwnMaterials=[],this.neutralColor=new Ye(0,0,0,1),this._options={mainTextureRatio:ua.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,mainTextureType:0,...i},this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType})}getEffectName(){return ua.EffectName}_createMergeEffect(){let e=`#define EMISSIVE 
`;return this._options.ldrMerge&&(e+=`#define LDR 
`),this._engine.createEffect("glowMapMerge",[O.PositionKind],["offset"],["textureSampler","textureSampler2"],e)}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width,t=this._mainTextureDesiredSize.height;e=this._engine.needPOTTextures?q.GetExponentOfTwo(e,this._maxSize):e,t=this._engine.needPOTTextures?q.GetExponentOfTwo(t,this._maxSize):t;let i=0;this._engine.getCaps().textureHalfFloatRender?i=2:i=0,this._blurTexture1=new Zi("GlowLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture1.wrapU=Y.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=Y.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode(Y.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;const r=Math.floor(e/2),s=Math.floor(t/2);this._blurTexture2=new Zi("GlowLayerBlurRTT2",{width:r,height:s},this._scene,!1,!0,i),this._blurTexture2.wrapU=Y.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=Y.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode(Y.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2];const n=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1=new Yr("GlowLayerHBP1",new Ie(1,0),n,{width:e,height:t},null,Y.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess1.width=e,this._horizontalBlurPostprocess1.height=t,this._horizontalBlurPostprocess1.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess1.onApplyObservable.add(a=>{a.setTexture("textureSampler",this._mainTexture)}),this._verticalBlurPostprocess1=new Yr("GlowLayerVBP1",new Ie(0,1),n,{width:e,height:t},null,Y.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2=new Yr("GlowLayerHBP2",new Ie(1,0),n,{width:r,height:s},null,Y.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2.width=r,this._horizontalBlurPostprocess2.height=s,this._horizontalBlurPostprocess2.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess2.onApplyObservable.add(a=>{a.setTexture("textureSampler",this._blurTexture1)}),this._verticalBlurPostprocess2=new Yr("GlowLayerVBP2",new Ie(0,1),n,{width:r,height:s},null,Y.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add(()=>{const a=this._blurTexture1.renderTarget;if(a){this._scene.postProcessManager.directRender(this._postProcesses1,a,!0);const l=this._blurTexture2.renderTarget;l&&this._scene.postProcessManager.directRender(this._postProcesses2,l,!0),this._engine.unBindFramebuffer(l??a,!0)}}),this._postProcesses.map(a=>{a.autoClear=!1})}_getEffectiveBlurKernelSize(){return this._options.blurKernelSize/2}isReady(e,t){const i=e.getMaterial(),r=e.getRenderingMesh();if(!i||!r)return!1;const s=i.emissiveTexture;return super._isReady(e,t,s)}needStencil(){return!1}_canRenderMesh(e,t){return!0}_internalRender(e){e.setTexture("textureSampler",this._blurTexture1),e.setTexture("textureSampler2",this._blurTexture2),e.setFloat("offset",this._intensity);const t=this._engine,i=t.getStencilBuffer();t.setStencilBuffer(!1),t.drawElementsType(me.TriangleFillMode,0,6),t.setStencilBuffer(i)}_setEmissiveTextureAndColor(e,t,i){var r;let s=1;if(this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(e,t,i):i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.texture&&(s=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector)this.customEmissiveColorSelector(e,t,i,this._emissiveTextureAndColor.color);else if(i.emissiveColor){const n=(r=i.emissiveIntensity)!==null&&r!==void 0?r:1;s*=n,this._emissiveTextureAndColor.color.set(i.emissiveColor.r*s,i.emissiveColor.g*s,i.emissiveColor.b*s,i.alpha)}else this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}_shouldRenderMesh(e){return this.hasMesh(e)}_addCustomEffectDefines(e){e.push("#define GLOW")}addExcludedMesh(e){this._excludedMeshes.indexOf(e.uniqueId)===-1&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);t!==-1&&this._excludedMeshes.splice(t,1)}addIncludedOnlyMesh(e){this._includedOnlyMeshes.indexOf(e.uniqueId)===-1&&this._includedOnlyMeshes.push(e.uniqueId)}removeIncludedOnlyMesh(e){const t=this._includedOnlyMeshes.indexOf(e.uniqueId);t!==-1&&this._includedOnlyMeshes.splice(t,1)}hasMesh(e){return super.hasMesh(e)?this._includedOnlyMeshes.length?this._includedOnlyMeshes.indexOf(e.uniqueId)!==-1:this._excludedMeshes.length?this._excludedMeshes.indexOf(e.uniqueId)===-1:!0:!1}_useMeshMaterial(e){return this._meshesUsingTheirOwnMaterials.length==0?!1:this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId)>-1}referenceMeshToUseItsOwnMaterial(e){e.resetDrawCache(this._mainTexture.renderPassId),this._meshesUsingTheirOwnMaterials.push(e.uniqueId),e.onDisposeObservable.add(()=>{this._disposeMesh(e)})}unReferenceMeshFromUsingItsOwnMaterial(e){let t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);for(;t>=0;)this._meshesUsingTheirOwnMaterials.splice(t,1),t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);e.resetDrawCache(this._mainTexture.renderPassId)}_disposeMesh(e){this.removeIncludedOnlyMesh(e),this.removeExcludedMesh(e)}getClassName(){return"GlowLayer"}serialize(){const e=ke.Serialize(this);e.customType="BABYLON.GlowLayer";let t;if(e.includedMeshes=[],this._includedOnlyMeshes.length)for(t=0;t<this._includedOnlyMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._includedOnlyMeshes[t]);i&&e.includedMeshes.push(i.id)}if(e.excludedMeshes=[],this._excludedMeshes.length)for(t=0;t<this._excludedMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._excludedMeshes[t]);i&&e.excludedMeshes.push(i.id)}return e}static Parse(e,t,i){const r=ke.Parse(()=>new ua(e.name,t,e.options),e,t,i);let s;for(s=0;s<e.excludedMeshes.length;s++){const n=t.getMeshById(e.excludedMeshes[s]);n&&r.addExcludedMesh(n)}for(s=0;s<e.includedMeshes.length;s++){const n=t.getMeshById(e.includedMeshes[s]);n&&r.addIncludedOnlyMesh(n)}return r}}ua.EffectName="GlowLayer";ua.DefaultBlurKernelSize=32;ua.DefaultTextureRatio=.5;M([F()],ua.prototype,"blurKernelSize",null);M([F()],ua.prototype,"intensity",null);M([F("options")],ua.prototype,"_options",void 0);ye("BABYLON.GlowLayer",ua);const NO="glowBlurPostProcessPixelShader",wO=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 screenSize;
uniform vec2 direction;
uniform float blurWidth;
float getLuminance(vec3 color)
{
return dot(color,vec3(0.2126,0.7152,0.0722));
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
float weights[7];
weights[0]=0.05;
weights[1]=0.1;
weights[2]=0.2;
weights[3]=0.3;
weights[4]=0.2;
weights[5]=0.1;
weights[6]=0.05;
vec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);
vec2 texelStep=texelSize*direction*blurWidth;
vec2 start=vUV-3.0*texelStep;
vec4 baseColor=vec4(0.,0.,0.,0.);
vec2 texelOffset=vec2(0.,0.);
for (int i=0; i<7; i++)
{
vec4 texel=texture2D(textureSampler,start+texelOffset);
baseColor.a+=texel.a*weights[i];
float luminance=getLuminance(baseColor.rgb);
float luminanceTexel=getLuminance(texel.rgb);
float choice=step(luminanceTexel,luminance);
baseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;
texelOffset+=texelStep;
}
gl_FragColor=baseColor;
}`;te.ShadersStore[NO]=wO;Er.prototype.getHighlightLayerByName=function(o){var e;for(let t=0;t<((e=this.effectLayers)===null||e===void 0?void 0:e.length);t++)if(this.effectLayers[t].name===o&&this.effectLayers[t].getEffectName()===on.EffectName)return this.effectLayers[t];return null};class lx extends et{constructor(e,t,i,r,s,n=Y.BILINEAR_SAMPLINGMODE,a,l){super(e,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,r,s,n,a,l),this.direction=t,this.kernel=i,this.onApplyObservable.add(c=>{c.setFloat2("screenSize",this.width,this.height),c.setVector2("direction",this.direction),c.setFloat("blurWidth",this.kernel)})}}class on extends pa{set blurHorizontalSize(e){this._horizontalBlurPostprocess.kernel=e,this._options.blurHorizontalSize=e}set blurVerticalSize(e){this._verticalBlurPostprocess.kernel=e,this._options.blurVerticalSize=e}get blurHorizontalSize(){return this._horizontalBlurPostprocess.kernel}get blurVerticalSize(){return this._verticalBlurPostprocess.kernel}constructor(e,t,i){super(e,t),this.name=e,this.innerGlow=!0,this.outerGlow=!0,this.onBeforeBlurObservable=new Q,this.onAfterBlurObservable=new Q,this._instanceGlowingMeshStencilReference=on.GlowingMeshStencilReference++,this._meshes={},this._excludedMeshes={},this.neutralColor=on.NeutralColor,this._engine.isStencilEnable||X.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),this._options={mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,...i},this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType}),this._shouldRender=!1}getEffectName(){return on.EffectName}_numInternalDraws(){return 2}_createMergeEffect(){return this._engine.createEffect("glowMapMerge",[O.PositionKind],["offset"],["textureSampler"],this._options.isStroke?`#define STROKE 
`:void 0)}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,t=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;e=this._engine.needPOTTextures?q.GetExponentOfTwo(e,this._maxSize):e,t=this._engine.needPOTTextures?q.GetExponentOfTwo(t,this._maxSize):t;let i=0;this._engine.getCaps().textureHalfFloatRender?i=2:i=0,this._blurTexture=new Zi("HighlightLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture.wrapU=Y.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=Y.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(Y.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],this._options.alphaBlendingMode===2?(this._downSamplePostprocess=new So("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,Y.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.externalTextureSamplerBinding=!0,this._downSamplePostprocess.onApplyObservable.add(r=>{r.setTexture("textureSampler",this._mainTexture)}),this._horizontalBlurPostprocess=new lx("HighlightLayerHBP",new Ie(1,0),this._options.blurHorizontalSize,1,null,Y.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add(r=>{r.setFloat2("screenSize",e,t)}),this._verticalBlurPostprocess=new lx("HighlightLayerVBP",new Ie(0,1),this._options.blurVerticalSize,1,null,Y.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add(r=>{r.setFloat2("screenSize",e,t)}),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new Yr("HighlightLayerHBP",new Ie(1,0),this._options.blurHorizontalSize/2,{width:e,height:t},null,Y.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess.width=e,this._horizontalBlurPostprocess.height=t,this._horizontalBlurPostprocess.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess.onApplyObservable.add(r=>{r.setTexture("textureSampler",this._mainTexture)}),this._verticalBlurPostprocess=new Yr("HighlightLayerVBP",new Ie(0,1),this._options.blurVerticalSize/2,{width:e,height:t},null,Y.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]),this._mainTexture.onAfterUnbindObservable.add(()=>{this.onBeforeBlurObservable.notifyObservers(this);const r=this._blurTexture.renderTarget;r&&(this._scene.postProcessManager.directRender(this._postProcesses,r,!0),this._engine.unBindFramebuffer(r,!0)),this.onAfterBlurObservable.notifyObservers(this)}),this._postProcesses.map(r=>{r.autoClear=!1})}needStencil(){return!0}isReady(e,t){const i=e.getMaterial(),r=e.getRenderingMesh();if(!i||!r||!this._meshes)return!1;let s=null;const n=this._meshes[r.uniqueId];return n&&n.glowEmissiveOnly&&i&&(s=i.emissiveTexture),super._isReady(e,t,s)}_internalRender(e,t){e.setTexture("textureSampler",this._blurTexture);const i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&t===0&&(e.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(me.TriangleFillMode,0,6)),this.innerGlow&&t===1&&(e.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(me.TriangleFillMode,0,6)),i.restoreStencilState()}shouldRender(){return super.shouldRender()?!!this._meshes:!1}_shouldRenderMesh(e){return!(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]||!super.hasMesh(e))}_canRenderMesh(e,t){return!0}_addCustomEffectDefines(e){e.push("#define HIGHLIGHT")}_setEmissiveTextureAndColor(e,t,i){const r=this._meshes[e.uniqueId];r?this._emissiveTextureAndColor.color.set(r.color.r,r.color.g,r.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),r&&r.glowEmissiveOnly&&i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null}addExcludedMesh(e){if(!this._excludedMeshes)return;this._excludedMeshes[e.uniqueId]||(this._excludedMeshes[e.uniqueId]={mesh:e,beforeBind:e.onBeforeBindObservable.add(i=>{i.getEngine().setStencilBuffer(!1)}),afterRender:e.onAfterRenderObservable.add(i=>{i.getEngine().setStencilBuffer(!0)})})}removeExcludedMesh(e){if(!this._excludedMeshes)return;const t=this._excludedMeshes[e.uniqueId];t&&(t.beforeBind&&e.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&e.onAfterRenderObservable.remove(t.afterRender)),this._excludedMeshes[e.uniqueId]=null}hasMesh(e){return!this._meshes||!super.hasMesh(e)?!1:this._meshes[e.uniqueId]!==void 0&&this._meshes[e.uniqueId]!==null}addMesh(e,t,i=!1){if(!this._meshes)return;const r=this._meshes[e.uniqueId];r?r.color=t:(this._meshes[e.uniqueId]={mesh:e,color:t,observerHighlight:e.onBeforeBindObservable.add(s=>{this.isEnabled&&(this._excludedMeshes&&this._excludedMeshes[s.uniqueId]?this._defaultStencilReference(s):s.getScene().getEngine().setStencilFunctionReference(this._instanceGlowingMeshStencilReference))}),observerDefault:e.onAfterRenderObservable.add(s=>{this.isEnabled&&this._defaultStencilReference(s)}),glowEmissiveOnly:i},e.onDisposeObservable.add(()=>{this._disposeMesh(e)})),this._shouldRender=!0}removeMesh(e){if(!this._meshes)return;const t=this._meshes[e.uniqueId];t&&(t.observerHighlight&&e.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&e.onAfterRenderObservable.remove(t.observerDefault),delete this._meshes[e.uniqueId]),this._shouldRender=!1;for(const i in this._meshes)if(this._meshes[i]){this._shouldRender=!0;break}}removeAllMeshes(){if(this._meshes){for(const e in this._meshes)if(Object.prototype.hasOwnProperty.call(this._meshes,e)){const t=this._meshes[e];t&&this.removeMesh(t.mesh)}}}_defaultStencilReference(e){e.getScene().getEngine().setStencilFunctionReference(on.NormalMeshStencilReference)}_disposeMesh(e){this.removeMesh(e),this.removeExcludedMesh(e)}dispose(){if(this._meshes){for(const e in this._meshes){const t=this._meshes[e];t&&t.mesh&&(t.observerHighlight&&t.mesh.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&t.mesh.onAfterRenderObservable.remove(t.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(const e in this._excludedMeshes){const t=this._excludedMeshes[e];t&&(t.beforeBind&&t.mesh.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&t.mesh.onAfterRenderObservable.remove(t.afterRender))}this._excludedMeshes=null}super.dispose()}getClassName(){return"HighlightLayer"}serialize(){const e=ke.Serialize(this);if(e.customType="BABYLON.HighlightLayer",e.meshes=[],this._meshes)for(const t in this._meshes){const i=this._meshes[t];i&&e.meshes.push({glowEmissiveOnly:i.glowEmissiveOnly,color:i.color.asArray(),meshId:i.mesh.id})}if(e.excludedMeshes=[],this._excludedMeshes)for(const t in this._excludedMeshes){const i=this._excludedMeshes[t];i&&e.excludedMeshes.push(i.mesh.id)}return e}static Parse(e,t,i){const r=ke.Parse(()=>new on(e.name,t,e.options),e,t,i);let s;for(s=0;s<e.excludedMeshes.length;s++){const n=t.getMeshById(e.excludedMeshes[s]);n&&r.addExcludedMesh(n)}for(s=0;s<e.meshes.length;s++){const n=e.meshes[s],a=t.getMeshById(n.meshId);a&&r.addMesh(a,ge.FromArray(n.color),n.glowEmissiveOnly)}return r}}on.EffectName="HighlightLayer";on.NeutralColor=new Ye(0,0,0,0);on.GlowingMeshStencilReference=2;on.NormalMeshStencilReference=1;M([F()],on.prototype,"innerGlow",void 0);M([F()],on.prototype,"outerGlow",void 0);M([F()],on.prototype,"blurHorizontalSize",null);M([F()],on.prototype,"blurVerticalSize",null);M([F("options")],on.prototype,"_options",void 0);ye("BABYLON.HighlightLayer",on);const FO="layerPixelShader",LO=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec4 color;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);
#ifdef LINEAR
baseColor.rgb=toGammaSpace(baseColor.rgb);
#endif
#ifdef ALPHATEST
if (baseColor.a<0.4)
discard;
#endif
gl_FragColor=baseColor*color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;te.ShadersStore[FO]=LO;const BO="layerVertexShader",UO=`attribute vec2 position;
uniform vec2 scale;
uniform vec2 offset;
uniform mat4 textureMatrix;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec2 shiftedPosition=position*scale+offset;
vUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));
gl_Position=vec4(shiftedPosition,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;te.ShadersStore[BO]=UO;class Lm{static AddFlare(e,t,i,r,s){return new Lm(e,t,i,r,s)}constructor(e,t,i,r,s){this.size=e,this.position=t,this.alphaMode=6,this.color=i||new ge(1,1,1),this.texture=r?new Y(r,s.getScene(),!0):null,this._system=s;const n=s.scene.getEngine();this._drawWrapper=new vs(n),this._drawWrapper.effect=n.createEffect("lensFlare",[O.PositionKind],["color","viewportMatrix"],["textureSampler"],""),s.lensFlares.push(this)}dispose(){this.texture&&this.texture.dispose();const e=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(e,1)}}const VO="lensFlarePixelShader",kO=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec4 color;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);
gl_FragColor=baseColor*color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;te.ShadersStore[VO]=kO;const GO="lensFlareVertexShader",zO=`attribute vec2 position;
uniform mat4 viewportMatrix;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=position*madd+madd;
gl_Position=viewportMatrix*vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;te.ShadersStore[GO]=zO;class _h{get scene(){return this._scene}constructor(e,t,i){this.name=e,this.lensFlares=new Array,this.borderLimit=300,this.viewportBorder=0,this.layerMask=268435455,this._vertexBuffers={},this._isEnabled=!0,this._scene=i||qe.LastCreatedScene,_h._SceneComponentInitialization(this._scene),this._emitter=t,this.id=e,i.lensFlareSystems.push(this),this.meshesSelectionPredicate=n=>i.activeCamera&&n.material&&n.isVisible&&n.isEnabled()&&n.isBlocker&&(n.layerMask&i.activeCamera.layerMask)!=0;const r=i.getEngine(),s=[];s.push(1,1),s.push(-1,1),s.push(-1,-1),s.push(1,-1),this._vertexBuffers[O.PositionKind]=new O(r,s,O.PositionKind,!1,!1,2),this._createIndexBuffer()}_createIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled=e}getScene(){return this._scene}getEmitter(){return this._emitter}setEmitter(e){this._emitter=e}getEmitterPosition(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position}computeEffectivePosition(e){let t=this.getEmitterPosition();t=x.Project(t,H.Identity(),this._scene.getTransformMatrix(),e),this._positionX=t.x,this._positionY=t.y,t=x.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),this.viewportBorder>0&&(e.x-=this.viewportBorder,e.y-=this.viewportBorder,e.width+=this.viewportBorder*2,e.height+=this.viewportBorder*2,t.x+=this.viewportBorder,t.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder);const i=this._scene.useRightHandedSystem;return t.z>0&&!i||t.z<0&&i?(this._positionX>e.x&&this._positionX<e.x+e.width&&this._positionY>e.y&&this._positionY<e.y+e.height,!0):!1}_isVisible(){if(!this._isEnabled||!this._scene.activeCamera)return!1;const t=this.getEmitterPosition().subtract(this._scene.activeCamera.globalPosition),i=t.length();t.normalize();const r=new Pt(this._scene.activeCamera.globalPosition,t),s=this._scene.pickWithRay(r,this.meshesSelectionPredicate,!0);return!s||!s.hit||s.distance>i}render(){if(!this._scene.activeCamera)return!1;const e=this._scene.getEngine(),i=this._scene.activeCamera.viewport.toGlobal(e.getRenderWidth(!0),e.getRenderHeight(!0));if(!this.computeEffectivePosition(i)||!this._isVisible())return!1;let r,s;this._positionX<this.borderLimit+i.x?r=this.borderLimit+i.x-this._positionX:this._positionX>i.x+i.width-this.borderLimit?r=this._positionX-i.x-i.width+this.borderLimit:r=0,this._positionY<this.borderLimit+i.y?s=this.borderLimit+i.y-this._positionY:this._positionY>i.y+i.height-this.borderLimit?s=this._positionY-i.y-i.height+this.borderLimit:s=0;let n=r>s?r:s;n-=this.viewportBorder,n>this.borderLimit&&(n=this.borderLimit);let a=1-Ee.Clamp(n/this.borderLimit,0,1);if(a<0)return!1;a>1&&(a=1),this.viewportBorder>0&&(i.x+=this.viewportBorder,i.y+=this.viewportBorder,i.width-=this.viewportBorder*2,i.height-=this.viewportBorder*2,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);const l=i.x+i.width/2,c=i.y+i.height/2,h=l-this._positionX,u=c-this._positionY;e.setState(!1),e.setDepthBuffer(!1);for(let d=0;d<this.lensFlares.length;d++){const f=this.lensFlares[d];if(!f._drawWrapper.effect.isReady()||f.texture&&!f.texture.isReady())continue;e.enableEffect(f._drawWrapper),e.bindBuffers(this._vertexBuffers,this._indexBuffer,f._drawWrapper.effect),e.setAlphaMode(f.alphaMode);const _=l-h*f.position,p=c-u*f.position,m=f.size,T=f.size*e.getAspectRatio(this._scene.activeCamera,!0),b=2*(_/(i.width+i.x*2))-1,y=1-2*(p/(i.height+i.y*2)),S=H.FromValues(m/2,0,0,0,0,T/2,0,0,0,0,1,0,b,y,0,1);f._drawWrapper.effect.setMatrix("viewportMatrix",S),f._drawWrapper.effect.setTexture("textureSampler",f.texture),f._drawWrapper.effect.setFloat4("color",f.color.r*a,f.color.g*a,f.color.b*a,1),e.drawElementsType(me.TriangleFillMode,0,6)}return e.setDepthBuffer(!0),e.setAlphaMode(0),!0}rebuild(){var e;this._createIndexBuffer();for(const t in this._vertexBuffers)(e=this._vertexBuffers[t])===null||e===void 0||e._rebuild()}dispose(){const e=this._vertexBuffers[O.PositionKind];for(e&&(e.dispose(),this._vertexBuffers[O.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();const t=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(t,1)}static Parse(e,t,i){const r=t.getLastEntryById(e.emitterId),s=e.name||"lensFlareSystem#"+e.emitterId,n=new _h(s,r,t);n.id=e.id||s,n.borderLimit=e.borderLimit;for(let a=0;a<e.flares.length;a++){const l=e.flares[a];Lm.AddFlare(l.size,l.position,ge.FromArray(l.color),l.textureName?i+l.textureName:"",n)}return n}serialize(){const e={};e.id=this.id,e.name=this.name,e.emitterId=this.getEmitter().id,e.borderLimit=this.borderLimit,e.flares=[];for(let t=0;t<this.lensFlares.length;t++){const i=this.lensFlares[t];e.flares.push({size:i.size,position:i.position,color:i.color.asArray(),textureName:J.GetFilename(i.texture?i.texture.name:"")})}return e}}_h._SceneComponentInitialization=o=>{throw pt("LensFlareSystemSceneComponent")};Er.AddParser(Re.NAME_LENSFLARESYSTEM,(o,e,t,i)=>{if(o.lensFlareSystems!==void 0&&o.lensFlareSystems!==null){t.lensFlareSystems||(t.lensFlareSystems=new Array);for(let r=0,s=o.lensFlareSystems.length;r<s;r++){const n=o.lensFlareSystems[r],a=_h.Parse(n,e,i);t.lensFlareSystems.push(a)}}});Er.prototype.getLensFlareSystemByName=function(o){for(let e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].name===o)return this.lensFlareSystems[e];return null};Er.prototype.getLensFlareSystemById=function(o){for(let e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].id===o)return this.lensFlareSystems[e];return null};Er.prototype.getLensFlareSystemByID=function(o){return this.getLensFlareSystemById(o)};Er.prototype.removeLensFlareSystem=function(o){const e=this.lensFlareSystems.indexOf(o);return e!==-1&&this.lensFlareSystems.splice(e,1),e};Er.prototype.addLensFlareSystem=function(o){this.lensFlareSystems.push(o)};class HO{constructor(e){this.name=Re.NAME_LENSFLARESYSTEM,this.scene=e,e.lensFlareSystems=new Array}register(){this.scene._afterCameraDrawStage.registerStep(Re.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM,this,this._draw)}rebuild(){for(let e=0;e<this.scene.lensFlareSystems.length;e++)this.scene.lensFlareSystems[e].rebuild()}addFromContainer(e){e.lensFlareSystems&&e.lensFlareSystems.forEach(t=>{this.scene.addLensFlareSystem(t)})}removeFromContainer(e,t){e.lensFlareSystems&&e.lensFlareSystems.forEach(i=>{this.scene.removeLensFlareSystem(i),t&&i.dispose()})}serialize(e){e.lensFlareSystems=[];const t=this.scene.lensFlareSystems;for(const i of t)e.lensFlareSystems.push(i.serialize())}dispose(){const e=this.scene.lensFlareSystems;for(;e.length;)e[0].dispose()}_draw(e){if(this.scene.lensFlaresEnabled){const t=this.scene.lensFlareSystems;J.StartPerformanceCounter("Lens flares",t.length>0);for(const i of t)e.layerMask&i.layerMask&&i.render();J.EndPerformanceCounter("Lens flares",t.length>0)}}}_h._SceneComponentInitialization=o=>{let e=o._getComponent(Re.NAME_LENSFLARESYSTEM);e||(e=new HO(o),o._addComponent(e))};const WO="bayerDitherFunctions",XO=`float bayerDither2(vec2 _P) {
return mod(2.0*_P.y+_P.x+1.0,4.0);
}
float bayerDither4(vec2 _P) {
vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5*mod(_P,4.0)); 
return 4.0*bayerDither2(P1)+bayerDither2(P2);
}
float bayerDither8(vec2 _P) {
vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5 *mod(_P,4.0)); 
vec2 P4=floor(0.25*mod(_P,8.0)); 
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);
}
`;te.IncludesShadersStore[WO]=XO;const $O="shadowMapFragmentExtraDeclaration",YO=`#if SM_FLOAT==0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#include<bayerDitherFunctions>
uniform float softTransparentShadowSM;
#endif
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
uniform vec3 lightDataSM;
varying vec3 vPositionWSM;
#endif
uniform vec3 biasAndScaleSM;
uniform vec2 depthValuesSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;te.IncludesShadersStore[$O]=YO;const jO="shadowMapFragment",KO=`float depthSM=vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
#if SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
depthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
depthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_FragDepth=clamp(1.0-depthSM,0.0,1.0);
#else
gl_FragDepth=clamp(depthSM,0.0,1.0); 
#endif
#elif SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#if SM_ESM==1
depthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT==1
gl_FragColor=vec4(depthSM,1.0,1.0,1.0);
#else
gl_FragColor=pack(depthSM);
#endif
return;`;te.IncludesShadersStore[jO]=KO;const qO="shadowMapPixelShader",QO=`#include<shadowMapFragmentExtraDeclaration>
#ifdef ALPHATEXTURE
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEXTURE
float alphaFromAlphaTexture=texture2D(diffuseSampler,vUV).a;
#ifdef ALPHATESTVALUE
if (alphaFromAlphaTexture<ALPHATESTVALUE)
discard;
#endif
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#ifdef ALPHATEXTURE
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alphaFromAlphaTexture) discard;
#else
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM) discard;
#endif
#endif
#include<shadowMapFragment>
}`;te.ShadersStore[qO]=QO;const ZO="sceneVertexDeclaration",JO=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform mat4 view;
uniform mat4 projection;
uniform vec4 vEyePosition;
`;te.IncludesShadersStore[ZO]=JO;const eD="meshVertexDeclaration",tD=`uniform mat4 world;
uniform float visibility;
`;te.IncludesShadersStore[eD]=tD;const iD="shadowMapVertexDeclaration",rD=`#include<sceneVertexDeclaration>
#include<meshVertexDeclaration>
`;te.IncludesShadersStore[iD]=rD;const sD="shadowMapUboDeclaration",nD=`layout(std140,column_major) uniform;
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;te.IncludesShadersStore[sD]=nD;const aD="shadowMapVertexExtraDeclaration",oD=`#if SM_NORMALBIAS==1
uniform vec3 lightDataSM;
#endif
uniform vec3 biasAndScaleSM;
uniform vec2 depthValuesSM;
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
varying vec3 vPositionWSM;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;te.IncludesShadersStore[aD]=oD;const lD="shadowMapVertexNormalBias",cD=`#if SM_NORMALBIAS==1
#if SM_DIRECTIONINLIGHTDATA==1
vec3 worldLightDirSM=normalize(-lightDataSM.xyz);
#else
vec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;
vec3 worldLightDirSM=normalize(directionToLightSM);
#endif
float ndlSM=dot(vNormalW,worldLightDirSM);
float sinNLSM=sqrt(1.0-ndlSM*ndlSM);
float normalBiasSM=biasAndScaleSM.y*sinNLSM;
worldPos.xyz-=vNormalW*normalBiasSM;
#endif
`;te.IncludesShadersStore[lD]=cD;const hD="shadowMapVertexMetric",uD=`#if SM_USEDISTANCE==1
vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE==1
#ifdef IS_NDC_HALF_ZRANGE
#define BIASFACTOR 0.5
#else
#define BIASFACTOR 1.0
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#else
gl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#endif
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
zSM=gl_Position.z;
gl_Position.z=0.0;
#elif SM_USEDISTANCE==0
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
vDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
`;te.IncludesShadersStore[hD]=uD;const dD="shadowMapVertexShader",fD=`attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef INSTANCES
attribute vec4 world0;
attribute vec4 world1;
attribute vec4 world2;
attribute vec4 world3;
#endif
#include<helperFunctions>
#include<__decl__shadowMapVertex>
#ifdef ALPHATEXTURE
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<shadowMapVertexExtraDeclaration>
#include<clipPlaneVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normWorldSM=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));
vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vec3 vNormalW=normalize(normWorldSM*normalUpdated);
#endif
#endif
#include<shadowMapVertexNormalBias>
gl_Position=viewProjection*worldPos;
#include<shadowMapVertexMetric>
#ifdef ALPHATEXTURE
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
}`;te.ShadersStore[dD]=fD;const _D="depthBoxBlurPixelShader",pD=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 screenSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec4 colorDepth=vec4(0.0);
for (int x=-OFFSET; x<=OFFSET; x++)
for (int y=-OFFSET; y<=OFFSET; y++)
colorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);
gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));
}`;te.ShadersStore[_D]=pD;const mD="shadowMapFragmentSoftTransparentShadow",gD=`#if SM_SOFTTRANSPARENTSHADOW==1
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alpha) discard;
#endif
`;te.IncludesShadersStore[mD]=gD;class lt{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return this._depthScale!==void 0?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===lt.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}else if(e===lt.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}else if(e===lt.FILTER_PCF||e===lt.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((e===lt.FILTER_PCF||e===lt.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get usePoissonSampling(){return this.filter===lt.FILTER_POISSONSAMPLING}set usePoissonSampling(e){const t=this._validateFilter(lt.FILTER_POISSONSAMPLING);!e&&this.filter!==lt.FILTER_POISSONSAMPLING||(this.filter=e?t:lt.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===lt.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){const t=this._validateFilter(lt.FILTER_EXPONENTIALSHADOWMAP);!e&&this.filter!==lt.FILTER_EXPONENTIALSHADOWMAP||(this.filter=e?t:lt.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===lt.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){const t=this._validateFilter(lt.FILTER_BLUREXPONENTIALSHADOWMAP);!e&&this.filter!==lt.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=e?t:lt.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===lt.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){const t=this._validateFilter(lt.FILTER_CLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==lt.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:lt.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===lt.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){const t=this._validateFilter(lt.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==lt.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:lt.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===lt.FILTER_PCF}set usePercentageCloserFiltering(e){const t=this._validateFilter(lt.FILTER_PCF);!e&&this.filter!==lt.FILTER_PCF||(this.filter=e?t:lt.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===lt.FILTER_PCSS}set useContactHardeningShadow(e){const t=this._validateFilter(lt.FILTER_PCSS);!e&&this.filter!==lt.FILTER_PCSS||(this.filter=e?t:lt.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return e>=1?this._darkness=1:e<=0?this._darkness=0:this._darkness=e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return lt.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),this._shadowMap.renderList.indexOf(e)===-1&&this._shadowMap.renderList.push(e),t)for(const i of e.getChildMeshes())this._shadowMap.renderList.indexOf(i)===-1&&this._shadowMap.renderList.push(i);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const i=this._shadowMap.renderList.indexOf(e);if(i!==-1&&this._shadowMap.renderList.splice(i,1),t)for(const r of e.getChildren())this.removeShadowCaster(r);return this}getLight(){return this._light}_getCamera(){var e;return(e=this._camera)!==null&&e!==void 0?e:this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(e,t,i,r){this.onBeforeShadowMapRenderObservable=new Q,this.onAfterShadowMapRenderObservable=new Q,this.onBeforeShadowMapRenderMeshObservable=new Q,this.onAfterShadowMapRenderMeshObservable=new Q,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=lt.FILTER_NONE,this._filteringQuality=lt.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=x.Zero(),this._viewMatrix=H.Zero(),this._projectionMatrix=H.Zero(),this._transformMatrix=H.Zero(),this._cachedPosition=new x(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new x(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=H.Identity(),this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=r??null;let s=t._shadowGenerators;s||(s=t._shadowGenerators=new Map),s.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),lt._SceneComponentInitialization(this._scene);const n=this._scene.getEngine().getCaps();i?n.textureFloatRender&&n.textureFloatLinearFiltering?this._textureType=1:n.textureHalfFloatRender&&n.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:n.textureHalfFloatRender&&n.textureHalfFloatLinearFiltering?this._textureType=2:n.textureFloatRender&&n.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){const e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new Zi(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)):this._shadowMap=new Zi(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube())}_initializeShadowMap(){if(this._createTargetRenderTexture(),this._shadowMap===null)return;this._shadowMap.wrapU=Y.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=Y.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(Y.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=this._renderForShadowMap.bind(this),this._shadowMap.customIsReadyFunction=()=>!0;const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(()=>{var r;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),(r=e._debugPushGroup)===null||r===void 0||r.call(e,`shadow map generation for pass id ${e.currentRenderPassId}`,1)}),this._shadowMap.onBeforeRenderObservable.add(r=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=r,this._filter===lt.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(()=>{var r,s;if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===lt.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap){(r=e._debugPopGroup)===null||r===void 0||r.call(e,1);return}const n=this.getShadowMapForRendering();n&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,n.renderTarget,!0),e.unBindFramebuffer(n.renderTarget,!0),(s=e._debugPopGroup)===null||s===void 0||s.call(e,1))});const t=new Ye(0,0,0,0),i=new Ye(1,1,1,1);this._shadowMap.onClearObservable.add(r=>{this._filter===lt.FILTER_PCF?r.clear(i,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?r.clear(t,!0,!0,!1):r.clear(i,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(r=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=r.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()});for(let r=ys.MIN_RENDERINGGROUPS;r<ys.MAX_RENDERINGGROUPS;r++)this._shadowMap.setRenderingAutoClearDepthStencil(r,!1)}_initializeBlurRTTAndPostProcesses(){const e=this._scene.getEngine(),t=this._mapSize/this.blurScale;(!this.useKernelBlur||this.blurScale!==1)&&(this._shadowMap2=new Zi(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=Y.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=Y.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(Y.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new Yr(this._light.name+"KernelBlurX",new Ie(1,0),this.blurKernel,1,null,Y.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(i=>{i.setTexture("textureSampler",this._shadowMap)}),this._kernelBlurYPostprocess=new Yr(this._light.name+"KernelBlurY",new Ie(0,1),this.blurKernel,1,null,Y.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===0&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new et(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,Y.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(i=>{i.setFloat2("screenSize",t,t),i.setTexture("textureSampler",this._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,i,r){let s;if(r.length)for(s=0;s<r.length;s++)this._renderSubMeshForShadowMap(r.data[s]);for(s=0;s<e.length;s++)this._renderSubMeshForShadowMap(e.data[s]);for(s=0;s<t.length;s++)this._renderSubMeshForShadowMap(t.data[s]);if(this._transparencyShadow)for(s=0;s<i.length;s++)this._renderSubMeshForShadowMap(i.data[s],!0);else for(s=0;s<i.length;s++)i.data[s].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,i){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){var i,r;const s=e.getRenderingMesh(),n=e.getEffectiveMesh(),a=this._scene,l=a.getEngine(),c=e.getMaterial();if(n._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!c||e.verticesCount===0||e._renderId===a.getRenderId())return;const h=n._getWorldMatrixDeterminant()<0;let u=(i=s.overrideMaterialSideOrientation)!==null&&i!==void 0?i:c.sideOrientation;h&&(u=u===0?1:0);const d=u===0;l.setState(c.backFaceCulling,void 0,void 0,d,c.cullBackFaces);const f=s._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(f.mustReturn)return;const _=l.getCaps().instancedArrays&&(f.visibleInstances[e._id]!==null&&f.visibleInstances[e._id]!==void 0||s.hasThinInstances);if(!(this.customAllowRendering&&!this.customAllowRendering(e)))if(this.isReady(e,_,t)){e._renderId=a.getRenderId();const p=c.shadowDepthWrapper,m=(r=p==null?void 0:p.getEffect(e,this,l.currentRenderPassId))!==null&&r!==void 0?r:e._getDrawWrapper(),T=vs.GetEffect(m);l.enableEffect(m),_||s._bind(e,T,c.fillMode),this.getTransformMatrix(),T.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===St.LIGHTTYPEID_DIRECTIONALLIGHT?T.setVector3("lightDataSM",this._cachedDirection):T.setVector3("lightDataSM",this._cachedPosition);const b=this._getCamera();if(b&&T.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(b),this.getLight().getDepthMinZ(b)+this.getLight().getDepthMaxZ(b)),t&&this.enableSoftTransparentShadow&&T.setFloat("softTransparentShadowSM",n.visibility*c.alpha),p)e._setMainDrawWrapperOverride(m),p.standalone?p.baseMaterial.bindForSubMesh(n.getWorldMatrix(),s,e):c.bindForSubMesh(n.getWorldMatrix(),s,e),e._setMainDrawWrapperOverride(null);else{if(this.useOpacityTextureForTransparentShadow){const S=c.opacityTexture;S&&(T.setTexture("diffuseSampler",S),T.setMatrix("diffuseMatrix",S.getTextureMatrix()||this._defaultTextureMatrix))}else if(c.needAlphaTesting()||c.needAlphaBlending()){const S=c.getAlphaTestTexture();S&&(T.setTexture("diffuseSampler",S),T.setMatrix("diffuseMatrix",S.getTextureMatrix()||this._defaultTextureMatrix))}if(s.useBones&&s.computeBonesUsingShaders&&s.skeleton){const S=s.skeleton;if(S.isUsingTextureForMatrices){const C=S.getTransformMatrixTexture(s);if(!C)return;T.setTexture("boneSampler",C),T.setFloat("boneTextureWidth",4*(S.bones.length+1))}else T.setMatrices("mBones",S.getTransformMatrices(s))}Ce.BindMorphTargetParameters(s,T),s.morphTargetManager&&s.morphTargetManager.isUsingTextureForTargets&&s.morphTargetManager._bind(T),Ra(T,c,a)}!this._useUBO&&!p&&this._bindCustomEffectForRenderSubMeshForShadowMap(e,T,n),Ce.BindSceneUniformBuffer(T,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const y=n.getWorldMatrix();_&&(n.getMeshUniformBuffer().bindToEffect(T,"Mesh"),n.transferToEffect(y)),this.forceBackFacesOnly&&l.setState(!0,0,!1,!0,c.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(s),this.onBeforeShadowMapRenderObservable.notifyObservers(T),s._processRendering(n,e,T,c.fillMode,f,_,(S,C)=>{n!==s&&!S?(s.getMeshUniformBuffer().bindToEffect(T,"Mesh"),s.transferToEffect(C)):(n.getMeshUniformBuffer().bindToEffect(T,"Mesh"),n.transferToEffect(S?C:y))}),this.forceBackFacesOnly&&l.setState(!0,0,!1,!1,c.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(T),this.onAfterShadowMapRenderMeshObservable.notifyObservers(s)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===lt.FILTER_NONE||this.filter===lt.FILTER_PCSS?this._shadowMap.updateSamplingMode(Y.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(Y.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){const i={useInstances:!1,...t},r=this.getShadowMap();if(!r){e&&e(this);return}const s=r.renderList;if(!s){e&&e(this);return}const n=new Array;for(const c of s)n.push(...c.subMeshes);if(n.length===0){e&&e(this);return}let a=0;const l=()=>{var c,h;if(!(!this._scene||!this._scene.getEngine())){for(;this.isReady(n[a],i.useInstances,(h=(c=n[a].getMaterial())===null||c===void 0?void 0:c.needAlphaBlendingForMesh(n[a].getMesh()))!==null&&h!==void 0?h:!1);)if(a++,a>=n.length){e&&e(this);return}setTimeout(l,16)}};l()}forceCompilationAsync(e){return new Promise(t=>{this.forceCompilation(()=>{t()},e)})}_isReadyCustomDefines(e,t,i){}_prepareShadowDefines(e,t,i,r){i.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),i.push("#define SM_FLOAT "+(this._textureType!==0?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const s=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&s.isVerticesDataPresent(O.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===St.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&r?"1":"0")),this._isReadyCustomDefines(i,e,t),i}isReady(e,t,i){var r;const s=e.getMaterial(),n=s==null?void 0:s.shadowDepthWrapper;if(!s)return!1;const a=[];if(this._prepareShadowDefines(e,t,a,i),n){if(!n.isReadyForSubMesh(e,a,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{const l=e._getDrawWrapper(void 0,!0);let c=l.effect,h=l.defines;const u=[O.PositionKind],d=e.getMesh();this.normalBias&&d.isVerticesDataPresent(O.NormalKind)&&(u.push(O.NormalKind),a.push("#define NORMAL"),d.nonUniformScaling&&a.push("#define NONUNIFORMSCALING"));const f=s==null?void 0:s.needAlphaTesting(),_=s==null?void 0:s.needAlphaBlending();if(s&&(f||_)){let y=null;if(this.useOpacityTextureForTransparentShadow?y=s.opacityTexture:y=s.getAlphaTestTexture(),y){if(!y.isReady())return!1;const S=(r=s.alphaCutOff)!==null&&r!==void 0?r:lt.DEFAULT_ALPHA_CUTOFF;a.push("#define ALPHATEXTURE"),f&&a.push(`#define ALPHATESTVALUE ${S}${S%1===0?".":""}`),d.isVerticesDataPresent(O.UVKind)&&(u.push(O.UVKind),a.push("#define UV1")),d.isVerticesDataPresent(O.UV2Kind)&&y.coordinatesIndex===1&&(u.push(O.UV2Kind),a.push("#define UV2"))}}const p=new pc;if(d.useBones&&d.computeBonesUsingShaders&&d.skeleton){u.push(O.MatricesIndicesKind),u.push(O.MatricesWeightsKind),d.numBoneInfluencers>4&&(u.push(O.MatricesIndicesExtraKind),u.push(O.MatricesWeightsExtraKind));const y=d.skeleton;a.push("#define NUM_BONE_INFLUENCERS "+d.numBoneInfluencers),d.numBoneInfluencers>0&&p.addCPUSkinningFallback(0,d),y.isUsingTextureForMatrices?a.push("#define BONETEXTURE"):a.push("#define BonesPerMesh "+(y.bones.length+1))}else a.push("#define NUM_BONE_INFLUENCERS 0");const m=d.morphTargetManager;let T=0;if(m&&m.numInfluencers>0&&(a.push("#define MORPHTARGETS"),T=m.numInfluencers,a.push("#define NUM_MORPH_INFLUENCERS "+T),m.isUsingTextureForTargets&&a.push("#define MORPHTARGETS_TEXTURE"),Ce.PrepareAttributesForMorphTargetsInfluencers(u,d,T)),Zo(s,this._scene,a),t&&(a.push("#define INSTANCES"),Ce.PushAttributesForInstances(u),e.getRenderingMesh().hasThinInstances&&a.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const y of this.customShaderOptions.defines)a.indexOf(y)===-1&&a.push(y);const b=a.join(`
`);if(h!==b){h=b;let y="shadowMap";const S=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices"],C=["diffuseSampler","boneSampler","morphTargets"],I=["Scene","Mesh"];if(ja(S),this.customShaderOptions){if(y=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const D of this.customShaderOptions.attributes)u.indexOf(D)===-1&&u.push(D);if(this.customShaderOptions.uniforms)for(const D of this.customShaderOptions.uniforms)S.indexOf(D)===-1&&S.push(D);if(this.customShaderOptions.samplers)for(const D of this.customShaderOptions.samplers)C.indexOf(D)===-1&&C.push(D)}const P=this._scene.getEngine();c=P.createEffect(y,{attributes:u,uniformsNames:S,uniformBuffersNames:I,samplers:C,defines:b,fallbacks:p,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:T}},P),l.setEffect(c,h)}if(!c.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(e,t){const i=this._scene,r=this._light;!i.shadowsEnabled||!r.shadowEnabled||(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===lt.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===lt.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===lt.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===lt.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),r.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const s=this._getCamera();if(!s)return;const n=this.getShadowMap();n&&(i.needCube()||t.setMatrix("lightMatrix"+e,this.getTransformMatrix()),this._filter===lt.FILTER_PCF?(t.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),n.getSize().width,1/n.getSize().width,this.frustumEdgeFalloff,e)):this._filter===lt.FILTER_PCSS?(t.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),t.setTexture("depthSampler"+e,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/n.getSize().width,this._contactHardeningLightSizeUVRatio*n.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowSampler"+e,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/n.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),e))}getTransformMatrix(){const e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),x.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),Math.abs(x.Dot(this._lightDirection,x.Up()))===1&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),H.LookAtLHToRef(t,t.add(this._lightDirection),x.Up(),this._viewMatrix);const i=this.getShadowMap();if(i){const r=i.renderList;r&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,r)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const e=this._shadowMap;if(!e)return;const t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const i of t)this._shadowMap.renderList.push(i)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const e=this._light._shadowGenerators.entries();for(let t=e.next();t.done!==!0;t=e.next()){const[i,r]=t.value;r===this&&this._light._shadowGenerators.delete(i)}this._light._shadowGenerators.size===0&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){var e;const t={},i=this.getShadowMap();if(!i)return t;if(t.className=this.getClassName(),t.lightId=this._light.id,t.cameraId=(e=this._camera)===null||e===void 0?void 0:e.id,t.id=this.id,t.mapSize=i.getRenderSize(),t.forceBackFacesOnly=this.forceBackFacesOnly,t.darkness=this.getDarkness(),t.transparencyShadow=this._transparencyShadow,t.frustumEdgeFalloff=this.frustumEdgeFalloff,t.bias=this.bias,t.normalBias=this.normalBias,t.usePercentageCloserFiltering=this.usePercentageCloserFiltering,t.useContactHardeningShadow=this.useContactHardeningShadow,t.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,t.filteringQuality=this.filteringQuality,t.useExponentialShadowMap=this.useExponentialShadowMap,t.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,t.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.usePoissonSampling=this.usePoissonSampling,t.depthScale=this.depthScale,t.blurBoxOffset=this.blurBoxOffset,t.blurKernel=this.blurKernel,t.blurScale=this.blurScale,t.useKernelBlur=this.useKernelBlur,t.renderList=[],i.renderList)for(let r=0;r<i.renderList.length;r++){const s=i.renderList[r];t.renderList.push(s.id)}return t}static Parse(e,t,i){const r=t.getLightById(e.lightId),s=e.cameraId!==void 0?t.getCameraById(e.cameraId):null,n=i?i(e.mapSize,r,s):new lt(e.mapSize,r,void 0,s),a=n.getShadowMap();for(let l=0;l<e.renderList.length;l++)t.getMeshesById(e.renderList[l]).forEach(function(h){a&&(a.renderList||(a.renderList=[]),a.renderList.push(h))});return e.id!==void 0&&(n.id=e.id),n.forceBackFacesOnly=!!e.forceBackFacesOnly,e.darkness!==void 0&&n.setDarkness(e.darkness),e.transparencyShadow&&n.setTransparencyShadow(!0),e.frustumEdgeFalloff!==void 0&&(n.frustumEdgeFalloff=e.frustumEdgeFalloff),e.bias!==void 0&&(n.bias=e.bias),e.normalBias!==void 0&&(n.normalBias=e.normalBias),e.usePercentageCloserFiltering?n.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?n.useContactHardeningShadow=!0:e.usePoissonSampling?n.usePoissonSampling=!0:e.useExponentialShadowMap?n.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?n.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?n.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?n.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?n.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(n.useBlurExponentialShadowMap=!0),e.contactHardeningLightSizeUVRatio!==void 0&&(n.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),e.filteringQuality!==void 0&&(n.filteringQuality=e.filteringQuality),e.depthScale&&(n.depthScale=e.depthScale),e.blurScale&&(n.blurScale=e.blurScale),e.blurBoxOffset&&(n.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(n.useKernelBlur=e.useKernelBlur),e.blurKernel&&(n.blurKernel=e.blurKernel),n}}lt.CLASSNAME="ShadowGenerator";lt.FILTER_NONE=0;lt.FILTER_EXPONENTIALSHADOWMAP=1;lt.FILTER_POISSONSAMPLING=2;lt.FILTER_BLUREXPONENTIALSHADOWMAP=3;lt.FILTER_CLOSEEXPONENTIALSHADOWMAP=4;lt.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5;lt.FILTER_PCF=6;lt.FILTER_PCSS=7;lt.QUALITY_HIGH=0;lt.QUALITY_MEDIUM=1;lt.QUALITY_LOW=2;lt.DEFAULT_ALPHA_CUTOFF=.5;lt._SceneComponentInitialization=o=>{throw pt("ShadowGeneratorSceneComponent")};const vD="depthPixelShader",xD=`#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
varying float vDepthMetric;
#ifdef PACKED
#include<packingFunctions>
#endif
#ifdef STORE_CAMERASPACE_Z
varying vec4 vViewPos;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#ifdef STORE_CAMERASPACE_Z
#ifdef PACKED
gl_FragColor=pack(vViewPos.z);
#else
gl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);
#endif
#else
#ifdef NONLINEARDEPTH
#ifdef PACKED
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);
#endif
#else
#ifdef PACKED
gl_FragColor=pack(vDepthMetric);
#else
gl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);
#endif
#endif
#endif
}`;te.ShadersStore[vD]=xD;const TD="depthVertexShader",ED=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;
uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#ifdef STORE_CAMERASPACE_Z
uniform mat4 view;
varying vec4 vViewPos;
#endif
varying float vDepthMetric;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#include<clipPlaneVertex>
gl_Position=viewProjection*worldPos;
#ifdef STORE_CAMERASPACE_Z
vViewPos=view*worldPos;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));
#else
vDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));
#endif
#endif
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
}
`;te.ShadersStore[TD]=ED;class xc{setMaterialForRendering(e,t){this._depthMap.setMaterialForRendering(e,t)}constructor(e,t=1,i=null,r=!1,s=Y.TRILINEAR_SAMPLINGMODE,n=!1,a){this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.reverseCulling=!1,this._scene=e,this._storeNonLinearDepth=r,this._storeCameraSpaceZ=n,this.isPacked=t===0,this.isPacked?this.clearColor=new Ye(1,1,1,1):this.clearColor=new Ye(1,0,0,1),xc._SceneComponentInitialization(this._scene);const l=e.getEngine();this._camera=i,s!==Y.NEAREST_SAMPLINGMODE&&(t===1&&!l._caps.textureFloatLinearFiltering&&(s=Y.NEAREST_SAMPLINGMODE),t===2&&!l._caps.textureHalfFloatLinearFiltering&&(s=Y.NEAREST_SAMPLINGMODE));const c=this.isPacked||!l._features.supportExtendedTextureFormats?5:6;this._depthMap=new Zi(a??"DepthRenderer",{width:l.getRenderWidth(),height:l.getRenderHeight()},this._scene,!1,!0,t,!1,s,void 0,void 0,void 0,c),this._depthMap.wrapU=Y.CLAMP_ADDRESSMODE,this._depthMap.wrapV=Y.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(u=>{u.clear(this.clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(()=>{var u;(u=l._debugPushGroup)===null||u===void 0||u.call(l,"depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(()=>{var u;(u=l._debugPopGroup)===null||u===void 0||u.call(l,1)}),this._depthMap.customIsReadyFunction=(u,d,f)=>{if((f||d===0)&&u.subMeshes)for(let _=0;_<u.subMeshes.length;++_){const p=u.subMeshes[_],m=p.getRenderingMesh(),T=m._getInstancesRenderList(p._id,!!p.getReplacementMesh()),b=l.getCaps().instancedArrays&&(T.visibleInstances[p._id]!==null&&T.visibleInstances[p._id]!==void 0||m.hasThinInstances);if(!this.isReady(p,b))return!1}return!0};const h=u=>{var d,f;const _=u.getRenderingMesh(),p=u.getEffectiveMesh(),m=this._scene,T=m.getEngine(),b=u.getMaterial();if(p._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!b||p.infiniteDistance||b.disableDepthWrite||u.verticesCount===0||u._renderId===m.getRenderId())return;const y=p._getWorldMatrixDeterminant()<0;let S=(d=_.overrideMaterialSideOrientation)!==null&&d!==void 0?d:b.sideOrientation;y&&(S=S===0?1:0);const C=S===0;T.setState(b.backFaceCulling,0,!1,C,this.reverseCulling?!b.cullBackFaces:b.cullBackFaces);const I=_._getInstancesRenderList(u._id,!!u.getReplacementMesh());if(I.mustReturn)return;const P=T.getCaps().instancedArrays&&(I.visibleInstances[u._id]!==null&&I.visibleInstances[u._id]!==void 0||_.hasThinInstances),D=this._camera||m.activeCamera;if(this.isReady(u,P)&&D){u._renderId=m.getRenderId();const w=(f=p._internalAbstractMeshDataInfo._materialForRenderPass)===null||f===void 0?void 0:f[T.currentRenderPassId];let L=u._getDrawWrapper();!L&&w&&(L=w._getDrawWrapper());const U=D.mode===Ve.ORTHOGRAPHIC_CAMERA;if(!L)return;const G=L.effect;T.enableEffect(L),P||_._bind(u,G,b.fillMode),w?w.bindForSubMesh(p.getWorldMatrix(),p,u):(G.setMatrix("viewProjection",m.getTransformMatrix()),G.setMatrix("world",p.getWorldMatrix()),this._storeCameraSpaceZ&&G.setMatrix("view",m.getViewMatrix()));let Z,he;if(U?(Z=!T.useReverseDepthBuffer&&T.isNDCHalfZRange?0:1,he=T.useReverseDepthBuffer&&T.isNDCHalfZRange?0:1):(Z=T.useReverseDepthBuffer&&T.isNDCHalfZRange?D.minZ:T.isNDCHalfZRange?0:D.minZ,he=T.useReverseDepthBuffer&&T.isNDCHalfZRange?0:D.maxZ),G.setFloat2("depthValues",Z,Z+he),!w){if(b.needAlphaTesting()){const _e=b.getAlphaTestTexture();_e&&(G.setTexture("diffuseSampler",_e),G.setMatrix("diffuseMatrix",_e.getTextureMatrix()))}if(_.useBones&&_.computeBonesUsingShaders&&_.skeleton){const _e=_.skeleton;if(_e.isUsingTextureForMatrices){const ne=_e.getTransformMatrixTexture(_);if(!ne)return;G.setTexture("boneSampler",ne),G.setFloat("boneTextureWidth",4*(_e.bones.length+1))}else G.setMatrices("mBones",_e.getTransformMatrices(_))}Ra(G,b,m),Ce.BindMorphTargetParameters(_,G),_.morphTargetManager&&_.morphTargetManager.isUsingTextureForTargets&&_.morphTargetManager._bind(G)}_._processRendering(p,u,G,b.fillMode,I,P,(_e,ne)=>G.setMatrix("world",ne))}};this._depthMap.customRenderFunction=(u,d,f,_)=>{let p;if(_.length)for(p=0;p<_.length;p++)h(_.data[p]);for(p=0;p<u.length;p++)h(u.data[p]);for(p=0;p<d.length;p++)h(d.data[p]);if(this.forceDepthWriteTransparentMeshes)for(p=0;p<f.length;p++)h(f.data[p]);else for(p=0;p<f.length;p++)f.data[p].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}isReady(e,t){var i;const r=this._scene.getEngine(),s=e.getMesh(),n=s.getScene(),a=(i=s._internalAbstractMeshDataInfo._materialForRenderPass)===null||i===void 0?void 0:i[r.currentRenderPassId];if(a)return a.isReadyForSubMesh(s,e,t);const l=e.getMaterial();if(!l||l.disableDepthWrite)return!1;const c=[],h=[O.PositionKind];if(l&&l.needAlphaTesting()&&l.getAlphaTestTexture()&&(c.push("#define ALPHATEST"),s.isVerticesDataPresent(O.UVKind)&&(h.push(O.UVKind),c.push("#define UV1")),s.isVerticesDataPresent(O.UV2Kind)&&(h.push(O.UV2Kind),c.push("#define UV2"))),s.useBones&&s.computeBonesUsingShaders){h.push(O.MatricesIndicesKind),h.push(O.MatricesWeightsKind),s.numBoneInfluencers>4&&(h.push(O.MatricesIndicesExtraKind),h.push(O.MatricesWeightsExtraKind)),c.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),c.push("#define BonesPerMesh "+(s.skeleton?s.skeleton.bones.length+1:0));const m=e.getRenderingMesh().skeleton;m!=null&&m.isUsingTextureForMatrices&&c.push("#define BONETEXTURE")}else c.push("#define NUM_BONE_INFLUENCERS 0");const u=s.morphTargetManager;let d=0;u&&u.numInfluencers>0&&(d=u.numInfluencers,c.push("#define MORPHTARGETS"),c.push("#define NUM_MORPH_INFLUENCERS "+d),u.isUsingTextureForTargets&&c.push("#define MORPHTARGETS_TEXTURE"),Ce.PrepareAttributesForMorphTargetsInfluencers(h,s,d)),t&&(c.push("#define INSTANCES"),Ce.PushAttributesForInstances(h),e.getRenderingMesh().hasThinInstances&&c.push("#define THIN_INSTANCES")),this._storeNonLinearDepth&&c.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&c.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&c.push("#define PACKED"),Zo(l,n,c);const f=e._getDrawWrapper(void 0,!0),_=f.defines,p=c.join(`
`);if(_!==p){const m=["world","mBones","boneTextureWidth","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];ja(m),f.setEffect(r.createEffect("depth",h,m,["diffuseSampler","morphTargets","boneSampler"],p,void 0,void 0,void 0,{maxSimultaneousMorphTargets:d}),p)}return f.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){const e=[];for(const t in this._scene._depthRenderer)this._scene._depthRenderer[t]===this&&e.push(t);if(e.length>0){this._depthMap.dispose();for(const t of e)delete this._scene._depthRenderer[t]}}}xc._SceneComponentInitialization=o=>{throw pt("DepthRendererSceneComponent")};const bD="minmaxReduxPixelShader",SD=`varying vec2 vUV;
uniform sampler2D textureSampler;
#if defined(INITIAL)
uniform sampler2D sourceTexture;
uniform vec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*(texSize-1.0));
float f1=texelFetch(sourceTexture,coord,0).r;
float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;
float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;
float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;
float minz=min(min(min(f1,f2),f3),f4);
#ifdef DEPTH_REDUX
float maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);
#else
float maxz=max(max(max(f1,f2),f3),f4);
#endif
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(MAIN)
uniform vec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*(texSize-1.0));
vec2 f1=texelFetch(textureSampler,coord,0).rg;
vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;
vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;
vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;
float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);
float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(ONEBEFORELAST)
uniform ivec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*vec2(texSize-1));
vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;
vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;
vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;
vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;
float minz=min(f1.x,f2.x);
float maxz=max(f1.y,f2.y);
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(LAST)
void main(void)
{
glFragColor=vec4(0.);
if (true) { 
discard;
}
}
#endif
`;te.ShadersStore[bD]=SD;class yD{constructor(e){this.onAfterReductionPerformed=new Q,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new zd(e.getScene()),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{this._postProcessManager._rebuild()})}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=2,r=!0){if(e===this._sourceTexture)return;this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=r;const s=this._camera.getScene(),n=new et("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,s.getEngine(),!1,"#define INITIAL"+(t?`
#define DEPTH_REDUX`:""),i,void 0,void 0,void 0,7);n.autoClear=!1,n.forceFullscreenViewport=r;let a=this._sourceTexture.getRenderWidth(),l=this._sourceTexture.getRenderHeight();n.onApply=((h,u)=>d=>{d.setTexture("sourceTexture",this._sourceTexture),d.setFloat2("texSize",h,u)})(a,l),this._reductionSteps.push(n);let c=1;for(;a>1||l>1;){a=Math.max(Math.round(a/2),1),l=Math.max(Math.round(l/2),1);const h=new et("Reduction phase "+c,"minmaxRedux",["texSize"],null,{width:a,height:l},null,1,s.getEngine(),!1,"#define "+(a==1&&l==1?"LAST":a==1||l==1?"ONEBEFORELAST":"MAIN"),i,void 0,void 0,void 0,7);if(h.autoClear=!1,h.forceFullscreenViewport=r,h.onApply=((u,d)=>f=>{u==1||d==1?f.setInt2("texSize",u,d):f.setFloat2("texSize",u,d)})(a,l),this._reductionSteps.push(h),c++,a==1&&l==1){const u=(d,f,_)=>{const p=new Float32Array(4*d*f),m={min:0,max:0};return()=>{s.getEngine()._readTexturePixels(_.inputTexture.texture,d,f,-1,0,p,!1),m.min=p[0],m.max=p[1],this.onAfterReductionPerformed.notifyObservers(m)}};h.onAfterRenderObservable.add(u(a,l,h))}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){this._onAfterUnbindObserver||!this._sourceTexture||(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(()=>{var e,t;const i=this._camera.getScene().getEngine();(e=i._debugPushGroup)===null||e===void 0||e.call(i,"min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport),i.unBindFramebuffer(this._reductionSteps[0].inputTexture,!1),(t=i._debugPopGroup)===null||t===void 0||t.call(i,1)}),this._activated=!0)}deactivate(){!this._onAfterUnbindObserver||!this._sourceTexture||(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){if(e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(let t=0;t<this._reductionSteps.length;++t)this._reductionSteps[t].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null}}class CD extends yD{get depthRenderer(){return this._depthRenderer}constructor(e){super(e)}setDepthRenderer(e=null,t=2,i=!0){const r=this._camera.getScene();this._depthRenderer&&(delete r._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),e===null&&(r._depthRenderer||(r._depthRenderer={}),e=this._depthRenderer=new xc(r,t,this._camera,!1,1),e.enabled=!1,this._depthRendererId="minmax"+this._camera.id,r._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,i)}setSourceTexture(e,t,i=2,r=!0){super.setSourceTexture(e,t,i,r)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){if(super.dispose(e),this._depthRenderer&&e){const t=this._depthRenderer.getDepthMap().getScene();t&&delete t._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}}const cx=x.Up(),AD=x.Zero(),kr=new x,wc=new x,Id=new H;class _s extends lt{_validateFilter(e){return e===lt.FILTER_NONE||e===lt.FILTER_PCF||e===lt.FILTER_PCSS?e:(console.error('Unsupported filter "'+e+'"!'),lt.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){e=Math.min(Math.max(e,_s.MIN_CASCADES_COUNT),_s.MAX_CASCADES_COUNT),e!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),!this._freezeShadowCastersBoundingInfoObservable&&!e&&(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(this._computeShadowCastersBoundingInfo.bind(this))),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._shadowMap&&this._shadowMap.renderList){const e=this._shadowMap.renderList;for(let i=0;i<e.length;i++){const r=e[i];if(!r)continue;const s=r.getBoundingInfo(),n=s.boundingBox;this._scbiMin.minimizeInPlace(n.minimumWorld),this._scbiMax.maximizeInPlace(n.maximumWorld)}const t=this._scene.meshes;for(let i=0;i<t.length;i++){const r=t[i];if(!r||!r.isVisible||!r.isEnabled||!r.receiveShadows)continue;const s=r.getBoundingInfo(),n=s.boundingBox;this._scbiMin.minimizeInPlace(n.minimumWorld),this._scbiMax.maximizeInPlace(n.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return _s.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){const t=this._getCamera();if(!t){this._shadowMaxZ=e;return}this._shadowMaxZ===e||e<t.minZ||e>t.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0)}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){const t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){const t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e){this._depthReducer&&this._depthReducer.deactivate(),this.setMinMaxDistance(0,1);return}this._depthReducer||(this._depthReducer=new CD(t),this._depthReducer.onAfterReductionPerformed.add(i=>{let r=i.min,s=i.max;r>=s&&(r=0,s=1),(r!=this._minDistance||s!=this._maxDistance)&&this.setMinMaxDistance(r,s)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){var e,t,i;return(i=(t=(e=this._depthReducer)===null||e===void 0?void 0:e.depthRenderer)===null||t===void 0?void 0:t.getDepthMap().refreshRate)!==null&&i!==void 0?i:-1}set autoCalcDepthBoundsRefreshRate(e){var t;!((t=this._depthReducer)===null||t===void 0)&&t.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){const e=this._getCamera();if(!e)return;const t=e.minZ,i=e.maxZ,r=i-t,s=this._minDistance,n=this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance,a=t+s*r,l=t+n*r,c=l-a,h=l/a;for(let u=0;u<this._cascades.length;++u){const d=(u+1)/this._numCascades,f=a*h**d,_=a+c*d,p=this._lambda*(f-_)+_;this._cascades[u].prevBreakDistance=u===0?s:this._cascades[u-1].breakDistance,this._cascades[u].breakDistance=(p-t)/r,this._viewSpaceFrustumsZ[u]=p,this._frustumLengths[u]=(this._cascades[u].breakDistance-this._cascades[u].prevBreakDistance)*r}this._breaksAreDirty=!1}_computeMatrices(){const e=this._scene;if(!this._getCamera())return;x.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),Math.abs(x.Dot(this._lightDirection,x.Up()))===1&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);const i=e.getEngine().useReverseDepthBuffer;for(let r=0;r<this._numCascades;++r){this._computeFrustumInWorldSpace(r),this._computeCascadeFrustum(r),this._cascadeMaxExtents[r].subtractToRef(this._cascadeMinExtents[r],kr),this._frustumCenter[r].addToRef(this._lightDirection.scale(this._cascadeMinExtents[r].z),this._shadowCameraPos[r]),H.LookAtLHToRef(this._shadowCameraPos[r],this._frustumCenter[r],cx,this._viewMatrices[r]);let s=0,n=kr.z;const a=this._shadowCastersBoundingInfo;a.update(this._viewMatrices[r]),n=Math.min(n,a.boundingBox.maximumWorld.z),!this._depthClamp||this.filter===lt.FILTER_PCSS?s=Math.min(s,a.boundingBox.minimumWorld.z):s=Math.max(s,a.boundingBox.minimumWorld.z),H.OrthoOffCenterLHToRef(this._cascadeMinExtents[r].x,this._cascadeMaxExtents[r].x,this._cascadeMinExtents[r].y,this._cascadeMaxExtents[r].y,i?n:s,i?s:n,this._projectionMatrices[r],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[r].z=s,this._cascadeMaxExtents[r].z=n,this._viewMatrices[r].multiplyToRef(this._projectionMatrices[r],this._transformMatrices[r]),x.TransformCoordinatesToRef(AD,this._transformMatrices[r],kr),kr.scaleInPlace(this._mapSize/2),wc.copyFromFloats(Math.round(kr.x),Math.round(kr.y),Math.round(kr.z)),wc.subtractInPlace(kr).scaleInPlace(2/this._mapSize),H.TranslationToRef(wc.x,wc.y,0,Id),this._projectionMatrices[r].multiplyToRef(Id,this._projectionMatrices[r]),this._viewMatrices[r].multiplyToRef(this._projectionMatrices[r],this._transformMatrices[r]),this._transformMatrices[r].copyToArray(this._transformMatricesAsArray,r*16)}}_computeFrustumInWorldSpace(e){const t=this._getCamera();if(!t)return;const i=this._cascades[e].prevBreakDistance,r=this._cascades[e].breakDistance,s=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();const n=H.Invert(t.getTransformationMatrix()),a=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let l=0;l<_s._FrustumCornersNDCSpace.length;++l)kr.copyFrom(_s._FrustumCornersNDCSpace[(l+a)%_s._FrustumCornersNDCSpace.length]),s&&kr.z===-1&&(kr.z=0),x.TransformCoordinatesToRef(kr,n,this._frustumCornersWorldSpace[e][l]);for(let l=0;l<_s._FrustumCornersNDCSpace.length/2;++l)kr.copyFrom(this._frustumCornersWorldSpace[e][l+4]).subtractInPlace(this._frustumCornersWorldSpace[e][l]),wc.copyFrom(kr).scaleInPlace(i),kr.scaleInPlace(r),kr.addInPlace(this._frustumCornersWorldSpace[e][l]),this._frustumCornersWorldSpace[e][l+4].copyFrom(kr),this._frustumCornersWorldSpace[e][l].addInPlace(wc)}_computeCascadeFrustum(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),!!this._getCamera()){for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][i]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let i=0;for(let r=0;r<this._frustumCornersWorldSpace[e].length;++r){const s=this._frustumCornersWorldSpace[e][r].subtractToRef(this._frustumCenter[e],kr).length();i=Math.max(i,s)}i=Math.ceil(i*16)/16,this._cascadeMaxExtents[e].copyFromFloats(i,i,i),this._cascadeMinExtents[e].copyFromFloats(-i,-i,-i)}else{const i=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,kr),H.LookAtLHToRef(i,kr,cx,Id);for(let r=0;r<this._frustumCornersWorldSpace[e].length;++r)x.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][r],Id,kr),this._cascadeMinExtents[e].minimizeInPlace(kr),this._cascadeMaxExtents[e].maximizeInPlace(kr)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){const e=qe.LastCreatedEngine;return e?e._features.supportCSM:!1}constructor(e,t,i,r){if(!_s.IsSupported){X.Error("CascadedShadowMap is not supported by the current engine.");return}super(e,t,i,r),this.usePercentageCloserFiltering=!0}_initializeGenerator(){var e,t,i,r,s,n,a,l,c,h,u,d,f,_,p,m,T,b,y,S;this.penumbraDarkness=(e=this.penumbraDarkness)!==null&&e!==void 0?e:1,this._numCascades=(t=this._numCascades)!==null&&t!==void 0?t:_s.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=(i=this.stabilizeCascades)!==null&&i!==void 0?i:!1,this._freezeShadowCastersBoundingInfoObservable=(r=this._freezeShadowCastersBoundingInfoObservable)!==null&&r!==void 0?r:null,this.freezeShadowCastersBoundingInfo=(s=this.freezeShadowCastersBoundingInfo)!==null&&s!==void 0?s:!1,this._scbiMin=(n=this._scbiMin)!==null&&n!==void 0?n:new x(0,0,0),this._scbiMax=(a=this._scbiMax)!==null&&a!==void 0?a:new x(0,0,0),this._shadowCastersBoundingInfo=(l=this._shadowCastersBoundingInfo)!==null&&l!==void 0?l:new Qn(new x(0,0,0),new x(0,0,0)),this._breaksAreDirty=(c=this._breaksAreDirty)!==null&&c!==void 0?c:!0,this._minDistance=(h=this._minDistance)!==null&&h!==void 0?h:0,this._maxDistance=(u=this._maxDistance)!==null&&u!==void 0?u:1,this._currentLayer=(d=this._currentLayer)!==null&&d!==void 0?d:0,this._shadowMaxZ=(p=(f=this._shadowMaxZ)!==null&&f!==void 0?f:(_=this._getCamera())===null||_===void 0?void 0:_.maxZ)!==null&&p!==void 0?p:1e4,this._debug=(m=this._debug)!==null&&m!==void 0?m:!1,this._depthClamp=(T=this._depthClamp)!==null&&T!==void 0?T:!0,this._cascadeBlendPercentage=(b=this._cascadeBlendPercentage)!==null&&b!==void 0?b:.1,this._lambda=(y=this._lambda)!==null&&y!==void 0?y:.5,this._autoCalcDepthBounds=(S=this._autoCalcDepthBounds)!==null&&S!==void 0?S:!1,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){const e=this._scene.getEngine(),t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new Zi(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)}_initializeShadowMap(){if(super._initializeShadowMap(),this._shadowMap===null)return;this._transformMatricesAsArray=new Float32Array(this._numCascades*16),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(this._numCascades*2),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let t=0;t<this._numCascades;++t){this._cascades[t]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[t]=H.Zero(),this._projectionMatrices[t]=H.Zero(),this._transformMatrices[t]=H.Zero(),this._cascadeMinExtents[t]=new x,this._cascadeMaxExtents[t]=new x,this._frustumCenter[t]=new x,this._shadowCameraPos[t]=new x,this._frustumCornersWorldSpace[t]=new Array(_s._FrustumCornersNDCSpace.length);for(let i=0;i<_s._FrustumCornersNDCSpace.length;++i)this._frustumCornersWorldSpace[t][i]=new x}const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===lt.FILTER_PCF&&e.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onBeforeBindObservable.add(()=>{var t;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),(t=e._debugPushGroup)===null||t===void 0||t.call(e,`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()}),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==lt.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);const i=this._scene,r=this._light;if(!i.shadowsEnabled||!r.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;const s=this._getCamera();s&&this._shadowMaxZ<s.maxZ&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),this.cascadeBlendPercentage===0&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const s=this._getCamera();if(!s)return;const n=this.getShadowMap();if(!n)return;const a=n.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,this.cascadeBlendPercentage===0?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===lt.FILTER_PCF)t.setDepthStencilTexture("shadowSampler"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a,1/a,this.frustumEdgeFalloff,e);else if(this._filter===lt.FILTER_PCSS){for(let l=0;l<this._numCascades;++l)this._lightSizeUVCorrection[l*2+0]=l===0?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[l].x-this._cascadeMinExtents[l].x),this._lightSizeUVCorrection[l*2+1]=l===0?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[l].y-this._cascadeMinExtents[l].y),this._depthCorrection[l]=l===0?1:(this._cascadeMaxExtents[l].z-this._cascadeMinExtents[l].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowSampler"+e,n),t.setTexture("depthSampler"+e,n),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/a,this._contactHardeningLightSizeUVRatio*a,this.frustumEdgeFalloff,e)}else t.setTexture("shadowSampler"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a,1/a,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){const e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){const r=t.renderList[i];e.renderList.push(r.id)}return e}static Parse(e,t){const i=lt.Parse(e,t,(r,s,n)=>new _s(r,s,void 0,n));return e.numCascades!==void 0&&(i.numCascades=e.numCascades),e.debug!==void 0&&(i.debug=e.debug),e.stabilizeCascades!==void 0&&(i.stabilizeCascades=e.stabilizeCascades),e.lambda!==void 0&&(i.lambda=e.lambda),e.cascadeBlendPercentage!==void 0&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),e.depthClamp!==void 0&&(i.depthClamp=e.depthClamp),e.autoCalcDepthBounds!==void 0&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),e.shadowMaxZ!==void 0&&(i.shadowMaxZ=e.shadowMaxZ),e.penumbraDarkness!==void 0&&(i.penumbraDarkness=e.penumbraDarkness),e.freezeShadowCastersBoundingInfo!==void 0&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),e.minDistance!==void 0&&e.maxDistance!==void 0&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}}_s._FrustumCornersNDCSpace=[new x(-1,1,-1),new x(1,1,-1),new x(1,-1,-1),new x(-1,-1,-1),new x(-1,1,1),new x(1,1,1),new x(1,-1,1),new x(-1,-1,1)];_s.CLASSNAME="CascadedShadowGenerator";_s.DEFAULT_CASCADES_COUNT=4;_s.MIN_CASCADES_COUNT=2;_s.MAX_CASCADES_COUNT=4;_s._SceneComponentInitialization=o=>{throw pt("ShadowGeneratorSceneComponent")};Er.AddParser(Re.NAME_SHADOWGENERATOR,(o,e)=>{if(o.shadowGenerators!==void 0&&o.shadowGenerators!==null)for(let t=0,i=o.shadowGenerators.length;t<i;t++){const r=o.shadowGenerators[t];r.className===_s.CLASSNAME?_s.Parse(r,e):lt.Parse(r,e)}});class RD{constructor(e){this.name=Re.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Re.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];const t=this.scene.lights;for(const i of t){const r=i.getShadowGenerators();if(r){const s=r.values();for(let n=s.next();n.done!==!0;n=s.next()){const a=n.value;e.shadowGenerators.push(a.serialize())}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){const t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){const r=t.lights[i],s=r.getShadowGenerators();if(r.isEnabled()&&r.shadowEnabled&&s){const n=s.values();for(let a=n.next();a.done!==!0;a=n.next()){const c=a.value.getShadowMap();t.textures.indexOf(c)!==-1&&e.push(c)}}}}}lt._SceneComponentInitialization=o=>{let e=o._getComponent(Re.NAME_SHADOWGENERATOR);e||(e=new RD(o),o._addComponent(e))};ii.AddNodeConstructor("Light_Type_0",(o,e)=>()=>new Bl(o,x.Zero(),e));class Bl extends zl{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){const i=this._shadowGenerators.values();for(let r=i.next();r.done!==!0;r=i.next())r.value.recreateShadowMap()}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return St.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new x(1,0,0);case 1:return new x(-1,0,0);case 2:return new x(0,-1,0);case 3:return new x(0,1,0);case 4:return new x(0,0,1);case 5:return new x(0,0,-1)}return x.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(!r)return;const s=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,n=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,a=this.getScene().getEngine().useReverseDepthBuffer;H.PerspectiveFovLHToRef(this.shadowAngle,1,a?n:s,a?s:n,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,a)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}}M([F()],Bl.prototype,"shadowAngle",null);class fo{constructor(e,t="",i="black"){this._renderingCanvas=e,this._loadingText=t,this._loadingDivBackgroundColor=i,this._resizeLoadingUI=()=>{const r=this._renderingCanvas.getBoundingClientRect(),s=window.getComputedStyle(this._renderingCanvas).position;this._loadingDiv&&(this._loadingDiv.style.position=s==="fixed"?"fixed":"absolute",this._loadingDiv.style.left=r.left+"px",this._loadingDiv.style.top=r.top+"px",this._loadingDiv.style.width=r.width+"px",this._loadingDiv.style.height=r.height+"px")}}displayLoadingUI(){if(this._loadingDiv)return;this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingDiv.style.pointerEvents="none",this._loadingDiv.style.display="grid",this._loadingDiv.style.gridTemplateRows="100%",this._loadingDiv.style.gridTemplateColumns="100%",this._loadingDiv.style.justifyItems="center",this._loadingDiv.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText,this._style=document.createElement("style"),this._style.type="text/css";const e=`@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}
                    100% { -webkit-transform: rotate(360deg);}
                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}
                    100% { transform: rotate(360deg);}
                }`;this._style.innerHTML=e,document.getElementsByTagName("head")[0].appendChild(this._style);const t=!!window.SVGSVGElement,i=new Image;fo.DefaultLogoUrl?i.src=fo.DefaultLogoUrl:i.src=t?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",i.style.width="150px",i.style.gridColumn="1",i.style.gridRow="1",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.position="absolute";const r=document.createElement("div");r.style.width="300px",r.style.gridColumn="1",r.style.gridRow="1",r.style.top="50%",r.style.left="50%",r.style.transform="translate(-50%, -50%)",r.style.position="absolute";const s=new Image;if(fo.DefaultSpinnerUrl?s.src=fo.DefaultSpinnerUrl:s.src=t?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",s.style.animation="spin1 0.75s infinite linear",s.style.webkitAnimation="spin1 0.75s infinite linear",s.style.transformOrigin="50% 50%",s.style.webkitTransformOrigin="50% 50%",!t){const n={w:16,h:18.5},a={w:30,h:30};i.style.width=`${n.w}vh`,i.style.height=`${n.h}vh`,i.style.left=`calc(50% - ${n.w/2}vh)`,i.style.top=`calc(50% - ${n.h/2}vh)`,s.style.width=`${a.w}vh`,s.style.height=`${a.h}vh`,s.style.left=`calc(50% - ${a.w/2}vh)`,s.style.top=`calc(50% - ${a.h/2}vh)`}r.appendChild(s),this._loadingDiv.appendChild(i),this._loadingDiv.appendChild(r),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),this._loadingDiv.style.opacity="1"}hideLoadingUI(){if(!this._loadingDiv)return;const e=()=>{this._loadingTextDiv&&(this._loadingTextDiv.remove(),this._loadingTextDiv=null),this._loadingDiv&&(this._loadingDiv.remove(),this._loadingDiv=null),this._style&&(this._style.remove(),this._style=null),window.removeEventListener("resize",this._resizeLoadingUI)};this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",e)}set loadingUIText(e){this._loadingText=e,this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)}get loadingUIText(){return this._loadingText}get loadingUIBackgroundColor(){return this._loadingDivBackgroundColor}set loadingUIBackgroundColor(e){this._loadingDivBackgroundColor=e,this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)}}fo.DefaultLogoUrl="";fo.DefaultSpinnerUrl="";q.DefaultLoadingScreenFactory=o=>new fo(o);class Hl{static ConvertPanoramaToCubemap(e,t,i,r){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*i*3)throw"ConvertPanoramaToCubemap: input size is wrong";const s=this.CreateCubemapTexture(r,this.FACE_FRONT,e,t,i),n=this.CreateCubemapTexture(r,this.FACE_BACK,e,t,i),a=this.CreateCubemapTexture(r,this.FACE_LEFT,e,t,i),l=this.CreateCubemapTexture(r,this.FACE_RIGHT,e,t,i),c=this.CreateCubemapTexture(r,this.FACE_UP,e,t,i),h=this.CreateCubemapTexture(r,this.FACE_DOWN,e,t,i);return{front:s,back:n,left:a,right:l,up:c,down:h,size:r,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,t,i,r,s){const n=new ArrayBuffer(e*e*4*3),a=new Float32Array(n),l=t[1].subtract(t[0]).scale(1/e),c=t[3].subtract(t[2]).scale(1/e),h=1/e;let u=0;for(let d=0;d<e;d++){let f=t[0],_=t[2];for(let p=0;p<e;p++){const m=_.subtract(f).scale(u).add(f);m.normalize();const T=this.CalcProjectionSpherical(m,i,r,s);a[d*e*3+p*3+0]=T.r,a[d*e*3+p*3+1]=T.g,a[d*e*3+p*3+2]=T.b,f=f.add(l),_=_.add(c)}u+=h}return a}static CalcProjectionSpherical(e,t,i,r){let s=Math.atan2(e.z,e.x);const n=Math.acos(e.y);for(;s<-Math.PI;)s+=2*Math.PI;for(;s>Math.PI;)s-=2*Math.PI;let a=s/Math.PI;const l=n/Math.PI;a=a*.5+.5;let c=Math.round(a*i);c<0?c=0:c>=i&&(c=i-1);let h=Math.round(l*r);h<0?h=0:h>=r&&(h=r-1);const u=r-h-1,d=t[u*i*3+c*3+0],f=t[u*i*3+c*3+1],_=t[u*i*3+c*3+2];return{r:d,g:f,b:_}}}Hl.FACE_LEFT=[new x(-1,-1,-1),new x(1,-1,-1),new x(-1,1,-1),new x(1,1,-1)];Hl.FACE_RIGHT=[new x(1,-1,1),new x(-1,-1,1),new x(1,1,1),new x(-1,1,1)];Hl.FACE_FRONT=[new x(1,-1,-1),new x(1,-1,1),new x(1,1,-1),new x(1,1,1)];Hl.FACE_BACK=[new x(-1,-1,1),new x(-1,-1,-1),new x(-1,1,1),new x(-1,1,-1)];Hl.FACE_DOWN=[new x(1,1,-1),new x(1,1,1),new x(-1,1,-1),new x(-1,1,1)];Hl.FACE_UP=[new x(-1,-1,-1),new x(-1,-1,1),new x(1,-1,-1),new x(1,-1,1)];class J_{static _Ldexp(e,t){return t>1023?e*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?e*Math.pow(2,-1074)*Math.pow(2,t+1074):e*Math.pow(2,t)}static _Rgbe2float(e,t,i,r,s,n){s>0?(s=this._Ldexp(1,s-(128+8)),e[n+0]=t*s,e[n+1]=i*s,e[n+2]=r*s):(e[n+0]=0,e[n+1]=0,e[n+2]=0)}static _ReadStringLine(e,t){let i="",r="";for(let s=t;s<e.length-t&&(r=String.fromCharCode(e[s]),r!=`
`);s++)i+=r;return i}static RGBE_ReadHeader(e){let t=0,i=0,r=this._ReadStringLine(e,0);if(r[0]!="#"||r[1]!="?")throw"Bad HDR Format.";let s=!1,n=!1,a=0;do a+=r.length+1,r=this._ReadStringLine(e,a),r=="FORMAT=32-bit_rle_rgbe"?n=!0:r.length==0&&(s=!0);while(!s);if(!n)throw"HDR Bad header format, unsupported FORMAT";a+=r.length+1,r=this._ReadStringLine(e,a);const c=/^-Y (.*) \+X (.*)$/g.exec(r);if(!c||c.length<3)throw"HDR Bad header format, no size";if(i=parseInt(c[2]),t=parseInt(c[1]),i<8||i>32767)throw"HDR Bad header format, unsupported size";return a+=r.length+1,{height:t,width:i,dataPosition:a}}static GetCubeMapTextureData(e,t){const i=new Uint8Array(e),r=this.RGBE_ReadHeader(i),s=this.RGBE_ReadPixels(i,r);return Hl.ConvertPanoramaToCubemap(s,r.width,r.height,t)}static RGBE_ReadPixels(e,t){return this._RGBEReadPixelsRLE(e,t)}static _RGBEReadPixelsRLE(e,t){let i=t.height;const r=t.width;let s,n,a,l,c,h=t.dataPosition,u=0,d=0,f=0;const _=new ArrayBuffer(r*4),p=new Uint8Array(_),m=new ArrayBuffer(t.width*t.height*4*3),T=new Float32Array(m);for(;i>0;){if(s=e[h++],n=e[h++],a=e[h++],l=e[h++],s!=2||n!=2||a&128||t.width<8||t.width>32767)return this._RGBEReadPixelsNOTRLE(e,t);if((a<<8|l)!=r)throw"HDR Bad header format, wrong scan line width";for(u=0,f=0;f<4;f++)for(d=(f+1)*r;u<d;)if(s=e[h++],n=e[h++],s>128){if(c=s-128,c==0||c>d-u)throw"HDR Bad Format, bad scanline data (run)";for(;c-- >0;)p[u++]=n}else{if(c=s,c==0||c>d-u)throw"HDR Bad Format, bad scanline data (non-run)";if(p[u++]=n,--c>0)for(let b=0;b<c;b++)p[u++]=e[h++]}for(f=0;f<r;f++)s=p[f],n=p[f+r],a=p[f+2*r],l=p[f+3*r],this._Rgbe2float(T,s,n,a,l,(t.height-i)*r*3+f*3);i--}return T}static _RGBEReadPixelsNOTRLE(e,t){let i=t.height;const r=t.width;let s,n,a,l,c,h=t.dataPosition;const u=new ArrayBuffer(t.width*t.height*4*3),d=new Float32Array(u);for(;i>0;){for(c=0;c<t.width;c++)s=e[h++],n=e[h++],a=e[h++],l=e[h++],this._Rgbe2float(d,s,n,a,l,(t.height-i)*r*3+c*3);i--}return d}}const ID="hdrFilteringVertexShader",PD=`attribute vec2 position;
varying vec3 direction;
uniform vec3 up;
uniform vec3 right;
uniform vec3 front;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
mat3 view=mat3(up,right,front);
direction=view*vec3(position,1.0);
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;te.ShadersStore[ID]=PD;const MD="hdrFilteringPixelShader",OD=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform float alphaG;
uniform samplerCube inputTexture;
uniform vec2 vFilteringInfo;
uniform float hdrScale;
varying vec3 direction;
void main() {
vec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);
gl_FragColor=vec4(color*hdrScale,1.0);
}`;te.ShadersStore[MD]=OD;class DD{constructor(e,t={}){this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);const i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),this._engine.updateTextureSamplingMode(3,i.texture,!0),i}_prefilterInternal(e){const t=e.getSize().width,i=Ee.ILog2(t)+1,r=this._effectWrapper.effect,s=this._createRenderTarget(t);this._effectRenderer.setViewport();const n=e.getInternalTexture();n&&this._engine.updateTextureSamplingMode(3,n,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);const a=[[new x(0,0,-1),new x(0,-1,0),new x(1,0,0)],[new x(0,0,1),new x(0,-1,0),new x(-1,0,0)],[new x(1,0,0),new x(0,0,1),new x(0,1,0)],[new x(1,0,0),new x(0,0,-1),new x(0,-1,0)],[new x(1,0,0),new x(0,-1,0),new x(0,0,1)],[new x(-1,0,0),new x(0,-1,0),new x(0,0,-1)]];r.setFloat("hdrScale",this.hdrScale),r.setFloat2("vFilteringInfo",e.getSize().width,i),r.setTexture("inputTexture",e);for(let l=0;l<6;l++){r.setVector3("up",a[l][0]),r.setVector3("right",a[l][1]),r.setVector3("front",a[l][2]);for(let c=0;c<i;c++){this._engine.bindFramebuffer(s,l,void 0,void 0,!0,c),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let h=Math.pow(2,(c-this._lodGenerationOffset)/this._lodGenerationScale)/t;c===0&&(h=0),r.setFloat("alphaG",h),this._effectRenderer.draw()}}return this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(e._texture),s._swapAndDie(e._texture),e._prefiltered=!0,e}_createEffect(e,t){const i=[];return e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u"),new $o({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:i,onCompiled:t})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}prefilter(e,t=null){return this._engine._features.allowTexturePrefiltering?new Promise(i=>{this._effectRenderer=new Tf(this._engine),this._effectWrapper=this._createEffect(e),this._effectWrapper.effect.executeWhenCompiled(()=>{this._prefilterInternal(e),this._effectRenderer.dispose(),this._effectWrapper.dispose(),i(),t&&t()})}):(X.Warn("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."),Promise.reject("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."))}}class lc extends ni{set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(H.RotationY(this._rotationY))}get rotationY(){return this._rotationY}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}constructor(e,t,i,r=!1,s=!0,n=!1,a=!1,l=null,c=null){var h;super(t),this._generateHarmonics=!0,this._onError=null,this._isBlocking=!0,this._rotationY=0,this.boundingBoxPosition=x.Zero(),this.onLoadObservable=new Q,e&&(this._coordinatesMode=Y.CUBIC_MODE,this.name=e,this.url=e,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=H.Identity(),this._prefilterOnLoad=a,this._onLoad=()=>{this.onLoadObservable.notifyObservers(this),l&&l()},this._onError=c,this.gammaSpace=n,this._noMipmap=r,this._size=i,this._generateHarmonics=s,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?this._texture.isReady?J.SetImmediate(()=>this._onLoad()):this._texture.onLoadedObservable.add(this._onLoad):!((h=this.getScene())===null||h===void 0)&&h.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture())}getClassName(){return"HDRCubeTexture"}_loadTexture(){const e=this._getEngine(),t=e.getCaps();let i=0;t.textureFloat&&t.textureFloatLinearFiltering?i=1:t.textureHalfFloat&&t.textureHalfFloatLinearFiltering&&(i=2);const r=s=>{this.lodGenerationOffset=0,this.lodGenerationScale=.8;const n=J_.GetCubeMapTextureData(s,this._size);if(this._generateHarmonics){const h=Uf.ConvertCubeMapToSphericalPolynomial(n);this.sphericalPolynomial=h}const a=[];let l=null,c=null;for(let h=0;h<6;h++){i===2?c=new Uint16Array(this._size*this._size*3):i===0&&(l=new Uint8Array(this._size*this._size*3));const u=n[lc._FacesMapping[h]];if(this.gammaSpace||c||l){for(let d=0;d<this._size*this._size;d++)if(this.gammaSpace&&(u[d*3+0]=Math.pow(u[d*3+0],mo),u[d*3+1]=Math.pow(u[d*3+1],mo),u[d*3+2]=Math.pow(u[d*3+2],mo)),c&&(c[d*3+0]=lo(u[d*3+0]),c[d*3+1]=lo(u[d*3+1]),c[d*3+2]=lo(u[d*3+2])),l){let f=Math.max(u[d*3+0]*255,0),_=Math.max(u[d*3+1]*255,0),p=Math.max(u[d*3+2]*255,0);const m=Math.max(Math.max(f,_),p);if(m>255){const T=255/m;f*=T,_*=T,p*=T}l[d*3+0]=f,l[d*3+1]=_,l[d*3+2]=p}}c?a.push(c):l?a.push(l):a.push(u)}return a};if(e._features.allowTexturePrefiltering&&this._prefilterOnLoad){const s=this._onLoad,n=new DD(e);this._onLoad=()=>{n.prefilter(this,s)}}this._texture=e.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,i,this._noMipmap,r,null,this._onLoad,this._onError)}clone(){const e=new lc(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace);return e.level=this.level,e.wrapU=this.wrapU,e.wrapV=this.wrapV,e.coordinatesIndex=this.coordinatesIndex,e.coordinatesMode=this.coordinatesMode,e}delayLoad(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture())}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t;this._textureMatrix=e,e.updateFlag!==this._textureMatrix.updateFlag&&e.isIdentity()!==this._textureMatrix.isIdentity()&&((t=this.getScene())===null||t===void 0||t.markAllMaterialsAsDirty(1,i=>i.getActiveTextures().indexOf(this)!==-1))}dispose(){this.onLoadObservable.clear(),super.dispose()}static Parse(e,t,i){let r=null;return e.name&&!e.isRenderTarget&&(r=new lc(i+e.name,t,e.size,e.noMipmap,e.generateHarmonics,e.useInGammaSpace),r.name=e.name,r.hasAlpha=e.hasAlpha,r.level=e.level,r.coordinatesMode=e.coordinatesMode,r.isBlocking=e.isBlocking),r&&(e.boundingBoxPosition&&(r.boundingBoxPosition=x.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=x.FromArray(e.boundingBoxSize)),e.rotationY&&(r.rotationY=e.rotationY)),r}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.hasAlpha=this.hasAlpha,e.isCube=!0,e.level=this.level,e.size=this._size,e.coordinatesMode=this.coordinatesMode,e.useInGammaSpace=this.gammaSpace,e.generateHarmonics=this._generateHarmonics,e.customType="BABYLON.HDRCubeTexture",e.noMipmap=this._noMipmap,e.isBlocking=this._isBlocking,e.rotationY=this._rotationY,e}}lc._FacesMapping=["right","left","up","down","front","back"];ye("BABYLON.HDRCubeTexture",lc);class xo{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(t===0||e===0)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,i=null){this.name=e,this.animations=new Array,this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new Q,this._onDataLayoutChanged=new Q,this._animationPropertiesOverride=null,this._scene=i||qe.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}clone(){const e=ke.Clone(()=>new xo(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),ke.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const i=new xo(e.name,e.influence);if(i.setPositions(e.positions),e.id!=null&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.animations){for(let r=0;r<e.animations.length;r++){const s=e.animations[r],n=Xr("BABYLON.Animation");n&&i.animations.push(n.Parse(s))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);const r=new xo(t,i,e.getScene());return r.setPositions(e.getVerticesData(O.PositionKind)),e.isVerticesDataPresent(O.NormalKind)&&r.setNormals(e.getVerticesData(O.NormalKind)),e.isVerticesDataPresent(O.TangentKind)&&r.setTangents(e.getVerticesData(O.TangentKind)),e.isVerticesDataPresent(O.UVKind)&&r.setUVs(e.getVerticesData(O.UVKind)),r}}M([F()],xo.prototype,"id",void 0);class Bm extends Y{get depth(){return this._depth}constructor(e,t,i,r,s,n,a=!0,l=!1,c=Y.TRILINEAR_SAMPLINGMODE,h=0){super(null,n,!a,l),this.format=s,this._texture=n.getEngine().createRawTexture2DArray(e,t,i,r,s,a,l,c,null,h),this._depth=r,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,r,s,n=!0,a=!1,l=3,c=0){return new Bm(e,t,i,r,5,s,n,a,l,c)}}class _o{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new Lr(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._useTextureToStoreTargets=!0,e||(e=qe.LastCreatedScene),this._scene=e,this._scene){this._scene.morphTargetManagers.push(this),this._uniqueId=this._scene.getUniqueId();const t=this._scene.getEngine().getCaps();this._canUseTextureForTargets=t.canUseGLVertexID&&t.textureFloat&&t.maxVertexTextureImageUnits>0&&t.texture2DArrayMaxLayerCount>1}}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets=e}get isUsingTextureForTargets(){return _o.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add(t=>{this._syncActiveTargets(t)})),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add(()=>{this._syncActiveTargets(!0)})),this._syncActiveTargets(!0)}removeTarget(e){const t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._syncActiveTargets(!0))}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture)}clone(){const e=new _o(this._scene);for(const t of this._targets)e.addTarget(t.clone());return e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const t of this._targets)e.targets.push(t.serialize());return e}_syncActiveTargets(e){if(this.areUpdatesFrozen)return;let t=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,this._scene&&this._targets.length>this._scene.getEngine().getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1),(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let i=-1;for(const r of this._targets){if(i++,r.influence===0&&this.optimizeInfluencers)continue;if(this._activeTargets.length>=_o.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(r),this._morphTargetTextureIndices[t]=i,this._tempInfluences[t++]=r.influence,this._supportsNormals=this._supportsNormals&&r.hasNormals,this._supportsTangents=this._supportsTangents&&r.hasTangents,this._supportsUVs=this._supportsUVs&&r.hasUVs;const s=r.getPositions();if(s){const n=s.length/3;if(this._vertexCount===0)this._vertexCount=n;else if(this._vertexCount!==n){X.Error("Incompatible target. Targets must all have the same vertices count.");return}}}(!this._influences||this._influences.length!==t)&&(this._influences=new Float32Array(t));for(let r=0;r<t;r++)this._influences[r]=this._tempInfluences[r];e&&this.synchronize()}synchronize(){if(!(!this._scene||this.areUpdatesFrozen)){if(this.isUsingTextureForTargets&&this._vertexCount){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride,this._textureHeight=1;const e=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>e&&(this._textureHeight=Math.ceil(this._textureWidth/e),this._textureWidth=e);let t=!0;if(this._targetStoreTexture){const i=this._targetStoreTexture.getSize();i.width===this._textureWidth&&i.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(t=!1)}if(t){this._targetStoreTexture&&this._targetStoreTexture.dispose();const i=this._targets.length,r=new Float32Array(i*this._textureWidth*this._textureHeight*4);let s=0;for(let n=0;n<i;n++){const a=this._targets[n],l=a.getPositions(),c=a.getNormals(),h=a.getUVs(),u=a.getTangents();if(!l){n===0&&X.Error("Invalid morph target. Target must have positions.");return}s=n*this._textureWidth*this._textureHeight*4;for(let d=0;d<this._vertexCount;d++)r[s]=l[d*3],r[s+1]=l[d*3+1],r[s+2]=l[d*3+2],s+=4,c&&(r[s]=c[d*3],r[s+1]=c[d*3+1],r[s+2]=c[d*3+2],s+=4),h&&(r[s]=h[d*2],r[s+1]=h[d*2+1],s+=4),u&&(r[s]=u[d*3],r[s+1]=u[d*3+1],r[s+2]=u[d*3+2],s+=4)}this._targetStoreTexture=Bm.CreateRGBATexture(r,this._textureWidth,this._textureHeight,i,this._scene,!1,!1,1,1)}}for(const e of this._scene.meshes)e.morphTargetManager===this&&e._syncGeometryWithMorphTargetManager()}}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene&&(this._scene.removeMorphTargetManager(this),this._parentContainer)){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}}static Parse(e,t){const i=new _o(t);i._uniqueId=e.id;for(const r of e.targets)i.addTarget(xo.Parse(r,t));return i}}_o.EnableTextureStorage=!0;_o.MaxActiveMorphTargetsInVertexAttributeMode=8;class Xf{constructor(){this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=x.Zero(),this._hitPointWorld=x.Zero(),this._rayFromWorld=x.Zero(),this._rayToWorld=x.Zero()}get hasHit(){return this._hasHit}get hitDistance(){return this._hitDistance}get hitNormalWorld(){return this._hitNormalWorld}get hitPointWorld(){return this._hitPointWorld}get rayFromWorld(){return this._rayFromWorld}get rayToWorld(){return this._rayToWorld}setHitData(e,t){this._hasHit=!0,this._hitNormalWorld=new x(e.x,e.y,e.z),this._hitPointWorld=new x(t.x,t.y,t.z)}setHitDistance(e){this._hitDistance=e}calculateHitDistance(){this._hitDistance=x.Distance(this._rayFromWorld,this._hitPointWorld)}reset(e=x.Zero(),t=x.Zero()){this._rayFromWorld=e,this._rayToWorld=t,this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=x.Zero(),this._hitPointWorld=x.Zero()}}let mE=class gE{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw pt("CannonJSPlugin")}constructor(e,t=gE.DefaultPluginFactory()){if(this._physicsPlugin=t,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new x(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._impostors.forEach(function(e){e.dispose()}),this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}addImpostor(e){this._impostors.push(e),e.uniqueId=this._uniqueIdCounter++,e.parent||this._physicsPlugin.generatePhysicsBody(e)}removeImpostor(e){const t=this._impostors.indexOf(e);t>-1&&this._impostors.splice(t,1).length&&this.getPhysicsPlugin().removePhysicsBody(e)}addJoint(e,t,i){const r={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(r),this._physicsPlugin.generateJoint(r)}removeJoint(e,t,i){const r=this._joints.filter(function(s){return s.connectedImpostor===t&&s.joint===i&&s.mainImpostor===e});r.length&&this._physicsPlugin.removeJoint(r[0])}_step(e){this._impostors.forEach(t=>{t.isBodyInitRequired()&&this._physicsPlugin.generatePhysicsBody(t)}),e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)}getPhysicsPlugin(){return this._physicsPlugin}getImpostors(){return this._impostors}getImpostorForPhysicsObject(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null}getImpostorWithPhysicsBody(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null}raycast(e,t){return this._physicsPlugin.raycast(e,t)}raycastToRef(e,t,i){return this._physicsPlugin.raycastToRef(e,t,i)}};class ep{constructor(e=!0,t=10,i=CANNON){if(this._useDeltaForWorldStep=e,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=new Array,this._firstFrame=!0,this._tmpQuaternion=new oe,this._minus90X=new oe(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new oe(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=x.Zero(),this._tmpDeltaPosition=x.Zero(),this._tmpUnityRotation=new oe,this.BJSCANNON=i,!this.isSupported()){X.Error("CannonJS is not available. Please make sure you included the js file.");return}this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=t,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new Xf}getPluginVersion(){return 1}setGravity(e){const t=e;this.world.gravity.set(t.x,t.y,t.z)}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){if(this._firstFrame){this._firstFrame=!1;for(const i of t)i.type==ht.HeightmapImpostor||i.type===ht.PlaneImpostor||i.beforeStep()}this.world.step(this._useDeltaForWorldStep?e:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()}_removeMarkedPhysicsBodiesFromWorld(){this._physicsBodiesToRemoveAfterStep.length>0&&(this._physicsBodiesToRemoveAfterStep.forEach(e=>{typeof this.world.removeBody=="function"?this.world.removeBody(e):this.world.remove(e)}),this._physicsBodiesToRemoveAfterStep.length=0)}applyImpulse(e,t,i){const r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),s=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyImpulse(s,r)}applyForce(e,t,i){const r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),s=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyForce(s,r)}generatePhysicsBody(e){if(this._removeMarkedPhysicsBodiesFromWorld(),e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){const t=this._createShape(e);if(!t){X.Warn("It was not possible to create a physics body for this object.");return}const i=e.physicsBody;i&&this.removePhysicsBody(e);const r=this._addMaterial("mat-"+e.uniqueId,e.getParam("friction"),e.getParam("restitution")),s={mass:e.getParam("mass"),material:r},n=e.getParam("nativeOptions");for(const a in n)Object.prototype.hasOwnProperty.call(n,a)&&(s[a]=n[a]);e.physicsBody=new this.BJSCANNON.Body(s),e.physicsBody.addEventListener("collide",e.onCollide),this.world.addEventListener("preStep",e.beforeStep),this.world.addEventListener("postStep",e.afterStep),e.physicsBody.addShape(t),typeof this.world.addBody=="function"?this.world.addBody(e.physicsBody):this.world.add(e.physicsBody),i&&["force","torque","velocity","angularVelocity"].forEach(function(a){const l=i[a];e.physicsBody[a].set(l.x,l.y,l.z)}),this._processChildMeshes(e)}this._updatePhysicsBodyTransformation(e)}_processChildMeshes(e){const t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[],i=e.object.rotationQuaternion;if(i?i.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),t.length){const r=s=>{if(!s.rotationQuaternion)return;const n=s.getPhysicsImpostor();if(n&&n.parent!==e&&s.parent){const l=s.getAbsolutePosition().subtract(s.parent.getAbsolutePosition()),c=s.rotationQuaternion.multiply(this._tmpQuaternion);n.physicsBody&&(this.removePhysicsBody(n),n.physicsBody=null),n.parent=e,n.resetUpdateFlags(),e.physicsBody.addShape(this._createShape(n),new this.BJSCANNON.Vec3(l.x,l.y,l.z),new this.BJSCANNON.Quaternion(c.x,c.y,c.z,c.w)),e.physicsBody.mass+=n.getParam("mass")}s.getChildMeshes(!0).filter(a=>!!a.physicsImpostor).forEach(r)};t.filter(s=>!!s.physicsImpostor).forEach(r)}}removePhysicsBody(e){e.physicsBody.removeEventListener("collide",e.onCollide),this.world.removeEventListener("preStep",e.beforeStep),this.world.removeEventListener("postStep",e.afterStep),this._physicsBodiesToRemoveAfterStep.indexOf(e.physicsBody)===-1&&this._physicsBodiesToRemoveAfterStep.push(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;let r;const s=e.joint.jointData,n={pivotA:s.mainPivot?new this.BJSCANNON.Vec3().set(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z):null,pivotB:s.connectedPivot?new this.BJSCANNON.Vec3().set(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z):null,axisA:s.mainAxis?new this.BJSCANNON.Vec3().set(s.mainAxis.x,s.mainAxis.y,s.mainAxis.z):null,axisB:s.connectedAxis?new this.BJSCANNON.Vec3().set(s.connectedAxis.x,s.connectedAxis.y,s.connectedAxis.z):null,maxForce:s.nativeParams.maxForce,collideConnected:!!s.collision};switch(e.joint.type){case Oi.HingeJoint:case Oi.Hinge2Joint:r=new this.BJSCANNON.HingeConstraint(t,i,n);break;case Oi.DistanceJoint:r=new this.BJSCANNON.DistanceConstraint(t,i,s.maxDistance||2);break;case Oi.SpringJoint:{const a=s;r=new this.BJSCANNON.Spring(t,i,{restLength:a.length,stiffness:a.stiffness,damping:a.damping,localAnchorA:n.pivotA,localAnchorB:n.pivotB});break}case Oi.LockJoint:r=new this.BJSCANNON.LockConstraint(t,i,n);break;case Oi.PointToPointJoint:case Oi.BallAndSocketJoint:default:r=new this.BJSCANNON.PointToPointConstraint(t,n.pivotA,i,n.pivotB,n.maxForce);break}r.collideConnected=!!s.collision,e.joint.physicsJoint=r,e.joint.type!==Oi.SpringJoint?this.world.addConstraint(r):(e.joint.jointData.forceApplicationCallback=e.joint.jointData.forceApplicationCallback||function(){r.applyForce()},e.mainImpostor.registerAfterPhysicsStep(e.joint.jointData.forceApplicationCallback))}removeJoint(e){e.joint.type!==Oi.SpringJoint?this.world.removeConstraint(e.joint.physicsJoint):e.mainImpostor.unregisterAfterPhysicsStep(e.joint.jointData.forceApplicationCallback)}_addMaterial(e,t,i){let r,s;for(r=0;r<this._physicsMaterials.length;r++)if(s=this._physicsMaterials[r],s.friction===t&&s.restitution===i)return s;const n=new this.BJSCANNON.Material(e);return n.friction=t,n.restitution=i,this._physicsMaterials.push(n),n}_checkWithEpsilon(e){return e<kt?kt:e}_createShape(e){const t=e.object;let i;const r=e.getObjectExtents();switch(e.type){case ht.SphereImpostor:{const s=r.x,n=r.y,a=r.z;i=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(s),this._checkWithEpsilon(n),this._checkWithEpsilon(a))/2);break}case ht.CylinderImpostor:{let s=e.getParam("nativeOptions");s||(s={});const n=s.radiusTop!==void 0?s.radiusTop:this._checkWithEpsilon(r.x)/2,a=s.radiusBottom!==void 0?s.radiusBottom:this._checkWithEpsilon(r.x)/2,l=s.height!==void 0?s.height:this._checkWithEpsilon(r.y),c=s.numSegments!==void 0?s.numSegments:16;i=new this.BJSCANNON.Cylinder(n,a,l,c);const h=new this.BJSCANNON.Quaternion;h.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);const u=new this.BJSCANNON.Vec3(0,0,0);i.transformAllPoints(u,h);break}case ht.BoxImpostor:{const s=r.scale(.5);i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(s.x),this._checkWithEpsilon(s.y),this._checkWithEpsilon(s.z)));break}case ht.PlaneImpostor:X.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),i=new this.BJSCANNON.Plane;break;case ht.MeshImpostor:{const s=t.getVerticesData?t.getVerticesData(O.PositionKind):[],n=t.getIndices?t.getIndices():[];if(!s){X.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");return}const a=t.position.clone(),l=t.rotation&&t.rotation.clone(),c=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace();const h=t.computeWorldMatrix(!0),u=new Array;let d;for(d=0;d<s.length;d+=3)x.TransformCoordinates(x.FromArray(s,d),h).toArray(u,d);X.Warn("MeshImpostor only collides against spheres."),i=new this.BJSCANNON.Trimesh(u,n),t.position.copyFrom(a),l&&t.rotation&&t.rotation.copyFrom(l),c&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(c);break}case ht.HeightmapImpostor:{const s=t.position.clone(),n=t.rotation&&t.rotation.clone(),a=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace(),t.rotationQuaternion&&t.rotationQuaternion.multiplyInPlace(this._minus90X),i=this._createHeightmap(t),t.position.copyFrom(s),n&&t.rotation&&t.rotation.copyFrom(n),a&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(a),t.computeWorldMatrix(!0);break}case ht.ParticleImpostor:i=new this.BJSCANNON.Particle;break;case ht.NoImpostor:i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0));break}return i}_createHeightmap(e,t){let i=e.getVerticesData(O.PositionKind);const r=e.computeWorldMatrix(!0),s=new Array;let n;for(n=0;n<i.length;n+=3)x.TransformCoordinates(x.FromArray(i,n),r).toArray(s,n);i=s;const a=new Array,l=t||~~(Math.sqrt(i.length/3)-1),c=e.getBoundingInfo(),h=Math.min(c.boundingBox.extendSizeWorld.x,c.boundingBox.extendSizeWorld.y),u=c.boundingBox.extendSizeWorld.z,d=h*2/l;for(let _=0;_<i.length;_=_+3){const p=Math.round(i[_+0]/d+l/2),m=Math.round((i[_+1]/d-l/2)*-1),T=-i[_+2]+u;a[p]||(a[p]=[]),a[p][m]||(a[p][m]=T),a[p][m]=Math.max(T,a[p][m])}for(let _=0;_<=l;++_){if(!a[_]){let p=1;for(;!a[(_+p)%l];)p++;a[_]=a[(_+p)%l].slice()}for(let p=0;p<=l;++p)if(!a[_][p]){let m=1,T;for(;T===void 0;)T=a[_][(p+m++)%l];a[_][p]=T}}const f=new this.BJSCANNON.Heightfield(a,{elementSize:d});return f.minY=u,f}_updatePhysicsBodyTransformation(e){const t=e.object;if(t.computeWorldMatrix&&t.computeWorldMatrix(!0),!t.getBoundingInfo())return;const i=e.getObjectCenter();this._tmpDeltaPosition.copyFrom(t.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(e.object.scaling),this._tmpPosition.copyFrom(i);let r=t.rotationQuaternion;if(r){if((e.type===ht.PlaneImpostor||e.type===ht.HeightmapImpostor)&&(r=r.multiply(this._minus90X),e.setDeltaRotation(this._plus90X)),e.type===ht.HeightmapImpostor){const s=t;let n=s.getBoundingInfo();const a=s.rotationQuaternion;s.rotationQuaternion=this._tmpUnityRotation,s.computeWorldMatrix(!0);const l=i.clone();let c=s.getPivotMatrix();c?c=c.clone():c=H.Identity();const h=H.Translation(n.boundingBox.extendSizeWorld.x,0,-n.boundingBox.extendSizeWorld.z);s.setPreTransformMatrix(h),s.computeWorldMatrix(!0),n=s.getBoundingInfo();const u=n.boundingBox.centerWorld.subtract(i).subtract(s.position).negate();this._tmpPosition.copyFromFloats(u.x,u.y-n.boundingBox.extendSizeWorld.y,u.z),this._tmpDeltaPosition.copyFrom(n.boundingBox.centerWorld.subtract(l)),this._tmpDeltaPosition.y+=n.boundingBox.extendSizeWorld.y,s.rotationQuaternion=a,s.setPreTransformMatrix(c),s.computeWorldMatrix(!0)}else e.type===ht.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpDeltaPosition),e.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),e.physicsBody.quaternion.set(r.x,r.y,r.z,r.w)}}setTransformationFromPhysicsBody(e){if(e.object.position.set(e.physicsBody.position.x,e.physicsBody.position.y,e.physicsBody.position.z),e.object.rotationQuaternion){const t=e.physicsBody.quaternion;e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}setPhysicsBodyTransformation(e,t,i){e.physicsBody.position.set(t.x,t.y,t.z),e.physicsBody.quaternion.set(i.x,i.y,i.z,i.w)}isSupported(){return this.BJSCANNON!==void 0}setLinearVelocity(e,t){e.physicsBody.velocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.velocity;return t?new x(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new x(t.x,t.y,t.z):null}setBodyMass(e,t){e.physicsBody.mass=t,e.physicsBody.updateMassProperties()}getBodyMass(e){return e.physicsBody.mass}getBodyFriction(e){return e.physicsBody.material.friction}setBodyFriction(e,t){e.physicsBody.material.friction=t}getBodyRestitution(e){return e.physicsBody.material.restitution}setBodyRestitution(e,t){e.physicsBody.material.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.wakeUp()}updateDistanceJoint(e,t){e.physicsJoint.distance=t}setMotor(e,t,i,r){r||(e.physicsJoint.enableMotor(),e.physicsJoint.setMotorSpeed(t),i&&this.setLimit(e,i))}setLimit(e,t,i){e.physicsJoint.motorEquation.maxForce=i,e.physicsJoint.motorEquation.minForce=t===void 0?-t:t}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.quaternion.x,e.rotationQuaternion.y=i.quaternion.y,e.rotationQuaternion.z=i.quaternion.z,e.rotationQuaternion.w=i.quaternion.w)}getRadius(e){return e.physicsBody.shapes[0].boundingSphereRadius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes[0];t.x=i.halfExtents.x*2,t.y=i.halfExtents.y*2,t.z=i.halfExtents.z*2}dispose(){}_extendNamespace(){const e=new this.BJSCANNON.Vec3,t=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,r,s){if(s=s||10,r=r||0,r===0)this.internalStep(i),this.time+=i;else{let n=Math.floor((this.time+r)/i)-Math.floor(this.time/i);n=Math.min(n,s)||1;const a=performance.now();for(let d=0;d!==n&&(this.internalStep(i),!(performance.now()-a>i*1e3));d++);this.time+=r;const c=this.time%i/i,h=e,u=this.bodies;for(let d=0;d!==u.length;d++){const f=u[d];f.type!==t.Body.STATIC&&f.sleepState!==t.Body.SLEEPING?(f.position.vsub(f.previousPosition,h),h.scale(c,h),f.position.vadd(h,f.interpolatedPosition)):(f.interpolatedPosition.set(f.position.x,f.position.y,f.position.z),f.interpolatedQuaternion.set(f.quaternion.x,f.quaternion.y,f.quaternion.z,f.quaternion.w))}}}}raycast(e,t){return this._raycastResult.reset(e,t),this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._cannonRaycastResult.reset(),this.world.raycastClosest(e,t,{},this._cannonRaycastResult),i.reset(e,t),this._cannonRaycastResult.hasHit&&(i.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),i.setHitDistance(this._cannonRaycastResult.distance))}}mE.DefaultPluginFactory=()=>new ep;class hx{constructor(e=!0,t,i=OIMO){this._useDeltaForWorldStep=e,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=x.Zero(),this.BJSOIMO=i,this.world=new this.BJSOIMO.World({iterations:t}),this.world.clear(),this._raycastResult=new Xf}getPluginVersion(){return 1}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this.world.timeStep=e}getTimeStep(){return this.world.timeStep}executeStep(e,t){t.forEach(function(r){r.beforeStep()}),this.world.timeStep=this._useDeltaForWorldStep?e:this._fixedTimeStep,this.world.step(),t.forEach(r=>{r.afterStep(),this._tmpImpostorsArray[r.uniqueId]=r});let i=this.world.contacts;for(;i!==null;){if(i.touching&&!i.body1.sleeping&&!i.body2.sleeping){i=i.next;continue}const r=this._tmpImpostorsArray[+i.body1.name],s=this._tmpImpostorsArray[+i.body2.name];if(!r||!s){i=i.next;continue}r.onCollide({body:s.physicsBody,point:null,distance:0,impulse:0,normal:null}),s.onCollide({body:r.physicsBody,point:null,distance:0,impulse:0,normal:null}),i=i.next}}applyImpulse(e,t,i){const r=e.physicsBody.mass;e.physicsBody.applyImpulse(i.scale(this.world.invScale),t.scale(this.world.invScale*r))}applyForce(e,t,i){X.Warn("Oimo doesn't support applying force. Using impulse instead."),this.applyImpulse(e,t,i)}generatePhysicsBody(e){if(e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){const t={name:e.uniqueId,config:[e.getParam("mass")||.001,e.getParam("friction"),e.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:e.getParam("mass")!==0,density:e.getParam("mass"),friction:e.getParam("friction"),restitution:e.getParam("restitution"),world:this.world},i=[e];(a=>{a.getChildMeshes&&a.getChildMeshes().forEach(function(l){l.physicsImpostor&&i.push(l.physicsImpostor)})})(e.object);const s=a=>Math.max(a,kt),n=new oe;i.forEach(a=>{if(!a.object.rotationQuaternion)return;const l=a.object.rotationQuaternion;n.copyFrom(l),a.object.rotationQuaternion.set(0,0,0,1),a.object.computeWorldMatrix(!0);const c=n.toEulerAngles(),h=a.getObjectExtents(),u=57.29577951308232;if(a===e){const d=e.getObjectCenter();e.object.getAbsolutePivotPoint().subtractToRef(d,this._tmpPositionVector),this._tmpPositionVector.divideInPlace(e.object.scaling),t.pos.push(d.x),t.pos.push(d.y),t.pos.push(d.z),t.posShape.push(0,0,0),t.rotShape.push(0,0,0)}else{const d=a.object.position.clone();t.posShape.push(d.x),t.posShape.push(d.y),t.posShape.push(d.z),t.rotShape.push(c.x*u,c.y*u,c.z*u)}switch(a.object.rotationQuaternion.copyFrom(n),a.type){case ht.ParticleImpostor:X.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case ht.SphereImpostor:{const d=h.x,f=h.y,_=h.z,p=Math.max(s(d),s(f),s(_))/2;t.type.push("sphere"),t.size.push(p),t.size.push(p),t.size.push(p);break}case ht.CylinderImpostor:{const d=s(h.x)/2,f=s(h.y);t.type.push("cylinder"),t.size.push(d),t.size.push(f),t.size.push(f);break}case ht.PlaneImpostor:case ht.BoxImpostor:default:{const d=s(h.x),f=s(h.y),_=s(h.z);t.type.push("box"),t.size.push(d),t.size.push(f),t.size.push(_);break}}a.object.rotationQuaternion=l}),e.physicsBody=this.world.add(t),e.physicsBody.resetQuaternion(n),e.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpPositionVector)}removePhysicsBody(e){this.world.removeRigidBody(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;const r=e.joint.jointData,s=r.nativeParams||{};let n;const a={body1:t,body2:i,axe1:s.axe1||(r.mainAxis?r.mainAxis.asArray():null),axe2:s.axe2||(r.connectedAxis?r.connectedAxis.asArray():null),pos1:s.pos1||(r.mainPivot?r.mainPivot.asArray():null),pos2:s.pos2||(r.connectedPivot?r.connectedPivot.asArray():null),min:s.min,max:s.max,collision:s.collision||r.collision,spring:s.spring,world:this.world};switch(e.joint.type){case Oi.BallAndSocketJoint:n="jointBall";break;case Oi.SpringJoint:{X.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");const l=r;a.min=l.length||a.min,a.max=Math.max(a.min,a.max)}case Oi.DistanceJoint:n="jointDistance",a.max=r.maxDistance;break;case Oi.PrismaticJoint:n="jointPrisme";break;case Oi.SliderJoint:n="jointSlide";break;case Oi.WheelJoint:n="jointWheel";break;case Oi.HingeJoint:default:n="jointHinge";break}a.type=n,e.joint.physicsJoint=this.world.add(a)}removeJoint(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(t){X.Warn(t)}}isSupported(){return this.BJSOIMO!==void 0}setTransformationFromPhysicsBody(e){if(!e.physicsBody.sleeping){if(e.physicsBody.shapes.next){let t=e.physicsBody.shapes;for(;t.next;)t=t.next;e.object.position.set(t.position.x,t.position.y,t.position.z)}else{const t=e.physicsBody.getPosition();e.object.position.set(t.x,t.y,t.z)}if(e.object.rotationQuaternion){const t=e.physicsBody.getQuaternion();e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}}setPhysicsBodyTransformation(e,t,i){const r=e.physicsBody;e.physicsBody.shapes.next||(r.position.set(t.x,t.y,t.z),r.orientation.set(i.x,i.y,i.z,i.w),r.syncShapes(),r.awake())}setLinearVelocity(e,t){e.physicsBody.linearVelocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.linearVelocity;return t?new x(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new x(t.x,t.y,t.z):null}setBodyMass(e,t){const i=t===0;e.physicsBody.shapes.density=i?1:t,e.physicsBody.setupMass(i?2:1)}getBodyMass(e){return e.physicsBody.shapes.density}getBodyFriction(e){return e.physicsBody.shapes.friction}setBodyFriction(e,t){e.physicsBody.shapes.friction=t}getBodyRestitution(e){return e.physicsBody.shapes.restitution}setBodyRestitution(e,t){e.physicsBody.shapes.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.awake()}updateDistanceJoint(e,t,i){e.physicsJoint.limitMotor.upperLimit=t,i!==void 0&&(e.physicsJoint.limitMotor.lowerLimit=i)}setMotor(e,t,i,r){i!==void 0?X.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):i=1e6,t*=-1;const s=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;s&&s.setMotor(t,i)}setLimit(e,t,i,r){const s=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;s&&s.setLimit(t,i===void 0?-t:i)}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.orientation.x,e.rotationQuaternion.y=i.orientation.y,e.rotationQuaternion.z=i.orientation.z,e.rotationQuaternion.w=i.orientation.w)}getRadius(e){return e.physicsBody.shapes.radius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes;t.x=i.halfWidth*2,t.y=i.halfHeight*2,t.z=i.halfDepth*2}dispose(){this.world.clear()}raycast(e,t){return X.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(e,t),this._raycastResult}raycastToRef(e,t,i){X.Warn("raycast is not currently supported by the Oimo physics plugin"),i.reset(e,t)}}class po{constructor(e=!0,t=Ammo,i=null){if(this._useDeltaForWorldStep=e,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new oe,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new x,this._tmpContactNormal=new x,this._tmpVec3=new x,this._tmpMatrix=new H,typeof t=="function"){X.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.");return}else this.bjsAMMO=t;if(!this.isSupported()){X.Error("AmmoJS is not available. Please make sure you included the js file.");return}this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=i||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=r=>{r=this.bjsAMMO.wrapPointer(r,this.bjsAMMO.btManifoldPoint);const s=r.getPositionWorldOnA(),n=r.m_normalWorldOnB;this._tmpContactPoint.x=s.x(),this._tmpContactPoint.y=s.y(),this._tmpContactPoint.z=s.z(),this._tmpContactNormal.x=n.x(),this._tmpContactNormal.y=n.y(),this._tmpContactNormal.z=n.z(),this._tmpContactImpulse=r.getAppliedImpulse(),this._tmpContactDistance=r.getDistance(),this._tmpContactCallbackResult=!0},this._raycastResult=new Xf,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)}getPluginVersion(){return 1}setGravity(e){this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)}setTimeStep(e){this._timeStep=e}setFixedTimeStep(e){this._fixedTimeStep=e}setMaxSteps(e){this._maxSteps=e}getTimeStep(){return this._timeStep}_isImpostorInContact(e){return this._tmpContactCallbackResult=!1,this.world.contactTest(e.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_isImpostorPairInContact(e,t){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(e.physicsBody,t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_stepSimulation(e=1/60,t=10,i=1/60){if(t==0)this.world.stepSimulation(e,0);else for(;t>0&&e>0;)e-i<i?(this.world.stepSimulation(e,0),e=0):(e-=i,this.world.stepSimulation(i,0)),t--}executeStep(e,t){for(const i of t)i.soft||i.beforeStep();this._stepSimulation(this._useDeltaForWorldStep?e:this._timeStep,this._maxSteps,this._fixedTimeStep);for(const i of t)if(i.soft?this._afterSoftStep(i):i.afterStep(),i._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(i))for(const r of i._onPhysicsCollideCallbacks)for(const s of r.otherImpostors)(i.physicsBody.isActive()||s.physicsBody.isActive())&&this._isImpostorPairInContact(i,s)&&(i.onCollide({body:s.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}),s.onCollide({body:i.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}))}_afterSoftStep(e){e.type===ht.RopeImpostor?this._ropeStep(e):this._softbodyOrClothStep(e)}_ropeStep(e){const t=e.physicsBody.get_m_nodes(),i=t.size();let r,s,n,a,l;const c=new Array;for(let d=0;d<i;d++)r=t.at(d),s=r.get_m_x(),n=s.x(),a=s.y(),l=s.z(),c.push(new x(n,a,l));const h=e.object,u=e.getParam("shape");e._isFromLine?e.object=Sm("lines",{points:c,instance:h}):e.object=JT("ext",{shape:u,path:c,instance:h})}_softbodyOrClothStep(e){const t=e.type===ht.ClothImpostor?1:-1,i=e.object;let r=i.getVerticesData(O.PositionKind);r||(r=[]);let s=i.getVerticesData(O.NormalKind);s||(s=[]);const n=r.length/3,a=e.physicsBody.get_m_nodes();let l,c,h,u,d,f,_,p;for(let T=0;T<n;T++){l=a.at(T),c=l.get_m_x(),h=c.x(),u=c.y(),d=c.z()*t;const b=l.get_m_n();f=b.x(),_=b.y(),p=b.z()*t,r[3*T]=h,r[3*T+1]=u,r[3*T+2]=d,s[3*T]=f,s[3*T+1]=_,s[3*T+2]=p}const m=new Oe;m.positions=r,m.normals=s,m.uvs=i.getVerticesData(O.UVKind),m.colors=i.getVerticesData(O.ColorKind),i&&i.getIndices&&(m.indices=i.getIndices()),m.applyToMesh(i)}applyImpulse(e,t,i){if(e.soft)X.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();const r=this._tmpAmmoVectorA,s=this._tmpAmmoVectorB;e.object&&e.object.getWorldMatrix&&i.subtractInPlace(e.object.getWorldMatrix().getTranslation()),r.setValue(i.x,i.y,i.z),s.setValue(t.x,t.y,t.z),e.physicsBody.applyImpulse(s,r)}}applyForce(e,t,i){if(e.soft)X.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();const r=this._tmpAmmoVectorA,s=this._tmpAmmoVectorB;if(e.object&&e.object.getWorldMatrix){const n=e.object.getWorldMatrix().getTranslation();r.setValue(i.x-n.x,i.y-n.y,i.z-n.z)}else r.setValue(i.x,i.y,i.z);s.setValue(t.x,t.y,t.z),e.physicsBody.applyForce(s,r)}}generatePhysicsBody(e){if(e._pluginData.toDispose=[],e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){const t=this._createShape(e),i=e.getParam("mass");if(e._pluginData.mass=i,e.soft)t.get_m_cfg().set_collisions(17),t.get_m_cfg().set_kDP(e.getParam("damping")),this.bjsAMMO.castObject(t,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(e.getParam("margin")),t.setActivationState(po._DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(t,1,-1),e.physicsBody=t,e._pluginData.toDispose.push(t),this.setBodyPressure(e,0),e.type===ht.SoftbodyImpostor&&this.setBodyPressure(e,e.getParam("pressure")),this.setBodyStiffness(e,e.getParam("stiffness")),this.setBodyVelocityIterations(e,e.getParam("velocityIterations")),this.setBodyPositionIterations(e,e.getParam("positionIterations"));else{const r=new this.bjsAMMO.btVector3(0,0,0),s=new this.bjsAMMO.btTransform;e.object.computeWorldMatrix(!0),s.setIdentity(),i!==0&&t.calculateLocalInertia(i,r),this._tmpAmmoVectorA.setValue(e.object.position.x,e.object.position.y,e.object.position.z),this._tmpAmmoQuaternion.setValue(e.object.rotationQuaternion.x,e.object.rotationQuaternion.y,e.object.rotationQuaternion.z,e.object.rotationQuaternion.w),s.setOrigin(this._tmpAmmoVectorA),s.setRotation(this._tmpAmmoQuaternion);const n=new this.bjsAMMO.btDefaultMotionState(s),a=new this.bjsAMMO.btRigidBodyConstructionInfo(i,n,t,r),l=new this.bjsAMMO.btRigidBody(a);if(i===0&&(l.setCollisionFlags(l.getCollisionFlags()|po._KINEMATIC_FLAG),l.setActivationState(po._DISABLE_DEACTIVATION_FLAG)),e.type==ht.NoImpostor&&!t.getChildShape&&l.setCollisionFlags(l.getCollisionFlags()|po._DISABLE_COLLISION_FLAG),e.type!==ht.MeshImpostor&&e.type!==ht.NoImpostor){const u=e.object.getBoundingInfo();this._tmpVec3.copyFrom(e.object.getAbsolutePosition()),this._tmpVec3.subtractInPlace(u.boundingBox.centerWorld),this._tmpVec3.x/=e.object.scaling.x,this._tmpVec3.y/=e.object.scaling.y,this._tmpVec3.z/=e.object.scaling.z,e.setDeltaPosition(this._tmpVec3)}const c=e.getParam("group"),h=e.getParam("mask");c&&h?this.world.addRigidBody(l,c,h):this.world.addRigidBody(l),e.physicsBody=l,e._pluginData.toDispose=e._pluginData.toDispose.concat([l,a,n,s,r,t])}this.setBodyRestitution(e,e.getParam("restitution")),this.setBodyFriction(e,e.getParam("friction"))}}removePhysicsBody(e){this.world&&(e.soft?this.world.removeSoftBody(e.physicsBody):this.world.removeRigidBody(e.physicsBody),e._pluginData&&(e._pluginData.toDispose.forEach(t=>{this.bjsAMMO.destroy(t)}),e._pluginData.toDispose=[]))}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;const r=e.joint.jointData;r.mainPivot||(r.mainPivot=new x(0,0,0)),r.connectedPivot||(r.connectedPivot=new x(0,0,0));let s;switch(e.joint.type){case Oi.DistanceJoint:{const n=r.maxDistance;n&&(r.mainPivot=new x(0,-n/2,0),r.connectedPivot=new x(0,n/2,0)),s=new this.bjsAMMO.btPoint2PointConstraint(t,i,new this.bjsAMMO.btVector3(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z),new this.bjsAMMO.btVector3(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z));break}case Oi.HingeJoint:{r.mainAxis||(r.mainAxis=new x(0,0,0)),r.connectedAxis||(r.connectedAxis=new x(0,0,0));const n=new this.bjsAMMO.btVector3(r.mainAxis.x,r.mainAxis.y,r.mainAxis.z),a=new this.bjsAMMO.btVector3(r.connectedAxis.x,r.connectedAxis.y,r.connectedAxis.z);s=new this.bjsAMMO.btHingeConstraint(t,i,new this.bjsAMMO.btVector3(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z),new this.bjsAMMO.btVector3(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z),n,a);break}case Oi.BallAndSocketJoint:s=new this.bjsAMMO.btPoint2PointConstraint(t,i,new this.bjsAMMO.btVector3(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z),new this.bjsAMMO.btVector3(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z));break;default:X.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint"),s=new this.bjsAMMO.btPoint2PointConstraint(t,i,new this.bjsAMMO.btVector3(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z),new this.bjsAMMO.btVector3(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z));break}this.world.addConstraint(s,!e.joint.jointData.collision),e.joint.physicsJoint=s}removeJoint(e){this.world&&this.world.removeConstraint(e.joint.physicsJoint)}_addMeshVerts(e,t,i){let r=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let s=i.getIndices();s||(s=[]);let n=i.getVerticesData(O.PositionKind);n||(n=[]);let a;if(t&&t!==i){let c;t.rotationQuaternion?c=t.rotationQuaternion:t.rotation?c=oe.FromEulerAngles(t.rotation.x,t.rotation.y,t.rotation.z):c=oe.Identity(),H.Compose(x.One(),c,t.position).invertToRef(this._tmpMatrix),a=i.computeWorldMatrix(!1).multiply(this._tmpMatrix)}else H.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),a=this._tmpMatrix;const l=s.length/3;for(let c=0;c<l;c++){const h=[];for(let u=0;u<3;u++){let d=new x(n[s[c*3+u]*3+0],n[s[c*3+u]*3+1],n[s[c*3+u]*3+2]);d=x.TransformCoordinates(d,a);let f;u==0?f=this._tmpAmmoVectorA:u==1?f=this._tmpAmmoVectorB:f=this._tmpAmmoVectorC,f.setValue(d.x,d.y,d.z),h.push(f)}e.addTriangle(h[0],h[1],h[2]),r++}i.getChildMeshes().forEach(c=>{r+=this._addMeshVerts(e,t,c)})}return r}_softVertexData(e){const t=e.object;if(t&&t.getIndices&&t.getWorldMatrix&&t.getChildMeshes){t.getIndices();let i=t.getVerticesData(O.PositionKind);i||(i=[]);let r=t.getVerticesData(O.NormalKind);r||(r=[]),t.computeWorldMatrix(!1);const s=[],n=[];for(let l=0;l<i.length;l+=3){let c=new x(i[l],i[l+1],i[l+2]),h=new x(r[l],r[l+1],r[l+2]);c=x.TransformCoordinates(c,t.getWorldMatrix()),h=x.TransformNormal(h,t.getWorldMatrix()),s.push(c.x,c.y,c.z),n.push(h.x,h.y,h.z)}const a=new Oe;return a.positions=s,a.normals=n,a.uvs=t.getVerticesData(O.UVKind),a.colors=t.getVerticesData(O.ColorKind),t&&t.getIndices&&(a.indices=t.getIndices()),a.applyToMesh(t),t.position=x.Zero(),t.rotationQuaternion=null,t.rotation=x.Zero(),t.computeWorldMatrix(!0),a}return Oe.ExtractFromMesh(t)}_createSoftbody(e){const t=e.object;if(t&&t.getIndices){let i=t.getIndices();i||(i=[]);const r=this._softVertexData(e),s=r.positions,n=r.normals;if(s===null||n===null)return new this.bjsAMMO.btCompoundShape;{const a=[],l=[];for(let _=0;_<s.length;_+=3){const p=new x(s[_],s[_+1],s[_+2]),m=new x(n[_],n[_+1],n[_+2]);a.push(p.x,p.y,-p.z),l.push(m.x,m.y,-m.z)}const c=new this.bjsAMMO.btSoftBodyHelpers().CreateFromTriMesh(this.world.getWorldInfo(),a,t.getIndices(),i.length/3,!0),h=s.length/3,u=c.get_m_nodes();let d,f;for(let _=0;_<h;_++)d=u.at(_),f=d.get_m_n(),f.setX(l[3*_]),f.setY(l[3*_+1]),f.setZ(l[3*_+2]);return c}}}_createCloth(e){const t=e.object;if(t&&t.getIndices){t.getIndices();const i=this._softVertexData(e),r=i.positions,s=i.normals;if(r===null||s===null)return new this.bjsAMMO.btCompoundShape;{const n=r.length,a=Math.sqrt(n/3);e.segments=a;const l=a-1;return this._tmpAmmoVectorA.setValue(r[0],r[1],r[2]),this._tmpAmmoVectorB.setValue(r[3*l],r[3*l+1],r[3*l+2]),this._tmpAmmoVectorD.setValue(r[n-3],r[n-2],r[n-1]),this._tmpAmmoVectorC.setValue(r[n-3-3*l],r[n-2-3*l],r[n-1-3*l]),new this.bjsAMMO.btSoftBodyHelpers().CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,a,a,e.getParam("fixedPoints"),!0)}}}_createRope(e){let t,i;const r=this._softVertexData(e),s=r.positions,n=r.normals;if(s===null||n===null)return new this.bjsAMMO.btCompoundShape;r.applyToMesh(e.object,!0),e._isFromLine=!0;const a=n.map(d=>d*d),l=(d,f)=>d+f;if(a.reduce(l)===0)t=s.length,i=t/3-1,this._tmpAmmoVectorA.setValue(s[0],s[1],s[2]),this._tmpAmmoVectorB.setValue(s[t-3],s[t-2],s[t-1]);else{e._isFromLine=!1;const d=e.getParam("path");if(e.getParam("shape")===null)return X.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;t=d.length,i=t-1,this._tmpAmmoVectorA.setValue(d[0].x,d[0].y,d[0].z),this._tmpAmmoVectorB.setValue(d[t-1].x,d[t-1].y,d[t-1].z)}e.segments=i;let h=e.getParam("fixedPoints");h=h>3?3:h;const u=new this.bjsAMMO.btSoftBodyHelpers().CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,i-1,h);return u.get_m_cfg().set_collisions(17),u}_createCustom(e){let t=null;return this.onCreateCustomShape&&(t=this.onCreateCustomShape(e)),t==null&&(t=new this.bjsAMMO.btCompoundShape),t}_addHullVerts(e,t,i){let r=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let s=i.getIndices();s||(s=[]);let n=i.getVerticesData(O.PositionKind);n||(n=[]),i.computeWorldMatrix(!1);const a=s.length/3;for(let l=0;l<a;l++){const c=[];for(let h=0;h<3;h++){let u=new x(n[s[l*3+h]*3+0],n[s[l*3+h]*3+1],n[s[l*3+h]*3+2]);H.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),u=x.TransformCoordinates(u,this._tmpMatrix);let d;h==0?d=this._tmpAmmoVectorA:h==1?d=this._tmpAmmoVectorB:d=this._tmpAmmoVectorC,d.setValue(u.x,u.y,u.z),c.push(d)}e.addPoint(c[0],!0),e.addPoint(c[1],!0),e.addPoint(c[2],!0),r++}i.getChildMeshes().forEach(l=>{r+=this._addHullVerts(e,t,l)})}return r}_createShape(e,t=!1){const i=e.object;let r;const s=e.getObjectExtents();if(!t){const n=e.object.getChildMeshes?e.object.getChildMeshes(!0):[];r=new this.bjsAMMO.btCompoundShape;let a=0;if(n.forEach(l=>{const c=l.getPhysicsImpostor();if(c){if(c.type==ht.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";const h=this._createShape(c),u=l.parent.getWorldMatrix().clone(),d=new x;u.decompose(d),this._tmpAmmoTransform.getOrigin().setValue(l.position.x*d.x,l.position.y*d.y,l.position.z*d.z),this._tmpAmmoQuaternion.setValue(l.rotationQuaternion.x,l.rotationQuaternion.y,l.rotationQuaternion.z,l.rotationQuaternion.w),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),r.addChildShape(this._tmpAmmoTransform,h),c.dispose(),a++}}),a>0){if(e.type!=ht.NoImpostor){const l=this._createShape(e,!0);l&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),r.addChildShape(this._tmpAmmoTransform,l))}return r}else this.bjsAMMO.destroy(r),r=null}switch(e.type){case ht.SphereImpostor:if(Ee.WithinEpsilon(s.x,s.y,1e-4)&&Ee.WithinEpsilon(s.x,s.z,1e-4))r=new this.bjsAMMO.btSphereShape(s.x/2);else{const n=[new this.bjsAMMO.btVector3(0,0,0)],a=[1];r=new this.bjsAMMO.btMultiSphereShape(n,a,1),r.setLocalScaling(new this.bjsAMMO.btVector3(s.x/2,s.y/2,s.z/2))}break;case ht.CapsuleImpostor:{const n=s.x/2;r=new this.bjsAMMO.btCapsuleShape(n,s.y-n*2)}break;case ht.CylinderImpostor:this._tmpAmmoVectorA.setValue(s.x/2,s.y/2,s.z/2),r=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case ht.PlaneImpostor:case ht.BoxImpostor:this._tmpAmmoVectorA.setValue(s.x/2,s.y/2,s.z/2),r=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case ht.MeshImpostor:if(e.getParam("mass")==0){if(this.onCreateCustomMeshImpostor)r=this.onCreateCustomMeshImpostor(e);else{const n=new this.bjsAMMO.btTriangleMesh;e._pluginData.toDispose.push(n),this._addMeshVerts(n,i,i)==0?r=new this.bjsAMMO.btCompoundShape:r=new this.bjsAMMO.btBvhTriangleMeshShape(n)}break}case ht.ConvexHullImpostor:{if(this.onCreateCustomConvexHullImpostor)r=this.onCreateCustomConvexHullImpostor(e);else{const n=new this.bjsAMMO.btConvexHullShape;this._addHullVerts(n,i,i)==0?(e._pluginData.toDispose.push(n),r=new this.bjsAMMO.btCompoundShape):r=n}break}case ht.NoImpostor:r=new this.bjsAMMO.btSphereShape(s.x/2);break;case ht.CustomImpostor:r=this._createCustom(e);break;case ht.SoftbodyImpostor:r=this._createSoftbody(e);break;case ht.ClothImpostor:r=this._createCloth(e);break;case ht.RopeImpostor:r=this._createRope(e);break;default:X.Warn("The impostor type is not currently supported by the ammo plugin.");break}return r}setTransformationFromPhysicsBody(e){e.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),e.object.rotationQuaternion?e.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):e.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(e.object.rotation))}setPhysicsBodyTransformation(e,t,i){const r=e.physicsBody.getWorldTransform();if(Math.abs(r.getOrigin().x()-t.x)>kt||Math.abs(r.getOrigin().y()-t.y)>kt||Math.abs(r.getOrigin().z()-t.z)>kt||Math.abs(r.getRotation().x()-i.x)>kt||Math.abs(r.getRotation().y()-i.y)>kt||Math.abs(r.getRotation().z()-i.z)>kt||Math.abs(r.getRotation().w()-i.w)>kt)if(this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),r.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(i.x,i.y,i.z,i.w),r.setRotation(this._tmpAmmoQuaternion),e.physicsBody.setWorldTransform(r),e.mass==0){const s=e.physicsBody.getMotionState();s&&s.setWorldTransform(r)}else e.physicsBody.activate()}isSupported(){return this.bjsAMMO!==void 0}setLinearVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.linearVelocity(this._tmpAmmoVectorA):e.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)}setAngularVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.angularVelocity(this._tmpAmmoVectorA):e.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)}getLinearVelocity(e){let t;if(e.soft?t=e.physicsBody.linearVelocity():t=e.physicsBody.getLinearVelocity(),!t)return null;const i=new x(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}getAngularVelocity(e){let t;if(e.soft?t=e.physicsBody.angularVelocity():t=e.physicsBody.getAngularVelocity(),!t)return null;const i=new x(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}setBodyMass(e,t){e.soft?e.physicsBody.setTotalMass(t,!1):e.physicsBody.setMassProps(t),e._pluginData.mass=t}getBodyMass(e){return e._pluginData.mass||0}getBodyFriction(e){return e._pluginData.friction||0}setBodyFriction(e,t){e.soft?e.physicsBody.get_m_cfg().set_kDF(t):e.physicsBody.setFriction(t),e._pluginData.friction=t}getBodyRestitution(e){return e._pluginData.restitution||0}setBodyRestitution(e,t){e.physicsBody.setRestitution(t),e._pluginData.restitution=t}getBodyPressure(e){return e.soft?e._pluginData.pressure||0:(X.Warn("Pressure is not a property of a rigid body"),0)}setBodyPressure(e,t){e.soft?e.type===ht.SoftbodyImpostor?(e.physicsBody.get_m_cfg().set_kPR(t),e._pluginData.pressure=t):(e.physicsBody.get_m_cfg().set_kPR(0),e._pluginData.pressure=0):X.Warn("Pressure can only be applied to a softbody")}getBodyStiffness(e){return e.soft?e._pluginData.stiffness||0:(X.Warn("Stiffness is not a property of a rigid body"),0)}setBodyStiffness(e,t){e.soft?(t=t<0?0:t,t=t>1?1:t,e.physicsBody.get_m_materials().at(0).set_m_kLST(t),e._pluginData.stiffness=t):X.Warn("Stiffness cannot be applied to a rigid body")}getBodyVelocityIterations(e){return e.soft?e._pluginData.velocityIterations||0:(X.Warn("Velocity iterations is not a property of a rigid body"),0)}setBodyVelocityIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_viterations(t),e._pluginData.velocityIterations=t):X.Warn("Velocity iterations cannot be applied to a rigid body")}getBodyPositionIterations(e){return e.soft?e._pluginData.positionIterations||0:(X.Warn("Position iterations is not a property of a rigid body"),0)}setBodyPositionIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_piterations(t),e._pluginData.positionIterations=t):X.Warn("Position iterations cannot be applied to a rigid body")}appendAnchor(e,t,i,r,s=1,n=!1){const a=e.segments,l=Math.round((a-1)*i),c=Math.round((a-1)*r),h=a-1-c,u=l+a*h;e.physicsBody.appendAnchor(u,t.physicsBody,n,s)}appendHook(e,t,i,r=1,s=!1){const n=Math.round(e.segments*i);e.physicsBody.appendAnchor(n,t.physicsBody,s,r)}sleepBody(e){e.physicsBody.forceActivationState(0)}wakeUpBody(e){e.physicsBody.activate()}updateDistanceJoint(){X.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")}setMotor(e,t,i){e.physicsJoint.enableAngularMotor(!0,t,i)}setLimit(){X.Warn("setLimit is not currently supported by the Ammo physics plugin")}syncMeshWithImpostor(e,t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.position.x=this._tmpAmmoTransform.getOrigin().x(),e.position.y=this._tmpAmmoTransform.getOrigin().y(),e.position.z=this._tmpAmmoTransform.getOrigin().z(),e.rotationQuaternion&&(e.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),e.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),e.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),e.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())}getRadius(e){return e.getObjectExtents().x/2}getBoxSizeToRef(e,t){const i=e.getObjectExtents();t.x=i.x,t.y=i.y,t.z=i.z}dispose(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null}raycast(e,t){return this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(e.x,e.y,e.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(t.x,t.y,t.z);const r=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,r),i.reset(e,t),r.hasHit()&&(i.setHitData({x:r.get_m_hitNormalWorld().x(),y:r.get_m_hitNormalWorld().y(),z:r.get_m_hitNormalWorld().z()},{x:r.get_m_hitPointWorld().x(),y:r.get_m_hitPointWorld().y(),z:r.get_m_hitPointWorld().z()}),i.calculateHitDistance()),this.bjsAMMO.destroy(r),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB)}}po._DISABLE_COLLISION_FLAG=4;po._KINEMATIC_FLAG=2;po._DISABLE_DEACTIVATION_FLAG=4;Er.prototype.removeReflectionProbe=function(o){if(!this.reflectionProbes)return-1;const e=this.reflectionProbes.indexOf(o);return e!==-1&&this.reflectionProbes.splice(e,1),e};Er.prototype.addReflectionProbe=function(o){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(o)};class Xu{constructor(e,t,i,r=!0,s=!1,n=!1){if(this.name=e,this._viewMatrix=H.Identity(),this._target=x.Zero(),this._add=x.Zero(),this._invertYAxis=!1,this.position=x.Zero(),this.metadata=null,this._parentContainer=null,this._scene=i,i.getEngine().supportsUniformBuffers){this._sceneUBOs=[];for(let h=0;h<6;++h)this._sceneUBOs.push(i.createSceneUniformBuffer(`Scene for Reflection Probe (name "${e}") face #${h}`))}this._scene.reflectionProbes||(this._scene.reflectionProbes=new Array),this._scene.reflectionProbes.push(this);let a=0;if(s){const h=this._scene.getEngine().getCaps();h.textureHalfFloatRender?a=2:h.textureFloatRender&&(a=1)}this._renderTargetTexture=new Zi(e,t,i,r,!0,a,!0),this._renderTargetTexture.gammaSpace=!n;const l=i.getEngine().useReverseDepthBuffer;this._renderTargetTexture.onBeforeRenderObservable.add(h=>{switch(this._sceneUBOs&&(i.setSceneUniformBuffer(this._sceneUBOs[h]),i.getSceneUniformBuffer().unbindEffect()),h){case 0:this._add.copyFromFloats(1,0,0);break;case 1:this._add.copyFromFloats(-1,0,0);break;case 2:this._add.copyFromFloats(0,this._invertYAxis?1:-1,0);break;case 3:this._add.copyFromFloats(0,this._invertYAxis?-1:1,0);break;case 4:this._add.copyFromFloats(0,0,i.useRightHandedSystem?-1:1);break;case 5:this._add.copyFromFloats(0,0,i.useRightHandedSystem?1:-1);break}this._attachedMesh&&this.position.copyFrom(this._attachedMesh.getAbsolutePosition()),this.position.addToRef(this._add,this._target);const u=i.useRightHandedSystem?H.LookAtRHToRef:H.LookAtLHToRef,d=i.useRightHandedSystem?H.PerspectiveFovRH:H.PerspectiveFovLH;u(this.position,this._target,x.Up(),this._viewMatrix),i.activeCamera&&(this._projectionMatrix=d(Math.PI/2,1,l?i.activeCamera.maxZ:i.activeCamera.minZ,l?i.activeCamera.minZ:i.activeCamera.maxZ,this._scene.getEngine().isNDCHalfZRange),i.setTransformMatrix(this._viewMatrix,this._projectionMatrix),i.activeCamera.isRigCamera&&!this._renderTargetTexture.activeCamera&&(this._renderTargetTexture.activeCamera=i.activeCamera.rigParent||null)),i._forcedViewPosition=this.position});let c;this._renderTargetTexture.onBeforeBindObservable.add(()=>{var h,u;this._currentSceneUBO=i.getSceneUniformBuffer(),(u=(h=i.getEngine())._debugPushGroup)===null||u===void 0||u.call(h,`reflection probe generation for ${e}`,1),c=this._scene.imageProcessingConfiguration.applyByPostProcess,n&&(i.imageProcessingConfiguration.applyByPostProcess=!0)}),this._renderTargetTexture.onAfterUnbindObservable.add(()=>{var h,u;i.imageProcessingConfiguration.applyByPostProcess=c,i._forcedViewPosition=null,this._sceneUBOs&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(!0),(u=(h=i.getEngine())._debugPopGroup)===null||u===void 0||u.call(h,1)})}get samples(){return this._renderTargetTexture.samples}set samples(e){this._renderTargetTexture.samples=e}get refreshRate(){return this._renderTargetTexture.refreshRate}set refreshRate(e){this._renderTargetTexture.refreshRate=e}getScene(){return this._scene}get cubeTexture(){return this._renderTargetTexture}get renderList(){return this._renderTargetTexture.renderList}attachToMesh(e){this._attachedMesh=e}setRenderingAutoClearDepthStencil(e,t){this._renderTargetTexture.setRenderingAutoClearDepthStencil(e,t)}dispose(){const e=this._scene.reflectionProbes.indexOf(this);if(e!==-1&&this._scene.reflectionProbes.splice(e,1),this._parentContainer){const t=this._parentContainer.reflectionProbes.indexOf(this);t>-1&&this._parentContainer.reflectionProbes.splice(t,1),this._parentContainer=null}if(this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null),this._sceneUBOs){for(const t of this._sceneUBOs)t.dispose();this._sceneUBOs=[]}}toString(e){let t="Name: "+this.name;return e&&(t+=", position: "+this.position.toString(),this._attachedMesh&&(t+=", attached mesh: "+this._attachedMesh.name)),t}getClassName(){return"ReflectionProbe"}serialize(){const e=ke.Serialize(this,this._renderTargetTexture.serialize());return e.isReflectionProbe=!0,e.metadata=this.metadata,e}static Parse(e,t,i){let r=null;if(t.reflectionProbes)for(let s=0;s<t.reflectionProbes.length;s++){const n=t.reflectionProbes[s];if(n.name===e.name){r=n;break}}return r=ke.Parse(()=>r||new Xu(e.name,e.renderTargetSize,t,e._generateMipMaps),e,t,i),r.cubeTexture._waitingRenderList=e.renderList,e._attachedMesh&&r.attachToMesh(t.getMeshById(e._attachedMesh)),e.metadata&&(r.metadata=e.metadata),r}}M([Du()],Xu.prototype,"_attachedMesh",void 0);M([Zs()],Xu.prototype,"position",void 0);class Ud{}Ud.LoaderInjectedPhysicsEngine=void 0;let Fc={},cc={};const ux=(o,e,t,i)=>{if(!e.materials)return null;for(let r=0,s=e.materials.length;r<s;r++){const n=e.materials[r];if(o(n))return{parsedMaterial:n,material:me.Parse(n,t,i)}}return null},ND=(o,e,t)=>{for(const i in e)if(o.name===e[i])return t.push(o.id),!0;return o.parentId!==void 0&&t.indexOf(o.parentId)!==-1?(t.push(o.id),!0):!1},zc=(o,e)=>o+" of "+(e?e.file+" from "+e.name+" version: "+e.version+", exporter version: "+e.exporter_version:"unknown"),vE=(o,e)=>{const t=e;if(e._waitingData.lods){if(e._waitingData.lods.ids&&e._waitingData.lods.ids.length>0){const i=e._waitingData.lods.ids,r=t.isEnabled(!1);if(e._waitingData.lods.distances){const s=e._waitingData.lods.distances;if(s.length>=i.length){const n=s.length>i.length?s[s.length-1]:0;t.setEnabled(!1);for(let a=0;a<i.length;a++){const l=i[a],c=o.getMeshById(l);c!=null&&t.addLODLevel(s[a],c)}n>0&&t.addLODLevel(n,null),r===!0&&t.setEnabled(!0)}else J.Warn("Invalid level of detail distances for "+e.name)}}e._waitingData.lods=null}},Pd=(o,e,t)=>{if(typeof o!="number"){const r=t.getLastEntryById(o);return r&&e!==void 0&&e!==null?r.instances[parseInt(e)]:r}const i=Fc[o];return i&&e!==void 0&&e!==null?i.instances[parseInt(e)]:i},Jd=(o,e)=>typeof o!="number"?e.getLastMaterialById(o,!0):cc[o],dx=(o,e,t,i,r=!1)=>{const s=new vT(o);let n="importScene has failed JSON parse";try{var a=JSON.parse(e);n="";const l=ft.loggingLevel===ft.DETAILED_LOGGING;let c,h;if(a.environmentTexture!==void 0&&a.environmentTexture!==null){const d=a.isPBR!==void 0?a.isPBR:!0;if(a.environmentTextureType&&a.environmentTextureType==="BABYLON.HDRCubeTexture"){const f=a.environmentTextureSize?a.environmentTextureSize:128,_=new lc((a.environmentTexture.match(/https?:\/\//g)?"":t)+a.environmentTexture,o,f,!0,!d,void 0,a.environmentTexturePrefilterOnLoad);a.environmentTextureRotationY&&(_.rotationY=a.environmentTextureRotationY),o.environmentTexture=_}else if(typeof a.environmentTexture=="object"){const f=ns.Parse(a.environmentTexture,o,t);o.environmentTexture=f}else if(a.environmentTexture.endsWith(".env")){const f=new ns((a.environmentTexture.match(/https?:\/\//g)?"":t)+a.environmentTexture,o,a.environmentTextureForcedExtension);a.environmentTextureRotationY&&(f.rotationY=a.environmentTextureRotationY),o.environmentTexture=f}else{const f=ns.CreateFromPrefilteredData((a.environmentTexture.match(/https?:\/\//g)?"":t)+a.environmentTexture,o,a.environmentTextureForcedExtension);a.environmentTextureRotationY&&(f.rotationY=a.environmentTextureRotationY),o.environmentTexture=f}if(a.createDefaultSkybox===!0){const f=o.activeCamera!==void 0&&o.activeCamera!==null?(o.activeCamera.maxZ-o.activeCamera.minZ)/2:1e3,_=a.skyboxBlurLevel||0;o.createDefaultSkybox(o.environmentTexture,d,f,_)}s.environmentTexture=o.environmentTexture}if(a.environmentIntensity!==void 0&&a.environmentIntensity!==null&&(o.environmentIntensity=a.environmentIntensity),a.lights!==void 0&&a.lights!==null)for(c=0,h=a.lights.length;c<h;c++){const d=a.lights[c],f=St.Parse(d,o);f&&(Fc[d.uniqueId]=f,s.lights.push(f),f._parentContainer=s,n+=c===0?`
	Lights:`:"",n+=`
		`+f.toString(l))}if(a.reflectionProbes!==void 0&&a.reflectionProbes!==null)for(c=0,h=a.reflectionProbes.length;c<h;c++){const d=a.reflectionProbes[c],f=Xu.Parse(d,o,t);f&&(s.reflectionProbes.push(f),f._parentContainer=s,n+=c===0?`
	Reflection Probes:`:"",n+=`
		`+f.toString(l))}if(a.animations!==void 0&&a.animations!==null)for(c=0,h=a.animations.length;c<h;c++){const d=a.animations[c],f=Xr("BABYLON.Animation");if(f){const _=f.Parse(d);o.animations.push(_),s.animations.push(_),n+=c===0?`
	Animations:`:"",n+=`
		`+_.toString(l)}}if(a.materials!==void 0&&a.materials!==null)for(c=0,h=a.materials.length;c<h;c++){const d=a.materials[c],f=me.Parse(d,o,t);f&&(cc[d.uniqueId||d.id]=f,s.materials.push(f),f._parentContainer=s,n+=c===0?`
	Materials:`:"",n+=`
		`+f.toString(l),f.getActiveTextures().forEach(p=>{s.textures.indexOf(p)==-1&&(s.textures.push(p),p._parentContainer=s)}))}if(a.multiMaterials!==void 0&&a.multiMaterials!==null)for(c=0,h=a.multiMaterials.length;c<h;c++){const d=a.multiMaterials[c],f=$a.ParseMultiMaterial(d,o);cc[d.uniqueId||d.id]=f,s.multiMaterials.push(f),f._parentContainer=s,n+=c===0?`
	MultiMaterials:`:"",n+=`
		`+f.toString(l),f.getActiveTextures().forEach(p=>{s.textures.indexOf(p)==-1&&(s.textures.push(p),p._parentContainer=s)})}if(a.morphTargetManagers!==void 0&&a.morphTargetManagers!==null)for(const d of a.morphTargetManagers){const f=_o.Parse(d,o);s.morphTargetManagers.push(f),f._parentContainer=s}if(a.skeletons!==void 0&&a.skeletons!==null)for(c=0,h=a.skeletons.length;c<h;c++){const d=a.skeletons[c],f=Ol.Parse(d,o);s.skeletons.push(f),f._parentContainer=s,n+=c===0?`
	Skeletons:`:"",n+=`
		`+f.toString(l)}const u=a.geometries;if(u!=null){const d=new Array,f=u.vertexData;if(f!=null)for(c=0,h=f.length;c<h;c++){const _=f[c];d.push(Bs.Parse(_,o,t))}d.forEach(_=>{_&&(s.geometries.push(_),_._parentContainer=s)})}if(a.transformNodes!==void 0&&a.transformNodes!==null)for(c=0,h=a.transformNodes.length;c<h;c++){const d=a.transformNodes[c],f=gt.Parse(d,o,t);Fc[d.uniqueId]=f,s.transformNodes.push(f),f._parentContainer=s}if(a.meshes!==void 0&&a.meshes!==null)for(c=0,h=a.meshes.length;c<h;c++){const d=a.meshes[c],f=K.Parse(d,o,t);if(Fc[d.uniqueId]=f,s.meshes.push(f),f._parentContainer=s,f.hasInstances)for(const _ of f.instances)s.meshes.push(_),_._parentContainer=s;n+=c===0?`
	Meshes:`:"",n+=`
		`+f.toString(l)}if(a.cameras!==void 0&&a.cameras!==null)for(c=0,h=a.cameras.length;c<h;c++){const d=a.cameras[c],f=Ve.Parse(d,o);Fc[d.uniqueId]=f,s.cameras.push(f),f._parentContainer=s,n+=c===0?`
	Cameras:`:"",n+=`
		`+f.toString(l)}if(a.postProcesses!==void 0&&a.postProcesses!==null)for(c=0,h=a.postProcesses.length;c<h;c++){const d=a.postProcesses[c],f=et.Parse(d,o,t);f&&(s.postProcesses.push(f),f._parentContainer=s,n+=c===0?`
Postprocesses:`:"",n+=`
		`+f.toString())}if(a.animationGroups!==void 0&&a.animationGroups!==null)for(c=0,h=a.animationGroups.length;c<h;c++){const d=a.animationGroups[c],f=vu.Parse(d,o);s.animationGroups.push(f),f._parentContainer=s,n+=c===0?`
	AnimationGroups:`:"",n+=`
		`+f.toString(l)}for(c=0,h=o.cameras.length;c<h;c++){const d=o.cameras[c];d._waitingParentId!==null&&(d.parent=Pd(d._waitingParentId,d._waitingParentInstanceIndex,o),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,h=o.lights.length;c<h;c++){const d=o.lights[c];d&&d._waitingParentId!==null&&(d.parent=Pd(d._waitingParentId,d._waitingParentInstanceIndex,o),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,h=o.transformNodes.length;c<h;c++){const d=o.transformNodes[c];d._waitingParentId!==null&&(d.parent=Pd(d._waitingParentId,d._waitingParentInstanceIndex,o),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,h=o.meshes.length;c<h;c++){const d=o.meshes[c];d._waitingParentId!==null&&(d.parent=Pd(d._waitingParentId,d._waitingParentInstanceIndex,o),d._waitingParentId=null,d._waitingParentInstanceIndex=null),d._waitingData.lods&&vE(o,d)}for(o.multiMaterials.forEach(d=>{d._waitingSubMaterialsUniqueIds.forEach(f=>{d.subMaterials.push(Jd(f,o))}),d._waitingSubMaterialsUniqueIds=[]}),o.meshes.forEach(d=>{d._waitingMaterialId!==null&&(d.material=Jd(d._waitingMaterialId,o),d._waitingMaterialId=null)}),c=0,h=o.skeletons.length;c<h;c++){const d=o.skeletons[c];d._hasWaitingData&&(d.bones!=null&&d.bones.forEach(f=>{if(f._waitingTransformNodeId){const _=o.getLastEntryById(f._waitingTransformNodeId);_&&f.linkTransformNode(_),f._waitingTransformNodeId=null}}),d._hasWaitingData=null)}for(c=0,h=o.meshes.length;c<h;c++){const d=o.meshes[c];d._waitingData.freezeWorldMatrix?(d.freezeWorldMatrix(),d._waitingData.freezeWorldMatrix=null):d.computeWorldMatrix(!0)}for(c=0,h=o.lights.length;c<h;c++){const d=o.lights[c];if(d._excludedMeshesIds.length>0){for(let f=0;f<d._excludedMeshesIds.length;f++){const _=o.getMeshById(d._excludedMeshesIds[f]);_&&d.excludedMeshes.push(_)}d._excludedMeshesIds=[]}if(d._includedOnlyMeshesIds.length>0){for(let f=0;f<d._includedOnlyMeshesIds.length;f++){const _=o.getMeshById(d._includedOnlyMeshesIds[f]);_&&d.includedOnlyMeshes.push(_)}d._includedOnlyMeshesIds=[]}}for(o.geometries.forEach(d=>{d._loadedUniqueId=""}),Er.Parse(a,o,s,t),c=0,h=o.meshes.length;c<h;c++){const d=o.meshes[c];d._waitingData.actions&&(li.Parse(d._waitingData.actions,d,o),d._waitingData.actions=null)}a.actions!==void 0&&a.actions!==null&&li.Parse(a.actions,null,o)}catch(l){const c=zc("loadAssets",a?a.producer:"Unknown")+n;if(i)i(c,l);else throw X.Log(c),l}finally{Fc={},cc={},r||s.removeAllFromScene(),n!==null&&ft.loggingLevel!==ft.NO_LOGGING&&X.Log(zc("loadAssets",a?a.producer:"Unknown")+(ft.loggingLevel!==ft.MINIMAL_LOGGING?n:""))}return s};ft.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:o=>o.indexOf("babylon")!==-1,importMesh:(o,e,t,i,r,s,n,a)=>{var l;let c="importMesh has failed JSON parse";try{var h=JSON.parse(t);c="";const u=ft.loggingLevel===ft.DETAILED_LOGGING;o?Array.isArray(o)||(o=[o]):o=null;const d=new Array,f=new Map,_=[];if(h.transformNodes!==void 0&&h.transformNodes!==null)for(let p=0,m=h.transformNodes.length;p<m;p++){const T=h.transformNodes[p],b=gt.Parse(T,e,i);_.push(b),f.set(b._waitingParsedUniqueId,b),b._waitingParsedUniqueId=null}if(h.meshes!==void 0&&h.meshes!==null){const p=[],m=[],T=[],b=[];for(let S=0,C=h.meshes.length;S<C;S++){const I=h.meshes[S];if(o===null||ND(I,o,d)){if(o!==null&&delete o[o.indexOf(I.name)],I.geometryId!==void 0&&I.geometryId!==null&&h.geometries!==void 0&&h.geometries!==null){let D=!1;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach(w=>{D===!0||!h.geometries[w]||!Array.isArray(h.geometries[w])||h.geometries[w].forEach(L=>{if(L.id===I.geometryId){switch(w){case"vertexData":Bs.Parse(L,e,i);break}D=!0}})}),D===!1&&X.Warn("Geometry not found for mesh "+I.id)}if(I.materialUniqueId||I.materialId){const D=I.materialUniqueId?T:m;let w=D.indexOf(I.materialUniqueId||I.materialId)!==-1;if(w===!1&&h.multiMaterials!==void 0&&h.multiMaterials!==null){const L=(U,G)=>{D.push(U);const Z=ux(G,h,e,i);Z&&Z.material&&(cc[Z.parsedMaterial.uniqueId||Z.parsedMaterial.id]=Z.material,c+=`
	Material `+Z.material.toString(u))};for(let U=0,G=h.multiMaterials.length;U<G;U++){const Z=h.multiMaterials[U];if(I.materialUniqueId&&Z.uniqueId===I.materialUniqueId||Z.id===I.materialId){Z.materialsUniqueIds?Z.materialsUniqueIds.forEach(_e=>L(_e,ne=>ne.uniqueId===_e)):Z.materials.forEach(_e=>L(_e,ne=>ne.id===_e)),D.push(Z.uniqueId||Z.id);const he=$a.ParseMultiMaterial(Z,e);cc[Z.uniqueId||Z.id]=he,he&&(w=!0,c+=`
	Multi-Material `+he.toString(u));break}}}if(w===!1){D.push(I.materialUniqueId||I.materialId);const L=ux(U=>I.materialUniqueId&&U.uniqueId===I.materialUniqueId||U.id===I.materialId,h,e,i);!L||!L.material?X.Warn("Material not found for mesh "+I.id):(cc[L.parsedMaterial.uniqueId||L.parsedMaterial.id]=L.material,c+=`
	Material `+L.material.toString(u))}}if(I.skeletonId>-1&&h.skeletons!==void 0&&h.skeletons!==null&&!(p.indexOf(I.skeletonId)>-1))for(let w=0,L=h.skeletons.length;w<L;w++){const U=h.skeletons[w];if(U.id===I.skeletonId){const G=Ol.Parse(U,e);n.push(G),p.push(U.id),c+=`
	Skeleton `+G.toString(u)}}if(I.morphTargetManagerId>-1&&h.morphTargetManagers!==void 0&&h.morphTargetManagers!==null&&!(b.indexOf(I.morphTargetManagerId)>-1))for(let w=0,L=h.morphTargetManagers.length;w<L;w++){const U=h.morphTargetManagers[w];if(U.id===I.morphTargetManagerId){const G=_o.Parse(U,e);b.push(G.uniqueId),c+=`
Morph target `+G.toString()}}const P=K.Parse(I,e,i);r.push(P),f.set(P._waitingParsedUniqueId,P),P._waitingParsedUniqueId=null,c+=`
	Mesh `+P.toString(u)}}e.multiMaterials.forEach(S=>{S._waitingSubMaterialsUniqueIds.forEach(C=>{S.subMaterials.push(Jd(C,e))}),S._waitingSubMaterialsUniqueIds=[]}),e.meshes.forEach(S=>{S._waitingMaterialId!==null&&(S.material=Jd(S._waitingMaterialId,e),S._waitingMaterialId=null)});for(let S=0,C=e.transformNodes.length;S<C;S++){const I=e.transformNodes[S];if(I._waitingParentId!==null){let P=f.get(parseInt(I._waitingParentId))||null;P===null&&(P=e.getLastEntryById(I._waitingParentId));let D=P;I._waitingParentInstanceIndex&&(D=P.instances[parseInt(I._waitingParentInstanceIndex)],I._waitingParentInstanceIndex=null),I.parent=D,I._waitingParentId=null}}let y;for(let S=0,C=e.meshes.length;S<C;S++){if(y=e.meshes[S],y._waitingParentId){let I=f.get(parseInt(y._waitingParentId))||null;I===null&&(I=e.getLastEntryById(y._waitingParentId));let P=I;if(y._waitingParentInstanceIndex&&(P=I.instances[parseInt(y._waitingParentInstanceIndex)],y._waitingParentInstanceIndex=null),y.parent=P,((l=y.parent)===null||l===void 0?void 0:l.getClassName())==="TransformNode"){const D=_.indexOf(y.parent);D>-1&&_.splice(D,1)}y._waitingParentId=null}y._waitingData.lods&&vE(e,y)}for(const S of _)S.dispose();for(let S=0,C=e.skeletons.length;S<C;S++){const I=e.skeletons[S];I._hasWaitingData&&(I.bones!=null&&I.bones.forEach(P=>{if(P._waitingTransformNodeId){const D=e.getLastEntryById(P._waitingTransformNodeId);D&&P.linkTransformNode(D),P._waitingTransformNodeId=null}}),I._hasWaitingData=null)}for(let S=0,C=e.meshes.length;S<C;S++)y=e.meshes[S],y._waitingData.freezeWorldMatrix?(y.freezeWorldMatrix(),y._waitingData.freezeWorldMatrix=null):y.computeWorldMatrix(!0)}if(h.particleSystems!==void 0&&h.particleSystems!==null){const p=Er.GetIndividualParser(Re.NAME_PARTICLESYSTEM);if(p)for(let m=0,T=h.particleSystems.length;m<T;m++){const b=h.particleSystems[m];d.indexOf(b.emitterId)!==-1&&s.push(p(b,e,i))}}return e.geometries.forEach(p=>{p._loadedUniqueId=""}),!0}catch(u){const d=zc("importMesh",h?h.producer:"Unknown")+c;if(a)a(d,u);else throw X.Log(d),u}finally{c!==null&&ft.loggingLevel!==ft.NO_LOGGING&&X.Log(zc("importMesh",h?h.producer:"Unknown")+(ft.loggingLevel!==ft.MINIMAL_LOGGING?c:""))}return!1},load:(o,e,t,i)=>{let r="importScene has failed JSON parse";try{var s=JSON.parse(e);if(r="",s.useDelayedTextureLoading!==void 0&&s.useDelayedTextureLoading!==null&&(o.useDelayedTextureLoading=s.useDelayedTextureLoading&&!ft.ForceFullSceneLoadingForIncremental),s.autoClear!==void 0&&s.autoClear!==null&&(o.autoClear=s.autoClear),s.clearColor!==void 0&&s.clearColor!==null&&(o.clearColor=Ye.FromArray(s.clearColor)),s.ambientColor!==void 0&&s.ambientColor!==null&&(o.ambientColor=ge.FromArray(s.ambientColor)),s.gravity!==void 0&&s.gravity!==null&&(o.gravity=x.FromArray(s.gravity)),s.useRightHandedSystem!==void 0&&(o.useRightHandedSystem=!!s.useRightHandedSystem),s.fogMode&&s.fogMode!==0)switch(o.fogMode=s.fogMode,o.fogColor=ge.FromArray(s.fogColor),o.fogStart=s.fogStart,o.fogEnd=s.fogEnd,o.fogDensity=s.fogDensity,r+="	Fog mode for scene:  ",o.fogMode){case 1:r+=`exp
`;break;case 2:r+=`exp2
`;break;case 3:r+=`linear
`;break}if(s.physicsEnabled){let a;s.physicsEngine==="cannon"||s.physicsEngine===ep.name?a=new ep(void 0,void 0,Ud.LoaderInjectedPhysicsEngine):s.physicsEngine==="oimo"||s.physicsEngine===hx.name?a=new hx(void 0,Ud.LoaderInjectedPhysicsEngine):(s.physicsEngine==="ammo"||s.physicsEngine===po.name)&&(a=new po(void 0,Ud.LoaderInjectedPhysicsEngine,void 0)),r="	Physics engine "+(s.physicsEngine?s.physicsEngine:"oimo")+` enabled
`;const l=s.physicsGravity?x.FromArray(s.physicsGravity):null;o.enablePhysics(l,a)}return s.metadata!==void 0&&s.metadata!==null&&(o.metadata=s.metadata),s.collisionsEnabled!==void 0&&s.collisionsEnabled!==null&&(o.collisionsEnabled=s.collisionsEnabled),dx(o,e,t,i,!0)?(s.autoAnimate&&o.beginAnimation(o,s.autoAnimateFrom,s.autoAnimateTo,s.autoAnimateLoop,s.autoAnimateSpeed||1),s.activeCameraID!==void 0&&s.activeCameraID!==null&&o.setActiveCameraById(s.activeCameraID),!0):!1}catch(n){const a=zc("importScene",s?s.producer:"Unknown")+r;if(i)i(a,n);else throw X.Log(a),n}finally{r!==null&&ft.loggingLevel!==ft.NO_LOGGING&&X.Log(zc("importScene",s?s.producer:"Unknown")+(ft.loggingLevel!==ft.MINIMAL_LOGGING?r:""))}return!1},loadAssetContainer:(o,e,t,i)=>dx(o,e,t,i)});class ef{get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,q.MarkAllMaterialsAsDirty(20))}constructor(e={}){this._isEnabled=!0,this.bias=e.bias===void 0?0:e.bias,this.power=e.power===void 0?1:e.power,this.leftColor=e.leftColor||ge.White(),this.rightColor=e.rightColor||ge.Black(),e.isEnabled===!1&&(this.isEnabled=!1)}clone(){const e=new ef;return Sn.DeepCopy(this,e),e}equals(e){return e&&this.bias===e.bias&&this.power===e.power&&this.leftColor.equals(e.leftColor)&&this.rightColor.equals(e.rightColor)&&this.isEnabled===e.isEnabled}serialize(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}}static Parse(e){return new ef({isEnabled:e.isEnabled,leftColor:ge.FromArray(e.leftColor),rightColor:ge.FromArray(e.rightColor),bias:e.bias,power:e.power||1})}}ke._FresnelParametersParser=ef.Parse;class yn extends ei{get doubleSided(){return this._twoSidedLighting}set doubleSided(e){this._twoSidedLighting!==e&&(this._twoSidedLighting=e,this.backFaceCulling=!e,this._markAllSubMeshesAsTexturesDirty())}constructor(e,t){super(e,t),this.maxSimultaneousLights=4,this.disableLighting=!1,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.emissiveColor=new ge(0,0,0),this.occlusionStrength=1,this.useLightmapAsShadowmap=!1,this._useAlphaFromAlbedoTexture=!0,this._useAmbientInGrayScale=!0}getClassName(){return"PBRBaseSimpleMaterial"}}M([F(),Te("_markAllSubMeshesAsLightsDirty")],yn.prototype,"maxSimultaneousLights",void 0);M([F(),Te("_markAllSubMeshesAsLightsDirty")],yn.prototype,"disableLighting",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],yn.prototype,"environmentTexture",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],yn.prototype,"invertNormalMapX",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],yn.prototype,"invertNormalMapY",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],yn.prototype,"normalTexture",void 0);M([Kr("emissive"),Te("_markAllSubMeshesAsTexturesDirty")],yn.prototype,"emissiveColor",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty")],yn.prototype,"emissiveTexture",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],yn.prototype,"occlusionStrength",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],yn.prototype,"occlusionTexture",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],yn.prototype,"alphaCutOff",void 0);M([F()],yn.prototype,"doubleSided",null);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty",null)],yn.prototype,"lightmapTexture",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],yn.prototype,"useLightmapAsShadowmap",void 0);class qo extends yn{constructor(e,t){super(e,t),this._useRoughnessFromMetallicTextureAlpha=!1,this._useRoughnessFromMetallicTextureGreen=!0,this._useMetallnessFromMetallicTextureBlue=!0,this.metallic=1,this.roughness=1}getClassName(){return"PBRMetallicRoughnessMaterial"}clone(e){const t=ke.Clone(()=>new qo(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=ke.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const r=ke.Parse(()=>new qo(e.name,t),e,t,i);return e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}M([Kr(),Te("_markAllSubMeshesAsTexturesDirty","_albedoColor")],qo.prototype,"baseColor",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],qo.prototype,"baseTexture",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],qo.prototype,"metallic",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty")],qo.prototype,"roughness",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],qo.prototype,"metallicRoughnessTexture",void 0);ye("BABYLON.PBRMetallicRoughnessMaterial",qo);class Qo extends yn{get useMicroSurfaceFromReflectivityMapAlpha(){return this._useMicroSurfaceFromReflectivityMapAlpha}constructor(e,t){super(e,t),this._useMicroSurfaceFromReflectivityMapAlpha=!0}getClassName(){return"PBRSpecularGlossinessMaterial"}clone(e){const t=ke.Clone(()=>new Qo(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=ke.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const r=ke.Parse(()=>new Qo(e.name,t),e,t,i);return e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}M([Kr("diffuse"),Te("_markAllSubMeshesAsTexturesDirty","_albedoColor")],Qo.prototype,"diffuseColor",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],Qo.prototype,"diffuseTexture",void 0);M([Kr("specular"),Te("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],Qo.prototype,"specularColor",void 0);M([F(),Te("_markAllSubMeshesAsTexturesDirty","_microSurface")],Qo.prototype,"glossiness",void 0);M([Bt(),Te("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],Qo.prototype,"specularGlossinessTexture",void 0);ye("BABYLON.PBRSpecularGlossinessMaterial",Qo);class jc extends ni{constructor(e,t,i=null){if(super(t),!!e)if(this._textureMatrix=H.Identity(),this.name=e,this.url=e,this._onLoad=i,this._texture=this._getFromCache(e,!0),this._texture)this._triggerOnLoad();else{const r=this.getScene();r?r.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture():this._loadTexture()}}_triggerOnLoad(){this._onLoad&&this._onLoad()}getTextureMatrix(){return this._textureMatrix}_load3dlTexture(){const e=this._getEngine();let t;e._features.support3DTextures?t=e.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):t=e.createRawTexture(null,1,1,5,!1,!1,2,null,0),this._texture=t,this._texture.isReady=!1,this.isCube=!1,this.is3D=e._features.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;const i=s=>{if(typeof s!="string")return;let n=null,a=null,l;const c=s.split(`
`);let h=0,u=0,d=0,f=0,_=0;for(let p=0;p<c.length;p++){if(l=c[p],!jc._NoneEmptyLineRegex.test(l)||l.indexOf("#")===0)continue;const m=l.split(" ");if(h===0){h=m.length,n=new Uint8Array(h*h*h*4),a=new Float32Array(h*h*h*4);continue}if(h!=0){const T=Math.max(parseInt(m[0]),0),b=Math.max(parseInt(m[1]),0),y=Math.max(parseInt(m[2]),0);_=Math.max(T,_),_=Math.max(b,_),_=Math.max(y,_);const S=(u+f*h+d*h*h)*4;a&&(a[S+0]=T,a[S+1]=b,a[S+2]=y),d++,d%h==0&&(f++,d=0,f%h==0&&(u++,f=0))}}if(a&&n)for(let p=0;p<a.length;p++)if(p>0&&(p+1)%4===0)n[p]=255;else{const m=a[p];n[p]=m/_*255}t.is3D?(t.updateSize(h,h,h),e.updateRawTexture3D(t,n,5,!1)):(t.updateSize(h*h,h),e.updateRawTexture(t,n,5,!1)),t.isReady=!0,this._triggerOnLoad()},r=this.getScene();return r?r._loadFile(this.url,i):e._loadFile(this.url,i),this._texture}_loadTexture(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this._load3dlTexture()}clone(){const e=new jc(this.url,this.getScene()||this._getEngine());return e.level=this.level,e}delayLoad(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,!0),this._texture||this._loadTexture())}static Parse(e,t){let i=null;return e.name&&!e.isRenderTarget&&(i=new jc(e.name,t),i.name=e.name,i.level=e.level),i}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.level=this.level,e.customType="BABYLON.ColorGradingTexture",e}}jc._NoneEmptyLineRegex=/\S+/;ye("BABYLON.ColorGradingTexture",jc);class tf extends ni{constructor(e,t,i,r=!1,s=!0,n=null,a=null){if(super(t),this._onLoad=null,this._onError=null,!e)throw new Error("Image url is not set");this._coordinatesMode=Y.CUBIC_MODE,this.name=e,this.url=e,this._size=i,this._noMipmap=r,this.gammaSpace=s,this._onLoad=n,this._onError=a,this.hasAlpha=!1,this.isCube=!0,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?n&&(this._texture.isReady?J.SetImmediate(()=>n()):this._texture.onLoadedObservable.add(n)):t.useDelayedTextureLoading?this.delayLoadState=4:this._loadImage(this._loadTexture.bind(this),this._onError)}_loadImage(e,t){const i=document.createElement("canvas");Nu(this.url,r=>{this._width=r.width,this._height=r.height,i.width=this._width,i.height=this._height;const s=i.getContext("2d");s.drawImage(r,0,0);const n=s.getImageData(0,0,r.width,r.height);this._buffer=n.data.buffer,i.remove(),e()},(r,s)=>{t&&t(`${this.getClassName()} could not be loaded`,s)},null)}_loadTexture(){const e=this.getScene(),t=()=>{const i=this._getFloat32ArrayFromArrayBuffer(this._buffer),r=Hl.ConvertPanoramaToCubemap(i,this._width,this._height,this._size),s=[];for(let n=0;n<6;n++){const a=r[tf._FacesMapping[n]];s.push(a)}return s};e&&(this._texture=e.getEngine().createRawCubeTextureFromUrl(this.url,e,this._size,4,e.getEngine().getCaps().textureFloat?1:7,this._noMipmap,t,null,this._onLoad,this._onError))}_getFloat32ArrayFromArrayBuffer(e){const t=new DataView(e),i=new Float32Array(e.byteLength*3/4);let r=0;for(let s=0;s<e.byteLength;s++)(s+1)%4!==0&&(i[r++]=t.getUint8(s)/255);return i}getClassName(){return"EquiRectangularCubeTexture"}clone(){const e=this.getScene();if(!e)return this;const t=new tf(this.url,e,this._size,this._noMipmap,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t}}tf._FacesMapping=["right","left","up","down","front","back"];class Um extends ni{constructor(e,t,i){var r,s;super(i.scene||i.engine),this.onLoadObservable=new Q,!(!t||!i.engine&&!i.scene)&&(i={...Um._DefaultOptions,...i},this._generateMipMaps=i.generateMipMaps,this._samplingMode=i.samplingMode,this._textureMatrix=H.Identity(),this._format=i.format,this.name=e,this.element=t,this._isVideo=!!t.getVideoPlaybackQuality,this._externalTexture=this._isVideo&&(s=(r=this._engine)===null||r===void 0?void 0:r.createExternalTexture(t))!==null&&s!==void 0?s:null,this.anisotropicFilteringLevel=1,this._createInternalTexture())}_createInternalTexture(){let e=0,t=0;this._isVideo?(e=this.element.videoWidth,t=this.element.videoHeight):(e=this.element.width,t=this.element.height);const i=this._getEngine();i&&(this._texture=i.createDynamicTexture(e,t,this._generateMipMaps,this._samplingMode),this._texture.format=this._format),this.update()}getTextureMatrix(){return this._textureMatrix}update(e=null){const t=this._getEngine();if(this._texture==null||t==null)return;const i=this.isReady();if(this._isVideo){const r=this.element;if(r.readyState<r.HAVE_CURRENT_DATA)return;t.updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:r,e===null?!0:e)}else{const r=this.element;t.updateDynamicTexture(this._texture,r,e===null?!0:e,!1,this._format)}!i&&this.isReady()&&this.onLoadObservable.notifyObservers(this)}dispose(){this.onLoadObservable.clear(),super.dispose()}}Um._DefaultOptions={generateMipMaps:!1,samplingMode:2,format:5,engine:null,scene:null};const wD=1,FD=2,LD=3,BD=9,UD=10,VD=11,kD=48,GD=4,zD=0,HD=1,WD=2,XD=3;function $f(o){let e=0;return{id_length:o[e++],colormap_type:o[e++],image_type:o[e++],colormap_index:o[e++]|o[e++]<<8,colormap_length:o[e++]|o[e++]<<8,colormap_size:o[e++],origin:[o[e++]|o[e++]<<8,o[e++]|o[e++]<<8],width:o[e++]|o[e++]<<8,height:o[e++]|o[e++]<<8,pixel_size:o[e++],flags:o[e++]}}function xE(o,e){if(e.length<19){X.Error("Unable to load TGA file - Not enough data to contain header");return}let t=18;const i=$f(e);if(i.id_length+t>e.length){X.Error("Unable to load TGA file - Not enough data");return}t+=i.id_length;let r=!1,s=!1,n=!1;switch(i.image_type){case BD:r=!0;case wD:s=!0;break;case UD:r=!0;case FD:break;case VD:r=!0;case LD:n=!0;break}let a;const l=i.pixel_size>>3,c=i.width*i.height*l;let h;if(s&&(h=e.subarray(t,t+=i.colormap_length*(i.colormap_size>>3))),r){a=new Uint8Array(c);let S,C,I,P=0;const D=new Uint8Array(l);for(;t<c&&P<c;)if(S=e[t++],C=(S&127)+1,S&128){for(I=0;I<l;++I)D[I]=e[t++];for(I=0;I<C;++I)a.set(D,P+I*l);P+=l*C}else{for(C*=l,I=0;I<C;++I)a[P+I]=e[t++];P+=C}}else a=e.subarray(t,t+=s?i.width*i.height:c);let u,d,f,_,p,m;switch((i.flags&kD)>>GD){default:case WD:u=0,f=1,m=i.width,d=0,_=1,p=i.height;break;case zD:u=0,f=1,m=i.width,d=i.height-1,_=-1,p=-1;break;case XD:u=i.width-1,f=-1,m=-1,d=0,_=1,p=i.height;break;case HD:u=i.width-1,f=-1,m=-1,d=i.height-1,_=-1,p=-1;break}const T="_getImageData"+(n?"Grey":"")+i.pixel_size+"bits",b=ZD[T](i,h,a,d,_,p,u,f,m);o.getEngine()._uploadDataToTextureDirectly(o,b)}function $D(o,e,t,i,r,s,n,a,l){const c=t,h=e,u=o.width,d=o.height;let f,_=0,p,m;const T=new Uint8Array(u*d*4);for(m=i;m!==s;m+=r)for(p=n;p!==l;p+=a,_++)f=c[_],T[(p+u*m)*4+3]=255,T[(p+u*m)*4+2]=h[f*3+0],T[(p+u*m)*4+1]=h[f*3+1],T[(p+u*m)*4+0]=h[f*3+2];return T}function YD(o,e,t,i,r,s,n,a,l){const c=t,h=o.width,u=o.height;let d,f=0,_,p;const m=new Uint8Array(h*u*4);for(p=i;p!==s;p+=r)for(_=n;_!==l;_+=a,f+=2){d=c[f+0]+(c[f+1]<<8);const T=((d&31744)>>10)*255/31|0,b=((d&992)>>5)*255/31|0,y=(d&31)*255/31|0;m[(_+h*p)*4+0]=T,m[(_+h*p)*4+1]=b,m[(_+h*p)*4+2]=y,m[(_+h*p)*4+3]=d&32768?0:255}return m}function jD(o,e,t,i,r,s,n,a,l){const c=t,h=o.width,u=o.height;let d=0,f,_;const p=new Uint8Array(h*u*4);for(_=i;_!==s;_+=r)for(f=n;f!==l;f+=a,d+=3)p[(f+h*_)*4+3]=255,p[(f+h*_)*4+2]=c[d+0],p[(f+h*_)*4+1]=c[d+1],p[(f+h*_)*4+0]=c[d+2];return p}function KD(o,e,t,i,r,s,n,a,l){const c=t,h=o.width,u=o.height;let d=0,f,_;const p=new Uint8Array(h*u*4);for(_=i;_!==s;_+=r)for(f=n;f!==l;f+=a,d+=4)p[(f+h*_)*4+2]=c[d+0],p[(f+h*_)*4+1]=c[d+1],p[(f+h*_)*4+0]=c[d+2],p[(f+h*_)*4+3]=c[d+3];return p}function qD(o,e,t,i,r,s,n,a,l){const c=t,h=o.width,u=o.height;let d,f=0,_,p;const m=new Uint8Array(h*u*4);for(p=i;p!==s;p+=r)for(_=n;_!==l;_+=a,f++)d=c[f],m[(_+h*p)*4+0]=d,m[(_+h*p)*4+1]=d,m[(_+h*p)*4+2]=d,m[(_+h*p)*4+3]=255;return m}function QD(o,e,t,i,r,s,n,a,l){const c=t,h=o.width,u=o.height;let d=0,f,_;const p=new Uint8Array(h*u*4);for(_=i;_!==s;_+=r)for(f=n;f!==l;f+=a,d+=2)p[(f+h*_)*4+0]=c[d+0],p[(f+h*_)*4+1]=c[d+0],p[(f+h*_)*4+2]=c[d+0],p[(f+h*_)*4+3]=c[d+1];return p}const ZD={GetTGAHeader:$f,UploadContent:xE,_getImageData8bits:$D,_getImageData16bits:YD,_getImageData24bits:jD,_getImageData32bits:KD,_getImageDataGrey8bits:qD,_getImageDataGrey16bits:QD};class JD{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".tga")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),s=$f(r);i(s.width,s.height,t.generateMipMaps,!1,()=>{xE(t,r)})}}q._TextureLoaders.push(new JD);class eN{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".hdr")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),s=J_.RGBE_ReadHeader(r),n=J_.RGBE_ReadPixels(r,s),a=s.width*s.height,l=new Float32Array(a*4);for(let c=0;c<a;c+=1)l[c*4]=n[c*3],l[c*4+1]=n[c*3+1],l[c*4+2]=n[c*3+2],l[c*4+3]=1;i(s.width,s.height,t.generateMipMaps,!1,()=>{const c=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,c._uploadDataToTextureDirectly(t,l)})}}q._TextureLoaders.push(new eN);var Bo;(function(o){o[o.cTFETC1=0]="cTFETC1",o[o.cTFETC2=1]="cTFETC2",o[o.cTFBC1=2]="cTFBC1",o[o.cTFBC3=3]="cTFBC3",o[o.cTFBC4=4]="cTFBC4",o[o.cTFBC5=5]="cTFBC5",o[o.cTFBC7=6]="cTFBC7",o[o.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",o[o.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",o[o.cTFASTC_4x4=10]="cTFASTC_4x4",o[o.cTFATC_RGB=11]="cTFATC_RGB",o[o.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",o[o.cTFRGBA32=13]="cTFRGBA32",o[o.cTFRGB565=14]="cTFRGB565",o[o.cTFBGR565=15]="cTFBGR565",o[o.cTFRGBA4444=16]="cTFRGBA4444",o[o.cTFFXT1_RGB=17]="cTFFXT1_RGB",o[o.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",o[o.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",o[o.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",o[o.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"})(Bo||(Bo={}));const Ul={JSModuleURL:"https://cdn.babylonjs.com/basisTranscoder/1/basis_transcoder.js",WasmModuleURL:"https://cdn.babylonjs.com/basisTranscoder/1/basis_transcoder.wasm"},tN=(o,e)=>{let t;switch(o){case Bo.cTFETC1:t=36196;break;case Bo.cTFBC1:t=33776;break;case Bo.cTFBC4:t=33779;break;case Bo.cTFASTC_4x4:t=37808;break;case Bo.cTFETC2:t=37496;break;case Bo.cTFBC7:t=36492;break}if(t===void 0)throw"The chosen Basis transcoder format is not currently supported";return t};let P_=null,oo=null,iN=0;const rN=!1,sN=()=>(P_||(P_=new Promise((o,e)=>{oo?o(oo):J.LoadFileAsync(Ul.WasmModuleURL).then(t=>{if(typeof URL!="function")return e("Basis transcoder requires an environment with a URL constructor");const i=URL.createObjectURL(new Blob([`(${nN})()`],{type:"application/javascript"}));oo=new Worker(i);const r=s=>{s.data.action==="init"?(oo.removeEventListener("message",r),o(oo)):s.data.action==="error"&&e(s.data.error||"error initializing worker")};oo.addEventListener("message",r),oo.postMessage({action:"init",url:Ul.JSModuleURL,wasmBinary:t})}).catch(e)})),P_),tp=(o,e)=>{const t=o instanceof ArrayBuffer?new Uint8Array(o):o;return new Promise((i,r)=>{sN().then(()=>{const s=iN++,n=l=>{l.data.action==="transcode"&&l.data.id===s&&(oo.removeEventListener("message",n),l.data.success?i(l.data):r("Transcode is not supported on this device"))};oo.addEventListener("message",n);const a=new Uint8Array(t.byteLength);a.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),oo.postMessage({action:"transcode",id:s,imageData:a,config:e,ignoreSupportedFormats:rN},[a.buffer])},s=>{r(s)})})},Md=(o,e)=>{var t,i;let r=(t=e._gl)===null||t===void 0?void 0:t.TEXTURE_2D;o.isCube&&(r=(i=e._gl)===null||i===void 0?void 0:i.TEXTURE_CUBE_MAP),e._bindTextureDirectly(r,o,!0)},ip=(o,e)=>{const t=o.getEngine();for(let i=0;i<e.fileInfo.images.length;i++){const r=e.fileInfo.images[i].levels[0];if(o._invertVScale=o.invertY,e.format===-1||e.format===Bo.cTFRGB565)if(o.type=10,o.format=4,t._features.basisNeedsPOT&&(Ee.Log2(r.width)%1!==0||Ee.Log2(r.height)%1!==0)){const s=new hi(t,bt.Temp);o._invertVScale=o.invertY,s.type=10,s.format=4,s.width=r.width+3&-4,s.height=r.height+3&-4,Md(s,t),t._uploadDataToTextureDirectly(s,new Uint16Array(r.transcodedPixels.buffer),i,0,4,!0),t._rescaleTexture(s,o,t.scenes[0],t._getInternalFormat(4),()=>{t._releaseTexture(s),Md(o,t)})}else o._invertVScale=!o.invertY,o.width=r.width+3&-4,o.height=r.height+3&-4,o.samplingMode=2,Md(o,t),t._uploadDataToTextureDirectly(o,new Uint16Array(r.transcodedPixels.buffer),i,0,4,!0);else{o.width=r.width,o.height=r.height,o.generateMipMaps=e.fileInfo.images[i].levels.length>1;const s=Vm.GetInternalFormatFromBasisFormat(e.format,t);o.format=s,Md(o,t),e.fileInfo.images[i].levels.forEach((n,a)=>{t._uploadCompressedDataToTextureDirectly(o,s,n.width,n.height,n.transcodedPixels,i,a)}),t._features.basisNeedsPOT&&(Ee.Log2(o.width)%1!==0||Ee.Log2(o.height)%1!==0)&&(J.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),o._cachedWrapU=Y.CLAMP_ADDRESSMODE,o._cachedWrapV=Y.CLAMP_ADDRESSMODE)}}},Vm={JSModuleURL:Ul.JSModuleURL,WasmModuleURL:Ul.WasmModuleURL,GetInternalFormatFromBasisFormat:tN,TranscodeAsync:tp,LoadTextureFromTranscodeResult:ip};function nN(){const o={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFBC4:4,cTFBC5:5,cTFBC7:6,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFBGR565:15,cTFRGBA4444:16,cTFFXT1_RGB:17,cTFPVRTC2_4_RGB:18,cTFPVRTC2_4_RGBA:19,cTFETC2_EAC_R11:20,cTFETC2_EAC_RG11:21};let e=null;onmessage=n=>{if(n.data.action==="init"){if(!e){try{importScripts(n.data.url)}catch(a){postMessage({action:"error",error:a})}e=BASIS({wasmBinary:n.data.wasmBinary})}e!==null&&e.then(a=>{BASIS=a,a.initializeBasis(),postMessage({action:"init"})})}else if(n.data.action==="transcode"){const a=n.data.config,l=n.data.imageData,c=new BASIS.BasisFile(l),h=i(c);let u=n.data.ignoreSupportedFormats?null:t(n.data.config,h),d=!1;u===null&&(d=!0,u=h.hasAlpha?o.cTFBC3:o.cTFBC1);let f=!0;c.startTranscoding()||(f=!1);const _=[];for(let p=0;p<h.images.length&&f;p++){const m=h.images[p];if(a.loadSingleImage===void 0||a.loadSingleImage===p){let T=m.levels.length;a.loadMipmapLevels===!1&&(T=1);for(let b=0;b<T;b++){const y=m.levels[b],S=r(c,p,b,u,d);if(!S){f=!1;break}y.transcodedPixels=S,_.push(y.transcodedPixels.buffer)}}}c.close(),c.delete(),d&&(u=-1),f?postMessage({action:"transcode",success:f,id:n.data.id,fileInfo:h,format:u},_):postMessage({action:"transcode",success:f,id:n.data.id})}};function t(n,a){let l=null;return n.supportedCompressionFormats&&(n.supportedCompressionFormats.astc?l=o.cTFASTC_4x4:n.supportedCompressionFormats.bc7?l=o.cTFBC7:n.supportedCompressionFormats.s3tc?l=a.hasAlpha?o.cTFBC3:o.cTFBC1:n.supportedCompressionFormats.pvrtc?l=a.hasAlpha?o.cTFPVRTC1_4_RGBA:o.cTFPVRTC1_4_RGB:n.supportedCompressionFormats.etc2?l=o.cTFETC2:n.supportedCompressionFormats.etc1?l=o.cTFETC1:l=o.cTFRGB565),l}function i(n){const a=n.getHasAlpha(),l=n.getNumImages(),c=[];for(let u=0;u<l;u++){const d={levels:[]},f=n.getNumLevels(u);for(let _=0;_<f;_++){const p={width:n.getImageWidth(u,_),height:n.getImageHeight(u,_)};d.levels.push(p)}c.push(d)}return{hasAlpha:a,images:c}}function r(n,a,l,c,h){const u=n.getImageTranscodedSizeInBytes(a,l,c);let d=new Uint8Array(u);if(!n.transcodeImage(d,a,l,c,1,0))return null;if(h){const f=n.getImageWidth(a,l)+3&-4,_=n.getImageHeight(a,l)+3&-4;d=s(d,0,f,_)}return d}function s(n,a,l,c){const h=new Uint16Array(4),u=new Uint16Array(l*c),d=l/4,f=c/4;for(let _=0;_<f;_++)for(let p=0;p<d;p++){const m=a+8*(_*d+p);h[0]=n[m]|n[m+1]<<8,h[1]=n[m+2]|n[m+3]<<8,h[2]=(2*(h[0]&31)+1*(h[1]&31))/3|(2*(h[0]&2016)+1*(h[1]&2016))/3&2016|(2*(h[0]&63488)+1*(h[1]&63488))/3&63488,h[3]=(2*(h[1]&31)+1*(h[0]&31))/3|(2*(h[1]&2016)+1*(h[0]&2016))/3&2016|(2*(h[1]&63488)+1*(h[0]&63488))/3&63488;for(let T=0;T<4;T++){const b=n[m+4+T];let y=(_*4+T)*l+p*4;u[y++]=h[b&3],u[y++]=h[b>>2&3],u[y++]=h[b>>4&3],u[y++]=h[b>>6&3]}}return u}}Object.defineProperty(Vm,"JSModuleURL",{get:function(){return Ul.JSModuleURL},set:function(o){Ul.JSModuleURL=o}});Object.defineProperty(Vm,"WasmModuleURL",{get:function(){return Ul.WasmModuleURL},set:function(o){Ul.WasmModuleURL=o}});class aN{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".basis")}loadCubeData(e,t,i,r,s){if(Array.isArray(e))return;const n=t.getEngine().getCaps(),a={supportedCompressionFormats:{etc1:!!n.etc1,s3tc:!!n.s3tc,pvrtc:!!n.pvrtc,etc2:!!n.etc2,astc:!!n.astc,bc7:!!n.bptc}};tp(e,a).then(l=>{const c=l.fileInfo.images[0].levels.length>1&&t.generateMipMaps;ip(t,l),t.getEngine()._setCubeMapTextureParams(t,c),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r()}).catch(l=>{const c="Failed to transcode Basis file, transcoding may not be supported on this device";J.Warn(c),t.isReady=!0,s&&s(l)})}loadData(e,t,i){const r=t.getEngine().getCaps(),s={supportedCompressionFormats:{etc1:!!r.etc1,s3tc:!!r.s3tc,pvrtc:!!r.pvrtc,etc2:!!r.etc2,astc:!!r.astc,bc7:!!r.bptc}};tp(e,s).then(n=>{const a=n.fileInfo.images[0].levels[0],l=n.fileInfo.images[0].levels.length>1&&t.generateMipMaps;i(a.width,a.height,l,n.format!==-1,()=>{ip(t,n)})}).catch(n=>{J.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),J.Warn(`Failed to transcode Basis file: ${n}`),i(0,0,!1,!1,()=>{},!0)})}}q._TextureLoaders.push(new aN);class tc extends Zi{get isSupported(){var e,t;return(t=(e=this._engine)===null||e===void 0?void 0:e.getCaps().drawBuffersExtension)!==null&&t!==void 0?t:!1}get textures(){return this._textures}get count(){return this._count}get depthTexture(){return this._textures[this._textures.length-1]}set wrapU(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapU=e}set wrapV(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapV=e}constructor(e,t,i,r,s,n){const a=s&&s.generateMipMaps?s.generateMipMaps:!1,l=s&&s.generateDepthTexture?s.generateDepthTexture:!1,c=s&&s.depthTextureFormat?s.depthTextureFormat:15,h=!s||s.doNotChangeAspectRatio===void 0?!0:s.doNotChangeAspectRatio,u=s&&s.drawOnlyOnFirstAttachmentByDefault?s.drawOnlyOnFirstAttachmentByDefault:!1;if(super(e,t,r,a,h,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0),!this.isSupported){this.dispose();return}const d=[],f=[],_=[];this._initTypes(i,d,f,_,s);const p=!s||s.generateDepthBuffer===void 0?!0:s.generateDepthBuffer,m=!s||s.generateStencilBuffer===void 0?!1:s.generateStencilBuffer;this._size=t,this._multiRenderTargetOptions={samplingModes:f,generateMipMaps:a,generateDepthBuffer:p,generateStencilBuffer:m,generateDepthTexture:l,depthTextureFormat:c,types:d,textureCount:i,useSRGBBuffers:_},this._count=i,this._drawOnlyOnFirstAttachmentByDefault=u,i>0&&(this._createInternalTextures(),this._createTextures(n))}_initTypes(e,t,i,r,s){for(let n=0;n<e;n++)s&&s.types&&s.types[n]!==void 0?t.push(s.types[n]):t.push(s&&s.defaultType?s.defaultType:0),s&&s.samplingModes&&s.samplingModes[n]!==void 0?i.push(s.samplingModes[n]):i.push(Y.BILINEAR_SAMPLINGMODE),s&&s.useSRGBBuffers&&s.useSRGBBuffers[n]!==void 0?r.push(s.useSRGBBuffers[n]):r.push(!1)}_rebuild(e=!1,t){if(this._count<1)return;this.releaseInternalTextures(),this._createInternalTextures(),e&&(this._releaseTextures(),this._createTextures(t));const i=this._renderTarget.textures;for(let r=0;r<i.length;r++){const s=this._textures[r];s._texture=i[r]}this.samples!==1&&this._renderTarget.setSamples(this.samples,!this._drawOnlyOnFirstAttachmentByDefault,!0)}_createInternalTextures(){this._renderTarget=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._renderTarget.texture}_releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;e++)this._textures[e]._texture=null,this._textures[e].dispose()}_createTextures(e){const t=this._renderTarget.textures;this._textures=[];for(let i=0;i<t.length;i++){const r=new Y(null,this.getScene());e!=null&&e[i]&&(r.name=e[i]),r._texture=t[i],this._textures.push(r)}}setInternalTexture(e,t,i=!0){this.renderTarget&&(t===0&&(this._texture=e),this.renderTarget.setTexture(e,t,i),this.textures[t]||(this.textures[t]=new Y(null,this.getScene())),this.textures[t]._texture=e,this._count=this.renderTarget.textures?this.renderTarget.textures.length:0,this._multiRenderTargetOptions.types&&(this._multiRenderTargetOptions.types[t]=e.type),this._multiRenderTargetOptions.samplingModes&&(this._multiRenderTargetOptions.samplingModes[t]=e.samplingMode),this._multiRenderTargetOptions.useSRGBBuffers&&(this._multiRenderTargetOptions.useSRGBBuffers[t]=e._useSRGBBuffer))}get samples(){return this._samples}set samples(e){this._renderTarget?this._samples=this._renderTarget.setSamples(e):this._samples=e}resize(e){this._size=e,this._rebuild()}updateCount(e,t,i){this._multiRenderTargetOptions.textureCount=e,this._count=e;const r=[],s=[],n=[];this._initTypes(e,r,s,n,t),this._multiRenderTargetOptions.types=r,this._multiRenderTargetOptions.samplingModes=s,this._multiRenderTargetOptions.useSRGBBuffers=n,this._rebuild(!0,i)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindMultiColorAttachmentFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}dispose(e=!1){this._releaseTextures(),e?this._texture=null:this.releaseInternalTextures(),super.dispose()}releaseInternalTextures(){var e,t;const i=(e=this._renderTarget)===null||e===void 0?void 0:e.textures;if(i){for(let r=i.length-1;r>=0;r--)this._textures[r]._texture=null;(t=this._renderTarget)===null||t===void 0||t.dispose(),this._renderTarget=null}}}const oN="noisePixelShader",lN=`uniform float brightness;
uniform float persistence;
uniform float timeScale;
varying vec2 vUV;
vec2 hash22(vec2 p)
{
p=p*mat2(127.1,311.7,269.5,183.3);
p=-1.0+2.0*fract(sin(p)*43758.5453123);
return sin(p*6.283+timeScale);
}
float interpolationNoise(vec2 p)
{
vec2 pi=floor(p);
vec2 pf=p-pi;
vec2 w=pf*pf*(3.-2.*pf);
float f00=dot(hash22(pi+vec2(.0,.0)),pf-vec2(.0,.0));
float f01=dot(hash22(pi+vec2(.0,1.)),pf-vec2(.0,1.));
float f10=dot(hash22(pi+vec2(1.0,0.)),pf-vec2(1.0,0.));
float f11=dot(hash22(pi+vec2(1.0,1.)),pf-vec2(1.0,1.));
float xm1=mix(f00,f10,w.x);
float xm2=mix(f01,f11,w.x);
float ym=mix(xm1,xm2,w.y); 
return ym;
}
float perlinNoise2D(float x,float y)
{
float sum=0.0;
float frequency=0.0;
float amplitude=0.0;
for(int i=0; i<OCTAVES; i++)
{
frequency=pow(2.0,float(i));
amplitude=pow(persistence,float(i));
sum=sum+interpolationNoise(vec2(x*frequency,y*frequency))*amplitude;
}
return sum;
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
float x=abs(vUV.x);
float y=abs(vUV.y);
float noise=brightness+(1.0-brightness)*perlinNoise2D(x,y);
gl_FragColor=vec4(noise,noise,noise,1.0);
}
`;te.ShadersStore[oN]=lN;class rf extends bo{constructor(e,t=256,i=qe.LastCreatedScene,r,s){super(e,t,"noise",i,r,s),this.time=0,this.brightness=.2,this.octaves=3,this.persistence=.8,this.animationSpeedFactor=1,this.autoClear=!1,this._updateShaderUniforms()}_updateShaderUniforms(){const e=this.getScene();e&&(this.time+=e.getAnimationRatio()*this.animationSpeedFactor*.01,this.setFloat("brightness",this.brightness),this.setFloat("persistence",this.persistence),this.setFloat("timeScale",this.time))}_getDefines(){return"#define OCTAVES "+(this.octaves|0)}render(e){this._updateShaderUniforms(),super.render(e)}serialize(){const e={};return e.customType="BABYLON.NoiseProceduralTexture",e.brightness=this.brightness,e.octaves=this.octaves,e.persistence=this.persistence,e.animationSpeedFactor=this.animationSpeedFactor,e.size=this.getSize().width,e.generateMipMaps=this._generateMipMaps,e.time=this.time,e}clone(){const e=this.getSize(),t=new rf(this.name,e.width,this.getScene(),this._fallbackTexture?this._fallbackTexture:void 0,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t.brightness=this.brightness,t.octaves=this.octaves,t.persistence=this.persistence,t.animationSpeedFactor=this.animationSpeedFactor,t.time=this.time,t}static Parse(e,t){var i;const r=new rf(e.name,e.size,t,void 0,e.generateMipMaps);return r.brightness=e.brightness,r.octaves=e.octaves,r.persistence=e.persistence,r.animationSpeedFactor=e.animationSpeedFactor,r.time=(i=e.time)!==null&&i!==void 0?i:0,r}}ye("BABYLON.NoiseProceduralTexture",rf);class km extends ns{constructor(e,t,i,r=5,s=0,n=!1,a=!1,l=3,c=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,i,r,s,n,a,l,c)}update(e,t,i,r,s=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,i,r,s)}updateRGBDAsync(e,t=null,i=.8,r=0){return ER(this._texture,e,t,i,r).then(()=>{})}clone(){return ke.Clone(()=>{const e=this.getScene(),t=this._texture,i=new km(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return t.source===bt.CubeRawRGBD&&i.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),i},this)}}class Rr extends nh{constructor(e,t,i,r,s){super(e,t,i),this._blockType=r,this._blockName=s,this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof Rr&&e._blockName===this._blockName?sa.Compatible:sa.TypeIncompatible}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}}class cN extends rt{constructor(e){super(e,W.Vertex),this.registerInput("matricesIndices",N.Vector4),this.registerInput("matricesWeights",N.Vector4),this.registerInput("matricesIndicesExtra",N.Vector4,!0),this.registerInput("matricesWeightsExtra",N.Vector4,!0),this.registerInput("world",N.Matrix),this.registerOutput("output",N.Matrix)}initialize(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh")}getClassName(){return"BonesBlock"}get matricesIndices(){return this._inputs[0]}get matricesWeights(){return this._inputs[1]}get matricesIndicesExtra(){return this._inputs[2]}get matricesWeightsExtra(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.matricesIndices.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="matricesIndices");t||(t=new yt("matricesIndices"),t.setAsAttribute("matricesIndices")),t.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="matricesWeights");t||(t=new yt("matricesWeights"),t.setAsAttribute("matricesWeights")),t.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Rt.World);t||(t=new yt("world"),t.setAsSystemValue(Rt.World)),t.output.connectTo(this.world)}}provideFallbacks(e,t){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&t.addCPUSkinningFallback(0,e)}bind(e,t,i){Ce.BindBonesParameters(i,e)}prepareDefines(e,t,i){i._areAttributesDirty&&Ce.PrepareDefinesForBones(e,i)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");const t=`//${this.name}`;e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});const i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});const r=this._outputs[0],s=this.world;return e.compilationString+=`#if NUM_BONE_INFLUENCERS>0\r
`,e.compilationString+=this._declareOutput(r,e)+` = ${s.associatedVariableName} * ${i};\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(r,e)+` = ${s.associatedVariableName};\r
`,e.compilationString+=`#endif\r
`,this}}ye("BABYLON.BonesBlock",cN);class hN extends rt{constructor(e){super(e,W.Vertex),this.registerInput("world0",N.Vector4),this.registerInput("world1",N.Vector4),this.registerInput("world2",N.Vector4),this.registerInput("world3",N.Vector4),this.registerInput("world",N.Matrix,!0),this.registerOutput("output",N.Matrix),this.registerOutput("instanceID",N.Float)}getClassName(){return"InstancesBlock"}get world0(){return this._inputs[0]}get world1(){return this._inputs[1]}get world2(){return this._inputs[2]}get world3(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}get instanceID(){return this._outputs[1]}autoConfigure(e){if(!this.world0.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="world0");t||(t=new yt("world0"),t.setAsAttribute("world0")),t.output.connectTo(this.world0)}if(!this.world1.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="world1");t||(t=new yt("world1"),t.setAsAttribute("world1")),t.output.connectTo(this.world1)}if(!this.world2.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="world2");t||(t=new yt("world2"),t.setAsAttribute("world2")),t.output.connectTo(this.world2)}if(!this.world3.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="world3");t||(t=new yt("world3"),t.setAsAttribute("world3")),t.output.connectTo(this.world3)}if(!this.world.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="world");t||(t=new yt("world"),t.setAsSystemValue(Rt.World)),t.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"}prepareDefines(e,t,i,r=!1,s){let n=!1;i.INSTANCES!==r&&(i.setValue("INSTANCES",r),n=!0),s&&i.THIN_INSTANCES!==!!(s!=null&&s.getRenderingMesh().hasThinInstances)&&(i.setValue("THIN_INSTANCES",!!(s!=null&&s.getRenderingMesh().hasThinInstances)),n=!0),n&&i.markAsUnprocessed()}_buildBlock(e){super._buildBlock(e);const t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);const i=this._outputs[0],r=this._outputs[1],s=this.world0,n=this.world1,a=this.world2,l=this.world3;return e.compilationString+=`#ifdef INSTANCES\r
`,e.compilationString+=this._declareOutput(i,e)+` = mat4(${s.associatedVariableName}, ${n.associatedVariableName}, ${a.associatedVariableName}, ${l.associatedVariableName});\r
`,e.compilationString+=`#ifdef THIN_INSTANCES\r
`,e.compilationString+=`${i.associatedVariableName} = ${this.world.associatedVariableName} * ${i.associatedVariableName};\r
`,e.compilationString+=`#endif\r
`,t._caps.canUseGLInstanceID?e.compilationString+=this._declareOutput(r,e)+` = float(gl_InstanceID);\r
`:e.compilationString+=this._declareOutput(r,e)+` = 0.0;\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(i,e)+` = ${this.world.associatedVariableName};\r
`,e.compilationString+=this._declareOutput(r,e)+` = 0.0;\r
`,e.compilationString+=`#endif\r
`,this}}ye("BABYLON.InstancesBlock",hN);class uN extends rt{constructor(e){super(e,W.Vertex),this.registerInput("position",N.Vector3),this.registerInput("normal",N.Vector3),this.registerInput("tangent",N.AutoDetect),this.tangent.addExcludedConnectionPointFromAllowedTypes(N.Color4|N.Vector4|N.Vector3),this.registerInput("uv",N.Vector2),this.registerOutput("positionOutput",N.Vector3),this.registerOutput("normalOutput",N.Vector3),this.registerOutput("tangentOutput",N.Vector4),this.registerOutput("uvOutput",N.Vector2)}getClassName(){return"MorphTargetsBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get tangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get positionOutput(){return this._outputs[0]}get normalOutput(){return this._outputs[1]}get tangentOutput(){return this._outputs[2]}get uvOutput(){return this._outputs[3]}initialize(e){e._excludeVariableName("morphTargetInfluences")}autoConfigure(e){if(!this.position.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="position");t||(t=new yt("position"),t.setAsAttribute()),t.output.connectTo(this.position)}if(!this.normal.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="normal");t||(t=new yt("normal"),t.setAsAttribute("normal")),t.output.connectTo(this.normal)}if(!this.tangent.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="tangent");t||(t=new yt("tangent"),t.setAsAttribute("tangent")),t.output.connectTo(this.tangent)}if(!this.uv.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="uv");t||(t=new yt("uv"),t.setAsAttribute("uv")),t.output.connectTo(this.uv)}}prepareDefines(e,t,i){if(e.morphTargetManager){const r=e.morphTargetManager;r!=null&&r.isUsingTextureForTargets&&r.numInfluencers!==i.NUM_MORPH_INFLUENCERS&&i.markAsAttributesDirty()}i._areAttributesDirty&&Ce.PrepareDefinesForMorphTargets(e,i)}bind(e,t,i){i&&i.morphTargetManager&&i.morphTargetManager.numInfluencers>0&&(Ce.BindMorphTargetParameters(i,e),i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(e))}replaceRepeatableContent(e,t,i,r){const s=this.position,n=this.normal,a=this.tangent,l=this.uv,c=this.positionOutput,h=this.normalOutput,u=this.tangentOutput,d=this.uvOutput,f=e,_=r.NUM_MORPH_INFLUENCERS,p=i.morphTargetManager,m=p&&p.supportsNormals&&r.NORMAL,T=p&&p.supportsTangents&&r.TANGENT,b=p&&p.supportsUVs&&r.UV1;let y="";p!=null&&p.isUsingTextureForTargets&&_>0&&(y+=`float vertexID;\r
`);for(let S=0;S<_;S++)y+=`#ifdef MORPHTARGETS\r
`,p!=null&&p.isUsingTextureForTargets?(y+=`vertexID = float(gl_VertexID) * morphTargetTextureInfo.x;\r
`,y+=`${c.associatedVariableName} += (readVector3FromRawSampler(${S}, vertexID) - ${s.associatedVariableName}) * morphTargetInfluences[${S}];\r
`,y+=`vertexID += 1.0;\r
`):y+=`${c.associatedVariableName} += (position${S} - ${s.associatedVariableName}) * morphTargetInfluences[${S}];\r
`,m&&(y+=`#ifdef MORPHTARGETS_NORMAL\r
`,p!=null&&p.isUsingTextureForTargets?(y+=`${h.associatedVariableName} += (readVector3FromRawSampler(${S}, vertexID) - ${n.associatedVariableName}) * morphTargetInfluences[${S}];\r
`,y+=`vertexID += 1.0;\r
`):y+=`${h.associatedVariableName} += (normal${S} - ${n.associatedVariableName}) * morphTargetInfluences[${S}];\r
`,y+=`#endif\r
`),b&&(y+=`#ifdef MORPHTARGETS_UV\r
`,p!=null&&p.isUsingTextureForTargets?(y+=`${d.associatedVariableName} += (readVector3FromRawSampler(${S}, vertexID).xy - ${l.associatedVariableName}) * morphTargetInfluences[${S}];\r
`,y+=`vertexID += 1.0;\r
`):y+=`${d.associatedVariableName}.xy += (uv_${S} - ${l.associatedVariableName}.xy) * morphTargetInfluences[${S}];\r
`,y+=`#endif\r
`),T&&(y+=`#ifdef MORPHTARGETS_TANGENT\r
`,p!=null&&p.isUsingTextureForTargets?y+=`${u.associatedVariableName}.xyz += (readVector3FromRawSampler(${S}, vertexID) - ${a.associatedVariableName}.xyz) * morphTargetInfluences[${S}];\r
`:y+=`${u.associatedVariableName}.xyz += (tangent${S} - ${a.associatedVariableName}.xyz) * morphTargetInfluences[${S}];\r
`,a.type===N.Vector4?y+=`${u.associatedVariableName}.w = ${a.associatedVariableName}.w;\r
`:y+=`${u.associatedVariableName}.w = 1.;\r
`,y+=`#endif\r
`),y+=`#endif\r
`;if(f.compilationString=f.compilationString.replace(this._repeatableContentAnchor,y),_>0)for(let S=0;S<_;S++)f.attributes.push(O.PositionKind+S),m&&f.attributes.push(O.NormalKind+S),T&&f.attributes.push(O.TangentKind+S),b&&f.attributes.push(O.UVKind+"_"+S)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);const t=this.position,i=this.normal,r=this.tangent,s=this.uv,n=this.positionOutput,a=this.normalOutput,l=this.tangentOutput,c=this.uvOutput,h=`//${this.name}`;return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",h),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",h,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+=`${this._declareOutput(n,e)} = ${t.associatedVariableName};\r
`,e.compilationString+=`#ifdef NORMAL\r
`,e.compilationString+=`${this._declareOutput(a,e)} = ${i.associatedVariableName};\r
`,e.compilationString+=`#else\r
`,e.compilationString+=`${this._declareOutput(a,e)} = vec3(0., 0., 0.);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef TANGENT\r
`,e.compilationString+=`${this._declareOutput(l,e)} = ${r.associatedVariableName};\r
`,e.compilationString+=`#else\r
`,e.compilationString+=`${this._declareOutput(l,e)} = vec4(0., 0., 0., 0.);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef UV1\r
`,e.compilationString+=`${this._declareOutput(c,e)} = ${s.associatedVariableName};\r
`,e.compilationString+=`#else\r
`,e.compilationString+=`${this._declareOutput(c,e)} = vec2(0., 0.);\r
`,e.compilationString+=`#endif\r
`,this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this}}ye("BABYLON.MorphTargetsBlock",uN);class dN extends rt{constructor(e){super(e,W.Vertex),this.registerInput("worldPosition",N.Vector4,!1,W.Vertex),this.registerOutput("direction",N.Vector3),this.registerOutput("color",N.Color3),this.registerOutput("intensity",N.Float),this.registerOutput("shadowBias",N.Float),this.registerOutput("shadowNormalBias",N.Float),this.registerOutput("shadowDepthScale",N.Float),this.registerOutput("shadowDepthRange",N.Vector2)}getClassName(){return"LightInformationBlock"}get worldPosition(){return this._inputs[0]}get direction(){return this._outputs[0]}get color(){return this._outputs[1]}get intensity(){return this._outputs[2]}get shadowBias(){return this._outputs[3]}get shadowNormalBias(){return this._outputs[4]}get shadowDepthScale(){return this._outputs[5]}get shadowDepthRange(){return this._outputs[6]}bind(e,t,i){if(!i)return;this.light&&this.light.isDisposed()&&(this.light=null);let r=this.light;const s=t.getScene();if(!r&&s.lights.length&&(r=this.light=s.lights[0],this._forcePrepareDefines=!0),!r||!r.isEnabled){e.setFloat3(this._lightDataUniformName,0,0,0),e.setFloat4(this._lightColorUniformName,0,0,0,0);return}r.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,r.diffuse,r.intensity);const n=r.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(n?e.setFloat3(this._lightShadowUniformName,n.bias,n.normalBias,n.depthScale):e.setFloat3(this._lightShadowUniformName,0,0,0)),this.shadowDepthRange)if(n&&s.activeCamera){const a=r;e.setFloat2(this._lightShadowExtraUniformName,a.getDepthMinZ(s.activeCamera),a.getDepthMinZ(s.activeCamera)+a.getDepthMaxZ(s.activeCamera))}else e.setFloat2(this._lightShadowExtraUniformName,0,0)}prepareDefines(e,t,i){if(!i._areLightsDirty&&!this._forcePrepareDefines)return;this._forcePrepareDefines=!1;const r=this.light;i.setValue(this._lightTypeDefineName,!!(r&&r instanceof Bl),!0)}_buildBlock(e){super._buildBlock(e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=this.direction,i=this.color,r=this.intensity,s=this.shadowBias,n=this.shadowNormalBias,a=this.shadowDepthScale,l=this.shadowDepthRange;return this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightShadowUniformName=e._getFreeVariableName("shadowData"),this._lightShadowExtraUniformName=e._getFreeVariableName("shadowExtraData"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE"),e._emitUniformFromString(this._lightDataUniformName,"vec3"),e._emitUniformFromString(this._lightColorUniformName,"vec4"),e.compilationString+=`#ifdef ${this._lightTypeDefineName}\r
`,e.compilationString+=this._declareOutput(t,e)+` = normalize(${this.worldPosition.associatedVariableName}.xyz - ${this._lightDataUniformName});\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(t,e)+` = ${this._lightDataUniformName};\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=this._declareOutput(i,e)+` = ${this._lightColorUniformName}.rgb;\r
`,e.compilationString+=this._declareOutput(r,e)+` = ${this._lightColorUniformName}.a;\r
`,(s.hasEndpoints||n.hasEndpoints||a.hasEndpoints)&&(e._emitUniformFromString(this._lightShadowUniformName,"vec3"),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+` = ${this._lightShadowUniformName}.x;\r
`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${this._lightShadowUniformName}.y;\r
`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${this._lightShadowUniformName}.z;\r
`)),l.hasEndpoints&&(e._emitUniformFromString(this._lightShadowExtraUniformName,"vec2"),e.compilationString+=this._declareOutput(l,e)+` = ${this._lightShadowUniformName};\r
`),this}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))}}ye("BABYLON.LightInformationBlock",dN);class TE extends rt{constructor(e){super(e,W.Fragment),this.convertInputToLinearSpace=!0,this.registerInput("color",N.AutoDetect),this.registerOutput("output",N.Color4),this.registerOutput("rgb",N.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(N.Color3|N.Color4|N.Vector3|N.Vector4)}getClassName(){return"ImageProcessingBlock"}get color(){return this._inputs[0]}get output(){return this._outputs[0]}get rgb(){return this._outputs[1]}initialize(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings"),e._excludeVariableName("ditherIntensity")}isReady(e,t,i){return!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}prepareDefines(e,t,i){i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i)}bind(e,t,i){i&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_buildBlock(e){var t;super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity");const i=this.color,r=this._outputs[0],s=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",s),e._emitFunctionFromInclude("imageProcessingDeclaration",s),e._emitFunctionFromInclude("imageProcessingFunctions",s),!((t=i.connectedPoint)===null||t===void 0)&&t.isConnected&&(i.connectedPoint.type===N.Color4||i.connectedPoint.type===N.Vector4?e.compilationString+=`${this._declareOutput(r,e)} = ${i.associatedVariableName};\r
`:e.compilationString+=`${this._declareOutput(r,e)} = vec4(${i.associatedVariableName}, 1.0);\r
`,e.compilationString+=`#ifdef IMAGEPROCESSINGPOSTPROCESS\r
`,this.convertInputToLinearSpace&&(e.compilationString+=`${r.associatedVariableName}.rgb = toLinearSpace(${i.associatedVariableName}.rgb);\r
`),e.compilationString+=`#else\r
`,e.compilationString+=`#ifdef IMAGEPROCESSING\r
`,this.convertInputToLinearSpace&&(e.compilationString+=`${r.associatedVariableName}.rgb = toLinearSpace(${i.associatedVariableName}.rgb);\r
`),e.compilationString+=`${r.associatedVariableName} = applyImageProcessing(${r.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#endif\r
`,this.rgb.hasEndpoints&&(e.compilationString+=this._declareOutput(this.rgb,e)+` = ${this.output.associatedVariableName}.xyz;\r
`)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertInputToLinearSpace = ${this.convertInputToLinearSpace};\r
`,e}serialize(){const e=super.serialize();return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e}_deserialize(e,t,i){var r;super._deserialize(e,t,i),this.convertInputToLinearSpace=(r=e.convertInputToLinearSpace)!==null&&r!==void 0?r:!0}}M([Xt("Convert input to linear space",zt.Boolean,"ADVANCED")],TE.prototype,"convertInputToLinearSpace",void 0);ye("BABYLON.ImageProcessingBlock",TE);class bh extends rt{constructor(e){super(e,W.Fragment,!0),this.registerInput("normal",N.AutoDetect,!1),this.normal.addExcludedConnectionPointFromAllowedTypes(N.Color4|N.Vector4|N.Vector3),this.registerInput("tangent",N.Vector4,!1),this.registerInput("world",N.Matrix,!1),this.registerOutput("TBN",N.Object,W.Fragment,new Rr("TBN",this,nr.Output,bh,"TBNBlock")),this.registerOutput("row0",N.Vector3,W.Fragment),this.registerOutput("row1",N.Vector3,W.Fragment),this.registerOutput("row2",N.Vector3,W.Fragment)}getClassName(){return"TBNBlock"}initialize(e){e._excludeVariableName("tbnNormal"),e._excludeVariableName("tbnTangent"),e._excludeVariableName("tbnBitangent"),e._excludeVariableName("TBN")}get normal(){return this._inputs[0]}get tangent(){return this._inputs[1]}get world(){return this._inputs[2]}get TBN(){return this._outputs[0]}get row0(){return this._outputs[1]}get row1(){return this._outputs[2]}get row2(){return this._outputs[3]}get target(){return W.Fragment}set target(e){}autoConfigure(e){if(!this.world.isConnected){let t=e.getInputBlockByPredicate(i=>i.isSystemValue&&i.systemValue===Rt.World);t||(t=new yt("world"),t.setAsSystemValue(Rt.World)),t.output.connectTo(this.world)}if(!this.normal.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="normal");t||(t=new yt("normal"),t.setAsAttribute("normal")),t.output.connectTo(this.normal)}if(!this.tangent.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="tangent"&&i.type===N.Vector4);t||(t=new yt("tangent"),t.setAsAttribute("tangent")),t.output.connectTo(this.tangent)}}prepareDefines(e,t,i){var r,s,n,a;const l=this.normal,c=this.tangent;let h=l.isConnected;!((r=l.connectInputBlock)===null||r===void 0)&&r.isAttribute&&!e.isVerticesDataPresent((s=l.connectInputBlock)===null||s===void 0?void 0:s.name)&&(h=!1);let u=c.isConnected;!((n=c.connectInputBlock)===null||n===void 0)&&n.isAttribute&&!e.isVerticesDataPresent((a=c.connectInputBlock)===null||a===void 0?void 0:a.name)&&(u=!1);const d=h&&u;i.setValue("TBNBLOCK",d,!0)}_buildBlock(e){super._buildBlock(e);const t=this.normal,i=this.tangent,r=this.world,s=this.TBN,n=this.row0,a=this.row1,l=this.row2;return e.target===W.Fragment&&(e.compilationString+=`
                // ${this.name}
                vec3 tbnNormal = normalize(${t.associatedVariableName}).xyz;
                vec3 tbnTangent = normalize(${i.associatedVariableName}.xyz);
                vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${i.associatedVariableName}.w;
                mat3 ${s.associatedVariableName} = mat3(${r.associatedVariableName}) * mat3(tbnTangent, tbnBitangent, tbnNormal);
            `,n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = vec3(${s.associatedVariableName}[0][0], ${s.associatedVariableName}[0][1], ${s.associatedVariableName}[0][2]);\r
`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = vec3(${s.associatedVariableName}[1[0], ${s.associatedVariableName}[1][1], ${s.associatedVariableName}[1][2]);\r
`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = vec3(${s.associatedVariableName}[2][0], ${s.associatedVariableName}[2][1], ${s.associatedVariableName}[2][2]);\r
`),e.sharedData.blocksWithDefines.push(this)),this}}ye("BABYLON.TBNBlock",bh);class $u extends rt{constructor(e){super(e,W.Fragment),this._tangentSpaceParameterName="",this._tangentCorrectionFactorName="",this._worldMatrixName="",this.invertX=!1,this.invertY=!1,this.useParallaxOcclusion=!1,this.useObjectSpaceNormalMap=!1,this._isUnique=!0,this.registerInput("worldPosition",N.Vector4,!1),this.registerInput("worldNormal",N.Vector4,!1),this.registerInput("worldTangent",N.Vector4,!0),this.registerInput("uv",N.Vector2,!1),this.registerInput("normalMapColor",N.Color3,!1),this.registerInput("strength",N.Float,!1),this.registerInput("viewDirection",N.Vector3,!0),this.registerInput("parallaxScale",N.Float,!0),this.registerInput("parallaxHeight",N.Float,!0),this.registerInput("TBN",N.Object,!0,W.VertexAndFragment,new Rr("TBN",this,nr.Input,bh,"TBNBlock")),this.registerInput("world",N.Matrix,!0),this.registerOutput("output",N.Vector4),this.registerOutput("uvOffset",N.Vector2)}getClassName(){return"PerturbNormalBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get worldTangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get normalMapColor(){return this._inputs[4]}get strength(){return this._inputs[5]}get viewDirection(){return this._inputs[6]}get parallaxScale(){return this._inputs[7]}get parallaxHeight(){return this._inputs[8]}get TBN(){return this._inputs[9]}get world(){return this._inputs[10]}get output(){return this._outputs[0]}get uvOffset(){return this._outputs[1]}prepareDefines(e,t,i){const r=this.normalMapColor.connectedPoint._ownerBlock.samplerName,s=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&r||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);i.setValue("BUMP",!0),i.setValue("PARALLAX",s,!0),i.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0),i.setValue("OBJECTSPACE_NORMALMAP",this.useObjectSpaceNormalMap,!0)}bind(e,t,i){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1),i&&(e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1),this.useObjectSpaceNormalMap&&!this.world.isConnected&&e.setMatrix(this._worldMatrixName,i.getWorldMatrix()))}autoConfigure(e){if(!this.uv.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="uv");t||(t=new yt("uv"),t.setAsAttribute()),t.output.connectTo(this.uv)}if(!this.strength.isConnected){const t=new yt("strength");t.value=1,t.output.connectTo(this.strength)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=this.uv,r=this.worldPosition,s=this.worldNormal,n=this.worldTangent;e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,"vec2"),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float"),this._worldMatrixName=e._getFreeDefineName("perturbNormalWorldMatrix"),e._emitUniformFromString(this._worldMatrixName,"mat4");let a=null;this.normalMapColor.connectedPoint&&(a=this.normalMapColor.connectedPoint._ownerBlock.samplerName);const l=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&a||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),c=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",h=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`\r
#if !defined(NORMALXYSCALE)\r
1.0/\r
#endif\r
${e._emitFloat(this.strength.connectInputBlock.value)}`:`\r
#if !defined(NORMALXYSCALE)\r
1.0/\r
#endif\r
${this.strength.associatedVariableName}`;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const u={search:/defined\(TANGENT\)/g,replace:n.isConnected?"defined(TANGENT)":"defined(IGNORE)"},d={search:/varying mat3 vTBN/g,replace:""},f={search:/uniform mat4 normalMatrix;/g,replace:""},_=this.TBN;_.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            mat3 vTBN = ${_.associatedVariableName};
            #endif
            `:n.isConnected&&(e.compilationString+=`vec3 tbnNormal = normalize(${s.associatedVariableName}.xyz);\r
`,e.compilationString+=`vec3 tbnTangent = normalize(${n.associatedVariableName}.xyz);\r
`,e.compilationString+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\r
`,e.compilationString+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:[u,d,f]}),e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,replace:`#define inline\r
vec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)`},{search:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g,replace:"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)"},{search:/texture2D\(bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});const p=!l||!a?this.normalMapColor.associatedVariableName:`texture2D(${a}, ${i.associatedVariableName} + uvOffset).xyz`;return e.compilationString+=this._declareOutput(this.output,e)+` = vec4(0.);\r
`,e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:[{search:/texture2D\(bumpSampler,vBumpUV\)/g,replace:`${p}`},{search:/#define CUSTOM_FRAGMENT_BUMP_FRAGMENT/g,replace:`mat4 normalMatrix = toNormalMatrix(${this.world.isConnected?this.world.associatedVariableName:this._worldMatrixName});`},{search:/perturbNormal\(TBN,texture2D\(bumpSampler,vBumpUV\+uvOffset\).xyz,vBumpInfos.y\)/g,replace:`perturbNormal(TBN, ${p}, vBumpInfos.y)`},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:`parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${l&&this.useParallaxOcclusion?a:"bumpSampler"})`},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:`parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${l?this.parallaxHeight.associatedVariableName:"0."})`},{search:/vTangentSpaceParams/g,replace:this._tangentSpaceParameterName},{search:/vBumpInfos.y/g,replace:h},{search:/vBumpInfos.z/g,replace:c},{search:/vBumpUV/g,replace:i.associatedVariableName},{search:/vPositionW/g,replace:r.associatedVariableName+".xyz"},{search:/normalW=/g,replace:this.output.associatedVariableName+".xyz = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:"mat3(normalMatrix) * "+this.output.associatedVariableName+".xyz"},{search:/normalW/g,replace:s.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:l?this.viewDirection.associatedVariableName:"vec3(0.)"},u]}),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.invertX = ${this.invertX};\r
`;return e+=`${this._codeVariableName}.invertY = ${this.invertY};\r
`,e+=`${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};\r
`,e+=`${this._codeVariableName}.useObjectSpaceNormalMap = ${this.useObjectSpaceNormalMap};\r
`,e}serialize(){const e=super.serialize();return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e.useObjectSpaceNormalMap=this.useObjectSpaceNormalMap,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion,this.useObjectSpaceNormalMap=!!e.useObjectSpaceNormalMap}}M([Xt("Invert X axis",zt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],$u.prototype,"invertX",void 0);M([Xt("Invert Y axis",zt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],$u.prototype,"invertY",void 0);M([Xt("Use parallax occlusion",zt.Boolean)],$u.prototype,"useParallaxOcclusion",void 0);M([Xt("Object Space Mode",zt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],$u.prototype,"useObjectSpaceNormalMap",void 0);ye("BABYLON.PerturbNormalBlock",$u);class fN extends rt{constructor(e){super(e,W.Fragment,!0),this.registerInput("value",N.Float,!0),this.registerInput("cutoff",N.Float,!0)}getClassName(){return"DiscardBlock"}get value(){return this._inputs[0]}get cutoff(){return this._inputs[1]}_buildBlock(e){if(super._buildBlock(e),e.sharedData.hints.needAlphaTesting=!0,!(!this.cutoff.isConnected||!this.value.isConnected))return e.compilationString+=`if (${this.value.associatedVariableName} < ${this.cutoff.associatedVariableName}) discard;\r
`,this}}ye("BABYLON.DiscardBlock",fN);class _N extends rt{constructor(e){super(e,W.Fragment),this.registerOutput("output",N.Float,W.Fragment)}getClassName(){return"FrontFacingBlock"}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),e.target===W.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = gl_FrontFacing ? 1.0 : 0.0;\r
`,this}}ye("BABYLON.FrontFacingBlock",_N);class pN extends rt{constructor(e){super(e,W.Fragment),this.registerInput("input",N.AutoDetect,!1),this.registerOutput("dx",N.BasedOnInput),this.registerOutput("dy",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[1]._typeConnectionSource=this._inputs[0]}getClassName(){return"DerivativeBlock"}get input(){return this._inputs[0]}get dx(){return this._outputs[0]}get dy(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1];return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),t.hasEndpoints&&(e.compilationString+=this._declareOutput(t,e)+` = dFdx(${this.input.associatedVariableName});\r
`),i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+` = dFdy(${this.input.associatedVariableName});\r
`),this}}ye("BABYLON.DerivativeBlock",pN);class mN extends rt{constructor(e){super(e,W.Fragment),this.registerOutput("xy",N.Vector2,W.Fragment),this.registerOutput("xyz",N.Vector3,W.Fragment),this.registerOutput("xyzw",N.Vector4,W.Fragment),this.registerOutput("x",N.Float,W.Fragment),this.registerOutput("y",N.Float,W.Fragment),this.registerOutput("z",N.Float,W.Fragment),this.registerOutput("w",N.Float,W.Fragment)}getClassName(){return"FragCoordBlock"}get xy(){return this._outputs[0]}get xyz(){return this._outputs[1]}get xyzw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get output(){return this._outputs[6]}writeOutputs(e){let t="";for(const i of this._outputs)i.hasEndpoints&&(t+=`${this._declareOutput(i,e)} = gl_FragCoord.${i.name};\r
`);return t}_buildBlock(e){if(super._buildBlock(e),e.target===W.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this}}ye("BABYLON.FragCoordBlock",mN);class gN extends rt{constructor(e){super(e,W.Fragment),this.registerOutput("xy",N.Vector2,W.Fragment),this.registerOutput("x",N.Float,W.Fragment),this.registerOutput("y",N.Float,W.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){const t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let i="";for(const r of this._outputs)r.hasEndpoints&&(i+=`${this._declareOutput(r,e)} = ${t}.${r.name};\r
`);return i}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===W.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";return e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,"vec2"),e.compilationString+=this.writeOutputs(e,this._varName),this}}ye("BABYLON.ScreenSizeBlock",gN);class vN extends rt{constructor(e){super(e,W.Fragment),this.registerInput("vector",N.AutoDetect),this.registerInput("worldViewProjection",N.Matrix),this.registerOutput("output",N.Vector2),this.registerOutput("x",N.Float),this.registerOutput("y",N.Float),this.inputs[0].addExcludedConnectionPointFromAllowedTypes(N.Color3|N.Vector3|N.Vector4)}getClassName(){return"ScreenSpaceBlock"}get vector(){return this._inputs[0]}get worldViewProjection(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(e){if(!this.worldViewProjection.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Rt.WorldViewProjection);t||(t=new yt("worldViewProjection"),t.setAsSystemValue(Rt.WorldViewProjection)),t.output.connectTo(this.worldViewProjection)}}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.worldViewProjection;if(!t.connectedPoint)return;const r=i.associatedVariableName,s=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case N.Vector3:e.compilationString+=`vec4 ${s} = ${r} * vec4(${t.associatedVariableName}, 1.0);\r
`;break;case N.Vector4:e.compilationString+=`vec4 ${s} = ${r} * ${t.associatedVariableName};\r
`;break}return e.compilationString+=`${s}.xy /= ${s}.w;`,e.compilationString+=`${s}.xy = ${s}.xy * 0.5 + vec2(0.5, 0.5);`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${s}.xy;\r
`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${s}.x;\r
`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${s}.y;\r
`),this}}ye("BABYLON.ScreenSpaceBlock",vN);class xN extends rt{constructor(e){super(e,W.Fragment),this.registerInput("input",N.Vector2),this.registerInput("strength",N.Float),this.registerInput("center",N.Vector2),this.registerInput("offset",N.Vector2),this.registerOutput("output",N.Vector2),this.registerOutput("x",N.Float),this.registerOutput("y",N.Float)}getClassName(){return"TwirlBlock"}get input(){return this._inputs[0]}get strength(){return this._inputs[1]}get center(){return this._inputs[2]}get offset(){return this._inputs[3]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(){if(!this.center.isConnected){const e=new yt("center");e.value=new Ie(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){const e=new yt("strength");e.value=1,e.output.connectTo(this.strength)}if(!this.offset.isConnected){const e=new yt("offset");e.value=new Ie(0,0),e.output.connectTo(this.offset)}}_buildBlock(e){super._buildBlock(e);const t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),r=e._getFreeVariableName("x"),s=e._getFreeVariableName("y"),n=e._getFreeVariableName("result");return e.compilationString+=`
            vec2 ${t} = ${this.input.associatedVariableName} - ${this.center.associatedVariableName};
            float ${i} = ${this.strength.associatedVariableName} * length(${t});
            float ${r} = cos(${i}) * ${t}.x - sin(${i}) * ${t}.y;
            float ${s} = sin(${i}) * ${t}.x + cos(${i}) * ${t}.y;
            vec2 ${n} = vec2(${r} + ${this.center.associatedVariableName}.x + ${this.offset.associatedVariableName}.x, ${s} + ${this.center.associatedVariableName}.y + ${this.offset.associatedVariableName}.y);
        `,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${n};\r
`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${n}.x;\r
`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${n}.y;\r
`),this}}ye("BABYLON.TwirlBlock",xN);class Yf extends rt{constructor(e){super(e,W.Fragment),this.generateInWorldSpace=!1,this.automaticNormalizationNormal=!0,this.automaticNormalizationTangent=!0,this.registerInput("input",N.Float),this.registerInput("worldPosition",N.Vector3),this.registerInput("worldNormal",N.Vector3),this.registerInput("worldTangent",N.AutoDetect,!0),this.registerOutput("output",N.Vector4),this.registerOutput("xyz",N.Vector3),this._inputs[3].addExcludedConnectionPointFromAllowedTypes(N.Color3|N.Vector3|N.Vector4)}getClassName(){return"HeightToNormalBlock"}get input(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];!this.generateInWorldSpace&&!this.worldTangent.isConnected&&console.error(`You must connect the 'worldTangent' input of the ${this.name} block!`);const i=this.generateInWorldSpace?"":`
            vec3 biTangent = cross(normal, tangent);
            mat3 TBN = mat3(tangent, biTangent, normal);
            `,r=this.generateInWorldSpace?"":`
            result = TBN * result;
            result = result * vec3(0.5) + vec3(0.5);
            `,s=`
            vec4 heightToNormal(in float height, in vec3 position, in vec3 tangent, in vec3 normal) {
                ${i}
                ${this.automaticNormalizationTangent?"tangent = normalize(tangent);":""}
                ${this.automaticNormalizationNormal?"normal = normalize(normal);":""}
                vec3 worlddX = dFdx(position);
                vec3 worlddY = dFdy(position);
                vec3 crossX = cross(normal, worlddX);
                vec3 crossY = cross(normal, worlddY);
                float d = abs(dot(crossY, worlddX));
                vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));
                inToNormal.y *= -1.0;
                vec3 result = normalize((d * normal) - inToNormal);
                ${r}
                return vec4(result, 0.);
            }`;return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitFunction("heightToNormal",s,"// heightToNormal"),e.compilationString+=this._declareOutput(t,e)+` = heightToNormal(${this.input.associatedVariableName}, ${this.worldPosition.associatedVariableName}, ${this.worldTangent.isConnected?this.worldTangent.associatedVariableName:"vec3(0.)"}.xyz, ${this.worldNormal.associatedVariableName});\r
`,this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+` = ${this.output.associatedVariableName}.xyz;\r
`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.generateInWorldSpace = ${this.generateInWorldSpace};\r
`,e+=`${this._codeVariableName}.automaticNormalizationNormal = ${this.automaticNormalizationNormal};\r
`,e+=`${this._codeVariableName}.automaticNormalizationTangent = ${this.automaticNormalizationTangent};\r
`,e}serialize(){const e=super.serialize();return e.generateInWorldSpace=this.generateInWorldSpace,e.automaticNormalizationNormal=this.automaticNormalizationNormal,e.automaticNormalizationTangent=this.automaticNormalizationTangent,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.generateInWorldSpace=e.generateInWorldSpace,this.automaticNormalizationNormal=e.automaticNormalizationNormal,this.automaticNormalizationTangent=e.automaticNormalizationTangent}}M([Xt("Generate in world space instead of tangent space",zt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Yf.prototype,"generateInWorldSpace",void 0);M([Xt("Force normalization for the worldNormal input",zt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Yf.prototype,"automaticNormalizationNormal",void 0);M([Xt("Force normalization for the worldTangent input",zt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Yf.prototype,"automaticNormalizationTangent",void 0);ye("BABYLON.HeightToNormalBlock",Yf);class TN extends rt{constructor(e){super(e,W.Fragment,!0),this.registerInput("depth",N.Float,!0),this.registerInput("worldPos",N.Vector4,!0),this.registerInput("viewProjection",N.Matrix,!0)}getClassName(){return"FragDepthBlock"}get depth(){return this._inputs[0]}get worldPos(){return this._inputs[1]}get viewProjection(){return this._inputs[2]}_buildBlock(e){return super._buildBlock(e),this.depth.isConnected?e.compilationString+=`gl_FragDepth = ${this.depth.associatedVariableName};\r
`:this.worldPos.isConnected&&this.viewProjection.isConnected?e.compilationString+=`
                vec4 p = ${this.viewProjection.associatedVariableName} * ${this.worldPos.associatedVariableName};
                float v = p.z / p.w;
                #ifndef IS_NDC_HALF_ZRANGE
                    v = v * 0.5 + 0.5;
                #endif
                gl_FragDepth = v;
    
            `:console.warn("FragDepthBlock: either the depth input or both the worldPos and viewProjection inputs must be connected!"),this}}ye("BABYLON.FragDepthBlock",TN);class EN extends rt{constructor(e){super(e,W.Fragment),this.registerInput("worldPosition",N.Vector4,!1),this.registerInput("viewProjection",N.Matrix,!1),this.registerInput("worldNormal",N.AutoDetect,!0),this.registerOutput("depth",N.Vector3),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(N.Color3|N.Vector3|N.Vector4)}getClassName(){return"ShadowMapBlock"}initialize(e){e._excludeVariableName("vPositionWSM"),e._excludeVariableName("lightDataSM"),e._excludeVariableName("biasAndScaleSM"),e._excludeVariableName("depthValuesSM"),e._excludeVariableName("clipPos"),e._excludeVariableName("worldPos"),e._excludeVariableName("zSM")}get worldPosition(){return this._inputs[0]}get viewProjection(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get depth(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitUniformFromString("biasAndScaleSM","vec3"),e._emitUniformFromString("lightDataSM","vec3"),e._emitUniformFromString("depthValuesSM","vec2"),e._emitFunctionFromInclude("packingFunctions",t),e.compilationString+=`vec4 worldPos = ${this.worldPosition.associatedVariableName};\r
`,e.compilationString+=`vec3 vPositionWSM;\r
`,e.compilationString+=`float vDepthMetricSM = 0.0;\r
`,e.compilationString+=`float zSM;\r
`,this.worldNormal.isConnected&&(e.compilationString+=`vec3 vNormalW = ${this.worldNormal.associatedVariableName}.xyz;\r
`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexNormalBias",t)),e.compilationString+=`vec4 clipPos = ${this.viewProjection.associatedVariableName} * worldPos;\r
`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexMetric",t,{replaceStrings:[{search:/gl_Position/g,replace:"clipPos"}]}),e.compilationString+=e._emitCodeFromInclude("shadowMapFragment",t,{replaceStrings:[{search:/return;/g,replace:""}]}),e.compilationString+=`
            #if SM_DEPTHTEXTURE == 1
                #ifdef IS_NDC_HALF_ZRANGE
                    gl_FragDepth = (clipPos.z / clipPos.w);
                #else
                    gl_FragDepth = (clipPos.z / clipPos.w) * 0.5 + 0.5;
                #endif
            #endif
        `,e.compilationString+=`${this._declareOutput(this.depth,e)} = vec3(depthSM, 1., 1.);\r
`,this}}ye("BABYLON.ShadowMapBlock",EN);class bN extends rt{constructor(e){super(e,W.VertexAndFragment,!1),this.registerInput("worldPosition",N.Vector4,!1,W.Vertex),this.registerInput("view",N.Matrix,!1,W.Vertex),this.registerInput("input",N.AutoDetect,!1,W.Fragment),this.registerInput("fogColor",N.AutoDetect,!1,W.Fragment),this.registerOutput("output",N.Color3,W.Fragment),this.input.addExcludedConnectionPointFromAllowedTypes(N.Color3|N.Vector3|N.Color4),this.fogColor.addExcludedConnectionPointFromAllowedTypes(N.Color3|N.Vector3|N.Color4)}getClassName(){return"FogBlock"}get worldPosition(){return this._inputs[0]}get view(){return this._inputs[1]}get input(){return this._inputs[2]}get fogColor(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Rt.View);t||(t=new yt("view"),t.setAsSystemValue(Rt.View)),t.output.connectTo(this.view)}if(!this.fogColor.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Rt.FogColor);t||(t=new yt("fogColor",void 0,N.Color3),t.setAsSystemValue(Rt.FogColor)),t.output.connectTo(this.fogColor)}}prepareDefines(e,t,i){const r=e.getScene();i.setValue("FOG",t.fogEnabled&&Ce.GetFogState(e,r))}bind(e,t,i){if(!i)return;const r=i.getScene();e.setFloat4(this._fogParameters,r.fogMode,r.fogStart,r.fogEnd,r.fogDensity)}_buildBlock(e){if(super._buildBlock(e),e.target===W.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e._emitFunctionFromInclude("fogFragmentDeclaration",`//${this.name}`,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}]});const t=e._getFreeVariableName("fog"),i=this.input,r=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");const s=this._outputs[0];e._emitUniformFromString(this._fogParameters,"vec4"),e.compilationString+=`#ifdef FOG\r
`,e.compilationString+=`float ${t} = CalcFogFactor(${this._fogDistanceName}, ${this._fogParameters});\r
`,e.compilationString+=this._declareOutput(s,e)+` = ${t} * ${i.associatedVariableName}.rgb + (1.0 - ${t}) * ${r.associatedVariableName}.rgb;\r
`,e.compilationString+=`#else\r
${this._declareOutput(s,e)} =  ${i.associatedVariableName}.rgb;\r
`,e.compilationString+=`#endif\r
`}else{const t=this.worldPosition,i=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,"vec3"),e.compilationString+=`${this._fogDistanceName} = (${i.associatedVariableName} * ${t.associatedVariableName}).xyz;\r
`}return this}}ye("BABYLON.FogBlock",bN);class rp extends rt{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?W.Fragment:W.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?W.Fragment:W.Vertex}constructor(e){super(e,W.VertexAndFragment),this._lightId=0,this.generateOnlyFragmentCode=!1,this._isUnique=!0,this.registerInput("worldPosition",N.Vector4,!1,W.Vertex),this.registerInput("worldNormal",N.Vector4,!1,W.Fragment),this.registerInput("cameraPosition",N.Vector3,!1,W.Fragment),this.registerInput("glossiness",N.Float,!0,W.Fragment),this.registerInput("glossPower",N.Float,!0,W.Fragment),this.registerInput("diffuseColor",N.Color3,!0,W.Fragment),this.registerInput("specularColor",N.Color3,!0,W.Fragment),this.registerInput("view",N.Matrix,!0),this.registerOutput("diffuseOutput",N.Color3,W.Fragment),this.registerOutput("specularOutput",N.Color3,W.Fragment),this.registerOutput("shadow",N.Float,W.Fragment)}getClassName(){return"LightBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get cameraPosition(){return this._inputs[2]}get glossiness(){return this._inputs[3]}get glossPower(){return this._inputs[4]}get diffuseColor(){return this._inputs[5]}get specularColor(){return this._inputs[6]}get view(){return this._inputs[7]}get diffuseOutput(){return this._outputs[0]}get specularOutput(){return this._outputs[1]}get shadow(){return this._outputs[2]}autoConfigure(e){if(!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Rt.CameraPosition);t||(t=new yt("cameraPosition"),t.setAsSystemValue(Rt.CameraPosition)),t.output.connectTo(this.cameraPosition)}}prepareDefines(e,t,i){if(!i._areLightsDirty)return;const r=e.getScene();if(!this.light)Ce.PrepareDefinesForLights(r,e,i,!0,t.maxSimultaneousLights);else{const s={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};Ce.PrepareDefinesForLight(r,e,this.light,this._lightId,i,!0,s),s.needRebuild&&i.rebuild()}}updateUniformsAndSamples(e,t,i,r){for(let s=0;s<t.maxSimultaneousLights&&i["LIGHT"+s];s++){const n=e.uniforms.indexOf("vLightData"+s)>=0;Ce.PrepareUniformsAndSamplersForLight(s,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+s],r,n)}}bind(e,t,i){if(!i)return;const r=i.getScene();this.light?Ce.BindLight(this.light,this._lightId,r,e,!0):Ce.BindLights(r,i,e,!0,t.maxSimultaneousLights)}_injectVertexCode(e){const t=this.worldPosition,i=`//${this.name}`;this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const r="v_"+t.associatedVariableName;e._emitVaryingFromString(r,"vec4")&&(e.compilationString+=`${r} = ${t.associatedVariableName};\r
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`vec4 worldPos = ${t.associatedVariableName};\r
`,this.view.isConnected&&(e.compilationString+=`mat4 view = ${this.view.associatedVariableName};\r
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))}_buildBlock(e){if(super._buildBlock(e),e.target!==W.Fragment){this._injectVertexCode(e);return}this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=`//${this.name}`,i=this.worldPosition;let r=i.associatedVariableName;this.generateOnlyFragmentCode?(r=e._getFreeVariableName("globalWorldPos"),e._emitFunction("light_globalworldpos",`vec3 ${r};\r
`,t),e.compilationString+=`${r} = ${i.associatedVariableName}.xyz;\r
`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${i.associatedVariableName}`:void 0})):r="v_"+r+".xyz",e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("lightsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:r}]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:r}]}),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),this._lightId===0&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${r});\r
`),e.compilationString+=`lightingInfo info;\r
`,e.compilationString+=`float shadow = 1.;\r
`,e.compilationString+=`float glossiness = ${this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"} * ${this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0"};\r
`,e.compilationString+=`vec3 diffuseBase = vec3(0., 0., 0.);\r
`,e.compilationString+=`vec3 specularBase = vec3(0., 0., 0.);\r
`,e.compilationString+=`vec3 normalW = ${this.worldNormal.associatedVariableName}.xyz;\r
`),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",t,{repeatKey:"maxSimultaneousLights"});const s=this.diffuseOutput,n=this.specularOutput;return e.compilationString+=this._declareOutput(s,e)+` = diffuseBase${this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:""};\r
`,n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = specularBase${this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:""};\r
`),this.shadow.hasEndpoints&&(e.compilationString+=this._declareOutput(this.shadow,e)+` = shadow;\r
`),this}serialize(){const e=super.serialize();return e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}M([Xt("Generate only fragment code",zt.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:rp._OnGenerateOnlyFragmentCodeChanged}})],rp.prototype,"generateOnlyFragmentCode",void 0);ye("BABYLON.LightBlock",rp);class hc extends rt{get texture(){return this._texture}set texture(e){var t;if(this._texture===e)return;const i=(t=e==null?void 0:e.getScene())!==null&&t!==void 0?t:qe.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,r=>r.hasTexture(this._texture)),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,r=>r.hasTexture(e))}get samplerName(){return this._samplerName}constructor(e){super(e,W.VertexAndFragment),this.registerOutput("source",N.Object,W.VertexAndFragment,new Rr("source",this,nr.Output,hc,"ImageSourceBlock"))}bind(e){this.texture&&e.setTexture(this._samplerName,this.texture)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}getClassName(){return"ImageSourceBlock"}get source(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.target===W.Vertex&&(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),e._emit2DSampler(this._samplerName),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\r
`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\r
`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\r
`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\r
`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\r
`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\r
`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\r
`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\r
`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\r
`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\r
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r
`),e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!sr.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=Y.Parse(e.texture,t,i))}}ye("BABYLON.ImageSourceBlock",hc);class SN extends rt{get texture(){var e;return this.source.isConnected?((e=this.source.connectedPoint)===null||e===void 0?void 0:e.ownerBlock).texture:this._texture}set texture(e){var t;if(this._texture===e)return;const i=(t=e==null?void 0:e.getScene())!==null&&t!==void 0?t:qe.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,r=>r.hasTexture(this._texture)),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,r=>r.hasTexture(e))}get samplerName(){return this._imageSource?this._imageSource.samplerName:this._samplerName}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){var t;if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const i=(t=this.texture.getScene())!==null&&t!==void 0?t:qe.LastCreatedScene;i==null||i.markAllMaterialsAsDirty(1,r=>r.hasTexture(this.texture))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){var t;if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const i=(t=this.texture.getScene())!==null&&t!==void 0?t:qe.LastCreatedScene;i==null||i.markAllMaterialsAsDirty(1,r=>r.hasTexture(this.texture))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,t?W.Fragment:W.VertexAndFragment),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this._fragmentOnly=t,this.registerInput("uv",N.AutoDetect,!1,W.VertexAndFragment),this.registerInput("source",N.Object,!0,W.VertexAndFragment,new Rr("source",this,nr.Input,hc,"ImageSourceBlock")),this.registerOutput("rgba",N.Color4,W.Neutral),this.registerOutput("rgb",N.Color3,W.Neutral),this.registerOutput("r",N.Float,W.Neutral),this.registerOutput("g",N.Float,W.Neutral),this.registerOutput("b",N.Float,W.Neutral),this.registerOutput("a",N.Float,W.Neutral),this.registerOutput("level",N.Float,W.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(N.Vector2|N.Vector3|N.Vector4),this._inputs[0]._prioritizeVertex=!t}getClassName(){return"TextureBlock"}get uv(){return this._inputs[0]}get source(){return this._inputs[1]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}get target(){if(this._fragmentOnly)return W.Fragment;if(!this.uv.isConnected||this.uv.sourceBlock.isInput)return W.VertexAndFragment;let e=this.uv.connectedPoint;for(;e;){if(e.target===W.Fragment)return W.Fragment;if(e.target===W.Vertex)return W.VertexAndFragment;if(e.target===W.Neutral||e.target===W.VertexAndFragment){const t=e.ownerBlock;if(t.target===W.Fragment)return W.Fragment;e=null;for(const i of t.inputs)if(i.connectedPoint){e=i.connectedPoint;break}}}return W.VertexAndFragment}set target(e){}autoConfigure(e){if(!this.uv.isConnected)if(e.mode===In.PostProcess){const t=e.getBlockByPredicate(i=>i.name==="uv");t&&t.connectTo(this)}else{const t=e.mode===In.Particle?"particle_uv":"uv";let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name===t);i||(i=new yt("uv"),i.setAsAttribute(t)),i.output.connectTo(this.uv)}}initializeDefines(e,t,i){i._areTexturesDirty&&this._mainUVDefineName!==void 0&&i.setValue(this._mainUVDefineName,!1,!0)}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;if(!this.texture||!this.texture.getTextureMatrix){this._isMixed&&(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0));return}const r=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,s=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,r,!0),i.setValue(this._gammaDefineName,s,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)):(i.setValue(this._defineName,!0),i[this._mainUVDefineName]==null&&i.setValue(this._mainUVDefineName,!1,!0)))}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this.texture&&(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))}get _isMixed(){return this.target!==W.Fragment}_injectVertexCode(e){const t=this.uv;if(this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.associatedVariableName.toUpperCase(),this._mainUVName="vMain"+t.associatedVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,"vec2",this._defineName),e._emitVaryingFromString(this._mainUVName,"vec2",this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,"mat4",this._defineName),e.compilationString+=`#ifdef ${this._defineName}\r
`,e.compilationString+=`${this._transformedUVName} = vec2(${this._textureTransformName} * vec4(${t.associatedVariableName}.xy, 1.0, 0.0));\r
`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\r
`,e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\r
`,e.compilationString+=`#endif\r
`,!!this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&i.name!=="level"&&this._writeOutput(e,i,i.name,!0)}}_generateTextureLookup(e){const t=this.samplerName;e.compilationString+=`#ifdef ${this._defineName}\r
`,e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${t}, ${this._transformedUVName});\r
`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\r
`,e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${t}, ${this._mainUVName?this._mainUVName:this.uv.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===W.Fragment)return;this._generateTextureLookup(e);return}if(this.uv.ownerBlock.target===W.Fragment){e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this.samplerName}, ${i.associatedVariableName});\r
`;return}this._generateTextureLookup(e)}_generateConversionCode(e,t,i){i!=="a"&&((!this.texture||!this.texture.gammaSpace)&&(e.compilationString+=`#ifdef ${this._linearDefineName}
                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
                    #endif
                `),e.compilationString+=`#ifdef ${this._gammaDefineName}
                ${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
                #endif
            `)}_writeOutput(e,t,i,r=!1){if(r){if(e.target===W.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`,this._generateConversionCode(e,t,i);return}if(this.uv.ownerBlock.target===W.Fragment){e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`,this._generateConversionCode(e,t,i);return}let s="";this.disableLevelMultiplication||(s=` * ${this._textureInfoName}`),e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i}${s};\r
`,this._generateConversionCode(e,t,i)}_buildBlock(e){if(super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,(e.target===W.Vertex||this._fragmentOnly||e.target===W.Fragment)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),(!this._isMixed&&e.target===W.Fragment||this._isMixed&&e.target===W.Vertex)&&(this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)),e.target!==W.Fragment){this._injectVertexCode(e);return}if(!this._outputs.some(i=>i.isConnectedInFragmentShader))return;this._isMixed&&!this._imageSource&&e._emit2DSampler(this._samplerName);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._isMixed&&e._emitUniformFromString(this._textureInfoName,"float"),this._writeTextureRead(e);for(const i of this._outputs)i.hasEndpoints&&i.name!=="level"&&this._writeOutput(e,i,i.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\r
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\r
`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\r
`,this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\r
`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\r
`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\r
`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\r
`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\r
`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\r
`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\r
`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\r
`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\r
`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\r
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r
`),e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,!this.hasImageSource&&this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!sr.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=Y.Parse(e.texture,t,i))}}ye("BABYLON.TextureBlock",SN);class Su extends rt{get texture(){return this._texture}set texture(e){var t;if(this._texture===e)return;const i=(t=e==null?void 0:e.getScene())!==null&&t!==void 0?t:qe.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,r=>r.hasTexture(this._texture)),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,r=>r.hasTexture(e))}static _OnGenerateOnlyFragmentCodeChanged(e,t){return e._onGenerateOnlyFragmentCodeChanged()}_onGenerateOnlyFragmentCodeChanged(){return this._setTarget(),!0}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?W.Fragment:W.VertexAndFragment)}constructor(e){super(e,W.VertexAndFragment),this.generateOnlyFragmentCode=!1}getClassName(){return"ReflectionTextureBaseBlock"}_getTexture(){return this.texture}autoConfigure(e){if(!this.position.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="position");t||(t=new yt("position"),t.setAsAttribute()),t.output.connectTo(this.position)}if(!this.world.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Rt.World);t||(t=new yt("world"),t.setAsSystemValue(Rt.World)),t.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Rt.View);t||(t=new yt("view"),t.setAsSystemValue(Rt.View)),t.output.connectTo(this.view)}}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const r=this._getTexture();!r||!r.getTextureMatrix||(i.setValue(this._define3DName,r.isCube,!0),i.setValue(this._defineLocalCubicName,!!r.boundingBoxSize,!0),i.setValue(this._defineExplicitName,r.coordinatesMode===0,!0),i.setValue(this._defineSkyboxName,r.coordinatesMode===5,!0),i.setValue(this._defineCubicName,r.coordinatesMode===3||r.coordinatesMode===6,!0),i.setValue("INVERTCUBICMAP",r.coordinatesMode===6,!0),i.setValue(this._defineSphericalName,r.coordinatesMode===1,!0),i.setValue(this._definePlanarName,r.coordinatesMode===2,!0),i.setValue(this._defineProjectionName,r.coordinatesMode===4,!0),i.setValue(this._defineEquirectangularName,r.coordinatesMode===7,!0),i.setValue(this._defineEquirectangularFixedName,r.coordinatesMode===8,!0),i.setValue(this._defineMirroredEquirectangularFixedName,r.coordinatesMode===9,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){const r=this._getTexture();if(!(!i||!r)&&(e.setMatrix(this._reflectionMatrixName,r.getReflectionTextureMatrix()),r.isCube?e.setTexture(this._cubeSamplerName,r):e.setTexture(this._2DSamplerName,r),r.boundingBoxSize)){const s=r;e.setVector3(this._reflectionPositionName,s.boundingBoxPosition),e.setVector3(this._reflectionSizeName,s.boundingBoxSize)}}handleVertexSide(e){if(this.generateOnlyFragmentCode&&e.target===W.Vertex)return"";this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,"mat4");let t="";this._worldPositionNameInFragmentOnlyMode=e._getFreeVariableName("worldPosition");const i=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName;return(this.generateOnlyFragmentCode||e._emitVaryingFromString(i,"vec4"))&&(t+=`${this.generateOnlyFragmentCode?"vec4 ":""}${i} = ${this.worldPosition.associatedVariableName};\r
`),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._positionUVWName,"vec3",this._defineSkyboxName))&&(t+=`#ifdef ${this._defineSkyboxName}\r
`,t+=`${this.generateOnlyFragmentCode?"vec3 ":""}${this._positionUVWName} = ${this.position.associatedVariableName}.xyz;\r
`,t+=`#endif\r
`),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._directionWName,"vec3",`defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})`))&&(t+=`#if defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})\r
`,t+=`${this.generateOnlyFragmentCode?"vec3 ":""}${this._directionWName} = normalize(vec3(${this.world.associatedVariableName} * vec4(${this.position.associatedVariableName}.xyz, 0.0)));\r
`,t+=`#endif\r
`),t}handleFragmentSideInits(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+=`#ifdef ${this._define3DName}\r
`,e._samplerDeclaration+=`uniform samplerCube ${this._cubeSamplerName};\r
`,e._samplerDeclaration+=`#else\r
`,e._samplerDeclaration+=`uniform sampler2D ${this._2DSamplerName};\r
`,e._samplerDeclaration+=`#endif\r
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunction("ReciprocalPI","#define RECIPROCAL_PI2 0.15915494",""),e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("reflectionFunction",t,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords"),this._reflectionPositionName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionPositionName,"vec3"),this._reflectionSizeName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionSizeName,"vec3")}handleFragmentSideCodeReflectionCoords(e,t,i=!1,r=!1){t||(t=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:`v_${this.worldPosition.associatedVariableName}`);const s=this._reflectionMatrixName,n=`normalize(${this._directionWName})`,a=`${this._positionUVWName}`,l=`${this.cameraPosition.associatedVariableName}`,c=`${this.view.associatedVariableName}`;e+=".xyz";let h=`
            #ifdef ${this._defineMirroredEquirectangularFixedName}
                vec3 ${this._reflectionVectorName} = computeMirroredFixedEquirectangularCoords(${t}, ${e}, ${n});
            #endif

            #ifdef ${this._defineEquirectangularFixedName}
                vec3 ${this._reflectionVectorName} = computeFixedEquirectangularCoords(${t}, ${e}, ${n});
            #endif

            #ifdef ${this._defineEquirectangularName}
                vec3 ${this._reflectionVectorName} = computeEquirectangularCoords(${t}, ${e}, ${l}.xyz, ${s});
            #endif

            #ifdef ${this._defineSphericalName}
                vec3 ${this._reflectionVectorName} = computeSphericalCoords(${t}, ${e}, ${c}, ${s});
            #endif

            #ifdef ${this._definePlanarName}
                vec3 ${this._reflectionVectorName} = computePlanarCoords(${t}, ${e}, ${l}.xyz, ${s});
            #endif

            #ifdef ${this._defineCubicName}
                #ifdef ${this._defineLocalCubicName}
                    vec3 ${this._reflectionVectorName} = computeCubicLocalCoords(${t}, ${e}, ${l}.xyz, ${s}, ${this._reflectionSizeName}, ${this._reflectionPositionName});
                #else
                vec3 ${this._reflectionVectorName} = computeCubicCoords(${t}, ${e}, ${l}.xyz, ${s});
                #endif
            #endif

            #ifdef ${this._defineProjectionName}
                vec3 ${this._reflectionVectorName} = computeProjectionCoords(${t}, ${c}, ${s});
            #endif

            #ifdef ${this._defineSkyboxName}
                vec3 ${this._reflectionVectorName} = computeSkyBoxCoords(${a}, ${s});
            #endif

            #ifdef ${this._defineExplicitName}
                vec3 ${this._reflectionVectorName} = vec3(0, 0, 0);
            #endif\r
`;return r||(h+=`#ifdef ${this._defineOppositeZ}
                ${this._reflectionVectorName}.z *= -1.0;
            #endif\r
`),i||(h+=`
                #ifdef ${this._define3DName}
                    vec3 ${this._reflectionCoordsName} = ${this._reflectionVectorName};
                #else
                    vec2 ${this._reflectionCoordsName} = ${this._reflectionVectorName}.xy;
                    #ifdef ${this._defineProjectionName}
                        ${this._reflectionCoordsName} /= ${this._reflectionVectorName}.z;
                    #endif
                    ${this._reflectionCoordsName}.y = 1.0 - ${this._reflectionCoordsName}.y;
                #endif\r
`),h}handleFragmentSideCodeReflectionColor(e,t=".rgb"){let r=`${"vec"+(t.length===0?"4":t.length-1)} ${this._reflectionColorName};
            #ifdef ${this._define3DName}\r
`;return e?r+=`${this._reflectionColorName} = textureCubeLodEXT(${this._cubeSamplerName}, ${this._reflectionVectorName}, ${e})${t};\r
`:r+=`${this._reflectionColorName} = textureCube(${this._cubeSamplerName}, ${this._reflectionVectorName})${t};\r
`,r+=`
            #else\r
`,e?r+=`${this._reflectionColorName} = texture2DLodEXT(${this._2DSamplerName}, ${this._reflectionCoordsName}, ${e})${t};\r
`:r+=`${this._reflectionColorName} = texture2D(${this._2DSamplerName}, ${this._reflectionCoordsName})${t};\r
`,r+=`#endif\r
`,r}writeOutputs(e,t){let i="";if(e.target===W.Fragment)for(const r of this._outputs)r.hasEndpoints&&(i+=`${this._declareOutput(r,e)} = ${t}.${r.name};\r
`);return i}_buildBlock(e){return super._buildBlock(e),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();if(!this.texture)return e;if(this.texture.isCube){const t=this.texture.forcedExtension;e+=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}", undefined, undefined, ${this.texture.noMipmap}, null, undefined, undefined, undefined, ${this.texture._prefiltered}, ${t?'"'+t+'"':"null"});\r
`}else e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null);\r
`;return e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r
`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!sr.IgnoreTexturesAtLoadTime&&(i=e.texture.url.indexOf("data:")===0?"":i,e.texture.isCube?this.texture=ns.Parse(e.texture,t,i):this.texture=Y.Parse(e.texture,t,i)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}M([Xt("Generate only fragment code",zt.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Su._OnGenerateOnlyFragmentCodeChanged}})],Su.prototype,"generateOnlyFragmentCode",void 0);ye("BABYLON.ReflectionTextureBaseBlock",Su);class yN extends Su{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The position input must not be connected to be able to switch!"),!1):this.worldPosition.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?W.Fragment:W.Vertex,this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?W.Fragment:W.Vertex}constructor(e){super(e),this.registerInput("position",N.AutoDetect,!1,W.Vertex),this.registerInput("worldPosition",N.Vector4,!1,W.Vertex),this.registerInput("worldNormal",N.Vector4,!1,W.Fragment),this.registerInput("world",N.Matrix,!1,W.Vertex),this.registerInput("cameraPosition",N.Vector3,!1,W.Fragment),this.registerInput("view",N.Matrix,!1,W.Fragment),this.registerOutput("rgb",N.Color3,W.Fragment),this.registerOutput("rgba",N.Color4,W.Fragment),this.registerOutput("r",N.Float,W.Fragment),this.registerOutput("g",N.Float,W.Fragment),this.registerOutput("b",N.Float,W.Fragment),this.registerOutput("a",N.Float,W.Fragment),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(N.Color3|N.Vector3|N.Vector4)}getClassName(){return"ReflectionTextureBlock"}get position(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get world(){return this._inputs[3]}get cameraPosition(){return this._inputs[4]}get view(){return this._inputs[5]}get rgb(){return this._outputs[0]}get rgba(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}autoConfigure(e){if(super.autoConfigure(e),!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Rt.CameraPosition);t||(t=new yt("cameraPosition"),t.setAsSystemValue(Rt.CameraPosition)),t.output.connectTo(this.cameraPosition)}}_buildBlock(e){if(super._buildBlock(e),!this.texture)return e.compilationString+=this.writeOutputs(e,"vec4(0.)"),this;if(e.target!==W.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.generateOnlyFragmentCode&&(e.compilationString+=this.handleVertexSide(e)),this.handleFragmentSideInits(e);const t=e._getFreeVariableName("normalWUnit");return e.compilationString+=`vec4 ${t} = normalize(${this.worldNormal.associatedVariableName});\r
`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this}}ye("BABYLON.ReflectionTextureBlock",yN);class Gm extends rt{constructor(e){super(e,W.VertexAndFragment),this.useNonLinearDepth=!1,this.force32itsFloat=!1,this._isUnique=!0,this.registerInput("uv",N.AutoDetect,!1,W.VertexAndFragment),this.registerOutput("depth",N.Float,W.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(N.Vector2|N.Vector3|N.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"SceneDepthBlock"}get uv(){return this._inputs[0]}get depth(){return this._outputs[0]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?W.VertexAndFragment:W.Fragment}_getTexture(e){return e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat).getDepthMap()}bind(e,t){const i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec"+(t.type===N.Vector3?"3":t.type===N.Vector4?"4":"2"))),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\r
`,!!this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,"r",!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===W.Fragment)return;e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName}.xy);\r
`;return}if(this.uv.ownerBlock.target===W.Fragment){e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName}.xy);\r
`;return}e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this._mainUVName});\r
`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===W.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`;return}if(this.uv.ownerBlock.target===W.Fragment){e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`;return}e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`}_buildBlock(e){if(super._buildBlock(e),this._samplerName=e._getFreeVariableName(this.name+"Sampler"),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.bindableBlocks.indexOf(this)<0&&e.sharedData.bindableBlocks.push(this),e.target!==W.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(this._outputs.some(t=>t.isConnectedInFragmentShader)){e._emit2DSampler(this._samplerName),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r");return this}}serialize(){const e=super.serialize();return e.useNonLinearDepth=this.useNonLinearDepth,e.force32itsFloat=this.force32itsFloat,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.force32itsFloat=e.force32itsFloat}}M([Xt("Use non linear depth",zt.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:o=>o.disableDepthRenderer()}})],Gm.prototype,"useNonLinearDepth",void 0);M([Xt("Force 32 bits float",zt.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:o=>o.disableDepthRenderer()}})],Gm.prototype,"force32itsFloat",void 0);ye("BABYLON.SceneDepthBlock",Gm);class CN extends rt{constructor(e){super(e,W.VertexAndFragment,!0),this.registerInput("worldPosition",N.Vector4,!1)}getClassName(){return"ClipPlanesBlock"}initialize(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6")}get worldPosition(){return this._inputs[0]}get target(){return W.VertexAndFragment}set target(e){}prepareDefines(e,t,i){var r,s,n,a,l,c;const h=e.getScene(),u=!!((r=t.clipPlane)!==null&&r!==void 0?r:h.clipPlane),d=!!((s=t.clipPlane2)!==null&&s!==void 0?s:h.clipPlane2),f=!!((n=t.clipPlane3)!==null&&n!==void 0?n:h.clipPlane3),_=!!((a=t.clipPlane4)!==null&&a!==void 0?a:h.clipPlane4),p=!!((l=t.clipPlane5)!==null&&l!==void 0?l:h.clipPlane5),m=!!((c=t.clipPlane6)!==null&&c!==void 0?c:h.clipPlane6);i.setValue("CLIPPLANE",u,!0),i.setValue("CLIPPLANE2",d,!0),i.setValue("CLIPPLANE3",f,!0),i.setValue("CLIPPLANE4",_,!0),i.setValue("CLIPPLANE5",p,!0),i.setValue("CLIPPLANE6",m,!0)}bind(e,t,i){if(!i)return;const r=i.getScene();Ra(e,t,r)}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;if(e.target!==W.Fragment){const i=this.worldPosition;e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane","vec4"),e._emitUniformFromString("vClipPlane2","vec4"),e._emitUniformFromString("vClipPlane3","vec4"),e._emitUniformFromString("vClipPlane4","vec4"),e._emitUniformFromString("vClipPlane5","vec4"),e._emitUniformFromString("vClipPlane6","vec4");return}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this}}ye("BABYLON.ClipPlanesBlock",CN);class AN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("left",N.AutoDetect),this.registerInput("right",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"AddBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};\r
`,this}}ye("BABYLON.AddBlock",AN);class RN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("input",N.AutoDetect),this.registerInput("factor",N.Float),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ScaleBlock"}get input(){return this._inputs[0]}get factor(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.input.associatedVariableName} * ${this.factor.associatedVariableName};\r
`,this}}ye("BABYLON.ScaleBlock",RN);class zm extends rt{constructor(e){super(e,W.Neutral),this.minimum=0,this.maximum=1,this.registerInput("value",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = clamp(${this.value.associatedVariableName}, ${this._writeFloat(this.minimum)}, ${this._writeFloat(this.maximum)});\r
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};\r
`;return e+=`${this._codeVariableName}.maximum = ${this.maximum};\r
`,e}serialize(){const e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.minimum=e.minimum,this.maximum=e.maximum}}M([Xt("Minimum",zt.Float)],zm.prototype,"minimum",void 0);M([Xt("Maximum",zt.Float)],zm.prototype,"maximum",void 0);ye("BABYLON.ClampBlock",zm);class IN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("left",N.AutoDetect),this.registerInput("right",N.AutoDetect),this.registerOutput("output",N.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(N.Float),this._inputs[0].excludedConnectionPointTypes.push(N.Matrix),this._inputs[0].excludedConnectionPointTypes.push(N.Vector2),this._inputs[1].excludedConnectionPointTypes.push(N.Float),this._inputs[1].excludedConnectionPointTypes.push(N.Matrix),this._inputs[1].excludedConnectionPointTypes.push(N.Vector2)}getClassName(){return"CrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = cross(${this.left.associatedVariableName}.xyz, ${this.right.associatedVariableName}.xyz);\r
`,this}}ye("BABYLON.CrossBlock",IN);class PN extends rt{get options(){return this._options}set options(e){this._deserializeOptions(e)}constructor(e){super(e)}getClassName(){return"CustomBlock"}_buildBlock(e){super._buildBlock(e);let t=this._code,i=this._options.functionName;this._inputs.forEach(s=>{const n=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),a=e._getGLType(s.type);t=t.replace(n,a),i=i.replace(n,a)}),this._outputs.forEach(s=>{const n=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),a=e._getGLType(s.type);t=t.replace(n,a),i=i.replace(n,a)}),e._emitFunction(i,t,""),this._outputs.forEach(s=>{e.compilationString+=this._declareOutput(s,e)+`;\r
`}),e.compilationString+=i+"(";let r=!1;return this._inputs.forEach((s,n)=>{n>0&&(e.compilationString+=", "),e.compilationString+=s.associatedVariableName,r=!0}),this._outputs.forEach((s,n)=>{(n>0||r)&&(e.compilationString+=", "),e.compilationString+=s.associatedVariableName}),e.compilationString+=`);\r
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.options = ${JSON.stringify(this._options)};\r
`,e}serialize(){const e=super.serialize();return e.options=this._options,e}_deserialize(e,t,i){this._deserializeOptions(e.options),super._deserialize(e,t,i)}_deserializeOptions(e){var t,i,r;this._options=e,this._code=e.code.join(`\r
`)+`\r
`,this.name=this.name||e.name,this.target=W[e.target],(t=e.inParameters)===null||t===void 0||t.forEach((s,n)=>{const a=N[s.type];this.registerInput(s.name,a),Object.defineProperty(this,s.name,{get:function(){return this._inputs[n]},enumerable:!0,configurable:!0})}),(i=e.outParameters)===null||i===void 0||i.forEach((s,n)=>{this.registerOutput(s.name,N[s.type]),Object.defineProperty(this,s.name,{get:function(){return this._outputs[n]},enumerable:!0,configurable:!0}),s.type==="BasedOnInput"&&(this._outputs[n]._typeConnectionSource=this._findInputByName(s.typeFromInput)[0])}),(r=e.inLinkedConnectionTypes)===null||r===void 0||r.forEach(s=>{this._linkConnectionTypes(this._findInputByName(s.input1)[1],this._findInputByName(s.input2)[1])})}_findInputByName(e){if(!e)return null;for(let t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null}}ye("BABYLON.CustomBlock",PN);class MN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("left",N.AutoDetect),this.registerInput("right",N.AutoDetect),this.registerOutput("output",N.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(N.Float),this._inputs[0].excludedConnectionPointTypes.push(N.Matrix),this._inputs[1].excludedConnectionPointTypes.push(N.Float),this._inputs[1].excludedConnectionPointTypes.push(N.Matrix)}getClassName(){return"DotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = dot(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r
`,this}}ye("BABYLON.DotBlock",MN);class ON extends rt{constructor(e){super(e,W.Neutral),this.registerInput("input",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(N.Float),this._inputs[0].excludedConnectionPointTypes.push(N.Matrix)}getClassName(){return"NormalizeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=this._declareOutput(t,e)+` = normalize(${i.associatedVariableName});\r
`,this}}ye("BABYLON.NormalizeBlock",ON);class DN extends rt{constructor(e){super(e,W.Neutral),this.rSwizzle="r",this.gSwizzle="g",this.bSwizzle="b",this.aSwizzle="a",this.registerInput("rgb ",N.Color3,!0),this.registerInput("r",N.Float,!0),this.registerInput("g",N.Float,!0),this.registerInput("b",N.Float,!0),this.registerInput("a",N.Float,!0),this.registerOutput("rgba",N.Color4),this.registerOutput("rgb",N.Color3)}getClassName(){return"ColorMergerBlock"}get rgbIn(){return this._inputs[0]}get r(){return this._inputs[1]}get g(){return this._inputs[2]}get b(){return this._inputs[3]}get a(){return this._inputs[4]}get rgba(){return this._outputs[0]}get rgbOut(){return this._outputs[1]}get rgb(){return this.rgbOut}_inputRename(e){return e==="rgb "?"rgbIn":e}_buildSwizzle(e){return"."+(this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle).substr(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.r,i=this.g,r=this.b,s=this.a,n=this.rgbIn,a=this._outputs[0],l=this._outputs[1];return n.isConnected?(a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = vec4(${n.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\r
`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = ${n.associatedVariableName}${this._buildSwizzle(3)};\r
`)):(a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\r
`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = vec3(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};\r
`)),this}serialize(){const e=super.serialize();return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e}_deserialize(e,t,i){var r,s,n,a;super._deserialize(e,t,i),this.rSwizzle=(r=e.rSwizzle)!==null&&r!==void 0?r:"r",this.gSwizzle=(s=e.gSwizzle)!==null&&s!==void 0?s:"g",this.bSwizzle=(n=e.bSwizzle)!==null&&n!==void 0?n:"b",this.aSwizzle=(a=e.aSwizzle)!==null&&a!==void 0?a:"a"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.rSwizzle = "${this.rSwizzle}";\r
`,e+=`${this._codeVariableName}.gSwizzle = "${this.gSwizzle}";\r
`,e+=`${this._codeVariableName}.bSwizzle = "${this.bSwizzle}";\r
`,e+=`${this._codeVariableName}.aSwizzle = "${this.aSwizzle}";\r
`,e}}ye("BABYLON.ColorMergerBlock",DN);class NN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("xyzw",N.Vector4,!0),this.registerInput("xyz ",N.Vector3,!0),this.registerInput("xy ",N.Vector2,!0),this.registerOutput("xyz",N.Vector3),this.registerOutput("xy",N.Vector2),this.registerOutput("zw",N.Vector2),this.registerOutput("x",N.Float),this.registerOutput("y",N.Float),this.registerOutput("z",N.Float),this.registerOutput("w",N.Float),this.inputsAreExclusive=!0}getClassName(){return"VectorSplitterBlock"}get xyzw(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get xyzOut(){return this._outputs[0]}get xyOut(){return this._outputs[1]}get zw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get w(){return this._outputs[6]}_inputRename(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}}_outputRename(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],r=this._outputs[1],s=this._outputs[2],n=this._outputs[3],a=this._outputs[4],l=this._outputs[5],c=this._outputs[6];return i.hasEndpoints&&(t===this.xyIn?e.compilationString+=this._declareOutput(i,e)+` = vec3(${t.associatedVariableName}, 0.0);\r
`:e.compilationString+=this._declareOutput(i,e)+` = ${t.associatedVariableName}.xyz;\r
`),s.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=this._declareOutput(s,e)+` = ${this.xyzw.associatedVariableName}.zw;\r
`),r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+` = ${t.associatedVariableName}.xy;\r
`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${t.associatedVariableName}.x;\r
`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${t.associatedVariableName}.y;\r
`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = ${t.associatedVariableName}.z;\r
`),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+` = ${t.associatedVariableName}.w;\r
`),this}}ye("BABYLON.VectorSplitterBlock",NN);class wN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("left",N.AutoDetect),this.registerInput("right",N.AutoDetect),this.registerInput("gradient",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(N.Float)}getClassName(){return"LerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});\r
`,this}}ye("BABYLON.LerpBlock",wN);class FN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("left",N.AutoDetect),this.registerInput("right",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"DivideBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};\r
`,this}}ye("BABYLON.DivideBlock",FN);class LN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("left",N.AutoDetect),this.registerInput("right",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"SubtractBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};\r
`,this}}ye("BABYLON.SubtractBlock",LN);class BN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("value",N.Float),this.registerInput("edge",N.Float),this.registerOutput("output",N.Float)}getClassName(){return"StepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});\r
`,this}}ye("BABYLON.StepBlock",BN);class EE extends rt{constructor(e){super(e,W.Neutral),this.registerInput("input",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0].excludedConnectionPointTypes.push(N.Matrix)}getClassName(){return"OneMinusBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = 1. - ${this.input.associatedVariableName};\r
`,this}}ye("BABYLON.OneMinusBlock",EE);ye("BABYLON.OppositeBlock",EE);class bE extends rt{constructor(e){super(e,W.Neutral),this.registerInput("worldPosition",N.Vector4),this.registerInput("cameraPosition",N.Vector3),this.registerOutput("output",N.Vector3)}getClassName(){return"ViewDirectionBlock"}get worldPosition(){return this._inputs[0]}get cameraPosition(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Rt.CameraPosition);t||(t=new yt("cameraPosition"),t.setAsSystemValue(Rt.CameraPosition)),t.output.connectTo(this.cameraPosition)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = normalize(${this.cameraPosition.associatedVariableName} - ${this.worldPosition.associatedVariableName}.xyz);\r
`,this}}ye("BABYLON.ViewDirectionBlock",bE);class UN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("worldNormal",N.Vector4),this.registerInput("viewDirection",N.Vector3),this.registerInput("bias",N.Float),this.registerInput("power",N.Float),this.registerOutput("fresnel",N.Float)}getClassName(){return"FresnelBlock"}get worldNormal(){return this._inputs[0]}get viewDirection(){return this._inputs[1]}get bias(){return this._inputs[2]}get power(){return this._inputs[3]}get fresnel(){return this._outputs[0]}autoConfigure(e){if(!this.viewDirection.isConnected){const t=new bE("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){const t=new yt("bias");t.value=0,t.output.connectTo(this.bias)}if(!this.power.isConnected){const t=new yt("power");t.value=1,t.output.connectTo(this.power)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitFunctionFromInclude("fresnelFunction",t,{removeIfDef:!0}),e.compilationString+=this._declareOutput(this.fresnel,e)+` = computeFresnelTerm(${this.viewDirection.associatedVariableName}.xyz, ${this.worldNormal.associatedVariableName}.xyz, ${this.bias.associatedVariableName}, ${this.power.associatedVariableName});\r
`,this}}ye("BABYLON.FresnelBlock",UN);class VN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("left",N.AutoDetect),this.registerInput("right",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MaxBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r
`,this}}ye("BABYLON.MaxBlock",VN);class kN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("left",N.AutoDetect),this.registerInput("right",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MinBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r
`,this}}ye("BABYLON.MinBlock",kN);class GN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("left",N.AutoDetect),this.registerInput("right",N.AutoDetect),this.registerOutput("output",N.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(N.Float),this._inputs[0].excludedConnectionPointTypes.push(N.Matrix),this._inputs[1].excludedConnectionPointTypes.push(N.Float),this._inputs[1].excludedConnectionPointTypes.push(N.Matrix)}getClassName(){return"DistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = length(${this.left.associatedVariableName} - ${this.right.associatedVariableName});\r
`,this}}ye("BABYLON.DistanceBlock",GN);class zN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("value",N.AutoDetect),this.registerOutput("output",N.Float),this._inputs[0].excludedConnectionPointTypes.push(N.Float),this._inputs[0].excludedConnectionPointTypes.push(N.Matrix)}getClassName(){return"LengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = length(${this.value.associatedVariableName});\r
`,this}}ye("BABYLON.LengthBlock",zN);class HN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("value",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NegateBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = -1.0 * ${this.value.associatedVariableName};\r
`,this}}ye("BABYLON.NegateBlock",HN);class WN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("value",N.AutoDetect),this.registerInput("power",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"PowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = pow(${this.value.associatedVariableName}, ${this.power.associatedVariableName});\r
`,this}}ye("BABYLON.PowBlock",WN);class XN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("seed",N.AutoDetect),this.registerOutput("output",N.Float),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(N.Vector2|N.Vector3|N.Vector4|N.Color3|N.Color4)}getClassName(){return"RandomNumberBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+=this._declareOutput(t,e)+` = getRand(${this.seed.associatedVariableName}.xy);\r
`,this}}ye("BABYLON.RandomNumberBlock",XN);class $N extends rt{constructor(e){super(e,W.Neutral),this.registerInput("x",N.Float),this.registerInput("y",N.Float),this.registerOutput("output",N.Float)}getClassName(){return"ArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = atan(${this.x.associatedVariableName}, ${this.y.associatedVariableName});\r
`,this}}ye("BABYLON.ArcTan2Block",$N);class YN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("value",N.AutoDetect),this.registerInput("edge0",N.Float),this.registerInput("edge1",N.Float),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = smoothstep(${this.edge0.associatedVariableName}, ${this.edge1.associatedVariableName}, ${this.value.associatedVariableName});\r
`,this}}ye("BABYLON.SmoothStepBlock",YN);class jN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("input",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ReciprocalBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return this.input.type===N.Matrix?e.compilationString+=this._declareOutput(t,e)+` = inverse(${this.input.associatedVariableName});\r
`:e.compilationString+=this._declareOutput(t,e)+` = 1. / ${this.input.associatedVariableName};\r
`,this}}ye("BABYLON.ReciprocalBlock",jN);class KN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("value",N.AutoDetect),this.registerInput("reference",N.AutoDetect),this.registerInput("distance",N.Float),this.registerInput("replacement",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(N.Float),this._inputs[0].excludedConnectionPointTypes.push(N.Matrix),this._inputs[1].excludedConnectionPointTypes.push(N.Float),this._inputs[1].excludedConnectionPointTypes.push(N.Matrix),this._inputs[3].excludedConnectionPointTypes.push(N.Float),this._inputs[3].excludedConnectionPointTypes.push(N.Matrix)}getClassName(){return"ReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+`;\r
`,e.compilationString+=`if (length(${this.value.associatedVariableName} - ${this.reference.associatedVariableName}) < ${this.distance.associatedVariableName}) {\r
`,e.compilationString+=`${t.associatedVariableName} = ${this.replacement.associatedVariableName};\r
`,e.compilationString+=`} else {\r
`,e.compilationString+=`${t.associatedVariableName} = ${this.value.associatedVariableName};\r
`,e.compilationString+=`}\r
`,this}}ye("BABYLON.ReplaceColorBlock",KN);class qN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("value",N.AutoDetect),this.registerInput("steps",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(N.Matrix),this._inputs[1].excludedConnectionPointTypes.push(N.Matrix)}getClassName(){return"PosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = floor(${this.value.associatedVariableName} / (1.0 / ${this.steps.associatedVariableName})) * (1.0 / ${this.steps.associatedVariableName});\r
`,this}}ye("BABYLON.PosterizeBlock",qN);var Hc;(function(o){o[o.SawTooth=0]="SawTooth",o[o.Square=1]="Square",o[o.Triangle=2]="Triangle"})(Hc||(Hc={}));class QN extends rt{constructor(e){super(e,W.Neutral),this.kind=Hc.SawTooth,this.registerInput("input",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(N.Matrix)}getClassName(){return"WaveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];switch(this.kind){case Hc.SawTooth:{e.compilationString+=this._declareOutput(t,e)+` = ${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName});\r
`;break}case Hc.Square:{e.compilationString+=this._declareOutput(t,e)+` = 1.0 - 2.0 * round(fract(${this.input.associatedVariableName}));\r
`;break}case Hc.Triangle:{e.compilationString+=this._declareOutput(t,e)+` = 2.0 * abs(2.0 * (${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName}))) - 1.0;\r
`;break}}return this}serialize(){const e=super.serialize();return e.kind=this.kind,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.kind=e.kind}}ye("BABYLON.WaveBlock",QN);class M_{get step(){return this._step}set step(e){this._step=e}get color(){return this._color}set color(e){this._color=e}constructor(e,t){this.step=e,this.color=t}}class ZN extends rt{colorStepsUpdated(){this.onValueChangedObservable.notifyObservers(this)}constructor(e){super(e,W.Neutral),this.colorSteps=[new M_(0,ge.Black()),new M_(1,ge.White())],this.onValueChangedObservable=new Q,this.registerInput("gradient",N.AutoDetect),this.registerOutput("output",N.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(N.Float|N.Vector2|N.Vector3|N.Vector4|N.Color3|N.Color4)}getClassName(){return"GradientBlock"}get gradient(){return this._inputs[0]}get output(){return this._outputs[0]}_writeColorConstant(e){const t=this.colorSteps[e];return`vec3(${t.color.r}, ${t.color.g}, ${t.color.b})`}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];if(!this.colorSteps.length||!this.gradient.connectedPoint){e.compilationString+=this._declareOutput(t,e)+` = vec3(0., 0., 0.);\r
`;return}const i=e._getFreeVariableName("gradientTempColor"),r=e._getFreeVariableName("gradientTempPosition");e.compilationString+=`vec3 ${i} = ${this._writeColorConstant(0)};\r
`,e.compilationString+=`float ${r};\r
`;let s=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==N.Float&&(s+=".x");for(let n=1;n<this.colorSteps.length;n++){const a=this.colorSteps[n],l=this.colorSteps[n-1];e.compilationString+=`${r} = clamp((${s} - ${e._emitFloat(l.step)}) / (${e._emitFloat(a.step)} -  ${e._emitFloat(l.step)}), 0.0, 1.0) * step(${e._emitFloat(n)}, ${e._emitFloat(this.colorSteps.length-1)});\r
`,e.compilationString+=`${i} = mix(${i}, ${this._writeColorConstant(n)}, ${r});\r
`}return e.compilationString+=this._declareOutput(t,e)+` = ${i};\r
`,this}serialize(){const e=super.serialize();e.colorSteps=[];for(const t of this.colorSteps)e.colorSteps.push({step:t.step,color:{r:t.color.r,g:t.color.g,b:t.color.b}});return e}_deserialize(e,t,i){super._deserialize(e,t,i),this.colorSteps.length=0;for(const r of e.colorSteps)this.colorSteps.push(new M_(r.step,new ge(r.color.r,r.color.g,r.color.b)))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();e+=`${this._codeVariableName}.colorSteps = [];\r
`;for(const t of this.colorSteps)e+=`${this._codeVariableName}.colorSteps.push(new BABYLON.GradientBlockColorStep(${t.step}, new BABYLON.Color3(${t.color.r}, ${t.color.g}, ${t.color.b})));\r
`;return e}}ye("BABYLON.GradientBlock",ZN);class JN extends rt{constructor(e){super(e,W.Neutral),this.registerInput("left",N.AutoDetect),this.registerInput("right",N.AutoDetect),this.registerInput("gradient",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(N.Float)}getClassName(){return"NLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = normalize(mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName}));\r
`,this}}ye("BABYLON.NLerpBlock",JN);class SE extends rt{constructor(e){super(e,W.Neutral),this.manhattanDistance=!1,this.registerInput("seed",N.Vector3),this.registerInput("jitter",N.Float),this.registerOutput("output",N.Vector2),this.registerOutput("x",N.Float),this.registerOutput("y",N.Float)}getClassName(){return"WorleyNoise3DBlock"}get seed(){return this._inputs[0]}get jitter(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)return;let t=`vec3 permute(vec3 x){\r
`;t+=`    return mod((34.0 * x + 1.0) * x, 289.0);\r
`,t+=`}\r
\r
`,t+=`vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\r
`,t+=`    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\r
`,t+=`}\r
\r
`,t+=`vec2 worley(vec3 P, float jitter, bool manhattanDistance){\r
`,t+=`    float K = 0.142857142857; // 1/7\r
`,t+=`    float Ko = 0.428571428571; // 1/2-K/2\r
`,t+=`    float  K2 = 0.020408163265306; // 1/(7*7)\r
`,t+=`    float Kz = 0.166666666667; // 1/6\r
`,t+=`    float Kzo = 0.416666666667; // 1/2-1/6*2\r
`,t+=`\r
`,t+=`    vec3 Pi = mod(floor(P), 289.0);\r
`,t+=`    vec3 Pf = fract(P) - 0.5;\r
`,t+=`\r
`,t+=`    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\r
`,t+=`    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\r
`,t+=`    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\r
`,t+=`\r
`,t+=`    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\r
`,t+=`    vec3 p1 = permute(p + Pi.y - 1.0);\r
`,t+=`    vec3 p2 = permute(p + Pi.y);\r
`,t+=`    vec3 p3 = permute(p + Pi.y + 1.0);\r
`,t+=`\r
`,t+=`    vec3 p11 = permute(p1 + Pi.z - 1.0);\r
`,t+=`    vec3 p12 = permute(p1 + Pi.z);\r
`,t+=`    vec3 p13 = permute(p1 + Pi.z + 1.0);\r
`,t+=`\r
`,t+=`    vec3 p21 = permute(p2 + Pi.z - 1.0);\r
`,t+=`    vec3 p22 = permute(p2 + Pi.z);\r
`,t+=`    vec3 p23 = permute(p2 + Pi.z + 1.0);\r
`,t+=`\r
`,t+=`    vec3 p31 = permute(p3 + Pi.z - 1.0);\r
`,t+=`    vec3 p32 = permute(p3 + Pi.z);\r
`,t+=`    vec3 p33 = permute(p3 + Pi.z + 1.0);\r
`,t+=`\r
`,t+=`    vec3 ox11 = fract(p11*K) - Ko;\r
`,t+=`    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\r
`,t+=`\r
`,t+=`    vec3 ox12 = fract(p12*K) - Ko;\r
`,t+=`    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox13 = fract(p13*K) - Ko;\r
`,t+=`    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox21 = fract(p21*K) - Ko;\r
`,t+=`    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox22 = fract(p22*K) - Ko;\r
`,t+=`    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox23 = fract(p23*K) - Ko;\r
`,t+=`    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox31 = fract(p31*K) - Ko;\r
`,t+=`    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox32 = fract(p32*K) - Ko;\r
`,t+=`    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox33 = fract(p33*K) - Ko;\r
`,t+=`    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 dx11 = Pfx + jitter*ox11;\r
`,t+=`    vec3 dy11 = Pfy.x + jitter*oy11;\r
`,t+=`    vec3 dz11 = Pfz.x + jitter*oz11;\r
`,t+=`\r
`,t+=`    vec3 dx12 = Pfx + jitter*ox12;\r
`,t+=`    vec3 dy12 = Pfy.x + jitter*oy12;\r
`,t+=`    vec3 dz12 = Pfz.y + jitter*oz12;\r
`,t+=`\r
`,t+=`    vec3 dx13 = Pfx + jitter*ox13;\r
`,t+=`    vec3 dy13 = Pfy.x + jitter*oy13;\r
`,t+=`    vec3 dz13 = Pfz.z + jitter*oz13;\r
`,t+=`\r
`,t+=`    vec3 dx21 = Pfx + jitter*ox21;\r
`,t+=`    vec3 dy21 = Pfy.y + jitter*oy21;\r
`,t+=`    vec3 dz21 = Pfz.x + jitter*oz21;\r
`,t+=`\r
`,t+=`    vec3 dx22 = Pfx + jitter*ox22;\r
`,t+=`    vec3 dy22 = Pfy.y + jitter*oy22;\r
`,t+=`    vec3 dz22 = Pfz.y + jitter*oz22;\r
`,t+=`\r
`,t+=`    vec3 dx23 = Pfx + jitter*ox23;\r
`,t+=`    vec3 dy23 = Pfy.y + jitter*oy23;\r
`,t+=`    vec3 dz23 = Pfz.z + jitter*oz23;\r
`,t+=`\r
`,t+=`    vec3 dx31 = Pfx + jitter*ox31;\r
`,t+=`    vec3 dy31 = Pfy.z + jitter*oy31;\r
`,t+=`    vec3 dz31 = Pfz.x + jitter*oz31;\r
`,t+=`\r
`,t+=`    vec3 dx32 = Pfx + jitter*ox32;\r
`,t+=`    vec3 dy32 = Pfy.z + jitter*oy32;\r
`,t+=`    vec3 dz32 = Pfz.y + jitter*oz32;\r
`,t+=`\r
`,t+=`    vec3 dx33 = Pfx + jitter*ox33;\r
`,t+=`    vec3 dy33 = Pfy.z + jitter*oy33;\r
`,t+=`    vec3 dz33 = Pfz.z + jitter*oz33;\r
`,t+=`\r
`,t+=`    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\r
`,t+=`    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\r
`,t+=`    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\r
`,t+=`    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\r
`,t+=`    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\r
`,t+=`    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\r
`,t+=`    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\r
`,t+=`    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\r
`,t+=`    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\r
`,t+=`\r
`,t+=`    vec3 d1a = min(d11, d12);\r
`,t+=`    d12 = max(d11, d12);\r
`,t+=`    d11 = min(d1a, d13); // Smallest now not in d12 or d13\r
`,t+=`    d13 = max(d1a, d13);\r
`,t+=`    d12 = min(d12, d13); // 2nd smallest now not in d13\r
`,t+=`    vec3 d2a = min(d21, d22);\r
`,t+=`    d22 = max(d21, d22);\r
`,t+=`    d21 = min(d2a, d23); // Smallest now not in d22 or d23\r
`,t+=`    d23 = max(d2a, d23);\r
`,t+=`    d22 = min(d22, d23); // 2nd smallest now not in d23\r
`,t+=`    vec3 d3a = min(d31, d32);\r
`,t+=`    d32 = max(d31, d32);\r
`,t+=`    d31 = min(d3a, d33); // Smallest now not in d32 or d33\r
`,t+=`    d33 = max(d3a, d33);\r
`,t+=`    d32 = min(d32, d33); // 2nd smallest now not in d33\r
`,t+=`    vec3 da = min(d11, d21);\r
`,t+=`    d21 = max(d11, d21);\r
`,t+=`    d11 = min(da, d31); // Smallest now in d11\r
`,t+=`    d31 = max(da, d31); // 2nd smallest now not in d31\r
`,t+=`    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\r
`,t+=`    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\r
`,t+=`    d12 = min(d12, d21); // 2nd smallest now not in d21\r
`,t+=`    d12 = min(d12, d22); // nor in d22\r
`,t+=`    d12 = min(d12, d31); // nor in d31\r
`,t+=`    d12 = min(d12, d32); // nor in d32\r
`,t+=`    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\r
`,t+=`    d11.y = min(d11.y,d12.z); // Only two more to go\r
`,t+=`    d11.y = min(d11.y,d11.z); // Done! (Phew!)\r
`,t+=`    return sqrt(d11.xy); // F1, F2\r
`,t+=`}\r
\r
`,e._emitFunction("worley3D",t,"// Worley3D");const i=e._getFreeVariableName("worleyTemp");return e.compilationString+=`vec2 ${i} = worley(${this.seed.associatedVariableName}, ${this.jitter.associatedVariableName}, ${this.manhattanDistance});\r
`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${i};\r
`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${i}.x;\r
`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${i}.y;\r
`),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.manhattanDistance = ${this.manhattanDistance};\r
`}serialize(){const e=super.serialize();return e.manhattanDistance=this.manhattanDistance,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.manhattanDistance=e.manhattanDistance}}M([Xt("Use Manhattan Distance",zt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],SE.prototype,"manhattanDistance",void 0);ye("BABYLON.WorleyNoise3DBlock",SE);class e1 extends rt{constructor(e){super(e,W.Neutral),this.registerInput("seed",N.Vector3),this.registerOutput("output",N.Float)}getClassName(){return"SimplexPerlin3DBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;let t=`const float SKEWFACTOR = 1.0/3.0;\r
`;return t+=`const float UNSKEWFACTOR = 1.0/6.0;\r
`,t+=`const float SIMPLEX_CORNER_POS = 0.5;\r
`,t+=`const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\r
`,t+=`float SimplexPerlin3D( vec3 P ){\r
`,t+=`    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\r
`,t+=`    P *= SIMPLEX_TETRAHADRON_HEIGHT;\r
`,t+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",t+=`    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\r
`,t+=`    vec3 g = step(x0.yzx, x0.xyz);\r
`,t+=`    vec3 l = 1.0 - g;\r
`,t+=`    vec3 Pi_1 = min( g.xyz, l.zxy );\r
`,t+=`    vec3 Pi_2 = max( g.xyz, l.zxy );\r
`,t+=`    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\r
`,t+=`    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\r
`,t+=`    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\r
`,t+=`    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\r
`,t+=`    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\r
`,t+=`    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\r
`,t+=`    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\r
`,t+=`    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\r
`,t+=`    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\r
`,t+=`    Pt *= Pt;\r
`,t+=`    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\r
`,t+=`    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\r
`,t+=`    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\r
`,t+=`    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\r
`,t+=`    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\r
`,t+=`    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\r
`,t+=`    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\r
`,t+=`    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\r
`,t+=`    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\r
`,t+=`    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\r
`,t+=`    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\r
`,t+=`    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\r
`,t+=`    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\r
`,t+=`    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\r
`,t+=`    kernel_weights = max(0.5 - kernel_weights, 0.0);\r
`,t+=`    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\r
`,t+=`    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\r
`,t+=`}\r
`,e._emitFunction("SimplexPerlin3D",t,"// SimplexPerlin3D"),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = SimplexPerlin3D(${this.seed.associatedVariableName});\r
`,this}}ye("BABYLON.SimplexPerlin3DBlock",e1);class t1 extends rt{constructor(e){super(e,W.Neutral),this.registerInput("normalMap0",N.AutoDetect),this.registerInput("normalMap1",N.AutoDetect),this.registerOutput("output",N.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(N.Color3|N.Color4|N.Vector3|N.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(N.Color3|N.Color4|N.Vector3|N.Vector4)}getClassName(){return"NormalBlendBlock"}get normalMap0(){return this._inputs[0]}get normalMap1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0],r=this._inputs[1],s=e._getFreeVariableName("stepR"),n=e._getFreeVariableName("stepG");return e.compilationString+=`float ${s} = step(0.5, ${i.associatedVariableName}.r);\r
`,e.compilationString+=`float ${n} = step(0.5, ${i.associatedVariableName}.g);\r
`,e.compilationString+=this._declareOutput(t,e)+`;\r
`,e.compilationString+=`${t.associatedVariableName}.r = (1.0 - ${s}) * ${i.associatedVariableName}.r * ${r.associatedVariableName}.r * 2.0 + ${s} * (1.0 - (1.0 - ${i.associatedVariableName}.r) * (1.0 - ${r.associatedVariableName}.r) * 2.0);\r
`,e.compilationString+=`${t.associatedVariableName}.g = (1.0 - ${n}) * ${i.associatedVariableName}.g * ${r.associatedVariableName}.g * 2.0 + ${n} * (1.0 - (1.0 - ${i.associatedVariableName}.g) * (1.0 - ${r.associatedVariableName}.g) * 2.0);\r
`,e.compilationString+=`${t.associatedVariableName}.b = ${i.associatedVariableName}.b * ${r.associatedVariableName}.b;\r
`,this}}ye("BABYLON.NormalBlendBlock",t1);class i1 extends rt{constructor(e){super(e,W.Neutral),this.registerInput("input",N.Vector2),this.registerInput("angle",N.Float),this.registerOutput("output",N.Vector2)}getClassName(){return"Rotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new yt("angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.angle,r=this.input;return e.compilationString+=this._declareOutput(t,e)+` = vec2(cos(${i.associatedVariableName}) * ${r.associatedVariableName}.x - sin(${i.associatedVariableName}) * ${r.associatedVariableName}.y, sin(${i.associatedVariableName}) * ${r.associatedVariableName}.x + cos(${i.associatedVariableName}) * ${r.associatedVariableName}.y);\r
`,this}}ye("BABYLON.Rotate2dBlock",i1);class r1 extends rt{constructor(e){super(e,W.Neutral),this.registerInput("incident",N.AutoDetect),this.registerInput("normal",N.AutoDetect),this.registerOutput("output",N.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(N.Vector3|N.Vector4|N.Color3|N.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(N.Vector3|N.Vector4|N.Color3|N.Color4)}getClassName(){return"ReflectBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = reflect(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz);\r
`,this}}ye("BABYLON.ReflectBlock",r1);class s1 extends rt{constructor(e){super(e,W.Neutral),this.registerInput("incident",N.AutoDetect),this.registerInput("normal",N.AutoDetect),this.registerInput("ior",N.Float),this.registerOutput("output",N.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(N.Vector3|N.Vector4|N.Color3|N.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(N.Vector3|N.Vector4|N.Color3|N.Color4)}getClassName(){return"RefractBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get ior(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = refract(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz, ${this.ior.associatedVariableName});\r
`,this}}ye("BABYLON.RefractBlock",s1);class n1 extends rt{constructor(e){super(e,W.Neutral),this.registerInput("color",N.Color3),this.registerInput("level",N.Float),this.registerOutput("output",N.Color3)}getClassName(){return"DesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],r=this.color.associatedVariableName,s=e._getFreeVariableName("colorMin"),n=e._getFreeVariableName("colorMax"),a=e._getFreeVariableName("colorMerge");return e.compilationString+=`float ${s} = min(min(${r}.x, ${r}.y), ${r}.z);\r
`,e.compilationString+=`float ${n} = max(max(${r}.x, ${r}.y), ${r}.z);\r
`,e.compilationString+=`float ${a} = 0.5 * (${s} + ${n});\r
`,e.compilationString+=this._declareOutput(t,e)+` = mix(${r}, vec3(${a}, ${a}, ${a}), ${this.level.associatedVariableName});\r
`,this}}ye("BABYLON.DesaturateBlock",n1);class Sh extends rt{constructor(e){super(e,W.Fragment),this.albedoScaling=!1,this.linkSheenWithAlbedo=!1,this._isUnique=!0,this.registerInput("intensity",N.Float,!0,W.Fragment),this.registerInput("color",N.Color3,!0,W.Fragment),this.registerInput("roughness",N.Float,!0,W.Fragment),this.registerOutput("sheen",N.Object,W.Fragment,new Rr("sheen",this,nr.Output,Sh,"SheenBlock"))}initialize(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")}getClassName(){return"SheenBlock"}get intensity(){return this._inputs[0]}get color(){return this._inputs[1]}get roughness(){return this._inputs[2]}get sheen(){return this._outputs[0]}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("SHEEN",!0),i.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),i.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),i.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)}getCode(e){let t="";const i=this.color.isConnected?this.color.associatedVariableName:"vec3(1.)",r=this.intensity.isConnected?this.intensity.associatedVariableName:"1.",s=this.roughness.isConnected?this.roughness.associatedVariableName:"0.";return t=`#ifdef SHEEN
            sheenOutParams sheenOut;

            vec4 vSheenColor = vec4(${i}, ${r});

            sheenBlock(
                vSheenColor,
            #ifdef SHEEN_ROUGHNESS
                ${s},
            #endif
                roughness,
            #ifdef SHEEN_TEXTURE
                vec4(0.),
                1.0,
            #endif
                reflectance,
            #ifdef SHEEN_LINKWITHALBEDO
                baseColor,
                surfaceAlbedo,
            #endif
            #ifdef ENVIRONMENTBRDF
                NdotV,
                environmentBrdf,
            #endif
            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
                AARoughnessFactors,
                ${e==null?void 0:e._vReflectionMicrosurfaceInfosName},
                ${e==null?void 0:e._vReflectionInfosName},
                ${e==null?void 0:e.reflectionColor},
                vLightingIntensity,
                #ifdef ${e==null?void 0:e._define3DName}
                    ${e==null?void 0:e._cubeSamplerName},
                #else
                    ${e==null?void 0:e._2DSamplerName},
                #endif
                reflectionOut.reflectionCoords,
                NdotVUnclamped,
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${e==null?void 0:e._define3DName}
                        ${e==null?void 0:e._cubeSamplerName},
                        ${e==null?void 0:e._cubeSamplerName},
                    #else
                        ${e==null?void 0:e._2DSamplerName},
                        ${e==null?void 0:e._2DSamplerName},
                    #endif
                #endif
                #if !defined(${e==null?void 0:e._defineSkyboxName}) && defined(RADIANCEOCCLUSION)
                    seo,
                #endif
                #if !defined(${e==null?void 0:e._defineSkyboxName}) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(${e==null?void 0:e._define3DName})
                    eho,
                #endif
            #endif
                sheenOut
            );

            #ifdef SHEEN_LINKWITHALBEDO
                surfaceAlbedo = sheenOut.surfaceAlbedo;
            #endif
        #endif\r
`,t}_buildBlock(e){return e.target===W.Fragment&&e.sharedData.blocksWithDefines.push(this),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.albedoScaling = ${this.albedoScaling};\r
`,e+=`${this._codeVariableName}.linkSheenWithAlbedo = ${this.linkSheenWithAlbedo};\r
`,e}serialize(){const e=super.serialize();return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo}}M([Xt("Albedo scaling",zt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Sh.prototype,"albedoScaling",void 0);M([Xt("Link sheen with albedo",zt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Sh.prototype,"linkSheenWithAlbedo",void 0);ye("BABYLON.SheenBlock",Sh);class jf extends rt{constructor(e){super(e,W.Fragment),this._tangentCorrectionFactorName="",this._isUnique=!0,this.registerInput("intensity",N.Float,!0,W.Fragment),this.registerInput("direction",N.Vector2,!0,W.Fragment),this.registerInput("uv",N.Vector2,!0),this.registerInput("worldTangent",N.Vector4,!0),this.registerInput("TBN",N.Object,!0,W.VertexAndFragment,new Rr("TBN",this,nr.Input,bh,"TBNBlock")),this.registerOutput("anisotropy",N.Object,W.Fragment,new Rr("anisotropy",this,nr.Output,jf,"AnisotropyBlock"))}initialize(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")}getClassName(){return"AnisotropyBlock"}get intensity(){return this._inputs[0]}get direction(){return this._inputs[1]}get uv(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get TBN(){return this._inputs[4]}get anisotropy(){return this._outputs[0]}_generateTBNSpace(e){let t="";const i=`//${this.name}`,r=this.uv,s=this.worldPositionConnectionPoint,n=this.worldNormalConnectionPoint,a=this.worldTangent;r.isConnected||console.error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const l={search:/defined\(TANGENT\)/g,replace:a.isConnected?"defined(TANGENT)":"defined(IGNORE)"},c=this.TBN;return c.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            mat3 vTBN = ${c.associatedVariableName};
            #endif
            `:a.isConnected&&(t+=`vec3 tbnNormal = normalize(${n.associatedVariableName}.xyz);\r
`,t+=`vec3 tbnTangent = normalize(${a.associatedVariableName}.xyz);\r
`,t+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\r
`,t+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),t+=`
            #if defined(${a.isConnected?"TANGENT":"IGNORE"}) && defined(NORMAL)
                mat3 TBN = vTBN;
            #else
                mat3 TBN = cotangent_frame(${n.associatedVariableName+".xyz"}, ${"v_"+s.associatedVariableName+".xyz"}, ${r.isConnected?r.associatedVariableName:"vec2(0.)"}, vec2(1., 1.));
            #endif\r
`,e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[l]}),t}getCode(e,t=!1){let i="";t&&(i+=this._generateTBNSpace(e));const r=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0",s=this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)";return i+=`anisotropicOutParams anisotropicOut;
            anisotropicBlock(
                vec3(${s}, ${r}),
            #ifdef ANISOTROPIC_TEXTURE
                vec3(0.),
            #endif
                TBN,
                normalW,
                viewDirectionW,
                anisotropicOut
            );\r
`,i}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("ANISOTROPIC",!0),i.setValue("ANISOTROPIC_TEXTURE",!1,!0)}bind(e,t,i){super.bind(e,t,i),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_buildBlock(e){return e.target===W.Fragment&&(e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float")),this}}ye("BABYLON.AnisotropyBlock",jf);class yh extends Su{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The position input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?W.Fragment:W.Vertex,this.generateOnlyFragmentCode&&(this.forceIrradianceInFragment=!0)}constructor(e){super(e),this.useSphericalHarmonics=!0,this.forceIrradianceInFragment=!1,this._isUnique=!0,this.registerInput("position",N.AutoDetect,!1,W.Vertex),this.registerInput("world",N.Matrix,!1,W.Vertex),this.registerInput("color",N.Color3,!0,W.Fragment),this.registerOutput("reflection",N.Object,W.Fragment,new Rr("reflection",this,nr.Output,yh,"ReflectionBlock")),this.position.addExcludedConnectionPointFromAllowedTypes(N.Color3|N.Vector3|N.Vector4)}getClassName(){return"ReflectionBlock"}get position(){return this._inputs[0]}get worldPosition(){return this.worldPositionConnectionPoint}get worldNormal(){return this.worldNormalConnectionPoint}get world(){return this._inputs[1]}get cameraPosition(){return this.cameraPositionConnectionPoint}get view(){return this.viewConnectionPoint}get color(){return this._inputs[2]}get reflection(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}get reflectionColor(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const r=this._getTexture(),s=r&&r.getTextureMatrix;i.setValue("REFLECTION",s,!0),s&&(i.setValue(this._defineLODReflectionAlpha,r.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularReflection,r.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!r.invertZ:r.invertZ,!0),i.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),i.setValue("GAMMAREFLECTION",r.gammaSpace,!0),i.setValue("RGBDREFLECTION",r.isRGBD,!0),r&&r.coordinatesMode!==Y.SKYBOX_MODE&&r.isCube&&(i.setValue("USESPHERICALFROMREFLECTIONMAP",!0),i.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?i.setValue("USESPHERICALINVERTEX",!1):i.setValue("USESPHERICALINVERTEX",!0)))}bind(e,t,i,r){super.bind(e,t,i);const s=this._getTexture();if(!s||!r)return;s.isCube?e.setTexture(this._cubeSamplerName,s):e.setTexture(this._2DSamplerName,s);const n=s.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,n,s.lodGenerationScale,s.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,n,Ee.Log2(n));const a=r.materialDefines,l=s.sphericalPolynomial;if(a.USESPHERICALFROMREFLECTIONMAP&&l)if(a.SPHERICAL_HARMONICS){const c=l.preScaledHarmonics;e.setVector3("vSphericalL00",c.l00),e.setVector3("vSphericalL1_1",c.l1_1),e.setVector3("vSphericalL10",c.l10),e.setVector3("vSphericalL11",c.l11),e.setVector3("vSphericalL2_2",c.l2_2),e.setVector3("vSphericalL2_1",c.l2_1),e.setVector3("vSphericalL20",c.l20),e.setVector3("vSphericalL21",c.l21),e.setVector3("vSphericalL22",c.l22)}else e.setFloat3("vSphericalX",l.x.x,l.x.y,l.x.z),e.setFloat3("vSphericalY",l.y.x,l.y.y,l.y.z),e.setFloat3("vSphericalZ",l.z.x,l.z.y,l.z.z),e.setFloat3("vSphericalXX_ZZ",l.xx.x-l.zz.x,l.xx.y-l.zz.y,l.xx.z-l.zz.z),e.setFloat3("vSphericalYY_ZZ",l.yy.x-l.zz.x,l.yy.y-l.zz.y,l.yy.z-l.zz.z),e.setFloat3("vSphericalZZ",l.zz.x,l.zz.y,l.zz.z),e.setFloat3("vSphericalXY",l.xy.x,l.xy.y,l.xy.z),e.setFloat3("vSphericalYZ",l.yz.x,l.yz.y,l.yz.z),e.setFloat3("vSphericalZX",l.zx.x,l.zx.y,l.zx.z)}handleVertexSide(e){let t=super.handleVertexSide(e);e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});const i=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,"vec3","defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX","vec3","SPHERICAL_HARMONICS",!0),t+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
                vec3 ${i} = vec3(${this._reflectionMatrixName} * vec4(normalize(${this.worldNormal.associatedVariableName}).xyz, 0)).xyz;
                #ifdef ${this._defineOppositeZ}
                    ${i}.z *= -1.0;
                #endif
                ${this._vEnvironmentIrradianceName} = computeEnvironmentIrradiance(${i});
            #endif\r
`,t}getCode(e,t){let i="";this.handleFragmentSideInits(e),e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),e._emitFunction("sampleReflection",`
            #ifdef ${this._define3DName}
                #define sampleReflection(s, c) textureCube(s, c)
            #else
                #define sampleReflection(s, c) texture2D(s, c)
            #endif\r
`,`//${this.name}`),e._emitFunction("sampleReflectionLod",`
            #ifdef ${this._define3DName}
                #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)
            #else
                #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)
            #endif\r
`,`//${this.name}`);const r=`
            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {
                ${this.handleFragmentSideCodeReflectionCoords("worldNormal","worldPos",!0,!0)}
                return ${this._reflectionVectorName};
            }\r
`;return e._emitFunction("computeReflectionCoordsPBR",r,`//${this.name}`),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,"vec3"),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,"vec2"),i+=`#ifdef REFLECTION
            vec2 ${this._vReflectionInfosName} = vec2(1., 0.);

            reflectionOutParams reflectionOut;

            reflectionBlock(
                ${this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName}.xyz,
                ${t},
                alphaG,
                ${this._vReflectionMicrosurfaceInfosName},
                ${this._vReflectionInfosName},
                ${this.reflectionColor},
            #ifdef ANISOTROPIC
                anisotropicOut,
            #endif
            #if defined(${this._defineLODReflectionAlpha}) && !defined(${this._defineSkyboxName})
                NdotVUnclamped,
            #endif
            #ifdef ${this._defineLinearSpecularReflection}
                roughness,
            #endif
            #ifdef ${this._define3DName}
                ${this._cubeSamplerName},
            #else
                ${this._2DSamplerName},
            #endif
            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)
                ${this._vEnvironmentIrradianceName},
            #endif
            #ifdef USESPHERICALFROMREFLECTIONMAP
                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                    ${this._reflectionMatrixName},
                #endif
            #endif
            #ifdef USEIRRADIANCEMAP
                irradianceSampler, // ** not handled **
            #endif
            #ifndef LODBASEDMICROSFURACE
                #ifdef ${this._define3DName}
                    ${this._cubeSamplerName},
                    ${this._cubeSamplerName},
                #else
                    ${this._2DSamplerName},
                    ${this._2DSamplerName},
                #endif
            #endif
            #ifdef REALTIME_FILTERING
                ${this._vReflectionFilteringInfoName},
            #endif
                reflectionOut
            );
        #endif\r
`,i}_buildBlock(e){return this._scene=e.sharedData.scene,e.target!==W.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture.gammaSpace = ${this.texture.gammaSpace};\r
`),e+=`${this._codeVariableName}.useSphericalHarmonics = ${this.useSphericalHarmonics};\r
`,e+=`${this._codeVariableName}.forceIrradianceInFragment = ${this.forceIrradianceInFragment};\r
`,e}serialize(){var e,t;const i=super.serialize();return i.useSphericalHarmonics=this.useSphericalHarmonics,i.forceIrradianceInFragment=this.forceIrradianceInFragment,i.gammaSpace=(t=(e=this.texture)===null||e===void 0?void 0:e.gammaSpace)!==null&&t!==void 0?t:!0,i}_deserialize(e,t,i){super._deserialize(e,t,i),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)}}M([Xt("Spherical Harmonics",zt.Boolean,"ADVANCED",{notifiers:{update:!0}})],yh.prototype,"useSphericalHarmonics",void 0);M([Xt("Force irradiance in fragment",zt.Boolean,"ADVANCED",{notifiers:{update:!0}})],yh.prototype,"forceIrradianceInFragment",void 0);ye("BABYLON.ReflectionBlock",yh);class ph extends rt{constructor(e){super(e,W.Fragment),this._tangentCorrectionFactorName="",this.remapF0OnInterfaceChange=!0,this._isUnique=!0,this.registerInput("intensity",N.Float,!1,W.Fragment),this.registerInput("roughness",N.Float,!0,W.Fragment),this.registerInput("indexOfRefraction",N.Float,!0,W.Fragment),this.registerInput("normalMapColor",N.Color3,!0,W.Fragment),this.registerInput("uv",N.Vector2,!0,W.Fragment),this.registerInput("tintColor",N.Color3,!0,W.Fragment),this.registerInput("tintAtDistance",N.Float,!0,W.Fragment),this.registerInput("tintThickness",N.Float,!0,W.Fragment),this.registerInput("worldTangent",N.Vector4,!0),this.registerInput("worldNormal",N.AutoDetect,!0),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(N.Color4|N.Vector4|N.Vector3),this.registerInput("TBN",N.Object,!0,W.VertexAndFragment,new Rr("TBN",this,nr.Input,bh,"TBNBlock")),this.registerOutput("clearcoat",N.Object,W.Fragment,new Rr("clearcoat",this,nr.Output,ph,"ClearCoatBlock"))}initialize(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams"),e._excludeVariableName("vGeometricNormaClearCoatW")}getClassName(){return"ClearCoatBlock"}get intensity(){return this._inputs[0]}get roughness(){return this._inputs[1]}get indexOfRefraction(){return this._inputs[2]}get normalMapColor(){return this._inputs[3]}get uv(){return this._inputs[4]}get tintColor(){return this._inputs[5]}get tintAtDistance(){return this._inputs[6]}get tintThickness(){return this._inputs[7]}get worldTangent(){return this._inputs[8]}get worldNormal(){return this._inputs[9]}get TBN(){return this._inputs[10]}get clearcoat(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new yt("ClearCoat intensity",W.Fragment,N.Float);e.value=1,e.output.connectTo(this.intensity)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("CLEARCOAT",!0),i.setValue("CLEARCOAT_TEXTURE",!1,!0),i.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),i.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),i.setValue("CLEARCOAT_DEFAULTIOR",this.indexOfRefraction.isConnected?this.indexOfRefraction.connectInputBlock.value===as._DefaultIndexOfRefraction:!0,!0),i.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)}bind(e,t,i){var r,s;super.bind(e,t,i);const n=(s=(r=this.indexOfRefraction.connectInputBlock)===null||r===void 0?void 0:r.value)!==null&&s!==void 0?s:as._DefaultIndexOfRefraction,a=1-n,l=1+n,c=Math.pow(-a/l,2),h=1/n;e.setFloat4("vClearCoatRefractionParams",c,h,a,l);const u=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,d=u!=null&&u.perturbedNormal.isConnected?u.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",d!=null&&d.invertX?1:-1,d!=null&&d.invertY?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",d!=null&&d.invertX?-1:1,d!=null&&d.invertY?-1:1),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_generateTBNSpace(e,t,i){let r="";const s=`//${this.name}`,n=this.worldTangent;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const a={search:/defined\(TANGENT\)/g,replace:n.isConnected?"defined(TANGENT)":"defined(IGNORE)"},l=this.TBN;return l.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            mat3 vTBN = ${l.associatedVariableName};
            #endif
            `:n.isConnected&&(r+=`vec3 tbnNormal = normalize(${i}.xyz);\r
`,r+=`vec3 tbnTangent = normalize(${n.associatedVariableName}.xyz);\r
`,r+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\r
`,r+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",s,{replaceStrings:[a]}),r}static GetCode(e,t,i,r,s,n,a){let l="";const c=t!=null&&t.intensity.isConnected?t.intensity.associatedVariableName:"1.",h=t!=null&&t.roughness.isConnected?t.roughness.associatedVariableName:"0.",u=t!=null&&t.normalMapColor.isConnected?t.normalMapColor.associatedVariableName:"vec3(0.)",d=t!=null&&t.uv.isConnected?t.uv.associatedVariableName:"vec2(0.)",f=t!=null&&t.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",_=t!=null&&t.tintThickness.isConnected?t.tintThickness.associatedVariableName:"1.",p=t!=null&&t.tintAtDistance.isConnected?t.tintAtDistance.associatedVariableName:"1.",m="vec4(0.)";if(t){e._emitUniformFromString("vClearCoatRefractionParams","vec4"),e._emitUniformFromString("vClearCoatTangentSpaceParams","vec2");const T=t.worldNormal;l+=`vec3 vGeometricNormaClearCoatW = ${T.isConnected?"normalize("+T.associatedVariableName+".xyz)":"geometricNormalW"};\r
`}else l+=`vec3 vGeometricNormaClearCoatW = geometricNormalW;\r
`;return s&&t&&(l+=t._generateTBNSpace(e,r,a),n=t.worldTangent.isConnected),l+=`clearcoatOutParams clearcoatOut;

        #ifdef CLEARCOAT
            vec2 vClearCoatParams = vec2(${c}, ${h});
            vec4 vClearCoatTintParams = vec4(${f}, ${_});

            clearcoatBlock(
                ${r}.xyz,
                vGeometricNormaClearCoatW,
                viewDirectionW,
                vClearCoatParams,
                specularEnvironmentR0,
            #ifdef CLEARCOAT_TEXTURE
                vec2(0.),
            #endif
            #ifdef CLEARCOAT_TINT
                vClearCoatTintParams,
                ${p},
                vClearCoatRefractionParams,
                #ifdef CLEARCOAT_TINT_TEXTURE
                    ${m},
                #endif
            #endif
            #ifdef CLEARCOAT_BUMP
                vec2(0., 1.),
                vec4(${u}, 0.),
                ${d},
                #if defined(${n?"TANGENT":"IGNORE"}) && defined(NORMAL)
                    vTBN,
                #else
                    vClearCoatTangentSpaceParams,
                #endif
                #ifdef OBJECTSPACE_NORMALMAP
                    normalMatrix,
                #endif
            #endif
            #if defined(FORCENORMALFORWARD) && defined(NORMAL)
                faceNormal,
            #endif
            #ifdef REFLECTION
                ${i==null?void 0:i._vReflectionMicrosurfaceInfosName},
                ${i==null?void 0:i._vReflectionInfosName},
                ${i==null?void 0:i.reflectionColor},
                vLightingIntensity,
                #ifdef ${i==null?void 0:i._define3DName}
                    ${i==null?void 0:i._cubeSamplerName},
                #else
                    ${i==null?void 0:i._2DSamplerName},
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${i==null?void 0:i._define3DName}
                        ${i==null?void 0:i._cubeSamplerName},
                        ${i==null?void 0:i._cubeSamplerName},
                    #else
                        ${i==null?void 0:i._2DSamplerName},
                        ${i==null?void 0:i._2DSamplerName},
                    #endif
                #endif
            #endif
            #if defined(ENVIRONMENTBRDF) && !defined(${i==null?void 0:i._defineSkyboxName})
                #ifdef RADIANCEOCCLUSION
                    ambientMonochrome,
                #endif
            #endif
            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
                (gl_FrontFacing ? 1. : -1.),
            #endif
                clearcoatOut
            );
        #else
            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;
        #endif\r
`,l}_buildBlock(e){return this._scene=e.sharedData.scene,e.target===W.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.remapF0OnInterfaceChange = ${this.remapF0OnInterfaceChange};\r
`,e}serialize(){const e=super.serialize();return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e}_deserialize(e,t,i){var r;super._deserialize(e,t,i),this.remapF0OnInterfaceChange=(r=e.remapF0OnInterfaceChange)!==null&&r!==void 0?r:!0}}M([Xt("Remap F0 on interface change",zt.Boolean,"ADVANCED")],ph.prototype,"remapF0OnInterfaceChange",void 0);ye("BABYLON.ClearCoatBlock",ph);class yu extends rt{constructor(e){super(e,W.Fragment),this._isUnique=!0,this.registerInput("intensity",N.Float,!0,W.Fragment),this.registerInput("indexOfRefraction",N.Float,!0,W.Fragment),this.registerInput("thickness",N.Float,!0,W.Fragment),this.registerOutput("iridescence",N.Object,W.Fragment,new Rr("iridescence",this,nr.Output,yu,"IridescenceBlock"))}initialize(e){e._excludeVariableName("iridescenceOut"),e._excludeVariableName("vIridescenceParams")}getClassName(){return"IridescenceBlock"}get intensity(){return this._inputs[0]}get indexOfRefraction(){return this._inputs[1]}get thickness(){return this._inputs[2]}get iridescence(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new yt("Iridescence intensity",W.Fragment,N.Float);e.value=1,e.output.connectTo(this.intensity);const t=new yt("Iridescence ior",W.Fragment,N.Float);t.value=1.3,t.output.connectTo(this.indexOfRefraction);const i=new yt("Iridescence thickness",W.Fragment,N.Float);i.value=400,i.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("IRIDESCENCE",!0,!0),i.setValue("IRIDESCENCE_TEXTURE",!1,!0),i.setValue("IRIDESCENCE_THICKNESS_TEXTURE",!1,!0)}static GetCode(e){let t="";const i=e!=null&&e.intensity.isConnected?e.intensity.associatedVariableName:"1.",r=e!=null&&e.indexOfRefraction.isConnected?e.indexOfRefraction.associatedVariableName:ln._DefaultIndexOfRefraction,s=e!=null&&e.thickness.isConnected?e.thickness.associatedVariableName:ln._DefaultMaximumThickness;return t+=`iridescenceOutParams iridescenceOut;

        #ifdef IRIDESCENCE
            iridescenceBlock(
                vec4(${i}, ${r}, 1., ${s}),
                NdotV,
                specularEnvironmentR0,
                #ifdef CLEARCOAT
                    NdotVUnclamped,
                #endif
                iridescenceOut
            );

            float iridescenceIntensity = iridescenceOut.iridescenceIntensity;
            specularEnvironmentR0 = iridescenceOut.specularEnvironmentR0;
        #endif\r
`,t}_buildBlock(e){return e.target===W.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this}serialize(){return super.serialize()}_deserialize(e,t,i){super._deserialize(e,t,i)}}ye("BABYLON.IridescenceBlock",yu);class Tc extends rt{constructor(e){super(e,W.Fragment),this.linkRefractionWithTransparency=!1,this.invertRefractionY=!1,this.useThicknessAsDepth=!1,this._isUnique=!0,this.registerInput("intensity",N.Float,!1,W.Fragment),this.registerInput("tintAtDistance",N.Float,!0,W.Fragment),this.registerInput("volumeIndexOfRefraction",N.Float,!0,W.Fragment),this.registerOutput("refraction",N.Object,W.Fragment,new Rr("refraction",this,nr.Output,Tc,"RefractionBlock"))}initialize(e){e._excludeVariableName("vRefractionPosition"),e._excludeVariableName("vRefractionSize")}getClassName(){return"RefractionBlock"}get intensity(){return this._inputs[0]}get tintAtDistance(){return this._inputs[1]}get volumeIndexOfRefraction(){return this._inputs[2]}get view(){return this.viewConnectionPoint}get refraction(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}autoConfigure(e){if(!this.intensity.isConnected){const t=new yt("Refraction intensity",W.Fragment,N.Float);t.value=1,t.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Rt.View);t||(t=new yt("view"),t.setAsSystemValue(Rt.View)),t.output.connectTo(this.view)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const r=this._getTexture(),s=r&&r.getTextureMatrix;i.setValue("SS_REFRACTION",s,!0),s&&(i.setValue(this._define3DName,r.isCube,!0),i.setValue(this._defineLODRefractionAlpha,r.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularRefraction,r.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!r.invertZ:r.invertZ,!0),i.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),i.setValue("SS_GAMMAREFRACTION",r.gammaSpace,!0),i.setValue("SS_RGBDREFRACTION",r.isRGBD,!0),i.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!r.boundingBoxSize,!0),i.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){var r,s,n,a;super.bind(e,t,i);const l=this._getTexture();if(!l)return;l.isCube?e.setTexture(this._cubeSamplerName,l):e.setTexture(this._2DSamplerName,l),e.setMatrix(this._refractionMatrixName,l.getReflectionTextureMatrix());let c=1;l.isCube||l.depth&&(c=l.depth);const h=(a=(s=(r=this.volumeIndexOfRefraction.connectInputBlock)===null||r===void 0?void 0:r.value)!==null&&s!==void 0?s:(n=this.indexOfRefractionConnectionPoint.connectInputBlock)===null||n===void 0?void 0:n.value)!==null&&a!==void 0?a:1.5;e.setFloat4(this._vRefractionInfosName,l.level,1/h,c,this.invertRefractionY?-1:1),e.setFloat4(this._vRefractionMicrosurfaceInfosName,l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset,1/h);const u=l.getSize().width;if(e.setFloat2(this._vRefractionFilteringInfoName,u,Ee.Log2(u)),l.boundingBoxSize){const d=l;e.setVector3("vRefractionPosition",d.boundingBoxPosition),e.setVector3("vRefractionSize",d.boundingBoxSize)}}getCode(e){const t="";return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),e._samplerDeclaration+=`#ifdef ${this._define3DName}\r
`,e._samplerDeclaration+=`uniform samplerCube ${this._cubeSamplerName};\r
`,e._samplerDeclaration+=`#else\r
`,e._samplerDeclaration+=`uniform sampler2D ${this._2DSamplerName};\r
`,e._samplerDeclaration+=`#endif\r
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,"mat4"),e._emitFunction("sampleRefraction",`
            #ifdef ${this._define3DName}
                #define sampleRefraction(s, c) textureCube(s, c)
            #else
                #define sampleRefraction(s, c) texture2D(s, c)
            #endif\r
`,`//${this.name}`),e._emitFunction("sampleRefractionLod",`
            #ifdef ${this._define3DName}
                #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)
            #else
                #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)
            #endif\r
`,`//${this.name}`),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,"vec4"),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,"vec4"),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,"vec2"),e._emitUniformFromString("vRefractionPosition","vec3"),e._emitUniformFromString("vRefractionSize","vec3"),t}_buildBlock(e){return this._scene=e.sharedData.scene,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(this.texture.isCube?e=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}");\r
`:e=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}");\r
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r
`),e+=`${this._codeVariableName}.linkRefractionWithTransparency = ${this.linkRefractionWithTransparency};\r
`,e+=`${this._codeVariableName}.invertRefractionY = ${this.invertRefractionY};\r
`,e+=`${this._codeVariableName}.useThicknessAsDepth = ${this.useThicknessAsDepth};\r
`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e.useThicknessAsDepth=this.useThicknessAsDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,e.texture.isCube?this.texture=ns.Parse(e.texture,t,i):this.texture=Y.Parse(e.texture,t,i)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY,this.useThicknessAsDepth=!!e.useThicknessAsDepth}}M([Xt("Link refraction to transparency",zt.Boolean,"ADVANCED",{notifiers:{update:!0}})],Tc.prototype,"linkRefractionWithTransparency",void 0);M([Xt("Invert refraction Y",zt.Boolean,"ADVANCED",{notifiers:{update:!0}})],Tc.prototype,"invertRefractionY",void 0);M([Xt("Use thickness as depth",zt.Boolean,"ADVANCED",{notifiers:{update:!0}})],Tc.prototype,"useThicknessAsDepth",void 0);ye("BABYLON.RefractionBlock",Tc);class Cu extends rt{constructor(e){super(e,W.Fragment),this._isUnique=!0,this.registerInput("thickness",N.Float,!1,W.Fragment),this.registerInput("tintColor",N.Color3,!0,W.Fragment),this.registerInput("translucencyIntensity",N.Float,!0,W.Fragment),this.registerInput("translucencyDiffusionDist",N.Color3,!0,W.Fragment),this.registerInput("refraction",N.Object,!0,W.Fragment,new Rr("refraction",this,nr.Input,Tc,"RefractionBlock")),this.registerOutput("subsurface",N.Object,W.Fragment,new Rr("subsurface",this,nr.Output,Cu,"SubSurfaceBlock"))}initialize(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vSubSurfaceIntensity")}getClassName(){return"SubSurfaceBlock"}get thickness(){return this._inputs[0]}get tintColor(){return this._inputs[1]}get translucencyIntensity(){return this._inputs[2]}get translucencyDiffusionDist(){return this._inputs[3]}get refraction(){return this._inputs[4]}get subsurface(){return this._outputs[0]}autoConfigure(){if(!this.thickness.isConnected){const e=new yt("SubSurface thickness",W.Fragment,N.Float);e.value=0,e.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const r=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;i.setValue("SUBSURFACE",r||this.refraction.isConnected,!0),i.setValue("SS_TRANSLUCENCY",r,!0),i.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),i.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),i.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),i.setValue("SS_MASK_FROM_THICKNESS_TEXTURE",!1,!0),i.setValue("SS_USE_GLTF_TEXTURES",!1,!0)}static GetCode(e,t,i,r){var s,n,a,l,c,h,u,d,f,_,p,m,T,b,y,S;let C="";const I=t!=null&&t.thickness.isConnected?t.thickness.associatedVariableName:"0.",P=t!=null&&t.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",D=t!=null&&t.translucencyIntensity.isConnected?t==null?void 0:t.translucencyIntensity.associatedVariableName:"1.",w=t!=null&&t.translucencyDiffusionDist.isConnected?t==null?void 0:t.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",L=t!=null&&t.refraction.isConnected?(s=t==null?void 0:t.refraction.connectedPoint)===null||s===void 0?void 0:s.ownerBlock:null,U=L!=null&&L.tintAtDistance.isConnected?L.tintAtDistance.associatedVariableName:"1.",G=L!=null&&L.intensity.isConnected?L.intensity.associatedVariableName:"1.",Z=L!=null&&L.view.isConnected?L.view.associatedVariableName:"";return C+=(n=L==null?void 0:L.getCode(e))!==null&&n!==void 0?n:"",C+=`subSurfaceOutParams subSurfaceOut;

        #ifdef SUBSURFACE
            vec2 vThicknessParam = vec2(0., ${I});
            vec4 vTintColor = vec4(${P}, ${U});
            vec3 vSubSurfaceIntensity = vec3(${G}, ${D}, 0.);

            subSurfaceBlock(
                vSubSurfaceIntensity,
                vThicknessParam,
                vTintColor,
                normalW,
                specularEnvironmentReflectance,
            #ifdef SS_THICKNESSANDMASK_TEXTURE
                vec4(0.),
            #endif
            #ifdef REFLECTION
                #ifdef SS_TRANSLUCENCY
                    ${i==null?void 0:i._reflectionMatrixName},
                    #ifdef USESPHERICALFROMREFLECTIONMAP
                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                            reflectionOut.irradianceVector,
                        #endif
                        #if defined(REALTIME_FILTERING)
                            ${i==null?void 0:i._cubeSamplerName},
                            ${i==null?void 0:i._vReflectionFilteringInfoName},
                        #endif
                        #endif
                    #ifdef USEIRRADIANCEMAP
                        irradianceSampler,
                    #endif
                #endif
            #endif
            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
                surfaceAlbedo,
            #endif
            #ifdef SS_REFRACTION
                ${r}.xyz,
                viewDirectionW,
                ${Z},
                ${(a=L==null?void 0:L._vRefractionInfosName)!==null&&a!==void 0?a:""},
                ${(l=L==null?void 0:L._refractionMatrixName)!==null&&l!==void 0?l:""},
                ${(c=L==null?void 0:L._vRefractionMicrosurfaceInfosName)!==null&&c!==void 0?c:""},
                vLightingIntensity,
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha,
                #endif
                #ifdef ${(h=L==null?void 0:L._defineLODRefractionAlpha)!==null&&h!==void 0?h:"IGNORE"}
                    NdotVUnclamped,
                #endif
                #ifdef ${(u=L==null?void 0:L._defineLinearSpecularRefraction)!==null&&u!==void 0?u:"IGNORE"}
                    roughness,
                #endif
                alphaG,
                #ifdef ${(d=L==null?void 0:L._define3DName)!==null&&d!==void 0?d:"IGNORE"}
                    ${(f=L==null?void 0:L._cubeSamplerName)!==null&&f!==void 0?f:""},
                #else
                    ${(_=L==null?void 0:L._2DSamplerName)!==null&&_!==void 0?_:""},
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${(p=L==null?void 0:L._define3DName)!==null&&p!==void 0?p:"IGNORE"}
                        ${(m=L==null?void 0:L._cubeSamplerName)!==null&&m!==void 0?m:""},
                        ${(T=L==null?void 0:L._cubeSamplerName)!==null&&T!==void 0?T:""},
                    #else
                        ${(b=L==null?void 0:L._2DSamplerName)!==null&&b!==void 0?b:""},
                        ${(y=L==null?void 0:L._2DSamplerName)!==null&&y!==void 0?y:""},
                    #endif
                #endif
                #ifdef ANISOTROPIC
                    anisotropicOut,
                #endif
                #ifdef REALTIME_FILTERING
                    ${(S=L==null?void 0:L._vRefractionFilteringInfoName)!==null&&S!==void 0?S:""},
                #endif
                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
                    vRefractionPosition,
                    vRefractionSize,
                #endif
            #endif
            #ifdef SS_TRANSLUCENCY
                ${w},
            #endif
                subSurfaceOut
            );

            #ifdef SS_REFRACTION
                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha = subSurfaceOut.alpha;
                #endif
            #endif
        #else
            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;
        #endif\r
`,C}_buildBlock(e){return e.target===W.Fragment&&e.sharedData.blocksWithDefines.push(this),this}}ye("BABYLON.SubSurfaceBlock",Cu);const a1={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["shadow",""],alpha:["alpha",""]};class jr extends rt{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?W.Fragment:W.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?W.Fragment:W.Vertex}constructor(e){super(e,W.VertexAndFragment),this._environmentBRDFTexture=null,this._metallicReflectanceColor=ge.White(),this._metallicF0Factor=1,this.directIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.lightFalloff=0,this.useAlphaTest=!1,this.alphaTestCutoff=.5,this.useAlphaBlending=!1,this.useRadianceOverAlpha=!0,this.useSpecularOverAlpha=!0,this.enableSpecularAntiAliasing=!1,this.realTimeFiltering=!1,this.realTimeFilteringQuality=8,this.useEnergyConservation=!0,this.useRadianceOcclusion=!0,this.useHorizonOcclusion=!0,this.unlit=!1,this.forceNormalForward=!1,this.generateOnlyFragmentCode=!1,this.debugMode=0,this.debugLimit=0,this.debugFactor=1,this._isUnique=!0,this.registerInput("worldPosition",N.Vector4,!1,W.Vertex),this.registerInput("worldNormal",N.Vector4,!1,W.Fragment),this.registerInput("view",N.Matrix,!1),this.registerInput("cameraPosition",N.Vector3,!1,W.Fragment),this.registerInput("perturbedNormal",N.Vector4,!0,W.Fragment),this.registerInput("baseColor",N.Color3,!0,W.Fragment),this.registerInput("metallic",N.Float,!1,W.Fragment),this.registerInput("roughness",N.Float,!1,W.Fragment),this.registerInput("ambientOcc",N.Float,!0,W.Fragment),this.registerInput("opacity",N.Float,!0,W.Fragment),this.registerInput("indexOfRefraction",N.Float,!0,W.Fragment),this.registerInput("ambientColor",N.Color3,!0,W.Fragment),this.registerInput("reflection",N.Object,!0,W.Fragment,new Rr("reflection",this,nr.Input,yh,"ReflectionBlock")),this.registerInput("clearcoat",N.Object,!0,W.Fragment,new Rr("clearcoat",this,nr.Input,ph,"ClearCoatBlock")),this.registerInput("sheen",N.Object,!0,W.Fragment,new Rr("sheen",this,nr.Input,Sh,"SheenBlock")),this.registerInput("subsurface",N.Object,!0,W.Fragment,new Rr("subsurface",this,nr.Input,Cu,"SubSurfaceBlock")),this.registerInput("anisotropy",N.Object,!0,W.Fragment,new Rr("anisotropy",this,nr.Input,jf,"AnisotropyBlock")),this.registerInput("iridescence",N.Object,!0,W.Fragment,new Rr("iridescence",this,nr.Input,yu,"IridescenceBlock")),this.registerOutput("ambientClr",N.Color3,W.Fragment),this.registerOutput("diffuseDir",N.Color3,W.Fragment),this.registerOutput("specularDir",N.Color3,W.Fragment),this.registerOutput("clearcoatDir",N.Color3,W.Fragment),this.registerOutput("sheenDir",N.Color3,W.Fragment),this.registerOutput("diffuseInd",N.Color3,W.Fragment),this.registerOutput("specularInd",N.Color3,W.Fragment),this.registerOutput("clearcoatInd",N.Color3,W.Fragment),this.registerOutput("sheenInd",N.Color3,W.Fragment),this.registerOutput("refraction",N.Color3,W.Fragment),this.registerOutput("lighting",N.Color3,W.Fragment),this.registerOutput("shadow",N.Float,W.Fragment),this.registerOutput("alpha",N.Float,W.Fragment)}initialize(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode")}getClassName(){return"PBRMetallicRoughnessBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get view(){return this._inputs[2]}get cameraPosition(){return this._inputs[3]}get perturbedNormal(){return this._inputs[4]}get baseColor(){return this._inputs[5]}get metallic(){return this._inputs[6]}get roughness(){return this._inputs[7]}get ambientOcc(){return this._inputs[8]}get opacity(){return this._inputs[9]}get indexOfRefraction(){return this._inputs[10]}get ambientColor(){return this._inputs[11]}get reflection(){return this._inputs[12]}get clearcoat(){return this._inputs[13]}get sheen(){return this._inputs[14]}get subsurface(){return this._inputs[15]}get anisotropy(){return this._inputs[16]}get iridescence(){return this._inputs[17]}get ambientClr(){return this._outputs[0]}get diffuseDir(){return this._outputs[1]}get specularDir(){return this._outputs[2]}get clearcoatDir(){return this._outputs[3]}get sheenDir(){return this._outputs[4]}get diffuseInd(){return this._outputs[5]}get specularInd(){return this._outputs[6]}get clearcoatInd(){return this._outputs[7]}get sheenInd(){return this._outputs[8]}get refraction(){return this._outputs[9]}get lighting(){return this._outputs[10]}get shadow(){return this._outputs[11]}get alpha(){return this._outputs[12]}autoConfigure(e){if(!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Rt.CameraPosition);t||(t=new yt("cameraPosition"),t.setAsSystemValue(Rt.CameraPosition)),t.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Rt.View);t||(t=new yt("view"),t.setAsSystemValue(Rt.View)),t.output.connectTo(this.view)}}prepareDefines(e,t,i){i.setValue("PBR",!0),i.setValue("METALLICWORKFLOW",!0),i.setValue("DEBUGMODE",this.debugMode,!0),i.setValue("NORMALXYSCALE",!0),i.setValue("BUMP",this.perturbedNormal.isConnected,!0),i.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),i.setValue("ALBEDO",!1,!0),i.setValue("OPACITY",this.opacity.isConnected,!0),i.setValue("AMBIENT",!0,!0),i.setValue("AMBIENTINGRAYSCALE",!1,!0),i.setValue("REFLECTIVITY",!1,!0),i.setValue("AOSTOREINMETALMAPRED",!1,!0),i.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===ei.LIGHTFALLOFF_STANDARD?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===ei.LIGHTFALLOFF_GLTF?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!0)):(i.setValue("USEPHYSICALLIGHTFALLOFF",!0),i.setValue("USEGLTFLIGHTFALLOFF",!1));const r=this.alphaTestCutoff.toString();i.setValue("ALPHABLEND",this.useAlphaBlending,!0),i.setValue("ALPHAFROMALBEDO",!1,!0),i.setValue("ALPHATEST",this.useAlphaTest,!0),i.setValue("ALPHATESTVALUE",r.indexOf(".")<0?r+".":r,!0),i.setValue("OPACITYRGB",!1,!0),i.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),i.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),i.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),i.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);const s=e.getScene();if(s.getEngine()._features.needTypeSuffixInShaderConstants?i.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):i.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),i.setValue("BRDF_V_HEIGHT_CORRELATED",!0),i.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),i.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),i.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),i.setValue("UNLIT",this.unlit,!0),i.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&Me.ReflectionTextureEnabled?(i.setValue("ENVIRONMENTBRDF",!0),i.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(i.setValue("ENVIRONMENTBRDF",!1),i.setValue("ENVIRONMENTBRDF_RGBD",!1)),i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i),!!i._areLightsDirty)if(!this.light)Ce.PrepareDefinesForLights(s,e,i,!0,t.maxSimultaneousLights),i._needNormals=!0,Ce.PrepareDefinesForMultiview(s,i);else{const a={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};Ce.PrepareDefinesForLight(s,e,this.light,this._lightId,i,!0,a),a.needRebuild&&i.rebuild()}}updateUniformsAndSamples(e,t,i,r){for(let s=0;s<t.maxSimultaneousLights&&i["LIGHT"+s];s++){const n=e.uniforms.indexOf("vLightData"+s)>=0;Ce.PrepareUniformsAndSamplersForLight(s,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+s],r,n)}}isReady(e,t,i){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady()||i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}bind(e,t,i){var r,s;if(!i)return;const n=i.getScene();this.light?Ce.BindLight(this.light,this._lightId,n,e,!0):Ce.BindLights(n,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);const a=this._scene.ambientColor;a&&e.setColor3("ambientFromScene",a);const l=n.useRightHandedSystem===(n._mirroredCameraPosition!=null);e.setFloat(this._invertNormalName,l?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);const c=1,h=(s=(r=this.indexOfRefraction.connectInputBlock)===null||r===void 0?void 0:r.value)!==null&&s!==void 0?s:1.5,u=Math.pow((h-c)/(h+c),2);this._metallicReflectanceColor.scaleToRef(u*this._metallicF0Factor,Jt.Color3[0]);const d=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,Jt.Color3[0],d),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_injectVertexCode(e){var t,i;const r=this.worldPosition,s=`//${this.name}`;this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",s,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",s,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const n="v_"+r.associatedVariableName;e._emitVaryingFromString(n,"vec4")&&(e.compilationString+=`${n} = ${r.associatedVariableName};\r
`);const a=this.reflection.isConnected?(t=this.reflection.connectedPoint)===null||t===void 0?void 0:t.ownerBlock:null;a&&(a.viewConnectionPoint=this.view),e.compilationString+=(i=a==null?void 0:a.handleVertexSide(e))!==null&&i!==void 0?i:"",e._emitVaryingFromString("vClipSpacePosition","vec4","defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+=`#if DEBUGMODE > 0\r
`,e._injectAtEnd+=`vClipSpacePosition = gl_Position;\r
`,e._injectAtEnd+=`#endif\r
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",s,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:r.associatedVariableName}]}):(e.compilationString+=`vec4 worldPos = ${r.associatedVariableName};\r
`,this.view.isConnected&&(e.compilationString+=`mat4 view = ${this.view.associatedVariableName};\r
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",s,{repeatKey:"maxSimultaneousLights"}))}_getAlbedoOpacityCode(){let e=`albedoOpacityOutParams albedoOpacityOut;\r
`;const t=this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)",i=this.opacity.isConnected?this.opacity.associatedVariableName:"1.";return e+=`albedoOpacityBlock(
                vec4(${t}, 1.),
            #ifdef ALBEDO
                vec4(1.),
                vec2(1., 1.),
            #endif
            #ifdef OPACITY
                vec4(${i}),
                vec2(1., 1.),
            #endif
                albedoOpacityOut
            );

            vec3 surfaceAlbedo = albedoOpacityOut.surfaceAlbedo;
            float alpha = albedoOpacityOut.alpha;\r
`,e}_getAmbientOcclusionCode(){let e=`ambientOcclusionOutParams aoOut;\r
`;const t=this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1.";return e+=`ambientOcclusionBlock(
            #ifdef AMBIENT
                vec3(${t}),
                vec4(0., 1.0, 1.0, 0.),
            #endif
                aoOut
            );\r
`,e}_getReflectivityCode(e){let t=`reflectivityOutParams reflectivityOut;\r
`;const i="1.";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,"vec4"),t+=`vec3 baseColor = surfaceAlbedo;

            reflectivityBlock(
                vec4(${this.metallic.associatedVariableName}, ${this.roughness.associatedVariableName}, 0., 0.),
            #ifdef METALLICWORKFLOW
                surfaceAlbedo,
                ${this._vMetallicReflectanceFactorsName},
            #endif
            #ifdef REFLECTIVITY
                vec3(0., 0., ${i}),
                vec4(1.),
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor,
            #endif
            #ifdef MICROSURFACEMAP
                microSurfaceTexel, <== not handled!
            #endif
                reflectivityOut
            );

            float microSurface = reflectivityOut.microSurface;
            float roughness = reflectivityOut.roughness;

            #ifdef METALLICWORKFLOW
                surfaceAlbedo = reflectivityOut.surfaceAlbedo;
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;
            #endif\r
`,t}_buildBlock(e){var t,i,r,s,n,a,l,c,h,u,d,f,_,p,m,T,b,y,S,C,I,P,D,w,L,U,G,Z,he,_e,ne,Pe,Se,ce,de,k,se,xe,le,je,st;super._buildBlock(e),this._scene=e.sharedData.scene,this._environmentBRDFTexture||(this._environmentBRDFTexture=Om(this._scene));const be=this.reflection.isConnected?(t=this.reflection.connectedPoint)===null||t===void 0?void 0:t.ownerBlock:null;if(be&&(be.worldPositionConnectionPoint=this.worldPosition,be.cameraPositionConnectionPoint=this.cameraPosition,be.worldNormalConnectionPoint=this.worldNormal,be.viewConnectionPoint=this.view),e.target!==W.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const We=`//${this.name}`,Ct=this.perturbedNormal;let _t=this.worldPosition.associatedVariableName;this.generateOnlyFragmentCode?(_t=e._getFreeVariableName("globalWorldPos"),e._emitFunction("pbr_globalworldpos",`vec3 ${_t};\r
`,We),e.compilationString+=`${_t} = ${this.worldPosition.associatedVariableName}.xyz;\r
`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",We,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${this.worldPosition.associatedVariableName}`:void 0}),e.compilationString+=`#if DEBUGMODE > 0\r
`,e.compilationString+=`vec4 vClipSpacePosition = vec4((vec2(gl_FragCoord.xy) / vec2(1.0)) * 2.0 - 1.0, 0.0, 1.0);\r
`,e.compilationString+=`#endif\r
`):_t="v_"+_t,this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitUniformFromString("vDebugMode","vec2","defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene","vec3"),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",We,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",We,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),e._emitFunctionFromInclude("helperFunctions",We),e._emitFunctionFromInclude("importanceSampling",We),e._emitFunctionFromInclude("pbrHelperFunctions",We),e._emitFunctionFromInclude("imageProcessingDeclaration",We),e._emitFunctionFromInclude("imageProcessingFunctions",We),e._emitFunctionFromInclude("shadowsFragmentFunctions",We,{replaceStrings:[{search:/vPositionW/g,replace:_t+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",We,{replaceStrings:[{search:/vPositionW/g,replace:_t+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",We),e._emitFunctionFromInclude("pbrBRDFFunctions",We,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(i=be==null?void 0:be._defineSkyboxName)!==null&&i!==void 0?i:"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",We),e._emitFunctionFromInclude("pbrDirectLightingFunctions",We,{replaceStrings:[{search:/vPositionW/g,replace:_t+".xyz"}]}),e._emitFunctionFromInclude("pbrIBLFunctions",We),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",We),e._emitFunctionFromInclude("pbrBlockReflectivity",We),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",We),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",We),e._emitFunctionFromInclude("pbrBlockAnisotropic",We),e._emitUniformFromString("vLightingIntensity","vec4"),be!=null&&be.generateOnlyFragmentCode&&(e.compilationString+=be.handleVertexSide(e)),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+=`vec4 ${this._vNormalWName} = normalize(${this.worldNormal.associatedVariableName});\r
`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${_t}.xyz);\r
`),e.compilationString+=`vec3 geometricNormalW = ${this._vNormalWName}.xyz;\r
`,e.compilationString+=`vec3 normalW = ${Ct.isConnected?"normalize("+Ct.associatedVariableName+".xyz)":"geometricNormalW"};\r
`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,"float"),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",We,{replaceStrings:[{search:/vPositionW/g,replace:_t+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(),e.compilationString+=e._emitCodeFromInclude("depthPrePass",We),e.compilationString+=this._getAmbientOcclusionCode(),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",We),e.compilationString+=`#ifdef UNLIT
                vec3 diffuseBase = vec3(1., 1., 1.);
            #else\r
`,e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",We,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(r=be==null?void 0:be._defineSkyboxName)!==null&&r!==void 0?r:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(s=be==null?void 0:be._define3DName)!==null&&s!==void 0?s:"REFLECTIONMAP_3D"}]});const mt=this.anisotropy.isConnected?(n=this.anisotropy.connectedPoint)===null||n===void 0?void 0:n.ownerBlock:null;mt&&(mt.worldPositionConnectionPoint=this.worldPosition,mt.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=mt.getCode(e,!this.perturbedNormal.isConnected)),be&&be.hasTexture&&(e.compilationString+=be.getCode(e,mt?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",We,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(a=be==null?void 0:be._define3DName)!==null&&a!==void 0?a:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(l=be==null?void 0:be._defineOppositeZ)!==null&&l!==void 0?l:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(c=be==null?void 0:be._defineProjectionName)!==null&&c!==void 0?c:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(h=be==null?void 0:be._defineSkyboxName)!==null&&h!==void 0?h:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(u=be==null?void 0:be._defineLODReflectionAlpha)!==null&&u!==void 0?u:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(d=be==null?void 0:be._defineLinearSpecularReflection)!==null&&d!==void 0?d:"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:(f=be==null?void 0:be._vReflectionFilteringInfoName)!==null&&f!==void 0?f:"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",We,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:this._vMetallicReflectanceFactorsName}]});const Ge=this.sheen.isConnected?(_=this.sheen.connectedPoint)===null||_===void 0?void 0:_.ownerBlock:null;Ge&&(e.compilationString+=Ge.getCode(be)),e._emitFunctionFromInclude("pbrBlockSheen",We,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(p=be==null?void 0:be._define3DName)!==null&&p!==void 0?p:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(m=be==null?void 0:be._defineSkyboxName)!==null&&m!==void 0?m:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(T=be==null?void 0:be._defineLODReflectionAlpha)!==null&&T!==void 0?T:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(b=be==null?void 0:be._defineLinearSpecularReflection)!==null&&b!==void 0?b:"LINEARSPECULARREFLECTION"}]});const Ut=this.iridescence.isConnected?(y=this.iridescence.connectedPoint)===null||y===void 0?void 0:y.ownerBlock:null;e.compilationString+=yu.GetCode(Ut),e._emitFunctionFromInclude("pbrBlockIridescence",We,{replaceStrings:[]});const Ft=this.clearcoat.isConnected?(S=this.clearcoat.connectedPoint)===null||S===void 0?void 0:S.ownerBlock:null,Zt=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,$t=this.perturbedNormal.isConnected&&((I=((C=this.perturbedNormal.connectedPoint)===null||C===void 0?void 0:C.ownerBlock).worldTangent)===null||I===void 0?void 0:I.isConnected),Di=this.anisotropy.isConnected&&((P=this.anisotropy.connectedPoint)===null||P===void 0?void 0:P.ownerBlock).worldTangent.isConnected;let Ui=$t||!this.perturbedNormal.isConnected&&Di;e.compilationString+=ph.GetCode(e,Ft,be,_t,Zt,Ui,this.worldNormal.associatedVariableName),Zt&&(Ui=(D=Ft==null?void 0:Ft.worldTangent.isConnected)!==null&&D!==void 0?D:!1),e._emitFunctionFromInclude("pbrBlockClearcoat",We,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(w=be==null?void 0:be._define3DName)!==null&&w!==void 0?w:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(L=be==null?void 0:be._defineOppositeZ)!==null&&L!==void 0?L:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(U=be==null?void 0:be._defineProjectionName)!==null&&U!==void 0?U:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(G=be==null?void 0:be._defineSkyboxName)!==null&&G!==void 0?G:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(Z=be==null?void 0:be._defineLODReflectionAlpha)!==null&&Z!==void 0?Z:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(he=be==null?void 0:be._defineLinearSpecularReflection)!==null&&he!==void 0?he:"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:Ui?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",We,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(_e=be==null?void 0:be._defineSkyboxName)!==null&&_e!==void 0?_e:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(ne=be==null?void 0:be._define3DName)!==null&&ne!==void 0?ne:"REFLECTIONMAP_3D"}]});const ar=this.subsurface.isConnected?(Pe=this.subsurface.connectedPoint)===null||Pe===void 0?void 0:Pe.ownerBlock:null,ti=this.subsurface.isConnected?(ce=((Se=this.subsurface.connectedPoint)===null||Se===void 0?void 0:Se.ownerBlock).refraction.connectedPoint)===null||ce===void 0?void 0:ce.ownerBlock:null;ti&&(ti.viewConnectionPoint=this.view,ti.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=Cu.GetCode(e,ar,be,_t),e._emitFunctionFromInclude("pbrBlockSubSurface",We,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(de=be==null?void 0:be._define3DName)!==null&&de!==void 0?de:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(k=be==null?void 0:be._defineOppositeZ)!==null&&k!==void 0?k:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(se=be==null?void 0:be._defineProjectionName)!==null&&se!==void 0?se:"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:(xe=ti==null?void 0:ti._define3DName)!==null&&xe!==void 0?xe:"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:(le=ti==null?void 0:ti._defineLODRefractionAlpha)!==null&&le!==void 0?le:"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:(je=ti==null?void 0:ti._defineLinearSpecularRefraction)!==null&&je!==void 0?je:"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:(st=ti==null?void 0:ti._defineOppositeZ)!==null&&st!==void 0?st:"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",We),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",We,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",We,{repeatKey:"maxSimultaneousLights"}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",We),e.compilationString+=`#endif\r
`;const or=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:"vec3(0., 0., 0.)";let pi=ei.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();pi.indexOf(".")===-1&&(pi+="."),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",We,{replaceStrings:[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:/vAmbientColor/g,replace:or+" * ambientFromScene"},{search:/vAmbientInfos\.w/g,replace:pi}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",We,{replaceStrings:[{search:/finalEmissive/g,replace:"vec3(0.)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",We,{replaceStrings:[{search:/visibility/g,replace:"1."}]}),e.compilationString+=e._emitCodeFromInclude("pbrDebug",We,{replaceStrings:[{search:/vNormalW/g,replace:this._vNormalWName},{search:/vPositionW/g,replace:_t},{search:/albedoTexture\.rgb;/g,replace:`vec3(1.);\r
gl_FragColor.rgb = toGammaSpace(gl_FragColor.rgb);\r
`}]});for(const Si of this._outputs)if(Si.hasEndpoints){const mi=a1[Si.name];if(mi){const[Is,cn]=mi;cn&&(e.compilationString+=`#if ${cn}\r
`),e.compilationString+=`${this._declareOutput(Si,e)} = ${Is};\r
`,cn&&(e.compilationString+=`#else\r
`,e.compilationString+=`${this._declareOutput(Si,e)} = vec3(0.);\r
`,e.compilationString+=`#endif\r
`)}else console.error(`There's no remapping for the ${Si.name} end point! No code generated`)}return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.lightFalloff = ${this.lightFalloff};\r
`,e+=`${this._codeVariableName}.useAlphaTest = ${this.useAlphaTest};\r
`,e+=`${this._codeVariableName}.alphaTestCutoff = ${this.alphaTestCutoff};\r
`,e+=`${this._codeVariableName}.useAlphaBlending = ${this.useAlphaBlending};\r
`,e+=`${this._codeVariableName}.useRadianceOverAlpha = ${this.useRadianceOverAlpha};\r
`,e+=`${this._codeVariableName}.useSpecularOverAlpha = ${this.useSpecularOverAlpha};\r
`,e+=`${this._codeVariableName}.enableSpecularAntiAliasing = ${this.enableSpecularAntiAliasing};\r
`,e+=`${this._codeVariableName}.realTimeFiltering = ${this.realTimeFiltering};\r
`,e+=`${this._codeVariableName}.realTimeFilteringQuality = ${this.realTimeFilteringQuality};\r
`,e+=`${this._codeVariableName}.useEnergyConservation = ${this.useEnergyConservation};\r
`,e+=`${this._codeVariableName}.useRadianceOcclusion = ${this.useRadianceOcclusion};\r
`,e+=`${this._codeVariableName}.useHorizonOcclusion = ${this.useHorizonOcclusion};\r
`,e+=`${this._codeVariableName}.unlit = ${this.unlit};\r
`,e+=`${this._codeVariableName}.forceNormalForward = ${this.forceNormalForward};\r
`,e+=`${this._codeVariableName}.debugMode = ${this.debugMode};\r
`,e+=`${this._codeVariableName}.debugLimit = ${this.debugLimit};\r
`,e+=`${this._codeVariableName}.debugFactor = ${this.debugFactor};\r
`,e}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){var r,s;super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=(r=e.lightFalloff)!==null&&r!==void 0?r:0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=(s=e.realTimeFilteringQuality)!==null&&s!==void 0?s:8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor,this.generateOnlyFragmentCode=!!e.generateOnlyFragmentCode,this._setTarget()}}M([Xt("Direct lights",zt.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],jr.prototype,"directIntensity",void 0);M([Xt("Environment lights",zt.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],jr.prototype,"environmentIntensity",void 0);M([Xt("Specular highlights",zt.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],jr.prototype,"specularIntensity",void 0);M([Xt("Light falloff",zt.List,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:ei.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:ei.LIGHTFALLOFF_GLTF},{label:"Standard",value:ei.LIGHTFALLOFF_STANDARD}]})],jr.prototype,"lightFalloff",void 0);M([Xt("Alpha Testing",zt.Boolean,"OPACITY")],jr.prototype,"useAlphaTest",void 0);M([Xt("Alpha CutOff",zt.Float,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],jr.prototype,"alphaTestCutoff",void 0);M([Xt("Alpha blending",zt.Boolean,"OPACITY")],jr.prototype,"useAlphaBlending",void 0);M([Xt("Radiance over alpha",zt.Boolean,"RENDERING",{notifiers:{update:!0}})],jr.prototype,"useRadianceOverAlpha",void 0);M([Xt("Specular over alpha",zt.Boolean,"RENDERING",{notifiers:{update:!0}})],jr.prototype,"useSpecularOverAlpha",void 0);M([Xt("Specular anti-aliasing",zt.Boolean,"RENDERING",{notifiers:{update:!0}})],jr.prototype,"enableSpecularAntiAliasing",void 0);M([Xt("Realtime filtering",zt.Boolean,"RENDERING",{notifiers:{update:!0}})],jr.prototype,"realTimeFiltering",void 0);M([Xt("Realtime filtering quality",zt.List,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],jr.prototype,"realTimeFilteringQuality",void 0);M([Xt("Energy Conservation",zt.Boolean,"ADVANCED",{notifiers:{update:!0}})],jr.prototype,"useEnergyConservation",void 0);M([Xt("Radiance occlusion",zt.Boolean,"ADVANCED",{notifiers:{update:!0}})],jr.prototype,"useRadianceOcclusion",void 0);M([Xt("Horizon occlusion",zt.Boolean,"ADVANCED",{notifiers:{update:!0}})],jr.prototype,"useHorizonOcclusion",void 0);M([Xt("Unlit",zt.Boolean,"ADVANCED",{notifiers:{update:!0}})],jr.prototype,"unlit",void 0);M([Xt("Force normal forward",zt.Boolean,"ADVANCED",{notifiers:{update:!0}})],jr.prototype,"forceNormalForward",void 0);M([Xt("Generate only fragment code",zt.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:jr._OnGenerateOnlyFragmentCodeChanged}})],jr.prototype,"generateOnlyFragmentCode",void 0);M([Xt("Debug mode",zt.List,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87}]})],jr.prototype,"debugMode",void 0);M([Xt("Split position",zt.Float,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],jr.prototype,"debugLimit",void 0);M([Xt("Output factor",zt.Float,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],jr.prototype,"debugFactor",void 0);ye("BABYLON.PBRMetallicRoughnessBlock",jr);class o1 extends rt{constructor(e){super(e,W.Neutral),this.registerInput("left",N.AutoDetect),this.registerInput("right",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"ModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = mod(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r
`,this}}ye("BABYLON.ModBlock",o1);class l1 extends rt{constructor(e){super(e,W.Neutral),this.registerInput("row0",N.Vector4),this.registerInput("row1",N.Vector4),this.registerInput("row2",N.Vector4),this.registerInput("row3",N.Vector4),this.registerOutput("output",N.Matrix)}getClassName(){return"MatrixBuilder"}get row0(){return this._inputs[0]}get row1(){return this._inputs[1]}get row2(){return this._inputs[2]}get row3(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(){if(!this.row0.isConnected){const e=new yt("row0");e.value=new Tt(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){const e=new yt("row1");e.value=new Tt(0,1,0,0),e.output.connectTo(this.row1)}if(!this.row2.isConnected){const e=new yt("row2");e.value=new Tt(0,0,1,0),e.output.connectTo(this.row2)}if(!this.row3.isConnected){const e=new yt("row3");e.value=new Tt(0,0,0,1),e.output.connectTo(this.row3)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.row0,r=this.row1,s=this.row2,n=this.row3;return e.compilationString+=this._declareOutput(t,e)+` = mat4(${i.associatedVariableName}, ${r.associatedVariableName}, ${s.associatedVariableName}, ${n.associatedVariableName});\r
`,this}}ye("BABYLON.MatrixBuilder",l1);var ia;(function(o){o[o.Equal=0]="Equal",o[o.NotEqual=1]="NotEqual",o[o.LessThan=2]="LessThan",o[o.GreaterThan=3]="GreaterThan",o[o.LessOrEqual=4]="LessOrEqual",o[o.GreaterOrEqual=5]="GreaterOrEqual",o[o.Xor=6]="Xor",o[o.Or=7]="Or",o[o.And=8]="And"})(ia||(ia={}));class c1 extends rt{constructor(e){super(e,W.Neutral),this.condition=ia.LessThan,this.registerInput("a",N.Float),this.registerInput("b",N.Float),this.registerInput("true",N.AutoDetect,!0),this.registerInput("false",N.AutoDetect,!0),this.registerOutput("output",N.BasedOnInput),this._linkConnectionTypes(2,3),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=N.Float}getClassName(){return"ConditionalBlock"}get a(){return this._inputs[0]}get b(){return this._inputs[1]}get true(){return this._inputs[2]}get false(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",r=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case ia.Equal:{e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} == ${this.b.associatedVariableName} ? ${i} : ${r};\r
`;break}case ia.NotEqual:{e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} != ${this.b.associatedVariableName} ? ${i} : ${r};\r
`;break}case ia.LessThan:{e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} < ${this.b.associatedVariableName} ? ${i} : ${r};\r
`;break}case ia.LessOrEqual:{e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} <= ${this.b.associatedVariableName} ? ${i} : ${r};\r
`;break}case ia.GreaterThan:{e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} > ${this.b.associatedVariableName} ? ${i} : ${r};\r
`;break}case ia.GreaterOrEqual:{e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} >= ${this.b.associatedVariableName} ? ${i} : ${r};\r
`;break}case ia.Xor:{e.compilationString+=this._declareOutput(t,e)+` = (mod(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 2.0) > 0.0) ? ${i} : ${r};\r
`;break}case ia.Or:{e.compilationString+=this._declareOutput(t,e)+` = (min(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 1.0) > 0.0) ? ${i} : ${r};\r
`;break}case ia.And:{e.compilationString+=this._declareOutput(t,e)+` = (${this.a.associatedVariableName} * ${this.b.associatedVariableName} > 0.0)  ? ${i} : ${r};\r
`;break}}return this}serialize(){const e=super.serialize();return e.condition=this.condition,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.condition=e.condition}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.condition = BABYLON.ConditionalBlockConditions.${ia[this.condition]};\r
`}}ye("BABYLON.ConditionalBlock",c1);class yE extends rt{constructor(e){super(e,W.Neutral),this.octaves=6,this.registerInput("seed",N.AutoDetect),this.registerInput("chaos",N.AutoDetect,!0),this.registerInput("offsetX",N.Float,!0),this.registerInput("offsetY",N.Float,!0),this.registerInput("offsetZ",N.Float,!0),this.registerOutput("output",N.Float),this._inputs[0].acceptedConnectionPointTypes.push(N.Vector2),this._inputs[0].acceptedConnectionPointTypes.push(N.Vector3),this._linkConnectionTypes(0,1)}getClassName(){return"CloudBlock"}get seed(){return this._inputs[0]}get chaos(){return this._inputs[1]}get offsetX(){return this._inputs[2]}get offsetY(){return this._inputs[3]}get offsetZ(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){var t,i;if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;const r=`

        float cloudRandom(in float p) { p = fract(p * 0.011); p *= p + 7.5; p *= p + p; return fract(p); }

        // Based on Morgan McGuire @morgan3d
        // https://www.shadertoy.com/view/4dS3Wd
        float cloudNoise(in vec2 x, in vec2 chaos) {
            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);

            vec2 i = floor(x);
            vec2 f = fract(x);

            float n = dot(i, step);

            vec2 u = f * f * (3.0 - 2.0 * f);
            return mix(
                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),
                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),
                    u.y
                );
        }

        float cloudNoise(in vec3 x, in vec3 chaos) {
            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);

            vec3 i = floor(x);
            vec3 f = fract(x);

            float n = dot(i, step);

            vec3 u = f * f * (3.0 - 2.0 * f);
            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),
                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);
        }`,s=`
        float fbm(in vec2 st, in vec2 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = .5;
            float frequency = 0.;

            // Loop of octaves
            for (int i = 0; i < OCTAVES; i++) {
                value += amplitude * cloudNoise(st, chaos);
                st *= 2.0;
                amplitude *= 0.5;
            }
            return value;
        }

        float fbm(in vec3 x, in vec3 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = 0.5;
            for (int i = 0; i < OCTAVES; ++i) {
                value += amplitude * cloudNoise(x, chaos);
                x = x * 2.0;
                amplitude *= 0.5;
            }
            return value;
        }`,n=`fbm${this.octaves}`;e._emitFunction("CloudBlockCode",r,"// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,s.replace(/fbm/gi,n).replace(/OCTAVES/gi,(this.octaves|0).toString()),"// CloudBlockCode FBM");const a=e._getFreeVariableName("st"),l=((t=this.seed.connectedPoint)===null||t===void 0?void 0:t.type)===N.Vector2?"vec2":"vec3";e.compilationString+=`${l} ${a} = ${this.seed.associatedVariableName};\r
`,this.offsetX.isConnected&&(e.compilationString+=`${a}.x += 0.1 * ${this.offsetX.associatedVariableName};\r
`),this.offsetY.isConnected&&(e.compilationString+=`${a}.y += 0.1 * ${this.offsetY.associatedVariableName};\r
`),this.offsetZ.isConnected&&l==="vec3"&&(e.compilationString+=`${a}.z += 0.1 * ${this.offsetZ.associatedVariableName};\r
`);let c="";return this.chaos.isConnected?c=this.chaos.associatedVariableName:c=((i=this.seed.connectedPoint)===null||i===void 0?void 0:i.type)===N.Vector2?"vec2(0., 0.)":"vec3(0., 0., 0.)",e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${n}(${a}, ${c});\r
`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.octaves = ${this.octaves};\r
`}serialize(){const e=super.serialize();return e.octaves=this.octaves,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.octaves=e.octaves}}M([Xt("Octaves",zt.Int)],yE.prototype,"octaves",void 0);ye("BABYLON.CloudBlock",yE);class h1 extends rt{constructor(e){super(e,W.Neutral),this.registerInput("seed",N.Vector2),this.registerInput("offset",N.Float),this.registerInput("density",N.Float),this.registerOutput("output",N.Float),this.registerOutput("cells",N.Float)}getClassName(){return"VoronoiNoiseBlock"}get seed(){return this._inputs[0]}get offset(){return this._inputs[1]}get density(){return this._inputs[2]}get output(){return this._outputs[0]}get cells(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;let t=`vec2 voronoiRandom(vec2 seed, float offset){
            mat2 m = mat2(15.27, 47.63, 99.41, 89.98);
            vec2 uv = fract(sin(m * seed) * 46839.32);
            return vec2(sin(uv.y * offset) * 0.5 + 0.5, cos(uv.x * offset) * 0.5 + 0.5);
        }
        `;e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t=`void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){
            vec2 g = floor(seed * density);
            vec2 f = fract(seed * density);
            float t = 8.0;
            vec3 res = vec3(8.0, 0.0, 0.0);

            for(int y=-1; y<=1; y++)
            {
                for(int x=-1; x<=1; x++)
                {
                    vec2 lattice = vec2(x,y);
                    vec2 randomOffset = voronoiRandom(lattice + g, offset);
                    float d = distance(lattice + randomOffset, f);
                    if(d < res.x)
                    {
                        res = vec3(d, randomOffset.x, randomOffset.y);
                        outValue = res.x;
                        cells = res.y;
                    }
                }
            }
        }
        `,e._emitFunction("voronoi",t,"// Voronoi");const i=e._getFreeVariableName("tempOutput"),r=e._getFreeVariableName("tempCells");return e.compilationString+=`float ${i} = 0.0;\r
`,e.compilationString+=`float ${r} = 0.0;\r
`,e.compilationString+=`voronoi(${this.seed.associatedVariableName}, ${this.offset.associatedVariableName}, ${this.density.associatedVariableName}, ${i}, ${r});\r
`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${i};\r
`),this.cells.hasEndpoints&&(e.compilationString+=this._declareOutput(this.cells,e)+` = ${r};\r
`),this}}ye("BABYLON.VoronoiNoiseBlock",h1);class u1 extends rt{constructor(e){super(e,W.Neutral),this.registerInput("input",N.AutoDetect),this.registerOutput("output",N.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==W.VertexAndFragment)return t.target;if(e.connectedPoint.target!==W.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){this._target&e||(this._target=e)}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${i.associatedVariableName};\r
`,this}}ye("BABYLON.ElbowBlock",u1);class CE extends rt{get texture(){var e;return this.source.isConnected?((e=this.source.connectedPoint)===null||e===void 0?void 0:e.ownerBlock).texture:this._texture}set texture(e){var t;if(this._texture===e)return;const i=(t=e==null?void 0:e.getScene())!==null&&t!==void 0?t:qe.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,r=>r.hasTexture(this._texture)),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,r=>r.hasTexture(e))}get textureY(){var e;return this.sourceY.isConnected?((e=this.sourceY.connectedPoint)===null||e===void 0?void 0:e.ownerBlock).texture:null}get textureZ(){var e,t;return!((e=this.sourceZ)===null||e===void 0)&&e.isConnected?((t=this.sourceY.connectedPoint)===null||t===void 0?void 0:t.ownerBlock).texture:null}_getImageSourceBlock(e){return e!=null&&e.isConnected?e.connectedPoint.ownerBlock:null}get samplerName(){const e=this._getImageSourceBlock(this.source);return e?e.samplerName:this._samplerName}get samplerYName(){var e,t;return(t=(e=this._getImageSourceBlock(this.sourceY))===null||e===void 0?void 0:e.samplerName)!==null&&t!==void 0?t:null}get samplerZName(){var e,t;return(t=(e=this._getImageSourceBlock(this.sourceZ))===null||e===void 0?void 0:e.samplerName)!==null&&t!==void 0?t:null}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){var t;if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const i=(t=this.texture.getScene())!==null&&t!==void 0?t:qe.LastCreatedScene;i==null||i.markAllMaterialsAsDirty(1,r=>r.hasTexture(this.texture))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){var t;if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const i=(t=this.texture.getScene())!==null&&t!==void 0?t:qe.LastCreatedScene;i==null||i.markAllMaterialsAsDirty(1,r=>r.hasTexture(this.texture))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,W.Neutral),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this.registerInput("position",N.AutoDetect,!1),this.registerInput("normal",N.AutoDetect,!1),this.registerInput("sharpness",N.Float,!0),this.registerInput("source",N.Object,!0,W.VertexAndFragment,new Rr("source",this,nr.Input,hc,"ImageSourceBlock")),this.registerInput("sourceY",N.Object,!0,W.VertexAndFragment,new Rr("sourceY",this,nr.Input,hc,"ImageSourceBlock")),t||this.registerInput("sourceZ",N.Object,!0,W.VertexAndFragment,new Rr("sourceZ",this,nr.Input,hc,"ImageSourceBlock")),this.registerOutput("rgba",N.Color4,W.Neutral),this.registerOutput("rgb",N.Color3,W.Neutral),this.registerOutput("r",N.Float,W.Neutral),this.registerOutput("g",N.Float,W.Neutral),this.registerOutput("b",N.Float,W.Neutral),this.registerOutput("a",N.Float,W.Neutral),this.registerOutput("level",N.Float,W.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(N.Color3|N.Vector3|N.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(N.Color3|N.Vector3|N.Vector4)}getClassName(){return"TriPlanarBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get sharpness(){return this._inputs[2]}get source(){return this._inputs[3]}get sourceY(){return this._inputs[4]}get sourceZ(){return this._inputs[5]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const r=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,s=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,r,!0),i.setValue(this._gammaDefineName,s,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this.texture&&(e.setFloat(this._textureInfoName,this.texture.level),this._imageSource||e.setTexture(this._samplerName,this.texture))}_generateTextureLookup(e){var t,i;const r=this.samplerName,s=(t=this.samplerYName)!==null&&t!==void 0?t:r,n=(i=this.samplerZName)!==null&&i!==void 0?i:r,a=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",l=e._getFreeVariableName("x"),c=e._getFreeVariableName("y"),h=e._getFreeVariableName("z"),u=e._getFreeVariableName("z");e.compilationString+=`
            vec4 ${l} = texture2D(${r}, ${this.position.associatedVariableName}.yz);
            vec4 ${c} = texture2D(${s}, ${this.position.associatedVariableName}.zx);
            vec4 ${h} = texture2D(${n}, ${this.position.associatedVariableName}.xy);
            
            // blend weights
            vec3 ${u} = pow(abs(${this.normal.associatedVariableName}.xyz), vec3(${a}));

            // blend and return
            vec4 ${this._tempTextureRead} = (${l}*${u}.x + ${c}*${u}.y + ${h}*${u}.z) / (${u}.x + ${u}.y + ${u}.z);        
        `}_generateConversionCode(e,t,i){i!=="a"&&((!this.texture||!this.texture.gammaSpace)&&(e.compilationString+=`#ifdef ${this._linearDefineName}
                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
                    #endif
                `),e.compilationString+=`#ifdef ${this._gammaDefineName}
                ${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
                #endif
            `)}_writeOutput(e,t,i){let r="";this.disableLevelMultiplication||(r=` * ${this._textureInfoName}`),e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i}${r};\r
`,this._generateConversionCode(e,t,i)}_buildBlock(e){super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitUniformFromString(this._textureInfoName,"float"),this._generateTextureLookup(e);for(const i of this._outputs)i.hasEndpoints&&i.name!=="level"&&this._writeOutput(e,i,i.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\r
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\r
`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\r
`,this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\r
`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\r
`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\r
`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\r
`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\r
`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\r
`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\r
`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\r
`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\r
`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\r
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r
`),e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.disableLevelMultiplication=this.disableLevelMultiplication,!this.hasImageSource&&this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!sr.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=Y.Parse(e.texture,t,i))}}ye("BABYLON.TriPlanarBlock",CE);class d1 extends CE{constructor(e){super(e,!0)}getClassName(){return"BiPlanarBlock"}_generateTextureLookup(e){var t;const i=this.samplerName,r=(t=this.samplerYName)!==null&&t!==void 0?t:this.samplerName,s=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",n=e._getFreeVariableName("dpdx"),a=e._getFreeVariableName("dpdy"),l=e._getFreeVariableName("n"),c=e._getFreeVariableName("ma"),h=e._getFreeVariableName("mi"),u=e._getFreeVariableName("me"),d=e._getFreeVariableName("x"),f=e._getFreeVariableName("y"),_=e._getFreeVariableName("y");e.compilationString+=`
            // grab coord derivatives for texturing
            vec3 ${n} = dFdx(${this.position.associatedVariableName}.xyz);
            vec3 ${a} = dFdy(${this.position.associatedVariableName}.xyz);
            vec3 ${l} = abs(${this.normal.associatedVariableName}.xyz);
        
            // determine major axis (in x; yz are following axis)
            ivec3 ${c} = (${l}.x>${l}.y && ${l}.x>${l}.z) ? ivec3(0,1,2) :
                    (${l}.y>${l}.z)            ? ivec3(1,2,0) :
                                            ivec3(2,0,1) ;
            // determine minor axis (in x; yz are following axis)
            ivec3 ${h} = (${l}.x<${l}.y && ${l}.x<${l}.z) ? ivec3(0,1,2) :
                    (${l}.y<${l}.z)            ? ivec3(1,2,0) :
                                            ivec3(2,0,1) ;
            // determine median axis (in x;  yz are following axis)
            ivec3 ${u} = ivec3(3) - ${h} - ${c};
            
            // project+fetch
            vec4 ${d} = textureGrad( ${i}, vec2(   ${this.position.associatedVariableName}[${c}.y],   ${this.position.associatedVariableName}[${c}.z]), 
                                    vec2(${n}[${c}.y],${n}[${c}.z]), 
                                    vec2(${a}[${c}.y],${a}[${c}.z]) );
            vec4 ${f} = textureGrad( ${r}, vec2(   ${this.position.associatedVariableName}[${u}.y],   ${this.position.associatedVariableName}[${u}.z]), 
                                    vec2(${n}[${u}.y],${n}[${u}.z]),
                                    vec2(${a}[${u}.y],${a}[${u}.z]) );
            
            // blend factors
            vec2 ${_} = vec2(${l}[${c}.x],${l}[${u}.x]);
            // make local support
            ${_} = clamp( (${_}-0.5773)/(1.0-0.5773), 0.0, 1.0 );
            // shape transition
            ${_} = pow( ${_}, vec2(${s}/8.0) );
            // blend and return
            vec4 ${this._tempTextureRead} = (${d}*${_}.x + ${f}*${_}.y) / (${_}.x + ${_}.y);
        `}}ye("BABYLON.BiPlanarBlock",d1);class f1 extends rt{constructor(e){super(e,W.Neutral),this.registerInput("input",N.Matrix),this.registerOutput("output",N.Float)}getClassName(){return"MatrixDeterminantBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=this._declareOutput(t,e)+`${t.associatedVariableName} = determinant(${i.associatedVariableName});\r
`,this}}ye("BABYLON.MatrixDeterminantBlock",f1);class _1 extends rt{constructor(e){super(e,W.Neutral),this.registerInput("input",N.Matrix),this.registerOutput("output",N.Matrix)}getClassName(){return"MatrixTransposeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=this._declareOutput(t,e)+`${t.associatedVariableName} = transpose(${i.associatedVariableName});\r
`,this}}ye("BABYLON.MatrixTransposeBlock",_1);function p1(o){return new Promise(e=>{DracoDecoderModule({wasmBinary:o}).then(t=>{e({module:t})})})}function sp(o,e,t,i,r,s){const n=new o.DecoderBuffer;n.Init(e,e.byteLength);const a=new o.Decoder;let l,c;try{const h=a.GetEncodedGeometryType(n);switch(h){case o.TRIANGULAR_MESH:l=new o.Mesh,c=a.DecodeBufferToMesh(n,l);break;case o.POINT_CLOUD:l=new o.PointCloud,c=a.DecodeBufferToPointCloud(n,l);break;default:throw new Error(`Invalid geometry type ${h}`)}if(!c.ok()||!l.ptr)throw new Error(c.error_msg());if(h===o.TRIANGULAR_MESH){const f=l.num_faces()*3,_=f*4,p=o._malloc(_);try{a.GetTrianglesUInt32Array(l,_,p);const m=new Uint32Array(f);m.set(new Uint32Array(o.HEAPF32.buffer,p,f)),i(m)}finally{o._free(p)}}const u=(d,f,_=1)=>{const p=f.num_components(),m=l.num_points(),T=m*p,b=T*Float32Array.BYTES_PER_ELEMENT,y=o._malloc(b);try{a.GetAttributeDataArrayForAllPoints(l,f,o.DT_FLOAT32,b,y);const S=new Float32Array(o.HEAPF32.buffer,y,T);if(d==="color"&&p===3){const C=new Float32Array(m*4);for(let I=0,P=0;I<C.length;I+=4,P+=p)C[I+0]=S[P+0],C[I+1]=S[P+1],C[I+2]=S[P+2],C[I+3]=1;r(d,C)}else{const C=new Float32Array(T);if(C.set(new Float32Array(o.HEAPF32.buffer,y,T)),_!==1)for(let I=0;I<C.length;I++)C[I]=C[I]/_;r(d,C)}}finally{o._free(y)}};if(t)for(const d in t){const f=t[d],_=a.GetAttributeByUniqueId(l,f),p=s&&s[d]||1;u(d,_,p)}else{const d={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"};for(const f in d){const _=a.GetAttributeId(l,o[d[f]]);if(_!==-1){const p=a.GetAttribute(l,_);u(f,p)}}}}finally{l&&o.destroy(l),o.destroy(a),o.destroy(n)}}function m1(){let o;onmessage=e=>{const t=e.data;switch(t.id){case"init":{const i=t.decoder;i.url&&(importScripts(i.url),o=DracoDecoderModule({wasmBinary:i.wasmBinary})),postMessage("done");break}case"decodeMesh":{if(!o)throw new Error("Draco decoder module is not available");o.then(i=>{sp(i,t.dataView,t.attributes,r=>{postMessage({id:"indices",value:r},[r.buffer])},(r,s)=>{postMessage({id:r,value:s},[s.buffer])}),postMessage("done")});break}}}}class Yn{static get DecoderAvailable(){const e=Yn.Configuration.decoder;return!!(e.wasmUrl&&e.wasmBinaryUrl&&typeof WebAssembly=="object"||e.fallbackUrl)}static GetDefaultNumWorkers(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}static get Default(){return Yn._Default||(Yn._Default=new Yn),Yn._Default}constructor(e=Yn.DefaultNumWorkers){const t=Yn.Configuration.decoder,i=t.wasmUrl&&t.wasmBinaryUrl&&typeof WebAssembly=="object"?{url:J.GetAbsoluteUrl(t.wasmUrl),wasmBinaryPromise:J.LoadFileAsync(J.GetAbsoluteUrl(t.wasmBinaryUrl))}:{url:J.GetAbsoluteUrl(t.fallbackUrl),wasmBinaryPromise:Promise.resolve(void 0)};e&&typeof Worker=="function"&&typeof URL=="function"?this._workerPoolPromise=i.wasmBinaryPromise.then(r=>{const s=`${sp}(${m1})()`,n=URL.createObjectURL(new Blob([s],{type:"application/javascript"}));return new Wu(e,()=>new Promise((a,l)=>{const c=new Worker(n),h=d=>{c.removeEventListener("error",h),c.removeEventListener("message",u),l(d)},u=d=>{d.data==="done"&&(c.removeEventListener("error",h),c.removeEventListener("message",u),a(c))};c.addEventListener("error",h),c.addEventListener("message",u),c.postMessage({id:"init",decoder:{url:i.url,wasmBinary:r}})}))}):this._decoderModulePromise=i.wasmBinaryPromise.then(r=>{if(!i.url)throw new Error("Draco decoder module is not available");return J.LoadScriptAsync(i.url).then(()=>p1(r))})}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._decoderModulePromise}whenReadyAsync(){return this._workerPoolPromise?this._workerPoolPromise.then(()=>{}):this._decoderModulePromise?this._decoderModulePromise.then(()=>{}):Promise.resolve()}decodeMeshAsync(e,t,i){const r=e instanceof ArrayBuffer?new Uint8Array(e):e;if(this._workerPoolPromise)return this._workerPoolPromise.then(s=>new Promise((n,a)=>{s.push((l,c)=>{const h=new Oe,u=_=>{l.removeEventListener("error",u),l.removeEventListener("message",d),a(_),c()},d=_=>{if(_.data==="done")l.removeEventListener("error",u),l.removeEventListener("message",d),n(h),c();else if(_.data.id==="indices")h.indices=_.data.value;else{const p=i&&i[_.data.id]?i[_.data.id]:1;if(p!==1)for(let m=0;m<_.data.value.length;m++)_.data.value[m]=_.data.value[m]/p;h.set(_.data.value,_.data.id)}};l.addEventListener("error",u),l.addEventListener("message",d);const f=new Uint8Array(r.byteLength);f.set(new Uint8Array(r.buffer,r.byteOffset,r.byteLength)),l.postMessage({id:"decodeMesh",dataView:f,attributes:t},[f.buffer])})}));if(this._decoderModulePromise)return this._decoderModulePromise.then(s=>{const n=new Oe;return sp(s.module,r,t,a=>{n.indices=a},(a,l)=>{n.set(l,a)},i),n});throw new Error("Draco decoder module is not available")}}Yn.Configuration={decoder:{wasmUrl:"https://preview.babylonjs.com/draco_wasm_wrapper_gltf.js",wasmBinaryUrl:"https://preview.babylonjs.com/draco_decoder_gltf.wasm",fallbackUrl:"https://preview.babylonjs.com/draco_decoder_gltf.js"}};Yn.DefaultNumWorkers=Yn.GetDefaultNumWorkers();Yn._Default=null;class ko{static get Default(){return ko._Default||(ko._Default=new ko),ko._Default}constructor(){const e=ko.Configuration.decoder;this._decoderModulePromise=J.LoadScriptAsync(J.GetAbsoluteUrl(e.url)).then(()=>MeshoptDecoder.ready)}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(e,t,i,r,s){return this._decoderModulePromise.then(()=>{const n=new Uint8Array(t*i);return MeshoptDecoder.decodeGltfBuffer(n,t,i,e,r,s),n})}}ko.Configuration={decoder:{url:"https://preview.babylonjs.com/meshopt_decoder.js"}};ko._Default=null;K._GoldbergMeshParser=(o,e)=>Kf.Parse(o,e);class Kf extends K{constructor(){super(...arguments),this.goldbergData={faceColors:[],faceCenters:[],faceZaxis:[],faceXaxis:[],faceYaxis:[],nbSharedFaces:0,nbUnsharedFaces:0,nbFaces:0,nbFacesAtPole:0,adjacentFaces:[]}}relatedGoldbergFace(e,t){return t===void 0?(e>this.goldbergData.nbUnsharedFaces-1&&(X.Warn("Maximum number of unshared faces used"),e=this.goldbergData.nbUnsharedFaces-1),this.goldbergData.nbUnsharedFaces+e):(e>11&&(X.Warn("Last pole used"),e=11),t>this.goldbergData.nbFacesAtPole-1&&(X.Warn("Maximum number of faces at a pole used"),t=this.goldbergData.nbFacesAtPole-1),12+e*this.goldbergData.nbFacesAtPole+t)}_changeGoldbergFaceColors(e){for(let i=0;i<e.length;i++){const r=e[i][0],s=e[i][1],n=e[i][2];for(let a=r;a<s+1;a++)this.goldbergData.faceColors[a]=n}const t=[];for(let i=0;i<12;i++)for(let r=0;r<5;r++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);for(let i=12;i<this.goldbergData.faceColors.length;i++)for(let r=0;r<6;r++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);return t}setGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.setVerticesData(O.ColorKind,t)}updateGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.updateVerticesData(O.ColorKind,t)}_changeGoldbergFaceUVs(e){const t=this.getVerticesData(O.UVKind);for(let i=0;i<e.length;i++){const r=e[i][0],s=e[i][1],n=e[i][2],a=e[i][3],l=e[i][4],c=[],h=[];let u,d;for(let f=0;f<5;f++)u=n.x+a*Math.cos(l+f*Math.PI/2.5),d=n.y+a*Math.sin(l+f*Math.PI/2.5),u<0&&(u=0),u>1&&(u=1),c.push(u,d);for(let f=0;f<6;f++)u=n.x+a*Math.cos(l+f*Math.PI/3),d=n.y+a*Math.sin(l+f*Math.PI/3),u<0&&(u=0),u>1&&(u=1),h.push(u,d);for(let f=r;f<Math.min(12,s+1);f++)for(let _=0;_<5;_++)t[10*f+2*_]=c[2*_],t[10*f+2*_+1]=c[2*_+1];for(let f=Math.max(12,r);f<s+1;f++)for(let _=0;_<6;_++)t[12*f-24+2*_]=h[2*_],t[12*f-23+2*_]=h[2*_+1]}return t}setGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.setVerticesData(O.UVKind,t)}updateGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.updateVerticesData(O.UVKind,t)}placeOnGoldbergFaceAt(e,t,i){const r=x.RotationFromAxis(this.goldbergData.faceXaxis[t],this.goldbergData.faceYaxis[t],this.goldbergData.faceZaxis[t]);e.rotation=r,e.position=this.goldbergData.faceCenters[t].add(this.goldbergData.faceXaxis[t].scale(i.x)).add(this.goldbergData.faceYaxis[t].scale(i.y)).add(this.goldbergData.faceZaxis[t].scale(i.z))}serialize(e){super.serialize(e),e.type="GoldbergMesh";const t={};if(t.adjacentFaces=this.goldbergData.adjacentFaces,t.nbSharedFaces=this.goldbergData.nbSharedFaces,t.nbUnsharedFaces=this.goldbergData.nbUnsharedFaces,t.nbFaces=this.goldbergData.nbFaces,t.nbFacesAtPole=this.goldbergData.nbFacesAtPole,this.goldbergData.faceColors){t.faceColors=[];for(const i of this.goldbergData.faceColors)t.faceColors.push(i.asArray())}if(this.goldbergData.faceCenters){t.faceCenters=[];for(const i of this.goldbergData.faceCenters)t.faceCenters.push(i.asArray())}if(this.goldbergData.faceZaxis){t.faceZaxis=[];for(const i of this.goldbergData.faceZaxis)t.faceZaxis.push(i.asArray())}if(this.goldbergData.faceYaxis){t.faceYaxis=[];for(const i of this.goldbergData.faceYaxis)t.faceYaxis.push(i.asArray())}if(this.goldbergData.faceXaxis){t.faceXaxis=[];for(const i of this.goldbergData.faceXaxis)t.faceXaxis.push(i.asArray())}e.goldbergData=t}static Parse(e,t){const i=e.goldbergData;i.faceColors=i.faceColors.map(s=>Ye.FromArray(s)),i.faceCenters=i.faceCenters.map(s=>x.FromArray(s)),i.faceZaxis=i.faceZaxis.map(s=>x.FromArray(s)),i.faceXaxis=i.faceXaxis.map(s=>x.FromArray(s)),i.faceYaxis=i.faceYaxis.map(s=>x.FromArray(s));const r=new Kf(e.name,t);return r.goldbergData=i,r}}function Vd(o){const e=o.pattern||K.NO_FLIP,t=o.tileWidth||o.tileSize||1,i=o.tileHeight||o.tileSize||1,r=o.alignHorizontal||0,s=o.alignVertical||0,n=o.width||o.size||1,a=Math.floor(n/t);let l=n-a*t;const c=o.height||o.size||1,h=Math.floor(c/i);let u=c-h*i;const d=t*a/2,f=i*h/2;let _=0,p=0,m=0,T=0,b=0,y=0;if(l>0||u>0){switch(m=-d,T=-f,b=d,y=f,r){case K.CENTER:l/=2,m-=l,b+=l;break;case K.LEFT:b+=l,_=-l/2;break;case K.RIGHT:m-=l,_=l/2;break}switch(s){case K.CENTER:u/=2,T-=u,y+=u;break;case K.BOTTOM:y+=u,p=-u/2;break;case K.TOP:T-=u,p=u/2;break}}const S=[],C=[],I=[];I[0]=[0,0,1,0,1,1,0,1],I[1]=[0,0,1,0,1,1,0,1],(e===K.ROTATE_TILE||e===K.ROTATE_ROW)&&(I[1]=[1,1,0,1,0,0,1,0]),(e===K.FLIP_TILE||e===K.FLIP_ROW)&&(I[1]=[1,0,0,0,0,1,1,1]),(e===K.FLIP_N_ROTATE_TILE||e===K.FLIP_N_ROTATE_ROW)&&(I[1]=[0,1,1,1,1,0,0,0]);let P=[];const D=[],w=[];let L=0;for(let he=0;he<h;he++)for(let _e=0;_e<a;_e++)S.push(-d+_e*t+_,-f+he*i+p,0),S.push(-d+(_e+1)*t+_,-f+he*i+p,0),S.push(-d+(_e+1)*t+_,-f+(he+1)*i+p,0),S.push(-d+_e*t+_,-f+(he+1)*i+p,0),w.push(L,L+1,L+3,L+1,L+2,L+3),e===K.FLIP_TILE||e===K.ROTATE_TILE||e===K.FLIP_N_ROTATE_TILE?P=P.concat(I[(_e%2+he%2)%2]):e===K.FLIP_ROW||e===K.ROTATE_ROW||e===K.FLIP_N_ROTATE_ROW?P=P.concat(I[he%2]):P=P.concat(I[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1),L+=4;if(l>0||u>0){const he=u>0&&(s===K.CENTER||s===K.TOP),_e=u>0&&(s===K.CENTER||s===K.BOTTOM),ne=l>0&&(r===K.CENTER||r===K.RIGHT),Pe=l>0&&(r===K.CENTER||r===K.LEFT);let Se=[],ce,de,k,se;if(he&&ne&&(S.push(m+_,T+p,0),S.push(-d+_,T+p,0),S.push(-d+_,T+u+p,0),S.push(m+_,T+u+p,0),w.push(L,L+1,L+3,L+1,L+2,L+3),L+=4,ce=1-l/t,de=1-u/i,k=1,se=1,Se=[ce,de,k,de,k,se,ce,se],e===K.ROTATE_ROW&&(Se=[1-ce,1-de,1-k,1-de,1-k,1-se,1-ce,1-se]),e===K.FLIP_ROW&&(Se=[1-ce,de,1-k,de,1-k,se,1-ce,se]),e===K.FLIP_N_ROTATE_ROW&&(Se=[ce,1-de,k,1-de,k,1-se,ce,1-se]),P=P.concat(Se),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),he&&Pe&&(S.push(d+_,T+p,0),S.push(b+_,T+p,0),S.push(b+_,T+u+p,0),S.push(d+_,T+u+p,0),w.push(L,L+1,L+3,L+1,L+2,L+3),L+=4,ce=0,de=1-u/i,k=l/t,se=1,Se=[ce,de,k,de,k,se,ce,se],(e===K.ROTATE_ROW||e===K.ROTATE_TILE&&a%2===0)&&(Se=[1-ce,1-de,1-k,1-de,1-k,1-se,1-ce,1-se]),(e===K.FLIP_ROW||e===K.FLIP_TILE&&a%2===0)&&(Se=[1-ce,de,1-k,de,1-k,se,1-ce,se]),(e===K.FLIP_N_ROTATE_ROW||e===K.FLIP_N_ROTATE_TILE&&a%2===0)&&(Se=[ce,1-de,k,1-de,k,1-se,ce,1-se]),P=P.concat(Se),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),_e&&ne&&(S.push(m+_,f+p,0),S.push(-d+_,f+p,0),S.push(-d+_,y+p,0),S.push(m+_,y+p,0),w.push(L,L+1,L+3,L+1,L+2,L+3),L+=4,ce=1-l/t,de=0,k=1,se=u/i,Se=[ce,de,k,de,k,se,ce,se],(e===K.ROTATE_ROW&&h%2===1||e===K.ROTATE_TILE&&h%1===0)&&(Se=[1-ce,1-de,1-k,1-de,1-k,1-se,1-ce,1-se]),(e===K.FLIP_ROW&&h%2===1||e===K.FLIP_TILE&&h%2===0)&&(Se=[1-ce,de,1-k,de,1-k,se,1-ce,se]),(e===K.FLIP_N_ROTATE_ROW&&h%2===1||e===K.FLIP_N_ROTATE_TILE&&h%2===0)&&(Se=[ce,1-de,k,1-de,k,1-se,ce,1-se]),P=P.concat(Se),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),_e&&Pe&&(S.push(d+_,f+p,0),S.push(b+_,f+p,0),S.push(b+_,y+p,0),S.push(d+_,y+p,0),w.push(L,L+1,L+3,L+1,L+2,L+3),L+=4,ce=0,de=0,k=l/t,se=u/i,Se=[ce,de,k,de,k,se,ce,se],(e===K.ROTATE_ROW&&h%2===1||e===K.ROTATE_TILE&&(h+a)%2===1)&&(Se=[1-ce,1-de,1-k,1-de,1-k,1-se,1-ce,1-se]),(e===K.FLIP_ROW&&h%2===1||e===K.FLIP_TILE&&(h+a)%2===1)&&(Se=[1-ce,de,1-k,de,1-k,se,1-ce,se]),(e===K.FLIP_N_ROTATE_ROW&&h%2===1||e===K.FLIP_N_ROTATE_TILE&&(h+a)%2===1)&&(Se=[ce,1-de,k,1-de,k,1-se,ce,1-se]),P=P.concat(Se),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),he){const xe=[];ce=0,de=1-u/i,k=1,se=1,xe[0]=[ce,de,k,de,k,se,ce,se],xe[1]=[ce,de,k,de,k,se,ce,se],(e===K.ROTATE_TILE||e===K.ROTATE_ROW)&&(xe[1]=[1-ce,1-de,1-k,1-de,1-k,1-se,1-ce,1-se]),(e===K.FLIP_TILE||e===K.FLIP_ROW)&&(xe[1]=[1-ce,de,1-k,de,1-k,se,1-ce,se]),(e===K.FLIP_N_ROTATE_TILE||e===K.FLIP_N_ROTATE_ROW)&&(xe[1]=[ce,1-de,k,1-de,k,1-se,ce,1-se]);for(let le=0;le<a;le++)S.push(-d+le*t+_,T+p,0),S.push(-d+(le+1)*t+_,T+p,0),S.push(-d+(le+1)*t+_,T+u+p,0),S.push(-d+le*t+_,T+u+p,0),w.push(L,L+1,L+3,L+1,L+2,L+3),L+=4,e===K.FLIP_TILE||e===K.ROTATE_TILE||e===K.FLIP_N_ROTATE_TILE?P=P.concat(xe[(le+1)%2]):e===K.FLIP_ROW||e===K.ROTATE_ROW||e===K.FLIP_N_ROTATE_ROW?P=P.concat(xe[1]):P=P.concat(xe[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(_e){const xe=[];ce=0,de=0,k=1,se=u/i,xe[0]=[ce,de,k,de,k,se,ce,se],xe[1]=[ce,de,k,de,k,se,ce,se],(e===K.ROTATE_TILE||e===K.ROTATE_ROW)&&(xe[1]=[1-ce,1-de,1-k,1-de,1-k,1-se,1-ce,1-se]),(e===K.FLIP_TILE||e===K.FLIP_ROW)&&(xe[1]=[1-ce,de,1-k,de,1-k,se,1-ce,se]),(e===K.FLIP_N_ROTATE_TILE||e===K.FLIP_N_ROTATE_ROW)&&(xe[1]=[ce,1-de,k,1-de,k,1-se,ce,1-se]);for(let le=0;le<a;le++)S.push(-d+le*t+_,y-u+p,0),S.push(-d+(le+1)*t+_,y-u+p,0),S.push(-d+(le+1)*t+_,y+p,0),S.push(-d+le*t+_,y+p,0),w.push(L,L+1,L+3,L+1,L+2,L+3),L+=4,e===K.FLIP_TILE||e===K.ROTATE_TILE||e===K.FLIP_N_ROTATE_TILE?P=P.concat(xe[(le+h)%2]):e===K.FLIP_ROW||e===K.ROTATE_ROW||e===K.FLIP_N_ROTATE_ROW?P=P.concat(xe[h%2]):P=P.concat(xe[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(ne){const xe=[];ce=1-l/t,de=0,k=1,se=1,xe[0]=[ce,de,k,de,k,se,ce,se],xe[1]=[ce,de,k,de,k,se,ce,se],(e===K.ROTATE_TILE||e===K.ROTATE_ROW)&&(xe[1]=[1-ce,1-de,1-k,1-de,1-k,1-se,1-ce,1-se]),(e===K.FLIP_TILE||e===K.FLIP_ROW)&&(xe[1]=[1-ce,de,1-k,de,1-k,se,1-ce,se]),(e===K.FLIP_N_ROTATE_TILE||e===K.FLIP_N_ROTATE_ROW)&&(xe[1]=[ce,1-de,k,1-de,k,1-se,ce,1-se]);for(let le=0;le<h;le++)S.push(m+_,-f+le*i+p,0),S.push(m+l+_,-f+le*i+p,0),S.push(m+l+_,-f+(le+1)*i+p,0),S.push(m+_,-f+(le+1)*i+p,0),w.push(L,L+1,L+3,L+1,L+2,L+3),L+=4,e===K.FLIP_TILE||e===K.ROTATE_TILE||e===K.FLIP_N_ROTATE_TILE?P=P.concat(xe[(le+1)%2]):e===K.FLIP_ROW||e===K.ROTATE_ROW||e===K.FLIP_N_ROTATE_ROW?P=P.concat(xe[le%2]):P=P.concat(xe[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(Pe){const xe=[];ce=0,de=0,k=l/i,se=1,xe[0]=[ce,de,k,de,k,se,ce,se],xe[1]=[ce,de,k,de,k,se,ce,se],(e===K.ROTATE_TILE||e===K.ROTATE_ROW)&&(xe[1]=[1-ce,1-de,1-k,1-de,1-k,1-se,1-ce,1-se]),(e===K.FLIP_TILE||e===K.FLIP_ROW)&&(xe[1]=[1-ce,de,1-k,de,1-k,se,1-ce,se]),(e===K.FLIP_N_ROTATE_TILE||e===K.FLIP_N_ROTATE_ROW)&&(xe[1]=[ce,1-de,k,1-de,k,1-se,ce,1-se]);for(let le=0;le<h;le++)S.push(b-l+_,-f+le*i+p,0),S.push(b+_,-f+le*i+p,0),S.push(b+_,-f+(le+1)*i+p,0),S.push(b-l+_,-f+(le+1)*i+p,0),w.push(L,L+1,L+3,L+1,L+2,L+3),L+=4,e===K.FLIP_TILE||e===K.ROTATE_TILE||e===K.FLIP_N_ROTATE_TILE?P=P.concat(xe[(le+a)%2]):e===K.FLIP_ROW||e===K.ROTATE_ROW||e===K.FLIP_N_ROTATE_ROW?P=P.concat(xe[le%2]):P=P.concat(xe[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}}const U=o.sideOrientation===0?0:o.sideOrientation||Oe.DEFAULTSIDE;Oe._ComputeSides(U,S,w,C,P,o.frontUVs,o.backUVs);const G=new Oe;G.indices=w,G.positions=S,G.normals=C,G.uvs=P;const Z=U===Oe.DOUBLESIDE?D.concat(D):D;return G.colors=Z,G}Oe.CreateTiledPlane=Vd;function g1(o){const t=o.faceUV||new Array(6),i=o.faceColors,r=o.pattern||K.NO_FLIP,s=o.width||o.size||1,n=o.height||o.size||1,a=o.depth||o.size||1,l=o.tileWidth||o.tileSize||1,c=o.tileHeight||o.tileSize||1,h=o.alignHorizontal||0,u=o.alignVertical||0,d=o.sideOrientation===0?0:o.sideOrientation||Oe.DEFAULTSIDE;for(let k=0;k<6;k++)t[k]===void 0&&(t[k]=new Tt(0,0,1,1)),i&&i[k]===void 0&&(i[k]=new Ye(1,1,1,1));const f=s/2,_=n/2,p=a/2,m=[];for(let k=0;k<2;k++)m[k]=Vd({pattern:r,tileWidth:l,tileHeight:c,width:s,height:n,alignVertical:u,alignHorizontal:h,sideOrientation:d});for(let k=2;k<4;k++)m[k]=Vd({pattern:r,tileWidth:l,tileHeight:c,width:a,height:n,alignVertical:u,alignHorizontal:h,sideOrientation:d});let T=u;u===K.BOTTOM?T=K.TOP:u===K.TOP&&(T=K.BOTTOM);for(let k=4;k<6;k++)m[k]=Vd({pattern:r,tileWidth:l,tileHeight:c,width:s,height:a,alignVertical:T,alignHorizontal:h,sideOrientation:d});let b=[],y=[],S=[],C=[];const I=[],P=[],D=[],w=[];let L=0,U=0;for(let k=0;k<6;k++){const se=m[k].positions.length;P[k]=[],D[k]=[];for(let xe=0;xe<se/3;xe++)P[k].push(new x(m[k].positions[3*xe],m[k].positions[3*xe+1],m[k].positions[3*xe+2])),D[k].push(new x(m[k].normals[3*xe],m[k].normals[3*xe+1],m[k].normals[3*xe+2]));L=m[k].uvs.length,w[k]=[];for(let xe=0;xe<L;xe+=2)w[k][xe]=t[k].x+(t[k].z-t[k].x)*m[k].uvs[xe],w[k][xe+1]=t[k].y+(t[k].w-t[k].y)*m[k].uvs[xe+1],Yt.UseOpenGLOrientationForUV&&(w[k][xe+1]=1-w[k][xe+1]);if(S=S.concat(w[k]),C=C.concat(m[k].indices.map(xe=>xe+U)),U+=P[k].length,i)for(let xe=0;xe<4;xe++)I.push(i[k].r,i[k].g,i[k].b,i[k].a)}const G=new x(0,0,p),Z=H.RotationY(Math.PI);b=P[0].map(k=>x.TransformNormal(k,Z).add(G)).map(k=>[k.x,k.y,k.z]).reduce((k,se)=>k.concat(se),[]),y=D[0].map(k=>x.TransformNormal(k,Z)).map(k=>[k.x,k.y,k.z]).reduce((k,se)=>k.concat(se),[]),b=b.concat(P[1].map(k=>k.subtract(G)).map(k=>[k.x,k.y,k.z]).reduce((k,se)=>k.concat(se),[])),y=y.concat(D[1].map(k=>[k.x,k.y,k.z]).reduce((k,se)=>k.concat(se),[]));const he=new x(f,0,0),_e=H.RotationY(-Math.PI/2);b=b.concat(P[2].map(k=>x.TransformNormal(k,_e).add(he)).map(k=>[k.x,k.y,k.z]).reduce((k,se)=>k.concat(se),[])),y=y.concat(D[2].map(k=>x.TransformNormal(k,_e)).map(k=>[k.x,k.y,k.z]).reduce((k,se)=>k.concat(se),[]));const ne=H.RotationY(Math.PI/2);b=b.concat(P[3].map(k=>x.TransformNormal(k,ne).subtract(he)).map(k=>[k.x,k.y,k.z]).reduce((k,se)=>k.concat(se),[])),y=y.concat(D[3].map(k=>x.TransformNormal(k,ne)).map(k=>[k.x,k.y,k.z]).reduce((k,se)=>k.concat(se),[]));const Pe=new x(0,_,0),Se=H.RotationX(Math.PI/2);b=b.concat(P[4].map(k=>x.TransformNormal(k,Se).add(Pe)).map(k=>[k.x,k.y,k.z]).reduce((k,se)=>k.concat(se),[])),y=y.concat(D[4].map(k=>x.TransformNormal(k,Se)).map(k=>[k.x,k.y,k.z]).reduce((k,se)=>k.concat(se),[]));const ce=H.RotationX(-Math.PI/2);b=b.concat(P[5].map(k=>x.TransformNormal(k,ce).subtract(Pe)).map(k=>[k.x,k.y,k.z]).reduce((k,se)=>k.concat(se),[])),y=y.concat(D[5].map(k=>x.TransformNormal(k,ce)).map(k=>[k.x,k.y,k.z]).reduce((k,se)=>k.concat(se),[])),Oe._ComputeSides(d,b,C,y,S);const de=new Oe;if(de.indices=C,de.positions=b,de.normals=y,de.uvs=S,i){const k=d===Oe.DOUBLESIDE?I.concat(I):I;de.colors=k}return de}Oe.CreateTiledBox=g1;function AE(o){const e=new Array,t=new Array,i=new Array,r=new Array,s=o.radius||2,n=o.tube||.5,a=o.radialSegments||32,l=o.tubularSegments||32,c=o.p||2,h=o.q||3,u=o.sideOrientation===0?0:o.sideOrientation||Oe.DEFAULTSIDE,d=m=>{const T=Math.cos(m),b=Math.sin(m),y=h/c*m,S=Math.cos(y),C=s*(2+S)*.5*T,I=s*(2+S)*b*.5,P=s*Math.sin(y)*.5;return new x(C,I,P)};let f,_;for(f=0;f<=a;f++){const T=f%a/a*2*c*Math.PI,b=d(T),y=d(T+.01),S=y.subtract(b);let C=y.add(b);const I=x.Cross(S,C);for(C=x.Cross(I,S),I.normalize(),C.normalize(),_=0;_<l;_++){const D=_%l/l*2*Math.PI,w=-n*Math.cos(D),L=n*Math.sin(D);t.push(b.x+w*C.x+L*I.x),t.push(b.y+w*C.y+L*I.y),t.push(b.z+w*C.z+L*I.z),r.push(f/a),r.push(Yt.UseOpenGLOrientationForUV?1-_/l:_/l)}}for(f=0;f<a;f++)for(_=0;_<l;_++){const m=(_+1)%l,T=f*l+_,b=(f+1)*l+_,y=(f+1)*l+m,S=f*l+m;e.push(S),e.push(b),e.push(T),e.push(S),e.push(y),e.push(b)}Oe.ComputeNormals(t,e,i),Oe._ComputeSides(u,t,e,i,r,o.frontUVs,o.backUVs);const p=new Oe;return p.indices=e,p.positions=t,p.normals=i,p.uvs=r,p}function v1(o,e={},t){const i=new K(o,t);return e.sideOrientation=K._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,AE(e).applyToMesh(i,e.updatable),i}Oe.CreateTorusKnot=AE;K.CreateTorusKnot=(o,e,t,i,r,s,n,a,l,c)=>v1(o,{radius:e,tube:t,radialSegments:i,tubularSegments:r,p:s,q:n,sideOrientation:c,updatable:l},a);class x1 extends Ie{constructor(e,t){super(e.x,e.y),this.index=t}}class O_{constructor(){this.elements=new Array}add(e){const t=new Array;return e.forEach(i=>{const r=new x1(i,this.elements.length);t.push(r),this.elements.push(r)}),t}computeBounds(){const e=new Ie(this.elements[0].x,this.elements[0].y),t=new Ie(this.elements[0].x,this.elements[0].y);return this.elements.forEach(i=>{i.x<e.x?e.x=i.x:i.x>t.x&&(t.x=i.x),i.y<e.y?e.y=i.y:i.y>t.y&&(t.y=i.y)}),{min:e,max:t,width:t.x-e.x,height:t.y-e.y}}}class T1{_addToepoint(e){for(const t of e)this._epoints.push(t.x,t.y)}constructor(e,t,i,r=earcut){this._points=new O_,this._outlinepoints=new O_,this._holes=new Array,this._epoints=new Array,this._eholes=new Array,this.bjsEarcut=r,this._name=e,this._scene=i||qe.LastCreatedScene;let s;t instanceof sm?s=t.getPoints():s=t,this._addToepoint(s),this._points.add(s),this._outlinepoints.add(s),typeof this.bjsEarcut>"u"&&X.Warn("Earcut was not found, the polygon will not be built.")}addHole(e){this._points.add(e);const t=new O_;return t.add(e),this._holes.push(t),this._eholes.push(this._epoints.length/2),this._addToepoint(e),this}build(e=!1,t=0,i=2){const r=new K(this._name,this._scene),s=this.buildVertexData(t,i);return r.setVerticesData(O.PositionKind,s.positions,e),r.setVerticesData(O.NormalKind,s.normals,e),r.setVerticesData(O.UVKind,s.uvs,e),r.setIndices(s.indices),r}buildVertexData(e=0,t=2){const i=new Oe,r=new Array,s=new Array,n=new Array,a=this._points.computeBounds();this._points.elements.forEach(h=>{r.push(0,1,0),s.push(h.x,0,h.y),n.push((h.x-a.min.x)/a.width,(h.y-a.min.y)/a.height)});const l=new Array,c=this.bjsEarcut(this._epoints,this._eholes,2);for(let h=0;h<c.length;h++)l.push(c[h]);if(e>0){const h=s.length/3;this._points.elements.forEach(d=>{r.push(0,-1,0),s.push(d.x,-e,d.y),n.push(1-(d.x-a.min.x)/a.width,1-(d.y-a.min.y)/a.height)});const u=l.length;for(let d=0;d<u;d+=3){const f=l[d+0],_=l[d+1],p=l[d+2];l.push(p+h),l.push(_+h),l.push(f+h)}this._addSide(s,r,n,l,a,this._outlinepoints,e,!1,t),this._holes.forEach(d=>{this._addSide(s,r,n,l,a,d,e,!0,t)})}return i.indices=l,i.positions=s,i.normals=r,i.uvs=n,i}_addSide(e,t,i,r,s,n,a,l,c){let h=e.length/3,u=0;for(let d=0;d<n.elements.length;d++){const f=n.elements[d],_=n.elements[(d+1)%n.elements.length];e.push(f.x,0,f.y),e.push(f.x,-a,f.y),e.push(_.x,0,_.y),e.push(_.x,-a,_.y);const p=n.elements[(d+n.elements.length-1)%n.elements.length],m=n.elements[(d+2)%n.elements.length];let T=new x(-(_.y-f.y),0,_.x-f.x),b=new x(-(f.y-p.y),0,f.x-p.x),y=new x(-(m.y-_.y),0,m.x-_.x);l||(T=T.scale(-1),b=b.scale(-1),y=y.scale(-1));const S=T.normalizeToNew();let C=b.normalizeToNew(),I=y.normalizeToNew();const P=x.Dot(C,S);P>c?P<kt-1?C=new x(f.x,0,f.y).subtract(new x(_.x,0,_.y)).normalize():C=b.add(T).normalize():C=S;const D=x.Dot(y,T);D>c?D<kt-1?I=new x(_.x,0,_.y).subtract(new x(f.x,0,f.y)).normalize():I=y.add(T).normalize():I=S,i.push(u/s.width,0),i.push(u/s.width,1),u+=T.length(),i.push(u/s.width,0),i.push(u/s.width,1),t.push(C.x,C.y,C.z),t.push(C.x,C.y,C.z),t.push(I.x,I.y,I.z),t.push(I.x,I.y,I.z),l?(r.push(h),r.push(h+2),r.push(h+1),r.push(h+1),r.push(h+2),r.push(h+3)):(r.push(h),r.push(h+1),r.push(h+2),r.push(h+1),r.push(h+3),r.push(h+2)),h+=4}}}function RE(o,e,t,i,r,s,n){const a=t||new Array(3),l=i,c=[],h=n||!1;for(let w=0;w<3;w++)a[w]===void 0&&(a[w]=new Tt(0,0,1,1)),l&&l[w]===void 0&&(l[w]=new Ye(1,1,1,1));const u=o.getVerticesData(O.PositionKind),d=o.getVerticesData(O.NormalKind),f=o.getVerticesData(O.UVKind),_=o.getIndices(),p=u.length/9;let m=0,T=0,b=0,y=0,S=0;const C=[0];if(h)for(let w=p;w<u.length/3;w+=4)T=u[3*(w+2)]-u[3*w],b=u[3*(w+2)+2]-u[3*w+2],y=Math.sqrt(T*T+b*b),S+=y,C.push(S);let I=0,P=0;for(let w=0;w<d.length;w+=3)Math.abs(d[w+1])<.001&&(P=1),Math.abs(d[w+1]-1)<.001&&(P=0),Math.abs(d[w+1]+1)<.001&&(P=2),I=w/3,P===1?(m=I-p,m%4<1.5?h?f[2*I]=a[P].x+(a[P].z-a[P].x)*C[Math.floor(m/4)]/S:f[2*I]=a[P].x:h?f[2*I]=a[P].x+(a[P].z-a[P].x)*C[Math.floor(m/4)+1]/S:f[2*I]=a[P].z,m%2===0?f[2*I+1]=Yt.UseOpenGLOrientationForUV?1-a[P].w:a[P].w:f[2*I+1]=Yt.UseOpenGLOrientationForUV?1-a[P].y:a[P].y):(f[2*I]=(1-f[2*I])*a[P].x+f[2*I]*a[P].z,f[2*I+1]=(1-f[2*I+1])*a[P].y+f[2*I+1]*a[P].w,Yt.UseOpenGLOrientationForUV&&(f[2*I+1]=1-f[2*I+1])),l&&c.push(l[P].r,l[P].g,l[P].b,l[P].a);Oe._ComputeSides(e,u,_,d,f,r,s);const D=new Oe;if(D.indices=_,D.positions=u,D.normals=d,D.uvs=f,l){const w=e===Oe.DOUBLESIDE?c.concat(c):c;D.colors=w}return D}function IE(o,e,t=null,i=earcut){e.sideOrientation=K._GetDefaultSideOrientation(e.sideOrientation);const r=e.shape,s=e.holes||[],n=e.depth||0,a=e.smoothingThreshold||2,l=[];let c=[];for(let _=0;_<r.length;_++)l[_]=new Ie(r[_].x,r[_].z);const h=1e-8;l[0].equalsWithEpsilon(l[l.length-1],h)&&l.pop();const u=new T1(o,l,t||qe.LastCreatedScene,i);for(let _=0;_<s.length;_++){c=[];for(let p=0;p<s[_].length;p++)c.push(new Ie(s[_][p].x,s[_][p].z));u.addHole(c)}const d=u.build(!1,n,a);return d._originalBuilderSideOrientation=e.sideOrientation,RE(d,e.sideOrientation,e.faceUV,e.faceColors,e.frontUVs,e.backUVs,e.wrap).applyToMesh(d,e.updatable),d}function E1(o,e,t=null,i=earcut){return IE(o,e,t,i)}Oe.CreatePolygon=RE;K.CreatePolygon=(o,e,t,i,r,s,n=earcut)=>IE(o,{shape:e,holes:i,updatable:r,sideOrientation:s},t,n);K.ExtrudePolygon=(o,e,t,i,r,s,n,a=earcut)=>E1(o,{shape:e,holes:r,depth:t,updatable:s,sideOrientation:n},i,a);function b1(o,e,t=null){const i=e.arc?e.arc<=0||e.arc>1?1:e.arc:1,r=e.closed===void 0?!0:e.closed,s=e.shape,n=e.radius||1,a=e.tessellation||64,l=e.clip||0,c=e.updatable,h=K._GetDefaultSideOrientation(e.sideOrientation),u=e.cap||K.NO_CAP,d=Math.PI*2,f=new Array,_=e.invertUV||!1;let p=0,m=0;const T=d/a*i;let b,y;for(p=0;p<=a-l;p++){for(y=[],(u==K.CAP_START||u==K.CAP_ALL)&&(y.push(new x(0,s[0].y,0)),y.push(new x(Math.cos(p*T)*s[0].x*n,s[0].y,Math.sin(p*T)*s[0].x*n))),m=0;m<s.length;m++)b=new x(Math.cos(p*T)*s[m].x*n,s[m].y,Math.sin(p*T)*s[m].x*n),y.push(b);(u==K.CAP_END||u==K.CAP_ALL)&&(y.push(new x(Math.cos(p*T)*s[s.length-1].x*n,s[s.length-1].y,Math.sin(p*T)*s[s.length-1].x*n)),y.push(new x(0,s[s.length-1].y,0))),f.push(y)}return hh(o,{pathArray:f,closeArray:r,sideOrientation:h,updatable:c,invertUV:_,frontUVs:e.frontUVs,backUVs:e.backUVs},t)}K.CreateLathe=(o,e,t,i,r,s,n)=>b1(o,{shape:e,radius:t,tessellation:i,sideOrientation:n,updatable:s},r);function S1(o,e,t=null){const i=e.path;let r=e.instance,s=1;e.radius!==void 0?s=e.radius:r&&(s=r._creationDataStorage.radius);const n=e.tessellation||64,a=e.radiusFunction||null;let l=e.cap||K.NO_CAP;const c=e.invertUV||!1,h=e.updatable,u=K._GetDefaultSideOrientation(e.sideOrientation);e.arc=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1;const d=(T,b,y,S,C,I,P,D)=>{const w=b.getTangents(),L=b.getNormals(),U=b.getDistances(),Z=Math.PI*2/C*D,_e=I||(()=>S);let ne,Pe,Se,ce;const de=j.Matrix[0];let k=P===K.NO_CAP||P===K.CAP_END?0:2;for(let xe=0;xe<T.length;xe++){Pe=_e(xe,U[xe]),ne=Array(),Se=L[xe];for(let le=0;le<C;le++)H.RotationAxisToRef(w[xe],Z*le,de),ce=ne[le]?ne[le]:x.Zero(),x.TransformCoordinatesToRef(Se,de,ce),ce.scaleInPlace(Pe).addInPlace(T[xe]),ne[le]=ce;y[k]=ne,k++}const se=(xe,le)=>{const je=Array();for(let st=0;st<xe;st++)je.push(T[le]);return je};switch(P){case K.NO_CAP:break;case K.CAP_START:y[0]=se(C,0),y[1]=y[2].slice(0);break;case K.CAP_END:y[k]=y[k-1].slice(0),y[k+1]=se(C,T.length-1);break;case K.CAP_ALL:y[0]=se(C,0),y[1]=y[2].slice(0),y[k]=y[k-1].slice(0),y[k+1]=se(C,T.length-1);break}return y};let f,_;if(r){const T=r._creationDataStorage,b=e.arc||T.arc;return f=T.path3D.update(i),_=d(i,f,T.pathArray,s,T.tessellation,a,T.cap,b),r=hh("",{pathArray:_,instance:r}),T.path3D=f,T.pathArray=_,T.arc=b,T.radius=s,r}f=new gu(i);const p=new Array;l=l<0||l>3?0:l,_=d(i,f,p,s,n,a,l,e.arc);const m=hh(o,{pathArray:_,closePath:!0,closeArray:!1,updatable:h,sideOrientation:u,invertUV:c,frontUVs:e.frontUVs,backUVs:e.backUVs},t);return m._creationDataStorage.pathArray=_,m._creationDataStorage.path3D=f,m._creationDataStorage.tessellation=n,m._creationDataStorage.cap=l,m._creationDataStorage.arc=e.arc,m._creationDataStorage.radius=s,m}K.CreateTube=(o,e,t,i,r,s,n,a,l,c)=>S1(o,{path:e,radius:t,tessellation:i,radiusFunction:r,arc:1,cap:s,updatable:a,sideOrientation:l,instance:c},n);const y1=new x(1,0,0),C1=new x(-1,0,0),A1=new x(0,1,0),R1=new x(0,-1,0),I1=new x(0,0,1),P1=new x(0,0,-1);class sf{constructor(e=x.Zero(),t=x.Up(),i=Ie.Zero(),r=0,s=0,n=null,a=null,l=null,c=null){this.position=e,this.normal=t,this.uv=i,this.vertexIdx=r,this.vertexIdxForBones=s,this.localPositionOverride=n,this.localNormalOverride=a,this.matrixIndicesOverride=l,this.matrixWeightsOverride=c}clone(){var e,t,i,r;return new sf(this.position.clone(),this.normal.clone(),this.uv.clone(),this.vertexIdx,this.vertexIdxForBones,(e=this.localPositionOverride)===null||e===void 0?void 0:e.slice(),(t=this.localNormalOverride)===null||t===void 0?void 0:t.slice(),(i=this.matrixIndicesOverride)===null||i===void 0?void 0:i.slice(),(r=this.matrixWeightsOverride)===null||r===void 0?void 0:r.slice())}}function M1(o,e,t){const i=!!e.skeleton,r=t.localMode||i,s=e.overrideMaterialSideOrientation!==null&&e.overrideMaterialSideOrientation!==void 0,n=e.getIndices(),a=i?e.getPositionData(!0,!0):e.getVerticesData(O.PositionKind),l=i?e.getNormalsData(!0,!0):e.getVerticesData(O.NormalKind),c=r?i?e.getVerticesData(O.PositionKind):a:null,h=r?i?e.getVerticesData(O.NormalKind):l:null,u=e.getVerticesData(O.UVKind),d=i?e.getVerticesData(O.MatricesIndicesKind):null,f=i?e.getVerticesData(O.MatricesWeightsKind):null,_=i?e.getVerticesData(O.MatricesIndicesExtraKind):null,p=i?e.getVerticesData(O.MatricesWeightsExtraKind):null,m=t.position||x.Zero();let T=t.normal||x.Up();const b=t.size||x.One(),y=t.angle||0;if(!T){const Se=new x(0,0,1),ce=e.getScene().activeCamera,de=x.TransformCoordinates(Se,ce.getWorldMatrix());T=ce.globalPosition.subtract(de)}const S=-Math.atan2(T.z,T.x)-Math.PI/2,C=Math.sqrt(T.x*T.x+T.z*T.z),I=Math.atan2(T.y,C),P=H.RotationYawPitchRoll(S,I,y).multiply(H.Translation(m.x,m.y,m.z)),D=H.Invert(P),L=e.getWorldMatrix().multiply(D),U=new Oe;U.indices=[],U.positions=[],U.normals=[],U.uvs=[],U.matricesIndices=i?[]:null,U.matricesWeights=i?[]:null,U.matricesIndicesExtra=_?[]:null,U.matricesWeightsExtra=p?[]:null;let G=0;const Z=Se=>{const ce=new sf;if(!n||!a||!l)return ce;const de=n[Se];if(ce.vertexIdx=de*3,ce.vertexIdxForBones=de*4,ce.position=new x(a[de*3],a[de*3+1],a[de*3+2]),x.TransformCoordinatesToRef(ce.position,L,ce.position),ce.normal=new x(l[de*3],l[de*3+1],l[de*3+2]),x.TransformNormalToRef(ce.normal,L,ce.normal),t.captureUVS&&u){const k=u[de*2+1];ce.uv=new Ie(u[de*2],Yt.UseOpenGLOrientationForUV?1-k:k)}return ce},he=[0,0,0,0],_e=(Se,ce)=>{if(Se.length===0)return Se;const de=.5*Math.abs(x.Dot(b,ce)),k=(le,je,st,be)=>{for(let We=0;We<be;++We)if(le[st+We]===je)return st+We;return-1},se=(le,je)=>{var st,be,We,Ct,_t,mt,Ge,Ut,Ft,Zt,$t,Di,Ui,ar,ti,or;const pi=x.GetClipFactor(le.position,je.position,ce,de);let Si=he,mi=he;if(d&&f){const Ms=le.matrixIndicesOverride?0:le.vertexIdxForBones,fr=(st=le.matrixIndicesOverride)!==null&&st!==void 0?st:d,hn=(be=le.matrixWeightsOverride)!==null&&be!==void 0?be:f,Ii=je.matrixIndicesOverride?0:je.vertexIdxForBones,re=(We=je.matrixIndicesOverride)!==null&&We!==void 0?We:d,Fe=(Ct=je.matrixWeightsOverride)!==null&&Ct!==void 0?Ct:f;Si=[0,0,0,0],mi=[0,0,0,0];let De=0;for(let un=0;un<4;++un)if(hn[Ms+un]>0){const tn=k(re,fr[Ms+un],Ii,4);Si[De]=fr[Ms+un],mi[De]=Ee.Lerp(hn[Ms+un],tn>=0?Fe[tn]:0,pi),De++}for(let un=0;un<4&&De<4;++un){const tn=re[Ii+un];k(fr,tn,Ms,4)===-1&&(Si[De]=tn,mi[De]=Ee.Lerp(0,Fe[Ii+un],pi),De++)}const At=mi[0]+mi[1]+mi[2]+mi[3];mi[0]/=At,mi[1]/=At,mi[2]/=At,mi[3]/=At}const Is=le.localPositionOverride?le.localPositionOverride[0]:(_t=c==null?void 0:c[le.vertexIdx])!==null&&_t!==void 0?_t:0,cn=le.localPositionOverride?le.localPositionOverride[1]:(mt=c==null?void 0:c[le.vertexIdx+1])!==null&&mt!==void 0?mt:0,Js=le.localPositionOverride?le.localPositionOverride[2]:(Ge=c==null?void 0:c[le.vertexIdx+2])!==null&&Ge!==void 0?Ge:0,Ur=je.localPositionOverride?je.localPositionOverride[0]:(Ut=c==null?void 0:c[je.vertexIdx])!==null&&Ut!==void 0?Ut:0,Zn=je.localPositionOverride?je.localPositionOverride[1]:(Ft=c==null?void 0:c[je.vertexIdx+1])!==null&&Ft!==void 0?Ft:0,Un=je.localPositionOverride?je.localPositionOverride[2]:(Zt=c==null?void 0:c[je.vertexIdx+2])!==null&&Zt!==void 0?Zt:0,Es=le.localNormalOverride?le.localNormalOverride[0]:($t=h==null?void 0:h[le.vertexIdx])!==null&&$t!==void 0?$t:0,Ps=le.localNormalOverride?le.localNormalOverride[1]:(Di=h==null?void 0:h[le.vertexIdx+1])!==null&&Di!==void 0?Di:0,en=le.localNormalOverride?le.localNormalOverride[2]:(Ui=h==null?void 0:h[le.vertexIdx+2])!==null&&Ui!==void 0?Ui:0,zi=je.localNormalOverride?je.localNormalOverride[0]:(ar=h==null?void 0:h[je.vertexIdx])!==null&&ar!==void 0?ar:0,os=je.localNormalOverride?je.localNormalOverride[1]:(ti=h==null?void 0:h[je.vertexIdx+1])!==null&&ti!==void 0?ti:0,ls=je.localNormalOverride?je.localNormalOverride[2]:(or=h==null?void 0:h[je.vertexIdx+2])!==null&&or!==void 0?or:0,Ir=Es+(zi-Es)*pi,zs=Ps+(os-Ps)*pi,Vr=en+(ls-en)*pi,Ni=Math.sqrt(Ir*Ir+zs*zs+Vr*Vr);return new sf(x.Lerp(le.position,je.position,pi),x.Lerp(le.normal,je.normal,pi).normalize(),Ie.Lerp(le.uv,je.uv,pi),-1,-1,c?[Is+(Ur-Is)*pi,cn+(Zn-cn)*pi,Js+(Un-Js)*pi]:null,h?[Ir/Ni,zs/Ni,Vr/Ni]:null,Si,mi)};let xe=null;Se.length>3&&(xe=new Array);for(let le=0;le<Se.length;le+=3){let je=0,st=null,be=null,We=null,Ct=null;const _t=x.Dot(Se[le].position,ce)-de,mt=x.Dot(Se[le+1].position,ce)-de,Ge=x.Dot(Se[le+2].position,ce)-de,Ut=_t>0,Ft=mt>0,Zt=Ge>0;switch(je=(Ut?1:0)+(Ft?1:0)+(Zt?1:0),je){case 0:Se.length>3?(xe.push(Se[le]),xe.push(Se[le+1]),xe.push(Se[le+2])):xe=Se;break;case 1:if(xe=xe??new Array,Ut&&(st=Se[le+1],be=Se[le+2],We=se(Se[le],st),Ct=se(Se[le],be)),Ft){st=Se[le],be=Se[le+2],We=se(Se[le+1],st),Ct=se(Se[le+1],be),xe.push(We),xe.push(be.clone()),xe.push(st.clone()),xe.push(be.clone()),xe.push(We.clone()),xe.push(Ct);break}Zt&&(st=Se[le],be=Se[le+1],We=se(Se[le+2],st),Ct=se(Se[le+2],be)),st&&be&&We&&Ct&&(xe.push(st.clone()),xe.push(be.clone()),xe.push(We),xe.push(Ct),xe.push(We.clone()),xe.push(be.clone()));break;case 2:xe=xe??new Array,Ut||(st=Se[le].clone(),be=se(st,Se[le+1]),We=se(st,Se[le+2]),xe.push(st),xe.push(be),xe.push(We)),Ft||(st=Se[le+1].clone(),be=se(st,Se[le+2]),We=se(st,Se[le]),xe.push(st),xe.push(be),xe.push(We)),Zt||(st=Se[le+2].clone(),be=se(st,Se[le]),We=se(st,Se[le+1]),xe.push(st),xe.push(be),xe.push(We));break}}return xe},ne=new Array(3);for(let Se=0;Se<n.length;Se+=3){let ce=ne;if(ce[0]=Z(Se),s&&r?(ce[1]=Z(Se+2),ce[2]=Z(Se+1)):(ce[1]=Z(Se+1),ce[2]=Z(Se+2)),!(t.cullBackFaces&&-ce[0].normal.z<=0&&-ce[1].normal.z<=0&&-ce[2].normal.z<=0)&&(ce=_e(ce,y1),!!ce&&(ce=_e(ce,C1),!!ce&&(ce=_e(ce,A1),!!ce&&(ce=_e(ce,R1),!!ce&&(ce=_e(ce,I1),!!ce&&(ce=_e(ce,P1),!!ce)))))))for(let de=0;de<ce.length;de++){const k=ce[de];if(U.indices.push(G),r?(k.localPositionOverride?(U.positions[G*3]=k.localPositionOverride[0],U.positions[G*3+1]=k.localPositionOverride[1],U.positions[G*3+2]=k.localPositionOverride[2]):c&&(U.positions[G*3]=c[k.vertexIdx],U.positions[G*3+1]=c[k.vertexIdx+1],U.positions[G*3+2]=c[k.vertexIdx+2]),k.localNormalOverride?(U.normals[G*3]=k.localNormalOverride[0],U.normals[G*3+1]=k.localNormalOverride[1],U.normals[G*3+2]=k.localNormalOverride[2]):h&&(U.normals[G*3]=h[k.vertexIdx],U.normals[G*3+1]=h[k.vertexIdx+1],U.normals[G*3+2]=h[k.vertexIdx+2])):(k.position.toArray(U.positions,G*3),k.normal.toArray(U.normals,G*3)),U.matricesIndices&&U.matricesWeights&&(k.matrixIndicesOverride?(U.matricesIndices[G*4]=k.matrixIndicesOverride[0],U.matricesIndices[G*4+1]=k.matrixIndicesOverride[1],U.matricesIndices[G*4+2]=k.matrixIndicesOverride[2],U.matricesIndices[G*4+3]=k.matrixIndicesOverride[3]):(d&&(U.matricesIndices[G*4]=d[k.vertexIdxForBones],U.matricesIndices[G*4+1]=d[k.vertexIdxForBones+1],U.matricesIndices[G*4+2]=d[k.vertexIdxForBones+2],U.matricesIndices[G*4+3]=d[k.vertexIdxForBones+3]),_&&U.matricesIndicesExtra&&(U.matricesIndicesExtra[G*4]=_[k.vertexIdxForBones],U.matricesIndicesExtra[G*4+1]=_[k.vertexIdxForBones+1],U.matricesIndicesExtra[G*4+2]=_[k.vertexIdxForBones+2],U.matricesIndicesExtra[G*4+3]=_[k.vertexIdxForBones+3])),k.matrixWeightsOverride?(U.matricesWeights[G*4]=k.matrixWeightsOverride[0],U.matricesWeights[G*4+1]=k.matrixWeightsOverride[1],U.matricesWeights[G*4+2]=k.matrixWeightsOverride[2],U.matricesWeights[G*4+3]=k.matrixWeightsOverride[3]):(f&&(U.matricesWeights[G*4]=f[k.vertexIdxForBones],U.matricesWeights[G*4+1]=f[k.vertexIdxForBones+1],U.matricesWeights[G*4+2]=f[k.vertexIdxForBones+2],U.matricesWeights[G*4+3]=f[k.vertexIdxForBones+3]),p&&U.matricesWeightsExtra&&(U.matricesWeightsExtra[G*4]=p[k.vertexIdxForBones],U.matricesWeightsExtra[G*4+1]=p[k.vertexIdxForBones+1],U.matricesWeightsExtra[G*4+2]=p[k.vertexIdxForBones+2],U.matricesWeightsExtra[G*4+3]=p[k.vertexIdxForBones+3]))),t.captureUVS)k.uv.toArray(U.uvs,G*2);else{U.uvs.push(.5+k.position.x/b.x);const se=.5+k.position.y/b.y;U.uvs.push(Yt.UseOpenGLOrientationForUV?1-se:se)}G++}}const Pe=new K(o,e.getScene());return U.applyToMesh(Pe),r?(Pe.skeleton=e.skeleton,Pe.parent=e):(Pe.position=m.clone(),Pe.rotation=new x(I,S,y)),Pe.computeWorldMatrix(!0),Pe.refreshBoundingInfo(!0,!0),Pe}K.CreateDecal=(o,e,t,i,r,s)=>M1(o,e,{position:t,normal:i,size:r,angle:s});class ji{constructor(e=0,t=0){this.x=e,this.y=t,e!==Math.floor(e)&&X.Warn("x is not an integer, floor(x) used"),t!==Math.floor(t)&&X.Warn("y is not an integer, floor(y) used")}clone(){return new ji(this.x,this.y)}rotate60About(e){const t=this.x;return this.x=e.x+e.y-this.y,this.y=t+this.y-e.x,this}rotateNeg60About(e){const t=this.x;return this.x=t+this.y-e.y,this.y=e.x+e.y-t,this}rotate120(e,t){e!==Math.floor(e)&&X.Warn("m not an integer only floor(m) used"),t!==Math.floor(t)&&X.Warn("n not an integer only floor(n) used");const i=this.x;return this.x=e-i-this.y,this.y=t+i,this}rotateNeg120(e,t){e!==Math.floor(e)&&X.Warn("m is not an integer, floor(m) used"),t!==Math.floor(t)&&X.Warn("n is not an integer,   floor(n) used");const i=this.x;return this.x=this.y-t,this.y=e+t-i-this.y,this}toCartesianOrigin(e,t){const i=x.Zero();return i.x=e.x+2*this.x*t+this.y*t,i.y=e.y+Math.sqrt(3)*this.y*t,i}static Zero(){return new ji(0,0)}}class O1{constructor(){this.cartesian=[],this.vertices=[],this.max=[],this.min=[],this.closestTo=[],this.innerFacets=[],this.isoVecsABOB=[],this.isoVecsOBOA=[],this.isoVecsBAOA=[],this.vertexTypes=[],this.IDATA=new np("icosahedron","Regular",[[0,Fr,-1],[-Fr,1,0],[-1,0,-Fr],[1,0,-Fr],[Fr,1,0],[0,Fr,1],[-1,0,Fr],[-Fr,-1,0],[0,-Fr,-1],[Fr,-1,0],[1,0,Fr],[0,-Fr,1]],[[0,2,1],[0,3,2],[0,4,3],[0,5,4],[0,1,5],[7,6,1],[8,7,2],[9,8,3],[10,9,4],[6,10,5],[2,7,1],[3,8,2],[4,9,3],[5,10,4],[1,6,5],[11,6,7],[11,7,8],[11,8,9],[11,9,10],[11,10,6]])}setIndices(){let e=12;const t={},i=this.m,r=this.n;let s=i,n=1,a=0;r!==0&&(s=Ee.HCF(i,r)),n=i/s,a=r/s;let l,c,h,u,d;const f=ji.Zero(),_=new ji(i,r),p=new ji(-r,i+r),m=ji.Zero(),T=ji.Zero(),b=ji.Zero();let y=[],S,C,I,P;const D=[],w=this.vertByDist,L=(U,G,Z,he)=>{S=U+"|"+Z,C=G+"|"+he,S in t||C in t?S in t&&!(C in t)?t[C]=t[S]:C in t&&!(S in t)&&(t[S]=t[C]):(t[S]=e,t[C]=e,e++),w[Z][0]>2?D[t[S]]=[-w[Z][0],w[Z][1],t[S]]:D[t[S]]=[y[w[Z][0]],w[Z][1],t[S]]};this.IDATA.edgematch=[[1,"B"],[2,"B"],[3,"B"],[4,"B"],[0,"B"],[10,"O",14,"A"],[11,"O",10,"A"],[12,"O",11,"A"],[13,"O",12,"A"],[14,"O",13,"A"],[0,"O"],[1,"O"],[2,"O"],[3,"O"],[4,"O"],[19,"B",5,"A"],[15,"B",6,"A"],[16,"B",7,"A"],[17,"B",8,"A"],[18,"B",9,"A"]];for(let U=0;U<20;U++){if(y=this.IDATA.face[U],h=y[2],u=y[1],d=y[0],I=f.x+"|"+f.y,S=U+"|"+I,S in t||(t[S]=h,D[h]=[y[w[I][0]],w[I][1]]),I=_.x+"|"+_.y,S=U+"|"+I,S in t||(t[S]=u,D[u]=[y[w[I][0]],w[I][1]]),I=p.x+"|"+p.y,S=U+"|"+I,S in t||(t[S]=d,D[d]=[y[w[I][0]],w[I][1]]),l=this.IDATA.edgematch[U][0],c=this.IDATA.edgematch[U][1],c==="B")for(let G=1;G<s;G++)T.x=i-G*(n+a),T.y=r+G*n,b.x=-G*a,b.y=G*(n+a),I=T.x+"|"+T.y,P=b.x+"|"+b.y,L(U,l,I,P);if(c==="O")for(let G=1;G<s;G++)b.x=-G*a,b.y=G*(n+a),m.x=G*n,m.y=G*a,I=b.x+"|"+b.y,P=m.x+"|"+m.y,L(U,l,I,P);if(l=this.IDATA.edgematch[U][2],c=this.IDATA.edgematch[U][3],c&&c==="A")for(let G=1;G<s;G++)m.x=G*n,m.y=G*a,T.x=i-(s-G)*(n+a),T.y=r+(s-G)*n,I=m.x+"|"+m.y,P=T.x+"|"+T.y,L(U,l,I,P);for(let G=0;G<this.vertices.length;G++)I=this.vertices[G].x+"|"+this.vertices[G].y,S=U+"|"+I,S in t||(t[S]=e++,w[I][0]>2?D[t[S]]=[-w[I][0],w[I][1],t[S]]:D[t[S]]=[y[w[I][0]],w[I][1],t[S]])}this.closestTo=D,this.vecToidx=t}calcCoeffs(){const e=this.m,t=this.n,i=Math.sqrt(3)/3,r=e*e+t*t+e*t;this.coau=(e+t)/r,this.cobu=-t/r,this.coav=-i*(e-t)/r,this.cobv=i*(2*e+t)/r}createInnerFacets(){const e=this.m,t=this.n;for(let i=0;i<t+e+1;i++)for(let r=this.min[i];r<this.max[i]+1;r++)r<this.max[i]&&r<this.max[i+1]+1&&this.innerFacets.push(["|"+r+"|"+i,"|"+r+"|"+(i+1),"|"+(r+1)+"|"+i]),i>0&&r<this.max[i-1]&&r+1<this.max[i]+1&&this.innerFacets.push(["|"+r+"|"+i,"|"+(r+1)+"|"+i,"|"+(r+1)+"|"+(i-1)])}edgeVecsABOB(){const e=this.m,t=this.n,i=new ji(-t,e+t);for(let r=1;r<e+t;r++){const s=new ji(this.min[r],r),n=new ji(this.min[r-1],r-1),a=new ji(this.min[r+1],r+1),l=s.clone(),c=n.clone(),h=a.clone();l.rotate60About(i),c.rotate60About(i),h.rotate60About(i);const u=new ji(this.max[l.y],l.y),d=new ji(this.max[l.y-1],l.y-1),f=new ji(this.max[l.y-1]-1,l.y-1);(l.x!==u.x||l.y!==u.y)&&(l.x!==d.x?(this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,d,f]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,f,u])):l.y===h.y?(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([s,n,d]),this.vertexTypes.push([1,0,1]),this.isoVecsABOB.push([s,d,a])):(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([s,n,d]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,d,u])))}}mapABOBtoOBOA(){const e=new ji(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let r=0;r<3;r++)e.x=this.isoVecsABOB[t][r].x,e.y=this.isoVecsABOB[t][r].y,this.vertexTypes[t][r]===0&&e.rotateNeg120(this.m,this.n),i.push(e.clone());this.isoVecsOBOA.push(i)}}mapABOBtoBAOA(){const e=new ji(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let r=0;r<3;r++)e.x=this.isoVecsABOB[t][r].x,e.y=this.isoVecsABOB[t][r].y,this.vertexTypes[t][r]===1&&e.rotate120(this.m,this.n),i.push(e.clone());this.isoVecsBAOA.push(i)}}MapToFace(e,t){const i=this.IDATA.face[e],r=i[2],s=i[1],n=i[0],a=x.FromArray(this.IDATA.vertex[r]),l=x.FromArray(this.IDATA.vertex[s]),c=x.FromArray(this.IDATA.vertex[n]),h=l.subtract(a),u=c.subtract(a),d=h.scale(this.coau).add(u.scale(this.cobu)),f=h.scale(this.coav).add(u.scale(this.cobv));let _,p=j.Vector3[0];for(let m=0;m<this.cartesian.length;m++)p=d.scale(this.cartesian[m].x).add(f.scale(this.cartesian[m].y)).add(a),p.x,p.y,p.z,_=e+"|"+this.vertices[m].x+"|"+this.vertices[m].y,t.vertex[this.vecToidx[_]]=[p.x,p.y,p.z]}build(e,t){const i=new Array,r=ji.Zero(),s=new ji(e,t),n=new ji(-t,e+t);i.push(r,s,n);for(let C=t;C<e+1;C++)for(let I=0;I<e+1-C;I++)i.push(new ji(I,C));if(t>0){const C=Ee.HCF(e,t),I=e/C,P=t/C;for(let w=1;w<C;w++)i.push(new ji(w*I,w*P)),i.push(new ji(-w*P,w*(I+P))),i.push(new ji(e-w*(I+P),t+w*I));const D=e/t;for(let w=1;w<t;w++)for(let L=0;L<w*D;L++)i.push(new ji(L,w)),i.push(new ji(L,w).rotate120(e,t)),i.push(new ji(L,w).rotateNeg120(e,t))}i.sort((C,I)=>C.x-I.x),i.sort((C,I)=>C.y-I.y);const a=new Array(e+t+1),l=new Array(e+t+1);for(let C=0;C<a.length;C++)a[C]=1/0,l[C]=-1/0;let c=0,h=0;const u=i.length;for(let C=0;C<u;C++)h=i[C].x,c=i[C].y,a[c]=Math.min(h,a[c]),l[c]=Math.max(h,l[c]);const d=(C,I)=>{const P=C.clone();return I==="A"&&P.rotateNeg120(e,t),I==="B"&&P.rotate120(e,t),P.x<0?P.y:P.x+P.y},f=[],_=[],p=[],m=[],T={},b=[];let y=-1,S=-1;for(let C=0;C<u;C++)f[C]=i[C].toCartesianOrigin(new ji(0,0),.5),_[C]=d(i[C],"O"),p[C]=d(i[C],"A"),m[C]=d(i[C],"B"),_[C]===p[C]&&p[C]===m[C]?(y=3,S=_[C]):_[C]===p[C]?(y=4,S=_[C]):p[C]===m[C]?(y=5,S=p[C]):m[C]===_[C]&&(y=6,S=_[C]),_[C]<p[C]&&_[C]<m[C]&&(y=2,S=_[C]),p[C]<_[C]&&p[C]<m[C]&&(y=1,S=p[C]),m[C]<p[C]&&m[C]<_[C]&&(y=0,S=m[C]),b.push([y,S,i[C].x,i[C].y]);b.sort((C,I)=>C[2]-I[2]),b.sort((C,I)=>C[3]-I[3]),b.sort((C,I)=>C[1]-I[1]),b.sort((C,I)=>C[0]-I[0]);for(let C=0;C<b.length;C++)T[b[C][2]+"|"+b[C][3]]=[b[C][0],b[C][1],C];return this.m=e,this.n=t,this.vertices=i,this.vertByDist=T,this.cartesian=f,this.min=a,this.max=l,this}}class np{constructor(e,t,i,r){this.name=e,this.category=t,this.vertex=i,this.face=r}}class Hm extends np{innerToData(e,t){for(let i=0;i<t.innerFacets.length;i++)this.face.push(t.innerFacets[i].map(r=>t.vecToidx[e+r]))}mapABOBtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let r=0;r<t.isoVecsABOB.length;r++){const s=[];for(let n=0;n<3;n++)t.vertexTypes[r][n]===0?s.push(e+"|"+t.isoVecsABOB[r][n].x+"|"+t.isoVecsABOB[r][n].y):s.push(i+"|"+t.isoVecsABOB[r][n].x+"|"+t.isoVecsABOB[r][n].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapOBOAtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let r=0;r<t.isoVecsOBOA.length;r++){const s=[];for(let n=0;n<3;n++)t.vertexTypes[r][n]===1?s.push(e+"|"+t.isoVecsOBOA[r][n].x+"|"+t.isoVecsOBOA[r][n].y):s.push(i+"|"+t.isoVecsOBOA[r][n].x+"|"+t.isoVecsOBOA[r][n].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapBAOAtoDATA(e,t){const i=t.IDATA.edgematch[e][2];for(let r=0;r<t.isoVecsBAOA.length;r++){const s=[];for(let n=0;n<3;n++)t.vertexTypes[r][n]===1?s.push(e+"|"+t.isoVecsBAOA[r][n].x+"|"+t.isoVecsBAOA[r][n].y):s.push(i+"|"+t.isoVecsBAOA[r][n].x+"|"+t.isoVecsBAOA[r][n].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}orderData(e){const t=[];for(let n=0;n<13;n++)t[n]=[];const i=e.closestTo;for(let n=0;n<i.length;n++)i[n][0]>-1?i[n][1]>0&&t[i[n][0]].push([n,i[n][1]]):t[12].push([n,i[n][0]]);const r=[];for(let n=0;n<12;n++)r[n]=n;let s=12;for(let n=0;n<12;n++){t[n].sort((a,l)=>a[1]-l[1]);for(let a=0;a<t[n].length;a++)r[t[n][a][0]]=s++}for(let n=0;n<t[12].length;n++)r[t[12][n][0]]=s++;for(let n=0;n<this.vertex.length;n++)this.vertex[n].push(r[n]);this.vertex.sort((n,a)=>n[3]-a[3]);for(let n=0;n<this.vertex.length;n++)this.vertex[n].pop();for(let n=0;n<this.face.length;n++)for(let a=0;a<this.face[n].length;a++)this.face[n][a]=r[this.face[n][a]];this.sharedNodes=t[12].length,this.poleNodes=this.vertex.length-this.sharedNodes}setOrder(e,t){const i=[],r=[];let s=t.pop();r.push(s);let n=this.face[s].indexOf(e);n=(n+2)%3;let a=this.face[s][n];i.push(a);let l=0;for(;t.length>0;)s=t[l],this.face[s].indexOf(a)>-1?(n=(this.face[s].indexOf(a)+1)%3,a=this.face[s][n],i.push(a),r.push(s),t.splice(l,1),l=0):l++;return this.adjacentFaces.push(i),r}toGoldbergPolyhedronData(){const e=new np("GeoDual","Goldberg",[],[]);e.name="GD dual";const t=this.vertex.length,i=new Array(t);for(let c=0;c<t;c++)i[c]=[];for(let c=0;c<this.face.length;c++)for(let h=0;h<3;h++)i[this.face[c][h]].push(c);let r=0,s=0,n=0,a=[],l=[];this.adjacentFaces=[];for(let c=0;c<i.length;c++)e.face[c]=this.setOrder(c,i[c].concat([])),i[c].forEach(h=>{r=0,s=0,n=0,a=this.face[h];for(let u=0;u<3;u++)l=this.vertex[a[u]],r+=l[0],s+=l[1],n+=l[2];e.vertex[h]=[r/3,s/3,n/3]});return e}static BuildGeodesicData(e){const t=new Hm("Geodesic-m-n","Geodesic",[[0,Fr,-1],[-Fr,1,0],[-1,0,-Fr],[1,0,-Fr],[Fr,1,0],[0,Fr,1],[-1,0,Fr],[-Fr,-1,0],[0,-Fr,-1],[Fr,-1,0],[1,0,Fr],[0,-Fr,1]],[]);e.setIndices(),e.calcCoeffs(),e.createInnerFacets(),e.edgeVecsABOB(),e.mapABOBtoOBOA(),e.mapABOBtoBAOA();for(let r=0;r<e.IDATA.face.length;r++)e.MapToFace(r,t),t.innerToData(r,e),e.IDATA.edgematch[r][1]==="B"&&t.mapABOBtoDATA(r,e),e.IDATA.edgematch[r][1]==="O"&&t.mapOBOAtoDATA(r,e),e.IDATA.edgematch[r][3]==="A"&&t.mapBAOAtoDATA(r,e);t.orderData(e);const i=1;return t.vertex=t.vertex.map(function(r){const s=r[0],n=r[1],a=r[2],l=Math.sqrt(s*s+n*n+a*a);return r[0]*=i/l,r[1]*=i/l,r[2]*=i/l,r}),t}}function D1(o,e){const t=o.size,i=o.sizeX||t||1,r=o.sizeY||t||1,s=o.sizeZ||t||1,n=o.sideOrientation===0?0:o.sideOrientation||Oe.DEFAULTSIDE,a=new Array,l=new Array,c=new Array,h=new Array;let u=1/0,d=-1/0,f=1/0,_=-1/0;for(let T=0;T<e.vertex.length;T++)u=Math.min(u,e.vertex[T][0]*i),d=Math.max(d,e.vertex[T][0]*i),f=Math.min(f,e.vertex[T][1]*r),_=Math.max(_,e.vertex[T][1]*r);let p=0;for(let T=0;T<e.face.length;T++){const b=e.face[T],y=x.FromArray(e.vertex[b[0]]),S=x.FromArray(e.vertex[b[2]]),C=x.FromArray(e.vertex[b[1]]),I=S.subtract(y),P=C.subtract(y),D=x.Cross(P,I).normalize();for(let w=0;w<b.length;w++){c.push(D.x,D.y,D.z);const L=e.vertex[b[w]];a.push(L[0]*i,L[1]*r,L[2]*s);const U=(L[1]*r-f)/(_-f);h.push((L[0]*i-u)/(d-u),Yt.UseOpenGLOrientationForUV?1-U:U)}for(let w=0;w<b.length-2;w++)l.push(p,p+w+2,p+w+1);p+=b.length}Oe._ComputeSides(n,a,l,c,h);const m=new Oe;return m.positions=a,m.indices=l,m.normals=c,m.uvs=h,m}function N1(o,e,t=null){const i=e.size,r=e.sizeX||i||1,s=e.sizeY||i||1,n=e.sizeZ||i||1;let a=e.m||1;a!==Math.floor(a)&&X.Warn("m not an integer only floor(m) used");let l=e.n||0;if(l!==Math.floor(l)&&X.Warn("n not an integer only floor(n) used"),l>a){const _=l;l=a,a=_,X.Warn("n > m therefore m and n swapped")}const c=new O1;c.build(a,l);const h=Hm.BuildGeodesicData(c),u=h.toGoldbergPolyhedronData(),d=new Kf(o,t);e.sideOrientation=K._GetDefaultSideOrientation(e.sideOrientation),d._originalBuilderSideOrientation=e.sideOrientation,D1(e,u).applyToMesh(d,e.updatable),d.goldbergData.nbSharedFaces=h.sharedNodes,d.goldbergData.nbUnsharedFaces=h.poleNodes,d.goldbergData.adjacentFaces=h.adjacentFaces,d.goldbergData.nbFaces=d.goldbergData.nbSharedFaces+d.goldbergData.nbUnsharedFaces,d.goldbergData.nbFacesAtPole=(d.goldbergData.nbUnsharedFaces-12)/12;for(let _=0;_<h.vertex.length;_++)d.goldbergData.faceCenters.push(x.FromArray(h.vertex[_])),d.goldbergData.faceCenters[_].x*=r,d.goldbergData.faceCenters[_].y*=s,d.goldbergData.faceCenters[_].z*=n,d.goldbergData.faceColors.push(new Ye(1,1,1,1));for(let _=0;_<u.face.length;_++){const p=u.face[_],m=x.FromArray(u.vertex[p[0]]),T=x.FromArray(u.vertex[p[2]]),b=x.FromArray(u.vertex[p[1]]),y=T.subtract(m),S=b.subtract(m),C=x.Cross(S,y).normalize(),I=x.Cross(S,C).normalize();d.goldbergData.faceXaxis.push(S.normalize()),d.goldbergData.faceYaxis.push(C),d.goldbergData.faceZaxis.push(I)}return d}K.CreateGoldberg=N1;class w1{constructor(){this.running=!1,this._simplificationArray=[]}addTask(e){this._simplificationArray.push(e)}executeNext(){const e=this._simplificationArray.pop();e?(this.running=!0,this.runSimplification(e)):this.running=!1}runSimplification(e){if(e.parallelProcessing)e.settings.forEach(t=>{this._getSimplifier(e).simplify(t,r=>{t.distance!==void 0&&e.mesh.addLODLevel(t.distance,r),r.isVisible=!0,t.quality===e.settings[e.settings.length-1].quality&&e.successCallback&&e.successCallback(),this.executeNext()})});else{const t=this._getSimplifier(e),i=(r,s)=>{t.simplify(r,n=>{r.distance!==void 0&&e.mesh.addLODLevel(r.distance,n),n.isVisible=!0,s()})};ba.Run(e.settings.length,r=>{i(e.settings[r.index],()=>{r.executeNext()})},()=>{e.successCallback&&e.successCallback(),this.executeNext()})}}_getSimplifier(e){switch(e.simplificationType){case nf.QUADRATIC:default:return new U1(e.mesh)}}}var nf;(function(o){o[o.QUADRATIC=0]="QUADRATIC"})(nf||(nf={}));class F1{constructor(e){this._vertices=e,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}}class L1{constructor(e,t){this.position=e,this.id=t,this.isBorder=!0,this.q=new Kc,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}updatePosition(e){this.position.copyFrom(e)}}class Kc{constructor(e){this.data=new Array(10);for(let t=0;t<10;++t)e&&e[t]?this.data[t]=e[t]:this.data[t]=0}det(e,t,i,r,s,n,a,l,c){return this.data[e]*this.data[s]*this.data[c]+this.data[i]*this.data[r]*this.data[l]+this.data[t]*this.data[n]*this.data[a]-this.data[i]*this.data[s]*this.data[a]-this.data[e]*this.data[n]*this.data[l]-this.data[t]*this.data[r]*this.data[c]}addInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e.data[t]}addArrayInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e[t]}add(e){const t=new Kc;for(let i=0;i<10;++i)t.data[i]=this.data[i]+e.data[i];return t}static FromData(e,t,i,r){return new Kc(Kc.DataFromNumbers(e,t,i,r))}static DataFromNumbers(e,t,i,r){return[e*e,e*t,e*i,e*r,t*t,t*i,t*r,i*i,i*r,r*r]}}class B1{constructor(e,t){this.vertexId=e,this.triangleId=t}}class U1{constructor(e){this._mesh=e,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=kt}simplify(e,t){this._initDecimatedMesh(),ba.Run(this._mesh.subMeshes.length,i=>{this._initWithMesh(i.index,()=>{this._runDecimation(e,i.index,()=>{i.executeNext()})},e.optimizeMesh)},()=>{setTimeout(()=>{t(this._reconstructedMesh)},0)})}_runDecimation(e,t,i){const r=~~(this._triangles.length*e.quality);let s=0;const n=this._triangles.length,a=(l,c)=>{setTimeout(()=>{l%5===0&&this._updateMesh(l===0);for(let d=0;d<this._triangles.length;++d)this._triangles[d].isDirty=!1;const h=1e-9*Math.pow(l+3,this.aggressiveness),u=d=>{const f=~~((this._triangles.length/2+d)%this._triangles.length),_=this._triangles[f];if(_&&!(_.error[3]>h||_.deleted||_.isDirty)){for(let p=0;p<3;++p)if(_.error[p]<h){const m=[],T=[],b=_._vertices[p],y=_._vertices[(p+1)%3];if(b.isBorder||y.isBorder)continue;const S=x.Zero();this._calculateError(b,y,S);const C=new Array;if(this._isFlipped(b,y,S,m,C)||this._isFlipped(y,b,S,T,C)||m.indexOf(!0)<0||T.indexOf(!0)<0)continue;const I=new Array;if(C.forEach(w=>{I.indexOf(w)===-1&&(w.deletePending=!0,I.push(w))}),I.length%2!==0)continue;b.q=y.q.add(b.q),b.updatePosition(S);const P=this._references.length;s=this._updateTriangles(b,b,m,s),s=this._updateTriangles(b,y,T,s);const D=this._references.length-P;if(D<=b.triangleCount){if(D)for(let w=0;w<D;w++)this._references[b.triangleStart+w]=this._references[P+w]}else b.triangleStart=P;b.triangleCount=D;break}}};ba.SyncAsyncForLoop(this._triangles.length,this.syncIterations,u,c,()=>n-s<=r)},0)};ba.Run(this.decimationIterations,l=>{n-s<=r?l.breakLoop():a(l.index,()=>{l.executeNext()})},()=>{setTimeout(()=>{this._reconstructMesh(t),i()},0)})}_initWithMesh(e,t,i){this._vertices=[],this._triangles=[];const r=this._mesh.getVerticesData(O.PositionKind),s=this._mesh.getIndices(),n=this._mesh.subMeshes[e],a=u=>{if(i){for(let d=0;d<this._vertices.length;++d)if(this._vertices[d].position.equalsWithEpsilon(u,1e-4))return this._vertices[d]}return null},l=[],c=u=>{if(!r)return;const d=u+n.verticesStart,f=x.FromArray(r,d*3),_=a(f)||new L1(f,this._vertices.length);_.originalOffsets.push(d),_.id===this._vertices.length&&this._vertices.push(_),l.push(_.id)},h=n.verticesCount;ba.SyncAsyncForLoop(h,this.syncIterations/4>>0,c,()=>{const u=d=>{if(!s)return;const _=(n.indexStart/3+d)*3,p=s[_+0],m=s[_+1],T=s[_+2],b=this._vertices[l[p-n.verticesStart]],y=this._vertices[l[m-n.verticesStart]],S=this._vertices[l[T-n.verticesStart]],C=new F1([b,y,S]);C.originalOffset=_,this._triangles.push(C)};ba.SyncAsyncForLoop(n.indexCount/3,this.syncIterations,u,()=>{this._init(t)})})}_init(e){const t=i=>{const r=this._triangles[i];r.normal=x.Cross(r._vertices[1].position.subtract(r._vertices[0].position),r._vertices[2].position.subtract(r._vertices[0].position)).normalize();for(let s=0;s<3;s++)r._vertices[s].q.addArrayInPlace(Kc.DataFromNumbers(r.normal.x,r.normal.y,r.normal.z,-x.Dot(r.normal,r._vertices[0].position)))};ba.SyncAsyncForLoop(this._triangles.length,this.syncIterations,t,()=>{const i=r=>{const s=this._triangles[r];for(let n=0;n<3;++n)s.error[n]=this._calculateError(s._vertices[n],s._vertices[(n+1)%3]);s.error[3]=Math.min(s.error[0],s.error[1],s.error[2])};ba.SyncAsyncForLoop(this._triangles.length,this.syncIterations,i,()=>{e()})})}_reconstructMesh(e){const t=[];let i;for(i=0;i<this._vertices.length;++i)this._vertices[i].triangleCount=0;let r,s;for(i=0;i<this._triangles.length;++i)if(!this._triangles[i].deleted){for(r=this._triangles[i],s=0;s<3;++s)r._vertices[s].triangleCount=1;t.push(r)}const n=this._reconstructedMesh.getVerticesData(O.PositionKind)||[],a=this._reconstructedMesh.getVerticesData(O.NormalKind)||[],l=this._reconstructedMesh.getVerticesData(O.UVKind)||[],c=this._reconstructedMesh.getVerticesData(O.ColorKind)||[],h=this._mesh.getVerticesData(O.NormalKind),u=this._mesh.getVerticesData(O.UVKind),d=this._mesh.getVerticesData(O.ColorKind);let f=0;for(i=0;i<this._vertices.length;++i){const S=this._vertices[i];S.id=f,S.triangleCount&&S.originalOffsets.forEach(C=>{n.push(S.position.x),n.push(S.position.y),n.push(S.position.z),h&&h.length&&(a.push(h[C*3]),a.push(h[C*3+1]),a.push(h[C*3+2])),u&&u.length&&(l.push(u[C*2]),l.push(u[C*2+1])),d&&d.length&&(c.push(d[C*4]),c.push(d[C*4+1]),c.push(d[C*4+2]),c.push(d[C*4+3])),++f})}const _=this._reconstructedMesh.getTotalIndices(),p=this._reconstructedMesh.getTotalVertices(),m=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];const T=this._reconstructedMesh.getIndices(),b=this._mesh.getIndices();for(i=0;i<t.length;++i)r=t[i],[0,1,2].forEach(S=>{const C=b[r.originalOffset+S];let I=r._vertices[S].originalOffsets.indexOf(C);I<0&&(I=0),T.push(r._vertices[S].id+I+p)});this._reconstructedMesh.setIndices(T),this._reconstructedMesh.setVerticesData(O.PositionKind,n),a.length>0&&this._reconstructedMesh.setVerticesData(O.NormalKind,a),l.length>0&&this._reconstructedMesh.setVerticesData(O.UVKind,l),c.length>0&&this._reconstructedMesh.setVerticesData(O.ColorKind,c);const y=this._mesh.subMeshes[e];e>0&&(this._reconstructedMesh.subMeshes=[],m.forEach(S=>{qs.AddToMesh(S.materialIndex,S.verticesStart,S.verticesCount,S.indexStart,S.indexCount,S.getMesh())}),qs.AddToMesh(y.materialIndex,p,f,_,t.length*3,this._reconstructedMesh))}_initDecimatedMesh(){this._reconstructedMesh=new K(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId}_isFlipped(e,t,i,r,s){for(let n=0;n<e.triangleCount;++n){const a=this._triangles[this._references[e.triangleStart+n].triangleId];if(a.deleted)continue;const l=this._references[e.triangleStart+n].vertexId,c=a._vertices[(l+1)%3],h=a._vertices[(l+2)%3];if(c===t||h===t){r[n]=!0,s.push(a);continue}let u=c.position.subtract(i);u=u.normalize();let d=h.position.subtract(i);if(d=d.normalize(),Math.abs(x.Dot(u,d))>.999)return!0;const f=x.Cross(u,d).normalize();if(r[n]=!1,x.Dot(f,a.normal)<.2)return!0}return!1}_updateTriangles(e,t,i,r){let s=r;for(let n=0;n<t.triangleCount;++n){const a=this._references[t.triangleStart+n],l=this._triangles[a.triangleId];if(!l.deleted){if(i[n]&&l.deletePending){l.deleted=!0,s++;continue}l._vertices[a.vertexId]=e,l.isDirty=!0,l.error[0]=this._calculateError(l._vertices[0],l._vertices[1])+l.borderFactor/2,l.error[1]=this._calculateError(l._vertices[1],l._vertices[2])+l.borderFactor/2,l.error[2]=this._calculateError(l._vertices[2],l._vertices[0])+l.borderFactor/2,l.error[3]=Math.min(l.error[0],l.error[1],l.error[2]),this._references.push(a)}}return s}_identifyBorder(){for(let e=0;e<this._vertices.length;++e){const t=[],i=[],r=this._vertices[e];let s;for(s=0;s<r.triangleCount;++s){const n=this._triangles[this._references[r.triangleStart+s].triangleId];for(let a=0;a<3;a++){let l=0;const c=n._vertices[a];for(;l<t.length&&i[l]!==c.id;)++l;l===t.length?(t.push(1),i.push(c.id)):t[l]++}}for(s=0;s<t.length;++s)t[s]===1?this._vertices[i[s]].isBorder=!0:this._vertices[i[s]].isBorder=!1}}_updateMesh(e=!1){let t;if(!e){const l=[];for(t=0;t<this._triangles.length;++t)this._triangles[t].deleted||l.push(this._triangles[t]);this._triangles=l}for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleCount=0,this._vertices[t].triangleStart=0;let i,r,s;for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],r=0;r<3;++r)s=i._vertices[r],s.triangleCount++;let n=0;for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleStart=n,n+=this._vertices[t].triangleCount,this._vertices[t].triangleCount=0;const a=new Array(this._triangles.length*3);for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],r=0;r<3;++r)s=i._vertices[r],a[s.triangleStart+s.triangleCount]=new B1(r,t),s.triangleCount++;this._references=a,e&&this._identifyBorder()}_vertexError(e,t){const i=t.x,r=t.y,s=t.z;return e.data[0]*i*i+2*e.data[1]*i*r+2*e.data[2]*i*s+2*e.data[3]*i+e.data[4]*r*r+2*e.data[5]*r*s+2*e.data[6]*r+e.data[7]*s*s+2*e.data[8]*s+e.data[9]}_calculateError(e,t,i){const r=e.q.add(t.q),s=e.isBorder&&t.isBorder;let n=0;const a=r.det(0,1,2,1,4,5,2,5,7);if(a!==0&&!s)i||(i=x.Zero()),i.x=-1/a*r.det(1,2,3,4,5,6,5,7,8),i.y=1/a*r.det(0,2,3,1,5,6,2,7,8),i.z=-1/a*r.det(0,1,3,1,4,6,2,5,8),n=this._vertexError(r,i);else{const l=e.position.add(t.position).divide(new x(2,2,2)),c=this._vertexError(r,e.position),h=this._vertexError(r,t.position),u=this._vertexError(r,l);n=Math.min(c,h,u),n===c?i&&i.copyFrom(e.position):n===h?i&&i.copyFrom(t.position):i&&i.copyFrom(l)}return n}}Object.defineProperty(Ne.prototype,"simplificationQueue",{get:function(){if(!this._simplificationQueue){this._simplificationQueue=new w1;let o=this._getComponent(Re.NAME_SIMPLIFICATIONQUEUE);o||(o=new V1(this),this._addComponent(o))}return this._simplificationQueue},set:function(o){this._simplificationQueue=o},enumerable:!0,configurable:!0});K.prototype.simplify=function(o,e=!0,t=nf.QUADRATIC,i){return this.getScene().simplificationQueue.addTask({settings:o,parallelProcessing:e,mesh:this,simplificationType:t,successCallback:i}),this};class V1{constructor(e){this.name=Re.NAME_SIMPLIFICATIONQUEUE,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(Re.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this._beforeCameraUpdate)}rebuild(){}dispose(){}_beforeCameraUpdate(){this.scene._simplificationQueue&&!this.scene._simplificationQueue.running&&this.scene._simplificationQueue.executeNext()}}K.prototype.thinInstanceAdd=function(o,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return X.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(o)?o.length:1);const t=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(o))for(let i=0;i<o.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,o[i],i===o.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,o,e);return t};K.prototype.thinInstanceAddSelf=function(o=!0){return this.thinInstanceAdd(H.IdentityReadOnly,o)};K.prototype.thinInstanceRegisterAttribute=function(o,e){o===O.ColorKind&&(o=O.ColorInstanceKind),this.removeVerticesData(o),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[o]=e,this._userThinInstanceBuffersStorage.sizes[o]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[o]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[o]),this._userThinInstanceBuffersStorage.vertexBuffers[o]=new O(this.getEngine(),this._userThinInstanceBuffersStorage.data[o],o,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[o])};K.prototype.thinInstanceSetMatrixAt=function(o,e,t=!0){if(!this._thinInstanceDataStorage.matrixData||o>=this._thinInstanceDataStorage.instancesCount)return!1;const i=this._thinInstanceDataStorage.matrixData;return e.copyToArray(i,o*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[o]=e),t&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0};K.prototype.thinInstanceSetAttributeAt=function(o,e,t,i=!0){return o===O.ColorKind&&(o=O.ColorInstanceKind),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[o]||e>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(o,0),this._userThinInstanceBuffersStorage.data[o].set(t,e*this._userThinInstanceBuffersStorage.strides[o]),i&&this.thinInstanceBufferUpdated(o),!0)};Object.defineProperty(K.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(o){var e,t;const i=(e=this._thinInstanceDataStorage.matrixData)!==null&&e!==void 0?e:(t=this.source)===null||t===void 0?void 0:t._thinInstanceDataStorage.matrixData,r=i?i.length/16:0;o<=r&&(this._thinInstanceDataStorage.instancesCount=o)},enumerable:!0,configurable:!0});K.prototype._thinInstanceCreateMatrixBuffer=function(o,e,t=!1){o===O.ColorKind&&(o=O.ColorInstanceKind);const i=new Xa(this.getEngine(),e,!t,16,!1,!0);for(let r=0;r<4;r++)this.setVerticesBuffer(i.createVertexBuffer(o+r,r*4,4));return i};K.prototype.thinInstanceSetBuffer=function(o,e,t=0,i=!1){var r,s,n;t=t||16,o==="matrix"?((r=this._thinInstanceDataStorage.matrixBuffer)===null||r===void 0||r.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*t,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,e!==null?(this._thinInstanceDataStorage.instancesCount=e.length/t,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,i),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):o==="previousMatrix"?((s=this._thinInstanceDataStorage.previousMatrixBuffer)===null||s===void 0||s.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,e!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,i))):(o===O.ColorKind&&(o=O.ColorInstanceKind),e===null?!((n=this._userThinInstanceBuffersStorage)===null||n===void 0)&&n.data[o]&&(this.removeVerticesData(o),delete this._userThinInstanceBuffersStorage.data[o],delete this._userThinInstanceBuffersStorage.strides[o],delete this._userThinInstanceBuffersStorage.sizes[o],delete this._userThinInstanceBuffersStorage.vertexBuffers[o]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[o]=e,this._userThinInstanceBuffersStorage.strides[o]=t,this._userThinInstanceBuffersStorage.sizes[o]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[o]=new O(this.getEngine(),e,o,!i,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[o])))};K.prototype.thinInstanceBufferUpdated=function(o){var e,t,i;o==="matrix"?(e=this._thinInstanceDataStorage.matrixBuffer)===null||e===void 0||e.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount):o==="previousMatrix"?(t=this._thinInstanceDataStorage.previousMatrixBuffer)===null||t===void 0||t.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount):(o===O.ColorKind&&(o=O.ColorInstanceKind),!((i=this._userThinInstanceBuffersStorage)===null||i===void 0)&&i.vertexBuffers[o]&&this._userThinInstanceBuffersStorage.vertexBuffers[o].updateDirectly(this._userThinInstanceBuffersStorage.data[o],0))};K.prototype.thinInstancePartialBufferUpdate=function(o,e,t){var i;o==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,t):(o===O.ColorKind&&(o=O.ColorInstanceKind),!((i=this._userThinInstanceBuffersStorage)===null||i===void 0)&&i.vertexBuffers[o]&&this._userThinInstanceBuffersStorage.vertexBuffers[o].updateDirectly(e,t))};K.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];const o=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=new Array;for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=H.FromArray(o,e*16)}return this._thinInstanceDataStorage.worldMatrices};K.prototype.thinInstanceRefreshBoundingInfo=function(o=!1,e=!1,t=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const i=this._thinInstanceDataStorage.boundingVectors;o&&(i.length=0,this.refreshBoundingInfo(e,t));const r=this.getBoundingInfo(),s=this._thinInstanceDataStorage.matrixData;if(i.length===0)for(let n=0;n<r.boundingBox.vectors.length;++n)i.push(r.boundingBox.vectors[n].clone());j.Vector3[0].setAll(Number.POSITIVE_INFINITY),j.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let n=0;n<this._thinInstanceDataStorage.instancesCount;++n){H.FromArrayToRef(s,n*16,j.Matrix[0]);for(let a=0;a<i.length;++a)x.TransformCoordinatesToRef(i[a],j.Matrix[0],j.Vector3[2]),j.Vector3[0].minimizeInPlace(j.Vector3[2]),j.Vector3[1].maximizeInPlace(j.Vector3[2])}r.reConstruct(j.Vector3[0],j.Vector3[1]),this._updateBoundingInfo()};K.prototype._thinInstanceUpdateBufferSize=function(o,e=1){var t,i,r;o===O.ColorKind&&(o=O.ColorInstanceKind);const s=o==="matrix";if(!s&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[o]))return;const n=s?16:this._userThinInstanceBuffersStorage.strides[o],a=s?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[o];let l=s?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[o];const c=(this._thinInstanceDataStorage.instancesCount+e)*n;let h=a;for(;h<c;)h*=2;if(!l||a!=h){if(!l)l=new Float32Array(h);else{const u=new Float32Array(h);u.set(l,0),l=u}s?((t=this._thinInstanceDataStorage.matrixBuffer)===null||t===void 0||t.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",l,!1),this._thinInstanceDataStorage.matrixData=l,this._thinInstanceDataStorage.matrixBufferSize=h,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&((i=this._thinInstanceDataStorage.previousMatrixBuffer)===null||i===void 0||i.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",l,!1))):((r=this._userThinInstanceBuffersStorage.vertexBuffers[o])===null||r===void 0||r.dispose(),this._userThinInstanceBuffersStorage.data[o]=l,this._userThinInstanceBuffersStorage.sizes[o]=h,this._userThinInstanceBuffersStorage.vertexBuffers[o]=new O(this.getEngine(),l,o,!0,!1,n,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[o]))}};K.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})};K.prototype._disposeThinInstanceSpecificData=function(){var o;!((o=this._thinInstanceDataStorage)===null||o===void 0)&&o.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)};q.OfflineProviderFactory=(o,e,t=!1)=>new vn(o,e,t);class vn{get enableSceneOffline(){return this._enableSceneOffline}get enableTexturesOffline(){return this._enableTexturesOffline}constructor(e,t,i=!1){this._idbFactory=typeof indexedDB<"u"?indexedDB:void 0,this._currentSceneUrl=vn._ReturnFullUrlLocation(e),this._db=null,this._enableSceneOffline=!1,this._enableTexturesOffline=!1,this._manifestVersionFound=0,this._mustUpdateRessources=!1,this._hasReachedQuota=!1,vn.IDBStorageEnabled?i?(this._enableSceneOffline=!0,this._enableTexturesOffline=!0,this._manifestVersionFound=1,J.SetImmediate(()=>{t(!0)})):this._checkManifestFile(t):t(!0)}_checkManifestFile(e){const t=()=>{this._enableSceneOffline=!1,this._enableTexturesOffline=!1,e(!1)},i=()=>{try{if(typeof URL=="function"&&this._currentSceneUrl.indexOf("http")===0){const a=new URL(this._currentSceneUrl);return a.pathname+=".manifest",a.toString()}}catch{}return`${this._currentSceneUrl}.manifest`};let r=!1,s=i();const n=new gs;navigator.onLine&&(r=!0,s=s+(s.match(/\?/)==null?"?":"&")+Date.now()),n.open("GET",s),n.addEventListener("load",()=>{if(n.status===200||vn._ValidateXHRData(n,1))try{const a=JSON.parse(n.response);this._enableSceneOffline=a.enableSceneOffline,this._enableTexturesOffline=a.enableTexturesOffline&&vn._IsUASupportingBlobStorage,a.version&&!isNaN(parseInt(a.version))&&(this._manifestVersionFound=a.version),e(!0)}catch{t()}else t()},!1),n.addEventListener("error",()=>{if(r){r=!1;const a=i();n.open("GET",a),n.send()}else t()},!1);try{n.send()}catch{X.Error("Error on XHR send request."),e(!1)}}open(e,t){const i=()=>{this._isSupported=!1,t&&t()};if(!this._idbFactory||!(this._enableSceneOffline||this._enableTexturesOffline))this._isSupported=!1,t&&t();else if(this._db)e&&e();else{this._hasReachedQuota=!1,this._isSupported=!0;const r=this._idbFactory.open("babylonjs",1);r.onerror=()=>{i()},r.onblocked=()=>{X.Error("IDB request blocked. Please reload the page."),i()},r.onsuccess=()=>{this._db=r.result,e()},r.onupgradeneeded=s=>{if(this._db=s.target.result,this._db)try{this._db.createObjectStore("scenes",{keyPath:"sceneUrl"}),this._db.createObjectStore("versions",{keyPath:"sceneUrl"}),this._db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(n){X.Error("Error while creating object stores. Exception: "+n.message),i()}}}}loadImage(e,t){const i=vn._ReturnFullUrlLocation(e),r=()=>{!this._hasReachedQuota&&this._db!==null?this._saveImageIntoDBAsync(i,t):t.src=e};this._mustUpdateRessources?r():this._loadImageFromDBAsync(i,t,r)}_loadImageFromDBAsync(e,t,i){if(this._isSupported&&this._db!==null){let r;const s=this._db.transaction(["textures"]);s.onabort=()=>{t.src=e},s.oncomplete=()=>{let a;r&&typeof URL=="function"?(a=URL.createObjectURL(r.data),t.onerror=()=>{X.Error("Error loading image from blob URL: "+a+" switching back to web url: "+e),t.src=e},t.src=a):i()};const n=s.objectStore("textures").get(e);n.onsuccess=a=>{r=a.target.result},n.onerror=()=>{X.Error("Error loading texture "+e+" from DB."),t.src=e}}else X.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t.src=e}_saveImageIntoDBAsync(e,t){let i;if(this._isSupported){const r=()=>{let s;if(i&&typeof URL=="function")try{s=URL.createObjectURL(i)}catch{s=URL.createObjectURL(i)}s&&(t.src=s)};if(vn._IsUASupportingBlobStorage){const s=new gs;s.open("GET",e),s.responseType="blob",s.addEventListener("load",()=>{if(s.status===200&&this._db){i=s.response;const n=this._db.transaction(["textures"],"readwrite");n.onabort=l=>{try{const h=l.target.error;h&&h.name==="QuotaExceededError"&&(this._hasReachedQuota=!0)}catch{}r()},n.oncomplete=()=>{r()};const a={textureUrl:e,data:i};try{const l=n.objectStore("textures").put(a);l.onsuccess=()=>{},l.onerror=()=>{r()}}catch(l){l.code===25&&(vn._IsUASupportingBlobStorage=!1,this._enableTexturesOffline=!1),t.src=e}}else t.src=e},!1),s.addEventListener("error",()=>{X.Error("Error in XHR request in BABYLON.Database."),t.src=e},!1),s.send()}else t.src=e}else X.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t.src=e}_checkVersionFromDB(e,t){const i=()=>{this._saveVersionIntoDBAsync(e,t)};this._loadVersionFromDBAsync(e,t,i)}_loadVersionFromDBAsync(e,t,i){if(this._isSupported&&this._db){let r;try{const s=this._db.transaction(["versions"]);s.oncomplete=()=>{r?this._manifestVersionFound!==r.data?(this._mustUpdateRessources=!0,i()):t(r.data):(this._mustUpdateRessources=!0,i())},s.onabort=()=>{t(-1)};const n=s.objectStore("versions").get(e);n.onsuccess=a=>{r=a.target.result},n.onerror=()=>{X.Error("Error loading version for scene "+e+" from DB."),t(-1)}}catch(s){X.Error("Error while accessing 'versions' object store (READ OP). Exception: "+s.message),t(-1)}}else X.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t(-1)}_saveVersionIntoDBAsync(e,t){if(this._isSupported&&!this._hasReachedQuota&&this._db)try{const i=this._db.transaction(["versions"],"readwrite");i.onabort=n=>{try{const a=n.target.error;a&&a.name==="QuotaExceededError"&&(this._hasReachedQuota=!0)}catch{}t(-1)},i.oncomplete=()=>{t(this._manifestVersionFound)};const r={sceneUrl:e,data:this._manifestVersionFound},s=i.objectStore("versions").put(r);s.onsuccess=()=>{},s.onerror=()=>{X.Error("Error in DB add version request in BABYLON.Database.")}}catch(i){X.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+i.message),t(-1)}else t(-1)}loadFile(e,t,i,r,s){const n=vn._ReturnFullUrlLocation(e),a=()=>{this._saveFileAsync(n,t,i,s,r)};this._checkVersionFromDB(n,l=>{l!==-1?this._mustUpdateRessources?this._saveFileAsync(n,t,i,s,r):this._loadFileAsync(n,t,a):r&&r()})}_loadFileAsync(e,t,i){if(this._isSupported&&this._db){let r;e.indexOf(".babylon")!==-1?r="scenes":r="textures";let s;const n=this._db.transaction([r]);n.oncomplete=()=>{s?t(s.data):i()},n.onabort=()=>{i()};const a=n.objectStore(r).get(e);a.onsuccess=l=>{s=l.target.result},a.onerror=()=>{X.Error("Error loading file "+e+" from DB."),i()}}else X.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t()}_saveFileAsync(e,t,i,r,s){if(this._isSupported){let n;e.indexOf(".babylon")!==-1?n="scenes":n="textures";const a=new gs;let l;a.open("GET",e+(e.match(/\?/)==null?"?":"&")+Date.now()),r&&(a.responseType="arraybuffer"),i&&(a.onprogress=i),a.addEventListener("load",()=>{if(a.status===200||a.status<400&&vn._ValidateXHRData(a,r?6:1))if(l=r?a.response:a.responseText,!this._hasReachedQuota&&this._db){const c=this._db.transaction([n],"readwrite");c.onabort=u=>{try{const d=u.target.error;d&&d.name==="QuotaExceededError"&&(this._hasReachedQuota=!0)}catch{}t(l)},c.oncomplete=()=>{t(l)};let h;n==="scenes"?h={sceneUrl:e,data:l,version:this._manifestVersionFound}:h={textureUrl:e,data:l};try{const u=c.objectStore(n).put(h);u.onsuccess=()=>{},u.onerror=()=>{X.Error("Error in DB add file request in BABYLON.Database.")}}catch{t(l)}}else t(l);else a.status>=400&&s?s(a):t()},!1),a.addEventListener("error",()=>{X.Error("error on XHR request."),s&&s()},!1),a.send()}else X.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),s&&s()}static _ValidateXHRData(e,t=7){try{if(t&1){if(e.responseText&&e.responseText.length>0)return!0;if(t===1)return!1}if(t&2){const i=$f(e.response);if(i.width&&i.height&&i.width>0&&i.height>0)return!0;if(t===2)return!1}if(t&4){const i=new Uint8Array(e.response,0,3);return i[0]===68&&i[1]===68&&i[2]===83}}catch{}return!1}}vn._IsUASupportingBlobStorage=!0;vn.IDBStorageEnabled=!1;vn._ParseURL=o=>{const e=document.createElement("a");e.href=o;const t=o.substring(0,o.lastIndexOf("#")),i=o.substring(t.lastIndexOf("/")+1,o.length);return o.substring(0,o.indexOf(i,0))};vn._ReturnFullUrlLocation=o=>o.indexOf("http:/")===-1&&o.indexOf("https:/")===-1&&typeof window<"u"?vn._ParseURL(window.location.href)+o:o;class PE{_isUbo(e){return e.addUniform!==void 0}constructor(e){this._isUbo(e)?(this.setMatrix3x3=e.updateMatrix3x3.bind(e),this.setMatrix2x2=e.updateMatrix2x2.bind(e),this.setFloat=e.updateFloat.bind(e),this.setFloat2=e.updateFloat2.bind(e),this.setFloat3=e.updateFloat3.bind(e),this.setFloat4=e.updateFloat4.bind(e),this.setFloatArray=e.updateFloatArray.bind(e),this.setArray=e.updateArray.bind(e),this.setIntArray=e.updateIntArray.bind(e),this.setMatrix=e.updateMatrix.bind(e),this.setMatrices=e.updateMatrices.bind(e),this.setVector3=e.updateVector3.bind(e),this.setVector4=e.updateVector4.bind(e),this.setColor3=e.updateColor3.bind(e),this.setColor4=e.updateColor4.bind(e),this.setDirectColor4=e.updateDirectColor4.bind(e),this.setInt=e.updateInt.bind(e),this.setInt2=e.updateInt2.bind(e),this.setInt3=e.updateInt3.bind(e),this.setInt4=e.updateInt4.bind(e)):(this.setMatrix3x3=e.setMatrix3x3.bind(e),this.setMatrix2x2=e.setMatrix2x2.bind(e),this.setFloat=e.setFloat.bind(e),this.setFloat2=e.setFloat2.bind(e),this.setFloat3=e.setFloat3.bind(e),this.setFloat4=e.setFloat4.bind(e),this.setFloatArray=e.setFloatArray.bind(e),this.setArray=e.setArray.bind(e),this.setIntArray=e.setIntArray.bind(e),this.setMatrix=e.setMatrix.bind(e),this.setMatrices=e.setMatrices.bind(e),this.setVector3=e.setVector3.bind(e),this.setVector4=e.setVector4.bind(e),this.setColor3=e.setColor3.bind(e),this.setColor4=e.setColor4.bind(e),this.setDirectColor4=e.setDirectColor4.bind(e),this.setInt=e.setInt.bind(e),this.setInt2=e.setInt2.bind(e),this.setInt3=e.setInt3.bind(e),this.setInt4=e.setInt4.bind(e))}}const k1="gpuUpdateParticlesPixelShader",G1=`#version 300 es
void main() {
discard;
}
`;te.ShadersStore[k1]=G1;const z1="gpuUpdateParticlesVertexShader",H1=`#version 300 es
#define PI 3.14159
uniform float currentCount;
uniform float timeDelta;
uniform float stopFactor;
#ifndef LOCAL
uniform mat4 emitterWM;
#endif
uniform vec2 lifeTime;
uniform vec2 emitPower;
uniform vec2 sizeRange;
uniform vec4 scaleRange;
#ifndef COLORGRADIENTS
uniform vec4 color1;
uniform vec4 color2;
#endif
uniform vec3 gravity;
uniform sampler2D randomSampler;
uniform sampler2D randomSampler2;
uniform vec4 angleRange;
#ifdef BOXEMITTER
uniform vec3 direction1;
uniform vec3 direction2;
uniform vec3 minEmitBox;
uniform vec3 maxEmitBox;
#endif
#ifdef POINTEMITTER
uniform vec3 direction1;
uniform vec3 direction2;
#endif
#ifdef HEMISPHERICEMITTER
uniform float radius;
uniform float radiusRange;
uniform float directionRandomizer;
#endif
#ifdef SPHEREEMITTER
uniform float radius;
uniform float radiusRange;
#ifdef DIRECTEDSPHEREEMITTER
uniform vec3 direction1;
uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CYLINDEREMITTER
uniform float radius;
uniform float height;
uniform float radiusRange;
#ifdef DIRECTEDCYLINDEREMITTER
uniform vec3 direction1;
uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CONEEMITTER
uniform vec2 radius;
uniform float coneAngle;
uniform vec2 height;
uniform float directionRandomizer;
#endif
in vec3 position;
#ifdef CUSTOMEMITTER
in vec3 initialPosition;
#endif
in float age;
in float life;
in vec4 seed;
in vec3 size;
#ifndef COLORGRADIENTS
in vec4 color;
#endif
in vec3 direction;
#ifndef BILLBOARD
in vec3 initialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
in float angle;
#else
in vec2 angle;
#endif
#ifdef ANIMATESHEET
in float cellIndex;
#ifdef ANIMATESHEETRANDOMSTART
in float cellStartOffset;
#endif
#endif
#ifdef NOISE
in vec3 noiseCoordinates1;
in vec3 noiseCoordinates2;
#endif
out vec3 outPosition;
#ifdef CUSTOMEMITTER
out vec3 outInitialPosition;
#endif
out float outAge;
out float outLife;
out vec4 outSeed;
out vec3 outSize;
#ifndef COLORGRADIENTS
out vec4 outColor;
#endif
out vec3 outDirection;
#ifndef BILLBOARD
out vec3 outInitialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
out float outAngle;
#else
out vec2 outAngle;
#endif
#ifdef ANIMATESHEET
out float outCellIndex;
#ifdef ANIMATESHEETRANDOMSTART
out float outCellStartOffset;
#endif
#endif
#ifdef NOISE
out vec3 outNoiseCoordinates1;
out vec3 outNoiseCoordinates2;
#endif
#ifdef SIZEGRADIENTS
uniform sampler2D sizeGradientSampler;
#endif 
#ifdef ANGULARSPEEDGRADIENTS
uniform sampler2D angularSpeedGradientSampler;
#endif 
#ifdef VELOCITYGRADIENTS
uniform sampler2D velocityGradientSampler;
#endif
#ifdef LIMITVELOCITYGRADIENTS
uniform sampler2D limitVelocityGradientSampler;
uniform float limitVelocityDamping;
#endif
#ifdef DRAGGRADIENTS
uniform sampler2D dragGradientSampler;
#endif
#ifdef NOISE
uniform vec3 noiseStrength;
uniform sampler2D noiseSampler;
#endif
#ifdef ANIMATESHEET
uniform vec4 cellInfos;
#endif
vec3 getRandomVec3(float offset) {
return texture(randomSampler2,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;
}
vec4 getRandomVec4(float offset) {
return texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));
}
void main() {
float newAge=age+timeDelta; 
if (newAge>=life && stopFactor != 0.) {
vec3 newPosition;
vec3 newDirection;
vec4 randoms=getRandomVec4(seed.x);
outLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;
outAge=newAge-life;
outSeed=seed;
#ifdef SIZEGRADIENTS 
outSize.x=texture(sizeGradientSampler,vec2(0,0)).r;
#else
outSize.x=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;
#endif
outSize.y=scaleRange.x+(scaleRange.y-scaleRange.x)*randoms.b;
outSize.z=scaleRange.z+(scaleRange.w-scaleRange.z)*randoms.a; 
#ifndef COLORGRADIENTS
outColor=color1+(color2-color1)*randoms.b;
#endif
#ifndef ANGULARSPEEDGRADIENTS 
outAngle.y=angleRange.x+(angleRange.y-angleRange.x)*randoms.a;
outAngle.x=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#else
outAngle=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#endif 
#ifdef POINTEMITTER
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);
newPosition=vec3(0,0,0);
newDirection=direction1+(direction2-direction1)*randoms3;
#elif defined(BOXEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);
newPosition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;
newDirection=direction1+(direction2-direction1)*randoms3; 
#elif defined(HEMISPHERICEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);
float phi=2.0*PI*randoms2.x;
float theta=acos(2.0*randoms2.y-1.0);
float randX=cos(phi)*sin(theta);
float randY=cos(theta);
float randZ=sin(phi)*sin(theta);
newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,abs(randY),randZ);
newDirection=newPosition+directionRandomizer*randoms3; 
#elif defined(SPHEREEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);
float phi=2.0*PI*randoms2.x;
float theta=acos(2.0*randoms2.y-1.0);
float randX=cos(phi)*sin(theta);
float randY=cos(theta);
float randZ=sin(phi)*sin(theta);
newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=normalize(direction1+(direction2-direction1)*randoms3);
#else
newDirection=normalize(newPosition+directionRandomizer*randoms3);
#endif
#elif defined(CYLINDEREMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);
float yPos=(randoms2.x-0.5)*height;
float angle=randoms2.y*PI*2.;
float inverseRadiusRangeSquared=((1.-radiusRange)*(1.-radiusRange));
float positionRadius=radius*sqrt(inverseRadiusRangeSquared+(randoms2.z*(1.-inverseRadiusRangeSquared)));
float xPos=positionRadius*cos(angle);
float zPos=positionRadius*sin(angle);
newPosition=vec3(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else
angle=angle+((randoms3.x-0.5)*PI)*directionRandomizer;
newDirection=vec3(cos(angle),(randoms3.y-0.5)*directionRandomizer,sin(angle));
newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
float s=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
float h=0.0001;
#else
float h=randoms2.y*height.y;
h=1.-h*h; 
#endif
float lRadius=radius.x-radius.x*randoms2.z*radius.y;
lRadius=lRadius*h;
float randX=lRadius*sin(s);
float randZ=lRadius*cos(s);
float randY=h *height.x;
newPosition=vec3(randX,randY,randZ); 
if (abs(cos(coneAngle))==1.0) {
newDirection=vec3(0.,1.0,0.);
} else {
vec3 randoms3=getRandomVec3(seed.z);
newDirection=normalize(newPosition+directionRandomizer*randoms3); 
}
#elif defined(CUSTOMEMITTER)
newPosition=initialPosition;
outInitialPosition=initialPosition;
#else 
newPosition=vec3(0.,0.,0.);
newDirection=2.0*(getRandomVec3(seed.w)-vec3(0.5,0.5,0.5));
#endif
float power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;
#ifdef LOCAL
outPosition=newPosition;
#else
outPosition=(emitterWM*vec4(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#ifndef BILLBOARD 
outInitialDirection=direction;
#endif
#else
#ifdef LOCAL
vec3 initial=newDirection;
#else 
vec3 initial=(emitterWM*vec4(newDirection,0.)).xyz;
#endif
outDirection=initial*power;
#ifndef BILLBOARD 
outInitialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET 
outCellIndex=cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=randoms.a*outLife;
#endif 
#endif
#ifdef NOISE
outNoiseCoordinates1=noiseCoordinates1;
outNoiseCoordinates2=noiseCoordinates2;
#endif
} else {
float directionScale=timeDelta;
outAge=newAge;
float ageGradient=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale*=texture(velocityGradientSampler,vec2(ageGradient,0)).r;
#endif
#ifdef DRAGGRADIENTS
directionScale*=1.0-texture(dragGradientSampler,vec2(ageGradient,0)).r;
#endif
#if defined(CUSTOMEMITTER)
outPosition=position+(direction-position)*ageGradient; 
outInitialPosition=initialPosition;
#else
outPosition=position+direction*directionScale;
#endif
outLife=life;
outSeed=seed;
#ifndef COLORGRADIENTS 
outColor=color;
#endif
#ifdef SIZEGRADIENTS
outSize.x=texture(sizeGradientSampler,vec2(ageGradient,0)).r;
outSize.yz=size.yz;
#else
outSize=size;
#endif 
#ifndef BILLBOARD 
outInitialDirection=initialDirection;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#else
vec3 updatedDirection=direction+gravity*timeDelta;
#ifdef LIMITVELOCITYGRADIENTS
float limitVelocity=texture(limitVelocityGradientSampler,vec2(ageGradient,0)).r;
float currentVelocity=length(updatedDirection);
if (currentVelocity>limitVelocity) {
updatedDirection=updatedDirection*limitVelocityDamping;
}
#endif
outDirection=updatedDirection;
#ifdef NOISE
float fetchedR=texture(noiseSampler,vec2(noiseCoordinates1.x,noiseCoordinates1.y)*vec2(0.5)+vec2(0.5)).r;
float fetchedG=texture(noiseSampler,vec2(noiseCoordinates1.z,noiseCoordinates2.x)*vec2(0.5)+vec2(0.5)).r;
float fetchedB=texture(noiseSampler,vec2(noiseCoordinates2.y,noiseCoordinates2.z)*vec2(0.5)+vec2(0.5)).r;
vec3 force=vec3(2.*fetchedR-1.,2.*fetchedG-1.,2.*fetchedB-1.)*noiseStrength;
outDirection=outDirection+force*timeDelta;
outNoiseCoordinates1=noiseCoordinates1;
outNoiseCoordinates2=noiseCoordinates2;
#endif 
#endif 
#ifdef ANGULARSPEEDGRADIENTS
float angularSpeed=texture(angularSpeedGradientSampler,vec2(ageGradient,0)).r;
outAngle=angle+angularSpeed*timeDelta;
#else
outAngle=vec2(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET 
float offsetAge=outAge;
float dist=cellInfos.y-cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=cellStartOffset;
offsetAge+=cellStartOffset;
#else
float cellStartOffset=0.;
#endif 
float ratio=0.;
if (cellInfos.w==1.0) {
ratio=clamp(mod(cellStartOffset+cellInfos.z*offsetAge,life)/life,0.,1.0);
}
else {
ratio=clamp(cellStartOffset+cellInfos.z*offsetAge/life,0.,1.0);
}
outCellIndex=float(int(cellInfos.x+ratio*dist));
#endif
}
}`;te.ShadersStore[z1]=H1;class W1{constructor(e,t){this._renderVAO=[],this._updateVAO=[],this.alignDataInBuffer=!1,this._parent=e,this._engine=t,this._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]}}isUpdateBufferCreated(){return!!this._updateEffect}isUpdateBufferReady(){var e,t;return(t=(e=this._updateEffect)===null||e===void 0?void 0:e.isReady())!==null&&t!==void 0?t:!1}createUpdateBuffer(e){return this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._parent.particleEmitterType instanceof nc&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._parent._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._parent._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._parent.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this._parent.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this._parent.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this._updateEffectOptions.defines=e,this._updateEffect=new ri("gpuUpdateParticles",this._updateEffectOptions,this._engine),new PE(this._updateEffect)}createVertexBuffers(e,t){this._updateVAO.push(this._createUpdateVAO(e)),this._renderVAO.push(this._engine.recordVertexArrayObject(t,null,this._parent._getWrapper(this._parent.blendMode).effect)),this._engine.bindArrayBuffer(null)}createParticleBuffer(e){return e}bindDrawBuffers(e){this._engine.bindVertexArrayObject(this._renderVAO[e],null)}preUpdateParticleBuffer(){const e=this._engine;if(this._engine.enableEffect(this._updateEffect),!e.setState)throw new Error("GPU particles cannot work without a full Engine. ThinEngine is not supported")}updateParticleBuffer(e,t,i){this._updateEffect.setTexture("randomSampler",this._parent._randomTexture),this._updateEffect.setTexture("randomSampler2",this._parent._randomTexture2),this._parent._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateEffect.setTexture("limitVelocityGradientSampler",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateEffect.setTexture("noiseSampler",this._parent.noiseTexture),this._engine.bindVertexArrayObject(this._updateVAO[e],null);const r=this._engine;r.bindTransformFeedbackBuffer(t.getBuffer()),r.setRasterizerState(!1),r.beginTransformFeedback(!0),r.drawArraysType(3,0,i),r.endTransformFeedback(),r.setRasterizerState(!0),r.bindTransformFeedbackBuffer(null)}releaseBuffers(){}releaseVertexBuffers(){for(let e=0;e<this._updateVAO.length;e++)this._engine.releaseVertexArrayObject(this._updateVAO[e]);this._updateVAO.length=0;for(let e=0;e<this._renderVAO.length;e++)this._engine.releaseVertexArrayObject(this._renderVAO[e]);this._renderVAO.length=0}_createUpdateVAO(e){const t={};t.position=e.createVertexBuffer("position",0,3);let i=3;t.age=e.createVertexBuffer("age",i,1),i+=1,t.size=e.createVertexBuffer("size",i,3),i+=3,t.life=e.createVertexBuffer("life",i,1),i+=1,t.seed=e.createVertexBuffer("seed",i,4),i+=4,t.direction=e.createVertexBuffer("direction",i,3),i+=3,this._parent.particleEmitterType instanceof nc&&(t.initialPosition=e.createVertexBuffer("initialPosition",i,3),i+=3),this._parent._colorGradientsTexture||(t.color=e.createVertexBuffer("color",i,4),i+=4),this._parent._isBillboardBased||(t.initialDirection=e.createVertexBuffer("initialDirection",i,3),i+=3),this._parent.noiseTexture&&(t.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",i,3),i+=3,t.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",i,3),i+=3),this._parent._angularSpeedGradientsTexture?(t.angle=e.createVertexBuffer("angle",i,1),i+=1):(t.angle=e.createVertexBuffer("angle",i,2),i+=2),this._parent._isAnimationSheetEnabled&&(t.cellIndex=e.createVertexBuffer("cellIndex",i,1),i+=1,this._parent.spriteRandomStartCell&&(t.cellStartOffset=e.createVertexBuffer("cellStartOffset",i,1),i+=1));const r=this._engine.recordVertexArrayObject(t,null,this._updateEffect);return this._engine.bindArrayBuffer(null),r}}ye("BABYLON.WebGL2ParticleSystem",W1);const X1="gpuUpdateParticlesComputeShader",$1=`struct Particle {
position : vec3<f32>,
age : f32,
size : vec3<f32>,
life : f32,
seed : vec4<f32>,
direction : vec3<f32>,
dummy0: f32,
#ifdef CUSTOMEMITTER
initialPosition : vec3<f32>,
dummy1: f32,
#endif
#ifndef COLORGRADIENTS
color : vec4<f32>,
#endif
#ifndef BILLBOARD
initialDirection : vec3<f32>,
dummy2: f32,
#endif
#ifdef NOISE
noiseCoordinates1 : vec3<f32>,
dummy3: f32,
noiseCoordinates2 : vec3<f32>,
dummy4: f32,
#endif
#ifdef ANGULARSPEEDGRADIENTS
angle : f32,
#else
angle : vec2<f32>,
#endif
#ifdef ANIMATESHEET
cellIndex : f32,
#ifdef ANIMATESHEETRANDOMSTART
cellStartOffset : f32,
#endif
#endif
};
struct Particles {
particles : array<Particle>,
};
struct SimParams {
currentCount : f32,
timeDelta : f32,
stopFactor : f32,
randomTextureSize: i32,
lifeTime : vec2<f32>,
emitPower : vec2<f32>,
#ifndef COLORGRADIENTS
color1 : vec4<f32>,
color2 : vec4<f32>,
#endif
sizeRange : vec2<f32>,
scaleRange : vec4<f32>,
angleRange : vec4<f32>,
gravity : vec3<f32>,
#ifdef LIMITVELOCITYGRADIENTS
limitVelocityDamping : f32,
#endif
#ifdef ANIMATESHEET
cellInfos : vec4<f32>,
#endif
#ifdef NOISE
noiseStrength : vec3<f32>,
#endif
#ifndef LOCAL
emitterWM : mat4x4<f32>,
#endif
#ifdef BOXEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
minEmitBox : vec3<f32>,
maxEmitBox : vec3<f32>,
#endif
#ifdef CONEEMITTER
radius : vec2<f32>,
coneAngle : f32,
height : vec2<f32>,
directionRandomizer : f32,
#endif
#ifdef CYLINDEREMITTER
radius : f32,
height : f32,
radiusRange : f32,
#ifdef DIRECTEDCYLINDEREMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
#ifdef HEMISPHERICEMITTER
radius : f32,
radiusRange : f32,
directionRandomizer : f32,
#endif
#ifdef POINTEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#endif
#ifdef SPHEREEMITTER
radius : f32,
radiusRange : f32,
#ifdef DIRECTEDSPHEREEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
};
@binding(0) @group(0) var<uniform> params : SimParams;
@binding(1) @group(0) var<storage,read> particlesIn : Particles;
@binding(2) @group(0) var<storage,read_write> particlesOut : Particles;
@binding(3) @group(0) var randomTexture : texture_2d<f32>;
@binding(4) @group(0) var randomTexture2 : texture_2d<f32>;
#ifdef SIZEGRADIENTS
@binding(0) @group(1) var sizeGradientSampler : sampler;
@binding(1) @group(1) var sizeGradientTexture : texture_2d<f32>;
#endif 
#ifdef ANGULARSPEEDGRADIENTS
@binding(2) @group(1) var angularSpeedGradientSampler : sampler;
@binding(3) @group(1) var angularSpeedGradientTexture : texture_2d<f32>;
#endif 
#ifdef VELOCITYGRADIENTS
@binding(4) @group(1) var velocityGradientSampler : sampler;
@binding(5) @group(1) var velocityGradientTexture : texture_2d<f32>;
#endif
#ifdef LIMITVELOCITYGRADIENTS
@binding(6) @group(1) var limitVelocityGradientSampler : sampler;
@binding(7) @group(1) var limitVelocityGradientTexture : texture_2d<f32>;
#endif
#ifdef DRAGGRADIENTS
@binding(8) @group(1) var dragGradientSampler : sampler;
@binding(9) @group(1) var dragGradientTexture : texture_2d<f32>;
#endif
#ifdef NOISE
@binding(10) @group(1) var noiseSampler : sampler;
@binding(11) @group(1) var noiseTexture : texture_2d<f32>;
#endif
fn getRandomVec3(offset : f32,vertexID : f32)->vec3<f32> {
return textureLoad(randomTexture2,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0).rgb;
}
fn getRandomVec4(offset : f32,vertexID : f32)->vec4<f32> {
return textureLoad(randomTexture,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0);
}
@stage(compute) @workgroup_size(64)
fn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {
let index : u32=GlobalInvocationID.x;
let vertexID : f32=f32(index);
if (index>=u32(params.currentCount)) {
return;
}
let PI : f32=3.14159;
let timeDelta : f32=params.timeDelta;
let newAge : f32=particlesIn.particles[index].age+timeDelta;
let life : f32=particlesIn.particles[index].life;
let seed : vec4<f32>=particlesIn.particles[index].seed;
let direction : vec3<f32>=particlesIn.particles[index].direction;
if (newAge>=life && params.stopFactor != 0.) {
var newPosition : vec3<f32>;
var newDirection : vec3<f32>;
let randoms : vec4<f32>=getRandomVec4(seed.x,vertexID);
let outLife : f32=params.lifeTime.x+(params.lifeTime.y-params.lifeTime.x)*randoms.r;
particlesOut.particles[index].life=outLife;
particlesOut.particles[index].age=newAge-life;
particlesOut.particles[index].seed=seed;
var sizex : f32;
#ifdef SIZEGRADIENTS 
sizex=textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(0.,0.),0.).r;
#else
sizex=params.sizeRange.x+(params.sizeRange.y-params.sizeRange.x)*randoms.g;
#endif
particlesOut.particles[index].size=vec3<f32>(
sizex,
params.scaleRange.x+(params.scaleRange.y-params.scaleRange.x)*randoms.b,
params.scaleRange.z+(params.scaleRange.w-params.scaleRange.z)*randoms.a);
#ifndef COLORGRADIENTS
particlesOut.particles[index].color=params.color1+(params.color2-params.color1)*randoms.b;
#endif
#ifndef ANGULARSPEEDGRADIENTS 
particlesOut.particles[index].angle=vec2<f32>(
params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r,
params.angleRange.x+(params.angleRange.y-params.angleRange.x)*randoms.a);
#else
particlesOut.particles[index].angle=params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r;
#endif 
#if defined(POINTEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
newPosition=vec3<f32>(0.,0.,0.);
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#elif defined(BOXEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
newPosition=params.minEmitBox+(params.maxEmitBox-params.minEmitBox)*randoms2;
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3; 
#elif defined(HEMISPHERICEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
let phi : f32=2.0*PI*randoms2.x;
let theta : f32=acos(-1.0+2.0*randoms2.y);
let randX : f32=cos(phi)*sin(theta);
let randY : f32=cos(theta);
let randZ : f32=sin(phi)*sin(theta);
newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,abs(randY),randZ);
newDirection=normalize(newPosition+params.directionRandomizer*randoms3);
#elif defined(SPHEREEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
let phi : f32=2.0*PI*randoms2.x;
let theta : f32=acos(-1.0+2.0*randoms2.y);
let randX : f32=cos(phi)*sin(theta);
let randY : f32=cos(theta);
let randZ : f32=sin(phi)*sin(theta);
newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=normalize(params.direction1+(params.direction2-params.direction1)*randoms3);
#else
newDirection=normalize(newPosition+params.directionRandomizer*randoms3);
#endif
#elif defined(CYLINDEREMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
let yPos : f32=(-0.5+randoms2.x)*params.height;
var angle : f32=randoms2.y*PI*2.;
let inverseRadiusRangeSquared : f32=(1.-params.radiusRange)*(1.-params.radiusRange);
let positionRadius : f32=params.radius*sqrt(inverseRadiusRangeSquared+randoms2.z*(1.-inverseRadiusRangeSquared));
let xPos : f32=positionRadius*cos(angle);
let zPos : f32=positionRadius*sin(angle);
newPosition=vec3<f32>(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#else
angle=angle+(-0.5+randoms3.x)*PI*params.directionRandomizer;
newDirection=vec3<f32>(cos(angle),(-0.5+randoms3.y)*params.directionRandomizer,sin(angle));
newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);
let s : f32=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
let h : f32=0.0001;
#else
var h : f32=randoms2.y*params.height.y;
h=1.-h*h; 
#endif
var lRadius : f32=params.radius.x-params.radius.x*randoms2.z*params.radius.y;
lRadius=lRadius*h;
let randX : f32=lRadius*sin(s);
let randZ : f32=lRadius*cos(s);
let randY : f32=h *params.height.x;
newPosition=vec3<f32>(randX,randY,randZ); 
if (abs(cos(params.coneAngle))==1.0) {
newDirection=vec3<f32>(0.,1.0,0.);
} else {
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
newDirection=normalize(newPosition+params.directionRandomizer*randoms3); 
}
#elif defined(CUSTOMEMITTER)
newPosition=particlesIn.particles[index].initialPosition;
particlesOut.particles[index].initialPosition=newPosition;
#else 
newPosition=vec3<f32>(0.,0.,0.);
newDirection=2.0*(getRandomVec3(seed.w,vertexID)-vec3<f32>(0.5,0.5,0.5));
#endif
let power : f32=params.emitPower.x+(params.emitPower.y-params.emitPower.x)*randoms.a;
#ifdef LOCAL
particlesOut.particles[index].position=newPosition;
#else
particlesOut.particles[index].position=(params.emitterWM*vec4<f32>(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
particlesOut.particles[index].direction=direction;
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=direction;
#endif
#else
#ifdef LOCAL
let initial : vec3<f32>=newDirection;
#else 
let initial : vec3<f32>=(params.emitterWM*vec4<f32>(newDirection,0.)).xyz;
#endif
particlesOut.particles[index].direction=initial*power;
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET 
particlesOut.particles[index].cellIndex=params.cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
particlesOut.particles[index].cellStartOffset=randoms.a*outLife;
#endif 
#endif
#ifdef NOISE
particlesOut.particles[index].noiseCoordinates1=particlesIn.particles[index].noiseCoordinates1;
particlesOut.particles[index].noiseCoordinates2=particlesIn.particles[index].noiseCoordinates2;
#endif
} else {
var directionScale : f32=timeDelta;
particlesOut.particles[index].age=newAge;
let ageGradient : f32=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale=directionScale*textureSampleLevel(velocityGradientTexture,velocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;
#endif
#ifdef DRAGGRADIENTS
directionScale=directionScale*(1.0-textureSampleLevel(dragGradientTexture,dragGradientSampler,vec2<f32>(ageGradient,0.),0.).r);
#endif
let position : vec3<f32>=particlesIn.particles[index].position;
#if defined(CUSTOMEMITTER)
particlesOut.particles[index].position=position+(direction-position)*ageGradient; 
particlesOut.particles[index].initialPosition=particlesIn.particles[index].initialPosition;
#else
particlesOut.particles[index].position=position+direction*directionScale;
#endif
particlesOut.particles[index].life=life;
particlesOut.particles[index].seed=seed;
#ifndef COLORGRADIENTS 
particlesOut.particles[index].color=particlesIn.particles[index].color;
#endif
#ifdef SIZEGRADIENTS
particlesOut.particles[index].size=vec3<f32>(
textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(ageGradient,0.),0.).r,
particlesIn.particles[index].size.yz);
#else
particlesOut.particles[index].size=particlesIn.particles[index].size;
#endif 
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=particlesIn.particles[index].initialDirection;
#endif
#ifdef CUSTOMEMITTER
particlesOut.particles[index].direction=direction;
#else
var updatedDirection : vec3<f32>=direction+params.gravity*timeDelta;
#ifdef LIMITVELOCITYGRADIENTS
let limitVelocity : f32=textureSampleLevel(limitVelocityGradientTexture,limitVelocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;
let currentVelocity : f32=length(updatedDirection);
if (currentVelocity>limitVelocity) {
updatedDirection=updatedDirection*params.limitVelocityDamping;
}
#endif
particlesOut.particles[index].direction=updatedDirection;
#ifdef NOISE
let noiseCoordinates1 : vec3<f32>=particlesIn.particles[index].noiseCoordinates1;
let noiseCoordinates2 : vec3<f32>=particlesIn.particles[index].noiseCoordinates2;
let fetchedR : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.x,noiseCoordinates1.y)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;
let fetchedG : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.z,noiseCoordinates2.x)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;
let fetchedB : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates2.y,noiseCoordinates2.z)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;
let force : vec3<f32>=vec3<f32>(-1.+2.*fetchedR,-1.+2.*fetchedG,-1.+2.*fetchedB)*params.noiseStrength;
particlesOut.particles[index].direction=particlesOut.particles[index].direction+force*timeDelta;
particlesOut.particles[index].noiseCoordinates1=noiseCoordinates1;
particlesOut.particles[index].noiseCoordinates2=noiseCoordinates2;
#endif 
#endif 
#ifdef ANGULARSPEEDGRADIENTS
let angularSpeed : f32=textureSampleLevel(angularSpeedGradientTexture,angularSpeedGradientSampler,vec2<f32>(ageGradient,0.),0.).r;
particlesOut.particles[index].angle=particlesIn.particles[index].angle+angularSpeed*timeDelta;
#else
let angle : vec2<f32>=particlesIn.particles[index].angle;
particlesOut.particles[index].angle=vec2<f32>(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET 
var offsetAge : f32=particlesOut.particles[index].age;
let dist : f32=params.cellInfos.y-params.cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
let cellStartOffset : f32=particlesIn.particles[index].cellStartOffset;
particlesOut.particles[index].cellStartOffset=cellStartOffset;
offsetAge=offsetAge+cellStartOffset;
#else
let cellStartOffset : f32=0.;
#endif 
var ratio : f32;
if (params.cellInfos.w==1.0) {
ratio=clamp(((cellStartOffset+params.cellInfos.z*offsetAge) % life)/life,0.,1.0);
}
else {
ratio=clamp((cellStartOffset+params.cellInfos.z*offsetAge)/life,0.,1.0);
}
particlesOut.particles[index].cellIndex=f32(i32(params.cellInfos.x+ratio*dist));
#endif
}
}
`;te.ShadersStoreWGSL[X1]=$1;class Y1{constructor(e,t){this._bufferComputeShader=[],this._renderVertexBuffers=[],this.alignDataInBuffer=!0,this._parent=e,this._engine=t}isUpdateBufferCreated(){return!!this._updateComputeShader}isUpdateBufferReady(){var e,t;return(t=(e=this._updateComputeShader)===null||e===void 0?void 0:e.isReady())!==null&&t!==void 0?t:!1}createUpdateBuffer(e){var t;const i={params:{group:0,binding:0},particlesIn:{group:0,binding:1},particlesOut:{group:0,binding:2},randomTexture:{group:0,binding:3},randomTexture2:{group:0,binding:4}};return this._parent._sizeGradientsTexture&&(i.sizeGradientTexture={group:1,binding:1}),this._parent._angularSpeedGradientsTexture&&(i.angularSpeedGradientTexture={group:1,binding:3}),this._parent._velocityGradientsTexture&&(i.velocityGradientTexture={group:1,binding:5}),this._parent._limitVelocityGradientsTexture&&(i.limitVelocityGradientTexture={group:1,binding:7}),this._parent._dragGradientsTexture&&(i.dragGradientTexture={group:1,binding:9}),this._parent.noiseTexture&&(i.noiseTexture={group:1,binding:11}),this._updateComputeShader=new Gu("updateParticles",this._engine,"gpuUpdateParticles",{bindingsMapping:i,defines:e.split(`
`)}),(t=this._simParamsComputeShader)===null||t===void 0||t.dispose(),this._simParamsComputeShader=new $e(this._engine),this._simParamsComputeShader.addUniform("currentCount",1),this._simParamsComputeShader.addUniform("timeDelta",1),this._simParamsComputeShader.addUniform("stopFactor",1),this._simParamsComputeShader.addUniform("randomTextureSize",1),this._simParamsComputeShader.addUniform("lifeTime",2),this._simParamsComputeShader.addUniform("emitPower",2),this._parent._colorGradientsTexture||(this._simParamsComputeShader.addUniform("color1",4),this._simParamsComputeShader.addUniform("color2",4)),this._simParamsComputeShader.addUniform("sizeRange",2),this._simParamsComputeShader.addUniform("scaleRange",4),this._simParamsComputeShader.addUniform("angleRange",4),this._simParamsComputeShader.addUniform("gravity",3),this._parent._limitVelocityGradientsTexture&&this._simParamsComputeShader.addUniform("limitVelocityDamping",1),this._parent.isAnimationSheetEnabled&&this._simParamsComputeShader.addUniform("cellInfos",4),this._parent.noiseTexture&&this._simParamsComputeShader.addUniform("noiseStrength",3),this._parent.isLocal||this._simParamsComputeShader.addUniform("emitterWM",16),this._parent.particleEmitterType&&this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader),this._updateComputeShader.setUniformBuffer("params",this._simParamsComputeShader),new PE(this._simParamsComputeShader)}createVertexBuffers(e,t){this._renderVertexBuffers.push(t)}createParticleBuffer(e){const t=new qS(this._engine,e.length*4,11);return t.update(e),this._bufferComputeShader.push(t),t.getBuffer()}bindDrawBuffers(e,t){this._engine.bindBuffers(this._renderVertexBuffers[e],null,t)}preUpdateParticleBuffer(){}updateParticleBuffer(e,t,i){this._simParamsComputeShader.update(),this._updateComputeShader.setTexture("randomTexture",this._parent._randomTexture,!1),this._updateComputeShader.setTexture("randomTexture2",this._parent._randomTexture2,!1),this._parent._sizeGradientsTexture&&this._updateComputeShader.setTexture("sizeGradientTexture",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateComputeShader.setTexture("angularSpeedGradientTexture",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateComputeShader.setTexture("velocityGradientTexture",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateComputeShader.setTexture("limitVelocityGradientTexture",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateComputeShader.setTexture("dragGradientTexture",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateComputeShader.setTexture("noiseTexture",this._parent.noiseTexture),this._updateComputeShader.setStorageBuffer("particlesIn",this._bufferComputeShader[e]),this._updateComputeShader.setStorageBuffer("particlesOut",this._bufferComputeShader[e^1]),this._updateComputeShader.dispatch(Math.ceil(i/64))}releaseBuffers(){var e;for(let t=0;t<this._bufferComputeShader.length;++t)this._bufferComputeShader[t].dispose();this._bufferComputeShader.length=0,(e=this._simParamsComputeShader)===null||e===void 0||e.dispose(),this._simParamsComputeShader=null,this._updateComputeShader=null}releaseVertexBuffers(){this._renderVertexBuffers.length=0}}ye("BABYLON.ComputeShaderParticleSystem",Y1);class ME{constructor(e,t,i){this.gradient=e,this.color1=t,this.color2=i}getColorToRef(e){if(!this.color2){e.copyFrom(this.color1);return}Ye.LerpToRef(this.color1,this.color2,Math.random(),e)}}class j1{constructor(e,t){this.gradient=e,this.color=t}}class OE{constructor(e,t,i){this.gradient=e,this.factor1=t,this.factor2=i}getFactor(){return this.factor2===void 0||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()}}class Hn{static GetCurrentGradient(e,t,i){if(t[0].gradient>e){i(t[0],t[0],1);return}for(let s=0;s<t.length-1;s++){const n=t[s],a=t[s+1];if(e>=n.gradient&&e<=a.gradient){const l=(e-n.gradient)/(a.gradient-n.gradient);i(n,a,l);return}}const r=t.length-1;i(t[r],t[r],1)}}class Au{constructor(e){this.particleSystem=e,this.position=x.Zero(),this.direction=x.Zero(),this.color=new Ye(0,0,0,0),this.colorStep=new Ye(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new Ie(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new Ye(0,0,0,0),this._currentColor2=new Ye(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=Au._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}_updateCellInfoFromSystem(){this.cellIndex=this.particleSystem.startSpriteCellID}updateCellIndex(){let e=this.age,t=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(this._randomCellOffset===void 0&&(this._randomCellOffset=Math.random()*this.lifeTime),t===0?(t=1,e=this._randomCellOffset):e+=this._randomCellOffset);const i=this._initialEndSpriteCellID-this._initialStartSpriteCellID;let r;this._initialSpriteCellLoop?r=Ee.Clamp(e*t%this.lifeTime/this.lifeTime):r=Ee.Clamp(e*t/this.lifeTime),this.cellIndex=this._initialStartSpriteCellID+r*i|0}_inheritParticleInfoToSubEmitter(e){if(e.particleSystem.emitter.position){const t=e.particleSystem.emitter;if(t.position.copyFrom(this.position),e.inheritDirection){const i=j.Vector3[0];this.direction.normalizeToRef(i),t.setDirection(i,0,Math.PI/2)}}else e.particleSystem.emitter.copyFrom(this.position);this.direction.scaleToRef(e.inheritedVelocityAmount/2,j.Vector3[0]),e.particleSystem._inheritedVelocityOffset.copyFrom(j.Vector3[0])}_inheritParticleInfoToSubEmitters(){this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach(e=>{this._inheritParticleInfoToSubEmitter(e)})}_reset(){this.age=0,this.id=Au._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0}copyTo(e){e.position.copyFrom(this.position),this._initialDirection?e._initialDirection?e._initialDirection.copyFrom(this._initialDirection):e._initialDirection=this._initialDirection.clone():e._initialDirection=null,e.direction.copyFrom(this.direction),this._localPosition&&(e._localPosition?e._localPosition.copyFrom(this._localPosition):e._localPosition=this._localPosition.clone()),e.color.copyFrom(this.color),e.colorStep.copyFrom(this.colorStep),e.lifeTime=this.lifeTime,e.age=this.age,e._randomCellOffset=this._randomCellOffset,e.size=this.size,e.scale.copyFrom(this.scale),e.angle=this.angle,e.angularSpeed=this.angularSpeed,e.particleSystem=this.particleSystem,e.cellIndex=this.cellIndex,e.id=this.id,e._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(e._currentColorGradient=this._currentColorGradient,e._currentColor1.copyFrom(this._currentColor1),e._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(e._currentSizeGradient=this._currentSizeGradient,e._currentSize1=this._currentSize1,e._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(e._currentAngularSpeedGradient=this._currentAngularSpeedGradient,e._currentAngularSpeed1=this._currentAngularSpeed1,e._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(e._currentVelocityGradient=this._currentVelocityGradient,e._currentVelocity1=this._currentVelocity1,e._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(e._currentLimitVelocityGradient=this._currentLimitVelocityGradient,e._currentLimitVelocity1=this._currentLimitVelocity1,e._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(e._currentDragGradient=this._currentDragGradient,e._currentDrag1=this._currentDrag1,e._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(e._initialStartSpriteCellID=this._initialStartSpriteCellID,e._initialEndSpriteCellID=this._initialEndSpriteCellID,e._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(e.remapData&&this.remapData?e.remapData.copyFrom(this.remapData):e.remapData=new Tt(0,0,0,0)),this._randomNoiseCoordinates1&&(e._randomNoiseCoordinates1?(e._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),e._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(e._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),e._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))}}Au._Count=0;var Ru;(function(o){o[o.ATTACHED=0]="ATTACHED",o[o.END=1]="END"})(Ru||(Ru={}));class yl{constructor(e){if(this.particleSystem=e,this.type=Ru.END,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!e.emitter||!e.emitter.dispose){const t=Xr("BABYLON.AbstractMesh");e.emitter=new t("SubemitterSystemEmitter",e.getScene()),e._disposeEmitterOnDispose=!0}}clone(){let e=this.particleSystem.emitter;if(!e)e=new x;else if(e instanceof x)e=e.clone();else if(e.getClassName().indexOf("Mesh")!==-1){const i=Xr("BABYLON.Mesh");e=new i("",e.getScene()),e.isVisible=!1}const t=new yl(this.particleSystem.clone(this.particleSystem.name,e));return t.particleSystem.name+="Clone",t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem._disposeEmitterOnDispose=!0,t.particleSystem.disposeOnStop=!0,t}serialize(e=!1){const t={};return t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem=this.particleSystem.serialize(e),t}static _ParseParticleSystem(e,t,i,r=!1){throw pt("ParseParticle")}static Parse(e,t,i){const r=e.particleSystem,s=new yl(yl._ParseParticleSystem(r,t,i,!0));return s.type=e.type,s.inheritDirection=e.inheritDirection,s.inheritedVelocityAmount=e.inheritedVelocityAmount,s.particleSystem._isSubEmitter=!0,s}dispose(){this.particleSystem.dispose()}}const K1="particlesPixelShader",q1=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
varying vec2 vUV;
varying vec4 vColor;
uniform vec4 textureMask;
uniform sampler2D diffuseSampler;
#include<clipPlaneFragmentDeclaration>
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
uniform sampler2D rampSampler;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec4 textureColor=texture2D(diffuseSampler,vUV);
vec4 baseColor=(textureColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;
#ifdef RAMPGRADIENT
float alpha=baseColor.a;
float remappedColorIndex=clamp((alpha-remapRanges.x)/remapRanges.y,0.0,1.0);
vec4 rampColor=texture2D(rampSampler,vec2(1.0-remappedColorIndex,0.));
baseColor.rgb*=rampColor.rgb;
float finalAlpha=baseColor.a;
baseColor.a=clamp((alpha*rampColor.a-remapRanges.z)/remapRanges.w,0.0,1.0);
#endif
#ifdef BLENDMULTIPLYMODE
float sourceAlpha=vColor.a*textureColor.a;
baseColor.rgb=baseColor.rgb*sourceAlpha+vec3(1.0)*(1.0-sourceAlpha);
#endif
#include<logDepthFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
baseColor.rgb=toLinearSpace(baseColor.rgb);
#else
#ifdef IMAGEPROCESSING
baseColor.rgb=toLinearSpace(baseColor.rgb);
baseColor=applyImageProcessing(baseColor);
#endif
#endif
gl_FragColor=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;te.ShadersStore[K1]=q1;const Q1="particlesVertexShader",Z1=`attribute vec3 position;
attribute vec4 color;
attribute float angle;
attribute vec2 size;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
#ifndef BILLBOARD
attribute vec3 direction;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
#ifdef RAMPGRADIENT
attribute vec4 remapData;
#endif
attribute vec2 offset;
uniform mat4 view;
uniform mat4 projection;
uniform vec2 translationPivot;
#ifdef ANIMATESHEET
uniform vec3 particlesInfos; 
#endif
varying vec2 vUV;
varying vec4 vColor;
varying vec3 vPositionW;
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
#endif
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration>
#include<logDepthDeclaration>
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {
vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));
vec3 zaxis=normalize(cross(yaxis,xaxis));
vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);
vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);
vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);
mat3 rotMatrix= mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
return position+alignedCorner;
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {
vec3 normalizedToCamera=normalize(toCamera);
vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));
vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);
vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
#ifdef BILLBOARDSTRETCHED_LOCAL
vec3 row1=direction;
#else
vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));
vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);
#endif
mat3 rotMatrix= mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
return position+alignedCorner;
}
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec2 cornerPos;
cornerPos=(vec2(offset.x-0.5,offset.y -0.5)-translationPivot)*size+translationPivot;
#ifdef BILLBOARD
vec3 rotatedCorner;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=position-eyePosition;
yaxis.y=0.;
vPositionW=rotate(normalize(yaxis),rotatedCorner);
vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 toCamera=position-eyePosition;
vPositionW=rotateAlign(toCamera,rotatedCorner);
vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 viewPos=(view*vec4(position,1.0)).xyz+rotatedCorner;
vPositionW=(invView*vec4(viewPos,1)).xyz;
#endif
#ifdef RAMPGRADIENT
remapRanges=remapData;
#endif
gl_Position=projection*vec4(viewPos,1.0);
#else
vec3 rotatedCorner;
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=normalize(direction);
vPositionW=rotate(yaxis,rotatedCorner);
gl_Position=projection*view*vec4(vPositionW,1.0);
#endif
vColor=color;
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex*particlesInfos.z);
float columnOffset=cellIndex-rowOffset/particlesInfos.z;
vec2 uvScale=particlesInfos.xy;
vec2 uvOffset=vec2(offset.x ,1.0-offset.y);
vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=offset;
#endif
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;te.ShadersStore[Q1]=Z1;class It extends Ya{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get useRampGradients(){return this._useRampGradients}set useRampGradients(e){this._useRampGradients!==e&&(this._useRampGradients=e,this._resetEffect())}get particles(){return this._particles}getActiveCount(){return this._particles.length}getClassName(){return"ParticleSystem"}isStopping(){return this._stopped&&this.isAlive()}getCustomEffect(e=0){var t,i;return(i=(t=this._customWrappers[e])===null||t===void 0?void 0:t.effect)!==null&&i!==void 0?i:this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){var t;return(t=this._customWrappers[e])!==null&&t!==void 0?t:this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new vs(this._engine),this._customWrappers[t].effect=e,this._customWrappers[t].drawContext&&(this._customWrappers[t].drawContext.useInstancing=this._useInstancing)}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new Q),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"particles"}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}constructor(e,t,i,r=null,s=!1,n=.01){super(e),this._emitterInverseWorldMatrix=H.Identity(),this._inheritedVelocityOffset=new x,this.onDisposeObservable=new Q,this.onStoppedObservable=new Q,this._particles=new Array,this._stockParticles=new Array,this._newPartsExcess=0,this._vertexBuffers={},this._scaledColorStep=new Ye(0,0,0,0),this._colorDiff=new Ye(0,0,0,0),this._scaledDirection=x.Zero(),this._scaledGravity=x.Zero(),this._currentRenderId=-1,this._useInstancing=!1,this._started=!1,this._stopped=!1,this._actualFrame=0,this._currentEmitRate1=0,this._currentEmitRate2=0,this._currentStartSize1=0,this._currentStartSize2=0,this.updateInAnimate=!0,this._rawTextureWidth=256,this._useRampGradients=!1,this._disposeEmitterOnDispose=!1,this.isLocal=!1,this.isGPU=!1,this._onBeforeDrawParticlesObservable=null,this.recycleParticle=l=>{const c=this._particles.pop();c!==l&&c.copyTo(l),this._stockParticles.push(c)},this._createParticle=()=>{let l;if(this._stockParticles.length!==0?(l=this._stockParticles.pop(),l._reset()):l=new Au(this),this._subEmitters&&this._subEmitters.length>0){const c=this._subEmitters[Math.floor(Math.random()*this._subEmitters.length)];l._attachedSubEmitters=[],c.forEach(h=>{if(h.type===Ru.ATTACHED){const u=h.clone();l._attachedSubEmitters.push(u),u.particleSystem.start()}})}return l},this._emitFromParticle=l=>{if(!this._subEmitters||this._subEmitters.length===0)return;const c=Math.floor(Math.random()*this._subEmitters.length);this._subEmitters[c].forEach(h=>{if(h.type===Ru.END){const u=h.clone();l._inheritParticleInfoToSubEmitter(u),u.particleSystem._rootParticleSystem=this,this.activeSubSystems.push(u.particleSystem),u.particleSystem.start()}})},this._capacity=t,this._epsilon=n,this._isAnimationSheetEnabled=s,!i||i.getClassName()==="Scene"?(this._scene=i||qe.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)):(this._engine=i,this.defaultProjectionMatrix=H.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._attachImageProcessingConfiguration(null),this._customWrappers={0:new vs(this._engine)},this._customWrappers[0].effect=r,this._drawWrappers=[],this._useInstancing=this._engine.getCaps().instancedArrays,this._createIndexBuffer(),this._createVertexBuffers(),this.particleEmitterType=new sc;let a=null;this.updateFunction=l=>{var c;let h=null;this.noiseTexture&&(h=this.noiseTexture.getSize(),(c=this.noiseTexture.getContent())===null||c===void 0||c.then(u=>{a=u}));for(let u=0;u<l.length;u++){const d=l[u];let f=this._scaledUpdateSpeed;const _=d.age;if(d.age+=f,d.age>d.lifeTime){const T=d.age-_;f=(d.lifeTime-_)*f/T,d.age=d.lifeTime}const p=d.age/d.lifeTime;this._colorGradients&&this._colorGradients.length>0?Hn.GetCurrentGradient(p,this._colorGradients,(T,b,y)=>{T!==d._currentColorGradient&&(d._currentColor1.copyFrom(d._currentColor2),b.getColorToRef(d._currentColor2),d._currentColorGradient=T),Ye.LerpToRef(d._currentColor1,d._currentColor2,y,d.color)}):(d.colorStep.scaleToRef(f,this._scaledColorStep),d.color.addInPlace(this._scaledColorStep),d.color.a<0&&(d.color.a=0)),this._angularSpeedGradients&&this._angularSpeedGradients.length>0&&Hn.GetCurrentGradient(p,this._angularSpeedGradients,(T,b,y)=>{T!==d._currentAngularSpeedGradient&&(d._currentAngularSpeed1=d._currentAngularSpeed2,d._currentAngularSpeed2=b.getFactor(),d._currentAngularSpeedGradient=T),d.angularSpeed=Ee.Lerp(d._currentAngularSpeed1,d._currentAngularSpeed2,y)}),d.angle+=d.angularSpeed*f;let m=f;if(this._velocityGradients&&this._velocityGradients.length>0&&Hn.GetCurrentGradient(p,this._velocityGradients,(T,b,y)=>{T!==d._currentVelocityGradient&&(d._currentVelocity1=d._currentVelocity2,d._currentVelocity2=b.getFactor(),d._currentVelocityGradient=T),m*=Ee.Lerp(d._currentVelocity1,d._currentVelocity2,y)}),d.direction.scaleToRef(m,this._scaledDirection),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&Hn.GetCurrentGradient(p,this._limitVelocityGradients,(T,b,y)=>{T!==d._currentLimitVelocityGradient&&(d._currentLimitVelocity1=d._currentLimitVelocity2,d._currentLimitVelocity2=b.getFactor(),d._currentLimitVelocityGradient=T);const S=Ee.Lerp(d._currentLimitVelocity1,d._currentLimitVelocity2,y);d.direction.length()>S&&d.direction.scaleInPlace(this.limitVelocityDamping)}),this._dragGradients&&this._dragGradients.length>0&&Hn.GetCurrentGradient(p,this._dragGradients,(T,b,y)=>{T!==d._currentDragGradient&&(d._currentDrag1=d._currentDrag2,d._currentDrag2=b.getFactor(),d._currentDragGradient=T);const S=Ee.Lerp(d._currentDrag1,d._currentDrag2,y);this._scaledDirection.scaleInPlace(1-S)}),this.isLocal&&d._localPosition?(d._localPosition.addInPlace(this._scaledDirection),x.TransformCoordinatesToRef(d._localPosition,this._emitterWorldMatrix,d.position)):d.position.addInPlace(this._scaledDirection),a&&h&&d._randomNoiseCoordinates1){const T=this._fetchR(d._randomNoiseCoordinates1.x,d._randomNoiseCoordinates1.y,h.width,h.height,a),b=this._fetchR(d._randomNoiseCoordinates1.z,d._randomNoiseCoordinates2.x,h.width,h.height,a),y=this._fetchR(d._randomNoiseCoordinates2.y,d._randomNoiseCoordinates2.z,h.width,h.height,a),S=j.Vector3[0],C=j.Vector3[1];S.copyFromFloats((2*T-1)*this.noiseStrength.x,(2*b-1)*this.noiseStrength.y,(2*y-1)*this.noiseStrength.z),S.scaleToRef(f,C),d.direction.addInPlace(C)}if(this.gravity.scaleToRef(f,this._scaledGravity),d.direction.addInPlace(this._scaledGravity),this._sizeGradients&&this._sizeGradients.length>0&&Hn.GetCurrentGradient(p,this._sizeGradients,(T,b,y)=>{T!==d._currentSizeGradient&&(d._currentSize1=d._currentSize2,d._currentSize2=b.getFactor(),d._currentSizeGradient=T),d.size=Ee.Lerp(d._currentSize1,d._currentSize2,y)}),this._useRampGradients&&(this._colorRemapGradients&&this._colorRemapGradients.length>0&&Hn.GetCurrentGradient(p,this._colorRemapGradients,(T,b,y)=>{const S=Ee.Lerp(T.factor1,b.factor1,y),C=Ee.Lerp(T.factor2,b.factor2,y);d.remapData.x=S,d.remapData.y=C-S}),this._alphaRemapGradients&&this._alphaRemapGradients.length>0&&Hn.GetCurrentGradient(p,this._alphaRemapGradients,(T,b,y)=>{const S=Ee.Lerp(T.factor1,b.factor1,y),C=Ee.Lerp(T.factor2,b.factor2,y);d.remapData.z=S,d.remapData.w=C-S})),this._isAnimationSheetEnabled&&d.updateCellIndex(),d._inheritParticleInfoToSubEmitters(),d.age>=d.lifeTime){this._emitFromParticle(d),d._attachedSubEmitters&&(d._attachedSubEmitters.forEach(T=>{T.particleSystem.disposeOnStop=!0,T.particleSystem.stop()}),d._attachedSubEmitters=null),this.recycleParticle(d),u--;continue}}}}_addFactorGradient(e,t,i,r){const s=new OE(t,i,r);e.push(s),e.sort((n,a)=>n.gradient<a.gradient?-1:n.gradient>a.gradient?1:0)}_removeFactorGradient(e,t){if(!e)return;let i=0;for(const r of e){if(r.gradient===t){e.splice(i,1);break}i++}}addLifeTimeGradient(e,t,i){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,e,t,i),this}removeLifeTimeGradient(e){return this._removeFactorGradient(this._lifeTimeGradients,e),this}addSizeGradient(e,t,i){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t,i),this}removeSizeGradient(e){return this._removeFactorGradient(this._sizeGradients,e),this}addColorRemapGradient(e,t,i){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,e,t,i),this}removeColorRemapGradient(e){return this._removeFactorGradient(this._colorRemapGradients,e),this}addAlphaRemapGradient(e,t,i){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,e,t,i),this}removeAlphaRemapGradient(e){return this._removeFactorGradient(this._alphaRemapGradients,e),this}addAngularSpeedGradient(e,t,i){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t,i),this}removeAngularSpeedGradient(e){return this._removeFactorGradient(this._angularSpeedGradients,e),this}addVelocityGradient(e,t,i){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t,i),this}removeVelocityGradient(e){return this._removeFactorGradient(this._velocityGradients,e),this}addLimitVelocityGradient(e,t,i){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t,i),this}removeLimitVelocityGradient(e){return this._removeFactorGradient(this._limitVelocityGradients,e),this}addDragGradient(e,t,i){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t,i),this}removeDragGradient(e){return this._removeFactorGradient(this._dragGradients,e),this}addEmitRateGradient(e,t,i){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,e,t,i),this}removeEmitRateGradient(e){return this._removeFactorGradient(this._emitRateGradients,e),this}addStartSizeGradient(e,t,i){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,e,t,i),this}removeStartSizeGradient(e){return this._removeFactorGradient(this._startSizeGradients,e),this}_createRampGradientTexture(){if(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)return;const e=new Uint8Array(this._rawTextureWidth*4),t=Jt.Color3[0];for(let i=0;i<this._rawTextureWidth;i++){const r=i/this._rawTextureWidth;Hn.GetCurrentGradient(r,this._rampGradients,(s,n,a)=>{ge.LerpToRef(s.color,n.color,a,t),e[i*4]=t.r*255,e[i*4+1]=t.g*255,e[i*4+2]=t.b*255,e[i*4+3]=255})}this._rampGradientsTexture=an.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}getRampGradients(){return this._rampGradients}forceRefreshGradients(){this._syncRampGradientTexture()}_syncRampGradientTexture(){this._rampGradients&&(this._rampGradients.sort((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())}addRampGradient(e,t){this._rampGradients||(this._rampGradients=[]);const i=new j1(e,t);return this._rampGradients.push(i),this._syncRampGradientTexture(),this}removeRampGradient(e){return this._removeGradientAndTexture(e,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this}addColorGradient(e,t,i){this._colorGradients||(this._colorGradients=[]);const r=new ME(e,t,i);return this._colorGradients.push(r),this._colorGradients.sort((s,n)=>s.gradient<n.gradient?-1:s.gradient>n.gradient?1:0),this}removeColorGradient(e){if(!this._colorGradients)return this;let t=0;for(const i of this._colorGradients){if(i.gradient===e){this._colorGradients.splice(t,1);break}t++}return this}resetDrawCache(){for(const e of this._drawWrappers)if(e)for(const t of e)t==null||t.dispose();this._drawWrappers=[]}_fetchR(e,t,i,r,s){e=Math.abs(e)*.5+.5,t=Math.abs(t)*.5+.5;const n=e*i%i|0,a=t*r%r|0,l=(n+a*i)*4;return s[l]/255}_reset(){this._resetEffect()}_resetEffect(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()}_createVertexBuffers(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),(!this._isBillboardBased||this.billboardMode===It.BILLBOARDMODE_STRETCHED||this.billboardMode===It.BILLBOARDMODE_STRETCHED_LOCAL)&&(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);const e=this._engine,t=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*t),this._vertexBuffer=new Xa(e,this._vertexData,!0,t);let i=0;const r=this._vertexBuffer.createVertexBuffer(O.PositionKind,i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[O.PositionKind]=r,i+=3;const s=this._vertexBuffer.createVertexBuffer(O.ColorKind,i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[O.ColorKind]=s,i+=4;const n=this._vertexBuffer.createVertexBuffer("angle",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=n,i+=1;const a=this._vertexBuffer.createVertexBuffer("size",i,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=a,i+=2,this._isAnimationSheetEnabled){const c=this._vertexBuffer.createVertexBuffer("cellIndex",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=c,i+=1}if(!this._isBillboardBased||this.billboardMode===It.BILLBOARDMODE_STRETCHED||this.billboardMode===It.BILLBOARDMODE_STRETCHED_LOCAL){const c=this._vertexBuffer.createVertexBuffer("direction",i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=c,i+=3}if(this._useRampGradients){const c=this._vertexBuffer.createVertexBuffer("remapData",i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=c,i+=4}let l;if(this._useInstancing){const c=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new Xa(e,c,!1,2),l=this._spriteBuffer.createVertexBuffer("offset",0,2)}else l=this._vertexBuffer.createVertexBuffer("offset",i,2,this._vertexBufferSize,this._useInstancing),i+=2;this._vertexBuffers.offset=l,this.resetDrawCache()}_createIndexBuffer(){if(this._useInstancing)return;const e=[];let t=0;for(let i=0;i<this._capacity;i++)e.push(t),e.push(t+1),e.push(t+2),e.push(t),e.push(t+2),e.push(t+3),t+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}getCapacity(){return this._capacity}isAlive(){return this._alive}isStarted(){return this._started}_prepareSubEmitterInternalArray(){this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach(e=>{e instanceof It?this._subEmitters.push([new yl(e)]):e instanceof yl?this._subEmitters.push([e]):e instanceof Array&&this._subEmitters.push(e)})}start(e=this.startDelay){var t;if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(()=>{this.start(0)},e);return}if(this._prepareSubEmitterInternalArray(),this._started=!0,this._stopped=!1,this._actualFrame=0,this._subEmitters&&this._subEmitters.length!=0&&(this.activeSubSystems=new Array),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){((t=this.emitter)===null||t===void 0?void 0:t.getClassName().indexOf("Mesh"))!==-1&&this.emitter.computeWorldMatrix(!0);const i=this.noiseTexture;if(i&&i.onGeneratedObservable)i.onGeneratedObservable.addOnce(()=>{setTimeout(()=>{for(let r=0;r<this.preWarmCycles;r++)this.animate(!0),i.render()})});else for(let r=0;r<this.preWarmCycles;r++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}stop(e=!0){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,e&&this._stopSubEmitters())}reset(){this._stockParticles.length=0,this._particles.length=0}_appendParticleVertex(e,t,i,r){let s=e*this._vertexBufferSize;if(this._vertexData[s++]=t.position.x+this.worldOffset.x,this._vertexData[s++]=t.position.y+this.worldOffset.y,this._vertexData[s++]=t.position.z+this.worldOffset.z,this._vertexData[s++]=t.color.r,this._vertexData[s++]=t.color.g,this._vertexData[s++]=t.color.b,this._vertexData[s++]=t.color.a,this._vertexData[s++]=t.angle,this._vertexData[s++]=t.scale.x*t.size,this._vertexData[s++]=t.scale.y*t.size,this._isAnimationSheetEnabled&&(this._vertexData[s++]=t.cellIndex),this._isBillboardBased)(this.billboardMode===It.BILLBOARDMODE_STRETCHED||this.billboardMode===It.BILLBOARDMODE_STRETCHED_LOCAL)&&(this._vertexData[s++]=t.direction.x,this._vertexData[s++]=t.direction.y,this._vertexData[s++]=t.direction.z);else if(t._initialDirection){let n=t._initialDirection;this.isLocal&&(x.TransformNormalToRef(n,this._emitterWorldMatrix,j.Vector3[0]),n=j.Vector3[0]),n.x===0&&n.z===0&&(n.x=.001),this._vertexData[s++]=n.x,this._vertexData[s++]=n.y,this._vertexData[s++]=n.z}else{let n=t.direction;this.isLocal&&(x.TransformNormalToRef(n,this._emitterWorldMatrix,j.Vector3[0]),n=j.Vector3[0]),n.x===0&&n.z===0&&(n.x=.001),this._vertexData[s++]=n.x,this._vertexData[s++]=n.y,this._vertexData[s++]=n.z}this._useRampGradients&&t.remapData&&(this._vertexData[s++]=t.remapData.x,this._vertexData[s++]=t.remapData.y,this._vertexData[s++]=t.remapData.z,this._vertexData[s++]=t.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(i===0?i=this._epsilon:i===1&&(i=1-this._epsilon),r===0?r=this._epsilon:r===1&&(r=1-this._epsilon)),this._vertexData[s++]=i,this._vertexData[s++]=r)}_stopSubEmitters(){this.activeSubSystems&&(this.activeSubSystems.forEach(e=>{e.stop(!0)}),this.activeSubSystems=new Array)}_removeFromRoot(){if(!this._rootParticleSystem)return;const e=this._rootParticleSystem.activeSubSystems.indexOf(this);e!==-1&&this._rootParticleSystem.activeSubSystems.splice(e,1),this._rootParticleSystem=null}_update(e){if(this._alive=this._particles.length>0,this.emitter.position){const i=this.emitter;this._emitterWorldMatrix=i.getWorldMatrix()}else{const i=this.emitter;this._emitterWorldMatrix=H.Translation(i.x,i.y,i.z)}this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles);let t;for(let i=0;i<e&&this._particles.length!==this._capacity;i++){if(t=this._createParticle(),this._particles.push(t),this.targetStopDuration&&this._lifeTimeGradients&&this._lifeTimeGradients.length>0){const s=Ee.Clamp(this._actualFrame/this.targetStopDuration);Hn.GetCurrentGradient(s,this._lifeTimeGradients,(n,a)=>{const l=n,c=a,h=l.getFactor(),u=c.getFactor(),d=(s-l.gradient)/(c.gradient-l.gradient);t.lifeTime=Ee.Lerp(h,u,d)})}else t.lifeTime=Ee.RandomRange(this.minLifeTime,this.maxLifeTime);const r=Ee.RandomRange(this.minEmitPower,this.maxEmitPower);if(this.startPositionFunction?this.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal):this.particleEmitterType.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal),this.isLocal&&(t._localPosition?t._localPosition.copyFrom(t.position):t._localPosition=t.position.clone(),x.TransformCoordinatesToRef(t._localPosition,this._emitterWorldMatrix,t.position)),this.startDirectionFunction?this.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal):this.particleEmitterType.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal,this._emitterInverseWorldMatrix),r===0?t._initialDirection?t._initialDirection.copyFrom(t.direction):t._initialDirection=t.direction.clone():t._initialDirection=null,t.direction.scaleInPlace(r),!this._sizeGradients||this._sizeGradients.length===0?t.size=Ee.RandomRange(this.minSize,this.maxSize):(t._currentSizeGradient=this._sizeGradients[0],t._currentSize1=t._currentSizeGradient.getFactor(),t.size=t._currentSize1,this._sizeGradients.length>1?t._currentSize2=this._sizeGradients[1].getFactor():t._currentSize2=t._currentSize1),t.scale.copyFromFloats(Ee.RandomRange(this.minScaleX,this.maxScaleX),Ee.RandomRange(this.minScaleY,this.maxScaleY)),this._startSizeGradients&&this._startSizeGradients[0]&&this.targetStopDuration){const s=this._actualFrame/this.targetStopDuration;Hn.GetCurrentGradient(s,this._startSizeGradients,(n,a,l)=>{n!==this._currentStartSizeGradient&&(this._currentStartSize1=this._currentStartSize2,this._currentStartSize2=a.getFactor(),this._currentStartSizeGradient=n);const c=Ee.Lerp(this._currentStartSize1,this._currentStartSize2,l);t.scale.scaleInPlace(c)})}if(!this._angularSpeedGradients||this._angularSpeedGradients.length===0?t.angularSpeed=Ee.RandomRange(this.minAngularSpeed,this.maxAngularSpeed):(t._currentAngularSpeedGradient=this._angularSpeedGradients[0],t.angularSpeed=t._currentAngularSpeedGradient.getFactor(),t._currentAngularSpeed1=t.angularSpeed,this._angularSpeedGradients.length>1?t._currentAngularSpeed2=this._angularSpeedGradients[1].getFactor():t._currentAngularSpeed2=t._currentAngularSpeed1),t.angle=Ee.RandomRange(this.minInitialRotation,this.maxInitialRotation),this._velocityGradients&&this._velocityGradients.length>0&&(t._currentVelocityGradient=this._velocityGradients[0],t._currentVelocity1=t._currentVelocityGradient.getFactor(),this._velocityGradients.length>1?t._currentVelocity2=this._velocityGradients[1].getFactor():t._currentVelocity2=t._currentVelocity1),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&(t._currentLimitVelocityGradient=this._limitVelocityGradients[0],t._currentLimitVelocity1=t._currentLimitVelocityGradient.getFactor(),this._limitVelocityGradients.length>1?t._currentLimitVelocity2=this._limitVelocityGradients[1].getFactor():t._currentLimitVelocity2=t._currentLimitVelocity1),this._dragGradients&&this._dragGradients.length>0&&(t._currentDragGradient=this._dragGradients[0],t._currentDrag1=t._currentDragGradient.getFactor(),this._dragGradients.length>1?t._currentDrag2=this._dragGradients[1].getFactor():t._currentDrag2=t._currentDrag1),!this._colorGradients||this._colorGradients.length===0){const s=Ee.RandomRange(0,1);Ye.LerpToRef(this.color1,this.color2,s,t.color),this.colorDead.subtractToRef(t.color,this._colorDiff),this._colorDiff.scaleToRef(1/t.lifeTime,t.colorStep)}else t._currentColorGradient=this._colorGradients[0],t._currentColorGradient.getColorToRef(t.color),t._currentColor1.copyFrom(t.color),this._colorGradients.length>1?this._colorGradients[1].getColorToRef(t._currentColor2):t._currentColor2.copyFrom(t.color);this._isAnimationSheetEnabled&&(t._initialStartSpriteCellID=this.startSpriteCellID,t._initialEndSpriteCellID=this.endSpriteCellID,t._initialSpriteCellLoop=this.spriteCellLoop),t.direction.addInPlace(this._inheritedVelocityOffset),this._useRampGradients&&(t.remapData=new Tt(0,1,0,1)),this.noiseTexture&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(t._randomNoiseCoordinates1=new x(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2=new x(Math.random(),Math.random(),Math.random()))),t._inheritParticleInfoToSubEmitters()}}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1){const r=[O.PositionKind,O.ColorKind,"angle","offset","size"];return e&&r.push("cellIndex"),t||r.push("direction"),i&&r.push("remapData"),r}static _GetEffectCreationOptions(e=!1,t=!1){const i=["invView","view","projection","textureMask","translationPivot","eyePosition"];return ja(i),e&&i.push("particlesInfos"),t&&i.push("logarithmicDepthConstant"),i}fillDefines(e,t){if(this._scene&&Zo(this,this._scene,e),this._isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),t===It.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&e.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case It.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case It.BILLBOARDMODE_STRETCHED:case It.BILLBOARDMODE_STRETCHED_LOCAL:e.push("#define BILLBOARDSTRETCHED"),this.billboardMode===It.BILLBOARDMODE_STRETCHED_LOCAL&&e.push("#define BILLBOARDSTRETCHED_LOCAL");break;case It.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL");break}this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...It._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==It.BILLBOARDMODE_STRETCHED&&this.billboardMode!==It.BILLBOARDMODE_STRETCHED_LOCAL,this._useRampGradients)),e.push(...It._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth)),i.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(wt.PrepareUniforms(e,this._imageProcessingConfigurationDefines),wt.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}_getWrapper(e){const t=this._getCustomDrawWrapper(e);if(t!=null&&t.effect)return t;const i=[];this.fillDefines(i,e);const r=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0;let s=this._drawWrappers[r];s||(s=this._drawWrappers[r]=[]);let n=s[e];n||(n=new vs(this._engine),n.drawContext&&(n.drawContext.useInstancing=this._useInstancing),s[e]=n);const a=i.join(`
`);if(n.defines!==a){const l=[],c=[],h=[];this.fillUniformsAttributesAndSamplerNames(c,l,h),n.setEffect(this._engine.createEffect("particles",l,c,h,a),a)}return n}animate(e=!1){var t;if(!this._started)return;if(!e&&this._scene){if(!this.isReady()||this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}this._scaledUpdateSpeed=this.updateSpeed*(e?this.preWarmStepOffset:((t=this._scene)===null||t===void 0?void 0:t.getAnimationRatio())||1);let i;if(this.manualEmitCount>-1)i=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{let r=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){const s=this._actualFrame/this.targetStopDuration;Hn.GetCurrentGradient(s,this._emitRateGradients,(n,a,l)=>{n!==this._currentEmitRateGradient&&(this._currentEmitRate1=this._currentEmitRate2,this._currentEmitRate2=a.getFactor(),this._currentEmitRateGradient=n),r=Ee.Lerp(this._currentEmitRate1,this._currentEmitRate2,l)})}i=r*this._scaledUpdateSpeed>>0,this._newPartsExcess+=r*this._scaledUpdateSpeed-i}if(this._newPartsExcess>1&&(i+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?i=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(i),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!e){let r=0;for(let s=0;s<this._particles.length;s++){const n=this._particles[s];this._appendParticleVertices(r,n),r+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}this.manualEmitCount===0&&this.disposeOnStop&&this.stop()}_appendParticleVertices(e,t){this._appendParticleVertex(e++,t,0,0),this._useInstancing||(this._appendParticleVertex(e++,t,1,0),this._appendParticleVertex(e++,t,1,1),this._appendParticleVertex(e++,t,0,1))}rebuild(){var e,t;this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),(e=this._spriteBuffer)===null||e===void 0||e._rebuild(),(t=this._vertexBuffer)===null||t===void 0||t._rebuild();for(const i in this._vertexBuffers)this._vertexBuffers[i]._rebuild();this.resetDrawCache()}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==It.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(It.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(It.BLENDMODE_ADD).effect.isReady())return!1;return!0}_render(e){var t,i;const r=this._getWrapper(e),s=r.effect,n=this._engine;n.enableEffect(r);const a=(t=this.defaultViewMatrix)!==null&&t!==void 0?t:this._scene.getViewMatrix();if(s.setTexture("diffuseSampler",this.particleTexture),s.setMatrix("view",a),s.setMatrix("projection",(i=this.defaultProjectionMatrix)!==null&&i!==void 0?i:this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){const c=this.particleTexture.getBaseSize();s.setFloat3("particlesInfos",this.spriteCellWidth/c.width,this.spriteCellHeight/c.height,this.spriteCellWidth/c.width)}if(s.setVector2("translationPivot",this.translationPivot),s.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){const c=this._scene.activeCamera;s.setVector3("eyePosition",c.globalPosition)}this._rampGradientsTexture&&((!this._rampGradients||!this._rampGradients.length)&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),s.setTexture("rampSampler",this._rampGradientsTexture));const l=s.defines;switch(this._scene&&Ra(s,this,this._scene),l.indexOf("#define BILLBOARDMODE_ALL")>=0&&(a.invertToRef(j.Matrix[0]),s.setMatrix("invView",j.Matrix[0])),this._vertexArrayObject!==void 0?(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,s)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):n.bindBuffers(this._vertexBuffers,this._indexBuffer,s),this.useLogarithmicDepth&&this._scene&&Ce.BindLogDepth(l,s,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(s),e){case It.BLENDMODE_ADD:n.setAlphaMode(1);break;case It.BLENDMODE_ONEONE:n.setAlphaMode(6);break;case It.BLENDMODE_STANDARD:n.setAlphaMode(2);break;case It.BLENDMODE_MULTIPLY:n.setAlphaMode(4);break}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(s),this._useInstancing?n.drawArraysType(7,0,4,this._particles.length):n.drawElementsType(0,0,this._particles.length*6),this._particles.length}render(){if(!this.isReady()||!this._particles.length)return 0;const e=this._engine;e.setState&&(e.setState(!1),this.forceDepthWrite&&e.setDepthWrite(!0));let t=0;return this.blendMode===It.BLENDMODE_MULTIPLYADD?t=this._render(It.BLENDMODE_MULTIPLY)+this._render(It.BLENDMODE_ADD):t=this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),t}dispose(e=!0){if(this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),this._subEmitters&&this._subEmitters.length){for(let t=0;t<this._subEmitters.length;t++)for(const i of this._subEmitters[t])i.dispose();this._subEmitters=[],this.subEmitters=[]}if(this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){const t=this._scene.particleSystems.indexOf(this);t>-1&&this._scene.particleSystems.splice(t,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()}clone(e,t,i=!1){const r={...this._customWrappers};let s=null;const n=this._engine;if(n.createEffectForParticles&&this.customShader!=null){s=this.customShader;const c=s.shaderOptions.defines.length>0?s.shaderOptions.defines.join(`
`):"",h=n.createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,c);r[0]?r[0].effect=h:this.setCustomEffect(h,0)}const a=this.serialize(i),l=It.Parse(a,this._scene||this._engine,this._rootUrl);return l.name=e,l.customShader=s,l._customWrappers=r,t===void 0&&(t=this.emitter),this.noiseTexture&&(l.noiseTexture=this.noiseTexture.clone()),l.emitter=t,this.preventAutoStart||l.start(),l}serialize(e=!1){const t={};if(It._Serialize(t,this,e),t.textureMask=this.textureMask.asArray(),t.customShader=this.customShader,t.preventAutoStart=this.preventAutoStart,this.subEmitters){t.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(const i of this._subEmitters){const r=[];for(const s of i)r.push(s.serialize(e));t.subEmitters.push(r)}}return t}static _Serialize(e,t,i){if(e.name=t.name,e.id=t.id,e.capacity=t.getCapacity(),e.disposeOnStop=t.disposeOnStop,e.manualEmitCount=t.manualEmitCount,t.emitter.position){const m=t.emitter;e.emitterId=m.id}else{const m=t.emitter;e.emitter=m.asArray()}t.particleEmitterType&&(e.particleEmitterType=t.particleEmitterType.serialize()),t.particleTexture&&(i?e.texture=t.particleTexture.serialize():(e.textureName=t.particleTexture.name,e.invertY=!!t.particleTexture._invertY)),e.isLocal=t.isLocal,ke.AppendSerializedAnimations(t,e),e.beginAnimationOnStart=t.beginAnimationOnStart,e.beginAnimationFrom=t.beginAnimationFrom,e.beginAnimationTo=t.beginAnimationTo,e.beginAnimationLoop=t.beginAnimationLoop,e.startDelay=t.startDelay,e.renderingGroupId=t.renderingGroupId,e.isBillboardBased=t.isBillboardBased,e.billboardMode=t.billboardMode,e.minAngularSpeed=t.minAngularSpeed,e.maxAngularSpeed=t.maxAngularSpeed,e.minSize=t.minSize,e.maxSize=t.maxSize,e.minScaleX=t.minScaleX,e.maxScaleX=t.maxScaleX,e.minScaleY=t.minScaleY,e.maxScaleY=t.maxScaleY,e.minEmitPower=t.minEmitPower,e.maxEmitPower=t.maxEmitPower,e.minLifeTime=t.minLifeTime,e.maxLifeTime=t.maxLifeTime,e.emitRate=t.emitRate,e.gravity=t.gravity.asArray(),e.noiseStrength=t.noiseStrength.asArray(),e.color1=t.color1.asArray(),e.color2=t.color2.asArray(),e.colorDead=t.colorDead.asArray(),e.updateSpeed=t.updateSpeed,e.targetStopDuration=t.targetStopDuration,e.blendMode=t.blendMode,e.preWarmCycles=t.preWarmCycles,e.preWarmStepOffset=t.preWarmStepOffset,e.minInitialRotation=t.minInitialRotation,e.maxInitialRotation=t.maxInitialRotation,e.startSpriteCellID=t.startSpriteCellID,e.spriteCellLoop=t.spriteCellLoop,e.endSpriteCellID=t.endSpriteCellID,e.spriteCellChangeSpeed=t.spriteCellChangeSpeed,e.spriteCellWidth=t.spriteCellWidth,e.spriteCellHeight=t.spriteCellHeight,e.spriteRandomStartCell=t.spriteRandomStartCell,e.isAnimationSheetEnabled=t.isAnimationSheetEnabled,e.useLogarithmicDepth=t.useLogarithmicDepth;const r=t.getColorGradients();if(r){e.colorGradients=[];for(const m of r){const T={gradient:m.gradient,color1:m.color1.asArray()};m.color2?T.color2=m.color2.asArray():T.color2=m.color1.asArray(),e.colorGradients.push(T)}}const s=t.getRampGradients();if(s){e.rampGradients=[];for(const m of s){const T={gradient:m.gradient,color:m.color.asArray()};e.rampGradients.push(T)}e.useRampGradients=t.useRampGradients}const n=t.getColorRemapGradients();if(n){e.colorRemapGradients=[];for(const m of n){const T={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?T.factor2=m.factor2:T.factor2=m.factor1,e.colorRemapGradients.push(T)}}const a=t.getAlphaRemapGradients();if(a){e.alphaRemapGradients=[];for(const m of a){const T={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?T.factor2=m.factor2:T.factor2=m.factor1,e.alphaRemapGradients.push(T)}}const l=t.getSizeGradients();if(l){e.sizeGradients=[];for(const m of l){const T={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?T.factor2=m.factor2:T.factor2=m.factor1,e.sizeGradients.push(T)}}const c=t.getAngularSpeedGradients();if(c){e.angularSpeedGradients=[];for(const m of c){const T={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?T.factor2=m.factor2:T.factor2=m.factor1,e.angularSpeedGradients.push(T)}}const h=t.getVelocityGradients();if(h){e.velocityGradients=[];for(const m of h){const T={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?T.factor2=m.factor2:T.factor2=m.factor1,e.velocityGradients.push(T)}}const u=t.getDragGradients();if(u){e.dragGradients=[];for(const m of u){const T={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?T.factor2=m.factor2:T.factor2=m.factor1,e.dragGradients.push(T)}}const d=t.getEmitRateGradients();if(d){e.emitRateGradients=[];for(const m of d){const T={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?T.factor2=m.factor2:T.factor2=m.factor1,e.emitRateGradients.push(T)}}const f=t.getStartSizeGradients();if(f){e.startSizeGradients=[];for(const m of f){const T={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?T.factor2=m.factor2:T.factor2=m.factor1,e.startSizeGradients.push(T)}}const _=t.getLifeTimeGradients();if(_){e.lifeTimeGradients=[];for(const m of _){const T={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?T.factor2=m.factor2:T.factor2=m.factor1,e.lifeTimeGradients.push(T)}}const p=t.getLimitVelocityGradients();if(p){e.limitVelocityGradients=[];for(const m of p){const T={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?T.factor2=m.factor2:T.factor2=m.factor1,e.limitVelocityGradients.push(T)}e.limitVelocityDamping=t.limitVelocityDamping}t.noiseTexture&&(e.noiseTexture=t.noiseTexture.serialize())}static _Parse(e,t,i,r){var s,n,a;let l;i instanceof ze?l=null:l=i;const c=Xr("BABYLON.Texture");if(c&&l&&(e.texture?t.particleTexture=c.Parse(e.texture,l,r):e.textureName&&(t.particleTexture=new c(r+e.textureName,l,!1,e.invertY!==void 0?e.invertY:!0),t.particleTexture.name=e.textureName)),!e.emitterId&&e.emitterId!==0&&e.emitter===void 0?t.emitter=x.Zero():e.emitterId&&l?t.emitter=l.getLastMeshById(e.emitterId):t.emitter=x.FromArray(e.emitter),t.isLocal=!!e.isLocal,e.renderingGroupId!==void 0&&(t.renderingGroupId=e.renderingGroupId),e.isBillboardBased!==void 0&&(t.isBillboardBased=e.isBillboardBased),e.billboardMode!==void 0&&(t.billboardMode=e.billboardMode),e.useLogarithmicDepth!==void 0&&(t.useLogarithmicDepth=e.useLogarithmicDepth),e.animations){for(let u=0;u<e.animations.length;u++){const d=e.animations[u],f=Xr("BABYLON.Animation");f&&t.animations.push(f.Parse(d))}t.beginAnimationOnStart=e.beginAnimationOnStart,t.beginAnimationFrom=e.beginAnimationFrom,t.beginAnimationTo=e.beginAnimationTo,t.beginAnimationLoop=e.beginAnimationLoop}if(e.autoAnimate&&l&&l.beginAnimation(t,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),t.startDelay=e.startDelay|0,t.minAngularSpeed=e.minAngularSpeed,t.maxAngularSpeed=e.maxAngularSpeed,t.minSize=e.minSize,t.maxSize=e.maxSize,e.minScaleX&&(t.minScaleX=e.minScaleX,t.maxScaleX=e.maxScaleX,t.minScaleY=e.minScaleY,t.maxScaleY=e.maxScaleY),e.preWarmCycles!==void 0&&(t.preWarmCycles=e.preWarmCycles,t.preWarmStepOffset=e.preWarmStepOffset),e.minInitialRotation!==void 0&&(t.minInitialRotation=e.minInitialRotation,t.maxInitialRotation=e.maxInitialRotation),t.minLifeTime=e.minLifeTime,t.maxLifeTime=e.maxLifeTime,t.minEmitPower=e.minEmitPower,t.maxEmitPower=e.maxEmitPower,t.emitRate=e.emitRate,t.gravity=x.FromArray(e.gravity),e.noiseStrength&&(t.noiseStrength=x.FromArray(e.noiseStrength)),t.color1=Ye.FromArray(e.color1),t.color2=Ye.FromArray(e.color2),t.colorDead=Ye.FromArray(e.colorDead),t.updateSpeed=e.updateSpeed,t.targetStopDuration=e.targetStopDuration,t.blendMode=e.blendMode,e.colorGradients)for(const u of e.colorGradients)t.addColorGradient(u.gradient,Ye.FromArray(u.color1),u.color2?Ye.FromArray(u.color2):void 0);if(e.rampGradients){for(const u of e.rampGradients)t.addRampGradient(u.gradient,ge.FromArray(u.color));t.useRampGradients=e.useRampGradients}if(e.colorRemapGradients)for(const u of e.colorRemapGradients)t.addColorRemapGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.alphaRemapGradients)for(const u of e.alphaRemapGradients)t.addAlphaRemapGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.sizeGradients)for(const u of e.sizeGradients)t.addSizeGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.angularSpeedGradients)for(const u of e.angularSpeedGradients)t.addAngularSpeedGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.velocityGradients)for(const u of e.velocityGradients)t.addVelocityGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.dragGradients)for(const u of e.dragGradients)t.addDragGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.emitRateGradients)for(const u of e.emitRateGradients)t.addEmitRateGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.startSizeGradients)for(const u of e.startSizeGradients)t.addStartSizeGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.lifeTimeGradients)for(const u of e.lifeTimeGradients)t.addLifeTimeGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.limitVelocityGradients){for(const u of e.limitVelocityGradients)t.addLimitVelocityGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);t.limitVelocityDamping=e.limitVelocityDamping}if(e.noiseTexture&&l){const u=Xr("BABYLON.ProceduralTexture");t.noiseTexture=u.Parse(e.noiseTexture,l,r)}let h;if(e.particleEmitterType){switch(e.particleEmitterType.type){case"SphereParticleEmitter":h=new Bu;break;case"SphereDirectedParticleEmitter":h=new xf;break;case"ConeEmitter":case"ConeParticleEmitter":h=new pf;break;case"CylinderParticleEmitter":h=new Lu;break;case"CylinderDirectedParticleEmitter":h=new mf;break;case"HemisphericParticleEmitter":h=new gf;break;case"PointParticleEmitter":h=new vf;break;case"MeshParticleEmitter":h=new cm;break;case"BoxEmitter":case"BoxParticleEmitter":default:h=new sc;break}h.parse(e.particleEmitterType,l)}else h=new sc,h.parse(e,l);t.particleEmitterType=h,t.startSpriteCellID=e.startSpriteCellID,t.endSpriteCellID=e.endSpriteCellID,t.spriteCellLoop=(s=e.spriteCellLoop)!==null&&s!==void 0?s:!0,t.spriteCellWidth=e.spriteCellWidth,t.spriteCellHeight=e.spriteCellHeight,t.spriteCellChangeSpeed=e.spriteCellChangeSpeed,t.spriteRandomStartCell=e.spriteRandomStartCell,t.disposeOnStop=(n=e.disposeOnStop)!==null&&n!==void 0?n:!1,t.manualEmitCount=(a=e.manualEmitCount)!==null&&a!==void 0?a:-1}static Parse(e,t,i,r=!1,s){const n=e.name;let a=null,l=null,c,h;if(t instanceof ze?c=t:(h=t,c=h.getEngine()),e.customShader&&c.createEffectForParticles){l=e.customShader;const d=l.shaderOptions.defines.length>0?l.shaderOptions.defines.join(`
`):"";a=c.createEffectForParticles(l.shaderPath.fragmentElement,l.shaderOptions.uniforms,l.shaderOptions.samplers,d)}const u=new It(n,s||e.capacity,t,a,e.isAnimationSheetEnabled);if(u.customShader=l,u._rootUrl=i,e.id&&(u.id=e.id),e.subEmitters){u.subEmitters=[];for(const d of e.subEmitters){const f=[];for(const _ of d)f.push(yl.Parse(_,t,i));u.subEmitters.push(f)}}return It._Parse(e,u,t,i),e.textureMask&&(u.textureMask=Ye.FromArray(e.textureMask)),e.preventAutoStart&&(u.preventAutoStart=e.preventAutoStart),!r&&!u.preventAutoStart&&u.start(),u}}It.BILLBOARDMODE_Y=2;It.BILLBOARDMODE_ALL=7;It.BILLBOARDMODE_STRETCHED=8;It.BILLBOARDMODE_STRETCHED_LOCAL=9;yl._ParseParticleSystem=It.Parse;const J1="clipPlaneFragmentDeclaration2",ew=`#ifdef CLIPPLANE
in float fClipDistance;
#endif
#ifdef CLIPPLANE2
in float fClipDistance2;
#endif
#ifdef CLIPPLANE3
in float fClipDistance3;
#endif
#ifdef CLIPPLANE4
in float fClipDistance4;
#endif
#ifdef CLIPPLANE5
in float fClipDistance5;
#endif
#ifdef CLIPPLANE6
in float fClipDistance6;
#endif
`;te.IncludesShadersStore[J1]=ew;const tw="gpuRenderParticlesPixelShader",iw=`precision highp float;
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform sampler2D diffuseSampler;
varying vec2 vUV;
varying vec4 vColor;
#include<clipPlaneFragmentDeclaration2> 
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
void main() {
#include<clipPlaneFragment> 
vec4 textureColor=texture2D(diffuseSampler,vUV);
gl_FragColor=textureColor*vColor;
#ifdef BLENDMULTIPLYMODE
float alpha=vColor.a*textureColor.a;
gl_FragColor.rgb=gl_FragColor.rgb*alpha+vec3(1.0)*(1.0-alpha);
#endif 
#include<logDepthFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);
#else
#ifdef IMAGEPROCESSING
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);
gl_FragColor=applyImageProcessing(gl_FragColor);
#endif
#endif
}
`;te.ShadersStore[tw]=iw;const rw="clipPlaneVertexDeclaration2",sw=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;
out float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;
out float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;
out float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;
out float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;
out float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;
out float fClipDistance6;
#endif
`;te.IncludesShadersStore[rw]=sw;const nw="gpuRenderParticlesVertexShader",aw=`precision highp float;
uniform mat4 view;
uniform mat4 projection;
uniform vec2 translationPivot;
uniform vec3 worldOffset;
#ifdef LOCAL
uniform mat4 emitterWM;
#endif
attribute vec3 position;
attribute float age;
attribute float life;
attribute vec3 size;
#ifndef BILLBOARD
attribute vec3 initialDirection;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
attribute float angle;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
attribute vec2 offset;
attribute vec2 uv;
varying vec2 vUV;
varying vec4 vColor;
varying vec3 vPositionW;
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration2>
#include<logDepthDeclaration>
#ifdef COLORGRADIENTS
uniform sampler2D colorGradientSampler;
#else
uniform vec4 colorDead;
attribute vec4 color;
#endif
#ifdef ANIMATESHEET
uniform vec3 sheetInfos;
#endif
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {
vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));
vec3 zaxis=normalize(cross(yaxis,xaxis));
vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);
vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);
vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);
mat3 rotMatrix= mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {
vec3 normalizedToCamera=normalize(toCamera);
vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));
vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));
vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);
vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);
vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
mat3 rotMatrix= mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#endif
void main() {
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex/sheetInfos.z);
float columnOffset=cellIndex-rowOffset*sheetInfos.z;
vec2 uvScale=sheetInfos.xy;
vec2 uvOffset=vec2(uv.x ,1.0-uv.y);
vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=uv;
#endif
float ratio=age/life;
#ifdef COLORGRADIENTS
vColor=texture2D(colorGradientSampler,vec2(ratio,0));
#else
vColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);
#endif
vec2 cornerPos=(offset-translationPivot)*size.yz*size.x+translationPivot;
#ifdef BILLBOARD
vec4 rotatedCorner;
rotatedCorner.w=0.;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=(position+worldOffset)-eyePosition;
yaxis.y=0.;
vPositionW=rotate(normalize(yaxis),rotatedCorner.xyz);
vec4 viewPosition=(view*vec4(vPositionW,1.0));
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 toCamera=(position+worldOffset)-eyePosition;
vPositionW=rotateAlign(toCamera,rotatedCorner.xyz);
vec4 viewPosition=(view*vec4(vPositionW,1.0));
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
#ifdef LOCAL
vec4 viewPosition=view*vec4(((emitterWM*vec4(position,1.0)).xyz+worldOffset),1.0)+rotatedCorner;
#else
vec4 viewPosition=view*vec4((position+worldOffset),1.0)+rotatedCorner;
#endif
vPositionW=(invView*viewPosition).xyz;
#endif
#else
vec3 rotatedCorner;
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=0.;
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
vec3 yaxis=normalize(initialDirection);
vPositionW=rotate(yaxis,rotatedCorner);
vec4 viewPosition=view*vec4(vPositionW,1.0);
#endif
gl_Position=projection*viewPosition;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<logDepthVertex>
}`;te.ShadersStore[nw]=aw;class Wc extends Ya{static get IsSupported(){if(!qe.LastCreatedEngine)return!1;const e=qe.LastCreatedEngine.getCaps();return e.supportTransformFeedbacks||e.supportComputeShaders}getCapacity(){return this._capacity}get activeParticleCount(){return this._activeCount}set activeParticleCount(e){this._activeCount=Math.min(e,this._capacity)}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==It.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(It.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(It.BLENDMODE_ADD).effect.isReady())return!1;return this._platform.isUpdateBufferCreated()?this._platform.isUpdateBufferReady():(this._recreateUpdateEffect(),!1)}isStarted(){return this._started}isStopped(){return this._stopped}isStopping(){return!1}getActiveCount(){return this._currentActiveCount}start(e=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(()=>{this.start(0)},e);return}this._started=!0,this._stopped=!1,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}stop(){this._stopped||(this._stopped=!0)}reset(){this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._currentActiveCount=0,this._targetIndex=0}getClassName(){return"GPUParticleSystem"}getCustomEffect(e=0){var t,i;return(i=(t=this._customWrappers[e])===null||t===void 0?void 0:t.effect)!==null&&i!==void 0?i:this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){var t;return(t=this._customWrappers[e])!==null&&t!==void 0?t:this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new vs(this._engine),this._customWrappers[t].effect=e}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new Q),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"gpuRenderParticles"}get vertexBuffers(){return this._renderVertexBuffers[this._targetIndex^1]}get indexBuffer(){return null}_removeGradientAndTexture(e,t,i){return super._removeGradientAndTexture(e,t,i),this._releaseBuffers(),this}addColorGradient(e,t){this._colorGradients||(this._colorGradients=[]);const i=new ME(e,t);return this._colorGradients.push(i),this._refreshColorGradient(!0),this._releaseBuffers(),this}_refreshColorGradient(e=!1){this._colorGradients&&(e&&this._colorGradients.sort((t,i)=>t.gradient<i.gradient?-1:t.gradient>i.gradient?1:0),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))}forceRefreshGradients(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()}removeColorGradient(e){return this._removeGradientAndTexture(e,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this}resetDrawCache(){var e;for(const t in this._drawWrappers)(e=this._drawWrappers[t].drawContext)===null||e===void 0||e.reset()}_addFactorGradient(e,t,i){const r=new OE(t,i);e.push(r),this._releaseBuffers()}addSizeGradient(e,t){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this}removeSizeGradient(e){return this._removeGradientAndTexture(e,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this}_refreshFactorGradient(e,t,i=!1){if(!e)return;i&&e.sort((s,n)=>s.gradient<n.gradient?-1:s.gradient>n.gradient?1:0);const r=this;r[t]&&(r[t].dispose(),r[t]=null)}addAngularSpeedGradient(e,t){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this}removeAngularSpeedGradient(e){return this._removeGradientAndTexture(e,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this}addVelocityGradient(e,t){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this}removeVelocityGradient(e){return this._removeGradientAndTexture(e,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this}addLimitVelocityGradient(e,t){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this}removeLimitVelocityGradient(e){return this._removeGradientAndTexture(e,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this}addDragGradient(e,t){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this}removeDragGradient(e){return this._removeGradientAndTexture(e,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this}addEmitRateGradient(){return this}removeEmitRateGradient(){return this}addStartSizeGradient(){return this}removeStartSizeGradient(){return this}addColorRemapGradient(){return this}removeColorRemapGradient(){return this}addAlphaRemapGradient(){return this}removeAlphaRemapGradient(){return this}addRampGradient(){return this}removeRampGradient(){return this}getRampGradients(){return null}get useRampGradients(){return!1}set useRampGradients(e){}addLifeTimeGradient(){return this}removeLifeTimeGradient(){return this}constructor(e,t,i,r=null,s=!1){if(super(e),this.layerMask=268435455,this._accumulatedCount=0,this._renderVertexBuffers=[],this._targetIndex=0,this._currentRenderId=-1,this._currentRenderingCameraUniqueId=-1,this._started=!1,this._stopped=!1,this._timeDelta=0,this.updateInAnimate=!1,this._actualFrame=0,this._rawTextureWidth=256,this.onDisposeObservable=new Q,this.onStoppedObservable=new Q,this.forceDepthWrite=!1,this._preWarmDone=!1,this.isLocal=!1,this.isGPU=!0,this._onBeforeDrawParticlesObservable=null,!i||i.getClassName()==="Scene"?(this._scene=i||qe.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)):(this._engine=i,this.defaultProjectionMatrix=H.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)),this._engine.getCaps().supportComputeShaders){if(!Xr("BABYLON.ComputeShaderParticleSystem"))throw new Error("The ComputeShaderParticleSystem class is not available! Make sure you have imported it.");this._platform=new(Xr("BABYLON.ComputeShaderParticleSystem"))(this,this._engine)}else{if(!Xr("BABYLON.WebGL2ParticleSystem"))throw new Error("The WebGL2ParticleSystem class is not available! Make sure you have imported it.");this._platform=new(Xr("BABYLON.WebGL2ParticleSystem"))(this,this._engine)}this._customWrappers={0:new vs(this._engine)},this._customWrappers[0].effect=r,this._drawWrappers={0:new vs(this._engine)},this._drawWrappers[0].drawContext&&(this._drawWrappers[0].drawContext.useInstancing=!0),this._attachImageProcessingConfiguration(null),t=t??{},t.randomTextureSize||delete t.randomTextureSize;const n={capacity:5e4,randomTextureSize:this._engine.getCaps().maxTextureSize,...t},a=t;isFinite(a)&&(n.capacity=a),this._capacity=n.capacity,this._activeCount=n.capacity,this._currentActiveCount=0,this._isAnimationSheetEnabled=s,this.particleEmitterType=new sc;const l=Math.min(this._engine.getCaps().maxTextureSize,n.randomTextureSize);let c=[];for(let h=0;h<l;++h)c.push(Math.random()),c.push(Math.random()),c.push(Math.random()),c.push(Math.random());this._randomTexture=new an(new Float32Array(c),l,1,5,i,!1,!1,1,1),this._randomTexture.name="GPUParticleSystem_random1",this._randomTexture.wrapU=1,this._randomTexture.wrapV=1,c=[];for(let h=0;h<l;++h)c.push(Math.random()),c.push(Math.random()),c.push(Math.random()),c.push(Math.random());this._randomTexture2=new an(new Float32Array(c),l,1,5,i,!1,!1,1,1),this._randomTexture2.name="GPUParticleSystem_random2",this._randomTexture2.wrapU=1,this._randomTexture2.wrapV=1,this._randomTextureSize=l}_reset(){this._releaseBuffers()}_createVertexBuffers(e,t,i){const r={};r.position=t.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);let s=3;r.age=t.createVertexBuffer("age",s,1,this._attributesStrideSize,!0),s+=1,r.size=t.createVertexBuffer("size",s,3,this._attributesStrideSize,!0),s+=3,r.life=t.createVertexBuffer("life",s,1,this._attributesStrideSize,!0),s+=1,s+=4,this.billboardMode===It.BILLBOARDMODE_STRETCHED&&(r.direction=t.createVertexBuffer("direction",s,3,this._attributesStrideSize,!0)),s+=3,this._platform.alignDataInBuffer&&(s+=1),this.particleEmitterType instanceof nc&&(s+=3,this._platform.alignDataInBuffer&&(s+=1)),this._colorGradientsTexture||(r.color=t.createVertexBuffer("color",s,4,this._attributesStrideSize,!0),s+=4),this._isBillboardBased||(r.initialDirection=t.createVertexBuffer("initialDirection",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1)),this.noiseTexture&&(r.noiseCoordinates1=t.createVertexBuffer("noiseCoordinates1",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1),r.noiseCoordinates2=t.createVertexBuffer("noiseCoordinates2",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1)),r.angle=t.createVertexBuffer("angle",s,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?s++:s+=2,this._isAnimationSheetEnabled&&(r.cellIndex=t.createVertexBuffer("cellIndex",s,1,this._attributesStrideSize,!0),s+=1,this.spriteRandomStartCell&&(r.cellStartOffset=t.createVertexBuffer("cellStartOffset",s,1,this._attributesStrideSize,!0),s+=1)),r.offset=i.createVertexBuffer("offset",0,2),r.uv=i.createVertexBuffer("uv",2,2),this._renderVertexBuffers.push(r),this._platform.createVertexBuffers(e,r),this.resetDrawCache()}_initialize(e=!1){if(this._buffer0&&!e)return;const t=this._engine,i=new Array;this._attributesStrideSize=21,this._targetIndex=0,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1),this.particleEmitterType instanceof nc&&(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this.isBillboardBased||(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=2)),this._platform.alignDataInBuffer&&(this._attributesStrideSize+=3-(this._attributesStrideSize+3&3));const r=this.particleEmitterType instanceof nc,s=j.Vector3[0];let n=0;for(let h=0;h<this._capacity;h++)if(i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),r?(this.particleEmitterType.particleDestinationGenerator(h,null,s),i.push(s.x),i.push(s.y),i.push(s.z)):(i.push(0),i.push(0),i.push(0)),this._platform.alignDataInBuffer&&i.push(0),n+=16,r&&(this.particleEmitterType.particlePositionGenerator(h,null,s),i.push(s.x),i.push(s.y),i.push(s.z),this._platform.alignDataInBuffer&&i.push(0),n+=4),this._colorGradientsTexture||(i.push(0),i.push(0),i.push(0),i.push(0),n+=4),this.isBillboardBased||(i.push(0),i.push(0),i.push(0),this._platform.alignDataInBuffer&&i.push(0),n+=4),this.noiseTexture&&(i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),n+=8),i.push(0),n+=1,this._angularSpeedGradientsTexture||(i.push(0),n+=1),this._isAnimationSheetEnabled&&(i.push(0),n+=1,this.spriteRandomStartCell&&(i.push(0),n+=1)),this._platform.alignDataInBuffer){let u=3-(n+3&3);for(n+=u;u-- >0;)i.push(0)}const a=new Float32Array([.5,.5,1,1,-.5,.5,0,1,.5,-.5,1,0,-.5,-.5,0,0]),l=this._platform.createParticleBuffer(i),c=this._platform.createParticleBuffer(i);this._buffer0=new Xa(t,l,!1,this._attributesStrideSize),this._buffer1=new Xa(t,c,!1,this._attributesStrideSize),this._spriteBuffer=new Xa(t,a,!1,4),this._renderVertexBuffers=[],this._createVertexBuffers(this._buffer0,this._buffer1,this._spriteBuffer),this._createVertexBuffers(this._buffer1,this._buffer0,this._spriteBuffer),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}_recreateUpdateEffect(){let e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";return this._isBillboardBased&&(e+=`
#define BILLBOARD`),this._colorGradientsTexture&&(e+=`
#define COLORGRADIENTS`),this._sizeGradientsTexture&&(e+=`
#define SIZEGRADIENTS`),this._angularSpeedGradientsTexture&&(e+=`
#define ANGULARSPEEDGRADIENTS`),this._velocityGradientsTexture&&(e+=`
#define VELOCITYGRADIENTS`),this._limitVelocityGradientsTexture&&(e+=`
#define LIMITVELOCITYGRADIENTS`),this._dragGradientsTexture&&(e+=`
#define DRAGGRADIENTS`),this.isAnimationSheetEnabled&&(e+=`
#define ANIMATESHEET`,this.spriteRandomStartCell&&(e+=`
#define ANIMATESHEETRANDOMSTART`)),this.noiseTexture&&(e+=`
#define NOISE`),this.isLocal&&(e+=`
#define LOCAL`),this._platform.isUpdateBufferCreated()&&this._cachedUpdateDefines===e?!0:(this._cachedUpdateDefines=e,this._updateBuffer=this._platform.createUpdateBuffer(e),this._platform.isUpdateBufferReady())}_getWrapper(e){const t=this._getCustomDrawWrapper(e);if(t!=null&&t.effect)return t;const i=[];this.fillDefines(i,e);let r=this._drawWrappers[e];r||(r=new vs(this._engine),r.drawContext&&(r.drawContext.useInstancing=!0),this._drawWrappers[e]=r);const s=i.join(`
`);if(r.defines!==s){const n=[],a=[],l=[];this.fillUniformsAttributesAndSamplerNames(a,n,l),r.setEffect(this._engine.createEffect("gpuRenderParticles",n,a,l,s),s)}return r}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1,r=!1){const s=[O.PositionKind,"age","life","size","angle"];return e||s.push(O.ColorKind),t&&s.push("cellIndex"),i||s.push("initialDirection"),r||s.push("direction"),s.push("offset",O.UVKind),s}static _GetEffectCreationOptions(e=!1,t=!1){const i=["emitterWM","worldOffset","view","projection","colorDead","invView","translationPivot","eyePosition"];return ja(i),e&&i.push("sheetInfos"),t&&i.push("logarithmicDepthConstant"),i}fillDefines(e,t=0){if(this._scene&&Zo(this,this._scene,e),t===It.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this.isLocal&&e.push("#define LOCAL"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case It.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case It.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case It.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL");break}this._colorGradientsTexture&&e.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(""+this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...Wc._GetAttributeNamesOrOptions(!!this._colorGradientsTexture,this._isAnimationSheetEnabled,this._isBillboardBased,this._isBillboardBased&&this.billboardMode===It.BILLBOARDMODE_STRETCHED)),e.push(...Wc._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth)),i.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(wt.PrepareUniforms(e,this._imageProcessingConfigurationDefines),wt.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}animate(e=!1){var t;this._timeDelta=this.updateSpeed*(e?this.preWarmStepOffset:((t=this._scene)===null||t===void 0?void 0:t.getAnimationRatio())||1),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop(),this.updateInAnimate&&this._update()}_createFactorGradientTexture(e,t){const i=this[t];if(!e||!e.length||i)return;const r=new Float32Array(this._rawTextureWidth);for(let s=0;s<this._rawTextureWidth;s++){const n=s/this._rawTextureWidth;Hn.GetCurrentGradient(n,e,(a,l,c)=>{r[s]=Ee.Lerp(a.factor1,l.factor1,c)})}this[t]=an.CreateRTexture(r,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1)}_createSizeGradientTexture(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")}_createAngularSpeedGradientTexture(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")}_createVelocityGradientTexture(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")}_createLimitVelocityGradientTexture(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")}_createDragGradientTexture(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")}_createColorGradientTexture(){if(!this._colorGradients||!this._colorGradients.length||this._colorGradientsTexture)return;const e=new Uint8Array(this._rawTextureWidth*4),t=Jt.Color4[0];for(let i=0;i<this._rawTextureWidth;i++){const r=i/this._rawTextureWidth;Hn.GetCurrentGradient(r,this._colorGradients,(s,n,a)=>{Ye.LerpToRef(s.color1,n.color1,a,t),e[i*4]=t.r*255,e[i*4+1]=t.g*255,e[i*4+2]=t.b*255,e[i*4+3]=t.a*255})}this._colorGradientsTexture=an.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}_render(e,t){var i,r;const s=this._getWrapper(e),n=s.effect;this._engine.enableEffect(s);const a=((i=this._scene)===null||i===void 0?void 0:i.getViewMatrix())||H.IdentityReadOnly;if(n.setMatrix("view",a),n.setMatrix("projection",(r=this.defaultProjectionMatrix)!==null&&r!==void 0?r:this._scene.getProjectionMatrix()),n.setTexture("diffuseSampler",this.particleTexture),n.setVector2("translationPivot",this.translationPivot),n.setVector3("worldOffset",this.worldOffset),this.isLocal&&n.setMatrix("emitterWM",t),this._colorGradientsTexture?n.setTexture("colorGradientSampler",this._colorGradientsTexture):n.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){const c=this.particleTexture.getBaseSize();n.setFloat3("sheetInfos",this.spriteCellWidth/c.width,this.spriteCellHeight/c.height,c.width/this.spriteCellWidth)}if(this._isBillboardBased&&this._scene){const c=this._scene.activeCamera;n.setVector3("eyePosition",c.globalPosition)}const l=n.defines;if(this._scene&&Ra(n,this,this._scene),l.indexOf("#define BILLBOARDMODE_ALL")>=0){const c=a.clone();c.invert(),n.setMatrix("invView",c)}switch(this.useLogarithmicDepth&&this._scene&&Ce.BindLogDepth(l,n,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(n),e){case It.BLENDMODE_ADD:this._engine.setAlphaMode(1);break;case It.BLENDMODE_ONEONE:this._engine.setAlphaMode(6);break;case It.BLENDMODE_STANDARD:this._engine.setAlphaMode(2);break;case It.BLENDMODE_MULTIPLY:this._engine.setAlphaMode(4);break}return this._platform.bindDrawBuffers(this._targetIndex,n),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(n),this._engine.drawArraysType(7,0,4,this._currentActiveCount),this._engine.setAlphaMode(0),this._currentActiveCount}_update(e){if(!this.emitter||!this._recreateUpdateEffect())return;if(this.emitter.position)e=this.emitter.getWorldMatrix();else{const i=this.emitter;e=j.Matrix[0],H.TranslationToRef(i.x,i.y,i.z,e)}this._platform.preUpdateParticleBuffer(),this._updateBuffer.setFloat("currentCount",this._currentActiveCount),this._updateBuffer.setFloat("timeDelta",this._timeDelta),this._updateBuffer.setFloat("stopFactor",this._stopped?0:1),this._updateBuffer.setInt("randomTextureSize",this._randomTextureSize),this._updateBuffer.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateBuffer.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateBuffer.setDirectColor4("color1",this.color1),this._updateBuffer.setDirectColor4("color2",this.color2)),this._updateBuffer.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateBuffer.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateBuffer.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateBuffer.setVector3("gravity",this.gravity),this._limitVelocityGradientsTexture&&this._updateBuffer.setFloat("limitVelocityDamping",this.limitVelocityDamping),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateBuffer),this._isAnimationSheetEnabled&&this._updateBuffer.setFloat4("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed,this.spriteCellLoop?1:0),this.noiseTexture&&this._updateBuffer.setVector3("noiseStrength",this.noiseStrength),this.isLocal||this._updateBuffer.setMatrix("emitterWM",e),this._platform.updateParticleBuffer(this._targetIndex,this._targetBuffer,this._currentActiveCount),this._targetIndex++,this._targetIndex===2&&(this._targetIndex=0);const t=this._sourceBuffer;this._sourceBuffer=this._targetBuffer,this._targetBuffer=t}render(e=!1,t=!1){if(!this._started||(this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture(),!this.isReady()))return 0;if(!e&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(let n=0;n<this.preWarmCycles;n++)this.animate(!0),this.render(!0,!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getFrameId()&&(!this._scene.activeCamera||this._scene.activeCamera&&this._currentRenderingCameraUniqueId===this._scene.activeCamera.uniqueId))return 0;this._currentRenderId=this._scene.getFrameId(),this._scene.activeCamera&&(this._currentRenderingCameraUniqueId=this._scene.activeCamera.uniqueId)}if(this._initialize(),this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>1){const n=this._accumulatedCount|0;this._accumulatedCount-=n,this._currentActiveCount=Math.min(this._activeCount,this._currentActiveCount+n)}if(!this._currentActiveCount)return 0;let i;if(this.emitter.position)i=this.emitter.getWorldMatrix();else{const n=this.emitter;i=j.Matrix[0],H.TranslationToRef(n.x,n.y,n.z,i)}const r=this._engine;this.updateInAnimate||this._update(i);let s=0;return!e&&!t&&(r.setState(!1),this.forceDepthWrite&&r.setDepthWrite(!0),this.blendMode===It.BLENDMODE_MULTIPLYADD?s=this._render(It.BLENDMODE_MULTIPLY,i)+this._render(It.BLENDMODE_ADD,i):s=this._render(this.blendMode,i),this._engine.setAlphaMode(0)),s}rebuild(){this._initialize(!0)}_releaseBuffers(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._platform.releaseBuffers()}dispose(e=!0){for(const t in this._drawWrappers)this._drawWrappers[t].dispose();if(this._drawWrappers={},this._scene){const t=this._scene.particleSystems.indexOf(this);t>-1&&this._scene.particleSystems.splice(t,1)}this._releaseBuffers(),this._platform.releaseVertexBuffers();for(let t=0;t<this._renderVertexBuffers.length;++t){const i=this._renderVertexBuffers[t];for(const r in i)i[r].dispose()}this._renderVertexBuffers=[],this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}clone(e,t,i=!1){const r={...this._customWrappers};let s=null;const n=this._engine;if(n.createEffectForParticles&&this.customShader!=null){s=this.customShader;const c=s.shaderOptions.defines.length>0?s.shaderOptions.defines.join(`
`):"";r[0]=n.createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,c,void 0,void 0,void 0,this)}const a=this.serialize(i),l=Wc.Parse(a,this._scene||this._engine,this._rootUrl);return l.name=e,l.customShader=s,l._customWrappers=r,t===void 0&&(t=this.emitter),this.noiseTexture&&(l.noiseTexture=this.noiseTexture.clone()),l.emitter=t,l}serialize(e=!1){const t={};return It._Serialize(t,this,e),t.activeParticleCount=this.activeParticleCount,t.randomTextureSize=this._randomTextureSize,t.customShader=this.customShader,t}static Parse(e,t,i,r=!1,s){const n=e.name;let a,l;t instanceof ze?a=t:(l=t,a=l.getEngine());const c=new Wc(n,{capacity:s||e.capacity,randomTextureSize:e.randomTextureSize},t,null,e.isAnimationSheetEnabled);if(c._rootUrl=i,e.customShader&&a.createEffectForParticles){const h=e.customShader,u=h.shaderOptions.defines.length>0?h.shaderOptions.defines.join(`
`):"",d=a.createEffectForParticles(h.shaderPath.fragmentElement,h.shaderOptions.uniforms,h.shaderOptions.samplers,u,void 0,void 0,void 0,c);c.setCustomEffect(d,0),c.customShader=h}return e.id&&(c.id=e.id),e.activeParticleCount&&(c.activeParticleCount=e.activeParticleCount),It._Parse(e,c,t,i),e.preventAutoStart&&(c.preventAutoStart=e.preventAutoStart),!r&&!c.preventAutoStart&&c.start(),c}}Er.AddParser(Re.NAME_PARTICLESYSTEM,(o,e,t,i)=>{const r=Er.GetIndividualParser(Re.NAME_PARTICLESYSTEM);if(r&&o.particleSystems!==void 0&&o.particleSystems!==null)for(let s=0,n=o.particleSystems.length;s<n;s++){const a=o.particleSystems[s];t.particleSystems.push(r(a,e,i))}});Er.AddIndividualParser(Re.NAME_PARTICLESYSTEM,(o,e,t)=>o.activeParticleCount?Wc.Parse(o,e,t):It.Parse(o,e,t));q.prototype.createEffectForParticles=function(o,e=[],t=[],i="",r,s,n,a){var l;let c=[],h=[];const u=[];return a?a.fillUniformsAttributesAndSamplerNames(h,c,u):(c=It._GetAttributeNamesOrOptions(),h=It._GetEffectCreationOptions()),i.indexOf(" BILLBOARD")===-1&&(i+=`
#define BILLBOARD
`),a!=null&&a.isAnimationSheetEnabled&&i.indexOf(" ANIMATESHEET")===-1&&(i+=`
#define ANIMATESHEET
`),t.indexOf("diffuseSampler")===-1&&t.push("diffuseSampler"),this.createEffect({vertex:(l=a==null?void 0:a.vertexShaderName)!==null&&l!==void 0?l:"particles",fragmentElement:o},c,h.concat(e),u.concat(t),i,r,s,n)};K.prototype.getEmittedParticleSystems=function(){const o=new Array;for(let e=0;e<this.getScene().particleSystems.length;e++){const t=this.getScene().particleSystems[e];t.emitter===this&&o.push(t)}return o};K.prototype.getHierarchyEmittedParticleSystems=function(){const o=new Array,e=this.getDescendants();e.push(this);for(let t=0;t<this.getScene().particleSystems.length;t++){const i=this.getScene().particleSystems[t],r=i.emitter;r.position&&e.indexOf(r)!==-1&&o.push(i)}return o};var fx;(function(o){o[o.Color=2]="Color",o[o.UV=1]="UV",o[o.Random=0]="Random",o[o.Stated=3]="Stated"})(fx||(fx={}));Object.defineProperty(Qt.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(o){this._physicsImpostor!==o&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=o,o&&(this._disposePhysicsObserver=this.onDisposeObservable.add(()=>{this.physicsImpostor&&(this.physicsImpostor.dispose(),this.physicsImpostor=null)})))},enumerable:!0,configurable:!0});Qt.prototype.getPhysicsImpostor=function(){return this.physicsImpostor};Qt.prototype.applyImpulse=function(o,e){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(o,e),this):this};Qt.prototype.setPhysicsLinkWith=function(o,e,t,i){return!this.physicsImpostor||!o.physicsImpostor?this:(this.physicsImpostor.createJoint(o.physicsImpostor,Oi.HingeJoint,{mainPivot:e,connectedPivot:t,nativeParams:i}),this)};class Wm{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw pt("")}constructor(e,t=Wm.DefaultPluginFactory()){this._physicsPlugin=t,this._physicsBodies=[],this._subTimeStep=0,e=e||new x(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}_step(e){e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._physicsBodies)}addBody(e){this._physicsBodies.push(e)}removeBody(e){const t=this._physicsBodies.indexOf(e);t>-1&&this._physicsBodies.splice(t,1)}getBodies(){return this._physicsBodies}getPhysicsPlugin(){return this._physicsPlugin}raycastToRef(e,t,i){this._physicsPlugin.raycast(e,t,i)}raycast(e,t){const i=new Xf;return this._physicsPlugin.raycast(e,t,i),i}}oe.Identity();var _x;(function(o){o[o.FREE=0]="FREE",o[o.LIMITED=1]="LIMITED",o[o.LOCKED=2]="LOCKED",o[o.NONE=3]="NONE"})(_x||(_x={}));var px;(function(o){o[o.LINEAR_X=0]="LINEAR_X",o[o.LINEAR_Y=1]="LINEAR_Y",o[o.LINEAR_Z=2]="LINEAR_Z",o[o.ANGULAR_X=3]="ANGULAR_X",o[o.ANGULAR_Y=4]="ANGULAR_Y",o[o.ANGULAR_Z=5]="ANGULAR_Z",o[o.LINEAR_DISTANCE=6]="LINEAR_DISTANCE"})(px||(px={}));var mx;(function(o){o[o.BALL_AND_SOCKET=1]="BALL_AND_SOCKET",o[o.DISTANCE=2]="DISTANCE",o[o.HINGE=3]="HINGE",o[o.SLIDER=4]="SLIDER",o[o.LOCK=5]="LOCK",o[o.PRISMATIC=6]="PRISMATIC"})(mx||(mx={}));var gx;(function(o){o[o.SPHERE=0]="SPHERE",o[o.CAPSULE=1]="CAPSULE",o[o.CYLINDER=2]="CYLINDER",o[o.BOX=3]="BOX",o[o.CONVEX_HULL=4]="CONVEX_HULL",o[o.CONTAINER=5]="CONTAINER",o[o.MESH=6]="MESH",o[o.HEIGHTFIELD=7]="HEIGHTFIELD"})(gx||(gx={}));var vx;(function(o){o[o.NONE=0]="NONE",o[o.VELOCITY=1]="VELOCITY",o[o.POSITION=2]="POSITION"})(vx||(vx={}));Ne.prototype.getPhysicsEngine=function(){return this._physicsEngine};Ne.prototype.enablePhysics=function(o=null,e){if(this._physicsEngine)return!0;let t=this._getComponent(Re.NAME_PHYSICSENGINE);t||(t=new ow(this),this._addComponent(t));try{if(!e||(e==null?void 0:e.getPluginVersion())===1)this._physicsEngine=new mE(o,e);else if((e==null?void 0:e.getPluginVersion())===2)this._physicsEngine=new Wm(o,e);else throw new Error("Unsupported Physics plugin version.");return this._physicsTimeAccumulator=0,!0}catch(i){return X.Error(i.message),!1}};Ne.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=null)};Ne.prototype.isPhysicsEnabled=function(){return this._physicsEngine!==void 0};Ne.prototype.deleteCompoundImpostor=function(o){const e=o.parts[0].mesh;e.physicsImpostor&&(e.physicsImpostor.dispose(),e.physicsImpostor=null)};Ne.prototype._advancePhysicsEngineStep=function(o){if(this._physicsEngine){const e=this._physicsEngine.getSubTimeStep();if(e>0)for(this._physicsTimeAccumulator+=o;this._physicsTimeAccumulator>e;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=e;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(o/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};class ow{constructor(e){this.name=Re.NAME_PHYSICSENGINE,this.scene=e,this.scene.onBeforePhysicsObservable=new Q,this.scene.onAfterPhysicsObservable=new Q,this.scene.getDeterministicFrameTime=()=>this.scene._physicsEngine?this.scene._physicsEngine.getTimeStep()*1e3:1e3/60}register(){}rebuild(){}dispose(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()}}x.Zero();var xx;(function(o){o[o.Constant=0]="Constant",o[o.Linear=1]="Linear"})(xx||(xx={}));var Tx;(function(o){o[o.Center=0]="Center",o[o.Perpendicular=1]="Perpendicular"})(Tx||(Tx={}));const lw="blackAndWhitePixelShader",cw=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform float degree;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
vec3 color=texture2D(textureSampler,vUV).rgb;
float luminance=dot(color,vec3(0.3,0.59,0.11)); 
vec3 blackAndWhite=vec3(luminance,luminance,luminance);
gl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);
}`;te.ShadersStore[lw]=cw;class qf extends et{getClassName(){return"BlackAndWhitePostProcess"}constructor(e,t,i,r,s,n){super(e,"blackAndWhite",["degree"],null,t,i,r,s,n),this.degree=1,this.onApplyObservable.add(a=>{a.setFloat("degree",this.degree)})}static _Parse(e,t,i,r){return ke.Parse(()=>new qf(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}M([F()],qf.prototype,"degree",void 0);ye("BABYLON.BlackAndWhitePostProcess",qf);class ci{constructor(e,t,i,r){this._name=t,this._singleInstance=r||!0,this._getPostProcesses=i,this._cameras={},this._indicesForCamera={},this._postProcesses={}}get isSupported(){for(const e in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,e)){const t=this._postProcesses[e];for(let i=0;i<t.length;i++)if(!t[i].isSupported)return!1}return!0}_update(){}_attachCameras(e){let t;const i=J.MakeArray(e||this._cameras);if(i)for(let r=0;r<i.length;r++){const s=i[r];if(!s)continue;const n=s.name;if(this._singleInstance?t=0:t=n,!this._postProcesses[t]){const a=this._getPostProcesses();a&&(this._postProcesses[t]=Array.isArray(a)?a:[a])}this._indicesForCamera[n]||(this._indicesForCamera[n]=[]),this._postProcesses[t].forEach(a=>{const l=s.attachPostProcess(a);this._indicesForCamera[n].push(l)}),this._cameras[n]||(this._cameras[n]=s)}}_detachCameras(e){const t=J.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){const r=t[i],s=r.name,n=this._postProcesses[this._singleInstance?0:s];n&&n.forEach(a=>{r.detachPostProcess(a)}),this._cameras[s]&&(this._cameras[s]=null)}}_enable(e){const t=J.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){const r=t[i],s=r.name;for(let n=0;n<this._indicesForCamera[s].length;n++)(r._postProcesses[this._indicesForCamera[s][n]]===void 0||r._postProcesses[this._indicesForCamera[s][n]]===null)&&this._postProcesses[this._singleInstance?0:s].forEach(a=>{t[i].attachPostProcess(a,this._indicesForCamera[s][n])})}}_disable(e){const t=J.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){const r=t[i],s=r.name;this._postProcesses[this._singleInstance?0:s].forEach(n=>{r.detachPostProcess(n)})}}getPostProcesses(e){return this._singleInstance?this._postProcesses[0]:e?this._postProcesses[e.name]:null}}const hw="extractHighlightsPixelShader",uw=`#include<helperFunctions>
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform float threshold;
uniform float exposure;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=texture2D(textureSampler,vUV);
float luma=dot(LuminanceEncodeApprox,gl_FragColor.rgb*exposure);
gl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;
}`;te.ShadersStore[hw]=uw;class Xm extends et{getClassName(){return"ExtractHighlightsPostProcess"}constructor(e,t,i,r,s,n,a=0,l=!1){super(e,"extractHighlights",["threshold","exposure"],null,t,i,r,s,n,null,a,void 0,null,l),this.threshold=.9,this._exposure=1,this._inputPostProcess=null,this.onApplyObservable.add(c=>{this.externalTextureSamplerBinding=!!this._inputPostProcess,this._inputPostProcess&&c.setTextureFromPostProcess("textureSampler",this._inputPostProcess),c.setFloat("threshold",Math.pow(this.threshold,mo)),c.setFloat("exposure",this._exposure)})}}M([F()],Xm.prototype,"threshold",void 0);ye("BABYLON.ExtractHighlightsPostProcess",Xm);const dw="bloomMergePixelShader",fw=`uniform sampler2D textureSampler;
uniform sampler2D bloomBlur;
varying vec2 vUV;
uniform float bloomWeight;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
gl_FragColor=texture2D(textureSampler,vUV);
vec3 blurred=texture2D(bloomBlur,vUV).rgb;
gl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight); 
}
`;te.ShadersStore[dw]=fw;class $m extends et{getClassName(){return"BloomMergePostProcess"}constructor(e,t,i,r,s,n,a,l,c,h=0,u=!1){super(e,"bloomMerge",["bloomWeight"],["bloomBlur"],s,n,a,l,c,null,h,void 0,null,!0),this.weight=1,this.weight=r,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add(d=>{d.setTextureFromPostProcess("textureSampler",t),d.setTextureFromPostProcessOutput("bloomBlur",i),d.setFloat("bloomWeight",this.weight)}),u||this.updateEffect()}}M([F()],$m.prototype,"weight",void 0);ye("BABYLON.BloomMergePostProcess",$m);class Ex extends ci{get threshold(){return this._downscale.threshold}set threshold(e){this._downscale.threshold=e}get weight(){return this._merge.weight}set weight(e){this._merge.weight=e}get kernel(){return this._blurX.kernel/this._bloomScale}set kernel(e){this._blurX.kernel=e*this._bloomScale,this._blurY.kernel=e*this._bloomScale}constructor(e,t,i,r,s=0,n=!1){super(e.getEngine(),"bloom",()=>this._effects,!0),this._bloomScale=t,this._effects=[],this._downscale=new Xm("highlights",1,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,s,n),this._blurX=new Yr("horizontal blur",new Ie(1,0),10,t,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,s,void 0,n),this._blurX.alwaysForcePOT=!0,this._blurX.autoClear=!1,this._blurY=new Yr("vertical blur",new Ie(0,1),10,t,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,s,void 0,n),this._blurY.alwaysForcePOT=!0,this._blurY.autoClear=!1,this.kernel=r,this._effects=[this._downscale,this._blurX,this._blurY],this._merge=new $m("bloomMerge",this._downscale,this._blurY,i,t,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,s,n),this._merge.autoClear=!1,this._effects.push(this._merge)}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}const _w="chromaticAberrationPixelShader",pw=`uniform sampler2D textureSampler; 
uniform float chromatic_aberration;
uniform float radialIntensity;
uniform vec2 direction;
uniform vec2 centerPosition;
uniform float screen_width;
uniform float screen_height;
varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);
vec2 directionOfEffect=direction;
if(directionOfEffect.x==0. && directionOfEffect.y==0.){
directionOfEffect=normalize(centered_screen_pos);
}
float radius2=centered_screen_pos.x*centered_screen_pos.x
+ centered_screen_pos.y*centered_screen_pos.y;
float radius=sqrt(radius2);
vec4 original=texture2D(textureSampler,vUV);
vec3 ref_indices=vec3(-0.3,0.0,0.3);
float ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;
float ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;
vec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);
vec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);
vec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);
original.r=texture2D(textureSampler,ref_coords_r).r;
original.g=texture2D(textureSampler,ref_coords_g).g;
original.b=texture2D(textureSampler,ref_coords_b).b;
original.a=clamp(texture2D(textureSampler,ref_coords_r).a+texture2D(textureSampler,ref_coords_g).a+texture2D(textureSampler,ref_coords_b).a,0.,1.);
gl_FragColor=original;
}`;te.ShadersStore[_w]=pw;class Ao extends et{getClassName(){return"ChromaticAberrationPostProcess"}constructor(e,t,i,r,s,n,a,l,c=0,h=!1){super(e,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],r,s,n,a,l,null,c,void 0,null,h),this.aberrationAmount=30,this.radialIntensity=0,this.direction=new Ie(.707,.707),this.centerPosition=new Ie(.5,.5),this.screenWidth=t,this.screenHeight=i,this.onApplyObservable.add(u=>{u.setFloat("chromatic_aberration",this.aberrationAmount),u.setFloat("screen_width",t),u.setFloat("screen_height",i),u.setFloat("radialIntensity",this.radialIntensity),u.setFloat2("direction",this.direction.x,this.direction.y),u.setFloat2("centerPosition",this.centerPosition.x,this.centerPosition.y)})}static _Parse(e,t,i,r){return ke.Parse(()=>new Ao(e.name,e.screenWidth,e.screenHeight,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1),e,i,r)}}M([F()],Ao.prototype,"aberrationAmount",void 0);M([F()],Ao.prototype,"radialIntensity",void 0);M([F()],Ao.prototype,"direction",void 0);M([F()],Ao.prototype,"centerPosition",void 0);M([F()],Ao.prototype,"screenWidth",void 0);M([F()],Ao.prototype,"screenHeight",void 0);ye("BABYLON.ChromaticAberrationPostProcess",Ao);const mw="circleOfConfusionPixelShader",gw=`uniform sampler2D depthSampler;
varying vec2 vUV;
uniform vec2 cameraMinMaxZ;
uniform float focusDistance;
uniform float cocPrecalculation;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
float depth=texture2D(depthSampler,vUV).r;
#define CUSTOM_COC_DEPTH
float pixelDistance=(cameraMinMaxZ.x+cameraMinMaxZ.y*depth)*1000.0; 
#define CUSTOM_COC_PIXELDISTANCE
float coc=abs(cocPrecalculation*((focusDistance-pixelDistance)/pixelDistance));
coc=clamp(coc,0.0,1.0);
gl_FragColor=vec4(coc,coc,coc,1.0);
}
`;te.ShadersStore[mw]=gw;class Ch extends et{getClassName(){return"CircleOfConfusionPostProcess"}constructor(e,t,i,r,s,n,a,l=0,c=!1){super(e,"circleOfConfusion",["cameraMinMaxZ","focusDistance","cocPrecalculation"],["depthSampler"],i,r,s,n,a,null,l,void 0,null,c),this.lensSize=50,this.fStop=1.4,this.focusDistance=2e3,this.focalLength=50,this._depthTexture=null,this._depthTexture=t,this.onApplyObservable.add(h=>{if(!this._depthTexture){X.Warn("No depth texture set on CircleOfConfusionPostProcess");return}h.setTexture("depthSampler",this._depthTexture);const d=this.lensSize/this.fStop*this.focalLength/(this.focusDistance-this.focalLength);h.setFloat("focusDistance",this.focusDistance),h.setFloat("cocPrecalculation",d);const f=this._depthTexture.activeCamera;h.setFloat2("cameraMinMaxZ",f.minZ,f.maxZ-f.minZ)})}set depthTexture(e){this._depthTexture=e}}M([F()],Ch.prototype,"lensSize",void 0);M([F()],Ch.prototype,"fStop",void 0);M([F()],Ch.prototype,"focusDistance",void 0);M([F()],Ch.prototype,"focalLength",void 0);ye("BABYLON.CircleOfConfusionPostProcess",Ch);const vw="colorCorrectionPixelShader",xw=`uniform sampler2D textureSampler; 
uniform sampler2D colorTable; 
varying vec2 vUV;
const float SLICE_COUNT=16.0; 
vec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {
float sliceSize=1.0/width; 
float slicePixelSize=sliceSize/width; 
float sliceInnerSize=slicePixelSize*(width-1.0); 
float zSlice0=min(floor(uv.z*width),width-1.0);
float zSlice1=min(zSlice0+1.0,width-1.0);
float xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;
float s0=xOffset+(zSlice0*sliceSize);
float s1=xOffset+(zSlice1*sliceSize);
vec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));
vec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));
float zOffset=mod(uv.z*width,1.0);
vec4 result=mix(slice0Color,slice1Color,zOffset);
return result;
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec4 screen_color=texture2D(textureSampler,vUV);
gl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);
}`;te.ShadersStore[vw]=xw;class Qf extends et{getClassName(){return"ColorCorrectionPostProcess"}constructor(e,t,i,r,s,n,a){super(e,"colorCorrection",null,["colorTable"],i,r,s,n,a);const l=(r==null?void 0:r.getScene())||null;this._colorTableTexture=new Y(t,l,!0,!1,Y.TRILINEAR_SAMPLINGMODE),this._colorTableTexture.anisotropicFilteringLevel=1,this._colorTableTexture.wrapU=Y.CLAMP_ADDRESSMODE,this._colorTableTexture.wrapV=Y.CLAMP_ADDRESSMODE,this.colorTableUrl=t,this.onApply=c=>{c.setTexture("colorTable",this._colorTableTexture)}}static _Parse(e,t,i,r){return ke.Parse(()=>new Qf(e.name,e.colorTableUrl,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}M([F()],Qf.prototype,"colorTableUrl",void 0);ye("BABYLON.ColorCorrectionPostProcess",Qf);const Tw="convolutionPixelShader",Ew=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 screenSize;
uniform float kernel[9];
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec2 onePixel=vec2(1.0,1.0)/screenSize;
vec4 colorSum =
texture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +
texture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +
texture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +
texture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +
texture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +
texture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +
texture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +
texture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +
texture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];
float kernelWeight =
kernel[0] +
kernel[1] +
kernel[2] +
kernel[3] +
kernel[4] +
kernel[5] +
kernel[6] +
kernel[7] +
kernel[8];
if (kernelWeight<=0.0) {
kernelWeight=1.0;
}
gl_FragColor=vec4((colorSum/kernelWeight).rgb,1);
}`;te.ShadersStore[Tw]=Ew;class Ro extends et{getClassName(){return"ConvolutionPostProcess"}constructor(e,t,i,r,s,n,a,l=0){super(e,"convolution",["kernel","screenSize"],null,i,r,s,n,a,null,l),this.kernel=t,this.onApply=c=>{c.setFloat2("screenSize",this.width,this.height),c.setArray("kernel",this.kernel)}}static _Parse(e,t,i,r){return ke.Parse(()=>new Ro(e.name,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType),e,i,r)}}Ro.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1];Ro.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0];Ro.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1];Ro.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0];Ro.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2];Ro.GaussianKernel=[0,1,0,1,1,1,0,1,0];M([F()],Ro.prototype,"kernel",void 0);ye("BABYLON.ConvolutionPostProcess",Ro);class af extends Yr{getClassName(){return"DepthOfFieldBlurPostProcess"}constructor(e,t,i,r,s,n,a,l=null,c=Y.BILINEAR_SAMPLINGMODE,h,u,d=0,f=!1,_=5){super(e,i,r,s,n,c=2,h,u,d,`#define DOF 1\r
`,f,_),this.direction=i,this.externalTextureSamplerBinding=!!l,this.onApplyObservable.add(p=>{l!=null&&p.setTextureFromPostProcess("textureSampler",l),p.setTextureFromPostProcessOutput("circleOfConfusionSampler",a)})}}M([F()],af.prototype,"direction",void 0);ye("BABYLON.DepthOfFieldBlurPostProcess",af);const bw="depthOfFieldMergePixelShader",Sw=`uniform sampler2D textureSampler;
varying vec2 vUV;
uniform sampler2D circleOfConfusionSampler;
uniform sampler2D blurStep0;
#if BLUR_LEVEL>0
uniform sampler2D blurStep1;
#endif
#if BLUR_LEVEL>1
uniform sampler2D blurStep2;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
float coc=texture2D(circleOfConfusionSampler,vUV).r;
#if BLUR_LEVEL==0
vec4 original=texture2D(textureSampler,vUV);
vec4 blurred0=texture2D(blurStep0,vUV);
gl_FragColor=mix(original,blurred0,coc);
#endif
#if BLUR_LEVEL==1
if(coc<0.5){
vec4 original=texture2D(textureSampler,vUV);
vec4 blurred1=texture2D(blurStep1,vUV);
gl_FragColor=mix(original,blurred1,coc/0.5);
}else{
vec4 blurred0=texture2D(blurStep0,vUV);
vec4 blurred1=texture2D(blurStep1,vUV);
gl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);
}
#endif
#if BLUR_LEVEL==2
if(coc<0.33){
vec4 original=texture2D(textureSampler,vUV);
vec4 blurred2=texture2D(blurStep2,vUV);
gl_FragColor=mix(original,blurred2,coc/0.33);
}else if(coc<0.66){
vec4 blurred1=texture2D(blurStep1,vUV);
vec4 blurred2=texture2D(blurStep2,vUV);
gl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);
}else{
vec4 blurred0=texture2D(blurStep0,vUV);
vec4 blurred1=texture2D(blurStep1,vUV);
gl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);
}
#endif
}
`;te.ShadersStore[bw]=Sw;class yw extends et{getClassName(){return"DepthOfFieldMergePostProcess"}constructor(e,t,i,r,s,n,a,l,c,h=0,u=!1){super(e,"depthOfFieldMerge",[],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"],s,n,a,l,c,null,h,void 0,null,!0),this._blurSteps=r,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add(d=>{d.setTextureFromPostProcess("textureSampler",t),d.setTextureFromPostProcessOutput("circleOfConfusionSampler",i),r.forEach((f,_)=>{d.setTextureFromPostProcessOutput("blurStep"+(r.length-_-1),f)})}),u||this.updateEffect()}updateEffect(e=null,t=null,i=null,r,s,n){e||(e="",e+="#define BLUR_LEVEL "+(this._blurSteps.length-1)+`
`),super.updateEffect(e,t,i,r,s,n)}}var qc;(function(o){o[o.Low=0]="Low",o[o.Medium=1]="Medium",o[o.High=2]="High"})(qc||(qc={}));class bx extends ci{set focalLength(e){this._circleOfConfusion.focalLength=e}get focalLength(){return this._circleOfConfusion.focalLength}set fStop(e){this._circleOfConfusion.fStop=e}get fStop(){return this._circleOfConfusion.fStop}set focusDistance(e){this._circleOfConfusion.focusDistance=e}get focusDistance(){return this._circleOfConfusion.focusDistance}set lensSize(e){this._circleOfConfusion.lensSize=e}get lensSize(){return this._circleOfConfusion.lensSize}constructor(e,t,i=qc.Low,r=0,s=!1){super(e.getEngine(),"depth of field",()=>this._effects,!0),this._effects=[];const n=e.getEngine(),a=n.isWebGPU||n.webGLVersion>1?6:5;this._circleOfConfusion=new Ch("circleOfConfusion",t,1,null,Y.BILINEAR_SAMPLINGMODE,n,!1,r,s),this._depthOfFieldBlurY=[],this._depthOfFieldBlurX=[];let l=1,c=15;switch(i){case qc.High:{l=3,c=51;break}case qc.Medium:{l=2,c=31;break}default:{c=15,l=1;break}}const h=c/Math.pow(2,l-1);let u=1;for(let d=0;d<l;d++){const f=new af("vertical blur",e,new Ie(0,1),h,u,null,this._circleOfConfusion,d==0?this._circleOfConfusion:null,Y.BILINEAR_SAMPLINGMODE,n,!1,r,s,d==0?a:5);f.autoClear=!1,u=.75/Math.pow(2,d);const _=new af("horizontal blur",e,new Ie(1,0),h,u,null,this._circleOfConfusion,null,Y.BILINEAR_SAMPLINGMODE,n,!1,r,s);_.autoClear=!1,this._depthOfFieldBlurY.push(f),this._depthOfFieldBlurX.push(_)}this._effects=[this._circleOfConfusion];for(let d=0;d<this._depthOfFieldBlurX.length;d++)this._effects.push(this._depthOfFieldBlurY[d]),this._effects.push(this._depthOfFieldBlurX[d]);this._dofMerge=new yw("dofMerge",this._circleOfConfusion,this._circleOfConfusion,this._depthOfFieldBlurX,u,null,Y.BILINEAR_SAMPLINGMODE,n,!1,r,s),this._dofMerge.autoClear=!1,this._effects.push(this._dofMerge)}getClassName(){return"DepthOfFieldEffect"}set depthTexture(e){this._circleOfConfusion.depthTexture=e}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}const Cw="displayPassPixelShader",Aw=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D passSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
gl_FragColor=texture2D(passSampler,vUV);
}`;te.ShadersStore[Cw]=Aw;class Ym extends et{getClassName(){return"DisplayPassPostProcess"}constructor(e,t,i,r,s,n){super(e,"displayPass",["passSampler"],["passSampler"],t,i,r,s,n)}static _Parse(e,t,i,r){return ke.Parse(()=>new Ym(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}ye("BABYLON.DisplayPassPostProcess",Ym);const Rw="filterPixelShader",Iw=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform mat4 kernelMatrix;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec3 baseColor=texture2D(textureSampler,vUV).rgb;
vec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;
gl_FragColor=vec4(updatedColor,1.0);
}`;te.ShadersStore[Rw]=Iw;class Zf extends et{getClassName(){return"FilterPostProcess"}constructor(e,t,i,r,s,n,a){super(e,"filter",["kernelMatrix"],null,i,r,s,n,a),this.kernelMatrix=t,this.onApply=l=>{l.setMatrix("kernelMatrix",this.kernelMatrix)}}static _Parse(e,t,i,r){return ke.Parse(()=>new Zf(e.name,e.kernelMatrix,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}M([Zx()],Zf.prototype,"kernelMatrix",void 0);ye("BABYLON.FilterPostProcess",Zf);const Pw="fxaaPixelShader",Mw=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
uniform sampler2D textureSampler;
uniform vec2 texelSize;
varying vec2 vUV;
varying vec2 sampleCoordS;
varying vec2 sampleCoordE;
varying vec2 sampleCoordN;
varying vec2 sampleCoordW;
varying vec2 sampleCoordNW;
varying vec2 sampleCoordSE;
varying vec2 sampleCoordNE;
varying vec2 sampleCoordSW;
const float fxaaQualitySubpix=1.0;
const float fxaaQualityEdgeThreshold=0.166;
const float fxaaQualityEdgeThresholdMin=0.0833;
const vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);
#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)
void main(){
vec2 posM;
posM.x=vUV.x;
posM.y=vUV.y;
vec4 rgbyM=TEXTUREFUNC(textureSampler,vUV,0.0);
float lumaM=FxaaLuma(rgbyM);
float lumaS=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordS,0.0));
float lumaE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordE,0.0));
float lumaN=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordN,0.0));
float lumaW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordW,0.0));
float maxSM=max(lumaS,lumaM);
float minSM=min(lumaS,lumaM);
float maxESM=max(lumaE,maxSM);
float minESM=min(lumaE,minSM);
float maxWN=max(lumaN,lumaW);
float minWN=min(lumaN,lumaW);
float rangeMax=max(maxWN,maxESM);
float rangeMin=min(minWN,minESM);
float rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;
float range=rangeMax-rangeMin;
float rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);
#ifndef MALI
if(range<rangeMaxClamped) 
{
gl_FragColor=rgbyM;
return;
}
#endif
float lumaNW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNW,0.0));
float lumaSE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSE,0.0));
float lumaNE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNE,0.0));
float lumaSW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSW,0.0));
float lumaNS=lumaN+lumaS;
float lumaWE=lumaW+lumaE;
float subpixRcpRange=1.0/range;
float subpixNSWE=lumaNS+lumaWE;
float edgeHorz1=(-2.0*lumaM)+lumaNS;
float edgeVert1=(-2.0*lumaM)+lumaWE;
float lumaNESE=lumaNE+lumaSE;
float lumaNWNE=lumaNW+lumaNE;
float edgeHorz2=(-2.0*lumaE)+lumaNESE;
float edgeVert2=(-2.0*lumaN)+lumaNWNE;
float lumaNWSW=lumaNW+lumaSW;
float lumaSWSE=lumaSW+lumaSE;
float edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);
float edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);
float edgeHorz3=(-2.0*lumaW)+lumaNWSW;
float edgeVert3=(-2.0*lumaS)+lumaSWSE;
float edgeHorz=abs(edgeHorz3)+edgeHorz4;
float edgeVert=abs(edgeVert3)+edgeVert4;
float subpixNWSWNESE=lumaNWSW+lumaNESE;
float lengthSign=texelSize.x;
bool horzSpan=edgeHorz>=edgeVert;
float subpixA=subpixNSWE*2.0+subpixNWSWNESE;
if (!horzSpan)
{
lumaN=lumaW;
}
if (!horzSpan) 
{
lumaS=lumaE;
}
if (horzSpan) 
{
lengthSign=texelSize.y;
}
float subpixB=(subpixA*(1.0/12.0))-lumaM;
float gradientN=lumaN-lumaM;
float gradientS=lumaS-lumaM;
float lumaNN=lumaN+lumaM;
float lumaSS=lumaS+lumaM;
bool pairN=abs(gradientN)>=abs(gradientS);
float gradient=max(abs(gradientN),abs(gradientS));
if (pairN)
{
lengthSign=-lengthSign;
}
float subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);
vec2 posB;
posB.x=posM.x;
posB.y=posM.y;
vec2 offNP;
offNP.x=(!horzSpan) ? 0.0 : texelSize.x;
offNP.y=(horzSpan) ? 0.0 : texelSize.y;
if (!horzSpan) 
{
posB.x+=lengthSign*0.5;
}
if (horzSpan)
{
posB.y+=lengthSign*0.5;
}
vec2 posN;
posN.x=posB.x-offNP.x*1.5;
posN.y=posB.y-offNP.y*1.5;
vec2 posP;
posP.x=posB.x+offNP.x*1.5;
posP.y=posB.y+offNP.y*1.5;
float subpixD=((-2.0)*subpixC)+3.0;
float lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN,0.0));
float subpixE=subpixC*subpixC;
float lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP,0.0));
if (!pairN) 
{
lumaNN=lumaSS;
}
float gradientScaled=gradient*1.0/4.0;
float lumaMM=lumaM-lumaNN*0.5;
float subpixF=subpixD*subpixE;
bool lumaMLTZero=lumaMM<0.0;
lumaEndN-=lumaNN*0.5;
lumaEndP-=lumaNN*0.5;
bool doneN=abs(lumaEndN)>=gradientScaled;
bool doneP=abs(lumaEndP)>=gradientScaled;
if (!doneN) 
{
posN.x-=offNP.x*3.0;
}
if (!doneN) 
{
posN.y-=offNP.y*3.0;
}
bool doneNP=(!doneN) || (!doneP);
if (!doneP) 
{
posP.x+=offNP.x*3.0;
}
if (!doneP)
{
posP.y+=offNP.y*3.0;
}
if (doneNP)
{
if (!doneN) lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN.xy,0.0));
if (!doneP) lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP.xy,0.0));
if (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;
if (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;
doneN=abs(lumaEndN)>=gradientScaled;
doneP=abs(lumaEndP)>=gradientScaled;
if (!doneN) posN.x-=offNP.x*12.0;
if (!doneN) posN.y-=offNP.y*12.0;
doneNP=(!doneN) || (!doneP);
if (!doneP) posP.x+=offNP.x*12.0;
if (!doneP) posP.y+=offNP.y*12.0;
}
float dstN=posM.x-posN.x;
float dstP=posP.x-posM.x;
if (!horzSpan)
{
dstN=posM.y-posN.y;
}
if (!horzSpan) 
{
dstP=posP.y-posM.y;
}
bool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;
float spanLength=(dstP+dstN);
bool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;
float spanLengthRcp=1.0/spanLength;
bool directionN=dstN<dstP;
float dst=min(dstN,dstP);
bool goodSpan=directionN ? goodSpanN : goodSpanP;
float subpixG=subpixF*subpixF;
float pixelOffset=(dst*(-spanLengthRcp))+0.5;
float subpixH=subpixG*fxaaQualitySubpix;
float pixelOffsetGood=goodSpan ? pixelOffset : 0.0;
float pixelOffsetSubpix=max(pixelOffsetGood,subpixH);
if (!horzSpan)
{
posM.x+=pixelOffsetSubpix*lengthSign;
}
if (horzSpan)
{
posM.y+=pixelOffsetSubpix*lengthSign;
}
#ifdef MALI
if(range<rangeMaxClamped) 
{
gl_FragColor=rgbyM;
}
else
{
gl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);
}
#else
gl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);
#endif
}`;te.ShadersStore[Pw]=Mw;const Ow="fxaaVertexShader",Dw=`attribute vec2 position;
uniform vec2 texelSize;
varying vec2 vUV;
varying vec2 sampleCoordS;
varying vec2 sampleCoordE;
varying vec2 sampleCoordN;
varying vec2 sampleCoordW;
varying vec2 sampleCoordNW;
varying vec2 sampleCoordSE;
varying vec2 sampleCoordNE;
varying vec2 sampleCoordSW;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd);
sampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;
sampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;
sampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;
sampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;
sampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;
sampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;
sampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;
sampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;te.ShadersStore[Ow]=Dw;class Ah extends et{getClassName(){return"FxaaPostProcess"}constructor(e,t,i=null,r,s,n,a=0){super(e,"fxaa",["texelSize"],null,t,i,r||Y.BILINEAR_SAMPLINGMODE,s,n,null,a,"fxaa",void 0,!0);const l=this._getDefines();this.updateEffect(l),this.onApplyObservable.add(c=>{const h=this.texelSize;c.setFloat2("texelSize",h.x,h.y)})}_getDefines(){const e=this.getEngine();if(!e)return null;const t=e.getGlInfo();return t&&t.renderer&&t.renderer.toLowerCase().indexOf("mali")>-1?`#define MALI 1
`:null}static _Parse(e,t,i,r){return ke.Parse(()=>new Ah(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}ye("BABYLON.FxaaPostProcess",Ah);const Nw="grainPixelShader",ww=`#include<helperFunctions>
uniform sampler2D textureSampler; 
uniform float intensity;
uniform float animatedSeed;
varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
gl_FragColor=texture2D(textureSampler,vUV);
vec2 seed=vUV*(animatedSeed);
float grain=dither(seed,intensity);
float lum=getLuminance(gl_FragColor.rgb);
float grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;
gl_FragColor.rgb+=grain*grainAmount;
gl_FragColor.rgb=max(gl_FragColor.rgb,0.0);
}`;te.ShadersStore[Nw]=ww;class Rh extends et{getClassName(){return"GrainPostProcess"}constructor(e,t,i,r,s,n,a=0,l=!1){super(e,"grain",["intensity","animatedSeed"],[],t,i,r,s,n,null,a,void 0,null,l),this.intensity=30,this.animated=!1,this.onApplyObservable.add(c=>{c.setFloat("intensity",this.intensity),c.setFloat("animatedSeed",this.animated?Math.random()+1:1)})}static _Parse(e,t,i,r){return ke.Parse(()=>new Rh(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}M([F()],Rh.prototype,"intensity",void 0);M([F()],Rh.prototype,"animated",void 0);ye("BABYLON.GrainPostProcess",Rh);const Fw="highlightsPixelShader",Lw=`varying vec2 vUV;
uniform sampler2D textureSampler;
const vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
vec4 tex=texture2D(textureSampler,vUV);
vec3 c=tex.rgb;
float luma=dot(c.rgb,RGBLuminanceCoefficients);
gl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a); 
}`;te.ShadersStore[Fw]=Lw;const Bw="mrtFragmentDeclaration",Uw=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
layout(location=0) out vec4 glFragData[{X}];
#endif
`;te.IncludesShadersStore[Bw]=Uw;const Vw="geometryPixelShader",kw=`#extension GL_EXT_draw_buffers : require
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
precision highp float;
#ifdef BUMP
varying mat4 vWorldView;
varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#ifdef VELOCITY
varying vec4 vCurrentPosition;
varying vec4 vPreviousPosition;
#endif
#ifdef NEED_UV
varying vec2 vUV;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#if defined(REFLECTIVITY)
#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
uniform sampler2D reflectivitySampler;
varying vec2 vReflectivityUV;
#endif
#ifdef ALBEDOTEXTURE
varying vec2 vAlbedoUV;
uniform sampler2D albedoSampler;
#endif
#ifdef REFLECTIVITYCOLOR
uniform vec3 reflectivityColor;
#endif
#ifdef ALBEDOCOLOR
uniform vec3 albedoColor;
#endif
#ifdef METALLIC
uniform float metallic;
#endif
#ifdef ROUGHNESS
uniform float glossiness;
#endif
#endif
#if defined(ALPHATEST) && defined(NEED_UV)
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#include<mrtFragmentDeclaration>[RENDER_TARGET_COUNT]
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<helperFunctions>
void main() {
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
vec3 normalOutput;
#ifdef BUMP
vec3 normalW=normalize(vNormalW);
#include<bumpFragment>
normalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));
#else
normalOutput=normalize(vNormalV);
#endif
#ifdef PREPASS
#ifdef PREPASS_DEPTH
gl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);
#endif
#ifdef PREPASS_NORMAL
gl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);
#endif
#else
gl_FragData[0]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);
gl_FragData[1]=vec4(normalOutput,1.0);
#endif
#ifdef POSITION
gl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);
#endif
#ifdef VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);
#endif
#ifdef REFLECTIVITY
vec4 reflectivity=vec4(1.0,1.0,1.0,1.0);
#ifdef METALLICWORKFLOW
float metal=1.0;
float roughness=1.0;
#ifdef ORMTEXTURE
metal*=texture2D(reflectivitySampler,vReflectivityUV).b;
roughness*=texture2D(reflectivitySampler,vReflectivityUV).g;
#endif
#ifdef METALLIC
metal*=metallic;
#endif
#ifdef ROUGHNESS
roughness*=(1.0-glossiness); 
#endif
reflectivity.a-=roughness;
vec3 color=vec3(1.0);
#ifdef ALBEDOTEXTURE
color=texture2D(albedoSampler,vAlbedoUV).rgb;
#ifdef GAMMAALBEDO
color=toLinearSpace(color);
#endif
#endif
#ifdef ALBEDOCOLOR
color*=albedoColor.xyz;
#endif
reflectivity.rgb=mix(vec3(0.04),color,metal);
#else
#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
reflectivity=texture2D(reflectivitySampler,vReflectivityUV);
#ifdef GAMMAREFLECTIVITYTEXTURE
reflectivity.rgb=toLinearSpace(reflectivity.rgb);
#endif
#else 
#ifdef REFLECTIVITYCOLOR
reflectivity.rgb=reflectivityColor.xyz;
reflectivity.a=1.0;
#endif
#endif
#ifdef GLOSSINESSS
reflectivity.a*=glossiness; 
#endif
#endif
gl_FragData[REFLECTIVITY_INDEX]=reflectivity;
#endif
}
`;te.ShadersStore[Vw]=kw;const Gw="geometryVertexDeclaration",zw=`uniform mat4 viewProjection;
uniform mat4 view;`;te.IncludesShadersStore[Gw]=zw;const Hw="geometryUboDeclaration",Ww=`#include<sceneUboDeclaration>
`;te.IncludesShadersStore[Hw]=Ww;const Xw="geometryVertexShader",$w=`precision highp float;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
#include<__decl__geometryVertex>
#include<clipPlaneVertexDeclaration>
attribute vec3 position;
attribute vec3 normal;
#ifdef NEED_UV
varying vec2 vUV;
#ifdef ALPHATEST
uniform mat4 diffuseMatrix;
#endif
#ifdef BUMP
uniform mat4 bumpMatrix;
varying vec2 vBumpUV;
#endif
#ifdef REFLECTIVITY
uniform mat4 reflectivityMatrix;
uniform mat4 albedoMatrix;
varying vec2 vReflectivityUV;
varying vec2 vAlbedoUV;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#ifdef BUMP
varying mat4 vWorldView;
#endif
#ifdef BUMP
varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#ifdef VELOCITY
uniform mat4 previousViewProjection;
varying vec4 vCurrentPosition;
varying vec4 vPreviousPosition;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#if defined(VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=vec4(finalWorld*vec4(positionUpdated,1.0));
#ifdef BUMP
vWorldView=view*finalWorld;
vNormalW=normalUpdated;
#else
vNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));
#endif
vViewPos=view*worldPos;
#if defined(VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;
previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
#if defined(POSITION) || defined(BUMP)
vPositionW=worldPos.xyz/worldPos.w;
#endif
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#include<clipPlaneVertex>
#ifdef NEED_UV
#ifdef UV1
#if defined(ALPHATEST) && defined(ALPHATEST_UV1)
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#else
vUV=uv;
#endif
#ifdef BUMP_UV1
vBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV1
vReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef ALBEDO_UV1
vAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#endif
#ifdef UV2
#if defined(ALPHATEST) && defined(ALPHATEST_UV2)
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#else
vUV=uv2;
#endif
#ifdef BUMP_UV2
vBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV2
vReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));
#endif
#ifdef ALBEDO_UV2
vAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#endif
#include<bumpVertex>
}
`;te.ShadersStore[Xw]=$w;const DE=["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];ja(DE);class Qi{_linkPrePassRenderer(e){this._linkedWithPrePass=!0,this._prePassRenderer=e,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add(()=>{}))}_unlinkPrePassRenderer(){this._linkedWithPrePass=!1,this._createRenderTargets()}_resetLayout(){this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._attachments=[]}_forceTextureType(e,t){e===Qi.POSITION_TEXTURE_TYPE?(this._positionIndex=t,this._enablePosition=!0):e===Qi.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=t,this._enableVelocity=!0):e===Qi.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=t,this._enableReflectivity=!0):e===Qi.DEPTH_TEXTURE_TYPE?this._depthIndex=t:e===Qi.NORMAL_TEXTURE_TYPE&&(this._normalIndex=t)}_setAttachments(e){this._attachments=e}_linkInternalTexture(e){this._multiRenderTarget.setInternalTexture(e,0,!1)}get renderList(){return this._multiRenderTarget.renderList}set renderList(e){this._multiRenderTarget.renderList=e}get isSupported(){return this._multiRenderTarget.isSupported}getTextureIndex(e){switch(e){case Qi.POSITION_TEXTURE_TYPE:return this._positionIndex;case Qi.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case Qi.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;default:return-1}}get enablePosition(){return this._enablePosition}set enablePosition(e){this._enablePosition=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableVelocity(){return this._enableVelocity}set enableVelocity(e){this._enableVelocity=e,e||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=e}get enableReflectivity(){return this._enableReflectivity}set enableReflectivity(e){this._enableReflectivity=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get scene(){return this._scene}get ratio(){return this._ratio}constructor(e,t=1,i=15){this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this._resizeObserver=null,this._enablePosition=!1,this._enableVelocity=!1,this._enableReflectivity=!1,this._positionIndex=-1,this._velocityIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._linkedWithPrePass=!1,this._specularColorLinear=new ge,this._scene=e,this._ratio=t,this._useUbo=e.getEngine().supportsUniformBuffers,this._depthFormat=i,Qi._SceneComponentInitialization(this._scene),this._createRenderTargets()}isReady(e,t){const i=e.getMaterial();if(i&&i.disableDepthWrite)return!1;const r=[],s=[O.PositionKind,O.NormalKind],n=e.getMesh();if(i){let f=!1;if(i.needAlphaTesting()&&i.getAlphaTestTexture()&&(r.push("#define ALPHATEST"),r.push(`#define ALPHATEST_UV${i.getAlphaTestTexture().coordinatesIndex+1}`),f=!0),i.bumpTexture&&Me.BumpTextureEnabled&&(r.push("#define BUMP"),r.push(`#define BUMP_UV${i.bumpTexture.coordinatesIndex+1}`),f=!0),this._enableReflectivity){let _=!1;i.getClassName()==="PBRMetallicRoughnessMaterial"?(i.metallicRoughnessTexture!==null&&(r.push("#define ORMTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.metallicRoughnessTexture.coordinatesIndex+1}`),r.push("#define METALLICWORKFLOW"),f=!0,_=!0),i.metallic!==null&&(r.push("#define METALLIC"),r.push("#define METALLICWORKFLOW"),_=!0),i.roughness!==null&&(r.push("#define ROUGHNESS"),r.push("#define METALLICWORKFLOW"),_=!0),_&&(i.baseTexture!==null&&(r.push("#define ALBEDOTEXTURE"),r.push(`#define ALBEDO_UV${i.baseTexture.coordinatesIndex+1}`),i.baseTexture.gammaSpace&&r.push("#define GAMMAALBEDO"),f=!0),i.baseColor!==null&&r.push("#define ALBEDOCOLOR"))):i.getClassName()==="PBRSpecularGlossinessMaterial"?(i.specularGlossinessTexture!==null?(r.push("#define SPECULARGLOSSINESSTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.specularGlossinessTexture.coordinatesIndex+1}`),f=!0,i.specularGlossinessTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE")):i.specularColor!==null&&r.push("#define REFLECTIVITYCOLOR"),i.glossiness!==null&&r.push("#define GLOSSINESSS")):i.getClassName()==="PBRMaterial"?(i.metallicTexture!==null&&(r.push("#define ORMTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.metallicTexture.coordinatesIndex+1}`),r.push("#define METALLICWORKFLOW"),f=!0,_=!0),i.metallic!==null&&(r.push("#define METALLIC"),r.push("#define METALLICWORKFLOW"),_=!0),i.roughness!==null&&(r.push("#define ROUGHNESS"),r.push("#define METALLICWORKFLOW"),_=!0),_?(i.albedoTexture!==null&&(r.push("#define ALBEDOTEXTURE"),r.push(`#define ALBEDO_UV${i.albedoTexture.coordinatesIndex+1}`),i.albedoTexture.gammaSpace&&r.push("#define GAMMAALBEDO"),f=!0),i.albedoColor!==null&&r.push("#define ALBEDOCOLOR")):(i.reflectivityTexture!==null?(r.push("#define SPECULARGLOSSINESSTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.reflectivityTexture.coordinatesIndex+1}`),i.reflectivityTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE"),f=!0):i.reflectivityColor!==null&&r.push("#define REFLECTIVITYCOLOR"),i.microSurface!==null&&r.push("#define GLOSSINESSS"))):i.getClassName()==="StandardMaterial"&&(i.specularTexture!==null&&(r.push("#define REFLECTIVITYTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.specularTexture.coordinatesIndex+1}`),i.specularTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE"),f=!0),i.specularColor!==null&&r.push("#define REFLECTIVITYCOLOR"))}f&&(r.push("#define NEED_UV"),n.isVerticesDataPresent(O.UVKind)&&(s.push(O.UVKind),r.push("#define UV1")),n.isVerticesDataPresent(O.UV2Kind)&&(s.push(O.UV2Kind),r.push("#define UV2")))}this._linkedWithPrePass&&(r.push("#define PREPASS"),this._depthIndex!==-1&&(r.push("#define DEPTH_INDEX "+this._depthIndex),r.push("#define PREPASS_DEPTH")),this._normalIndex!==-1&&(r.push("#define NORMAL_INDEX "+this._normalIndex),r.push("#define PREPASS_NORMAL"))),this._enablePosition&&(r.push("#define POSITION"),r.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(r.push("#define VELOCITY"),r.push("#define VELOCITY_INDEX "+this._velocityIndex),this.excludedSkinnedMeshesFromVelocity.indexOf(n)===-1&&r.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(r.push("#define REFLECTIVITY"),r.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),n.useBones&&n.computeBonesUsingShaders?(s.push(O.MatricesIndicesKind),s.push(O.MatricesWeightsKind),n.numBoneInfluencers>4&&(s.push(O.MatricesIndicesExtraKind),s.push(O.MatricesWeightsExtraKind)),r.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),r.push("#define BonesPerMesh "+(n.skeleton?n.skeleton.bones.length+1:0))):r.push("#define NUM_BONE_INFLUENCERS 0");const a=n.morphTargetManager;let l=0;a&&a.numInfluencers>0&&(l=a.numInfluencers,r.push("#define MORPHTARGETS"),r.push("#define NUM_MORPH_INFLUENCERS "+l),a.isUsingTextureForTargets&&r.push("#define MORPHTARGETS_TEXTURE"),Ce.PrepareAttributesForMorphTargetsInfluencers(s,n,l)),t&&(r.push("#define INSTANCES"),Ce.PushAttributesForInstances(s,this._enableVelocity),e.getRenderingMesh().hasThinInstances&&r.push("#define THIN_INSTANCES")),this._linkedWithPrePass?r.push("#define RENDER_TARGET_COUNT "+this._attachments.length):r.push("#define RENDER_TARGET_COUNT "+this._multiRenderTarget.textures.length),Zo(i,this._scene,r);const c=this._scene.getEngine(),h=e._getDrawWrapper(void 0,!0),u=h.defines,d=r.join(`
`);return u!==d&&h.setEffect(c.createEffect("geometry",{attributes:s,uniformsNames:DE,samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets"],defines:d,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:l}},c),d),h.effect.isReady()}getGBuffer(){return this._multiRenderTarget}get samples(){return this._multiRenderTarget.samples}set samples(e){this._multiRenderTarget.samples=e}dispose(){this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.getGBuffer().dispose()}_assignRenderTargetIndices(){const e=[];let t=2;return e.push("gBuffer_Depth","gBuffer_Normal"),this._enablePosition&&(this._positionIndex=t,t++,e.push("gBuffer_Position")),this._enableVelocity&&(this._velocityIndex=t,t++,e.push("gBuffer_Velocity")),this._enableReflectivity&&(this._reflectivityIndex=t,t++,e.push("gBuffer_Reflectivity")),[t,e]}_createRenderTargets(){const e=this._scene.getEngine(),[t,i]=this._assignRenderTargetIndices();let r=0;if(e._caps.textureFloat&&e._caps.textureFloatLinearFiltering?r=1:e._caps.textureHalfFloat&&e._caps.textureHalfFloatLinearFiltering&&(r=2),this._multiRenderTarget=new tc("gBuffer",{width:e.getRenderWidth()*this._ratio,height:e.getRenderHeight()*this._ratio},t,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,defaultType:r,depthTextureFormat:this._depthFormat},i.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this._multiRenderTarget.wrapU=Y.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=Y.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null,this._multiRenderTarget.onClearObservable.add(n=>{n.clear(new Ye(0,0,0,0),!0,!0,!0)}),this._resizeObserver=e.onResizeObservable.add(()=>{this._multiRenderTarget&&this._multiRenderTarget.resize({width:e.getRenderWidth()*this._ratio,height:e.getRenderHeight()*this._ratio})});const s=n=>{const a=n.getRenderingMesh(),l=n.getEffectiveMesh(),c=this._scene,h=c.getEngine(),u=n.getMaterial();if(!u)return;if(l._internalAbstractMeshDataInfo._isActiveIntermediate=!1,this._enableVelocity&&!this._previousTransformationMatrices[l.uniqueId]&&(this._previousTransformationMatrices[l.uniqueId]={world:H.Identity(),viewProjection:c.getTransformMatrix()},a.skeleton)){const p=a.skeleton.getTransformMatrices(a);this._previousBonesTransformationMatrices[a.uniqueId]=this._copyBonesTransformationMatrices(p,new Float32Array(p.length))}const d=a._getInstancesRenderList(n._id,!!n.getReplacementMesh());if(d.mustReturn)return;const f=h.getCaps().instancedArrays&&(d.visibleInstances[n._id]!==null||a.hasThinInstances),_=l.getWorldMatrix();if(this.isReady(n,f)){const p=n._getDrawWrapper();if(!p)return;const m=p.effect;h.enableEffect(p),f||a._bind(n,m,u.fillMode),this._useUbo?(Ce.BindSceneUniformBuffer(m,this._scene.getSceneUniformBuffer()),this._scene.finalizeSceneUbo()):(m.setMatrix("viewProjection",c.getTransformMatrix()),m.setMatrix("view",c.getViewMatrix()));let T;const b=a._instanceDataStorage;if(!b.isFrozen&&(u.backFaceCulling||a.overrideMaterialSideOrientation!==null)){const y=l._getWorldMatrixDeterminant();T=a.overrideMaterialSideOrientation,T===null&&(T=u.sideOrientation),y<0&&(T=T===me.ClockWiseSideOrientation?me.CounterClockWiseSideOrientation:me.ClockWiseSideOrientation)}else T=b.sideOrientation;if(u._preBind(p,T),u.needAlphaTesting()){const y=u.getAlphaTestTexture();y&&(m.setTexture("diffuseSampler",y),m.setMatrix("diffuseMatrix",y.getTextureMatrix()))}u.bumpTexture&&c.getEngine().getCaps().standardDerivatives&&Me.BumpTextureEnabled&&(m.setFloat3("vBumpInfos",u.bumpTexture.coordinatesIndex,1/u.bumpTexture.level,u.parallaxScaleBias),m.setMatrix("bumpMatrix",u.bumpTexture.getTextureMatrix()),m.setTexture("bumpSampler",u.bumpTexture),m.setFloat2("vTangentSpaceParams",u.invertNormalMapX?-1:1,u.invertNormalMapY?-1:1)),this._enableReflectivity&&(u.getClassName()==="PBRMetallicRoughnessMaterial"?(u.metallicRoughnessTexture!==null&&(m.setTexture("reflectivitySampler",u.metallicRoughnessTexture),m.setMatrix("reflectivityMatrix",u.metallicRoughnessTexture.getTextureMatrix())),u.metallic!==null&&m.setFloat("metallic",u.metallic),u.roughness!==null&&m.setFloat("glossiness",1-u.roughness),u.baseTexture!==null&&(m.setTexture("albedoSampler",u.baseTexture),m.setMatrix("albedoMatrix",u.baseTexture.getTextureMatrix())),u.baseColor!==null&&m.setColor3("albedoColor",u.baseColor)):u.getClassName()==="PBRSpecularGlossinessMaterial"?(u.specularGlossinessTexture!==null?(m.setTexture("reflectivitySampler",u.specularGlossinessTexture),m.setMatrix("reflectivityMatrix",u.specularGlossinessTexture.getTextureMatrix())):u.specularColor!==null&&(u.specularColor.toLinearSpaceToRef(this._specularColorLinear),m.setColor3("reflectivityColor",this._specularColorLinear)),u.glossiness!==null&&m.setFloat("glossiness",u.glossiness)):u.getClassName()==="PBRMaterial"?(u.metallicTexture!==null&&(m.setTexture("reflectivitySampler",u.metallicTexture),m.setMatrix("reflectivityMatrix",u.metallicTexture.getTextureMatrix())),u.metallic!==null&&m.setFloat("metallic",u.metallic),u.roughness!==null&&m.setFloat("glossiness",1-u.roughness),u.roughness!==null||u.metallic!==null||u.metallicTexture!==null?(u.albedoTexture!==null&&(m.setTexture("albedoSampler",u.albedoTexture),m.setMatrix("albedoMatrix",u.albedoTexture.getTextureMatrix())),u.albedoColor!==null&&m.setColor3("albedoColor",u.albedoColor)):(u.reflectivityTexture!==null?(m.setTexture("reflectivitySampler",u.reflectivityTexture),m.setMatrix("reflectivityMatrix",u.reflectivityTexture.getTextureMatrix())):u.reflectivityColor!==null&&m.setColor3("reflectivityColor",u.reflectivityColor),u.microSurface!==null&&m.setFloat("glossiness",u.microSurface))):u.getClassName()==="StandardMaterial"&&(u.specularTexture!==null&&(m.setTexture("reflectivitySampler",u.specularTexture),m.setMatrix("reflectivityMatrix",u.specularTexture.getTextureMatrix())),u.specularColor!==null&&m.setColor3("reflectivityColor",u.specularColor))),Ra(m,u,this._scene),a.useBones&&a.computeBonesUsingShaders&&a.skeleton&&(m.setMatrices("mBones",a.skeleton.getTransformMatrices(a)),this._enableVelocity&&m.setMatrices("mPreviousBones",this._previousBonesTransformationMatrices[a.uniqueId])),Ce.BindMorphTargetParameters(a,m),a.morphTargetManager&&a.morphTargetManager.isUsingTextureForTargets&&a.morphTargetManager._bind(m),this._enableVelocity&&(m.setMatrix("previousWorld",this._previousTransformationMatrices[l.uniqueId].world),m.setMatrix("previousViewProjection",this._previousTransformationMatrices[l.uniqueId].viewProjection)),f&&a.hasThinInstances&&m.setMatrix("world",_),a._processRendering(l,n,m,u.fillMode,d,f,(y,S)=>{y||m.setMatrix("world",S)})}this._enableVelocity&&(this._previousTransformationMatrices[l.uniqueId].world=_.clone(),this._previousTransformationMatrices[l.uniqueId].viewProjection=this._scene.getTransformMatrix().clone(),a.skeleton&&this._copyBonesTransformationMatrices(a.skeleton.getTransformMatrices(a),this._previousBonesTransformationMatrices[l.uniqueId]))};this._multiRenderTarget.customIsReadyFunction=(n,a,l)=>{if((l||a===0)&&n.subMeshes)for(let c=0;c<n.subMeshes.length;++c){const h=n.subMeshes[c],u=h.getMaterial(),d=h.getRenderingMesh();if(!u)continue;const f=d._getInstancesRenderList(h._id,!!h.getReplacementMesh()),_=e.getCaps().instancedArrays&&(f.visibleInstances[h._id]!==null||d.hasThinInstances);if(!this.isReady(h,_))return!1}return!0},this._multiRenderTarget.customRenderFunction=(n,a,l,c)=>{let h;if(this._linkedWithPrePass){if(!this._prePassRenderer.enabled)return;this._scene.getEngine().bindAttachments(this._attachments)}if(c.length){for(e.setColorWrite(!1),h=0;h<c.length;h++)s(c.data[h]);e.setColorWrite(!0)}for(h=0;h<n.length;h++)s(n.data[h]);for(e.setDepthWrite(!1),h=0;h<a.length;h++)s(a.data[h]);if(this.renderTransparentMeshes)for(h=0;h<l.length;h++)s(l.data[h]);e.setDepthWrite(!0)}}_copyBonesTransformationMatrices(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t}}Qi.DEPTH_TEXTURE_TYPE=0;Qi.NORMAL_TEXTURE_TYPE=1;Qi.POSITION_TEXTURE_TYPE=2;Qi.VELOCITY_TEXTURE_TYPE=3;Qi.REFLECTIVITY_TEXTURE_TYPE=4;Qi._SceneComponentInitialization=o=>{throw pt("GeometryBufferRendererSceneComponent")};class Yw{constructor(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}}Object.defineProperty(Ne.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(o){o&&o.isSupported&&(this._geometryBufferRenderer=o)},enumerable:!0,configurable:!0});Ne.prototype.enableGeometryBufferRenderer=function(o=1,e=15){return this._geometryBufferRenderer?this._geometryBufferRenderer:(this._geometryBufferRenderer=new Qi(this,o,e),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null),this._geometryBufferRenderer)};Ne.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};class jw{constructor(e){this.name=Re.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Re.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())}}Qi._SceneComponentInitialization=o=>{let e=o._getComponent(Re.NAME_GEOMETRYBUFFERRENDERER);e||(e=new jw(o),o._addComponent(e))};const Kw="motionBlurPixelShader",qw=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform float motionStrength;
uniform float motionScale;
uniform vec2 screenSize;
#ifdef OBJECT_BASED
uniform sampler2D velocitySampler;
#else
uniform sampler2D depthSampler;
uniform mat4 inverseViewProjection;
uniform mat4 prevViewProjection;
uniform mat4 projection;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#ifdef GEOMETRY_SUPPORTED
#ifdef OBJECT_BASED
vec2 texelSize=1.0/screenSize;
vec4 velocityColor=texture2D(velocitySampler,vUV);
velocityColor.rg=velocityColor.rg*2.0-vec2(1.0);
vec2 velocity=vec2(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0))*velocityColor.a;
velocity*=motionScale*motionStrength;
float speed=length(velocity/texelSize);
int samplesCount=int(clamp(speed,1.0,SAMPLES));
velocity=normalize(velocity)*texelSize;
float hlim=float(-samplesCount)*0.5+0.5;
vec4 result=texture2D(textureSampler,vUV);
for (int i=1; i<int(SAMPLES); ++i)
{
if (i>=samplesCount)
break;
vec2 offset=vUV+velocity*(hlim+float(i));
result+=texture2D(textureSampler,offset);
}
gl_FragColor=result/float(samplesCount);
gl_FragColor.a=1.0;
#else
vec2 texelSize=1.0/screenSize;
float depth=texture2D(depthSampler,vUV).r;
depth=projection[2].z+projection[3].z/depth; 
vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);
cpos=inverseViewProjection*cpos;
cpos/=cpos.w;
vec4 ppos=prevViewProjection*cpos;
ppos/=ppos.w;
ppos.xy=ppos.xy*0.5+0.5;
vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;
float speed=length(velocity/texelSize);
int nSamples=int(clamp(speed,1.0,SAMPLES));
vec4 result=texture2D(textureSampler,vUV);
for (int i=1; i<int(SAMPLES); ++i) {
if (i>=nSamples)
break;
vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);
result+=texture2D(textureSampler,offset1);
}
gl_FragColor=result/float(nSamples);
#endif
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;te.ShadersStore[Kw]=qw;class Ec extends et{get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this._motionBlurSamples=e,this._updateEffect()}get isObjectBased(){return this._isObjectBased}set isObjectBased(e){this._isObjectBased!==e&&(this._isObjectBased=e,this._applyMode())}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"MotionBlurPostProcess"}constructor(e,t,i,r,s,n,a,l=0,c=!1,h=!1){super(e,"motionBlur",["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection","projection"],["velocitySampler","depthSampler"],i,r,s,n,a,`#define GEOMETRY_SUPPORTED
#define SAMPLES 64.0
#define OBJECT_BASED`,l,void 0,null,c),this.motionStrength=1,this._motionBlurSamples=32,this._isObjectBased=!0,this._forceGeometryBuffer=!1,this._invViewProjection=null,this._previousViewProjection=null,this._forceGeometryBuffer=h,this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=!0)):(t.enablePrePassRenderer(),this._prePassRenderer&&(this._prePassRenderer.markAsDirty(),this._prePassEffectConfiguration=new Yw)),this._applyMode()}excludeSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else if(this._prePassRenderer)t=this._prePassRenderer.excludedSkinnedMesh;else return;t.push(e)}}removeExcludedSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else if(this._prePassRenderer)t=this._prePassRenderer.excludedSkinnedMesh;else return;const i=t.indexOf(e);i!==-1&&t.splice(i,1)}}dispose(e){this._geometryBufferRenderer&&(this._geometryBufferRenderer._previousTransformationMatrices={},this._geometryBufferRenderer._previousBonesTransformationMatrices={},this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity=[]),super.dispose(e)}_applyMode(){if(!this._geometryBufferRenderer&&!this._prePassRenderer)return X.Warn("Multiple Render Target support needed to compute object based motion blur"),this.updateEffect();this._updateEffect(),this._invViewProjection=null,this._previousViewProjection=null,this.isObjectBased?(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=2),this.onApply=e=>this._onApplyObjectBased(e)):(this._invViewProjection=H.Identity(),this._previousViewProjection=this._scene.getTransformMatrix().clone(),this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=5),this.onApply=e=>this._onApplyScreenBased(e))}_onApplyObjectBased(e){if(e.setVector2("screenSize",new Ie(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(Qi.VELOCITY_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(2);e.setTexture("velocitySampler",this._prePassRenderer.getRenderTarget().textures[t])}}_onApplyScreenBased(e){const t=j.Matrix[0];if(t.copyFrom(this._scene.getTransformMatrix()),t.invertToRef(this._invViewProjection),e.setMatrix("inverseViewProjection",this._invViewProjection),e.setMatrix("prevViewProjection",this._previousViewProjection),this._previousViewProjection.copyFrom(t),e.setMatrix("projection",this._scene.getProjectionMatrix()),e.setVector2("screenSize",new Ie(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const i=this._geometryBufferRenderer.getTextureIndex(Qi.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[i])}else if(this._prePassRenderer){const i=this._prePassRenderer.getIndex(5);e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[i])}}_updateEffect(){if(this._geometryBufferRenderer||this._prePassRenderer){const e=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this._motionBlurSamples.toFixed(1),this._isObjectBased?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(e.join(`
`))}}static _Parse(e,t,i,r){return ke.Parse(()=>new Ec(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1),e,i,r)}}M([F()],Ec.prototype,"motionStrength",void 0);M([F()],Ec.prototype,"motionBlurSamples",null);M([F()],Ec.prototype,"isObjectBased",null);ye("BABYLON.MotionBlurPostProcess",Ec);const Qw="refractionPixelShader",Zw=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D refractionSampler;
uniform vec3 baseColor;
uniform float depth;
uniform float colorLevel;
void main() {
float ref=1.0-texture2D(refractionSampler,vUV).r;
vec2 uv=vUV-vec2(0.5);
vec2 offset=uv*depth*ref;
vec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;
gl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);
}`;te.ShadersStore[Qw]=Zw;class bc extends et{get refractionTexture(){return this._refTexture}set refractionTexture(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1}getClassName(){return"RefractionPostProcess"}constructor(e,t,i,r,s,n,a,l,c,h){super(e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],n,a,l,c,h),this._ownRefractionTexture=!0,this.color=i,this.depth=r,this.colorLevel=s,this.refractionTextureUrl=t,this.onActivateObservable.add(u=>{this._refTexture=this._refTexture||new Y(t,u.getScene())}),this.onApplyObservable.add(u=>{u.setColor3("baseColor",this.color),u.setFloat("depth",this.depth),u.setFloat("colorLevel",this.colorLevel),u.setTexture("refractionSampler",this._refTexture)})}dispose(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),super.dispose(e)}static _Parse(e,t,i,r){return ke.Parse(()=>new bc(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}M([F()],bc.prototype,"color",void 0);M([F()],bc.prototype,"depth",void 0);M([F()],bc.prototype,"colorLevel",void 0);M([F()],bc.prototype,"refractionTextureUrl",void 0);ye("BABYLON.RefractionPostProcess",bc);const Jw="sharpenPixelShader",eF=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 screenSize;
uniform vec2 sharpnessAmounts;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec2 onePixel=vec2(1.0,1.0)/screenSize;
vec4 color=texture2D(textureSampler,vUV);
vec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +
texture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(0,1)) -
color*4.0;
gl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);
}`;te.ShadersStore[Jw]=eF;class Ih extends et{getClassName(){return"SharpenPostProcess"}constructor(e,t,i,r,s,n,a=0,l=!1){super(e,"sharpen",["sharpnessAmounts","screenSize"],null,t,i,r,s,n,null,a,void 0,null,l),this.colorAmount=1,this.edgeAmount=.3,this.onApply=c=>{c.setFloat2("screenSize",this.width,this.height),c.setFloat2("sharpnessAmounts",this.edgeAmount,this.colorAmount)}}static _Parse(e,t,i,r){return ke.Parse(()=>new Ih(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,r)}}M([F()],Ih.prototype,"colorAmount",void 0);M([F()],Ih.prototype,"edgeAmount",void 0);ye("BABYLON.SharpenPostProcess",Ih);class Ph{get name(){return this._name}get cameras(){return this._cameras}constructor(e,t){this._engine=e,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}getClassName(){return"PostProcessRenderPipeline"}get isSupported(){for(const e in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&!this._renderEffects[e].isSupported)return!1;return!0}addEffect(e){this._renderEffects[e._name]=e}_rebuild(){}_enableEffect(e,t){const i=this._renderEffects[e];i&&i._enable(J.MakeArray(t||this._cameras))}_disableEffect(e,t){const i=this._renderEffects[e];i&&i._disable(J.MakeArray(t||this._cameras))}_attachCameras(e,t){const i=J.MakeArray(e||this._cameras);if(!i)return;const r=[];let s;for(s=0;s<i.length;s++){const n=i[s];n&&(this._cameras.indexOf(n)===-1?this._cameras.push(n):t&&r.push(s))}for(s=0;s<r.length;s++)i.splice(r[s],1);for(const n in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,n)&&this._renderEffects[n]._attachCameras(i)}_detachCameras(e){const t=J.MakeArray(e||this._cameras);if(t){for(const i in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,i)&&this._renderEffects[i]._detachCameras(t);for(let i=0;i<t.length;i++)this._cameras.splice(this._cameras.indexOf(t[i]),1)}}_update(){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._update();for(let e=0;e<this._cameras.length;e++){if(!this._cameras[e])continue;const t=this._cameras[e].name;this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()}}_reset(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array}_enableMSAAOnFirstPostProcess(e){if(!this._engine._features.supportMSAA)return!1;const t=Object.keys(this._renderEffects);if(t.length>0){const i=this._renderEffects[t[0]].getPostProcesses();i&&(i[0].samples=e)}return!0}setPrePassRenderer(e){return!1}dispose(){}}M([F()],Ph.prototype,"_name",void 0);class tF{constructor(){this._renderPipelines={}}get supportedPipelines(){const e=[];for(const t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){const i=this._renderPipelines[t];i.isSupported&&e.push(i)}return e}addPipeline(e){this._renderPipelines[e._name]=e}attachCamerasToRenderPipeline(e,t,i=!1){const r=this._renderPipelines[e];r&&r._attachCameras(t,i)}detachCamerasFromRenderPipeline(e,t){const i=this._renderPipelines[e];i&&i._detachCameras(t)}enableEffectInPipeline(e,t,i){const r=this._renderPipelines[e];r&&r._enableEffect(t,i)}disableEffectInPipeline(e,t,i){const r=this._renderPipelines[e];r&&r._disableEffect(t,i)}update(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){const t=this._renderPipelines[e];t.isSupported?t._update():(t.dispose(),delete this._renderPipelines[e])}}_rebuild(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e]._rebuild()}dispose(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e].dispose()}}Object.defineProperty(Ne.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let o=this._getComponent(Re.NAME_POSTPROCESSRENDERPIPELINEMANAGER);o||(o=new iF(this),this._addComponent(o)),this._postProcessRenderPipelineManager=new tF}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});class iF{constructor(e){this.name=Re.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Re.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}}class Ts extends Ph{get automaticBuild(){return this._buildAllowed}set automaticBuild(e){this._buildAllowed=e}get scene(){return this._scene}set sharpenEnabled(e){this._sharpenEnabled!==e&&(this._sharpenEnabled=e,this._buildPipeline())}get sharpenEnabled(){return this._sharpenEnabled}get bloomKernel(){return this._bloomKernel}set bloomKernel(e){this._bloomKernel=e,this.bloom.kernel=e/this._hardwareScaleLevel}set bloomWeight(e){this._bloomWeight!==e&&(this.bloom.weight=e,this._bloomWeight=e)}get bloomWeight(){return this._bloomWeight}set bloomThreshold(e){this._bloomThreshold!==e&&(this.bloom.threshold=e,this._bloomThreshold=e)}get bloomThreshold(){return this._bloomThreshold}set bloomScale(e){this._bloomScale!==e&&(this._bloomScale=e,this._rebuildBloom(),this._buildPipeline())}get bloomScale(){return this._bloomScale}set bloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get bloomEnabled(){return this._bloomEnabled}_rebuildBloom(){const e=this.bloom;this.bloom=new Ex(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(let t=0;t<this._cameras.length;t++)e.disposeEffects(this._cameras[t])}get depthOfFieldEnabled(){return this._depthOfFieldEnabled}set depthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get depthOfFieldBlurLevel(){return this._depthOfFieldBlurLevel}set depthOfFieldBlurLevel(e){if(this._depthOfFieldBlurLevel===e)return;this._depthOfFieldBlurLevel=e;const t=this.depthOfField;this.depthOfField=new bx(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=t.focalLength,this.depthOfField.focusDistance=t.focusDistance,this.depthOfField.fStop=t.fStop,this.depthOfField.lensSize=t.lensSize;for(let i=0;i<this._cameras.length;i++)t.disposeEffects(this._cameras[i]);this._buildPipeline()}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}set imageProcessingEnabled(e){this._imageProcessingEnabled!==e&&(this._scene.imageProcessingConfiguration.isEnabled=e)}get imageProcessingEnabled(){return this._imageProcessingEnabled}set glowLayerEnabled(e){e&&!this._glowLayer?this._glowLayer=new ua("",this._scene):!e&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)}get glowLayerEnabled(){return this._glowLayer!=null}get glowLayer(){return this._glowLayer}set chromaticAberrationEnabled(e){this._chromaticAberrationEnabled!==e&&(this._chromaticAberrationEnabled=e,this._buildPipeline())}get chromaticAberrationEnabled(){return this._chromaticAberrationEnabled}set grainEnabled(e){this._grainEnabled!==e&&(this._grainEnabled=e,this._buildPipeline())}get grainEnabled(){return this._grainEnabled}constructor(e="",t=!0,i=qe.LastCreatedScene,r,s=!0){super(i.getEngine(),e),this._camerasToBeAttached=[],this.SharpenPostProcessId="SharpenPostProcessEffect",this.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",this.FxaaPostProcessId="FxaaPostProcessEffect",this.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",this.GrainPostProcessId="GrainPostProcessEffect",this._glowLayer=null,this.animations=[],this._imageProcessingConfigurationObserver=null,this._sharpenEnabled=!1,this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._depthOfFieldBlurLevel=qc.Low,this._fxaaEnabled=!1,this._imageProcessingEnabled=!0,this._bloomScale=.5,this._chromaticAberrationEnabled=!1,this._grainEnabled=!1,this._buildAllowed=!0,this.onBuildObservable=new Q,this._resizeObserver=null,this._hardwareScaleLevel=1,this._bloomKernel=64,this._bloomWeight=.15,this._bloomThreshold=.9,this._samples=1,this._hasCleared=!1,this._prevPostProcess=null,this._prevPrevPostProcess=null,this._depthOfFieldSceneObserver=null,this._activeCameraChangedObserver=null,this._activeCamerasChangedObserver=null,this._cameras=r||i.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._buildAllowed=s,this._scene=i;const n=this._scene.getEngine().getCaps();this._hdr=t&&(n.textureHalfFloatRender||n.textureFloatRender),this._hdr?n.textureHalfFloatRender?this._defaultPipelineTextureType=2:n.textureFloatRender&&(this._defaultPipelineTextureType=1):this._defaultPipelineTextureType=0,i.postProcessRenderPipelineManager.addPipeline(this);const a=this._scene.getEngine();this.sharpen=new Ih("sharpen",1,null,Y.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._sharpenEffect=new ci(a,this.SharpenPostProcessId,()=>this.sharpen,!0),this.depthOfField=new bx(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!0),this._hardwareScaleLevel=a.getHardwareScalingLevel(),this._resizeObserver=a.onResizeObservable.add(()=>{this._hardwareScaleLevel=a.getHardwareScalingLevel(),this.bloomKernel=this._bloomKernel}),this.bloom=new Ex(this._scene,this._bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!0),this.chromaticAberration=new Ao("ChromaticAberration",a.getRenderWidth(),a.getRenderHeight(),1,null,Y.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._chromaticAberrationEffect=new ci(a,this.ChromaticAberrationPostProcessId,()=>this.chromaticAberration,!0),this.grain=new Rh("Grain",1,null,Y.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._grainEffect=new ci(a,this.GrainPostProcessId,()=>this.grain,!0),this._imageProcessingConfigurationObserver=this._scene.imageProcessingConfiguration.onUpdateParameters.add(()=>{this.bloom._downscale._exposure=this._scene.imageProcessingConfiguration.exposure,this.imageProcessingEnabled!==this._scene.imageProcessingConfiguration.isEnabled&&(this._imageProcessingEnabled=this._scene.imageProcessingConfiguration.isEnabled,J.SetImmediate(()=>{this._buildPipeline()}))}),this._buildPipeline()}getClassName(){return"DefaultRenderingPipeline"}prepare(){const e=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=e}_setAutoClearAndTextureSharing(e,t=!1){this._hasCleared?e.autoClear=!1:(e.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),t||(this._prevPrevPostProcess?e.shareOutputWith(this._prevPrevPostProcess):e.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=e)}_buildPipeline(){if(!this._buildAllowed)return;this._scene.autoClear=!0;const e=this._scene.getEngine();if(this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(const t of this._cameras){const i=this._scene.enableDepthRenderer(t);i.useOnlyInActiveCamera=!0}this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add(t=>{this._cameras.indexOf(t.activeCamera)>-1&&(this.depthOfField.depthTexture=t.enableDepthRenderer(t.activeCamera).getDepthMap())})}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);const t=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=t.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new Df("imageProcessing",1,null,Y.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType,this.scene.imageProcessingConfiguration),this._hdr?(this.addEffect(new ci(e,this.ImageProcessingPostProcessId,()=>this.imageProcessing,!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,(!this._cameras||this._cameras.length===0)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new Ah("fxaa",1,null,Y.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType),this.addEffect(new ci(e,this.FxaaPostProcessId,()=>this.fxaa,!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),(this._scene.activeCameras&&this._scene.activeCameras.length>1||this._scene.activeCamera&&this._cameras.indexOf(this._scene.activeCamera)===-1)&&(this._scene.autoClear=!0),this._activeCameraChangedObserver||(this._activeCameraChangedObserver=this._scene.onActiveCameraChanged.add(()=>{this._scene.activeCamera&&this._cameras.indexOf(this._scene.activeCamera)===-1&&(this._scene.autoClear=!0)})),this._activeCamerasChangedObserver||(this._activeCamerasChangedObserver=this._scene.onActiveCamerasChanged.add(()=>{this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0)})),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&X.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}_disposePostProcesses(e=!1){for(let t=0;t<this._cameras.length;t++){const i=this._cameras[t];this.imageProcessing&&this.imageProcessing.dispose(i),this.fxaa&&this.fxaa.dispose(i),e&&(this.sharpen&&this.sharpen.dispose(i),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(i)),this.bloom&&this.bloom.disposeEffects(i),this.chromaticAberration&&this.chromaticAberration.dispose(i),this.grain&&this.grain.dispose(i),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,e&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._buildAllowed=!1,this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.onActiveCameraChanged.remove(this._activeCameraChangedObserver),this._scene.onActiveCamerasChanged.remove(this._activeCamerasChangedObserver),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),super.dispose()}serialize(){const e=ke.Serialize(this);return e.customType="DefaultRenderingPipeline",e}static Parse(e,t,i){return ke.Parse(()=>new Ts(e._name,e._name._hdr,t),e,t,i)}}M([F()],Ts.prototype,"sharpenEnabled",null);M([F()],Ts.prototype,"bloomKernel",null);M([F()],Ts.prototype,"_bloomWeight",void 0);M([F()],Ts.prototype,"_bloomThreshold",void 0);M([F()],Ts.prototype,"_hdr",void 0);M([F()],Ts.prototype,"bloomWeight",null);M([F()],Ts.prototype,"bloomThreshold",null);M([F()],Ts.prototype,"bloomScale",null);M([F()],Ts.prototype,"bloomEnabled",null);M([F()],Ts.prototype,"depthOfFieldEnabled",null);M([F()],Ts.prototype,"depthOfFieldBlurLevel",null);M([F()],Ts.prototype,"fxaaEnabled",null);M([F()],Ts.prototype,"samples",null);M([F()],Ts.prototype,"imageProcessingEnabled",null);M([F()],Ts.prototype,"glowLayerEnabled",null);M([F()],Ts.prototype,"chromaticAberrationEnabled",null);M([F()],Ts.prototype,"grainEnabled",null);ye("BABYLON.DefaultRenderingPipeline",Ts);const rF="lensHighlightsPixelShader",sF=`uniform sampler2D textureSampler; 
uniform float gain;
uniform float threshold;
uniform float screen_width;
uniform float screen_height;
varying vec2 vUV;
vec4 highlightColor(vec4 color) {
vec4 highlight=color;
float luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));
float lum_threshold;
if (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }
else { lum_threshold=0.5+0.44*threshold; }
luminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);
highlight*=luminance*gain;
highlight.a=1.0;
return highlight;
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec4 original=texture2D(textureSampler,vUV);
if (gain==-1.0) {
gl_FragColor=vec4(0.0,0.0,0.0,1.0);
return;
}
float w=2.0/screen_width;
float h=2.0/screen_height;
float weight=1.0;
vec4 blurred=vec4(0.0,0.0,0.0,0.0);
#ifdef PENTAGON
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));
#else
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));
#endif
blurred/=39.0;
gl_FragColor=blurred;
}`;te.ShadersStore[rF]=sF;const nF="depthOfFieldPixelShader",aF=`uniform sampler2D textureSampler;
uniform sampler2D highlightsSampler;
uniform sampler2D depthSampler;
uniform sampler2D grainSampler;
uniform float grain_amount;
uniform bool blur_noise;
uniform float screen_width;
uniform float screen_height;
uniform float distortion;
uniform bool dof_enabled;
uniform float screen_distance; 
uniform float aperture;
uniform float darken;
uniform float edge_blur;
uniform bool highlights;
uniform float near;
uniform float far;
varying vec2 vUV;
#define PI 3.14159265
#define TWOPI 6.28318530
#define inverse_focal_length 0.1 
vec2 centered_screen_pos;
vec2 distorted_coords;
float radius2;
float radius;
vec2 rand(vec2 co)
{
float noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));
float noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));
return clamp(vec2(noise1,noise2),0.0,1.0);
}
vec2 getDistortedCoords(vec2 coords) {
if (distortion==0.0) { return coords; }
vec2 direction=1.0*normalize(centered_screen_pos);
vec2 dist_coords=vec2(0.5,0.5);
dist_coords.x=0.5+direction.x*radius2*1.0;
dist_coords.y=0.5+direction.y*radius2*1.0;
float dist_amount=clamp(distortion*0.23,0.0,1.0);
dist_coords=mix(coords,dist_coords,dist_amount);
return dist_coords;
}
float sampleScreen(inout vec4 color,in vec2 offset,in float weight) {
vec2 coords=distorted_coords;
float angle=rand(coords*100.0).x*TWOPI;
coords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));
color+=texture2D(textureSampler,coords)*weight;
return weight;
}
float getBlurLevel(float size) {
return min(3.0,ceil(size/1.0));
}
vec4 getBlurColor(float size) {
vec4 col=texture2D(textureSampler,distorted_coords);
float blur_level=getBlurLevel(size);
float w=(size/screen_width);
float h=(size/screen_height);
float total_weight=1.0;
vec2 sample_coords;
total_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);
total_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);
total_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);
total_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);
total_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);
total_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);
total_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);
total_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);
total_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);
total_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);
if (blur_level>1.0) {
total_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);
total_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);
total_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);
total_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);
total_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);
total_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);
total_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);
total_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);
total_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);
total_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);
}
if (blur_level>2.0) {
total_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);
total_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);
total_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);
total_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);
total_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);
total_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);
total_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);
total_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);
total_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);
}
col/=total_weight; 
if (darken>0.0) {
col.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);
}
return col;
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);
radius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;
radius=sqrt(radius2);
distorted_coords=getDistortedCoords(vUV); 
vec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); 
float depth=texture2D(depthSampler,distorted_coords).r; 
float distance=near+(far-near)*depth; 
vec4 color=texture2D(textureSampler,vUV); 
float coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));
if (dof_enabled==false || coc<0.07) { coc=0.0; }
float edge_blur_amount=0.0;
if (edge_blur>0.0) {
edge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;
}
float blur_amount=max(edge_blur_amount,coc);
if (blur_amount==0.0) {
gl_FragColor=texture2D(textureSampler,distorted_coords);
}
else {
gl_FragColor=getBlurColor(blur_amount*1.7);
if (highlights) {
gl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;
}
if (blur_noise) {
vec2 noise=rand(distorted_coords)*0.01*blur_amount;
vec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);
gl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;
}
}
if (grain_amount>0.0) {
vec4 grain_color=texture2D(grainSampler,texels_coords*0.003);
gl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;
}
}
`;te.ShadersStore[nF]=aF;class oF{constructor(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}}const lF="ssao2PixelShader",cF=`precision highp float;
uniform sampler2D textureSampler;
uniform float near;
uniform float far;
uniform float radius;
float scales[16]=float[16](
0.1,
0.11406250000000001,
0.131640625,
0.15625,
0.187890625,
0.2265625,
0.272265625,
0.325,
0.384765625,
0.4515625,
0.525390625,
0.60625,
0.694140625,
0.7890625,
0.891015625,
1.0
);
varying vec2 vUV;
float perspectiveDepthToViewZ(in float invClipZ,in float near,in float far ) {
return ( near*far )/( ( far-near )*invClipZ-far );
}
float viewZToPerspectiveDepth( in float viewZ,in float near,in float far ) {
return ( near*far/viewZ+far)/( far-near );
}
float viewZToOrthographicDepth( in float viewZ,in float near,in float far ) {
return ( viewZ+near )/( near-far );
}
#ifdef SSAO
uniform sampler2D randomSampler;
uniform sampler2D depthSampler;
uniform sampler2D normalSampler;
uniform float randTextureTiles;
uniform float samplesFactor;
uniform vec3 sampleSphere[SAMPLES];
uniform float totalStrength;
uniform float base;
uniform float xViewport;
uniform float yViewport;
uniform mat3 depthProjection;
uniform float maxZ;
uniform float minZAspect;
uniform vec2 texelSize;
uniform mat4 projection;
void main()
{
vec3 random=texture2D(randomSampler,vUV*randTextureTiles).rgb;
float depth=texture2D(depthSampler,vUV).r;
float depthSign=depth/abs(depth);
depth=depth*depthSign;
vec3 normal=texture2D(normalSampler,vUV).rgb;
float occlusion=0.0;
float correctedRadius=min(radius,minZAspect*depth/near);
vec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);
vec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);
vec3 origin=vViewRay*vDepthFactor;
vec3 rvec=random*2.0-1.0;
rvec.z=0.0;
float dotProduct=dot(rvec,normal);
rvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);
vec3 tangent=normalize(rvec-normal*dot(rvec,normal));
vec3 bitangent=cross(normal,tangent);
mat3 tbn=mat3(tangent,bitangent,normal);
float difference;
for (int i=0; i<SAMPLES; ++i) {
vec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];
samplePosition=samplePosition*correctedRadius+origin;
vec4 offset=vec4(samplePosition,1.0);
offset=projection*offset;
offset.xyz/=offset.w;
offset.xy=offset.xy*0.5+0.5;
if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {
continue;
}
float sampleDepth=abs(texture2D(depthSampler,offset.xy).r);
difference=depthSign*samplePosition.z-sampleDepth;
float rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);
occlusion+=(difference>=0.0 ? 1.0 : 0.0)*rangeCheck;
}
occlusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));
float ao=1.0-totalStrength*occlusion*samplesFactor;
float result=clamp(ao+base,0.0,1.0);
gl_FragColor=vec4(vec3(result),1.0);
}
#endif
#ifdef BILATERAL_BLUR
uniform sampler2D depthSampler;
uniform float outSize;
uniform float samplerOffsets[SAMPLES];
vec4 blur9(sampler2D image,vec2 uv,float resolution,vec2 direction) {
vec4 color=vec4(0.0);
vec2 off1=vec2(1.3846153846)*direction;
vec2 off2=vec2(3.2307692308)*direction;
color+=texture2D(image,uv)*0.2270270270;
color+=texture2D(image,uv+(off1/resolution))*0.3162162162;
color+=texture2D(image,uv-(off1/resolution))*0.3162162162;
color+=texture2D(image,uv+(off2/resolution))*0.0702702703;
color+=texture2D(image,uv-(off2/resolution))*0.0702702703;
return color;
}
vec4 blur13(sampler2D image,vec2 uv,float resolution,vec2 direction) {
vec4 color=vec4(0.0);
vec2 off1=vec2(1.411764705882353)*direction;
vec2 off2=vec2(3.2941176470588234)*direction;
vec2 off3=vec2(5.176470588235294)*direction;
color+=texture2D(image,uv)*0.1964825501511404;
color+=texture2D(image,uv+(off1/resolution))*0.2969069646728344;
color+=texture2D(image,uv-(off1/resolution))*0.2969069646728344;
color+=texture2D(image,uv+(off2/resolution))*0.09447039785044732;
color+=texture2D(image,uv-(off2/resolution))*0.09447039785044732;
color+=texture2D(image,uv+(off3/resolution))*0.010381362401148057;
color+=texture2D(image,uv-(off3/resolution))*0.010381362401148057;
return color;
}
vec4 blur13Bilateral(sampler2D image,vec2 uv,float resolution,vec2 direction) {
vec4 color=vec4(0.0);
vec2 off1=vec2(1.411764705882353)*direction;
vec2 off2=vec2(3.2941176470588234)*direction;
vec2 off3=vec2(5.176470588235294)*direction;
float compareDepth=abs(texture2D(depthSampler,uv).r);
float sampleDepth;
float weight;
float weightSum=30.0;
color+=texture2D(image,uv)*30.0;
sampleDepth=abs(texture2D(depthSampler,uv+(off1/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+= weight;
color+=texture2D(image,uv+(off1/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv-(off1/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+= weight;
color+=texture2D(image,uv-(off1/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv+(off2/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv+(off2/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv-(off2/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv-(off2/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv+(off3/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv+(off3/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv-(off3/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv-(off3/resolution))*weight;
return color/weightSum;
}
void main()
{
#if EXPENSIVE
float compareDepth=abs(texture2D(depthSampler,vUV).r);
float texelsize=1.0/outSize;
float result=0.0;
float weightSum=0.0;
for (int i=0; i<SAMPLES; ++i)
{
#ifdef BILATERAL_BLUR_H
vec2 direction=vec2(1.0,0.0);
vec2 sampleOffset=vec2(texelsize*samplerOffsets[i],0.0);
#else
vec2 direction=vec2(0.0,1.0);
vec2 sampleOffset=vec2(0.0,texelsize*samplerOffsets[i]);
#endif
vec2 samplePos=vUV+sampleOffset;
float sampleDepth=abs(texture2D(depthSampler,samplePos).r);
float weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30000.0);
result+=texture2D(textureSampler,samplePos).r*weight;
weightSum+=weight;
}
result/=weightSum;
gl_FragColor.rgb=vec3(result);
gl_FragColor.a=1.0;
#else
vec4 color;
#ifdef BILATERAL_BLUR_H
vec2 direction=vec2(1.0,0.0);
color=blur13Bilateral(textureSampler,vUV,outSize,direction);
#else
vec2 direction=vec2(0.0,1.0);
color=blur13Bilateral(textureSampler,vUV,outSize,direction);
#endif
gl_FragColor.rgb=vec3(color.r);
gl_FragColor.a=1.0;
#endif
}
#endif
`;te.ShadersStore[lF]=cF;const hF="ssaoCombinePixelShader",uF=`uniform sampler2D textureSampler;
uniform sampler2D originalColor;
uniform vec4 viewport;
varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 ssaoColor=texture2D(textureSampler,viewport.xy+vUV*viewport.zw);
vec4 sceneColor=texture2D(originalColor,vUV);
gl_FragColor=sceneColor*ssaoColor;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;te.ShadersStore[hF]=uF;class bn extends Ph{set samples(e){this._samples=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()}get samples(){return this._samples}set textureSamples(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e}get textureSamples(){return this._textureSamples}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}set expensiveBlur(e){this._blurHPostProcess.updateEffect(`#define BILATERAL_BLUR
#define BILATERAL_BLUR_H
#define SAMPLES 16
#define EXPENSIVE `+(e?"1":"0")+`
`,null,["textureSampler","depthSampler"]),this._blurVPostProcess.updateEffect(`#define BILATERAL_BLUR
#define SAMPLES 16
#define EXPENSIVE `+(e?"1":"0")+`
`,null,["textureSampler","depthSampler"]),this._expensiveBlur=e}get expensiveBlur(){return this._expensiveBlur}static get IsSupported(){const e=qe.LastCreatedEngine;return e?e._features.supportSSAO2:!1}get scene(){return this._scene}constructor(e,t,i,r,s=!1,n=0){if(super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.maxZ=100,this.minZAspect=.2,this._samples=8,this._textureSamples=1,this._forceGeometryBuffer=!1,this._expensiveBlur=!0,this.radius=2,this.base=0,this._bits=new Uint32Array(1),this._scene=t,this._ratio=i,this._forceGeometryBuffer=s,!this.isSupported){X.Error("The current engine does not support SSAO 2.");return}const a=this._ratio.ssaoRatio||i,l=this._ratio.blurRatio||i;this._forceGeometryBuffer?t.enableGeometryBufferRenderer():t.enablePrePassRenderer(),this._createRandomTexture(),this._originalColorPostProcess=new So("SSAOOriginalSceneColor",1,null,Y.BILINEAR_SAMPLINGMODE,t.getEngine(),void 0,n),this._originalColorPostProcess.samples=this.textureSamples,this._createSSAOPostProcess(1,n),this._createBlurPostProcess(a,l,n),this._createSSAOCombinePostProcess(l,n),this.addEffect(new ci(t.getEngine(),this.SSAOOriginalSceneColorEffect,()=>this._originalColorPostProcess,!0)),this.addEffect(new ci(t.getEngine(),this.SSAORenderEffect,()=>this._ssaoPostProcess,!0)),this.addEffect(new ci(t.getEngine(),this.SSAOBlurHRenderEffect,()=>this._blurHPostProcess,!0)),this.addEffect(new ci(t.getEngine(),this.SSAOBlurVRenderEffect,()=>this._blurVPostProcess,!0)),this.addEffect(new ci(t.getEngine(),this.SSAOCombineRenderEffect,()=>this._ssaoCombinePostProcess,!0)),t.postProcessRenderPipelineManager.addPipeline(this),r&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,r)}getClassName(){return"SSAO2RenderingPipeline"}dispose(e=!1){for(let t=0;t<this._scene.cameras.length;t++){const i=this._scene.cameras[t];this._originalColorPostProcess.dispose(i),this._ssaoPostProcess.dispose(i),this._blurHPostProcess.dispose(i),this._blurVPostProcess.dispose(i),this._ssaoCombinePostProcess.dispose(i)}this._randomTexture.dispose(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_createBlurPostProcess(e,t,i){this._samplerOffsets=[];const r=this.expensiveBlur;for(let s=-8;s<8;s++)this._samplerOffsets.push(s*2+.5);this._blurHPostProcess=new et("BlurH","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],e,null,Y.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,`#define BILATERAL_BLUR
#define BILATERAL_BLUR_H
#define SAMPLES 16
#define EXPENSIVE `+(r?"1":"0")+`
`,i),this._blurHPostProcess.onApply=s=>{this._scene.activeCamera&&(s.setFloat("outSize",this._ssaoCombinePostProcess.width>0?this._ssaoCombinePostProcess.width:this._originalColorPostProcess.width),s.setFloat("near",this._scene.activeCamera.minZ),s.setFloat("far",this._scene.activeCamera.maxZ),s.setFloat("radius",this.radius),this._geometryBufferRenderer?s.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&s.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),s.setArray("samplerOffsets",this._samplerOffsets))},this._blurVPostProcess=new et("BlurV","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],t,null,Y.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,`#define BILATERAL_BLUR
#define BILATERAL_BLUR_V
#define SAMPLES 16
#define EXPENSIVE `+(r?"1":"0")+`
`,i),this._blurVPostProcess.onApply=s=>{this._scene.activeCamera&&(s.setFloat("outSize",this._ssaoCombinePostProcess.height>0?this._ssaoCombinePostProcess.height:this._originalColorPostProcess.height),s.setFloat("near",this._scene.activeCamera.minZ),s.setFloat("far",this._scene.activeCamera.maxZ),s.setFloat("radius",this.radius),this._geometryBufferRenderer?s.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&s.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),s.setArray("samplerOffsets",this._samplerOffsets))},this._blurHPostProcess.samples=this.textureSamples,this._blurVPostProcess.samples=this.textureSamples}_rebuild(){super._rebuild()}_radicalInverse_VdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(this._bits[0]&1431655765)<<1|(this._bits[0]&2863311530)>>>1>>>0,this._bits[0]=(this._bits[0]&858993459)<<2|(this._bits[0]&3435973836)>>>2>>>0,this._bits[0]=(this._bits[0]&252645135)<<4|(this._bits[0]&4042322160)>>>4>>>0,this._bits[0]=(this._bits[0]&16711935)<<8|(this._bits[0]&4278255360)>>>8>>>0,this._bits[0]*23283064365386963e-26}_hammersley(e,t){return[e/t,this._radicalInverse_VdC(e)]}_hemisphereSample_uniform(e,t){const i=t*2*Math.PI,r=1-e*.85,s=Math.sqrt(1-r*r);return new x(Math.cos(i)*s,Math.sin(i)*s,r)}_generateHemisphere(){const e=this.samples,t=[];let i,r=0;for(;r<e;){if(e<16)i=this._hemisphereSample_uniform(Math.random(),Math.random());else{const s=this._hammersley(r,e);i=this._hemisphereSample_uniform(s[0],s[1])}t.push(i.x,i.y,i.z),r++}return t}_getDefinesForSSAO(){return"#define SAMPLES "+this.samples+`
#define SSAO`}_createSSAOPostProcess(e,t){this._sampleSphere=this._generateHemisphere();const i=this._getDefinesForSSAO(),r=["randomSampler","depthSampler","normalSampler"];this._ssaoPostProcess=new et("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","far","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],r,e,null,Y.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i,t),this._ssaoPostProcess.onApply=s=>{var n,a,l,c;if(this._scene.activeCamera){if(s.setArray3("sampleSphere",this._sampleSphere),s.setFloat("randTextureTiles",32),s.setFloat("samplesFactor",1/this.samples),s.setFloat("totalStrength",this.totalStrength),s.setFloat2("texelSize",1/this._ssaoPostProcess.width,1/this._ssaoPostProcess.height),s.setFloat("radius",this.radius),s.setFloat("maxZ",this.maxZ),s.setFloat("minZAspect",this.minZAspect),s.setFloat("base",this.base),s.setFloat("near",this._scene.activeCamera.minZ),s.setFloat("far",this._scene.activeCamera.maxZ),this._scene.activeCamera.mode===Ve.PERSPECTIVE_CAMERA)s.setMatrix3x3("depthProjection",bn.PERSPECTIVE_DEPTH_PROJECTION),s.setFloat("xViewport",Math.tan(this._scene.activeCamera.fov/2)*this._scene.getEngine().getAspectRatio(this._scene.activeCamera,!0)),s.setFloat("yViewport",Math.tan(this._scene.activeCamera.fov/2));else{const h=this._scene.getEngine().getRenderWidth()/2,u=this._scene.getEngine().getRenderHeight()/2,d=(n=this._scene.activeCamera.orthoLeft)!==null&&n!==void 0?n:-h,f=(a=this._scene.activeCamera.orthoRight)!==null&&a!==void 0?a:h,_=(l=this._scene.activeCamera.orthoBottom)!==null&&l!==void 0?l:-u,p=(c=this._scene.activeCamera.orthoTop)!==null&&c!==void 0?c:u;s.setMatrix3x3("depthProjection",bn.ORTHO_DEPTH_PROJECTION),s.setFloat("xViewport",(f-d)*.5),s.setFloat("yViewport",(p-_)*.5)}s.setMatrix("projection",this._scene.getProjectionMatrix()),this._geometryBufferRenderer?(s.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]),s.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[1])):this._prePassRenderer&&(s.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),s.setTexture("normalSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(6)])),s.setTexture("randomSampler",this._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new oF)}_createSSAOCombinePostProcess(e,t){this._ssaoCombinePostProcess=new et("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,Y.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,void 0,t),this._ssaoCombinePostProcess.onApply=i=>{const r=this._scene.activeCamera.viewport;i.setVector4("viewport",j.Vector4[0].copyFromFloats(r.x,r.y,r.width,r.height)),i.setTextureFromPostProcessOutput("originalColor",this._originalColorPostProcess)},this._ssaoCombinePostProcess.samples=this.textureSamples}_createRandomTexture(){this._randomTexture=new za("SSAORandomTexture",128,this._scene,!1,Y.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=Y.WRAP_ADDRESSMODE,this._randomTexture.wrapV=Y.WRAP_ADDRESSMODE;const t=this._randomTexture.getContext(),i=(s,n)=>Math.random()*(n-s)+s,r=x.Zero();for(let s=0;s<128;s++)for(let n=0;n<128;n++)r.x=i(0,1),r.y=i(0,1),r.z=0,r.normalize(),r.scaleInPlace(255),r.x=Math.floor(r.x),r.y=Math.floor(r.y),t.fillStyle="rgb("+r.x+", "+r.y+", "+r.z+")",t.fillRect(s,n,1,1);this._randomTexture.update(!1)}serialize(){const e=ke.Serialize(this);return e.customType="SSAO2RenderingPipeline",e}static Parse(e,t,i){return ke.Parse(()=>new bn(e._name,t,e._ratio),e,t,i)}}bn.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1];bn.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1];M([F()],bn.prototype,"totalStrength",void 0);M([F()],bn.prototype,"maxZ",void 0);M([F()],bn.prototype,"minZAspect",void 0);M([F("samples")],bn.prototype,"_samples",void 0);M([F("textureSamples")],bn.prototype,"_textureSamples",void 0);M([F()],bn.prototype,"_ratio",void 0);M([F("expensiveBlur")],bn.prototype,"_expensiveBlur",void 0);M([F()],bn.prototype,"radius",void 0);M([F()],bn.prototype,"base",void 0);ye("BABYLON.SSAO2RenderingPipeline",bn);const dF="ssaoPixelShader",fF=`uniform sampler2D textureSampler;
varying vec2 vUV;
#ifdef SSAO
uniform sampler2D randomSampler;
uniform float randTextureTiles;
uniform float samplesFactor;
uniform vec3 sampleSphere[SAMPLES];
uniform float totalStrength;
uniform float radius;
uniform float area;
uniform float fallOff;
uniform float base;
vec3 normalFromDepth(float depth,vec2 coords)
{
vec2 offset1=vec2(0.0,radius);
vec2 offset2=vec2(radius,0.0);
float depth1=texture2D(textureSampler,coords+offset1).r;
float depth2=texture2D(textureSampler,coords+offset2).r;
vec3 p1=vec3(offset1,depth1-depth);
vec3 p2=vec3(offset2,depth2-depth);
vec3 normal=cross(p1,p2);
normal.z=-normal.z;
return normalize(normal);
}
void main()
{
vec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);
float depth=texture2D(textureSampler,vUV).r;
vec3 position=vec3(vUV,depth);
vec3 normal=normalFromDepth(depth,vUV);
float radiusDepth=radius/depth;
float occlusion=0.0;
vec3 ray;
vec3 hemiRay;
float occlusionDepth;
float difference;
for (int i=0; i<SAMPLES; i++)
{
ray=radiusDepth*reflect(sampleSphere[i],random);
hemiRay=position+sign(dot(ray,normal))*ray;
occlusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;
difference=depth-occlusionDepth;
occlusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));
}
float ao=1.0-totalStrength*occlusion*samplesFactor;
float result=clamp(ao+base,0.0,1.0);
gl_FragColor.r=result;
gl_FragColor.g=result;
gl_FragColor.b=result;
gl_FragColor.a=1.0;
}
#endif
`;te.ShadersStore[dF]=fF;class Yu extends Ph{get scene(){return this._scene}constructor(e,t,i,r){super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.base=.5,this._firstUpdate=!0,this._scene=t,this._createRandomTexture();const s=i.ssaoRatio||i,n=i.combineRatio||i;this._originalColorPostProcess=new So("SSAOOriginalSceneColor",n,null,Y.BILINEAR_SAMPLINGMODE,t.getEngine(),!1),this._createSSAOPostProcess(s),this._createBlurPostProcess(s),this._createSSAOCombinePostProcess(n),this.addEffect(new ci(t.getEngine(),this.SSAOOriginalSceneColorEffect,()=>this._originalColorPostProcess,!0)),this.addEffect(new ci(t.getEngine(),this.SSAORenderEffect,()=>this._ssaoPostProcess,!0)),this.addEffect(new ci(t.getEngine(),this.SSAOBlurHRenderEffect,()=>this._blurHPostProcess,!0)),this.addEffect(new ci(t.getEngine(),this.SSAOBlurVRenderEffect,()=>this._blurVPostProcess,!0)),this.addEffect(new ci(t.getEngine(),this.SSAOCombineRenderEffect,()=>this._ssaoCombinePostProcess,!0)),t.postProcessRenderPipelineManager.addPipeline(this),r&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,r)}_attachCameras(e,t){super._attachCameras(e,t);for(const i of this._cameras)this._scene.enableDepthRenderer(i).getDepthMap()}getClassName(){return"SSAORenderingPipeline"}dispose(e=!1){for(let t=0;t<this._scene.cameras.length;t++){const i=this._scene.cameras[t];this._originalColorPostProcess.dispose(i),this._ssaoPostProcess.dispose(i),this._blurHPostProcess.dispose(i),this._blurVPostProcess.dispose(i),this._ssaoCombinePostProcess.dispose(i)}this._randomTexture.dispose(),e&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_createBlurPostProcess(e){this._blurHPostProcess=new Yr("BlurH",new Ie(1,0),16,e,null,Y.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new Yr("BlurV",new Ie(0,1),16,e,null,Y.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add(()=>{const i=this._blurHPostProcess.width/this._scene.getEngine().getRenderWidth();this._blurHPostProcess.kernel=16*i}),this._blurVPostProcess.onActivateObservable.add(()=>{const i=this._blurVPostProcess.height/this._scene.getEngine().getRenderHeight();this._blurVPostProcess.kernel=16*i})}_rebuild(){this._firstUpdate=!0,super._rebuild()}_createSSAOPostProcess(e){const i=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271],r=1/16;this._ssaoPostProcess=new et("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,Y.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,`#define SAMPLES 16
#define SSAO`),this._ssaoPostProcess.externalTextureSamplerBinding=!0,this._ssaoPostProcess.onApply=s=>{this._firstUpdate&&(s.setArray3("sampleSphere",i),s.setFloat("samplesFactor",r),s.setFloat("randTextureTiles",4)),s.setFloat("totalStrength",this.totalStrength),s.setFloat("radius",this.radius),s.setFloat("area",this.area),s.setFloat("fallOff",this.fallOff),s.setFloat("base",this.base),s.setTexture("textureSampler",this._scene.enableDepthRenderer(this._scene.activeCamera).getDepthMap()),s.setTexture("randomSampler",this._randomTexture)}}_createSSAOCombinePostProcess(e){this._ssaoCombinePostProcess=new et("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,Y.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=t=>{t.setVector4("viewport",j.Vector4[0].copyFromFloats(0,0,1,1)),t.setTextureFromPostProcess("originalColor",this._originalColorPostProcess)}}_createRandomTexture(){this._randomTexture=new za("SSAORandomTexture",512,this._scene,!1,Y.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=Y.WRAP_ADDRESSMODE,this._randomTexture.wrapV=Y.WRAP_ADDRESSMODE;const t=this._randomTexture.getContext(),i=(s,n)=>Math.random()*(n-s)+s,r=x.Zero();for(let s=0;s<512;s++)for(let n=0;n<512;n++)r.x=Math.floor(Math.max(0,i(-1,1))*255),r.y=Math.floor(Math.max(0,i(-1,1))*255),r.z=Math.floor(Math.max(0,i(-1,1))*255),t.fillStyle="rgb("+r.x+", "+r.y+", "+r.z+")",t.fillRect(s,n,1,1);this._randomTexture.update(!1)}}M([F()],Yu.prototype,"totalStrength",void 0);M([F()],Yu.prototype,"radius",void 0);M([F()],Yu.prototype,"area",void 0);M([F()],Yu.prototype,"fallOff",void 0);M([F()],Yu.prototype,"base",void 0);class _F{constructor(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}}const pF="screenSpaceReflectionPixelShader",mF=`uniform sampler2D textureSampler;
#ifdef SSR_SUPPORTED
uniform sampler2D reflectivitySampler;
uniform sampler2D normalSampler;
uniform sampler2D positionSampler;
#endif
uniform mat4 view;
uniform mat4 projection;
uniform float stepSize;
uniform float strength;
uniform float threshold;
uniform float roughnessFactor;
uniform float reflectionSpecularFalloffExponent;
varying vec2 vUV;
#ifdef SSR_SUPPORTED
struct ReflectionInfo {
vec3 color;
vec4 coords;
};
/**
* According to specular,see https:
*/
vec3 fresnelSchlick(float cosTheta,vec3 F0)
{
return F0+(1.0-F0)*pow(1.0-cosTheta,5.0);
}
/**
* Once the pixel's coordinates has been found,let's adjust (smooth) a little bit
* by sampling multiple reflection pixels.
*/
ReflectionInfo smoothReflectionInfo(vec3 dir,vec3 hitCoord)
{
ReflectionInfo info;
info.color=vec3(0.0);
vec4 projectedCoord;
float sampledDepth;
for(int i=0; i<SMOOTH_STEPS; i++)
{
projectedCoord=projection*vec4(hitCoord,1.0);
projectedCoord.xy/=projectedCoord.w;
projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);
sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;
float depth=sampledDepth-hitCoord.z;
dir*=0.5;
if(depth>0.0)
hitCoord-=dir;
else
hitCoord+=dir;
info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;
}
projectedCoord=projection*vec4(hitCoord,1.0);
projectedCoord.xy/=projectedCoord.w;
projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);
info.coords=vec4(projectedCoord.xy,sampledDepth,1.0);
info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;
info.color/=float(SMOOTH_STEPS+1);
return info;
}
/**
* Tests the given world position (hitCoord) according to the given reflection vector (dir)
* until it finds a collision (means that depth is enough close to say "it's the pixel to sample!").
*/
ReflectionInfo getReflectionInfo(vec3 dir,vec3 hitCoord)
{
ReflectionInfo info;
vec4 projectedCoord;
float sampledDepth;
dir*=stepSize;
for(int i=0; i<REFLECTION_SAMPLES; i++)
{
hitCoord+=dir;
projectedCoord=projection*vec4(hitCoord,1.0);
projectedCoord.xy/=projectedCoord.w;
projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);
sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;
float depth=sampledDepth-hitCoord.z;
#ifdef RIGHT_HANDED_SCENE
depth*=-1.0;
#endif
if(((depth-dir.z)<threshold) && depth<=0.0)
{
#ifdef ENABLE_SMOOTH_REFLECTIONS
return smoothReflectionInfo(dir,hitCoord);
#else
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;
info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);
return info;
#endif
}
}
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;
info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);
return info;
}
vec3 hash(vec3 a)
{
a=fract(a*0.8);
a+=dot(a,a.yxz+19.19);
return fract((a.xxy+a.yxx)*a.zyx);
}
#endif
void main()
{
#ifdef SSR_SUPPORTED
vec4 albedoFull=texture2D(textureSampler,vUV);
vec3 albedo=albedoFull.rgb;
float spec=texture2D(reflectivitySampler,vUV).r;
if (spec==0.0) {
gl_FragColor=albedoFull;
return;
}
vec3 normal=(texture2D(normalSampler,vUV)).xyz;
vec3 position=(view*texture2D(positionSampler,vUV)).xyz;
vec3 reflected=normalize(reflect(normalize(position),normalize(normal)));
float roughness=1.0-texture2D(reflectivitySampler,vUV).a;
vec3 jitt=mix(vec3(0.0),hash(position),roughness)*roughnessFactor;
ReflectionInfo info=getReflectionInfo(jitt+reflected,position);
vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-info.coords.xy));
float screenEdgefactor=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);
vec3 F0=vec3(0.04);
F0 =mix(F0,albedo,spec);
vec3 fresnel=fresnelSchlick(max(dot(normalize(normal),normalize(position)),0.0),F0);
#ifdef RIGHT_HANDED_SCENE
reflected.z*=-1.0;
#endif
float reflectionMultiplier=clamp(pow(spec*strength,reflectionSpecularFalloffExponent)*screenEdgefactor*reflected.z,0.0,0.9);
float albedoMultiplier=1.0-reflectionMultiplier;
vec3 SSR=info.color*fresnel;
gl_FragColor=vec4((albedo*albedoMultiplier)+(SSR*reflectionMultiplier),albedoFull.a);
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;te.ShadersStore[pF]=mF;class Ia extends et{get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"ScreenSpaceReflectionPostProcess"}constructor(e,t,i,r,s,n,a,l=0,c=!1,h=!1){if(super(e,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","stepSize","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],i,r,s,n,a,`#define SSR_SUPPORTED
#define REFLECTION_SAMPLES 64
#define SMOOTH_STEPS 5
`,l,void 0,null,c),this.threshold=1.2,this.strength=1,this.reflectionSpecularFalloffExponent=3,this.step=1,this.roughnessFactor=.2,this._forceGeometryBuffer=!1,this._enableSmoothReflections=!1,this._reflectionSamples=64,this._smoothSteps=5,this._forceGeometryBuffer=h,this._forceGeometryBuffer){const u=t.enableGeometryBufferRenderer();u&&u.isSupported&&(u.enablePosition=!0,u.enableReflectivity=!0)}else{const u=t.enablePrePassRenderer();u==null||u.markAsDirty(),this._prePassEffectConfiguration=new _F}this._updateEffectDefines(),this.onApply=u=>{const d=this._geometryBufferRenderer,f=this._prePassRenderer;if(!f&&!d)return;if(d){const T=d.getTextureIndex(Qi.POSITION_TEXTURE_TYPE),b=d.getTextureIndex(Qi.REFLECTIVITY_TEXTURE_TYPE);u.setTexture("normalSampler",d.getGBuffer().textures[1]),u.setTexture("positionSampler",d.getGBuffer().textures[T]),u.setTexture("reflectivitySampler",d.getGBuffer().textures[b])}else if(f){const T=f.getIndex(1),b=f.getIndex(3),y=f.getIndex(6);u.setTexture("normalSampler",f.getRenderTarget().textures[y]),u.setTexture("positionSampler",f.getRenderTarget().textures[T]),u.setTexture("reflectivitySampler",f.getRenderTarget().textures[b])}const _=t.activeCamera;if(!_)return;const p=_.getViewMatrix(!0),m=_.getProjectionMatrix(!0);u.setMatrix("projection",m),u.setMatrix("view",p),u.setFloat("threshold",this.threshold),u.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),u.setFloat("strength",this.strength),u.setFloat("stepSize",this.step),u.setFloat("roughnessFactor",this.roughnessFactor)},this._isSceneRightHanded=t.useRightHandedSystem}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get reflectionSamples(){return this._reflectionSamples}set reflectionSamples(e){e!==this._reflectionSamples&&(this._reflectionSamples=e,this._updateEffectDefines())}get smoothSteps(){return this._smoothSteps}set smoothSteps(e){e!==this._smoothSteps&&(this._smoothSteps=e,this._updateEffectDefines())}_updateEffectDefines(){const e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define ENABLE_SMOOTH_REFLECTIONS"),this._isSceneRightHanded&&e.push("#define RIGHT_HANDED_SCENE"),e.push("#define REFLECTION_SAMPLES "+(this._reflectionSamples>>0)),e.push("#define SMOOTH_STEPS "+(this._smoothSteps>>0)),this.updateEffect(e.join(`
`))}static _Parse(e,t,i,r){return ke.Parse(()=>new Ia(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,r)}}M([F()],Ia.prototype,"threshold",void 0);M([F()],Ia.prototype,"strength",void 0);M([F()],Ia.prototype,"reflectionSpecularFalloffExponent",void 0);M([F()],Ia.prototype,"step",void 0);M([F()],Ia.prototype,"roughnessFactor",void 0);M([F()],Ia.prototype,"enableSmoothReflections",null);M([F()],Ia.prototype,"reflectionSamples",null);M([F()],Ia.prototype,"smoothSteps",null);ye("BABYLON.ScreenSpaceReflectionPostProcess",Ia);const gF="standardPixelShader",vF=`uniform sampler2D textureSampler;
varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
#if defined(PASS_POST_PROCESS)
void main(void)
{
vec4 color=texture2D(textureSampler,vUV);
gl_FragColor=color;
}
#endif
#if defined(DOWN_SAMPLE_X4)
uniform vec2 dsOffsets[16];
void main(void)
{
vec4 average=vec4(0.0,0.0,0.0,0.0);
average=texture2D(textureSampler,vUV+dsOffsets[0]);
average+=texture2D(textureSampler,vUV+dsOffsets[1]);
average+=texture2D(textureSampler,vUV+dsOffsets[2]);
average+=texture2D(textureSampler,vUV+dsOffsets[3]);
average+=texture2D(textureSampler,vUV+dsOffsets[4]);
average+=texture2D(textureSampler,vUV+dsOffsets[5]);
average+=texture2D(textureSampler,vUV+dsOffsets[6]);
average+=texture2D(textureSampler,vUV+dsOffsets[7]);
average+=texture2D(textureSampler,vUV+dsOffsets[8]);
average+=texture2D(textureSampler,vUV+dsOffsets[9]);
average+=texture2D(textureSampler,vUV+dsOffsets[10]);
average+=texture2D(textureSampler,vUV+dsOffsets[11]);
average+=texture2D(textureSampler,vUV+dsOffsets[12]);
average+=texture2D(textureSampler,vUV+dsOffsets[13]);
average+=texture2D(textureSampler,vUV+dsOffsets[14]);
average+=texture2D(textureSampler,vUV+dsOffsets[15]);
average/=16.0;
gl_FragColor=average;
}
#endif
#if defined(BRIGHT_PASS)
uniform vec2 dsOffsets[4];
uniform float brightThreshold;
void main(void)
{
vec4 average=vec4(0.0,0.0,0.0,0.0);
average=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));
average+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));
average+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));
average+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));
average*=0.25;
float luminance=length(average.rgb);
if (luminance<brightThreshold) {
average=vec4(0.0,0.0,0.0,1.0);
}
gl_FragColor=average;
}
#endif
#if defined(TEXTURE_ADDER)
uniform sampler2D otherSampler;
uniform sampler2D lensSampler;
uniform float exposure;
void main(void)
{
vec3 colour=texture2D(textureSampler,vUV).rgb;
colour*=exposure;
vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);
vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);
colour=retColor*retColor;
colour+=colour*texture2D(lensSampler,vUV).rgb;
vec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);
gl_FragColor=finalColor;
}
#endif
#if defined(VLS)
#define PI 3.1415926535897932384626433832795
uniform mat4 shadowViewProjection;
uniform mat4 lightWorld;
uniform vec3 cameraPosition;
uniform vec3 sunDirection;
uniform vec3 sunColor;
uniform vec2 depthValues;
uniform float scatteringCoefficient;
uniform float scatteringPower;
uniform sampler2D shadowMapSampler;
uniform sampler2D positionSampler;
float computeScattering(float lightDotView)
{
float result=1.0-scatteringCoefficient*scatteringCoefficient;
result/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));
return result;
}
void main(void)
{
vec3 worldPos=texture2D(positionSampler,vUV).rgb;
vec3 startPosition=cameraPosition;
vec3 rayVector=worldPos-startPosition;
float rayLength=length(rayVector);
vec3 rayDirection=rayVector/rayLength;
float stepLength=rayLength/NB_STEPS;
vec3 stepL=rayDirection*stepLength;
vec3 currentPosition=startPosition;
vec3 accumFog=vec3(0.0);
for (int i=0; i<int(NB_STEPS); i++)
{
vec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);
float depthMetric= (worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depthMetric,0.0,1.0);
worldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;
worldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);
float shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;
if (shadowMapValue>shadowPixelDepth)
accumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));
currentPosition+=stepL;
}
accumFog/=NB_STEPS;
vec3 color=accumFog*scatteringPower;
gl_FragColor=vec4(color*exp(color) ,1.0);
}
#endif
#if defined(VLSMERGE)
uniform sampler2D originalSampler;
void main(void)
{
gl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);
}
#endif
#if defined(LUMINANCE)
uniform vec2 lumOffsets[4];
void main()
{
float average=0.0;
vec4 color=vec4(0.0);
float maximum=-1e20;
vec3 weight=vec3(0.299,0.587,0.114);
for (int i=0; i<4; i++)
{
color=texture2D(textureSampler,vUV+ lumOffsets[i]);
float GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));
#ifdef WEIGHTED_AVERAGE
float GreyValue=dot(color.rgb,weight);
#endif
#ifdef BRIGHTNESS
float GreyValue=max(color.r,max(color.g,color.b));
#endif
#ifdef HSL_COMPONENT
float GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));
#endif
#ifdef MAGNITUDE
float GreyValue=length(color.rgb);
#endif
maximum=max(maximum,GreyValue);
average+=(0.25*log(1e-5+GreyValue));
}
average=exp(average);
gl_FragColor=vec4(average,maximum,0.0,1.0);
}
#endif
#if defined(LUMINANCE_DOWN_SAMPLE)
uniform vec2 dsOffsets[9];
uniform float halfDestPixelSize;
#ifdef FINAL_DOWN_SAMPLER
#include<packingFunctions>
#endif
void main()
{
vec4 color=vec4(0.0);
float average=0.0;
for (int i=0; i<9; i++)
{
color=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);
average+=color.r;
}
average/=9.0;
#ifdef FINAL_DOWN_SAMPLER
gl_FragColor=pack(average);
#else
gl_FragColor=vec4(average,average,0.0,1.0);
#endif
}
#endif
#if defined(HDR)
uniform sampler2D textureAdderSampler;
uniform float averageLuminance;
void main()
{
vec4 color=texture2D(textureAdderSampler,vUV);
#ifndef AUTO_EXPOSURE
vec4 adjustedColor=color/averageLuminance;
color=adjustedColor;
color.a=1.0;
#endif
gl_FragColor=color;
}
#endif
#if defined(LENS_FLARE)
#define GHOSTS 3
uniform sampler2D lensColorSampler;
uniform float strength;
uniform float ghostDispersal;
uniform float haloWidth;
uniform vec2 resolution;
uniform float distortionStrength;
float hash(vec2 p)
{
float h=dot(p,vec2(127.1,311.7));
return -1.0+2.0*fract(sin(h)*43758.5453123);
}
float noise(in vec2 p)
{
vec2 i=floor(p);
vec2 f=fract(p);
vec2 u=f*f*(3.0-2.0*f);
return mix(mix(hash(i+vec2(0.0,0.0)),
hash(i+vec2(1.0,0.0)),u.x),
mix(hash(i+vec2(0.0,1.0)),
hash(i+vec2(1.0,1.0)),u.x),u.y);
}
float fbm(vec2 p)
{
float f=0.0;
f+=0.5000*noise(p); p*=2.02;
f+=0.2500*noise(p); p*=2.03;
f+=0.1250*noise(p); p*=2.01;
f+=0.0625*noise(p); p*=2.04;
f/=0.9375;
return f;
}
vec3 pattern(vec2 uv)
{
vec2 p=-1.0+2.0*uv;
float p2=dot(p,p);
float f=fbm(vec2(15.0*p2))/2.0;
float r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));
float g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));
float b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));
return (1.0-f)*vec3(r,g,b);
}
float luminance(vec3 color)
{
return dot(color.rgb,vec3(0.2126,0.7152,0.0722));
}
vec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)
{
return vec4(
texture2D(tex,texcoord+direction*distortion.r).r,
texture2D(tex,texcoord+direction*distortion.g).g,
texture2D(tex,texcoord+direction*distortion.b).b,
1.0
);
}
void main(void)
{
vec2 uv=-vUV+vec2(1.0);
vec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;
vec2 texelSize=1.0/resolution;
vec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);
vec4 result=vec4(0.0);
float ghostIndice=1.0;
for (int i=0; i<GHOSTS; ++i)
{
vec2 offset=fract(uv+ghostDir*ghostIndice);
float weight=length(vec2(0.5)-offset)/length(vec2(0.5));
weight=pow(1.0-weight,10.0);
result+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;
ghostIndice+=1.0;
}
vec2 haloVec=normalize(ghostDir)*haloWidth;
float weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));
weight=pow(1.0-weight,10.0);
result+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;
result*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));
gl_FragColor=result;
}
#endif
#if defined(LENS_FLARE_COMPOSE)
uniform sampler2D otherSampler;
uniform sampler2D lensDirtSampler;
uniform sampler2D lensStarSampler;
uniform mat4 lensStarMatrix;
void main(void)
{
vec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;
vec4 lensMod=texture2D(lensDirtSampler,vUV);
lensMod+=texture2D(lensStarSampler,vUV/*lensFlareCoords*/);
vec4 result=texture2D(textureSampler,vUV)*lensMod;
gl_FragColor=texture2D(otherSampler,vUV)+result;
}
#endif
#if defined(DEPTH_OF_FIELD)
uniform sampler2D otherSampler;
uniform sampler2D depthSampler;
uniform float distance;
void main(void)
{
vec4 sharp=texture2D(otherSampler,vUV);
vec4 blur=texture2D(textureSampler,vUV);
float dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);
float factor=0.0;
if (dist<0.05)
factor=1.0;
else if (dist<0.1)
factor=20.0*(0.1-dist);
else if (dist<0.5)
factor=0.0;
else
factor=2.0*(dist-0.5);
factor=clamp(factor,0.0,0.90);
gl_FragColor=mix(sharp,blur,factor);
}
#endif
#if defined(MOTION_BLUR)
uniform mat4 inverseViewProjection;
uniform mat4 prevViewProjection;
uniform vec2 screenSize;
uniform float motionScale;
uniform float motionStrength;
uniform sampler2D depthSampler;
void main(void)
{
vec2 texelSize=1.0/screenSize;
float depth=texture2D(depthSampler,vUV).r;
vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);
cpos=cpos*inverseViewProjection;
vec4 ppos=cpos*prevViewProjection;
ppos.xyz/=ppos.w;
ppos.xy=ppos.xy*0.5+0.5;
vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;
float speed=length(velocity/texelSize);
int nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));
vec4 result=texture2D(textureSampler,vUV);
for (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {
if (i>=nSamples)
break;
vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);
result+=texture2D(textureSampler,offset1);
}
gl_FragColor=result/float(nSamples);
}
#endif
`;te.ShadersStore[gF]=vF;class ai extends Ph{get exposure(){return this._fixedExposure}set exposure(e){this._fixedExposure=e,this._currentExposure=e}get hdrAutoExposure(){return this._hdrAutoExposure}set hdrAutoExposure(e){if(this._hdrAutoExposure=e,this.hdrPostProcess){const t=["#define HDR"];e&&t.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(t.join(`
`))}}get motionStrength(){return this._motionStrength}set motionStrength(e){this._motionStrength=e,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=e)}get objectBasedMotionBlur(){return this._isObjectBasedMotionBlur}set objectBasedMotionBlur(e){const t=this._isObjectBasedMotionBlur!==e;this._isObjectBasedMotionBlur=e,t&&this._buildPipeline()}get BloomEnabled(){return this._bloomEnabled}set BloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get DepthOfFieldEnabled(){return this._depthOfFieldEnabled}set DepthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get LensFlareEnabled(){return this._lensFlareEnabled}set LensFlareEnabled(e){this._lensFlareEnabled!==e&&(this._lensFlareEnabled=e,this._buildPipeline())}get HDREnabled(){return this._hdrEnabled}set HDREnabled(e){this._hdrEnabled!==e&&(this._hdrEnabled=e,this._buildPipeline())}get VLSEnabled(){return this._vlsEnabled}set VLSEnabled(e){if(this._vlsEnabled!==e){if(e&&!this._scene.enableGeometryBufferRenderer()){X.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");return}this._vlsEnabled=e,this._buildPipeline()}}get MotionBlurEnabled(){return this._motionBlurEnabled}set MotionBlurEnabled(e){this._motionBlurEnabled!==e&&(this._motionBlurEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get screenSpaceReflectionsEnabled(){return this._screenSpaceReflectionsEnabled}set screenSpaceReflectionsEnabled(e){this._screenSpaceReflectionsEnabled!==e&&(this._screenSpaceReflectionsEnabled=e,this._buildPipeline())}get volumetricLightStepsCount(){return this._volumetricLightStepsCount}set volumetricLightStepsCount(e){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect(`#define VLS
#define NB_STEPS `+e.toFixed(1)),this._volumetricLightStepsCount=e}get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=e:this.motionBlurPostProcess.updateEffect(`#define MOTION_BLUR
#define MAX_MOTION_SAMPLES `+e.toFixed(1))),this._motionBlurSamples=e}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}constructor(e,t,i,r=null,s){super(t.getEngine(),e),this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.blurHPostProcesses=[],this.blurVPostProcesses=[],this.textureAdderPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.luminancePostProcess=null,this.luminanceDownSamplePostProcesses=[],this.hdrPostProcess=null,this.textureAdderFinalPostProcess=null,this.lensFlareFinalPostProcess=null,this.hdrFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.motionBlurPostProcess=null,this.depthOfFieldPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.brightThreshold=1,this.blurWidth=512,this.horizontalBlur=!1,this.lensTexture=null,this.volumetricLightCoefficient=.2,this.volumetricLightPower=4,this.volumetricLightBlurScale=64,this.sourceLight=null,this.hdrMinimumLuminance=1,this.hdrDecreaseRate=.5,this.hdrIncreaseRate=.5,this.lensColorTexture=null,this.lensFlareStrength=20,this.lensFlareGhostDispersal=1.4,this.lensFlareHaloWidth=.7,this.lensFlareDistortionStrength=16,this.lensFlareBlurWidth=512,this.lensStarTexture=null,this.lensFlareDirtTexture=null,this.depthOfFieldDistance=10,this.depthOfFieldBlurWidth=64,this.animations=[],this._currentDepthOfFieldSource=null,this._fixedExposure=1,this._currentExposure=1,this._hdrAutoExposure=!1,this._hdrCurrentLuminance=1,this._motionStrength=1,this._isObjectBasedMotionBlur=!1,this._camerasToBeAttached=[],this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._vlsEnabled=!1,this._lensFlareEnabled=!1,this._hdrEnabled=!1,this._motionBlurEnabled=!1,this._fxaaEnabled=!1,this._screenSpaceReflectionsEnabled=!1,this._motionBlurSamples=64,this._volumetricLightStepsCount=50,this._samples=1,this._cameras=s||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._basePostProcess=r,this._ratio=i,this._floatTextureType=t.getEngine().getCaps().textureFloatRender?1:2,t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline()}_buildPipeline(){const e=this._ratio,t=this._scene;this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new Ia("HDRPass",t,e,null,Y.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add(()=>{this._currentDepthOfFieldSource=this.screenSpaceReflectionPostProcess}),this.addEffect(new ci(t.getEngine(),"HDRScreenSpaceReflections",()=>this.screenSpaceReflectionPostProcess,!0))),this._basePostProcess?this.originalPostProcess=this._basePostProcess:this.originalPostProcess=new et("HDRPass","standard",[],[],e,null,Y.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add(()=>{this._currentDepthOfFieldSource=this.originalPostProcess}),this.addEffect(new ci(t.getEngine(),"HDRPassPostProcess",()=>this.originalPostProcess,!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(t,e/4),this._createBrightPassPostProcess(t,e/4),this._createBlurPostProcesses(t,e/4,1),this._createTextureAdderPostProcess(t,e),this.textureAdderFinalPostProcess=new et("HDRDepthOfFieldSource","standard",[],[],e,null,Y.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new ci(t.getEngine(),"HDRBaseDepthOfFieldSource",()=>this.textureAdderFinalPostProcess,!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(t,e),this.volumetricLightFinalPostProcess=new et("HDRVLSFinal","standard",[],[],e,null,Y.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new ci(t.getEngine(),"HDRVLSFinal",()=>this.volumetricLightFinalPostProcess,!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(t,e),this.lensFlareFinalPostProcess=new et("HDRPostLensFlareDepthOfFieldSource","standard",[],[],e,null,Y.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new ci(t.getEngine(),"HDRPostLensFlareDepthOfFieldSource",()=>this.lensFlareFinalPostProcess,!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(t,this._floatTextureType),this._createHdrPostProcess(t,e),this.hdrFinalPostProcess=new et("HDRPostHDReDepthOfFieldSource","standard",[],[],e,null,Y.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new ci(t.getEngine(),"HDRPostHDReDepthOfFieldSource",()=>this.hdrFinalPostProcess,!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(t,e/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(t,e)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(t,e),this._fxaaEnabled&&(this.fxaaPostProcess=new Ah("fxaa",1,null,Y.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,0),this.addEffect(new ci(t.getEngine(),"HDRFxaa",()=>this.fxaaPostProcess,!0))),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&X.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}_createDownSampleX4PostProcess(e,t){const i=new Array(32);this.downSampleX4PostProcess=new et("HDRDownSampleX4","standard",["dsOffsets"],[],t,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=r=>{let s=0;const n=this.downSampleX4PostProcess.width,a=this.downSampleX4PostProcess.height;for(let l=-2;l<2;l++)for(let c=-2;c<2;c++)i[s]=(l+.5)*(1/n),i[s+1]=(c+.5)*(1/a),s+=2;r.setArray2("dsOffsets",i)},this.addEffect(new ci(e.getEngine(),"HDRDownSampleX4",()=>this.downSampleX4PostProcess,!0))}_createBrightPassPostProcess(e,t){const i=new Array(8);this.brightPassPostProcess=new et("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],t,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=r=>{const s=1/this.brightPassPostProcess.width,n=1/this.brightPassPostProcess.height;i[0]=-.5*s,i[1]=.5*n,i[2]=.5*s,i[3]=.5*n,i[4]=-.5*s,i[5]=-.5*n,i[6]=.5*s,i[7]=-.5*n,r.setArray2("dsOffsets",i),r.setFloat("brightThreshold",this.brightThreshold)},this.addEffect(new ci(e.getEngine(),"HDRBrightPass",()=>this.brightPassPostProcess,!0))}_createBlurPostProcesses(e,t,i,r="blurWidth"){const s=e.getEngine(),n=new Yr("HDRBlurH_"+i,new Ie(1,0),this[r],t,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType),a=new Yr("HDRBlurV_"+i,new Ie(0,1),this[r],t,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType);n.onActivateObservable.add(()=>{const l=n.width/s.getRenderWidth();n.kernel=this[r]*l}),a.onActivateObservable.add(()=>{const l=a.height/s.getRenderHeight();a.kernel=this.horizontalBlur?64*l:this[r]*l}),this.addEffect(new ci(e.getEngine(),"HDRBlurH"+i,()=>n,!0)),this.addEffect(new ci(e.getEngine(),"HDRBlurV"+i,()=>a,!0)),this.blurHPostProcesses.push(n),this.blurVPostProcesses.push(a)}_createTextureAdderPostProcess(e,t){this.textureAdderPostProcess=new et("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],t,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=i=>{i.setTextureFromPostProcess("otherSampler",this._vlsEnabled?this._currentDepthOfFieldSource:this.originalPostProcess),i.setTexture("lensSampler",this.lensTexture),i.setFloat("exposure",this._currentExposure),this._currentDepthOfFieldSource=this.textureAdderFinalPostProcess},this.addEffect(new ci(e.getEngine(),"HDRTextureAdder",()=>this.textureAdderPostProcess,!0))}_createVolumetricLightPostProcess(e,t){const i=e.enableGeometryBufferRenderer();i.enablePosition=!0;const r=i.getGBuffer();this.volumetricLightPostProcess=new et("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],t/8,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,`#define VLS
#define NB_STEPS `+this._volumetricLightStepsCount.toFixed(1));const s=Ie.Zero();this.volumetricLightPostProcess.onApply=n=>{if(this.sourceLight&&this.sourceLight.getShadowGenerator()&&this._scene.activeCamera){const a=this.sourceLight.getShadowGenerator();n.setTexture("shadowMapSampler",a.getShadowMap()),n.setTexture("positionSampler",r.textures[2]),n.setColor3("sunColor",this.sourceLight.diffuse),n.setVector3("sunDirection",this.sourceLight.getShadowDirection()),n.setVector3("cameraPosition",this._scene.activeCamera.globalPosition),n.setMatrix("shadowViewProjection",a.getTransformMatrix()),n.setFloat("scatteringCoefficient",this.volumetricLightCoefficient),n.setFloat("scatteringPower",this.volumetricLightPower),s.x=this.sourceLight.getDepthMinZ(this._scene.activeCamera),s.y=this.sourceLight.getDepthMaxZ(this._scene.activeCamera),n.setVector2("depthValues",s)}},this.addEffect(new ci(e.getEngine(),"HDRVLS",()=>this.volumetricLightPostProcess,!0)),this._createBlurPostProcesses(e,t/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new et("HDRVLSMerge","standard",[],["originalSampler"],t,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=n=>{n.setTextureFromPostProcess("originalSampler",this._bloomEnabled?this.textureAdderFinalPostProcess:this.originalPostProcess),this._currentDepthOfFieldSource=this.volumetricLightFinalPostProcess},this.addEffect(new ci(e.getEngine(),"HDRVLSMerge",()=>this.volumetricLightMergePostProces,!0))}_createLuminancePostProcesses(e,t){let i=Math.pow(3,ai.LuminanceSteps);this.luminancePostProcess=new et("HDRLuminance","standard",["lumOffsets"],[],{width:i,height:i},null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE",t);const r=[];this.luminancePostProcess.onApply=n=>{const a=1/this.luminancePostProcess.width,l=1/this.luminancePostProcess.height;r[0]=-.5*a,r[1]=.5*l,r[2]=.5*a,r[3]=.5*l,r[4]=-.5*a,r[5]=-.5*l,r[6]=.5*a,r[7]=-.5*l,n.setArray2("lumOffsets",r)},this.addEffect(new ci(e.getEngine(),"HDRLuminance",()=>this.luminancePostProcess,!0));for(let n=ai.LuminanceSteps-1;n>=0;n--){i=Math.pow(3,n);let a=`#define LUMINANCE_DOWN_SAMPLE
`;n===0&&(a+="#define FINAL_DOWN_SAMPLER");const l=new et("HDRLuminanceDownSample"+n,"standard",["dsOffsets","halfDestPixelSize"],[],{width:i,height:i},null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,a,t);this.luminanceDownSamplePostProcesses.push(l)}let s=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach((n,a)=>{const l=new Array(18);n.onApply=c=>{if(!s)return;let h=0;for(let u=-1;u<2;u++)for(let d=-1;d<2;d++)l[h]=u/s.width,l[h+1]=d/s.height,h+=2;c.setArray2("dsOffsets",l),c.setFloat("halfDestPixelSize",.5/s.width),a===this.luminanceDownSamplePostProcesses.length-1?s=this.luminancePostProcess:s=n},a===this.luminanceDownSamplePostProcesses.length-1&&(n.onAfterRender=()=>{const c=e.getEngine().readPixels(0,0,1,1),h=new Tt(1/(255*255*255),1/(255*255),1/255,1);c.then(u=>{const d=new Uint8Array(u.buffer);this._hdrCurrentLuminance=(d[0]*h.x+d[1]*h.y+d[2]*h.z+d[3]*h.w)/100})}),this.addEffect(new ci(e.getEngine(),"HDRLuminanceDownSample"+a,()=>n,!0))})}_createHdrPostProcess(e,t){const i=["#define HDR"];this._hdrAutoExposure&&i.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new et("HDR","standard",["averageLuminance"],["textureAdderSampler"],t,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,i.join(`
`),0);let r=1,s=0,n=0;this.hdrPostProcess.onApply=a=>{if(a.setTextureFromPostProcess("textureAdderSampler",this._currentDepthOfFieldSource),s+=e.getEngine().getDeltaTime(),r<0)r=this._hdrCurrentLuminance;else{const l=(n-s)/1e3;this._hdrCurrentLuminance<r+this.hdrDecreaseRate*l?r+=this.hdrDecreaseRate*l:this._hdrCurrentLuminance>r-this.hdrIncreaseRate*l?r-=this.hdrIncreaseRate*l:r=this._hdrCurrentLuminance}this.hdrAutoExposure?this._currentExposure=this._fixedExposure/r:(r=Ee.Clamp(r,this.hdrMinimumLuminance,1e20),a.setFloat("averageLuminance",r)),n=s,this._currentDepthOfFieldSource=this.hdrFinalPostProcess},this.addEffect(new ci(e.getEngine(),"HDR",()=>this.hdrPostProcess,!0))}_createLensFlarePostProcess(e,t){this.lensFlarePostProcess=new et("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],t/2,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new ci(e.getEngine(),"HDRLensFlare",()=>this.lensFlarePostProcess,!0)),this._createBlurPostProcesses(e,t/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new et("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],t,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new ci(e.getEngine(),"HDRLensFlareCompose",()=>this.lensFlareComposePostProcess,!0));const i=new Ie(0,0);this.lensFlarePostProcess.externalTextureSamplerBinding=!0,this.lensFlarePostProcess.onApply=n=>{n.setTextureFromPostProcess("textureSampler",this._bloomEnabled?this.blurHPostProcesses[0]:this.originalPostProcess),n.setTexture("lensColorSampler",this.lensColorTexture),n.setFloat("strength",this.lensFlareStrength),n.setFloat("ghostDispersal",this.lensFlareGhostDispersal),n.setFloat("haloWidth",this.lensFlareHaloWidth),i.x=this.lensFlarePostProcess.width,i.y=this.lensFlarePostProcess.height,n.setVector2("resolution",i),n.setFloat("distortionStrength",this.lensFlareDistortionStrength)};const r=H.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),s=H.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=n=>{if(!this._scene.activeCamera)return;n.setTextureFromPostProcess("otherSampler",this.lensFlarePostProcess),n.setTexture("lensDirtSampler",this.lensFlareDirtTexture),n.setTexture("lensStarSampler",this.lensStarTexture);const a=this._scene.activeCamera.getViewMatrix().getRow(0),l=this._scene.activeCamera.getViewMatrix().getRow(2);let c=x.Dot(a.toVector3(),new x(1,0,0))+x.Dot(l.toVector3(),new x(0,0,1));c*=4;const h=H.FromValues(Math.cos(c)*.5,-Math.sin(c),0,0,Math.sin(c),Math.cos(c)*.5,0,0,0,0,1,0,0,0,0,1),u=s.multiply(h).multiply(r);n.setMatrix("lensStarMatrix",u),this._currentDepthOfFieldSource=this.lensFlareFinalPostProcess}}_createDepthOfFieldPostProcess(e,t){this.depthOfFieldPostProcess=new et("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],t,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=i=>{i.setTextureFromPostProcess("otherSampler",this._currentDepthOfFieldSource),i.setTexture("depthSampler",this._getDepthTexture()),i.setFloat("distance",this.depthOfFieldDistance)},this.addEffect(new ci(e.getEngine(),"HDRDepthOfField",()=>this.depthOfFieldPostProcess,!0))}_createMotionBlurPostProcess(e,t){if(this._isObjectBasedMotionBlur){const i=new Ec("HDRMotionBlur",e,t,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,0);i.motionStrength=this.motionStrength,i.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=i}else{this.motionBlurPostProcess=new et("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],t,null,Y.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,`#define MOTION_BLUR
#define MAX_MOTION_SAMPLES `+this.motionBlurSamples.toFixed(1),0);let i=0,r=H.Identity();const s=H.Identity();let n=H.Identity();const a=Ie.Zero();this.motionBlurPostProcess.onApply=l=>{n=e.getProjectionMatrix().multiply(e.getViewMatrix()),n.invertToRef(s),l.setMatrix("inverseViewProjection",s),l.setMatrix("prevViewProjection",r),r=n,a.x=this.motionBlurPostProcess.width,a.y=this.motionBlurPostProcess.height,l.setVector2("screenSize",a),i=e.getEngine().getFps()/60,l.setFloat("motionScale",i),l.setFloat("motionStrength",this.motionStrength),l.setTexture("depthSampler",this._getDepthTexture())}}this.addEffect(new ci(e.getEngine(),"HDRMotionBlur",()=>this.motionBlurPostProcess,!0))}_getDepthTexture(){return this._scene.getEngine().getCaps().drawBuffersExtension?this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]:this._scene.enableDepthRenderer().getDepthMap()}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this.originalPostProcess&&this.originalPostProcess.dispose(t),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(t),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(t),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(t),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(t),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(t),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(t),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(t),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(t),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(t),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(t),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(t);for(let i=0;i<this.luminanceDownSamplePostProcesses.length;i++)this.luminanceDownSamplePostProcesses[i].dispose(t);this.luminancePostProcess&&this.luminancePostProcess.dispose(t),this.hdrPostProcess&&this.hdrPostProcess.dispose(t),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(t),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(t),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(t),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(t);for(let i=0;i<this.blurHPostProcesses.length;i++)this.blurHPostProcesses[i].dispose(t);for(let i=0;i<this.blurVPostProcesses.length;i++)this.blurVPostProcesses[i].dispose(t)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses.length=0,this.blurHPostProcesses.length=0,this.blurVPostProcesses.length=0}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}serialize(){const e=ke.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(e.screenSpaceReflectionPostProcess=ke.Serialize(this.screenSpaceReflectionPostProcess)),e.customType="StandardRenderingPipeline",e}static Parse(e,t,i){const r=ke.Parse(()=>new ai(e._name,t,e._ratio),e,t,i);return e.sourceLightId&&(r.sourceLight=t.getLightById(e.sourceLightId)),e.screenSpaceReflectionPostProcess&&ke.Parse(()=>r.screenSpaceReflectionPostProcess,e.screenSpaceReflectionPostProcess,t,i),r}}ai.LuminanceSteps=6;M([F()],ai.prototype,"brightThreshold",void 0);M([F()],ai.prototype,"blurWidth",void 0);M([F()],ai.prototype,"horizontalBlur",void 0);M([F()],ai.prototype,"exposure",null);M([Bt("lensTexture")],ai.prototype,"lensTexture",void 0);M([F()],ai.prototype,"volumetricLightCoefficient",void 0);M([F()],ai.prototype,"volumetricLightPower",void 0);M([F()],ai.prototype,"volumetricLightBlurScale",void 0);M([F()],ai.prototype,"hdrMinimumLuminance",void 0);M([F()],ai.prototype,"hdrDecreaseRate",void 0);M([F()],ai.prototype,"hdrIncreaseRate",void 0);M([F()],ai.prototype,"hdrAutoExposure",null);M([Bt("lensColorTexture")],ai.prototype,"lensColorTexture",void 0);M([F()],ai.prototype,"lensFlareStrength",void 0);M([F()],ai.prototype,"lensFlareGhostDispersal",void 0);M([F()],ai.prototype,"lensFlareHaloWidth",void 0);M([F()],ai.prototype,"lensFlareDistortionStrength",void 0);M([F()],ai.prototype,"lensFlareBlurWidth",void 0);M([Bt("lensStarTexture")],ai.prototype,"lensStarTexture",void 0);M([Bt("lensFlareDirtTexture")],ai.prototype,"lensFlareDirtTexture",void 0);M([F()],ai.prototype,"depthOfFieldDistance",void 0);M([F()],ai.prototype,"depthOfFieldBlurWidth",void 0);M([F()],ai.prototype,"motionStrength",null);M([F()],ai.prototype,"objectBasedMotionBlur",null);M([F()],ai.prototype,"_ratio",void 0);M([F()],ai.prototype,"BloomEnabled",null);M([F()],ai.prototype,"DepthOfFieldEnabled",null);M([F()],ai.prototype,"LensFlareEnabled",null);M([F()],ai.prototype,"HDREnabled",null);M([F()],ai.prototype,"VLSEnabled",null);M([F()],ai.prototype,"MotionBlurEnabled",null);M([F()],ai.prototype,"fxaaEnabled",null);M([F()],ai.prototype,"screenSpaceReflectionsEnabled",null);M([F()],ai.prototype,"volumetricLightStepsCount",null);M([F()],ai.prototype,"motionBlurSamples",null);M([F()],ai.prototype,"samples",null);ye("BABYLON.StandardRenderingPipeline",ai);class xF{constructor(){this.enabled=!1,this.name="screenSpaceReflections2",this.texturesRequired=[6,3,5]}}const TF="screenSpaceRayTrace",EF=`float distanceSquared(vec2 a,vec2 b) { a-=b; return dot(a,a); }
/**
param csOrigin Camera-space ray origin,which must be 
within the view volume and must have z>0.01 and project within the valid screen rectangle
param csDirection Unit length camera-space ray direction
param projectToPixelMatrix A projection matrix that maps to **pixel** coordinates 
(**not** [-1,+1] normalized device coordinates).
param csZBuffer The camera-space Z buffer
param csZBufferSize Dimensions of csZBuffer
param csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer
param nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value
for clipping rays headed towards the camera
param stride Step in horizontal or vertical pixels between samples. This is a float
because integer math is slow on GPUs,but should be set to an integer>=1
param jitterFraction Number between 0 and 1 for how far to bump the ray in stride units
to conceal banding artifacts,plus the stride ray offset.
param maxSteps Maximum number of iterations. Higher gives better images but may be slow
param maxRayTraceDistance Maximum camera-space distance to trace before returning a miss
param selfCollisionNumSkip Number of steps to skip at start when raytracing to avoid self collisions.
1 is a reasonable value,depending on the scene you may need to set this value to 2
param hitPixel Pixel coordinates of the first intersection with the scene
param csHitPoint Camera space location of the ray hit
*/
#define inline
bool traceScreenSpaceRay1(
vec3 csOrigin,
vec3 csDirection,
mat4 projectToPixelMatrix,
sampler2D csZBuffer,
vec2 csZBufferSize,
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
sampler2D csZBackBuffer,
float csZBackSizeFactor,
#endif
float csZThickness,
float nearPlaneZ,
float stride,
float jitterFraction,
float maxSteps,
float maxRayTraceDistance,
float selfCollisionNumSkip,
out vec2 startPixel,
out vec2 hitPixel,
out vec3 csHitPoint
#ifdef SSRAYTRACE_DEBUG
,out vec3 debugColor
#endif
)
{
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
float rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ ? (-nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;
#else
float rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ ? (nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;
#endif
vec3 csEndPoint=csOrigin+csDirection*rayLength;
hitPixel=vec2(-1.0,-1.0);
vec4 H0=projectToPixelMatrix*vec4(csOrigin,1.0);
vec4 H1=projectToPixelMatrix*vec4(csEndPoint,1.0);
float k0=1.0/H0.w;
float k1=1.0/H1.w;
vec3 Q0=csOrigin*k0;
vec3 Q1=csEndPoint*k1;
vec2 P0=H0.xy*k0;
vec2 P1=H1.xy*k1;
#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM
float xMax=csZBufferSize.x-0.5,xMin=0.5,yMax=csZBufferSize.y-0.5,yMin=0.5;
float alpha=0.0;
if ((P1.y>yMax) || (P1.y<yMin)) {
alpha=(P1.y-((P1.y>yMax) ? yMax : yMin))/(P1.y-P0.y);
}
if ((P1.x>xMax) || (P1.x<xMin)) {
alpha=max(alpha,(P1.x-((P1.x>xMax) ? xMax : xMin))/(P1.x-P0.x));
}
P1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);
#endif
P1+=vec2((distanceSquared(P0,P1)<0.0001) ? 0.01 : 0.0);
vec2 delta=P1-P0;
bool permute=false;
if (abs(delta.x)<abs(delta.y)) { 
permute=true;
delta=delta.yx;
P0=P0.yx;
P1=P1.yx; 
}
float stepDirection=sign(delta.x);
float invdx=stepDirection/delta.x;
vec2 dP=vec2(stepDirection,delta.y*invdx);
vec3 dQ=(Q1-Q0)*invdx;
float dk=(k1-k0)*invdx;
float zMin=min(csEndPoint.z,csOrigin.z);
float zMax=max(csEndPoint.z,csOrigin.z);
dP*=stride; dQ*=stride; dk*=stride;
P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;
vec4 pqk=vec4(P0,Q0.z,k0);
vec4 dPQK=vec4(dP,dQ.z,dk);
startPixel=permute ? P0.yx : P0.xy;
float prevZMaxEstimate=csOrigin.z;
float rayZMin=prevZMaxEstimate,rayZMax=prevZMaxEstimate;
float sceneZMax=rayZMax+1e4;
float end=P1.x*stepDirection;
bool hit=false;
float stepCount;
for (stepCount=0.0;
stepCount<=selfCollisionNumSkip ||
(pqk.x*stepDirection)<=end &&
stepCount<maxSteps &&
!hit &&
sceneZMax != 0.0; 
pqk+=dPQK,++stepCount)
{
hitPixel=permute ? pqk.yx : pqk.xy;
rayZMin=prevZMaxEstimate;
rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);
rayZMax=clamp(rayZMax,zMin,zMax);
prevZMaxEstimate=rayZMax;
if (rayZMin>rayZMax) { 
float t=rayZMin; rayZMin=rayZMax; rayZMax=t;
}
sceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
float sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;
hit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);
#else
hit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);
#endif
#else
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
float sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;
hit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);
#else
hit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);
#endif
#endif
}
pqk-=dPQK;
stepCount-=1.0;
#ifdef SSRAYTRACE_ENABLE_REFINEMENT
if (stride>1.0 && hit) {
pqk-=dPQK;
stepCount-=1.0;
float invStride=1.0/stride;
dPQK*=invStride;
float refinementStepCount=0.0;
prevZMaxEstimate=pqk.z/pqk.w;
rayZMax=prevZMaxEstimate;
sceneZMax=rayZMax+1e7;
for (;
refinementStepCount<=1.0 ||
(refinementStepCount<=stride*1.4) &&
(rayZMax<sceneZMax) && (sceneZMax != 0.0);
pqk+=dPQK,refinementStepCount+=1.0)
{
rayZMin=prevZMaxEstimate;
rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);
rayZMax=clamp(rayZMax,zMin,zMax);
prevZMaxEstimate=rayZMax;
rayZMax=max(rayZMax,rayZMin);
hitPixel=permute ? pqk.yx : pqk.xy;
sceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;
}
pqk-=dPQK;
refinementStepCount-=1.0;
stepCount+=refinementStepCount/stride;
}
#endif
Q0.xy+=dQ.xy*stepCount;
Q0.z=pqk.z;
csHitPoint=Q0/pqk.w;
#ifdef SSRAYTRACE_DEBUG
if (((pqk.x+dPQK.x)*stepDirection)>end) {
debugColor=vec3(0,0,1);
} else if ((stepCount+1.0)>=maxSteps) {
debugColor=vec3(1,0,0);
} else if (sceneZMax==0.0) {
debugColor=vec3(1,1,0);
} else {
debugColor=vec3(0,stepCount/maxSteps,0);
}
#endif
return hit;
}
`;te.IncludesShadersStore[TF]=EF;const bF="screenSpaceReflection2PixelShader",SF=`uniform sampler2D textureSampler;
varying vec2 vUV;
#ifdef SSR_SUPPORTED
uniform sampler2D reflectivitySampler;
uniform sampler2D normalSampler;
uniform sampler2D depthSampler;
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
uniform sampler2D backDepthSampler;
uniform float backSizeFactor;
#endif
#ifdef SSR_USE_ENVIRONMENT_CUBE
uniform samplerCube envCubeSampler;
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
uniform vec3 vReflectionPosition;
uniform vec3 vReflectionSize;
#endif
#endif
uniform mat4 view;
uniform mat4 invView;
uniform mat4 projection;
uniform mat4 invProjectionMatrix;
uniform mat4 projectionPixel;
uniform float nearPlaneZ;
uniform float stepSize;
uniform float maxSteps;
uniform float strength;
uniform float thickness;
uniform float roughnessFactor;
uniform float reflectionSpecularFalloffExponent;
uniform float maxDistance;
uniform float selfCollisionNumSkip;
#include<helperFunctions>
#include<screenSpaceRayTrace>
vec3 fresnelSchlick(float cosTheta,vec3 F0)
{
return F0+(1.0-F0)*pow(1.0-cosTheta,5.0);
}
vec3 hash(vec3 a)
{
a=fract(a*0.8);
a+=dot(a,a.yxz+19.19);
return fract((a.xxy+a.yxx)*a.zyx);
}
vec3 computeViewPosFromUVDepth(vec2 texCoord,float depth) {
vec4 ndc;
ndc.xy=texCoord*2.0-1.0;
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
ndc.z=-projection[2].z-projection[3].z/depth;
#else
ndc.z=projection[2].z+projection[3].z/depth;
#endif
ndc.w=1.0;
vec4 eyePos=invProjectionMatrix*ndc;
eyePos.xyz/=eyePos.w;
return eyePos.xyz;
}
float computeAttenuationForIntersection(ivec2 hitPixel,vec2 hitUV,vec3 vsRayOrigin,vec3 vsHitPoint,vec3 reflectionVector,float maxRayDistance) {
float attenuation=1.0;
#ifdef SSR_ATTENUATE_SCREEN_BORDERS
vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-hitUV.xy));
attenuation*=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);
#endif
#ifdef SSR_ATTENUATE_INTERSECTION_DISTANCE
attenuation*=1.0-clamp(distance(vsRayOrigin,vsHitPoint)/maxRayDistance,0.0,1.0);
#endif
#ifdef SSR_ATTENUATE_BACKFACE_REFLECTION
vec3 reflectionNormal=texelFetch(normalSampler,hitPixel,0).xyz;
float directionBasedAttenuation=smoothstep(-0.17,0.0,dot(reflectionNormal,-reflectionVector));
attenuation*=directionBasedAttenuation;
#endif
return attenuation;
}
#endif
void main()
{
#ifdef SSR_SUPPORTED
vec4 colorFull=texture2D(textureSampler,vUV);
vec3 color=toLinearSpace(colorFull.rgb);
vec4 reflectivity=texture2D(reflectivitySampler,vUV);
if (dot(reflectivity.rgb,vec3(1.))<=0.0) {
#ifdef USE_BLUR
gl_FragColor=vec4(0.);
#else
gl_FragColor=vec4(colorFull.rgb,1.0);
#endif
return;
}
vec2 texSize=vec2(textureSize(depthSampler,0));
vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz; 
float depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;
vec3 csPosition=computeViewPosFromUVDepth(vUV,depth);
vec3 csViewDirection=normalize(csPosition);
vec3 csReflectedVector=reflect(csViewDirection,csNormal);
#ifdef SSR_USE_ENVIRONMENT_CUBE
vec3 wReflectedVector=vec3(invView*vec4(csReflectedVector,0.0));
#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC
vec4 worldPos=invView*vec4(csPosition,1.0);
wReflectedVector=parallaxCorrectNormal(worldPos.xyz,normalize(wReflectedVector),vReflectionSize,vReflectionPosition);
#endif
#ifdef SSR_INVERTCUBICMAP
wReflectedVector.y*=-1.0;
#endif
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
wReflectedVector.z*=-1.0;
#endif
vec3 envColor=toLinearSpace(textureCube(envCubeSampler,wReflectedVector).xyz);
#else
vec3 envColor=color;
#endif
float reflectionAttenuation=1.0;
bool rayHasHit=false;
vec2 startPixel;
vec2 hitPixel;
vec3 hitPoint;
#ifdef SSRAYTRACE_DEBUG
vec3 debugColor;
#endif
#ifdef SSR_ATTENUATE_FACING_CAMERA
reflectionAttenuation*=1.0-smoothstep(0.25,0.5,dot(-csViewDirection,csReflectedVector));
#endif
if (reflectionAttenuation>0.0) {
#ifdef SSR_USE_BLUR
vec3 jitt=vec3(0.);
#else
float roughness=1.0-reflectivity.a;
vec3 jitt=mix(vec3(0.0),hash(csPosition),roughness)*roughnessFactor; 
#endif
vec2 uv2=vUV*texSize;
float c=(uv2.x+uv2.y)*0.25;
float jitter=mod(c,1.0); 
rayHasHit=traceScreenSpaceRay1(
csPosition,
normalize(csReflectedVector+jitt),
projectionPixel,
depthSampler,
texSize,
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
backDepthSampler,
backSizeFactor,
#endif
thickness,
nearPlaneZ,
stepSize,
jitter,
maxSteps,
maxDistance,
selfCollisionNumSkip,
startPixel,
hitPixel,
hitPoint
#ifdef SSRAYTRACE_DEBUG
,debugColor
#endif
);
}
#ifdef SSRAYTRACE_DEBUG
gl_FragColor=vec4(debugColor,1.);
return;
#endif
vec3 F0=reflectivity.rgb;
vec3 fresnel=fresnelSchlick(max(dot(csNormal,-csViewDirection),0.0),F0);
vec3 SSR=envColor;
if (rayHasHit) {
vec3 color=toLinearSpace(texelFetch(textureSampler,ivec2(hitPixel),0).rgb);
reflectionAttenuation*=computeAttenuationForIntersection(ivec2(hitPixel),hitPixel/texSize,csPosition,hitPoint,csReflectedVector,maxDistance);
SSR=color*reflectionAttenuation+(1.0-reflectionAttenuation)*envColor;
}
SSR*=fresnel;
#ifdef SSR_USE_BLUR
float blur_radius=0.0;
float roughness=1.0-reflectivity.a*(1.0-roughnessFactor);
if (roughness>0.001) {
float cone_angle=min(roughness,0.999)*3.14159265*0.5;
float cone_len=distance(startPixel,hitPixel);
float op_len=2.0*tan(cone_angle)*cone_len; 
float a=op_len;
float h=cone_len;
float a2=a*a;
float fh2=4.0f*h*h;
blur_radius=(a*(sqrt(a2+fh2)-a))/(4.0f*h);
}
gl_FragColor=vec4(SSR,blur_radius/255.0); 
#else
vec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);
vec3 colorMultiplier=1.0-reflectionMultiplier;
gl_FragColor=vec4(toGammaSpace((color*colorMultiplier)+(SSR*reflectionMultiplier)),colorFull.a);
#endif
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;te.ShadersStore[bF]=SF;const yF="screenSpaceReflection2BlurPixelShader",CF=`uniform sampler2D textureSampler;
varying vec2 vUV;
uniform float blurQuality;
uniform vec2 texelOffsetScale;
const float weights[8]=float[8] (0.071303,0.131514,0.189879,0.321392,0.452906, 0.584419,0.715932,0.847445);
void processSample(vec2 uv,float i,vec2 stepSize,out vec4 accumulator,out float denominator)
{
vec2 offsetUV=stepSize*i+uv;
float coefficient=weights[int(blurQuality-abs(i))];
accumulator+=texture2D(textureSampler,offsetUV)*coefficient;
denominator+=coefficient;
}
void main()
{
vec4 colorFull=texture2D(textureSampler,vUV);
if (dot(colorFull,vec4(1.0))==0.0) {
gl_FragColor=colorFull;
return;
}
float blurRadius=colorFull.a*255.0; 
vec2 stepSize=texelOffsetScale.xy*blurRadius;
vec4 accumulator=texture2D(textureSampler,vUV)*0.214607;
float denominator=0.214607;
processSample(vUV,1.0,stepSize,accumulator,denominator);
processSample(vUV,1.0*0.2,stepSize,accumulator,denominator);
processSample(vUV,1.0*0.4,stepSize,accumulator,denominator);
processSample(vUV,1.0*0.6,stepSize,accumulator,denominator);
processSample(vUV,1.0*0.8,stepSize,accumulator,denominator);
processSample(vUV,1.0*1.2,stepSize,accumulator,denominator);
processSample(vUV,1.0*1.4,stepSize,accumulator,denominator);
processSample(vUV,1.0*1.6,stepSize,accumulator,denominator);
processSample(vUV,1.0*1.8,stepSize,accumulator,denominator);
processSample(vUV,1.0*2.0,stepSize,accumulator,denominator);
processSample(vUV,-1.0,stepSize,accumulator,denominator);
processSample(vUV,-1.0*0.2,stepSize,accumulator,denominator);
processSample(vUV,-1.0*0.4,stepSize,accumulator,denominator);
processSample(vUV,-1.0*0.6,stepSize,accumulator,denominator);
processSample(vUV,-1.0*0.8,stepSize,accumulator,denominator);
processSample(vUV,-1.0*1.2,stepSize,accumulator,denominator);
processSample(vUV,-1.0*1.4,stepSize,accumulator,denominator);
processSample(vUV,-1.0*1.6,stepSize,accumulator,denominator);
processSample(vUV,-1.0*1.8,stepSize,accumulator,denominator);
processSample(vUV,-1.0*2.0,stepSize,accumulator,denominator);
gl_FragColor=vec4(accumulator.rgb/denominator,colorFull.a);
}
`;te.ShadersStore[yF]=CF;const AF="screenSpaceReflection2BlurCombinerPixelShader",RF=`uniform sampler2D textureSampler; 
uniform sampler2D mainSampler;
uniform sampler2D reflectivitySampler;
uniform float strength;
uniform float reflectionSpecularFalloffExponent;
varying vec2 vUV;
#include<helperFunctions>
void main()
{
vec3 SSR=texture2D(textureSampler,vUV).rgb;
vec4 color=toLinearSpace(texture2D(mainSampler,vUV));
vec4 reflectivity=texture2D(reflectivitySampler,vUV);
vec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);
vec3 colorMultiplier=1.0-reflectionMultiplier;
gl_FragColor=vec4(toGammaSpace((color.rgb*colorMultiplier)+(SSR*reflectionMultiplier)),color.a);
}
`;te.ShadersStore[AF]=RF;const IF=H.Compose(new x(.5,.5,.5),oe.Identity(),new x(.5,.5,.5)),PF=H.Compose(new x(.5,.5,1),oe.Identity(),new x(.5,.5,0));class Sr extends Ph{set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}get blurDispersionStrength(){return this._blurDispersionStrength}set blurDispersionStrength(e){if(e===this._blurDispersionStrength)return;const t=e===0&&this._blurDispersionStrength!==0||e!==0&&this._blurDispersionStrength===0;this._blurDispersionStrength=e,t&&this._buildPipeline()}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e,this._updateEffectDefines()}get environmentTextureIsProbe(){return this._environmentTextureIsProbe}set environmentTextureIsProbe(e){this._environmentTextureIsProbe=e,this._updateEffectDefines()}get attenuateScreenBorders(){return this._attenuateScreenBorders}set attenuateScreenBorders(e){this._attenuateScreenBorders!==e&&(this._attenuateScreenBorders=e,this._updateEffectDefines())}get attenuateIntersectionDistance(){return this._attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._attenuateIntersectionDistance!==e&&(this._attenuateIntersectionDistance=e,this._updateEffectDefines())}get attenuateFacingCamera(){return this._attenuateFacingCamera}set attenuateFacingCamera(e){this._attenuateFacingCamera!==e&&(this._attenuateFacingCamera=e,this._updateEffectDefines())}get attenuateBackfaceReflection(){return this._attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._attenuateBackfaceReflection!==e&&(this._attenuateBackfaceReflection=e,this._updateEffectDefines())}get clipToFrustum(){return this._clipToFrustum}set clipToFrustum(e){this._clipToFrustum!==e&&(this._clipToFrustum=e,this._updateEffectDefines())}get enableAutomaticThicknessComputation(){return this._enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._enableAutomaticThicknessComputation!==e&&(this._enableAutomaticThicknessComputation=e,this._buildPipeline())}get backfaceDepthRenderer(){return this._depthRenderer}get backfaceDepthTextureSizeFactor(){return this._backfaceDepthTextureSizeFactor}set backfaceDepthTextureSizeFactor(e){this._backfaceDepthTextureSizeFactor!==e&&(this._backfaceDepthTextureSizeFactor=e,this._resizeDepthRenderer())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)):this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._buildPipeline())}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}get scene(){return this._scene}constructor(e,t,i,r=!1,s=0){if(super(t.getEngine(),e),this.SSRRenderEffect="SSRRenderEffect",this.SSRBlurRenderEffect="SSRBlurRenderEffect",this.SSRCombineRenderEffect="SSRCombineRenderEffect",this._samples=1,this.maxDistance=1e3,this.step=1,this.thickness=.5,this.strength=1,this.reflectionSpecularFalloffExponent=1,this.maxSteps=1e3,this.roughnessFactor=.2,this.selfCollisionNumSkip=1,this._blurDispersionStrength=1/20,this.blurQuality=2,this._enableSmoothReflections=!1,this._environmentTextureIsProbe=!1,this._attenuateScreenBorders=!0,this._attenuateIntersectionDistance=!0,this._attenuateFacingCamera=!1,this._attenuateBackfaceReflection=!1,this._clipToFrustum=!0,this._enableAutomaticThicknessComputation=!1,this._backfaceDepthTextureSizeFactor=1,this._isEnabled=!0,this._debug=!1,this._forceGeometryBuffer=!1,this._isDirty=!1,this._camerasToBeAttached=[],this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=s,this._forceGeometryBuffer=r,!this.isSupported){X.Error("The current engine does not support SSR.");return}if(t.postProcessRenderPipelineManager.addPipeline(this),this._forceGeometryBuffer){const n=t.enableGeometryBufferRenderer();n&&(n.enableReflectivity=!0)}else{const n=t.enablePrePassRenderer();n==null||n.markAsDirty()}this._buildPipeline()}getClassName(){return"SSRRenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(e=!1){this._disposeDepthRenderer(),this._disposePostProcesses(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}_getTextureSize(){const e=this._scene.getEngine(),t=this._geometryBufferRenderer,i=this._prePassRenderer;let r={width:e.getRenderWidth(),height:e.getRenderHeight()};if(t)r=t.getGBuffer().textures[0].getSize();else if(i){const s=i.getIndex(5),n=i.getRenderTarget();n&&n.textures&&(r=n.textures[s].getSize())}return r}_updateEffectDefines(){var e;const t=[];(this._geometryBufferRenderer||this._prePassRenderer)&&t.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&t.push("#define SSRAYTRACE_ENABLE_REFINEMENT"),this._scene.useRightHandedSystem&&t.push("#define SSRAYTRACE_RIGHT_HANDED_SCENE"),this._environmentTexture&&(t.push("#define SSR_USE_ENVIRONMENT_CUBE"),this._environmentTexture.boundingBoxSize&&t.push("#define SSR_USE_LOCAL_REFLECTIONMAP_CUBIC")),this._environmentTextureIsProbe&&t.push("#define SSR_INVERTCUBICMAP"),this._enableAutomaticThicknessComputation&&t.push("#define SSRAYTRACE_USE_BACK_DEPTHBUFFER"),this._attenuateScreenBorders&&t.push("#define SSR_ATTENUATE_SCREEN_BORDERS"),this._attenuateIntersectionDistance&&t.push("#define SSR_ATTENUATE_INTERSECTION_DISTANCE"),this._attenuateFacingCamera&&t.push("#define SSR_ATTENUATE_FACING_CAMERA"),this._attenuateBackfaceReflection&&t.push("#define SSR_ATTENUATE_BACKFACE_REFLECTION"),this._clipToFrustum&&t.push("#define SSRAYTRACE_CLIP_TO_FRUSTUM"),this._blurDispersionStrength>0&&t.push("#define SSR_USE_BLUR"),this._debug&&t.push("#define SSRAYTRACE_DEBUG"),(e=this._ssrPostProcess)===null||e===void 0||e.updateEffect(t.join(`
`))}_buildPipeline(){var e;if(!this._isEnabled){this._isDirty=!0;return}this._isDirty=!1;const t=this._scene.getEngine();if(this._disposeDepthRenderer(),this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._enableAutomaticThicknessComputation){const i=(e=this._cameras)===null||e===void 0?void 0:e[0];i&&(this._depthRendererCamera=i,this._depthRenderer=new xc(this._scene,void 0,void 0,void 0,1,!0,"SSRBackDepth"),this._depthRenderer.clearColor.r=1e8,this._depthRenderer.reverseCulling=!0,this._depthRenderer.getDepthMap().noPrePassRenderer=!0,this._resizeDepthRenderer(),i.customRenderTargets.push(this._depthRenderer.getDepthMap()))}this._createSSRPostProcess(),this.addEffect(new ci(t,this.SSRRenderEffect,()=>this._ssrPostProcess,!0)),this._blurDispersionStrength>0&&(this._createBlurAndCombinerPostProcesses(),this.addEffect(new ci(t,this.SSRBlurRenderEffect,()=>[this._blurPostProcessX,this._blurPostProcessY],!0)),this.addEffect(new ci(t,this.SSRCombineRenderEffect,()=>this._blurCombinerPostProcess,!0))),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_resizeDepthRenderer(){if(!this._depthRenderer)return;const e=this._getTextureSize(),t=this._depthRenderer.getDepthMap().getSize(),i=Math.floor(e.width/this._backfaceDepthTextureSizeFactor),r=Math.floor(e.height/this._backfaceDepthTextureSizeFactor);(t.width!==i||t.height!==r)&&this._depthRenderer.getDepthMap().resize({width:i,height:r})}_disposeDepthRenderer(){var e;if(this._depthRenderer){if(this._depthRendererCamera){const t=(e=this._depthRendererCamera.customRenderTargets.indexOf(this._depthRenderer.getDepthMap()))!==null&&e!==void 0?e:-1;t!==-1&&this._depthRendererCamera.customRenderTargets.splice(t,1)}this._depthRendererCamera=null,this._depthRenderer.getDepthMap().dispose()}this._depthRenderer=null}_disposePostProcesses(){var e,t,i,r;for(let s=0;s<this._cameras.length;s++){const n=this._cameras[s];(e=this._ssrPostProcess)===null||e===void 0||e.dispose(n),(t=this._blurPostProcessX)===null||t===void 0||t.dispose(n),(i=this._blurPostProcessY)===null||i===void 0||i.dispose(n),(r=this._blurCombinerPostProcess)===null||r===void 0||r.dispose(n)}this._ssrPostProcess=null,this._blurPostProcessX=null,this._blurPostProcessY=null,this._blurCombinerPostProcess=null}_createSSRPostProcess(){this._ssrPostProcess=new et("ssr","screenSpaceReflection2",["projection","invProjectionMatrix","view","invView","thickness","reflectionSpecularFalloffExponent","strength","stepSize","maxSteps","roughnessFactor","projectionPixel","nearPlaneZ","maxDistance","selfCollisionNumSkip","vReflectionPosition","vReflectionSize","backSizeFactor"],["textureSampler","normalSampler","reflectivitySampler","depthSampler","envCubeSampler","backDepthSampler"],1,null,this._textureType,this._scene.getEngine(),!1,"",this._textureType),this._updateEffectDefines(),this._ssrPostProcess.onApply=e=>{this._resizeDepthRenderer();const t=this._geometryBufferRenderer,i=this._prePassRenderer;if(!i&&!t)return;if(t){const l=t.getTextureIndex(Qi.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("normalSampler",t.getGBuffer().textures[1]),e.setTexture("reflectivitySampler",t.getGBuffer().textures[l]),e.setTexture("depthSampler",t.getGBuffer().textures[0])}else if(i){const l=i.getIndex(5),c=i.getIndex(3),h=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[h]),e.setTexture("depthSampler",i.getRenderTarget().textures[l]),e.setTexture("reflectivitySampler",i.getRenderTarget().textures[c])}this._enableAutomaticThicknessComputation&&this._depthRenderer&&(e.setTexture("backDepthSampler",this._depthRenderer.getDepthMap()),e.setFloat("backSizeFactor",this._backfaceDepthTextureSizeFactor));const r=this._scene.activeCamera;if(!r)return;const s=r.getViewMatrix(!0),n=r.getProjectionMatrix(!0);n.invertToRef(j.Matrix[0]),s.invertToRef(j.Matrix[1]),e.setMatrix("projection",n),e.setMatrix("view",s),e.setMatrix("invView",j.Matrix[1]),e.setMatrix("invProjectionMatrix",j.Matrix[0]),e.setFloat("thickness",this.thickness),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("maxSteps",this.maxSteps),e.setFloat("roughnessFactor",this.roughnessFactor),e.setFloat("nearPlaneZ",r.minZ),e.setFloat("maxDistance",this.maxDistance),e.setFloat("selfCollisionNumSkip",this.selfCollisionNumSkip);const a=this._getTextureSize();H.ScalingToRef(a.width,a.height,1,j.Matrix[2]),n.multiplyToRef(this._scene.getEngine().isWebGPU?PF:IF,j.Matrix[3]),j.Matrix[3].multiplyToRef(j.Matrix[2],j.Matrix[4]),e.setMatrix("projectionPixel",j.Matrix[4]),this._environmentTexture&&(e.setTexture("envCubeSampler",this._environmentTexture),this._environmentTexture.boundingBoxSize&&(e.setVector3("vReflectionPosition",this._environmentTexture.boundingBoxPosition),e.setVector3("vReflectionSize",this._environmentTexture.boundingBoxSize)))},this._ssrPostProcess.samples=this.samples,this._forceGeometryBuffer||(this._ssrPostProcess._prePassEffectConfiguration=new xF)}_createBlurAndCombinerPostProcesses(){const e=this._scene.getEngine();this._blurPostProcessX=new et("SSRblurX","screenSpaceReflection2Blur",["blurQuality","texelOffsetScale"],["textureSampler"],1,null,2,e,!1,"",this._textureType),this._blurPostProcessX.autoClear=!1,this._blurPostProcessX.onApplyObservable.add(t=>{var i,r;let s=this._scene.getEngine().getRenderWidth();if(this._prePassRenderer){const n=this._prePassRenderer.getIndex(4),a=this._prePassRenderer.getRenderTarget();a&&a.textures&&(s=a.textures[n].getSize().width)}else s=(r=(i=this._ssrPostProcess)===null||i===void 0?void 0:i.inputTexture.width)!==null&&r!==void 0?r:s;t.setFloat("blurQuality",this.blurQuality),t.setFloat2("texelOffsetScale",this._blurDispersionStrength/s,0)}),this._blurPostProcessY=new et("SSRblurY","screenSpaceReflection2Blur",["blurQuality","texelOffsetScale"],["textureSampler"],1,null,2,e,!1,"",this._textureType),this._blurPostProcessY.autoClear=!1,this._blurPostProcessY.onApplyObservable.add(t=>{var i,r;let s=this._scene.getEngine().getRenderHeight();if(this._prePassRenderer){const n=this._prePassRenderer.getIndex(4),a=this._prePassRenderer.getRenderTarget();a&&a.textures&&(s=a.textures[n].getSize().height)}else s=(r=(i=this._ssrPostProcess)===null||i===void 0?void 0:i.inputTexture.height)!==null&&r!==void 0?r:s;t.setFloat("blurQuality",this.blurQuality),t.setFloat2("texelOffsetScale",0,this._blurDispersionStrength/s)}),this._blurCombinerPostProcess=new et("SSRblurCombiner","screenSpaceReflection2BlurCombiner",["strength","reflectionSpecularFalloffExponent"],["textureSampler","mainSampler","reflectivitySampler"],1,null,1,e,!1,"",this._textureType),this._blurCombinerPostProcess.autoClear=!1,this._blurCombinerPostProcess.onApplyObservable.add(t=>{const i=this._geometryBufferRenderer,r=this._prePassRenderer;if(!(!r&&!i)){if(r){const s=r.getIndex(4),n=r.getRenderTarget();n&&n.textures&&t.setTexture("mainSampler",n.textures[s])}else t._bindTexture("mainSampler",this._ssrPostProcess.inputTexture.texture);if(i){const s=i.getTextureIndex(Qi.REFLECTIVITY_TEXTURE_TYPE);t.setTexture("reflectivitySampler",i.getGBuffer().textures[s])}else if(r){const s=r.getIndex(3);t.setTexture("reflectivitySampler",r.getRenderTarget().textures[s])}t.setFloat("strength",this.strength),t.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent)}})}serialize(){const e=ke.Serialize(this);return e.customType="SSRRenderingPipeline",e}static Parse(e,t,i){return ke.Parse(()=>new Sr(e._name,t,e._ratio),e,t,i)}}M([F()],Sr.prototype,"samples",null);M([F()],Sr.prototype,"maxDistance",void 0);M([F()],Sr.prototype,"step",void 0);M([F()],Sr.prototype,"thickness",void 0);M([F()],Sr.prototype,"strength",void 0);M([F()],Sr.prototype,"reflectionSpecularFalloffExponent",void 0);M([F()],Sr.prototype,"maxSteps",void 0);M([F()],Sr.prototype,"roughnessFactor",void 0);M([F()],Sr.prototype,"selfCollisionNumSkip",void 0);M([F("blurDispersionStrength")],Sr.prototype,"_blurDispersionStrength",void 0);M([F()],Sr.prototype,"blurQuality",void 0);M([F("enableSmoothReflections")],Sr.prototype,"_enableSmoothReflections",void 0);M([F("environmentTexture")],Sr.prototype,"_environmentTexture",void 0);M([F("environmentTextureIsProbe")],Sr.prototype,"_environmentTextureIsProbe",void 0);M([F("attenuateScreenBorders")],Sr.prototype,"_attenuateScreenBorders",void 0);M([F("attenuateIntersectionDistance")],Sr.prototype,"_attenuateIntersectionDistance",void 0);M([F("attenuateFacingCamera")],Sr.prototype,"_attenuateFacingCamera",void 0);M([F("attenuateBackfaceReflection")],Sr.prototype,"_attenuateBackfaceReflection",void 0);M([F("clipToFrustum")],Sr.prototype,"_clipToFrustum",void 0);M([F("enableAutomaticThicknessComputation")],Sr.prototype,"_enableAutomaticThicknessComputation",void 0);M([F("backfaceDepthTextureSizeFactor")],Sr.prototype,"_backfaceDepthTextureSizeFactor",void 0);M([F("isEnabled")],Sr.prototype,"_isEnabled",void 0);M([F("debug")],Sr.prototype,"_debug",void 0);ye("BABYLON.SSRRenderingPipeline",Sr);const MF="tonemapPixelShader",OF=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform float _ExposureAdjustment;
#if defined(HABLE_TONEMAPPING)
const float A=0.15;
const float B=0.50;
const float C=0.10;
const float D=0.20;
const float E=0.02;
const float F=0.30;
const float W=11.2;
#endif
float Luminance(vec3 c)
{
return dot(c,vec3(0.22,0.707,0.071));
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
vec3 colour=texture2D(textureSampler,vUV).rgb;
#if defined(REINHARD_TONEMAPPING)
float lum=Luminance(colour.rgb); 
float lumTm=lum*_ExposureAdjustment;
float scale=lumTm/(1.0+lumTm); 
colour*=scale/lum;
#elif defined(HABLE_TONEMAPPING)
colour*=_ExposureAdjustment;
const float ExposureBias=2.0;
vec3 x=ExposureBias*colour;
vec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;
x=vec3(W,W,W);
vec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);
colour=curr*whiteScale;
#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)
colour*=_ExposureAdjustment;
vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);
vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);
colour=retColor*retColor;
#elif defined(PHOTOGRAPHIC_TONEMAPPING)
colour= vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);
#endif
gl_FragColor=vec4(colour.rgb,1.0);
}`;te.ShadersStore[MF]=OF;var Sx;(function(o){o[o.Hable=0]="Hable",o[o.Reinhard=1]="Reinhard",o[o.HejiDawson=2]="HejiDawson",o[o.Photographic=3]="Photographic"})(Sx||(Sx={}));const DF="volumetricLightScatteringPixelShader",NF=`uniform sampler2D textureSampler;
uniform sampler2D lightScatteringSampler;
uniform float decay;
uniform float exposure;
uniform float weight;
uniform float density;
uniform vec2 meshPositionOnScreen;
varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec2 tc=vUV;
vec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);
deltaTexCoord*=1.0/float(NUM_SAMPLES)*density;
float illuminationDecay=1.0;
vec4 color=texture2D(lightScatteringSampler,tc)*0.4;
for(int i=0; i<NUM_SAMPLES; i++) {
tc-=deltaTexCoord;
vec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;
dataSample*=illuminationDecay*weight;
color+=dataSample;
illuminationDecay*=decay;
}
vec4 realColor=texture2D(textureSampler,vUV);
gl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));
#define CUSTOM_FRAGMENT_MAIN_END
}
`;te.ShadersStore[DF]=NF;const wF="volumetricLightScatteringPassVertexShader",FF=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
uniform mat4 viewProjection;
uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
}
`;te.ShadersStore[wF]=FF;const LF="volumetricLightScatteringPassPixelShader",BF=`#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
#endif
#if defined(ALPHATEST)
uniform sampler2D diffuseSampler;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#if defined(ALPHATEST)
vec4 diffuseColor=texture2D(diffuseSampler,vUV);
if (diffuseColor.a<0.4)
discard;
#endif
gl_FragColor=vec4(0.0,0.0,0.0,1.0);
}
`;te.ShadersStore[LF]=BF;class ma extends et{get useDiffuseColor(){return X.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1}set useDiffuseColor(e){X.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")}constructor(e,t,i,r,s=100,n=Y.BILINEAR_SAMPLINGMODE,a,l,c){var h,u;super(e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],t.postProcessRatio||t,i,n,a,l,"#define NUM_SAMPLES "+s),this._screenCoordinates=Ie.Zero(),this.customMeshPosition=x.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=new Array,this.includedMeshes=new Array,this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,c=(u=(h=i==null?void 0:i.getScene())!==null&&h!==void 0?h:c)!==null&&u!==void 0?u:this._scene,a=c.getEngine(),this._viewPort=new Dn(0,0,1,1).toGlobal(a.getRenderWidth(),a.getRenderHeight()),this.mesh=r??ma.CreateDefaultMesh("VolumetricLightScatteringMesh",c),this._createPass(c,t.passRatio||t),this.onActivate=d=>{this.isSupported||this.dispose(d),this.onActivate=null},this.onApplyObservable.add(d=>{this._updateMeshScreenCoordinates(c),d.setTexture("lightScatteringSampler",this._volumetricLightScatteringRTT),d.setFloat("exposure",this.exposure),d.setFloat("decay",this.decay),d.setFloat("weight",this.weight),d.setFloat("density",this.density),d.setVector2("meshPositionOnScreen",this._screenCoordinates)})}getClassName(){return"VolumetricLightScatteringPostProcess"}_isReady(e,t){var i;const r=e.getMesh();if(r===this.mesh&&r.material)return r.material.isReady(r);const s=(i=r._internalAbstractMeshDataInfo._materialForRenderPass)===null||i===void 0?void 0:i[this._scene.getEngine().currentRenderPassId];if(s)return s.isReadyForSubMesh(r,e,t);const n=[],a=[O.PositionKind],l=e.getMaterial();l&&(l.needAlphaTesting()&&n.push("#define ALPHATEST"),r.isVerticesDataPresent(O.UVKind)&&(a.push(O.UVKind),n.push("#define UV1")),r.isVerticesDataPresent(O.UV2Kind)&&(a.push(O.UV2Kind),n.push("#define UV2"))),r.useBones&&r.computeBonesUsingShaders?(a.push(O.MatricesIndicesKind),a.push(O.MatricesWeightsKind),n.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),n.push("#define BonesPerMesh "+(r.skeleton?r.skeleton.bones.length+1:0))):n.push("#define NUM_BONE_INFLUENCERS 0"),t&&(n.push("#define INSTANCES"),Ce.PushAttributesForInstances(a),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES"));const c=e._getDrawWrapper(void 0,!0),h=c.defines,u=n.join(`
`);return h!==u&&c.setEffect(r.getScene().getEngine().createEffect("volumetricLightScatteringPass",a,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],u,void 0,void 0,void 0,{maxSimultaneousMorphTargets:r.numBoneInfluencers}),u),c.effect.isReady()}setCustomMeshPosition(e){this.customMeshPosition=e}getCustomMeshPosition(){return this.customMeshPosition}dispose(e){const t=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);t!==-1&&e.getScene().customRenderTargets.splice(t,1),this._volumetricLightScatteringRTT.dispose(),super.dispose(e)}getPass(){return this._volumetricLightScatteringRTT}_meshExcluded(e){return this.includedMeshes.length>0&&this.includedMeshes.indexOf(e)===-1||this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1}_createPass(e,t){const i=e.getEngine();this._volumetricLightScatteringRTT=new Zi("volumetricLightScatteringMap",{width:i.getRenderWidth()*t,height:i.getRenderHeight()*t},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=Y.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=Y.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;const r=this.getCamera();r?r.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);const s=l=>{var c;const h=l.getRenderingMesh(),u=l.getEffectiveMesh();if(this._meshExcluded(h))return;u._internalAbstractMeshDataInfo._isActiveIntermediate=!1;const d=l.getMaterial();if(!d)return;const f=h.getScene(),_=f.getEngine();_.setState(d.backFaceCulling,void 0,void 0,void 0,d.cullBackFaces);const p=h._getInstancesRenderList(l._id,!!l.getReplacementMesh());if(p.mustReturn)return;const m=_.getCaps().instancedArrays&&(p.visibleInstances[l._id]!==null||h.hasThinInstances);if(this._isReady(l,m)){const T=(c=u._internalAbstractMeshDataInfo._materialForRenderPass)===null||c===void 0?void 0:c[_.currentRenderPassId];let b=l._getDrawWrapper();if(h===this.mesh&&!b&&(b=d._getDrawWrapper()),!b)return;const y=b.effect;if(_.enableEffect(b),m||h._bind(l,y,d.fillMode),h===this.mesh)d.bind(u.getWorldMatrix(),h);else if(T)T.bindForSubMesh(u.getWorldMatrix(),u,l);else{if(y.setMatrix("viewProjection",f.getTransformMatrix()),d&&d.needAlphaTesting()){const S=d.getAlphaTestTexture();y.setTexture("diffuseSampler",S),S&&y.setMatrix("diffuseMatrix",S.getTextureMatrix())}h.useBones&&h.computeBonesUsingShaders&&h.skeleton&&y.setMatrices("mBones",h.skeleton.getTransformMatrices(h))}m&&h.hasThinInstances&&y.setMatrix("world",u.getWorldMatrix()),h._processRendering(u,l,y,me.TriangleFillMode,p,m,(S,C)=>{S||y.setMatrix("world",C)})}};let n;const a=new Ye(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(()=>{n=e.clearColor,e.clearColor=a}),this._volumetricLightScatteringRTT.onAfterRenderObservable.add(()=>{e.clearColor=n}),this._volumetricLightScatteringRTT.customIsReadyFunction=(l,c,h)=>{if((h||c===0)&&l.subMeshes)for(let u=0;u<l.subMeshes.length;++u){const d=l.subMeshes[u],f=d.getMaterial(),_=d.getRenderingMesh();if(!f)continue;const p=_._getInstancesRenderList(d._id,!!d.getReplacementMesh()),m=i.getCaps().instancedArrays&&(p.visibleInstances[d._id]!==null||_.hasThinInstances);if(!this._isReady(d,m))return!1}return!0},this._volumetricLightScatteringRTT.customRenderFunction=(l,c,h,u)=>{const d=e.getEngine();let f;if(u.length){for(d.setColorWrite(!1),f=0;f<u.length;f++)s(u.data[f]);d.setColorWrite(!0)}for(f=0;f<l.length;f++)s(l.data[f]);for(f=0;f<c.length;f++)s(c.data[f]);if(h.length){for(f=0;f<h.length;f++){const p=h.data[f],m=p.getBoundingInfo();m&&e.activeCamera&&(p._alphaIndex=p.getMesh().alphaIndex,p._distanceToCamera=m.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}const _=h.data.slice(0,h.length);for(_.sort((p,m)=>p._alphaIndex>m._alphaIndex?1:p._alphaIndex<m._alphaIndex?-1:p._distanceToCamera<m._distanceToCamera?1:p._distanceToCamera>m._distanceToCamera?-1:0),d.setAlphaMode(2),f=0;f<_.length;f++)s(_[f]);d.setAlphaMode(0)}}}_updateMeshScreenCoordinates(e){const t=e.getTransformMatrix();let i;this.useCustomMeshPosition?i=this.customMeshPosition:this.attachedNode?i=this.attachedNode.position:i=this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;const r=x.Project(i,H.Identity(),t,this._viewPort);this._screenCoordinates.x=r.x/this._viewPort.width,this._screenCoordinates.y=r.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)}static CreateDefaultMesh(e,t){const i=om(e,{size:1},t);i.billboardMode=Qt.BILLBOARDMODE_ALL;const r=new Be(e+"Material",t);return r.emissiveColor=new ge(1,1,1),i.material=r,i}}M([Zs()],ma.prototype,"customMeshPosition",void 0);M([F()],ma.prototype,"useCustomMeshPosition",void 0);M([F()],ma.prototype,"invert",void 0);M([Du()],ma.prototype,"mesh",void 0);M([F()],ma.prototype,"excludedMeshes",void 0);M([F()],ma.prototype,"includedMeshes",void 0);M([F()],ma.prototype,"exposure",void 0);M([F()],ma.prototype,"decay",void 0);M([F()],ma.prototype,"weight",void 0);M([F()],ma.prototype,"density",void 0);ye("BABYLON.VolumetricLightScatteringPostProcess",ma);const UF="screenSpaceCurvaturePixelShader",VF=`precision highp float;
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D normalSampler;
uniform float curvature_ridge;
uniform float curvature_valley;
#ifndef CURVATURE_OFFSET
#define CURVATURE_OFFSET 1
#endif
float curvature_soft_clamp(float curvature,float control)
{
if (curvature<0.5/control)
return curvature*(1.0-curvature*control);
return 0.25/control;
}
float calculate_curvature(ivec2 texel,float ridge,float valley)
{
vec2 normal_up =texelFetch(normalSampler,texel+ivec2(0, CURVATURE_OFFSET),0).rb;
vec2 normal_down =texelFetch(normalSampler,texel+ivec2(0,-CURVATURE_OFFSET),0).rb;
vec2 normal_left =texelFetch(normalSampler,texel+ivec2(-CURVATURE_OFFSET,0),0).rb;
vec2 normal_right=texelFetch(normalSampler,texel+ivec2( CURVATURE_OFFSET,0),0).rb;
float normal_diff=((normal_up.g-normal_down.g)+(normal_right.r-normal_left.r));
if (normal_diff<0.0)
return -2.0*curvature_soft_clamp(-normal_diff,valley);
return 2.0*curvature_soft_clamp(normal_diff,ridge);
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
ivec2 texel=ivec2(gl_FragCoord.xy);
vec4 baseColor=texture2D(textureSampler,vUV);
float curvature=calculate_curvature(texel,curvature_ridge,curvature_valley);
baseColor.rgb*=curvature+1.0;
gl_FragColor=baseColor;
}`;te.ShadersStore[UF]=VF;class ju extends et{getClassName(){return"ScreenSpaceCurvaturePostProcess"}constructor(e,t,i,r,s,n,a,l=0,c=!1){super(e,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],i,r,s,n,a,void 0,l,void 0,null,c),this.ridge=1,this.valley=1,this._geometryBufferRenderer=t.enableGeometryBufferRenderer(),this._geometryBufferRenderer?this.onApply=h=>{h.setFloat("curvature_ridge",.5/Math.max(this.ridge*this.ridge,1e-4)),h.setFloat("curvature_valley",.7/Math.max(this.valley*this.valley,1e-4));const u=this._geometryBufferRenderer.getGBuffer().textures[1];h.setTexture("normalSampler",u)}:X.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first.")}static get IsSupported(){const e=qe.LastCreatedEngine;return e?e.getCaps().drawBuffersExtension:!1}static _Parse(e,t,i,r){return ke.Parse(()=>new ju(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,r)}}M([F()],ju.prototype,"ridge",void 0);M([F()],ju.prototype,"valley",void 0);ye("BABYLON.ScreenSpaceCurvaturePostProcess",ju);const kF="boundingBoxRendererFragmentDeclaration",GF=`uniform vec4 color;
`;te.IncludesShadersStore[kF]=GF;const zF="boundingBoxRendererUboDeclaration",HF=`#ifdef WEBGL2
uniform vec4 color;
uniform mat4 world;
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#else
layout(std140,column_major) uniform;
uniform BoundingBoxRenderer {
vec4 color;
mat4 world;
mat4 viewProjection;
mat4 viewProjectionR;
};
#endif
`;te.IncludesShadersStore[zF]=HF;const WF="boundingBoxRendererPixelShader",XF=`#include<__decl__boundingBoxRendererFragment>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;te.ShadersStore[WF]=XF;const $F="boundingBoxRendererVertexDeclaration",YF=`uniform mat4 world;
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
`;te.IncludesShadersStore[$F]=YF;const jF="boundingBoxRendererVertexShader",KF=`attribute vec3 position;
#include<__decl__boundingBoxRendererVertex>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec4 worldPos=world*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
#define CUSTOM_VERTEX_MAIN_END
}
`;te.ShadersStore[jF]=KF;Object.defineProperty(Ne.prototype,"forceShowBoundingBoxes",{get:function(){return this._forceShowBoundingBoxes||!1},set:function(o){this._forceShowBoundingBoxes=o,o&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0});Ne.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new qF(this)),this._boundingBoxRenderer};Object.defineProperty(Qt.prototype,"showBoundingBox",{get:function(){return this._showBoundingBox||!1},set:function(o){this._showBoundingBox=o,o&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});class qF{constructor(e){this.name=Re.NAME_BOUNDINGBOXRENDERER,this.frontColor=new ge(1,1,1),this.backColor=new ge(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new Q,this.onAfterBoxRenderingObservable=new Q,this.onResourcesReadyObservable=new Q,this.enabled=!0,this.renderList=new Lr(32),this._vertexBuffers={},this._fillIndexBuffer=null,this._fillIndexData=null,this.scene=e,e._addComponent(this),this._uniformBufferFront=new $e(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererFront",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferFront),this._uniformBufferBack=new $e(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererBack",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferBack)}_buildUniformLayout(e){e.addUniform("color",4),e.addUniform("world",16),e.addUniform("viewProjection",16),e.addUniform("viewProjectionR",16),e.create()}register(){this.scene._beforeEvaluateActiveMeshStage.registerStep(Re.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene._preActiveMeshStage.registerStep(Re.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this._preActiveMesh),this.scene._evaluateSubMeshStage.registerStep(Re.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this._evaluateSubMesh),this.scene._afterRenderingGroupDrawStage.registerStep(Re.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)}_evaluateSubMesh(e,t){if(e.showSubMeshesBoundingBox){const i=t.getBoundingInfo();i!=null&&(i.boundingBox._tag=e.renderingGroupId,this.renderList.push(i.boundingBox))}}_preActiveMesh(e){if(e.showBoundingBox||this.scene.forceShowBoundingBoxes){const t=e.getBoundingInfo();t.boundingBox._tag=e.renderingGroupId,this.renderList.push(t.boundingBox)}}_prepareResources(){if(this._colorShader)return;this._colorShader=new da("colorShader",this.scene,"boundingBoxRenderer",{attributes:[O.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!1),this._colorShader.doNotSerialize=!0,this._colorShader.reservedDataStore={hidden:!0},this._colorShaderForOcclusionQuery=new da("colorShaderOccQuery",this.scene,"boundingBoxRenderer",{attributes:[O.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!0),this._colorShaderForOcclusionQuery.doNotSerialize=!0,this._colorShaderForOcclusionQuery.reservedDataStore={hidden:!0};const e=this.scene.getEngine(),t=Em({size:1});this._vertexBuffers[O.PositionKind]=new O(e,t.positions,O.PositionKind,!1),this._createIndexBuffer(),this._fillIndexData=t.indices,this.onResourcesReadyObservable.notifyObservers(this)}_createIndexBuffer(){const e=this.scene.getEngine();this._indexBuffer=e.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}rebuild(){const e=this._vertexBuffers[O.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}reset(){this.renderList.reset()}render(e){var t,i;if(this.renderList.length===0||!this.enabled||(this._prepareResources(),!this._colorShader.isReady()))return;const r=this.scene.getEngine();r.setDepthWrite(!1);const s=this.frontColor.toColor4(),n=this.backColor.toColor4(),a=this.scene.getTransformMatrix();for(let l=0;l<this.renderList.length;l++){const c=this.renderList.data[l];if(c._tag!==e)continue;this._createWrappersForBoundingBox(c),this.onBeforeBoxRenderingObservable.notifyObservers(c);const h=c.minimum,d=c.maximum.subtract(h),f=h.add(d.scale(.5)),_=H.Scaling(d.x,d.y,d.z).multiply(H.Translation(f.x,f.y,f.z)).multiply(c.getWorldMatrix()),p=r.useReverseDepthBuffer;if(this.showBackLines){const T=(t=c._drawWrapperBack)!==null&&t!==void 0?t:this._colorShader._getDrawWrapper();this._colorShader._preBind(T),r.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),p?r.setDepthFunctionToLessOrEqual():r.setDepthFunctionToGreaterOrEqual(),this._uniformBufferBack.bindToEffect(T.effect,"BoundingBoxRenderer"),this._uniformBufferBack.updateDirectColor4("color",n),this._uniformBufferBack.updateMatrix("world",_),this._uniformBufferBack.updateMatrix("viewProjection",a),this._uniformBufferBack.update(),r.drawElementsType(me.LineListDrawMode,0,24)}const m=(i=c._drawWrapperFront)!==null&&i!==void 0?i:this._colorShader._getDrawWrapper();this._colorShader._preBind(m),r.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),p?r.setDepthFunctionToGreater():r.setDepthFunctionToLess(),this._uniformBufferFront.bindToEffect(m.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateDirectColor4("color",s),this._uniformBufferFront.updateMatrix("world",_),this._uniformBufferFront.updateMatrix("viewProjection",a),this._uniformBufferFront.update(),r.drawElementsType(me.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(c)}this._colorShader.unbind(),r.setDepthFunctionToLessOrEqual(),r.setDepthWrite(!0)}_createWrappersForBoundingBox(e){if(!e._drawWrapperFront){const t=this.scene.getEngine();e._drawWrapperFront=new vs(t),e._drawWrapperBack=new vs(t),e._drawWrapperFront.setEffect(this._colorShader.getEffect()),e._drawWrapperBack.setEffect(this._colorShader.getEffect())}}renderOcclusionBoundingBox(e){const t=this.scene.getEngine();this._renderPassIdForOcclusionQuery===void 0&&(this._renderPassIdForOcclusionQuery=t.createRenderPassId("Render pass for occlusion query"));const i=t.currentRenderPassId;t.currentRenderPassId=this._renderPassIdForOcclusionQuery,this._prepareResources();const r=e.subMeshes[0];if(!this._colorShaderForOcclusionQuery.isReady(e,void 0,r)||!e.hasBoundingInfo){t.currentRenderPassId=i;return}this._fillIndexBuffer||(this._fillIndexBuffer=t.createIndexBuffer(this._fillIndexData));const s=t.useReverseDepthBuffer;t.setDepthWrite(!1),t.setColorWrite(!1);const n=e.getBoundingInfo().boundingBox,a=n.minimum,c=n.maximum.subtract(a),h=a.add(c.scale(.5)),u=H.Scaling(c.x,c.y,c.z).multiply(H.Translation(h.x,h.y,h.z)).multiply(n.getWorldMatrix()),d=r._drawWrapper;this._colorShaderForOcclusionQuery._preBind(d),t.bindBuffers(this._vertexBuffers,this._fillIndexBuffer,d.effect),s?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._uniformBufferFront.bindToEffect(d.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateMatrix("world",u),this._uniformBufferFront.updateMatrix("viewProjection",this.scene.getTransformMatrix()),this._uniformBufferFront.update(),t.drawElementsType(me.TriangleFillMode,0,36),this._colorShaderForOcclusionQuery.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0),t.setColorWrite(!0),t.currentRenderPassId=i}dispose(){if(this._renderPassIdForOcclusionQuery!==void 0&&(this.scene.getEngine().releaseRenderPassId(this._renderPassIdForOcclusionQuery),this._renderPassIdForOcclusionQuery=void 0),!this._colorShader)return;this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this._colorShader.dispose(),this._colorShaderForOcclusionQuery.dispose(),this._uniformBufferFront.dispose(),this._uniformBufferBack.dispose();const e=this._vertexBuffers[O.PositionKind];e&&(e.dispose(),this._vertexBuffers[O.PositionKind]=null),this.scene.getEngine()._releaseBuffer(this._indexBuffer),this._fillIndexBuffer&&(this.scene.getEngine()._releaseBuffer(this._fillIndexBuffer),this._fillIndexBuffer=null)}}Ne.prototype.enableDepthRenderer=function(o,e=!1,t=!1,i=3){if(o=o||this.activeCamera,!o)throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[o.id]){const r=!!this.getEngine().getCaps().textureFloatRender;let s=0;this.getEngine().getCaps().textureHalfFloatRender&&(!t||!r)?s=2:r?s=1:s=0,this._depthRenderer[o.id]=new xc(this,s,o,e,i)}return this._depthRenderer[o.id]};Ne.prototype.disableDepthRenderer=function(o){o=o||this.activeCamera,!(!o||!this._depthRenderer||!this._depthRenderer[o.id])&&this._depthRenderer[o.id].dispose()};class QF{constructor(e){this.name=Re.NAME_DEPTHRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Re.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(Re.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)}rebuild(){}dispose(){for(const e in this.scene._depthRenderer)this.scene._depthRenderer[e].dispose()}_gatherRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&!i.useOnlyInActiveCamera&&e.push(i.getDepthMap())}}_gatherActiveCameraRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&i.useOnlyInActiveCamera&&this.scene.activeCamera.id===t&&e.push(i.getDepthMap())}}}xc._SceneComponentInitialization=o=>{let e=o._getComponent(Re.NAME_DEPTHRENDERER);e||(e=new QF(o),o._addComponent(e))};const ZF="oitFinalPixelShader",JF=`precision highp float;
uniform sampler2D uFrontColor;
uniform sampler2D uBackColor;
void main() {
ivec2 fragCoord=ivec2(gl_FragCoord.xy);
vec4 frontColor=texelFetch(uFrontColor,fragCoord,0);
vec4 backColor=texelFetch(uBackColor,fragCoord,0);
float alphaMultiplier=1.0-frontColor.a;
glFragColor=vec4(
frontColor.rgb+alphaMultiplier*backColor.rgb,
frontColor.a+backColor.a
);
}`;te.ShadersStore[ZF]=JF;const eL="oitBackBlendPixelShader",tL=`precision highp float;
uniform sampler2D uBackColor;
void main() {
glFragColor=texelFetch(uBackColor,ivec2(gl_FragCoord.xy),0);
if (glFragColor.a==0.0) { 
discard;
}
}`;te.ShadersStore[eL]=tL;class iL{constructor(){this.enabled=!0,this.name="depthPeeling",this.texturesRequired=[4]}}class zo{get passCount(){return this._passCount}set passCount(e){this._passCount!==e&&(this._passCount=e,this._createRenderPassIds())}get useRenderPasses(){return this._useRenderPasses}set useRenderPasses(e){this._useRenderPasses!==e&&(this._useRenderPasses=e,this._createRenderPassIds())}addExcludedMesh(e){this._excludedMeshes.indexOf(e.uniqueId)===-1&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);t!==-1&&this._excludedMeshes.splice(t,1)}constructor(e,t=5){if(this._thinTextures=[],this._currentPingPongState=0,this._layoutCacheFormat=[[!0],[!0,!0],[!0,!0,!0]],this._layoutCache=[],this._candidateSubMeshes=new Lr(10),this._excludedSubMeshes=new Lr(10),this._excludedMeshes=[],this._colorCache=[new Ye(zo._DEPTH_CLEAR_VALUE,zo._DEPTH_CLEAR_VALUE,0,0),new Ye(-zo._MIN_DEPTH,zo._MAX_DEPTH,0,0),new Ye(0,0,0,0)],this._scene=e,this._engine=e.getEngine(),this._passCount=t,!e.enablePrePassRenderer()){X.Warn("Depth peeling for order independant transparency could not enable PrePass, aborting.");return}for(let i=0;i<this._layoutCacheFormat.length;++i)this._layoutCache[i]=this._engine.buildTextureLayout(this._layoutCacheFormat[i]);this._renderPassIds=[],this.useRenderPasses=!1,this._prePassEffectConfiguration=new iL,this._createTextures(),this._createEffects()}_createRenderPassIds(){if(this._releaseRenderPassIds(),this._useRenderPasses)for(let e=0;e<this._passCount+1;++e)this._renderPassIds[e]||(this._renderPassIds[e]=this._engine.createRenderPassId(`DepthPeelingRenderer - pass #${e}`))}_releaseRenderPassIds(){for(let e=0;e<this._renderPassIds.length;++e)this._engine.releaseRenderPassId(this._renderPassIds[e]);this._renderPassIds=[]}_createTextures(){const e={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()};this._depthMrts=[new tc("depthPeelingDepth0",e,3,this._scene),new tc("depthPeelingDepth1",e,3,this._scene)],this._colorMrts=[new tc("depthPeelingColor0",e,2,this._scene,{generateDepthBuffer:!1}),new tc("depthPeelingColor1",e,2,this._scene,{generateDepthBuffer:!1})],this._blendBackMrt=new tc("depthPeelingBack",e,1,this._scene,{generateDepthBuffer:!1}),this._outputRT=new Zi("depthPeelingOutput",e,this._scene,!1);const t=[{format:7,samplingMode:1,type:this._engine.getCaps().textureFloatLinearFiltering?1:2},{format:5,samplingMode:1,type:2}];for(let i=0;i<2;i++){const r=this._engine._createInternalTexture(e,t[0],!1),s=this._engine._createInternalTexture(e,t[1],!1),n=this._engine._createInternalTexture(e,t[1],!1);this._depthMrts[i].setInternalTexture(r,0),this._depthMrts[i].setInternalTexture(s,1),this._depthMrts[i].setInternalTexture(n,2),this._colorMrts[i].setInternalTexture(s,0),this._colorMrts[i].setInternalTexture(n,1),this._thinTextures.push(new kh(r),new kh(s),new kh(n))}}_disposeTextures(){for(let e=0;e<this._thinTextures.length;e++)e!==6&&this._thinTextures[e].dispose();for(let e=0;e<2;e++)this._depthMrts[e].dispose(!0),this._colorMrts[e].dispose(!0),this._blendBackMrt.dispose(!0);this._outputRT.dispose(),this._thinTextures=[],this._colorMrts=[],this._depthMrts=[]}_updateTextures(){return(this._depthMrts[0].getSize().width!==this._engine.getRenderWidth()||this._depthMrts[0].getSize().height!==this._engine.getRenderHeight())&&(this._disposeTextures(),this._createTextures()),this._updateTextureReferences()}_updateTextureReferences(){var e;const t=this._scene.prePassRenderer;if(!t)return!1;const i=t.getIndex(4),r=!((e=t.defaultRT.textures)===null||e===void 0)&&e.length?t.defaultRT.textures[i].getInternalTexture():null;return r?(this._blendBackTexture!==r&&(this._blendBackTexture=r,this._blendBackMrt.setInternalTexture(this._blendBackTexture,0),this._thinTextures[6]&&this._thinTextures[6].dispose(),this._thinTextures[6]=new kh(this._blendBackTexture),t.defaultRT.renderTarget._shareDepth(this._depthMrts[0].renderTarget)),!0):!1}_createEffects(){this._blendBackEffectWrapper=new $o({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[]}),this._blendBackEffectWrapperPingPong=new $o({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[]}),this._finalEffectWrapper=new $o({fragmentShader:"oitFinal",useShaderStore:!0,engine:this._engine,samplerNames:["uFrontColor","uBackColor"],uniformNames:[]}),this._effectRenderer=new Tf(this._engine)}setPrePassRenderer(e){e.addEffectConfiguration(this._prePassEffectConfiguration)}bind(e){e.setTexture("oitDepthSampler",this._thinTextures[this._currentPingPongState*3]),e.setTexture("oitFrontColorSampler",this._thinTextures[this._currentPingPongState*3+1])}_renderSubMeshes(e){let t;this._useRenderPasses&&(t={});for(let i=0;i<e.length;i++){const r=e.data[i].getMaterial();let s=!0,n=!1;const a=e.data[i];let l,c=!1;if(this._useRenderPasses&&(l=a._getDrawWrapper(),c=!l),r&&(s=r.allowShaderHotSwapping,n=r.backFaceCulling,r.allowShaderHotSwapping=!1,r.backFaceCulling=!1),a.render(!1),c&&(l=a._getDrawWrapper(),l.materialContext)){let h=t[l.materialContext.uniqueId];h||(h=t[l.materialContext.uniqueId]=this._engine.createMaterialContext()),a._getDrawWrapper().materialContext=h}r&&(r.allowShaderHotSwapping=s,r.backFaceCulling=n)}}_finalCompose(e){var t;((t=this._scene.prePassRenderer)===null||t===void 0?void 0:t.setCustomOutput(this._outputRT))?this._engine.bindFramebuffer(this._outputRT.renderTarget):this._engine.restoreDefaultFramebuffer(),this._engine.setAlphaMode(0),this._engine.applyStates(),this._engine.enableEffect(this._finalEffectWrapper._drawWrapper),this._finalEffectWrapper.effect.setTexture("uFrontColor",this._thinTextures[e*3+1]),this._finalEffectWrapper.effect.setTexture("uBackColor",this._thinTextures[6]),this._effectRenderer.render(this._finalEffectWrapper)}render(e){if(this._candidateSubMeshes.length=0,this._excludedSubMeshes.length=0,!this._blendBackEffectWrapper.effect.isReady()||!this._blendBackEffectWrapperPingPong.effect.isReady()||!this._finalEffectWrapper.effect.isReady()||!this._updateTextures())return this._excludedSubMeshes;for(let s=0;s<e.length;s++){const n=e.data[s],a=n.getMaterial();a&&(a.fillMode===me.TriangleFanDrawMode||a.fillMode===me.TriangleFillMode||a.fillMode===me.TriangleStripDrawMode)&&this._excludedMeshes.indexOf(n.getMesh().uniqueId)===-1?this._candidateSubMeshes.push(n):this._excludedSubMeshes.push(n)}if(!this._candidateSubMeshes.length)return this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._finalCompose(1),this._excludedSubMeshes;const t=this._engine.currentRenderPassId;this._scene.prePassRenderer._enabled=!1,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[0]),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[1],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthMask=!1,this._engine.depthCullingState.depthTest=!0,this._engine.applyStates(),this._currentPingPongState=1,this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._scene.resetCachedMaterial();let i=0,r=0;for(let s=0;s<this._passCount;s++){i=s%2,r=1-i,this._currentPingPongState=i,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[s+1]),this._engine.bindFramebuffer(this._depthMrts[r].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[r].renderTarget),this._engine.bindFramebuffer(this._colorMrts[r].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[r].renderTarget),this._engine.bindFramebuffer(this._depthMrts[r].renderTarget),this._engine.bindAttachments(this._layoutCache[2]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthTest=!1,this._engine.applyStates(),this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[r].renderTarget),this._scene.resetCachedMaterial(),this._engine.bindFramebuffer(this._blendBackMrt.renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaEquation(0),this._engine.setAlphaMode(17),this._engine.applyStates();const n=r===0||!this._useRenderPasses?this._blendBackEffectWrapper:this._blendBackEffectWrapperPingPong;this._engine.enableEffect(n._drawWrapper),n.effect.setTexture("uBackColor",this._thinTextures[r*3+2]),this._effectRenderer.render(n),this._engine.unBindFramebuffer(this._blendBackMrt.renderTarget)}return this._engine.currentRenderPassId=t,this._finalCompose(r),this._scene.prePassRenderer._enabled=!0,this._engine.depthCullingState.depthMask=!0,this._engine.depthCullingState.depthTest=!0,this._excludedSubMeshes}dispose(){this._disposeTextures(),this._blendBackEffectWrapper.dispose(),this._finalEffectWrapper.dispose(),this._effectRenderer.dispose(),this._releaseRenderPassIds()}}zo._DEPTH_CLEAR_VALUE=-99999;zo._MIN_DEPTH=0;zo._MAX_DEPTH=1;Object.defineProperty(Ne.prototype,"depthPeelingRenderer",{get:function(){if(!this._depthPeelingRenderer){let o=this._getComponent(Re.NAME_DEPTHPEELINGRENDERER);o||(o=new rL(this),this._addComponent(o))}return this._depthPeelingRenderer},set:function(o){this._depthPeelingRenderer=o},enumerable:!0,configurable:!0});Object.defineProperty(Ne.prototype,"useOrderIndependentTransparency",{get:function(){return this._useOrderIndependentTransparency},set:function(o){var e;this._useOrderIndependentTransparency!==o&&(this._useOrderIndependentTransparency=o,this.markAllMaterialsAsDirty(63),(e=this.prePassRenderer)===null||e===void 0||e.markAsDirty())},enumerable:!0,configurable:!0});class rL{constructor(e){this.name=Re.NAME_DEPTHPEELINGRENDERER,this.scene=e,e.depthPeelingRenderer=new zo(e)}register(){}rebuild(){}dispose(){var e;(e=this.scene.depthPeelingRenderer)===null||e===void 0||e.dispose(),this.scene.depthPeelingRenderer=null}}const sL="linePixelShader",nL=`#include<clipPlaneFragmentDeclaration>
uniform vec4 color;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;te.ShadersStore[sL]=nL;const aL="lineVertexShader",oL=`#include<instancesDeclaration>
#include<clipPlaneVertexDeclaration>
attribute vec3 position;
attribute vec4 normal;
uniform mat4 viewProjection;
uniform float width;
uniform float aspectRatio;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
mat4 worldViewProjection=viewProjection*finalWorld;
vec4 viewPosition=worldViewProjection*vec4(position,1.0);
vec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);
vec2 currentScreen=viewPosition.xy/viewPosition.w;
vec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;
currentScreen.x*=aspectRatio;
nextScreen.x*=aspectRatio;
vec2 dir=normalize(nextScreen-currentScreen);
vec2 normalDir=vec2(-dir.y,dir.x);
normalDir*=width/2.0;
normalDir.x/=aspectRatio;
vec4 offset=vec4(normalDir*normal.w,0.0,0.0);
gl_Position=viewPosition+offset;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=finalWorld*vec4(position,1.0);
#include<clipPlaneVertex>
#endif
#define CUSTOM_VERTEX_MAIN_END
}`;te.ShadersStore[aL]=oL;Qt.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this};Qt.prototype.enableEdgesRendering=function(o=.95,e=!1,t){return this.disableEdgesRendering(),this._edgesRenderer=new Jf(this,o,e,!0,t),this};Object.defineProperty(Qt.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0});Eo.prototype.enableEdgesRendering=function(o=.95,e=!1){return this.disableEdgesRendering(),this._edgesRenderer=new cL(this,o,e),this};KT.prototype.enableEdgesRendering=function(o=.95,e=!1){return Eo.prototype.enableEdgesRendering.apply(this,arguments),this};class lL{constructor(){this.edges=new Array,this.edgesConnectedCount=0}}class Jf{get linesPositions(){return this._linesPositions}get linesNormals(){return this._linesNormals}get linesIndices(){return this._linesIndices}get lineShader(){return this._lineShader}set lineShader(e){this._lineShader=e}static _GetShader(e){if(!e._edgeRenderLineShader){const t=new da("lineShader",e,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"]},!1);t.disableDepthWrite=!0,t.backFaceCulling=!1,t.checkReadyOnEveryCall=e.getEngine().isWebGPU,e._edgeRenderLineShader=t}return e._edgeRenderLineShader}constructor(e,t=.95,i=!1,r=!0,s){var n;this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=new Array,this._linesNormals=new Array,this._linesIndices=new Array,this._buffers={},this._buffersForInstances={},this._checkVerticesInsteadOfIndices=!1,this.isEnabled=!0,this.customInstances=new Lr(32),this._source=e,this._checkVerticesInsteadOfIndices=i,this._options=s??null,this._epsilon=t,this._source.getScene().getEngine().isWebGPU&&(this._drawWrapper=new vs(e.getEngine())),this._prepareRessources(),r&&(!((n=s==null?void 0:s.useAlternateEdgeFinder)!==null&&n!==void 0)||n?this._generateEdgesLinesAlternate():this._generateEdgesLines()),this._meshRebuildObserver=this._source.onRebuildObservable.add(()=>{this._rebuild()}),this._meshDisposeObserver=this._source.onDisposeObservable.add(()=>{this.dispose()})}_prepareRessources(){this._lineShader||(this._lineShader=Jf._GetShader(this._source.getScene()))}_rebuild(){let e=this._buffers[O.PositionKind];e&&e._rebuild(),e=this._buffers[O.NormalKind],e&&e._rebuild();const i=this._source.getScene().getEngine();this._ib=i.createIndexBuffer(this._linesIndices)}dispose(){var e;this._source.onRebuildObservable.remove(this._meshRebuildObserver),this._source.onDisposeObservable.remove(this._meshDisposeObserver);let t=this._buffers[O.PositionKind];t&&(t.dispose(),this._buffers[O.PositionKind]=null),t=this._buffers[O.NormalKind],t&&(t.dispose(),this._buffers[O.NormalKind]=null),this._ib&&this._source.getScene().getEngine()._releaseBuffer(this._ib),this._lineShader.dispose(),(e=this._drawWrapper)===null||e===void 0||e.dispose()}_processEdgeForAdjacencies(e,t,i,r,s){return e===i&&t===r||e===r&&t===i?0:e===r&&t===s||e===s&&t===r?1:e===s&&t===i||e===i&&t===s?2:-1}_processEdgeForAdjacenciesWithVertices(e,t,i,r,s){return e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(r,1e-10)||e.equalsWithEpsilon(r,1e-10)&&t.equalsWithEpsilon(i,1e-10)?0:e.equalsWithEpsilon(r,1e-10)&&t.equalsWithEpsilon(s,1e-10)||e.equalsWithEpsilon(s,1e-10)&&t.equalsWithEpsilon(r,1e-10)?1:e.equalsWithEpsilon(s,1e-10)&&t.equalsWithEpsilon(i,1e-10)||e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(s,1e-10)?2:-1}_checkEdge(e,t,i,r,s){let n;t===void 0?n=!0:n=x.Dot(i[e],i[t])<this._epsilon,n&&this.createLine(r,s,this._linesPositions.length/3)}createLine(e,t,i){this._linesPositions.push(e.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,t.z,t.x,t.y,t.z),this._linesNormals.push(t.x,t.y,t.z,-1,t.x,t.y,t.z,1,e.x,e.y,e.z,-1,e.x,e.y,e.z,1),this._linesIndices.push(i,i+1,i+2,i,i+2,i+3)}_tessellateTriangle(e,t,i,r){const s=(D,w,L)=>{L>=0&&w.push(L);for(let U=0;U<D.length;++U)w.push(D[U][0])};let n=0;e[1].length>=e[0].length&&e[1].length>=e[2].length?n=1:e[2].length>=e[0].length&&e[2].length>=e[1].length&&(n=2);for(let D=0;D<3;++D)D===n?e[D].sort((w,L)=>w[1]<L[1]?-1:w[1]>L[1]?1:0):e[D].sort((w,L)=>w[1]>L[1]?-1:w[1]<L[1]?1:0);const a=[],l=[];s(e[n],a,-1);const c=a.length;for(let D=n+2;D>=n+1;--D)s(e[D%3],l,D!==n+2?r[i[t+(D+1)%3]]:-1);const h=l.length,u=0,d=0;i.push(r[i[t+n]],a[0],l[0]),i.push(r[i[t+(n+1)%3]],l[h-1],a[c-1]);const f=c<=h,_=f?c:h,p=f?h:c,m=f?c-1:h-1,T=f?0:1;let b=c+h-2,y=f?u:d,S=f?d:u;const C=f?a:l,I=f?l:a;let P=0;for(;b-- >0;){T?i.push(C[y],I[S]):i.push(I[S],C[y]),P+=_;let D;P>=p&&y<m?(D=C[++y],P-=p):D=I[++S],i.push(D)}i[t+0]=i[i.length-3],i[t+1]=i[i.length-2],i[t+2]=i[i.length-1],i.length=i.length-3}_generateEdgesLinesAlternate(){var e,t,i,r,s,n,a,l,c,h;const u=this._source.getVerticesData(O.PositionKind);let d=this._source.getIndices();if(!d||!u)return;Array.isArray(d)||(d=Array.from(d));const f=(t=(e=this._options)===null||e===void 0?void 0:e.useFastVertexMerger)!==null&&t!==void 0?t:!0,_=f?Math.round(-Math.log((r=(i=this._options)===null||i===void 0?void 0:i.epsilonVertexMerge)!==null&&r!==void 0?r:1e-6)/Math.log(10)):(n=(s=this._options)===null||s===void 0?void 0:s.epsilonVertexMerge)!==null&&n!==void 0?n:1e-6,p=[],m=[];if(f){const y={};for(let S=0;S<u.length;S+=3){const C=u[S+0],I=u[S+1],P=u[S+2],D=C.toFixed(_)+"|"+I.toFixed(_)+"|"+P.toFixed(_);if(y[D]!==void 0)p.push(y[D]);else{const w=S/3;y[D]=w,p.push(w),m.push(w)}}}else for(let y=0;y<u.length;y+=3){const S=u[y+0],C=u[y+1],I=u[y+2];let P=!1;for(let D=0;D<y&&!P;D+=3){const w=u[D+0],L=u[D+1],U=u[D+2];if(Math.abs(S-w)<_&&Math.abs(C-L)<_&&Math.abs(I-U)<_){p.push(D/3),P=!0;break}}P||(p.push(y/3),m.push(y/3))}if(!((a=this._options)===null||a===void 0)&&a.applyTessellation){const y=(c=(l=this._options)===null||l===void 0?void 0:l.epsilonVertexAligned)!==null&&c!==void 0?c:1e-6,S=[];for(let C=0;C<d.length;C+=3){let I;for(let P=0;P<3;++P){const D=p[d[C+P]],w=p[d[C+(P+1)%3]],L=p[d[C+(P+2)%3]];if(D===w)continue;const U=u[D*3+0],G=u[D*3+1],Z=u[D*3+2],he=u[w*3+0],_e=u[w*3+1],ne=u[w*3+2],Pe=Math.sqrt((he-U)*(he-U)+(_e-G)*(_e-G)+(ne-Z)*(ne-Z));for(let Se=0;Se<m.length-1;Se++){const ce=m[Se];if(ce===D||ce===w||ce===L)continue;const de=u[ce*3+0],k=u[ce*3+1],se=u[ce*3+2],xe=Math.sqrt((de-U)*(de-U)+(k-G)*(k-G)+(se-Z)*(se-Z)),le=Math.sqrt((de-he)*(de-he)+(k-_e)*(k-_e)+(se-ne)*(se-ne));Math.abs(xe+le-Pe)<y&&(I||(I={index:C,edgesPoints:[[],[],[]]},S.push(I)),I.edgesPoints[P].push([ce,xe]))}}}for(let C=0;C<S.length;++C){const I=S[C];this._tessellateTriangle(I.edgesPoints,I.index,d,p)}S.length=0}const T={};for(let y=0;y<d.length;y+=3){let S;for(let C=0;C<3;++C){let I=p[d[y+C]],P=p[d[y+(C+1)%3]];const D=p[d[y+(C+2)%3]];if(I===P||(I===D||P===D)&&(!((h=this._options)===null||h===void 0)&&h.removeDegeneratedTriangles))continue;if(j.Vector3[0].copyFromFloats(u[I*3+0],u[I*3+1],u[I*3+2]),j.Vector3[1].copyFromFloats(u[P*3+0],u[P*3+1],u[P*3+2]),j.Vector3[2].copyFromFloats(u[D*3+0],u[D*3+1],u[D*3+2]),S||(j.Vector3[1].subtractToRef(j.Vector3[0],j.Vector3[3]),j.Vector3[2].subtractToRef(j.Vector3[1],j.Vector3[4]),S=x.Cross(j.Vector3[3],j.Vector3[4]),S.normalize()),I>P){const U=I;I=P,P=U}const w=I+"_"+P,L=T[w];L?L.done||(x.Dot(S,L.normal)<this._epsilon&&this.createLine(j.Vector3[0],j.Vector3[1],this._linesPositions.length/3),L.done=!0):T[w]={normal:S,done:!1,index:y,i:C}}}for(const y in T){const S=T[y];if(!S.done){const C=p[d[S.index+S.i]],I=p[d[S.index+(S.i+1)%3]];j.Vector3[0].copyFromFloats(u[C*3+0],u[C*3+1],u[C*3+2]),j.Vector3[1].copyFromFloats(u[I*3+0],u[I*3+1],u[I*3+2]),this.createLine(j.Vector3[0],j.Vector3[1],this._linesPositions.length/3)}}const b=this._source.getScene().getEngine();this._buffers[O.PositionKind]=new O(b,this._linesPositions,O.PositionKind,!1),this._buffers[O.NormalKind]=new O(b,this._linesNormals,O.NormalKind,!1,!1,4),this._buffersForInstances[O.PositionKind]=this._buffers[O.PositionKind],this._buffersForInstances[O.NormalKind]=this._buffers[O.NormalKind],this._ib=b.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}_generateEdgesLines(){const e=this._source.getVerticesData(O.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=new Array,r=new Array;let s,n;for(s=0;s<t.length;s+=3){n=new lL;const l=t[s],c=t[s+1],h=t[s+2];n.p0=new x(e[l*3],e[l*3+1],e[l*3+2]),n.p1=new x(e[c*3],e[c*3+1],e[c*3+2]),n.p2=new x(e[h*3],e[h*3+1],e[h*3+2]);const u=x.Cross(n.p1.subtract(n.p0),n.p2.subtract(n.p1));u.normalize(),r.push(u),i.push(n)}for(s=0;s<i.length;s++){n=i[s];for(let l=s+1;l<i.length;l++){const c=i[l];if(n.edgesConnectedCount===3)break;if(c.edgesConnectedCount===3)continue;const h=t[l*3],u=t[l*3+1],d=t[l*3+2];for(let f=0;f<3;f++){let _=0;if(n.edges[f]===void 0){switch(f){case 0:this._checkVerticesInsteadOfIndices?_=this._processEdgeForAdjacenciesWithVertices(n.p0,n.p1,c.p0,c.p1,c.p2):_=this._processEdgeForAdjacencies(t[s*3],t[s*3+1],h,u,d);break;case 1:this._checkVerticesInsteadOfIndices?_=this._processEdgeForAdjacenciesWithVertices(n.p1,n.p2,c.p0,c.p1,c.p2):_=this._processEdgeForAdjacencies(t[s*3+1],t[s*3+2],h,u,d);break;case 2:this._checkVerticesInsteadOfIndices?_=this._processEdgeForAdjacenciesWithVertices(n.p2,n.p0,c.p0,c.p1,c.p2):_=this._processEdgeForAdjacencies(t[s*3+2],t[s*3],h,u,d);break}if(_!==-1&&(n.edges[f]=l,c.edges[_]=s,n.edgesConnectedCount++,c.edgesConnectedCount++,n.edgesConnectedCount===3))break}}}}for(s=0;s<i.length;s++){const l=i[s];this._checkEdge(s,l.edges[0],r,l.p0,l.p1),this._checkEdge(s,l.edges[1],r,l.p1,l.p2),this._checkEdge(s,l.edges[2],r,l.p2,l.p0)}const a=this._source.getScene().getEngine();this._buffers[O.PositionKind]=new O(a,this._linesPositions,O.PositionKind,!1),this._buffers[O.NormalKind]=new O(a,this._linesNormals,O.NormalKind,!1,!1,4),this._buffersForInstances[O.PositionKind]=this._buffers[O.PositionKind],this._buffersForInstances[O.NormalKind]=this._buffers[O.NormalKind],this._ib=a.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}isReady(){return this._lineShader.isReady(this._source,this._source.hasInstances&&this.customInstances.length>0||this._source.hasThinInstances)}render(){const e=this._source.getScene(),t=this._lineShader._getDrawWrapper();if(this._drawWrapper&&this._lineShader._setDrawWrapper(this._drawWrapper),!this.isReady()||!e.activeCamera){this._lineShader._setDrawWrapper(t);return}const i=this._source.hasInstances&&this.customInstances.length>0,r=i||this._source.hasThinInstances;let s=0;if(r)if(this._buffersForInstances.world0=this._source.getVertexBuffer("world0"),this._buffersForInstances.world1=this._source.getVertexBuffer("world1"),this._buffersForInstances.world2=this._source.getVertexBuffer("world2"),this._buffersForInstances.world3=this._source.getVertexBuffer("world3"),i){const a=this._source._instanceDataStorage;if(s=this.customInstances.length,!a.instancesData){this._source.getScene()._activeMeshesFrozen||this.customInstances.reset();return}if(!a.isFrozen){let l=0;for(let c=0;c<s;++c)this.customInstances.data[c].copyToArray(a.instancesData,l),l+=16;a.instancesBuffer.updateDirectly(a.instancesData,0,s)}}else s=this._source.thinInstanceCount;const n=e.getEngine();this._lineShader._preBind(),this._source.edgesColor.a!==1?n.setAlphaMode(2):n.setAlphaMode(0),n.bindBuffers(r?this._buffersForInstances:this._buffers,this._ib,this._lineShader.getEffect()),e.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),e.activeCamera.mode===Ve.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",n.getAspectRatio(e.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix()),n.drawElementsType(me.TriangleFillMode,0,this._indicesCount,s),this._lineShader.unbind(),r&&n.unbindInstanceAttributes(),this._source.getScene()._activeMeshesFrozen||this.customInstances.reset(),this._lineShader._setDrawWrapper(t)}}class cL extends Jf{constructor(e,t=.95,i=!1){super(e,t,i,!1),this._generateEdgesLines()}_generateEdgesLines(){const e=this._source.getVerticesData(O.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=j.Vector3[0],r=j.Vector3[1],s=t.length-1;for(let a=0,l=0;a<s;a+=2,l+=4)x.FromArrayToRef(e,3*t[a],i),x.FromArrayToRef(e,3*t[a+1],r),this.createLine(i,r,l);const n=this._source.getScene().getEngine();this._buffers[O.PositionKind]=new O(n,this._linesPositions,O.PositionKind,!1),this._buffers[O.NormalKind]=new O(n,this._linesNormals,O.NormalKind,!1,!1,4),this._ib=n.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}}class hL extends tc{constructor(e,t,i,r,s,n){super(e,i,r,s,n),this._beforeCompositionPostProcesses=[],this._internalTextureDirty=!1,this.enabled=!1,this.renderTargetTexture=null,this.renderTargetTexture=t}_createCompositionEffect(){this.imageProcessingPostProcess=new Df("prePassComposition",1,null,void 0,this._engine),this.imageProcessingPostProcess._updateParameters()}_checkSize(){const e=this._engine.getRenderWidth(!0),t=this._engine.getRenderHeight(!0),i=this.getRenderWidth(),r=this.getRenderHeight();(i!==e||r!==t)&&(this.resize({width:e,height:t}),this._internalTextureDirty=!0)}updateCount(e,t,i){super.updateCount(e,t,i),this._internalTextureDirty=!0}_resetPostProcessChain(){this._beforeCompositionPostProcesses.length=0}dispose(){const e=this._scene;if(super.dispose(),e&&e.prePassRenderer){const t=e.prePassRenderer.renderTargets.indexOf(this);t!==-1&&e.prePassRenderer.renderTargets.splice(t,1)}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose(),this.renderTargetTexture&&(this.renderTargetTexture._prePassRenderTarget=null),this._outputPostProcess&&(this._outputPostProcess.autoClear=!0,this._outputPostProcess.restoreDefaultInputTexture())}}class Sa{getIndex(e){return this._textureIndices[e]}get samples(){return this.defaultRT.samples}set samples(e){this.defaultRT.samples=e}getRenderTarget(){return this._currentTarget}_setRenderTarget(e){e?this._currentTarget=e:(this._currentTarget=this.defaultRT,this._engine.currentRenderPassId=this._currentTarget.renderPassId)}get currentRTisSceneRT(){return this._currentTarget===this.defaultRT}_refreshGeometryBufferRendererLink(){if(this.doNotUseGeometryRendererFallback)this._geometryBuffer&&this._geometryBuffer._unlinkPrePassRenderer(),this._geometryBuffer=null,this._scene.disableGeometryBufferRenderer();else{if(this._geometryBuffer=this._scene.enableGeometryBufferRenderer(),!this._geometryBuffer){this.doNotUseGeometryRendererFallback=!0;return}this._geometryBuffer._linkPrePassRenderer(this)}}get enabled(){return this._enabled}constructor(e){this.excludedSkinnedMesh=[],this.excludedMaterials=[],this.mrtCount=0,this._mrtFormats=[],this._mrtLayout=[],this._mrtNames=[],this._textureIndices=[],this._isDirty=!0,this._effectConfigurations=[],this.doNotUseGeometryRendererFallback=!0,this.renderTargets=[],this._clearColor=new Ye(0,0,0,0),this._enabled=!1,this._needsCompositionForThisPass=!1,this.disableGammaTransform=!1,this._scene=e,this._engine=e.getEngine(),Sa._SceneComponentInitialization(this._scene),this.defaultRT=this._createRenderTarget("sceneprePassRT",null),this._currentTarget=this.defaultRT}_createRenderTarget(e,t){const i=new hL(e,t,{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},0,this._scene,{generateMipMaps:!1,generateStencilBuffer:this._engine.isStencilEnable,defaultType:0,types:[],drawOnlyOnFirstAttachmentByDefault:!0});return this.renderTargets.push(i),i}get isSupported(){return this._scene.getEngine().getCaps().drawBuffersExtension}bindAttachmentsForEffect(e,t){const i=t.getMaterial(),r=i&&i.isPrePassCapable,s=i&&this.excludedMaterials.indexOf(i)!==-1;this.enabled&&this._currentTarget.enabled&&(e._multiTarget&&r&&!s?this._engine.bindAttachments(this._multiRenderAttachments):(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment(),this._geometryBuffer&&this.currentRTisSceneRT&&!s&&this._geometryBuffer.renderList.push(t.getRenderingMesh())))}_reinitializeAttachments(){const e=[],t=[!1],i=[!0];for(let r=0;r<this.mrtCount;r++)e.push(!0),r>0&&(t.push(!0),i.push(!1));this._multiRenderAttachments=this._engine.buildTextureLayout(e),this._clearAttachments=this._engine.buildTextureLayout(t),this._defaultAttachments=this._engine.buildTextureLayout(i)}_resetLayout(){for(let e=0;e<Sa._TextureFormats.length;e++)this._textureIndices[Sa._TextureFormats[e].type]=-1;this._textureIndices[4]=0,this._mrtLayout=[4],this._mrtFormats=[Sa._TextureFormats[4].format],this._mrtNames=[Sa._TextureFormats[4].name],this.mrtCount=1}_updateGeometryBufferLayout(){if(this._refreshGeometryBufferRendererLink(),this._geometryBuffer){this._geometryBuffer._resetLayout();const e=[];for(let i=0;i<this._mrtLayout.length;i++)e.push(!1);this._geometryBuffer._linkInternalTexture(this.defaultRT.getInternalTexture());const t=[{prePassConstant:5,geometryBufferConstant:Qi.DEPTH_TEXTURE_TYPE},{prePassConstant:6,geometryBufferConstant:Qi.NORMAL_TEXTURE_TYPE},{prePassConstant:1,geometryBufferConstant:Qi.POSITION_TEXTURE_TYPE},{prePassConstant:3,geometryBufferConstant:Qi.REFLECTIVITY_TEXTURE_TYPE},{prePassConstant:2,geometryBufferConstant:Qi.VELOCITY_TEXTURE_TYPE}];for(let i=0;i<t.length;i++){const r=this._mrtLayout.indexOf(t[i].prePassConstant);r!==-1&&(this._geometryBuffer._forceTextureType(t[i].geometryBufferConstant,r),e[r]=!0)}this._geometryBuffer._setAttachments(this._engine.buildTextureLayout(e))}}restoreAttachments(){this.enabled&&this._currentTarget.enabled&&this._defaultAttachments&&(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment())}_beforeDraw(e,t,i){this._isDirty&&this._update(),!(!this._enabled||!this._currentTarget.enabled)&&(this._geometryBuffer&&(this._geometryBuffer.renderList=[]),this._setupOutputForThisPass(this._currentTarget,e))}_prepareFrame(e,t,i){e.renderTargetTexture?e.renderTargetTexture._prepareFrame(this._scene,t,i,e.renderTargetTexture.useCameraPostProcesses):this._postProcessesSourceForThisPass.length?this._scene.postProcessManager._prepareFrame():this._engine.restoreDefaultFramebuffer()}setCustomOutput(e){const t=this._postProcessesSourceForThisPass[0];return t?(t.inputTexture=e.renderTarget,!0):!1}_renderPostProcesses(e,t){var i;const r=this._postProcessesSourceForThisPass[0],s=r?r.inputTexture:e.renderTargetTexture?e.renderTargetTexture.renderTarget:null;let n=this._currentTarget._beforeCompositionPostProcesses;this._needsCompositionForThisPass&&(n=n.concat([this._currentTarget.imageProcessingPostProcess])),n.length&&(this._scene.postProcessManager._prepareFrame((i=this._currentTarget.renderTarget)===null||i===void 0?void 0:i.texture,n),this._scene.postProcessManager.directRender(n,s,!1,t))}_afterDraw(e,t){this._enabled&&this._currentTarget.enabled&&(this._prepareFrame(this._currentTarget,e,t),this._renderPostProcesses(this._currentTarget,e))}_clear(){this._enabled&&this._currentTarget.enabled&&(this._bindFrameBuffer(this._currentTarget),this._engine.bindAttachments(this._clearAttachments),this._engine.clear(this._clearColor,!0,!1,!1),this._engine.bindAttachments(this._defaultAttachments))}_bindFrameBuffer(e){if(this._enabled&&this._currentTarget.enabled){this._currentTarget._checkSize();const t=this._currentTarget.renderTarget;t&&this._engine.bindFramebuffer(t)}}_setEnabled(e){this._enabled=e}_setRenderTargetEnabled(e,t){e.enabled=t,t||this._unlinkInternalTexture(e)}addEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e.name)return this._effectConfigurations[t];return this._effectConfigurations.push(e),e}_enable(){const e=this.mrtCount;for(let t=0;t<this._effectConfigurations.length;t++)this._effectConfigurations[t].enabled&&this._enableTextures(this._effectConfigurations[t].texturesRequired);for(let t=0;t<this.renderTargets.length;t++){(this.mrtCount!==e||this.renderTargets[t].count!==this.mrtCount)&&this.renderTargets[t].updateCount(this.mrtCount,{types:this._mrtFormats},this._mrtNames.concat("prePass_DepthBuffer")),this.renderTargets[t]._resetPostProcessChain();for(let i=0;i<this._effectConfigurations.length;i++)this._effectConfigurations[i].enabled&&(!this._effectConfigurations[i].postProcess&&this._effectConfigurations[i].createPostProcess&&this._effectConfigurations[i].createPostProcess(),this._effectConfigurations[i].postProcess&&this.renderTargets[t]._beforeCompositionPostProcesses.push(this._effectConfigurations[i].postProcess))}this._reinitializeAttachments(),this._setEnabled(!0),this._updateGeometryBufferLayout()}_disable(){this._setEnabled(!1);for(let e=0;e<this.renderTargets.length;e++)this._setRenderTargetEnabled(this.renderTargets[e],!1);this._resetLayout();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled=!1}_getPostProcessesSource(e,t){if(t)return t._postProcesses;if(e.renderTargetTexture)if(e.renderTargetTexture.useCameraPostProcesses){const i=e.renderTargetTexture.activeCamera?e.renderTargetTexture.activeCamera:this._scene.activeCamera;return i?i._postProcesses:[]}else return e.renderTargetTexture.postProcesses?e.renderTargetTexture.postProcesses:[];else return this._scene.activeCamera?this._scene.activeCamera._postProcesses:[]}_setupOutputForThisPass(e,t){const i=t&&this._scene.activeCameras&&!!this._scene.activeCameras.length&&this._scene.activeCameras.indexOf(t)!==0;this._postProcessesSourceForThisPass=this._getPostProcessesSource(e,t),this._postProcessesSourceForThisPass=this._postProcessesSourceForThisPass.filter(l=>l!=null),this._scene.autoClear=!0;const r=this._hasImageProcessing(this._postProcessesSourceForThisPass);this._needsCompositionForThisPass=!r&&!this.disableGammaTransform&&this._needsImageProcessing()&&!i;const s=this._getFirstPostProcess(this._postProcessesSourceForThisPass),n=e._beforeCompositionPostProcesses&&e._beforeCompositionPostProcesses[0];let a=null;this._scene.imageProcessingConfiguration.applyByPostProcess=this._needsCompositionForThisPass||r,this._needsCompositionForThisPass&&!e.imageProcessingPostProcess&&e._createCompositionEffect(),n?a=n:this._needsCompositionForThisPass?a=e.imageProcessingPostProcess:s&&(a=s),this._bindFrameBuffer(e),this._linkInternalTexture(e,a)}_linkInternalTexture(e,t){t&&(t.autoClear=!1,t.inputTexture=e.renderTarget),e._outputPostProcess!==t&&(e._outputPostProcess&&this._unlinkInternalTexture(e),e._outputPostProcess=t),e._internalTextureDirty&&(this._updateGeometryBufferLayout(),e._internalTextureDirty=!1)}_unlinkInternalTexture(e){e._outputPostProcess&&(e._outputPostProcess.autoClear=!0,e._outputPostProcess.restoreDefaultInputTexture(),e._outputPostProcess=null)}_needsImageProcessing(){for(let e=0;e<this._effectConfigurations.length;e++)if(this._effectConfigurations[e].enabled&&this._effectConfigurations[e].needsImageProcessing)return!0;return!1}_hasImageProcessing(e){var t;let i=!1;if(e){for(let r=0;r<e.length;r++)if(((t=e[r])===null||t===void 0?void 0:t.getClassName())==="ImageProcessingPostProcess"){i=!0;break}}return i}_getFirstPostProcess(e){for(let t=0;t<e.length;t++)if(e[t]!==null)return e[t];return null}markAsDirty(){this._isDirty=!0}_enableTextures(e){this._scene.needsPreviousWorldMatrices=!1;for(let t=0;t<e.length;t++){const i=e[t];this._textureIndices[i]===-1&&(this._textureIndices[i]=this._mrtLayout.length,this._mrtLayout.push(i),this._mrtFormats.push(Sa._TextureFormats[i].format),this._mrtNames.push(Sa._TextureFormats[i].name),this.mrtCount++),i===2&&(this._scene.needsPreviousWorldMatrices=!0)}}_update(){this._disable();let e=!1;this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._scene._depthPeelingRenderer&&this._scene.useOrderIndependentTransparency&&(this._scene._depthPeelingRenderer.setPrePassRenderer(this),e=!0);for(let i=0;i<this._scene.materials.length;i++)this._scene.materials[i].setPrePassRenderer(this)&&(e=!0);e&&this._setRenderTargetEnabled(this.defaultRT,!0);let t;for(let i=0;i<this.renderTargets.length;i++){if(this.renderTargets[i].renderTargetTexture)t=this._getPostProcessesSource(this.renderTargets[i]);else{const r=this._scene.activeCamera;if(!r)continue;t=r._postProcesses}if(t&&(t=t.filter(r=>r!=null),t)){for(let r=0;r<t.length;r++)t[r].setPrePassRenderer(this)&&(this._setRenderTargetEnabled(this.renderTargets[i],!0),e=!0);this._hasImageProcessing(t)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!0)}}this._markAllMaterialsAsPrePassDirty(),this._isDirty=!1,e&&this._enable()}_markAllMaterialsAsPrePassDirty(){const e=this._scene.materials;for(let t=0;t<e.length;t++)e[t].markAsDirty(me.PrePassDirtyFlag)}dispose(){for(let e=this.renderTargets.length-1;e>=0;e--)this.renderTargets[e].dispose();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].dispose&&this._effectConfigurations[e].dispose()}}Sa._SceneComponentInitialization=o=>{throw pt("PrePassRendererSceneComponent")};Sa._TextureFormats=[{type:0,format:2,name:"prePass_Irradiance"},{type:1,format:2,name:"prePass_Position"},{type:2,format:0,name:"prePass_Velocity"},{type:3,format:0,name:"prePass_Reflectivity"},{type:4,format:2,name:"prePass_Color"},{type:5,format:2,name:"prePass_Depth"},{type:6,format:2,name:"prePass_Normal"},{type:7,format:0,name:"prePass_Albedo"}];Object.defineProperty(Ne.prototype,"prePassRenderer",{get:function(){return this._prePassRenderer},set:function(o){o&&o.isSupported&&(this._prePassRenderer=o)},enumerable:!0,configurable:!0});Ne.prototype.enablePrePassRenderer=function(){return this._prePassRenderer?this._prePassRenderer:(this._prePassRenderer=new Sa(this),this._prePassRenderer.isSupported||(this._prePassRenderer=null,X.Error(`PrePassRenderer needs WebGL 2 support.
Maybe you tried to use the following features that need the PrePassRenderer :
 + Subsurface Scattering`)),this._prePassRenderer)};Ne.prototype.disablePrePassRenderer=function(){this._prePassRenderer&&(this._prePassRenderer.dispose(),this._prePassRenderer=null)};class uL{constructor(e){this.name=Re.NAME_PREPASSRENDERER,this.scene=e}register(){this.scene._beforeCameraDrawStage.registerStep(Re.STEP_BEFORECAMERADRAW_PREPASS,this,this._beforeCameraDraw),this.scene._afterCameraDrawStage.registerStep(Re.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterCameraDraw),this.scene._beforeRenderTargetDrawStage.registerStep(Re.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this._beforeRenderTargetDraw),this.scene._afterRenderTargetDrawStage.registerStep(Re.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterRenderTargetDraw),this.scene._beforeClearStage.registerStep(Re.STEP_BEFORECLEAR_PREPASS,this,this._beforeClearStage),this.scene._beforeRenderTargetClearStage.registerStep(Re.STEP_BEFORERENDERTARGETCLEAR_PREPASS,this,this._beforeRenderTargetClearStage),this.scene._beforeRenderingMeshStage.registerStep(Re.STEP_BEFORERENDERINGMESH_PREPASS,this,this._beforeRenderingMeshStage),this.scene._afterRenderingMeshStage.registerStep(Re.STEP_AFTERRENDERINGMESH_PREPASS,this,this._afterRenderingMeshStage)}_beforeRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._beforeDraw(void 0,t,i))}_afterRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&this.scene.prePassRenderer._afterDraw(t,i)}_beforeRenderTargetClearStage(e){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(e._prePassRenderTarget||(e._prePassRenderTarget=this.scene.prePassRenderer._createRenderTarget(e.name+"_prePassRTT",e)),this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._clear())}_beforeCameraDraw(e){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._beforeDraw(e))}_afterCameraDraw(){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw()}_beforeClearStage(){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._clear())}_beforeRenderingMeshStage(e,t,i,r){if(!r)return;const s=e.getScene();s.prePassRenderer&&s.prePassRenderer.bindAttachmentsForEffect(r,t)}_afterRenderingMeshStage(e){const t=e.getScene();t.prePassRenderer&&t.prePassRenderer.restoreAttachments()}rebuild(){this.scene.disablePrePassRenderer(),this.scene.enablePrePassRenderer()}dispose(){this.scene.disablePrePassRenderer()}}Sa._SceneComponentInitialization=o=>{let e=o._getComponent(Re.NAME_PREPASSRENDERER);e||(e=new uL(o),o._addComponent(e))};const dL="fibonacci",fL=`#define rcp(x) 1./x
#define GOLDEN_RATIO 1.618033988749895
#define TWO_PI 6.2831855
vec2 Golden2dSeq(int i,float n)
{
return vec2(float(i)/n+(0.5/n),fract(float(i)*rcp(GOLDEN_RATIO)));
}
vec2 SampleDiskGolden(int i,int sampleCount)
{
vec2 f=Golden2dSeq(i,float(sampleCount));
return vec2(sqrt(f.x),TWO_PI*f.y);
}`;te.IncludesShadersStore[dL]=fL;const _L="diffusionProfile",pL=`uniform vec3 diffusionS[5];
uniform float diffusionD[5];
uniform float filterRadii[5];`;te.IncludesShadersStore[_L]=pL;const mL="subSurfaceScatteringPixelShader",gL=`#include<fibonacci>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<diffusionProfile>
varying vec2 vUV;
uniform vec2 texelSize;
uniform sampler2D textureSampler;
uniform sampler2D irradianceSampler;
uniform sampler2D depthSampler;
uniform sampler2D albedoSampler;
uniform vec2 viewportSize;
uniform float metersPerUnit;
const float LOG2_E=1.4426950408889634;
const float SSS_PIXELS_PER_SAMPLE=4.;
const int _SssSampleBudget=40;
#define rcp(x) 1./x
#define Sq(x) x*x
#define SSS_BILATERAL_FILTER true
vec3 EvalBurleyDiffusionProfile(float r,vec3 S)
{
vec3 exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S); 
vec3 expSum=exp_13*(1.+exp_13*exp_13); 
return (S*rcp(8.*PI))*expSum; 
}
vec2 SampleBurleyDiffusionProfile(float u,float rcpS)
{
u=1.-u; 
float g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));
float n=exp2(log2(g)*(-1.0/3.0)); 
float p=(g*n)*n; 
float c=1.+p+n; 
float d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u); 
float x=(3./LOG2_E)*log2(c)-d; 
float rcpExp=((c*c)*c)*rcp((4.*u)*((c*c)+(4.*u)*(4.*u)));
float r=x*rcpS;
float rcpPdf=(8.*PI*rcpS)*rcpExp; 
return vec2(r,rcpPdf);
}
vec3 ComputeBilateralWeight(float xy2,float z,float mmPerUnit,vec3 S,float rcpPdf)
{
#ifndef SSS_BILATERAL_FILTER
z=0.;
#endif
float r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));
float area=rcpPdf;
#if SSS_CLAMP_ARTIFACT
return clamp(EvalBurleyDiffusionProfile(r,S)*area,0.0,1.0);
#else
return EvalBurleyDiffusionProfile(r,S)*area;
#endif
}
void EvaluateSample(int i,int n,vec3 S,float d,vec3 centerPosVS,float mmPerUnit,float pixelsPerMm,
float phase,inout vec3 totalIrradiance,inout vec3 totalWeight)
{
float scale =rcp(float(n));
float offset=rcp(float(n))*0.5;
float sinPhase,cosPhase;
sinPhase=sin(phase);
cosPhase=cos(phase);
vec2 bdp=SampleBurleyDiffusionProfile(float(i)*scale+offset,d);
float r=bdp.x;
float rcpPdf=bdp.y;
float phi=SampleDiskGolden(i,n).y;
float sinPhi,cosPhi;
sinPhi=sin(phi);
cosPhi=cos(phi);
float sinPsi=cosPhase*sinPhi+sinPhase*cosPhi; 
float cosPsi=cosPhase*cosPhi-sinPhase*sinPhi; 
vec2 vec=r*vec2(cosPsi,sinPsi);
vec2 position; 
float xy2;
position=vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*texelSize;
xy2 =r*r;
vec4 textureSample=texture2D(irradianceSampler,position);
float viewZ=texture2D(depthSampler,position).r;
vec3 irradiance =textureSample.rgb;
if (testLightingForSSS(textureSample.a))
{
float relZ=viewZ-centerPosVS.z;
vec3 weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);
totalIrradiance+=weight*irradiance;
totalWeight +=weight;
}
else
{
}
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
vec4 irradianceAndDiffusionProfile =texture2D(irradianceSampler,vUV);
vec3 centerIrradiance=irradianceAndDiffusionProfile.rgb;
int diffusionProfileIndex=int(round(irradianceAndDiffusionProfile.a*255.));
float centerDepth =0.;
vec4 inputColor=texture2D(textureSampler,vUV);
bool passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);
if (passedStencilTest)
{
centerDepth=texture2D(depthSampler,vUV).r;
}
if (!passedStencilTest) { 
gl_FragColor=inputColor;
return;
}
float distScale =1.;
vec3 S =diffusionS[diffusionProfileIndex];
float d =diffusionD[diffusionProfileIndex];
float filterRadius=filterRadii[diffusionProfileIndex];
vec2 centerPosNDC=vUV;
vec2 cornerPosNDC=vUV+0.5*texelSize;
vec3 centerPosVS =vec3(centerPosNDC*viewportSize,1.0)*centerDepth; 
vec3 cornerPosVS =vec3(cornerPosNDC*viewportSize,1.0)*centerDepth; 
float mmPerUnit =1000.*(metersPerUnit*rcp(distScale));
float unitsPerMm=rcp(mmPerUnit);
float unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);
float pixelsPerMm =rcp(unitsPerPixel)*unitsPerMm;
float filterArea =PI*Sq(filterRadius*pixelsPerMm);
int sampleCount =int(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));
int sampleBudget=_SssSampleBudget;
int texturingMode=0;
vec3 albedo =texture2D(albedoSampler,vUV).rgb;
if (distScale==0. || sampleCount<1)
{
#ifdef DEBUG_SSS_SAMPLES
vec3 green=vec3(0.,1.,0.);
gl_FragColor=vec4(green,1.0);
return;
#endif
gl_FragColor=vec4(inputColor.rgb+albedo*centerIrradiance,1.0);
return;
}
#ifdef DEBUG_SSS_SAMPLES
vec3 red =vec3(1.,0.,0.);
vec3 blue=vec3(0.,0.,1.);
gl_FragColor=vec4(mix(blue,red,clamp(float(sampleCount)/float(sampleBudget),0.0,1.0)),1.0);
return;
#endif
float phase=0.;
int n=min(sampleCount,sampleBudget);
vec3 centerWeight =vec3(0.); 
vec3 totalIrradiance=vec3(0.);
vec3 totalWeight =vec3(0.);
for (int i=0; i<n; i++)
{
EvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,
phase,totalIrradiance,totalWeight);
}
totalWeight=max(totalWeight,HALF_MIN);
gl_FragColor=vec4(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3(0.0)),1.);
}`;te.ShadersStore[mL]=gL;class vL extends et{getClassName(){return"SubSurfaceScatteringPostProcess"}constructor(e,t,i,r=null,s,n,a,l=0){super(e,"subSurfaceScattering",["texelSize","viewportSize","metersPerUnit"],["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],i,r,s||Y.BILINEAR_SAMPLINGMODE,n,a,null,l,"postprocess",void 0,!0),this._scene=t,this.updateEffect(),this.onApplyObservable.add(c=>{if(!t.prePassRenderer||!t.subSurfaceConfiguration){X.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");return}const h=this.texelSize;c.setFloat("metersPerUnit",t.subSurfaceConfiguration.metersPerUnit),c.setFloat2("texelSize",h.x,h.y),c.setTexture("irradianceSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(0)]),c.setTexture("depthSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(5)]),c.setTexture("albedoSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(7)]),c.setFloat2("viewportSize",Math.tan(t.activeCamera.fov/2)*t.getEngine().getAspectRatio(t.activeCamera,!0),Math.tan(t.activeCamera.fov/2)),c.setArray3("diffusionS",t.subSurfaceConfiguration.ssDiffusionS),c.setArray("diffusionD",t.subSurfaceConfiguration.ssDiffusionD),c.setArray("filterRadii",t.subSurfaceConfiguration.ssFilterRadii)})}}class Ku{get ssDiffusionS(){return this._ssDiffusionS}get ssDiffusionD(){return this._ssDiffusionD}get ssFilterRadii(){return this._ssFilterRadii}constructor(e){this._ssDiffusionS=[],this._ssFilterRadii=[],this._ssDiffusionD=[],this.enabled=!1,this.needsImageProcessing=!0,this.name=Re.NAME_SUBSURFACE,this.ssDiffusionProfileColors=[],this.metersPerUnit=1,this.texturesRequired=[5,7,4,0],this.addDiffusionProfile(new ge(1,1,1)),this._scene=e,Ku._SceneComponentInitialization(this._scene)}addDiffusionProfile(e){if(this.ssDiffusionD.length>=5)return X.Error("You already reached the maximum number of diffusion profiles."),0;for(let t=0;t<this._ssDiffusionS.length/3;t++)if(this._ssDiffusionS[t*3]===e.r&&this._ssDiffusionS[t*3+1]===e.g&&this._ssDiffusionS[t*3+2]===e.b)return t;return this._ssDiffusionS.push(e.r,e.b,e.g),this._ssDiffusionD.push(Math.max(Math.max(e.r,e.b),e.g)),this._ssFilterRadii.push(this.getDiffusionProfileParameters(e)),this.ssDiffusionProfileColors.push(e),this._ssDiffusionD.length-1}createPostProcess(){return this.postProcess=new vL("subSurfaceScattering",this._scene,1,null,void 0,this._scene.getEngine()),this.postProcess.autoClear=!1,this.postProcess}clearAllDiffusionProfiles(){this._ssDiffusionD=[],this._ssDiffusionS=[],this._ssFilterRadii=[],this.ssDiffusionProfileColors=[]}dispose(){this.clearAllDiffusionProfiles(),this.postProcess&&this.postProcess.dispose()}getDiffusionProfileParameters(e){const i=Math.max(e.r,e.g,e.b);return this._sampleBurleyDiffusionProfile(.997,i)}_sampleBurleyDiffusionProfile(e,t){e=1-e;const i=1+4*e*(2*e+Math.sqrt(1+4*e*e)),r=Math.pow(i,-1/3),n=1+i*r*r+r;return 3*Math.log(n/(4*e))*t}}Ku._SceneComponentInitialization=o=>{throw pt("SubSurfaceSceneComponent")};Er.AddParser(Re.NAME_SUBSURFACE,(o,e)=>{if(o.ssDiffusionProfileColors!==void 0&&o.ssDiffusionProfileColors!==null&&(e.enableSubSurfaceForPrePass(),e.subSurfaceConfiguration))for(let t=0,i=o.ssDiffusionProfileColors.length;t<i;t++){const r=o.ssDiffusionProfileColors[t];e.subSurfaceConfiguration.addDiffusionProfile(new ge(r.r,r.g,r.b))}});Object.defineProperty(Ne.prototype,"subSurfaceConfiguration",{get:function(){return this._subSurfaceConfiguration},set:function(o){o&&this.enablePrePassRenderer()&&(this._subSurfaceConfiguration=o)},enumerable:!0,configurable:!0});Ne.prototype.enableSubSurfaceForPrePass=function(){if(this._subSurfaceConfiguration)return this._subSurfaceConfiguration;const o=this.enablePrePassRenderer();return o?(this._subSurfaceConfiguration=new Ku(this),o.addEffectConfiguration(this._subSurfaceConfiguration),this._subSurfaceConfiguration):null};Ne.prototype.disableSubSurfaceForPrePass=function(){this._subSurfaceConfiguration&&(this._subSurfaceConfiguration.dispose(),this._subSurfaceConfiguration=null)};class xL{constructor(e){this.name=Re.NAME_PREPASSRENDERER,this.scene=e}register(){}serialize(e){if(!this.scene.subSurfaceConfiguration)return;const t=this.scene.subSurfaceConfiguration.ssDiffusionProfileColors;e.ssDiffusionProfileColors=[];for(let i=0;i<t.length;i++)e.ssDiffusionProfileColors.push({r:t[i].r,g:t[i].g,b:t[i].b})}addFromContainer(){}removeFromContainer(){this.scene.prePassRenderer&&this.scene.subSurfaceConfiguration&&this.scene.subSurfaceConfiguration.clearAllDiffusionProfiles()}rebuild(){}dispose(){}}Ku._SceneComponentInitialization=o=>{let e=o._getComponent(Re.NAME_SUBSURFACE);e||(e=new xL(o),o._addComponent(e))};const TL="outlinePixelShader",EL=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform vec4 color;
#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#include<logDepthFragment>
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;te.ShadersStore[TL]=EL;const bL="outlineVertexShader",SL=`attribute vec3 position;
attribute vec3 normal;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
uniform float offset;
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef ALPHATEST
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
vec3 offsetPosition=positionUpdated+(normalUpdated*offset);
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(offsetPosition,1.0);
gl_Position=viewProjection*worldPos;
#ifdef ALPHATEST
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
#include<logDepthVertex>
}
`;te.ShadersStore[bL]=SL;Ne.prototype.getOutlineRenderer=function(){return this._outlineRenderer||(this._outlineRenderer=new Iu(this)),this._outlineRenderer};Object.defineProperty(K.prototype,"renderOutline",{get:function(){return this._renderOutline},set:function(o){o&&this.getScene().getOutlineRenderer(),this._renderOutline=o},enumerable:!0,configurable:!0});Object.defineProperty(K.prototype,"renderOverlay",{get:function(){return this._renderOverlay},set:function(o){o&&this.getScene().getOutlineRenderer(),this._renderOverlay=o},enumerable:!0,configurable:!0});class Iu{constructor(e){this.name=Re.NAME_OUTLINERENDERER,this.zOffset=1,this.zOffsetUnits=4,this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=[];for(let t=0;t<4;++t)this._passIdForDrawWrapper[t]=this._engine.createRenderPassId(`Outline Renderer (${t})`)}register(){this.scene._beforeRenderingMeshStage.registerStep(Re.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(Re.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){for(let e=0;e<this._passIdForDrawWrapper.length;++e)this._engine.releaseRenderPassId(this._passIdForDrawWrapper[e])}render(e,t,i=!1,r){r=r??this._passIdForDrawWrapper[0];const s=this.scene,n=s.getEngine(),a=n.getCaps().instancedArrays&&(t.visibleInstances[e._id]!==null&&t.visibleInstances[e._id]!==void 0||e.getRenderingMesh().hasThinInstances);if(!this.isReady(e,a,r))return;const l=e.getMesh(),c=l._internalAbstractMeshDataInfo._actAsRegularMesh?l:null,h=e.getRenderingMesh(),u=c||h,d=e.getMaterial();if(!d||!s.activeCamera)return;const f=e._getDrawWrapper(r),_=vs.GetEffect(f);if(n.enableEffect(f),d.useLogarithmicDepth&&_.setFloat("logarithmicDepthConstant",2/(Math.log(s.activeCamera.maxZ+1)/Math.LN2)),_.setFloat("offset",i?0:h.outlineWidth),_.setColor4("color",i?h.overlayColor:h.outlineColor,i?h.overlayAlpha:d.alpha),_.setMatrix("viewProjection",s.getTransformMatrix()),_.setMatrix("world",u.getWorldMatrix()),h.useBones&&h.computeBonesUsingShaders&&h.skeleton&&_.setMatrices("mBones",h.skeleton.getTransformMatrices(h)),h.morphTargetManager&&h.morphTargetManager.isUsingTextureForTargets&&h.morphTargetManager._bind(_),Ce.BindMorphTargetParameters(h,_),a||h._bind(e,_,d.fillMode),d&&d.needAlphaTesting()){const p=d.getAlphaTestTexture();p&&(_.setTexture("diffuseSampler",p),_.setMatrix("diffuseMatrix",p.getTextureMatrix()))}Ra(_,d,s),n.setZOffset(-this.zOffset),n.setZOffsetUnits(-this.zOffsetUnits),h._processRendering(u,e,_,d.fillMode,t,a,(p,m)=>{_.setMatrix("world",m)}),n.setZOffset(0),n.setZOffsetUnits(0)}isReady(e,t,i){i=i??this._passIdForDrawWrapper[0];const r=[],s=[O.PositionKind,O.NormalKind],n=e.getMesh(),a=e.getMaterial();if(!a)return!1;const l=n.getScene();a.needAlphaTesting()&&(r.push("#define ALPHATEST"),n.isVerticesDataPresent(O.UVKind)&&(s.push(O.UVKind),r.push("#define UV1")),n.isVerticesDataPresent(O.UV2Kind)&&(s.push(O.UV2Kind),r.push("#define UV2"))),a.useLogarithmicDepth&&r.push("#define LOGARITHMICDEPTH"),Zo(a,l,r),n.useBones&&n.computeBonesUsingShaders?(s.push(O.MatricesIndicesKind),s.push(O.MatricesWeightsKind),n.numBoneInfluencers>4&&(s.push(O.MatricesIndicesExtraKind),s.push(O.MatricesWeightsExtraKind)),r.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),r.push("#define BonesPerMesh "+(n.skeleton?n.skeleton.bones.length+1:0))):r.push("#define NUM_BONE_INFLUENCERS 0");const c=n.morphTargetManager;let h=0;c&&c.numInfluencers>0&&(h=c.numInfluencers,r.push("#define MORPHTARGETS"),r.push("#define NUM_MORPH_INFLUENCERS "+h),c.isUsingTextureForTargets&&r.push("#define MORPHTARGETS_TEXTURE"),Ce.PrepareAttributesForMorphTargetsInfluencers(s,n,h)),t&&(r.push("#define INSTANCES"),Ce.PushAttributesForInstances(s),e.getRenderingMesh().hasThinInstances&&r.push("#define THIN_INSTANCES"));const u=e._getDrawWrapper(i,!0),d=u.defines,f=r.join(`
`);if(d!==f){const _=["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];ja(_),u.setEffect(this.scene.getEngine().createEffect("outline",s,_,["diffuseSampler","morphTargets"],f,void 0,void 0,void 0,{maxSimultaneousMorphTargets:h}),f)}return u.effect.isReady()}_beforeRenderingMesh(e,t,i){if(this._savedDepthWrite=this._engine.getDepthWrite(),e.renderOutline){const r=t.getMaterial();r&&r.needAlphaBlendingForMesh(e)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(7681),this._engine.setStencilFunction(519),this._engine.setStencilMask(Iu._StencilReference),this._engine.setStencilFunctionReference(Iu._StencilReference),this._engine.stencilStateComposer.useStencilGlobalOnly=!0,this.render(t,i,!0,this._passIdForDrawWrapper[1]),this._engine.setColorWrite(!0),this._engine.setStencilFunction(517)),this._engine.setDepthWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[0]),this._engine.setDepthWrite(this._savedDepthWrite),r&&r.needAlphaBlendingForMesh(e)&&(this._engine.stencilStateComposer.useStencilGlobalOnly=!1,this._engine.restoreStencilState())}}_afterRenderingMesh(e,t,i){if(e.renderOverlay){const r=this._engine.getAlphaMode(),s=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(2),this.render(t,i,!0,this._passIdForDrawWrapper[3]),this._engine.setAlphaMode(r),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=s}e.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[2]),this._engine.setColorWrite(!0))}}Iu._StencilReference=4;class NE{get particleSize(){return this._particleSize}set particleSize(e){e!==this._particleSize&&(this._particleSize=e,this.onParticleSizeChanged.notifyObservers(this))}get useInstancing(){return!this.indexBuffer}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity===e||!this._hasVelocity()||(this._useVelocity=e,this._effectsAreDirty=!0)}_hasVelocity(){var e;return!!(!((e=this.vertexBuffers)===null||e===void 0)&&e.velocity)}get indexBuffer(){return null}getClassName(){return"FluidRenderingObject"}constructor(e){this.priority=0,this._particleSize=.1,this.onParticleSizeChanged=new Q,this.particleThicknessAlpha=.05,this._useVelocity=!1,this._scene=e,this._engine=e.getEngine(),this._effectsAreDirty=!0,this._depthEffectWrapper=null,this._thicknessEffectWrapper=null}_createEffects(){const e=["view","projection","particleRadius","size"],t=["position","offset"],i=[];this._effectsAreDirty=!1,this.useVelocity&&(t.push("velocity"),i.push("#define FLUIDRENDERING_VELOCITY")),this._scene.useRightHandedSystem&&i.push("#define FLUIDRENDERING_RHS"),this._depthEffectWrapper=new $o({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDepth",fragmentShader:"fluidRenderingParticleDepth",attributeNames:t,uniformNames:e,samplerNames:[],defines:i}),e.push("particleAlpha"),this._thicknessEffectWrapper=new $o({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleThickness",fragmentShader:"fluidRenderingParticleThickness",attributeNames:["position","offset"],uniformNames:e,samplerNames:[]})}isReady(){if(this._effectsAreDirty&&this._createEffects(),!this._depthEffectWrapper||!this._thicknessEffectWrapper)return!1;const e=this._depthEffectWrapper._drawWrapper.effect,t=this._thicknessEffectWrapper._drawWrapper.effect;return e.isReady()&&t.isReady()}renderDepthTexture(){const e=this.numParticles;if(!this._depthEffectWrapper||e===0)return;const t=this._depthEffectWrapper._drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat2("size",this._particleSize,this._particleSize),i.setFloat("particleRadius",this._particleSize/2),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}renderThicknessTexture(){const e=this.numParticles;if(!this._thicknessEffectWrapper||e===0)return;const t=this._thicknessEffectWrapper._drawWrapper,i=t.effect;this._engine.setAlphaMode(6),this._engine.setDepthWrite(!1),this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat("particleAlpha",this.particleThicknessAlpha),i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0)}renderDiffuseTexture(){}dispose(){var e,t;(e=this._depthEffectWrapper)===null||e===void 0||e.dispose(),(t=this._thicknessEffectWrapper)===null||t===void 0||t.dispose()}}class yL extends NE{get particleSystem(){return this._particleSystem}getClassName(){return"FluidRenderingObjectParticleSystem"}get useTrueRenderingForDiffuseTexture(){return this._useTrueRenderingForDiffuseTexture}set useTrueRenderingForDiffuseTexture(e){this._useTrueRenderingForDiffuseTexture!==e&&(this._useTrueRenderingForDiffuseTexture=e,e?(this._particleSystem.blendMode=this._blendMode,this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null):(this._particleSystem.blendMode=-1,this._onBeforeDrawParticleObserver=this._particleSystem.onBeforeDrawParticlesObservable.add(()=>{this._engine.setAlphaMode(2)})))}get vertexBuffers(){return this._particleSystem.vertexBuffers}get indexBuffer(){return this._particleSystem.indexBuffer}constructor(e,t){super(e),this._useTrueRenderingForDiffuseTexture=!0,this._particleSystem=t,this._originalRender=t.render.bind(t),this._blendMode=t.blendMode,this._onBeforeDrawParticleObserver=null,this._updateInAnimate=this._particleSystem.updateInAnimate,this._particleSystem.updateInAnimate=!0,this._particleSystem.render=()=>0,this.particleSize=(t.minSize+t.maxSize)/2,this.useTrueRenderingForDiffuseTexture=!1}isReady(){return super.isReady()&&this._particleSystem.isReady()}get numParticles(){return this._particleSystem.getActiveCount()}renderDiffuseTexture(){this._originalRender()}dispose(){super.dispose(),this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null,this._particleSystem.render=this._originalRender,this._particleSystem.blendMode=this._blendMode,this._particleSystem.updateInAnimate=this._updateInAnimate}}class D_{get blurNumIterations(){return this._blurNumIterations}set blurNumIterations(e){if(this._blurNumIterations!==e&&(this._blurNumIterations=e,this._blurPostProcesses!==null)){const t=this._blurPostProcesses[0],i=this._blurPostProcesses[1];this._blurPostProcesses=[];for(let r=0;r<this._blurNumIterations*2;++r)this._blurPostProcesses[r]=r&1?i:t}}get renderTarget(){return this._rt}get renderTargetBlur(){return this._rtBlur}get texture(){return this._texture}get textureBlur(){return this._textureBlurred}constructor(e,t,i,r,s,n,a=1,l=6,c=1,h=6,u=!1,d=null,f=!0,_=1){this.enableBlur=!0,this.blurSizeDivisor=1,this.blurFilterSize=7,this._blurNumIterations=3,this.blurMaxFilterSize=100,this.blurDepthScale=10,this.particleSize=.02,this.onDisposeObservable=new Q,this._name=e,this._scene=t,this._camera=d,this._engine=t.getEngine(),this._width=i,this._height=r,this._blurTextureSizeX=s,this._blurTextureSizeY=n,this._textureType=a,this._textureFormat=l,this._blurTextureType=c,this._blurTextureFormat=h,this._useStandardBlur=u,this._generateDepthBuffer=f,this._samples=_,this._postProcessRunningIndex=0,this.enableBlur=s!==0&&n!==0,this._rt=null,this._texture=null,this._rtBlur=null,this._textureBlurred=null,this._blurPostProcesses=null}initialize(){if(this.dispose(),this._createRenderTarget(),this.enableBlur&&this._texture){const[e,t,i]=this._createBlurPostProcesses(this._texture,this._blurTextureType,this._blurTextureFormat,this.blurSizeDivisor,this._name,this._useStandardBlur);this._rtBlur=e,this._textureBlurred=t,this._blurPostProcesses=i}}applyBlurPostProcesses(){this.enableBlur&&this._blurPostProcesses&&(this._postProcessRunningIndex=0,this._scene.postProcessManager.directRender(this._blurPostProcesses,this._rtBlur,!0),this._engine.unBindFramebuffer(this._rtBlur))}_createRenderTarget(){this._rt=this._engine.createRenderTargetTexture({width:this._width,height:this._height},{generateMipMaps:!1,type:this._textureType,format:this._textureFormat,samplingMode:1,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:!1,samples:this._samples});const e=this._rt.texture;e.incrementReferences(),this._texture=new Y(null,this._scene),this._texture.name="rtt"+this._name,this._texture._texture=e,this._texture.wrapU=Y.CLAMP_ADDRESSMODE,this._texture.wrapV=Y.CLAMP_ADDRESSMODE,this._texture.anisotropicFilteringLevel=1}_createBlurPostProcesses(e,t,i,r,s,n=!1){const a=this._scene.getEngine(),l=new Ie(Math.floor(this._blurTextureSizeX/r),Math.floor(this._blurTextureSizeY/r)),c=t===1&&a.getCaps().textureFloatLinearFiltering||t===2&&a.getCaps().textureHalfFloatLinearFiltering,h=this._engine.createRenderTargetTexture({width:l.x,height:l.y},{generateMipMaps:!1,type:t,format:i,samplingMode:c?2:1,generateDepthBuffer:!1,generateStencilBuffer:!1,samples:this._samples}),u=h.texture;u.incrementReferences();const d=new Y(null,this._scene);if(d.name="rttBlurred"+s,d._texture=u,d.wrapU=Y.CLAMP_ADDRESSMODE,d.wrapV=Y.CLAMP_ADDRESSMODE,d.anisotropicFilteringLevel=1,n){const f=new et("BilateralBlurX","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);f.samples=this._samples,f.externalTextureSamplerBinding=!0,f.onApplyObservable.add(m=>{this._postProcessRunningIndex===0?m.setTexture("textureSampler",e):m._bindTexture("textureSampler",f.inputTexture.texture),m.setInt("filterSize",this.blurFilterSize),m.setFloat2("blurDir",1/this._blurTextureSizeX,0),this._postProcessRunningIndex++}),f.onSizeChangedObservable.add(()=>{f._textures.forEach(m=>{m.texture.wrapU=Y.CLAMP_ADDRESSMODE,m.texture.wrapV=Y.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(f);const _=new et("BilateralBlurY","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);_.samples=this._samples,_.onApplyObservable.add(m=>{m.setInt("filterSize",this.blurFilterSize),m.setFloat2("blurDir",0,1/this._blurTextureSizeY),this._postProcessRunningIndex++}),_.onSizeChangedObservable.add(()=>{_._textures.forEach(m=>{m.texture.wrapU=Y.CLAMP_ADDRESSMODE,m.texture.wrapV=Y.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(_),f.autoClear=!1,_.autoClear=!1;const p=[];for(let m=0;m<this._blurNumIterations*2;++m)p[m]=m&1?_:f;return[h,d,p]}else{const f=["maxFilterSize","blurDir","projectedParticleConstant","depthThreshold"],_=new et("BilateralBlurX","fluidRenderingBilateralBlur",f,null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);_.samples=this._samples,_.externalTextureSamplerBinding=!0,_.onApplyObservable.add(T=>{this._postProcessRunningIndex===0?T.setTexture("textureSampler",e):T._bindTexture("textureSampler",_.inputTexture.texture),T.setInt("maxFilterSize",this.blurMaxFilterSize),T.setFloat2("blurDir",1/this._blurTextureSizeX,0),T.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),T.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++}),_.onSizeChangedObservable.add(()=>{_._textures.forEach(T=>{T.texture.wrapU=Y.CLAMP_ADDRESSMODE,T.texture.wrapV=Y.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(_);const p=new et("BilateralBlurY","fluidRenderingBilateralBlur",f,null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);p.samples=this._samples,p.onApplyObservable.add(T=>{T.setInt("maxFilterSize",this.blurMaxFilterSize),T.setFloat2("blurDir",0,1/this._blurTextureSizeY),T.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),T.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++}),p.onSizeChangedObservable.add(()=>{p._textures.forEach(T=>{T.texture.wrapU=Y.CLAMP_ADDRESSMODE,T.texture.wrapV=Y.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(p),_.autoClear=!1,p.autoClear=!1;const m=[];for(let T=0;T<this._blurNumIterations*2;++T)m[T]=T&1?p:_;return[h,d,m]}}_fixReusablePostProcess(e){e.isReusable()&&(e.onActivateObservable.add(()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2}),e.onApplyObservable.add(()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2}))}_getProjectedParticleConstant(){var e,t;return this.blurFilterSize*this.particleSize*.05*(this._height/2)/Math.tan(((t=(e=this._camera)===null||e===void 0?void 0:e.fov)!==null&&t!==void 0?t:45*Math.PI/180)/2)}_getDepthThreshold(){return this.particleSize/2*this.blurDepthScale}dispose(){var e,t,i,r;this.onDisposeObservable.hasObservers()&&this.onDisposeObservable.notifyObservers(this),(e=this._rt)===null||e===void 0||e.dispose(),this._rt=null,(t=this._texture)===null||t===void 0||t.dispose(),this._texture=null,(i=this._rtBlur)===null||i===void 0||i.dispose(),this._rtBlur=null,(r=this._textureBlurred)===null||r===void 0||r.dispose(),this._textureBlurred=null,this._blurPostProcesses&&(this._blurPostProcesses[0].dispose(),this._blurPostProcesses[1].dispose()),this._blurPostProcesses=null}}var ra;(function(o){o[o.DepthTexture=0]="DepthTexture",o[o.DepthBlurredTexture=1]="DepthBlurredTexture",o[o.ThicknessTexture=2]="ThicknessTexture",o[o.ThicknessBlurredTexture=3]="ThicknessBlurredTexture",o[o.DiffuseTexture=4]="DiffuseTexture",o[o.Normals=5]="Normals",o[o.DiffuseRendering=6]="DiffuseRendering"})(ra||(ra={}));class yx{get needInitialization(){return this._needInitialization}get generateDiffuseTexture(){return this._generateDiffuseTexture}set generateDiffuseTexture(e){this._generateDiffuseTexture!==e&&(this._generateDiffuseTexture=e,this._needInitialization=!0)}get debugFeature(){return this._debugFeature}set debugFeature(e){this._debugFeature!==e&&(this._needInitialization=!0,this._debugFeature=e)}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._needInitialization=!0)}get environmentMap(){return this._environmentMap}set environmentMap(e){this._environmentMap!==e&&(this._needInitialization=!0,this._environmentMap=e)}get enableBlurDepth(){return this._enableBlurDepth}set enableBlurDepth(e){this._enableBlurDepth!==e&&(this._enableBlurDepth=e,this._needInitialization=!0)}get blurDepthSizeDivisor(){return this._blurDepthSizeDivisor}set blurDepthSizeDivisor(e){this._blurDepthSizeDivisor!==e&&(this._blurDepthSizeDivisor=e,this._needInitialization=!0)}get blurDepthFilterSize(){return this._blurDepthFilterSize}set blurDepthFilterSize(e){this._blurDepthFilterSize!==e&&(this._blurDepthFilterSize=e,this._setBlurParameters())}get blurDepthNumIterations(){return this._blurDepthNumIterations}set blurDepthNumIterations(e){this._blurDepthNumIterations!==e&&(this._blurDepthNumIterations=e,this._setBlurParameters())}get blurDepthMaxFilterSize(){return this._blurDepthMaxFilterSize}set blurDepthMaxFilterSize(e){this._blurDepthMaxFilterSize!==e&&(this._blurDepthMaxFilterSize=e,this._setBlurParameters())}get blurDepthDepthScale(){return this._blurDepthDepthScale}set blurDepthDepthScale(e){this._blurDepthDepthScale!==e&&(this._blurDepthDepthScale=e,this._setBlurParameters())}get enableBlurThickness(){return this._enableBlurThickness}set enableBlurThickness(e){this._enableBlurThickness!==e&&(this._enableBlurThickness=e,this._needInitialization=!0)}get blurThicknessSizeDivisor(){return this._blurThicknessSizeDivisor}set blurThicknessSizeDivisor(e){this._blurThicknessSizeDivisor!==e&&(this._blurThicknessSizeDivisor=e,this._needInitialization=!0)}get blurThicknessFilterSize(){return this._blurThicknessFilterSize}set blurThicknessFilterSize(e){this._blurThicknessFilterSize!==e&&(this._blurThicknessFilterSize=e,this._setBlurParameters())}get blurThicknessNumIterations(){return this._blurThicknessNumIterations}set blurThicknessNumIterations(e){this._blurThicknessNumIterations!==e&&(this._blurThicknessNumIterations=e,this._setBlurParameters())}get useFixedThickness(){return this._useFixedThickness}set useFixedThickness(e){this._useFixedThickness!==e&&(this._useFixedThickness=e,this._needInitialization=!0)}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity!==e&&(this._useVelocity=e,this._needInitialization=!0,this._onUseVelocityChanged.notifyObservers(this))}get depthMapSize(){return this._depthMapSize}set depthMapSize(e){this._depthMapSize!==e&&(this._depthMapSize=e,this._needInitialization=!0)}get thicknessMapSize(){return this._thicknessMapSize}set thicknessMapSize(e){this._thicknessMapSize!==e&&(this._thicknessMapSize=e,this._needInitialization=!0)}get diffuseMapSize(){return this._diffuseMapSize}set diffuseMapSize(e){this._diffuseMapSize!==e&&(this._diffuseMapSize=e,this._needInitialization=!0)}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._needInitialization=!0)}get camera(){return this._camera}constructor(e,t){this._generateDiffuseTexture=!1,this.fluidColor=new ge(.085,.6375,.765),this.density=2,this.refractionStrength=.1,this.fresnelClamp=1,this.specularPower=250,this.minimumThickness=0,this.dirLight=new x(-2,-1,1).normalize(),this._debugFeature=ra.DepthBlurredTexture,this._debug=!1,this._enableBlurDepth=!0,this._blurDepthSizeDivisor=1,this._blurDepthFilterSize=7,this._blurDepthNumIterations=3,this._blurDepthMaxFilterSize=100,this._blurDepthDepthScale=10,this._enableBlurThickness=!0,this._blurThicknessSizeDivisor=1,this._blurThicknessFilterSize=5,this._blurThicknessNumIterations=1,this._useFixedThickness=!1,this._onUseVelocityChanged=new Q,this._useVelocity=!1,this._depthMapSize=null,this._thicknessMapSize=null,this._diffuseMapSize=null,this._samples=1,this._scene=e,this._engine=e.getEngine(),this._camera=t??e.activeCamera,this._needInitialization=!0,this._bgDepthTexture=null,this._invProjectionMatrix=new H,this._depthClearColor=new Ye(1e6,1e6,1e6,1),this._thicknessClearColor=new Ye(0,0,0,1),this._depthRenderTarget=null,this._diffuseRenderTarget=null,this._thicknessRenderTarget=null,this._renderPostProcess=null}_initialize(){var e,t,i;this.dispose(),this._needInitialization=!1;const r=(e=this._depthMapSize)!==null&&e!==void 0?e:this._engine.getRenderWidth(),s=this._depthMapSize!==null?Math.round(this._depthMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();if(this._depthRenderTarget=new D_("Depth",this._scene,r,s,r,s,1,7,1,7,!1,this._camera,!0,this._samples),this._initializeRenderTarget(this._depthRenderTarget),this.generateDiffuseTexture){const l=(t=this._diffuseMapSize)!==null&&t!==void 0?t:this._engine.getRenderWidth(),c=this._diffuseMapSize!==null?Math.round(this._diffuseMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._diffuseRenderTarget=new D_("Diffuse",this._scene,l,c,0,0,0,5,0,5,!0,this._camera,!0,this._samples),this._initializeRenderTarget(this._diffuseRenderTarget)}const n=(i=this._thicknessMapSize)!==null&&i!==void 0?i:this._engine.getRenderWidth(),a=this._thicknessMapSize!==null?Math.round(this._thicknessMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._useFixedThickness||(this._thicknessRenderTarget=new D_("Thickness",this._scene,n,a,n,a,2,6,2,6,!0,this._camera,!1,this._samples),this._initializeRenderTarget(this._thicknessRenderTarget)),this._createLiquidRenderingPostProcess()}_setBlurParameters(e=null){(e===null||e===this._depthRenderTarget)&&this._setBlurDepthParameters(),(e===null||e===this._thicknessRenderTarget)&&this._setBlurThicknessParameters()}_setBlurDepthParameters(){this._depthRenderTarget&&(this._depthRenderTarget.blurFilterSize=this.blurDepthFilterSize,this._depthRenderTarget.blurMaxFilterSize=this.blurDepthMaxFilterSize,this._depthRenderTarget.blurNumIterations=this.blurDepthNumIterations,this._depthRenderTarget.blurDepthScale=this.blurDepthDepthScale)}_setBlurThicknessParameters(){this._thicknessRenderTarget&&(this._thicknessRenderTarget.blurFilterSize=this.blurThicknessFilterSize,this._thicknessRenderTarget.blurNumIterations=this.blurThicknessNumIterations)}_initializeRenderTarget(e){e!==this._diffuseRenderTarget&&(e.enableBlur=e===this._depthRenderTarget?this.enableBlurDepth:this.enableBlurThickness,e.blurSizeDivisor=e===this._depthRenderTarget?this.blurDepthSizeDivisor:this.blurThicknessSizeDivisor),this._setBlurParameters(e),e.initialize()}_createLiquidRenderingPostProcess(){var e;const t=this._scene.getEngine(),i=["viewMatrix","projectionMatrix","invProjectionMatrix","texelSize","dirLight","cameraFar","density","refractionStrength","fresnelClamp","specularPower"],r=["depthSampler"],s=[];if(this.dispose(!0),!this._camera)return;const n=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture,a=new Ie(1/n.getSize().width,1/n.getSize().height);this._scene.useRightHandedSystem&&s.push("#define FLUIDRENDERING_RHS"),this._environmentMap!==null&&((e=this._environmentMap)!==null&&e!==void 0?e:this._scene.environmentTexture)&&(r.push("reflectionSampler"),s.push("#define FLUIDRENDERING_ENVIRONMENT")),this._diffuseRenderTarget?(r.push("diffuseSampler"),s.push("#define FLUIDRENDERING_DIFFUSETEXTURE")):i.push("diffuseColor"),this._useVelocity&&(r.push("velocitySampler"),s.push("#define FLUIDRENDERING_VELOCITY")),this._useFixedThickness?(i.push("thickness"),r.push("bgDepthSampler"),s.push("#define FLUIDRENDERING_FIXED_THICKNESS")):(i.push("minimumThickness"),r.push("thicknessSampler")),this._debug&&(s.push("#define FLUIDRENDERING_DEBUG"),this._debugFeature===ra.Normals?s.push("#define FLUIDRENDERING_DEBUG_SHOWNORMAL"):this._debugFeature===ra.DiffuseRendering?s.push("#define FLUIDRENDERING_DEBUG_DIFFUSERENDERING"):(s.push("#define FLUIDRENDERING_DEBUG_TEXTURE"),r.push("debugSampler"),(this._debugFeature===ra.DepthTexture||this._debugFeature===ra.DepthBlurredTexture)&&s.push("#define FLUIDRENDERING_DEBUG_DEPTH"))),this._renderPostProcess=new et("FluidRendering","fluidRenderingRender",i,r,1,null,2,t,!1,null,0,void 0,void 0,!0,void 0),this._renderPostProcess.updateEffect(s.join(`
`)),this._renderPostProcess.samples=this._samples,this._renderPostProcess.onApplyObservable.add(l=>{var c,h,u,d,f,_,p,m,T,b,y,S,C,I,P,D,w,L,U,G,Z,he,_e;if(this._invProjectionMatrix.copyFrom(this._scene.getProjectionMatrix()),this._invProjectionMatrix.invert(),t.isWebGPU&&l.setTextureSampler("textureSamplerSampler",this._renderPostProcess.inputTexture.texture),this._depthRenderTarget.enableBlur?(l.setTexture("depthSampler",this._depthRenderTarget.textureBlur),t.isWebGPU&&l.setTextureSampler("depthSamplerSampler",(d=(u=this._depthRenderTarget.textureBlur)===null||u===void 0?void 0:u.getInternalTexture())!==null&&d!==void 0?d:null)):(l.setTexture("depthSampler",this._depthRenderTarget.texture),t.isWebGPU&&l.setTextureSampler("depthSamplerSampler",(h=(c=this._depthRenderTarget.texture)===null||c===void 0?void 0:c.getInternalTexture())!==null&&h!==void 0?h:null)),this._diffuseRenderTarget?this._diffuseRenderTarget.enableBlur?(l.setTexture("diffuseSampler",this._diffuseRenderTarget.textureBlur),t.isWebGPU&&l.setTextureSampler("diffuseSamplerSampler",(m=(p=this._diffuseRenderTarget.textureBlur)===null||p===void 0?void 0:p.getInternalTexture())!==null&&m!==void 0?m:null)):(l.setTexture("diffuseSampler",this._diffuseRenderTarget.texture),t.isWebGPU&&l.setTextureSampler("diffuseSamplerSampler",(_=(f=this._diffuseRenderTarget.texture)===null||f===void 0?void 0:f.getInternalTexture())!==null&&_!==void 0?_:null)):l.setColor3("diffuseColor",this.fluidColor),this._useFixedThickness?(l.setFloat("thickness",this.minimumThickness),l._bindTexture("bgDepthSampler",this._bgDepthTexture),t.isWebGPU&&l.setTextureSampler("bgDepthSamplerSampler",(T=this._bgDepthTexture)!==null&&T!==void 0?T:null)):(this._thicknessRenderTarget.enableBlur?(l.setTexture("thicknessSampler",this._thicknessRenderTarget.textureBlur),t.isWebGPU&&l.setTextureSampler("thicknessSamplerSampler",(C=(S=this._thicknessRenderTarget.textureBlur)===null||S===void 0?void 0:S.getInternalTexture())!==null&&C!==void 0?C:null)):(l.setTexture("thicknessSampler",this._thicknessRenderTarget.texture),t.isWebGPU&&l.setTextureSampler("thicknessSamplerSampler",(y=(b=this._thicknessRenderTarget.texture)===null||b===void 0?void 0:b.getInternalTexture())!==null&&y!==void 0?y:null)),l.setFloat("minimumThickness",this.minimumThickness)),this._environmentMap!==null){const ne=(I=this._environmentMap)!==null&&I!==void 0?I:this._scene.environmentTexture;ne&&(l.setTexture("reflectionSampler",ne),t.isWebGPU&&l.setTextureSampler("reflectionSamplerSampler",(P=ne==null?void 0:ne.getInternalTexture())!==null&&P!==void 0?P:null))}if(l.setMatrix("viewMatrix",this._scene.getViewMatrix()),l.setMatrix("invProjectionMatrix",this._invProjectionMatrix),l.setMatrix("projectionMatrix",this._scene.getProjectionMatrix()),l.setVector2("texelSize",a),l.setFloat("density",this.density),l.setFloat("refractionStrength",this.refractionStrength),l.setFloat("fresnelClamp",this.fresnelClamp),l.setFloat("specularPower",this.specularPower),l.setVector3("dirLight",this.dirLight),l.setFloat("cameraFar",this._camera.maxZ),this._debug){let ne=null;switch(this._debugFeature){case ra.DepthTexture:ne=this._depthRenderTarget.texture;break;case ra.DepthBlurredTexture:ne=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture;break;case ra.ThicknessTexture:ne=(w=(D=this._thicknessRenderTarget)===null||D===void 0?void 0:D.texture)!==null&&w!==void 0?w:null;break;case ra.ThicknessBlurredTexture:ne=!((L=this._thicknessRenderTarget)===null||L===void 0)&&L.enableBlur?(G=(U=this._thicknessRenderTarget)===null||U===void 0?void 0:U.textureBlur)!==null&&G!==void 0?G:null:(he=(Z=this._thicknessRenderTarget)===null||Z===void 0?void 0:Z.texture)!==null&&he!==void 0?he:null;break;case ra.DiffuseTexture:this._diffuseRenderTarget&&(ne=this._diffuseRenderTarget.texture);break}this._debugFeature!==ra.Normals&&(l.setTexture("debugSampler",ne),t.isWebGPU&&l.setTextureSampler("debugSamplerSampler",(_e=ne==null?void 0:ne.getInternalTexture())!==null&&_e!==void 0?_e:null))}})}_clearTargets(){var e,t,i;!((e=this._depthRenderTarget)===null||e===void 0)&&e.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),this._engine.clear(this._depthClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),!((t=this._diffuseRenderTarget)===null||t===void 0)&&t.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),!((i=this._thicknessRenderTarget)===null||i===void 0)&&i.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!1,!1),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget))}_render(e){var t,i,r,s,n,a;if(this._needInitialization||!e.isReady())return;const l=this._engine._currentRenderTarget;this._engine.setState(!1,void 0,void 0,void 0,!0),this._engine.setDepthBuffer(!0),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0),!((t=this._depthRenderTarget)===null||t===void 0)&&t.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),e.renderDepthTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),!((i=this._diffuseRenderTarget)===null||i===void 0)&&i.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),e.renderDiffuseTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),!((r=this._thicknessRenderTarget)===null||r===void 0)&&r.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),e.renderThicknessTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget)),(s=this._depthRenderTarget)===null||s===void 0||s.applyBlurPostProcesses(),(n=this._diffuseRenderTarget)===null||n===void 0||n.applyBlurPostProcesses(),(a=this._thicknessRenderTarget)===null||a===void 0||a.applyBlurPostProcesses(),l&&this._engine.bindFramebuffer(l)}dispose(e=!1){var t,i,r,s;e||((t=this._depthRenderTarget)===null||t===void 0||t.dispose(),this._depthRenderTarget=null,(i=this._diffuseRenderTarget)===null||i===void 0||i.dispose(),this._diffuseRenderTarget=null,(r=this._thicknessRenderTarget)===null||r===void 0||r.dispose(),this._thicknessRenderTarget=null),this._renderPostProcess&&this._camera&&this._camera.detachPostProcess(this._renderPostProcess),(s=this._renderPostProcess)===null||s===void 0||s.dispose(),this._renderPostProcess=null,this._needInitialization=!1}}class CL extends NE{getClassName(){return"FluidRenderingObjectCustomParticles"}get vertexBuffers(){return this._vertexBuffers}constructor(e,t,i){super(e),this._numParticles=i,this._diffuseEffectWrapper=null,this._vertexBuffers={},this.addBuffers(t)}addBuffers(e){for(const t in e){let i,r=!0;switch(t){case"velocity":i=3;break;case"offset":r=!1;break}this._vertexBuffers[t]=new O(this._engine,e[t],t,!0,!1,i,r)}}_createEffects(){super._createEffects();const e=["view","projection","size"],t=["position","offset","color"];this._diffuseEffectWrapper=new $o({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDiffuse",fragmentShader:"fluidRenderingParticleDiffuse",attributeNames:t,uniformNames:e,samplerNames:[]})}isReady(){var e,t;return this._vertexBuffers.offset||(this._vertexBuffers.offset=new O(this._engine,[0,0,1,0,0,1,1,1],"offset",!1,!1,2)),super.isReady()&&((t=(e=this._diffuseEffectWrapper)===null||e===void 0?void 0:e.effect.isReady())!==null&&t!==void 0?t:!1)}get numParticles(){return this._numParticles}setNumParticles(e){this._numParticles=e}renderDiffuseTexture(){const e=this.numParticles;if(!this._diffuseEffectWrapper||e===0)return;const t=this._diffuseEffectWrapper._drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),this._particleSize!==null&&i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}dispose(){var e;super.dispose(),(e=this._diffuseEffectWrapper)===null||e===void 0||e.dispose();for(const t in this._vertexBuffers)this._vertexBuffers[t].dispose();this._vertexBuffers={}}}const AL="copyTextureToTexturePixelShader",RL=`uniform float conversion;
uniform sampler2D textureSampler;
varying vec2 vUV;
#include<helperFunctions>
void main(void) 
{
vec4 color=texture2D(textureSampler,vUV);
#ifdef DEPTH_TEXTURE
gl_FragDepth=color.r;
#else
if (conversion==1.) {
color=toLinearSpace(color);
} else if (conversion==2.) {
color=toGammaSpace(color);
}
gl_FragColor=color;
#endif
}
`;te.ShadersStore[AL]=RL;var ap;(function(o){o[o.None=0]="None",o[o.ToLinearSpace=1]="ToLinearSpace",o[o.ToGammaSpace=2]="ToGammaSpace"})(ap||(ap={}));class IL{_textureIsInternal(e){return e.getInternalTexture===void 0}constructor(e,t=!1){this._engine=e,this._isDepthTexture=t,this._renderer=new Tf(e),this._effectWrapper=new $o({engine:e,name:"CopyTextureToTexture",fragmentShader:"copyTextureToTexture",useShaderStore:!0,uniformNames:["conversion"],samplerNames:["textureSampler"],defines:t?["#define DEPTH_TEXTURE"]:[]}),this._effectWrapper.onApplyObservable.add(()=>{t&&(e.setState(!1),e.setDepthBuffer(!0),e.depthCullingState.depthMask=!0,e.depthCullingState.depthFunc=519),this._textureIsInternal(this._source)?this._effectWrapper.effect._bindTexture("textureSampler",this._source):this._effectWrapper.effect.setTexture("textureSampler",this._source),this._effectWrapper.effect.setFloat("conversion",this._conversion)})}isReady(){return this._effectWrapper.effect.isReady()}copy(e,t,i=ap.None){if(!this.isReady())return!1;this._source=e,this._conversion=i;const r=this._engine.depthCullingState.depthFunc;return this._renderer.render(this._effectWrapper,t),this._isDepthTexture&&r&&(this._engine.depthCullingState.depthFunc=r),!0}dispose(){this._effectWrapper.dispose(),this._renderer.dispose()}}class PL{get depthRTWrapper(){return this._depthRTWrapper}constructor(e,t,i,r=1){this._engine=e,this._copyTextureToTexture=new IL(e,!0),this._depthRTWrapper=this._engine.createRenderTargetTexture({width:t,height:i},{generateMipMaps:!1,type:0,format:6,samplingMode:1,generateDepthBuffer:!0,generateStencilBuffer:!1,samples:r,noColorAttachment:!0}),this._depthRTWrapper.createDepthStencilTexture(0,!1,!1,1)}copy(e){return this._copyTextureToTexture.copy(e,this._depthRTWrapper)}dispose(){this._depthRTWrapper.dispose(),this._copyTextureToTexture.dispose()}}const ML="fluidRenderingParticleDepthVertexShader",OL=`attribute vec3 position;
attribute vec2 offset;
uniform mat4 view;
uniform mat4 projection;
uniform vec2 size;
varying vec2 uv;
varying vec3 viewPos;
varying float sphereRadius;
#ifdef FLUIDRENDERING_VELOCITY
attribute vec3 velocity;
varying float velocityNorm;
#endif
void main(void) {
vec3 cornerPos;
cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;
cornerPos.z=0.0;
viewPos=(view*vec4(position,1.0)).xyz;
gl_Position=projection*vec4(viewPos+cornerPos,1.0);
uv=offset;
sphereRadius=size.x/2.0;
#ifdef FLUIDRENDERING_VELOCITY
velocityNorm=length(velocity);
#endif
}
`;te.ShadersStore[ML]=OL;const DL="fluidRenderingParticleDepthPixelShader",NL=`uniform mat4 projection;
varying vec2 uv;
varying vec3 viewPos;
varying float sphereRadius;
#ifdef FLUIDRENDERING_VELOCITY
varying float velocityNorm;
#endif
void main(void) {
vec3 normal;
normal.xy=uv*2.0-1.0;
float r2=dot(normal.xy,normal.xy);
if (r2>1.0) discard;
normal.z=sqrt(1.0-r2);
#ifndef FLUIDRENDERING_RHS
normal.z=-normal.z;
#endif
vec4 realViewPos=vec4(viewPos+normal*sphereRadius,1.0);
vec4 clipSpacePos=projection*realViewPos;
#ifdef WEBGPU
gl_FragDepth=clipSpacePos.z/clipSpacePos.w;
#else
gl_FragDepth=(clipSpacePos.z/clipSpacePos.w)*0.5+0.5;
#endif
#ifdef FLUIDRENDERING_RHS
realViewPos.z=-realViewPos.z;
#endif
#ifdef FLUIDRENDERING_VELOCITY
glFragColor=vec4(realViewPos.z,velocityNorm,0.,1.);
#else
glFragColor=vec4(realViewPos.z,0.,0.,1.);
#endif
}
`;te.ShadersStore[DL]=NL;const wL="fluidRenderingParticleThicknessVertexShader",FL=`attribute vec3 position;
attribute vec2 offset;
uniform mat4 view;
uniform mat4 projection;
uniform vec2 size;
varying vec2 uv;
void main(void) {
vec3 cornerPos;
cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;
cornerPos.z=0.0;
vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;
gl_Position=projection*vec4(viewPos,1.0);
uv=offset;
}
`;te.ShadersStore[wL]=FL;const LL="fluidRenderingParticleThicknessPixelShader",BL=`uniform float particleAlpha;
varying vec2 uv;
void main(void) {
vec3 normal;
normal.xy=uv*2.0-1.0;
float r2=dot(normal.xy,normal.xy);
if (r2>1.0) discard;
float thickness=sqrt(1.0-r2);
glFragColor=vec4(vec3(particleAlpha*thickness),1.0);
}
`;te.ShadersStore[LL]=BL;const UL="fluidRenderingParticleDiffuseVertexShader",VL=`attribute vec3 position;
attribute vec2 offset;
attribute vec4 color;
uniform mat4 view;
uniform mat4 projection;
uniform vec2 size;
varying vec2 uv;
varying vec3 diffuseColor;
void main(void) {
vec3 cornerPos;
cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;
cornerPos.z=0.0;
vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;
gl_Position=projection*vec4(viewPos,1.0);
uv=offset;
diffuseColor=color.rgb;
}
`;te.ShadersStore[UL]=VL;const kL="fluidRenderingParticleDiffusePixelShader",GL=`uniform float particleAlpha;
varying vec2 uv;
varying vec3 diffuseColor;
void main(void) {
vec3 normal;
normal.xy=uv*2.0-1.0;
float r2=dot(normal.xy,normal.xy);
if (r2>1.0) discard;
glFragColor=vec4(diffuseColor,1.0);
}
`;te.ShadersStore[kL]=GL;const zL="fluidRenderingBilateralBlurPixelShader",HL=`uniform sampler2D textureSampler;
uniform int maxFilterSize;
uniform vec2 blurDir;
uniform float projectedParticleConstant;
uniform float depthThreshold;
varying vec2 vUV;
void main(void) {
float depth=textureLod(textureSampler,vUV,0.).x;
if (depth>=1e6 || depth<=0.) {
glFragColor=vec4(vec3(depth),1.);
return;
}
int filterSize=min(maxFilterSize,int(ceil(projectedParticleConstant/depth)));
float sigma=float(filterSize)/3.0;
float two_sigma2=2.0*sigma*sigma;
float sigmaDepth=depthThreshold/3.0;
float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;
float sum=0.;
float wsum=0.;
float sumVel=0.;
for (int x=-filterSize; x<=filterSize; ++x) {
vec2 coords=vec2(x);
vec2 sampleDepthVel=textureLod(textureSampler,vUV+coords*blurDir,0.).rg;
float r=dot(coords,coords);
float w=exp(-r/two_sigma2);
float rDepth=sampleDepthVel.r-depth;
float wd=exp(-rDepth*rDepth/two_sigmaDepth2);
sum+=sampleDepthVel.r*w*wd;
sumVel+=sampleDepthVel.g*w*wd;
wsum+=w*wd;
}
glFragColor=vec4(sum/wsum,sumVel/wsum,0.,1.);
}
`;te.ShadersStore[zL]=HL;const WL="fluidRenderingStandardBlurPixelShader",XL=`uniform sampler2D textureSampler;
uniform int filterSize;
uniform vec2 blurDir;
varying vec2 vUV;
void main(void) {
vec4 s=textureLod(textureSampler,vUV,0.);
if (s.r==0.) {
glFragColor=vec4(0.,0.,0.,1.);
return;
}
float sigma=float(filterSize)/3.0;
float twoSigma2=2.0*sigma*sigma;
vec4 sum=vec4(0.);
float wsum=0.;
for (int x=-filterSize; x<=filterSize; ++x) {
vec2 coords=vec2(x);
vec4 sampl=textureLod(textureSampler,vUV+coords*blurDir,0.);
float w=exp(-coords.x*coords.x/twoSigma2);
sum+=sampl*w;
wsum+=w;
}
sum/=wsum;
glFragColor=vec4(sum.rgb,1.);
}
`;te.ShadersStore[WL]=XL;const $L="fluidRenderingRenderPixelShader",YL=`#define IOR 1.333
#define ETA 1.0/IOR
#define F0 0.02
uniform sampler2D textureSampler;
uniform sampler2D depthSampler;
#ifdef FLUIDRENDERING_DIFFUSETEXTURE
uniform sampler2D diffuseSampler;
#else
uniform vec3 diffuseColor;
#endif
#ifdef FLUIDRENDERING_FIXED_THICKNESS
uniform float thickness;
uniform sampler2D bgDepthSampler;
#else
uniform float minimumThickness;
uniform sampler2D thicknessSampler;
#endif
#ifdef FLUIDRENDERING_ENVIRONMENT
uniform samplerCube reflectionSampler;
#endif
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)
uniform sampler2D debugSampler;
#endif
uniform mat4 viewMatrix;
uniform mat4 projectionMatrix;
uniform mat4 invProjectionMatrix;
uniform vec2 texelSize;
uniform vec3 dirLight;
uniform float cameraFar;
uniform float density;
uniform float refractionStrength;
uniform float fresnelClamp;
uniform float specularPower;
varying vec2 vUV;
vec3 computeViewPosFromUVDepth(vec2 texCoord,float depth) {
vec4 ndc;
ndc.xy=texCoord*2.0-1.0;
#ifdef FLUIDRENDERING_RHS
ndc.z=-projectionMatrix[2].z+projectionMatrix[3].z/depth;
#else
ndc.z=projectionMatrix[2].z+projectionMatrix[3].z/depth;
#endif
ndc.w=1.0;
vec4 eyePos=invProjectionMatrix*ndc;
eyePos.xyz/=eyePos.w;
return eyePos.xyz;
}
vec3 getViewPosFromTexCoord(vec2 texCoord) {
float depth=textureLod(depthSampler,texCoord,0.).x;
return computeViewPosFromUVDepth(texCoord,depth);
}
void main(void) {
vec2 texCoord=vUV;
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)
vec4 color=texture2D(debugSampler,texCoord);
#ifdef FLUIDRENDERING_DEBUG_DEPTH
glFragColor=vec4(color.rgb/vec3(2.0),1.);
if (color.r>0.999 && color.g>0.999) {
glFragColor=texture2D(textureSampler,texCoord);
}
#else
glFragColor=vec4(color.rgb,1.);
if (color.r<0.001 && color.g<0.001 && color.b<0.001) {
glFragColor=texture2D(textureSampler,texCoord);
}
#endif
return;
#endif
vec2 depthVel=textureLod(depthSampler,texCoord,0.).rg;
float depth=depthVel.r;
#ifndef FLUIDRENDERING_FIXED_THICKNESS
float thickness=texture2D(thicknessSampler,texCoord).x;
#else
float bgDepth=texture2D(bgDepthSampler,texCoord).x;
float depthNonLinear=projectionMatrix[2].z+projectionMatrix[3].z/depth;
depthNonLinear=depthNonLinear*0.5+0.5;
#endif
vec3 backColor=texture2D(textureSampler,texCoord).rgb;
#ifndef FLUIDRENDERING_FIXED_THICKNESS
if (depth>=cameraFar || depth<=0. || thickness<=minimumThickness) {
#else
if (depth>=cameraFar || depth<=0. || bgDepth<=depthNonLinear) {
#endif
glFragColor=vec4(backColor,1.);
return;
}
vec3 viewPos=computeViewPosFromUVDepth(texCoord,depth);
vec3 ddx=getViewPosFromTexCoord(texCoord+vec2(texelSize.x,0.))-viewPos;
vec3 ddy=getViewPosFromTexCoord(texCoord+vec2(0.,texelSize.y))-viewPos;
vec3 ddx2=viewPos-getViewPosFromTexCoord(texCoord+vec2(-texelSize.x,0.));
if (abs(ddx.z)>abs(ddx2.z)) {
ddx=ddx2;
}
vec3 ddy2=viewPos-getViewPosFromTexCoord(texCoord+vec2(0.,-texelSize.y));
if (abs(ddy.z)>abs(ddy2.z)) {
ddy=ddy2;
}
vec3 normal=normalize(cross(ddy,ddx));
#ifdef FLUIDRENDERING_RHS
normal=-normal;
#endif
#ifndef WEBGPU
if(isnan(normal.x) || isnan(normal.y) || isnan(normal.z) || isinf(normal.x) || isinf(normal.y) || isinf(normal.z)) {
normal=vec3(0.,0.,-1.);
}
#endif
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_SHOWNORMAL)
glFragColor=vec4(normal*0.5+0.5,1.0);
return;
#endif
vec3 rayDir=normalize(viewPos); 
#ifdef FLUIDRENDERING_DIFFUSETEXTURE
vec3 diffuseColor=texture2D(diffuseSampler,texCoord).rgb;
#endif
vec3 lightDir=normalize(vec3(viewMatrix*vec4(-dirLight,0.)));
vec3 H =normalize(lightDir-rayDir);
float specular=pow(max(0.0,dot(H,normal)),specularPower);
#ifdef FLUIDRENDERING_DEBUG_DIFFUSERENDERING
float diffuse =max(0.0,dot(lightDir,normal))*1.0;
glFragColor=vec4(vec3(0.1) /*ambient*/+vec3(0.42,0.50,1.00)*diffuse+vec3(0,0,0.2)+specular,1.);
return;
#endif
vec3 refractionDir=refract(rayDir,normal,ETA);
vec3 transmitted=(texture2D(textureSampler,vec2(texCoord+refractionDir.xy*thickness*refractionStrength)).rgb);
vec3 transmittance=exp(-density*thickness*(1.0-diffuseColor)); 
vec3 refractionColor=transmitted*transmittance;
#ifdef FLUIDRENDERING_ENVIRONMENT
vec3 reflectionDir=reflect(rayDir,normal);
vec3 reflectionColor=(textureCube(reflectionSampler,reflectionDir).rgb);
float fresnel=clamp(F0+(1.0-F0)*pow(1.0-dot(normal,-rayDir),5.0),0.,fresnelClamp);
vec3 finalColor=mix(refractionColor,reflectionColor,fresnel)+specular;
#else
vec3 finalColor=refractionColor+specular;
#endif
#ifdef FLUIDRENDERING_VELOCITY
float velocity=depthVel.g;
finalColor=mix(finalColor,vec3(1.0),smoothstep(0.3,1.0,velocity/6.0));
#endif
glFragColor=vec4(finalColor,1.);
}
`;te.ShadersStore[$L]=YL;Object.defineProperty(Ne.prototype,"fluidRenderer",{get:function(){return this._fluidRenderer},set:function(o){this._fluidRenderer=o},enumerable:!0,configurable:!0});Ne.prototype.enableFluidRenderer=function(){return this._fluidRenderer?this._fluidRenderer:(this._fluidRenderer=new jm(this),this._fluidRenderer)};Ne.prototype.disableFluidRenderer=function(){var o;(o=this._fluidRenderer)===null||o===void 0||o.dispose(),this._fluidRenderer=null};function jL(o){return!!o.particleSystem}class KL{constructor(e){this.name=Re.NAME_FLUIDRENDERER,this.scene=e}register(){this.scene._gatherActiveCameraRenderTargetsStage.registerStep(Re.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER,this,this._gatherActiveCameraRenderTargets),this.scene._afterCameraDrawStage.registerStep(Re.STEP_AFTERCAMERADRAW_FLUIDRENDERER,this,this._afterCameraDraw)}_gatherActiveCameraRenderTargets(e){var t;(t=this.scene.fluidRenderer)===null||t===void 0||t._prepareRendering()}_afterCameraDraw(e){var t;(t=this.scene.fluidRenderer)===null||t===void 0||t._render(e)}rebuild(){this.scene._fluidRenderer&&(this.scene.disableFluidRenderer(),this.scene.enableFluidRenderer())}dispose(){this.scene.disableFluidRenderer()}}class jm{static _SceneComponentInitialization(e){let t=e._getComponent(Re.NAME_FLUIDRENDERER);t||(t=new KL(e),e._addComponent(t))}constructor(e){this._scene=e,this._engine=e.getEngine(),this._onEngineResizeObserver=null,this.renderObjects=[],this.targetRenderers=[],this._cameras=new Map,jm._SceneComponentInitialization(this._scene),this._onEngineResizeObserver=this._engine.onResizeObservable.add(()=>{this._initialize()})}recreate(){this._sortRenderingObjects(),this._initialize()}getRenderObjectFromParticleSystem(e){const t=this._getParticleSystemIndex(e);return t!==-1?this.renderObjects[t]:null}addParticleSystem(e,t,i,r){const s=new yL(this._scene,e);s.onParticleSizeChanged.add(this._setParticleSizeForRenderTargets.bind(this)),i||(i=new yx(this._scene,r),this.targetRenderers.push(i)),i._onUseVelocityChanged.hasObservers()||i._onUseVelocityChanged.add(this._setUseVelocityForRenderObject.bind(this)),t!==void 0&&(i.generateDiffuseTexture=t);const n={object:s,targetRenderer:i};return this.renderObjects.push(n),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),n}addCustomParticles(e,t,i,r,s){const n=new CL(this._scene,e,t);n.onParticleSizeChanged.add(this._setParticleSizeForRenderTargets.bind(this)),r||(r=new yx(this._scene,s),this.targetRenderers.push(r)),r._onUseVelocityChanged.hasObservers()||r._onUseVelocityChanged.add(this._setUseVelocityForRenderObject.bind(this)),i!==void 0&&(r.generateDiffuseTexture=i);const a={object:n,targetRenderer:r};return this.renderObjects.push(a),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),a}removeRenderObject(e,t=!0){const i=this.renderObjects.indexOf(e);return i===-1?!1:(e.object.dispose(),this.renderObjects.splice(i,1),t&&this._removeUnusedTargetRenderers()?this._initialize():this._setParticleSizeForRenderTargets(),!0)}_sortRenderingObjects(){this.renderObjects.sort((e,t)=>e.object.priority<t.object.priority?-1:e.object.priority>t.object.priority?1:0)}_removeUnusedTargetRenderers(){const e={};for(let r=0;r<this.renderObjects.length;++r){const s=this.renderObjects[r].targetRenderer;e[this.targetRenderers.indexOf(s)]=!0}let t=!1;const i=[];for(let r=0;r<this.targetRenderers.length;++r)e[r]?i.push(this.targetRenderers[r]):(this.targetRenderers[r].dispose(),t=!0);return t&&(this.targetRenderers.length=0,this.targetRenderers.push(...i)),t}_getParticleSystemIndex(e){for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t].object;if(jL(i)&&i.particleSystem===e)return t}return-1}_initialize(){for(let i=0;i<this.targetRenderers.length;++i)this.targetRenderers[i].dispose();const e=new Map;for(let i=0;i<this.targetRenderers.length;++i){const r=this.targetRenderers[i];if(r._initialize(),r.camera&&r._renderPostProcess){let s=e.get(r.camera);s||(s=[[],{}],e.set(r.camera,s)),s[0].push(r),r.camera.attachPostProcess(r._renderPostProcess,i)}}let t=e.keys();for(let i=t.next();i.done!==!0;i=t.next()){const r=i.value,s=e.get(r),n=r._getFirstPostProcess();if(!n)continue;const[a,l]=s;n.onSizeChangedObservable.add(()=>{var c;n.inputTexture.depthStencilTexture||n.inputTexture.createDepthStencilTexture(0,!0,this._engine.isStencilEnable,a[0].samples);for(const h of a){const u=(c=h._thicknessRenderTarget)===null||c===void 0?void 0:c.renderTarget,d=u==null?void 0:u.texture;if(u&&d){const f=d.width+"_"+d.height;let _=l[f];_||(_=l[f]=new PL(this._engine,d.width,d.height)),_.depthRTWrapper._shareDepth(u)}}})}t=this._cameras.keys();for(let i=t.next();i.done!==!0;i=t.next()){const r=i.value,n=this._cameras.get(r)[1],a=e.get(r);if(a)for(const l in n)a[1][l]||n[l].dispose();else for(const l in n)n[l].dispose()}this._cameras.clear(),this._cameras=e,this._setParticleSizeForRenderTargets()}_setParticleSizeForRenderTargets(){const e=new Map;for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t];let r=e.get(i.targetRenderer);r===void 0&&(r=0),e.set(i.targetRenderer,Math.max(r,i.object.particleSize))}e.forEach((t,i)=>{i._depthRenderTarget&&(i._depthRenderTarget.particleSize=t)})}_setUseVelocityForRenderObject(){for(const e of this.renderObjects)e.object.useVelocity=e.targetRenderer.useVelocity}_prepareRendering(){for(const e of this.targetRenderers)if(e.needInitialization){this._initialize();return}}_render(e){var t;for(let r=0;r<this.targetRenderers.length;++r)(!e||this.targetRenderers[r].camera===e)&&this.targetRenderers[r]._clearTargets();const i=this._cameras.keys();for(let r=i.next();r.done!==!0;r=i.next()){const s=r.value,n=this._cameras.get(s);if(e&&s!==e)continue;const a=s._getFirstPostProcess();if(!a)continue;const l=(t=a.inputTexture)===null||t===void 0?void 0:t.depthStencilTexture;if(l){const[c,h]=n;for(const u of c)u._bgDepthTexture=l;for(const u in h)h[u].copy(l)}}for(let r=0;r<this.renderObjects.length;++r){const s=this.renderObjects[r];(!e||s.targetRenderer.camera===e)&&s.targetRenderer._render(s.object)}}dispose(){this._engine.onResizeObservable.remove(this._onEngineResizeObserver),this._onEngineResizeObserver=null;for(let e=0;e<this.renderObjects.length;++e)this.renderObjects[e].object.dispose();for(let e=0;e<this.targetRenderers.length;++e)this.targetRenderers[e].dispose();this._cameras.forEach(e=>{const t=e[1];for(const i in t)t[i].dispose()}),this.renderObjects=[],this.targetRenderers=[],this._cameras.clear()}}Ne.prototype._internalPickSprites=function(o,e,t,i){if(!Vs)return null;let r=null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}if(this.spriteManagers.length>0)for(let s=0;s<this.spriteManagers.length;s++){const n=this.spriteManagers[s];if(!n.isPickable)continue;const a=n.intersects(o,i,e,t);if(!(!a||!a.hit)&&!(!t&&r!=null&&a.distance>=r.distance)&&(r=a,t))break}return r||new Vs};Ne.prototype._internalMultiPickSprites=function(o,e,t){if(!Vs)return null;let i=new Array;if(!t){if(!this.activeCamera)return null;t=this.activeCamera}if(this.spriteManagers.length>0)for(let r=0;r<this.spriteManagers.length;r++){const s=this.spriteManagers[r];if(!s.isPickable)continue;const n=s.multiIntersects(o,t,e);n!==null&&(i=i.concat(n))}return i};Ne.prototype.pickSprite=function(o,e,t,i,r){if(!this._tempSpritePickingRay)return null;this.createPickingRayInCameraSpaceToRef(o,e,this._tempSpritePickingRay,r);const s=this._internalPickSprites(this._tempSpritePickingRay,t,i,r);return s&&(s.ray=this.createPickingRayInCameraSpace(o,e,r)),s};Ne.prototype.pickSpriteWithRay=function(o,e,t,i){if(!this._tempSpritePickingRay)return null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}Pt.TransformToRef(o,i.getViewMatrix(),this._tempSpritePickingRay);const r=this._internalPickSprites(this._tempSpritePickingRay,e,t,i);return r&&(r.ray=o),r};Ne.prototype.multiPickSprite=function(o,e,t,i){return this.createPickingRayInCameraSpaceToRef(o,e,this._tempSpritePickingRay,i),this._internalMultiPickSprites(this._tempSpritePickingRay,t,i)};Ne.prototype.multiPickSpriteWithRay=function(o,e,t){if(!this._tempSpritePickingRay)return null;if(!t){if(!this.activeCamera)return null;t=this.activeCamera}return Pt.TransformToRef(o,t.getViewMatrix(),this._tempSpritePickingRay),this._internalMultiPickSprites(this._tempSpritePickingRay,e,t)};Ne.prototype.setPointerOverSprite=function(o){this._pointerOverSprite!==o&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(10,is.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=o,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(9,is.CreateNewFromSprite(this._pointerOverSprite,this)))};Ne.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};const qL="imageProcessingCompatibility",QL=`#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));
#endif
`;te.IncludesShadersStore[qL]=QL;const ZL="spritesPixelShader",JL=`uniform bool alphaTest;
varying vec4 vColor;
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 color=texture2D(diffuseSampler,vUV);
float fAlphaTest=float(alphaTest);
if (fAlphaTest != 0.)
{
if (color.a<0.95)
discard;
}
color*=vColor;
#include<fogFragment>
gl_FragColor=color;
#include<imageProcessingCompatibility>
#define CUSTOM_FRAGMENT_MAIN_END
}`;te.ShadersStore[ZL]=JL;const eB="spritesVertexShader",tB=`attribute vec4 position;
attribute vec2 options;
attribute vec2 offsets;
attribute vec2 inverts;
attribute vec4 cellInfo;
attribute vec4 color;
uniform mat4 view;
uniform mat4 projection;
varying vec2 vUV;
varying vec4 vColor;
#include<fogVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; 
vec2 cornerPos;
float angle=position.w;
vec2 size=vec2(options.x,options.y);
vec2 offset=offsets.xy;
cornerPos=vec2(offset.x-0.5,offset.y -0.5)*size;
vec3 rotatedCorner;
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
viewPos+=rotatedCorner;
gl_Position=projection*vec4(viewPos,1.0); 
vColor=color;
vec2 uvOffset=vec2(abs(offset.x-inverts.x),abs(1.0-offset.y-inverts.y));
vec2 uvPlace=cellInfo.xy;
vec2 uvSize=cellInfo.zw;
vUV.x=uvPlace.x+uvSize.x*uvOffset.x;
vUV.y=uvPlace.y+uvSize.y*uvOffset.y;
#ifdef FOG
vFogDistance=viewPos;
#endif
#define CUSTOM_VERTEX_MAIN_END
}`;te.ShadersStore[eB]=tB;const iB="spriteMapPixelShader",rB=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
precision highp float;
varying vec3 vPosition;
varying vec2 vUV;
varying vec2 tUV;
uniform float time;
uniform float spriteCount;
uniform sampler2D spriteSheet;
uniform vec2 spriteMapSize;
uniform vec2 outputSize;
uniform vec2 stageSize;
uniform sampler2D frameMap;
uniform sampler2D tileMaps[LAYERS];
uniform sampler2D animationMap;
uniform vec3 colorMul;
float mt;
const float fdStep=1./4.;
const float aFrameSteps=1./MAX_ANIMATION_FRAMES;
mat4 getFrameData(float frameID){
float fX=frameID/spriteCount;
return mat4(
texture2D(frameMap,vec2(fX,0.),0.),
texture2D(frameMap,vec2(fX,fdStep*1.),0.),
texture2D(frameMap,vec2(fX,fdStep*2.),0.),
vec4(0.)
);
}
void main(){
vec4 color=vec4(0.);
vec2 tileUV=fract(tUV);
#ifdef FLIPU
tileUV.y=1.0-tileUV.y;
#endif
vec2 tileID=floor(tUV);
vec2 sheetUnits=1./spriteMapSize;
float spriteUnits=1./spriteCount;
vec2 stageUnits=1./stageSize;
for(int i=0; i<LAYERS; i++) {
float frameID;
#define LAYER_ID_SWITCH
vec4 animationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,0.),0.);
if(animationData.y>0.) {
mt=mod(time*animationData.z,1.0);
for(float f=0.; f<MAX_ANIMATION_FRAMES; f++){
if(animationData.y>mt){
frameID=animationData.x;
break;
}
animationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,aFrameSteps*f),0.);
}
}
mat4 frameData=getFrameData(frameID+0.5);
vec2 frameSize=(frameData[0].zw)/spriteMapSize;
vec2 offset=frameData[0].xy*sheetUnits;
vec2 ratio=frameData[2].xy/frameData[0].zw;
if (frameData[2].z==1.){
tileUV.xy=tileUV.yx;
}
vec4 nc=texture2D(spriteSheet,tileUV*frameSize+offset);
if (i==0){
color=nc;
} else {
float alpha=min(color.a+nc.a,1.0);
vec3 mixed=mix(color.xyz,nc.xyz,nc.a);
color=vec4(mixed,alpha);
}
}
color.xyz*=colorMul;
gl_FragColor=color;
}`;te.ShadersStore[iB]=rB;const sB="spriteMapVertexShader",nB=`precision highp float;
attribute vec3 position;
attribute vec3 normal;
attribute vec2 uv;
varying vec3 vPosition;
varying vec2 vUV;
varying vec2 tUV;
varying vec2 stageUnits;
varying vec2 levelUnits;
varying vec2 tileID;
uniform float time;
uniform mat4 worldViewProjection;
uniform vec2 outputSize;
uniform vec2 stageSize;
uniform vec2 spriteMapSize;
uniform float stageScale;
void main() {
vec4 p=vec4( position,1. );
vPosition=p.xyz;
vUV=uv;
tUV=uv*stageSize; 
gl_Position=worldViewProjection*p;
}`;te.ShadersStore[sB]=nB;var Cx;(function(o){o[o.INIT=0]="INIT",o[o.RUNNING=1]="RUNNING",o[o.DONE=2]="DONE",o[o.ERROR=3]="ERROR"})(Cx||(Cx={}));class Gh{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}}Q.prototype.notifyObserversWithPromise=async function(o,e=-1,t,i,r){let s=Promise.resolve(o);if(!this.observers.length)return s;const n=this._eventState;return n.mask=e,n.target=t,n.currentTarget=i,n.skipNextObservers=!1,n.userInfo=r,this.observers.forEach(a=>{n.skipNextObservers||a._willBeUnregistered||a.mask&e&&(a.scope?s=s.then(l=>(n.lastReturnValue=l,a.callback.apply(a.scope,[o,n]))):s=s.then(l=>(n.lastReturnValue=l,a.callback(o,n))),a.unregisterOnNextCall&&this._deferUnregister(a))}),await s,o};let ol=null;function wE(o,e,t,i,r="image/png",s=!1){const{height:n,width:a}=FE(o,e,t);if(!(n&&a)){X.Error("Invalid 'size' parameter !");return}ol||(ol=document.createElement("canvas")),ol.width=a,ol.height=n;const l=ol.getContext("2d"),c=o.getRenderWidth()/o.getRenderHeight();let h=a,u=h/c;u>n&&(u=n,h=u*c);const d=Math.max(0,a-h)/2,f=Math.max(0,n-u)/2;e.getScene().activeCamera!==e?Km(o,e,t,p=>{if(s){const m=new Blob([p]);J.DownloadBlob(m),i&&i("")}else i&&i(p)},r,1,o.getCreationOptions().antialias):o.onEndFrameObservable.addOnce(()=>{const p=o.getRenderingCanvas();l&&p&&l.drawImage(p,d,f,h,u),ol&&(s?(J.EncodeScreenshotCanvasData(ol,void 0,r),i&&i("")):J.EncodeScreenshotCanvasData(ol,i,r))})}function aB(o,e,t,i="image/png"){return new Promise((r,s)=>{wE(o,e,t,n=>{typeof n<"u"?r(n):s(new Error("Data is undefined"))},i)})}function Km(o,e,t,i,r="image/png",s=1,n=!1,a,l=!1,c=!1,h=!0){const{height:u,width:d}=FE(o,e,t),f={width:d,height:u};if(!(u&&d)){X.Error("Invalid 'size' parameter !");return}const _={width:o.getRenderWidth(),height:o.getRenderHeight()};o.setSize(d,u);const p=e.getScene(),m=new Zi("screenShot",f,p,!1,!1,0,!1,Y.NEAREST_SAMPLINGMODE,void 0,c,void 0,void 0,void 0,s);m.renderList=p.meshes.slice(),m.samples=s,m.renderSprites=l,m.activeCamera=e,m.forceLayerMaskCheck=h;const T=()=>{o.onEndFrameObservable.addOnce(()=>{m.readPixels(void 0,void 0,void 0,!1).then(b=>{Ys.DumpData(d,u,b,i,r,a,!0),m.dispose()})}),p.incrementRenderId(),p.resetCachedMaterial(),m.render(!0),p.incrementRenderId(),p.resetCachedMaterial(),o.setSize(_.width,_.height),e.getProjectionMatrix(!0),p.render()};if(n){const b=new Ah("antialiasing",1,p.activeCamera);m.addPostProcess(b),b.getEffect().isReady()?T():b.getEffect().onCompiled=()=>{T()}}else T()}function oB(o,e,t,i="image/png",r=1,s=!1,n,a=!1,l=!1,c=!0){return new Promise((h,u)=>{Km(o,e,t,d=>{typeof d<"u"?h(d):u(new Error("Data is undefined"))},i,r,s,n,a,l,c)})}function FE(o,e,t){let i=0,r=0;if(typeof t=="object"){const s=t.precision?Math.abs(t.precision):1;t.width&&t.height?(i=t.height*s,r=t.width*s):t.width&&!t.height?(r=t.width*s,i=Math.round(r/o.getAspectRatio(e))):t.height&&!t.width?(i=t.height*s,r=Math.round(i*o.getAspectRatio(e))):(r=Math.round(o.getRenderWidth()*s),i=Math.round(r/o.getAspectRatio(e)))}else isNaN(t)||(i=t,r=t);return r&&(r=Math.floor(r)),i&&(i=Math.floor(i)),{height:i|0,width:r|0}}const lB=()=>{J.CreateScreenshot=wE,J.CreateScreenshotAsync=aB,J.CreateScreenshotUsingRenderTarget=Km,J.CreateScreenshotUsingRenderTargetAsync=oB};lB();var Ax;(function(o){o[o.Checkbox=0]="Checkbox",o[o.Slider=1]="Slider",o[o.Vector3=2]="Vector3",o[o.Quaternion=3]="Quaternion",o[o.Color3=4]="Color3",o[o.String=5]="String",o[o.Button=6]="Button",o[o.Options=7]="Options",o[o.Tab=8]="Tab",o[o.FileButton=9]="FileButton",o[o.Vector2=10]="Vector2"})(Ax||(Ax={}));class N_{constructor(e){this.byteOffset=0,this.buffer=e}loadAsync(e){return this.buffer.readAsync(this.byteOffset,e).then(t=>{this._dataView=new DataView(t.buffer,t.byteOffset,t.byteLength),this._dataByteOffset=0})}readUint32(){const e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return Gb(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}}class Rx{static _GetStorage(){try{return localStorage.setItem("test",""),localStorage.removeItem("test"),localStorage}catch{const t={};return{getItem:i=>{const r=t[i];return r===void 0?null:r},setItem:(i,r)=>{t[i]=r}}}}static ReadString(e,t){const i=this._Storage.getItem(e);return i!==null?i:t}static WriteString(e,t){this._Storage.setItem(e,t)}static ReadBoolean(e,t){const i=this._Storage.getItem(e);return i!==null?i==="true":t}static WriteBoolean(e,t){this._Storage.setItem(e,t?"true":"false")}static ReadNumber(e,t){const i=this._Storage.getItem(e);return i!==null?parseFloat(i):t}static WriteNumber(e,t){this._Storage.setItem(e,t.toString())}}Rx._Storage=Rx._GetStorage();var Ix;(function(o){class e{serialize(){const r={},s=new Array(this._characterToIdx.size);return this._characterToIdx.forEach((n,a)=>{s[n]=a}),r.characters=s,r.insertionCosts=this._insertionCosts,r.deletionCosts=this._deletionCosts,r.substitutionCosts=this._substitutionCosts,JSON.stringify(r)}static Deserialize(r){const s=JSON.parse(r),n=new e(s.characters);return n._insertionCosts=s.insertionCosts,n._deletionCosts=s.deletionCosts,n._substitutionCosts=s.substitutionCosts,n}constructor(r,s=null,n=null,a=null){s=s??(()=>1),n=n??(()=>1),a=a??((c,h)=>c===h?0:1),this._characterToIdx=new Map,this._insertionCosts=new Array(r.length),this._deletionCosts=new Array(r.length),this._substitutionCosts=new Array(r.length);let l;for(let c=0;c<r.length;++c){l=r[c],this._characterToIdx.set(l,c),this._insertionCosts[c]=s(l),this._deletionCosts[c]=n(l),this._substitutionCosts[c]=new Array(r.length);for(let h=c;h<r.length;++h)this._substitutionCosts[c][h]=a(l,r[h])}}getCharacterIdx(r){return this._characterToIdx.get(r)}getInsertionCost(r){return this._insertionCosts[r]}getDeletionCost(r){return this._deletionCosts[r]}getSubstitutionCost(r,s){const n=Math.min(r,s),a=Math.max(r,s);return this._substitutionCosts[n][a]}}o.Alphabet=e;class t{serialize(){return JSON.stringify(this._characters)}static Deserialize(r,s){const n=new t([],s);return n._characters=JSON.parse(r),n}constructor(r,s){if(r.length>t._MAX_SEQUENCE_LENGTH)throw new Error("Sequences longer than "+t._MAX_SEQUENCE_LENGTH+" not supported.");this._alphabet=s,this._characters=r.map(n=>this._alphabet.getCharacterIdx(n))}distance(r){return t._Distance(this,r)}static _Distance(r,s){const n=r._alphabet;if(n!==s._alphabet)throw new Error("Cannot Levenshtein compare Sequences built from different alphabets.");const a=r._characters,l=s._characters,c=a.length,h=l.length,u=t._CostMatrix;u[0][0]=0;for(let d=0;d<c;++d)u[d+1][0]=u[d][0]+n.getInsertionCost(a[d]);for(let d=0;d<h;++d)u[0][d+1]=u[0][d]+n.getInsertionCost(l[d]);for(let d=0;d<c;++d)for(let f=0;f<h;++f)t._InsertionCost=u[d+1][f]+n.getInsertionCost(l[f]),t._DeletionCost=u[d][f+1]+n.getDeletionCost(a[d]),t._SubstitutionCost=u[d][f]+n.getSubstitutionCost(a[d],l[f]),u[d+1][f+1]=Math.min(t._InsertionCost,t._DeletionCost,t._SubstitutionCost);return u[c][h]}}t._MAX_SEQUENCE_LENGTH=256,t._CostMatrix=[...Array(t._MAX_SEQUENCE_LENGTH+1)].map(()=>new Array(t._MAX_SEQUENCE_LENGTH+1)),o.Sequence=t})(Ix||(Ix={}));new H;const cB=1.5;class ll{constructor(e){this._view=new Float32Array(e),this._itemLength=0}get itemLength(){return this._itemLength}at(e){return e<0||e>=this._itemLength?NaN:this._view[e]}subarray(e,t){return e>=t||e<0?new Float32Array(0):(t>this._itemLength&&(t=this._itemLength),this._view.subarray(e,t))}push(e){this._view[this._itemLength]=e,this._itemLength++,this._itemLength>=this._view.length&&this._growArray()}_growArray(){const e=Math.floor(this._view.length*cB),t=new Float32Array(e);t.set(this._view),this._view=t}}const cl=1800,hB=24,uB="0",Px="timestamp",Mx="numPoints",dB=/\r/g,w_="@";class Ba{static get SliceDataOffset(){return 2}static get NumberOfPointsOffset(){return 1}constructor(e,t){this._scene=e,this._collectDataAtFrame=()=>{const i=Us.Now-this._startingTimestamp,r=this.datasets.ids.length,s=this.datasets.startingIndices.itemLength;let n=0;if(s>0){const a=this.datasets.startingIndices.at(s-1);n=a+this.datasets.data.at(a+Ba.NumberOfPointsOffset)+Ba.SliceDataOffset}if(this.datasets.startingIndices.push(n),this.datasets.data.push(i),this.datasets.data.push(r),this.datasets.ids.forEach(a=>{const l=this._strategies.get(a);l&&this.datasets.data.push(l.getData())}),this.datasetObservable.hasObservers()){const a=[i,r];for(let l=0;l<r;l++)a.push(this.datasets.data.at(n+Ba.SliceDataOffset+l));this.datasetObservable.notifyObservers(a)}},this.datasets={ids:[],data:new ll(cl),startingIndices:new ll(cl)},this._strategies=new Map,this._datasetMeta=new Map,this._eventRestoreSet=new Set,this._customEventObservable=new Q,this.datasetObservable=new Q,this.metadataObservable=new Q(i=>i.callback(this._datasetMeta,new $x(0))),t&&this.addCollectionStrategies(...t)}registerEvent(e,t,i){var r;if(this._strategies.has(e)&&!t)return;this._strategies.has(e)&&t&&((r=this._strategies.get(e))===null||r===void 0||r.dispose(),this._strategies.delete(e));const s=a=>{let l=0,c=0;const h=a.onAfterRenderObservable.add(()=>{c=l,l=0}),u=this._customEventObservable.add(d=>{e===d.name&&(d.value!==void 0?l=d.value:l++)});return{id:e,getData:()=>c,dispose:()=>{a.onAfterRenderObservable.remove(h),this._customEventObservable.remove(u)}}},n={name:e};return this._eventRestoreSet.add(e),this.addCollectionStrategies({strategyCallback:s,category:i}),n}sendEvent(e){this._customEventObservable.notifyObservers(e)}_restoreStringEvents(){this._eventRestoreSet.size!==this._customEventObservable.observers.length&&this._eventRestoreSet.forEach(e=>{this.registerEvent(e,!0)})}addCollectionStrategies(...e){for(let{strategyCallback:t,category:i,hidden:r}of e){const s=t(this._scene);if(this._strategies.has(s.id)){s.dispose();continue}this.datasets.ids.push(s.id),i&&(i=i.replace(new RegExp(w_,"g"),"")),this._datasetMeta.set(s.id,{color:this._getHexColorFromId(s.id),category:i,hidden:r}),this._strategies.set(s.id,s)}this.metadataObservable.notifyObservers(this._datasetMeta)}_getHexColorFromId(e){let t=0;for(let r=0;r<e.length;r++)t=e.charCodeAt(r)+((t<<5)-t);let i="#";for(let r=0;r<hB;r+=8){const s=t>>r&255;i+=(uB+s.toString(16)).substr(-2)}return i}getCurrentSlice(){const e=Us.Now-this._startingTimestamp,t=this.datasets.ids.length,i=[e,t];this.datasets.ids.forEach(r=>{const s=this._strategies.get(r);s&&this.datasetObservable.hasObservers()&&i.push(s.getData())}),this.datasetObservable.hasObservers()&&this.datasetObservable.notifyObservers(i)}updateMetadata(e,t,i){const r=this._datasetMeta.get(e);r&&(r[t]=i,this.metadataObservable.notifyObservers(this._datasetMeta))}clear(e){this.datasets.data=new ll(cl),this.datasets.ids.length=0,this.datasets.startingIndices=new ll(cl),this._datasetMeta.clear(),this._strategies.forEach(t=>t.dispose()),this._strategies.clear(),e||this._eventRestoreSet.clear(),this._hasLoadedData=!1}get hasLoadedData(){return this._hasLoadedData}loadFromFileData(e,t){const i=e.replace(dB,"").split(`
`).map(u=>u.split(",").filter(d=>d.length>0)).filter(u=>u.length>0),r=0,s=Ba.NumberOfPointsOffset;if(i.length<2)return!1;const n={ids:[],data:new ll(cl),startingIndices:new ll(cl)},[a,...l]=i;if(a.length<2||a[r]!==Px||a[s]!==Mx)return!1;const c=new Map;for(let u=Ba.SliceDataOffset;u<a.length;u++){const[d,f]=a[u].split(w_);n.ids.push(d),c.set(d,f)}let h=0;for(const u of l){if(u.length<2)return!1;const d=parseFloat(u[r]),f=parseInt(u[s]);if(isNaN(f)||isNaN(d)||(n.data.push(d),n.data.push(f),f+Ba.SliceDataOffset!==u.length))return!1;for(let _=Ba.SliceDataOffset;_<u.length;_++){const p=parseFloat(u[_]);if(isNaN(p))return!1;n.data.push(p)}n.startingIndices.push(h),h+=u.length}if(this.datasets.ids=n.ids,this.datasets.data=n.data,this.datasets.startingIndices=n.startingIndices,t||this._datasetMeta.clear(),this._strategies.forEach(u=>u.dispose()),this._strategies.clear(),!t)for(const u of this.datasets.ids){const d=c.get(u);this._datasetMeta.set(u,{category:d,color:this._getHexColorFromId(u)})}return this.metadataObservable.notifyObservers(this._datasetMeta),this._hasLoadedData=!0,!0}exportDataToCsv(){let e="";e+=`${Px},${Mx}`;for(let i=0;i<this.datasets.ids.length;i++)if(e+=`,${this.datasets.ids[i]}`,this._datasetMeta){const r=this._datasetMeta.get(this.datasets.ids[i]);r!=null&&r.category&&(e+=`${w_}${r.category}`)}e+=`
`;for(let i=0;i<this.datasets.startingIndices.itemLength;i++){const r=this.datasets.startingIndices.at(i),s=this.datasets.data.at(r),n=this.datasets.data.at(r+Ba.NumberOfPointsOffset);e+=`${s},${n}`;for(let a=0;a<n;a++)e+=`,${this.datasets.data.at(r+Ba.SliceDataOffset+a)}`;for(let a=0;a<this.datasets.ids.length-n;a++)e+=",";e+=`
`}const t=`${new Date().toISOString()}-perfdata.csv`;J.Download(new Blob([e],{type:"text/csv"}),t)}start(e){e?this._startingTimestamp===void 0&&(this._startingTimestamp=Us.Now):(this.datasets.data=new ll(cl),this.datasets.startingIndices=new ll(cl),this._startingTimestamp=Us.Now),this._scene.onAfterRenderObservable.add(this._collectDataAtFrame),this._restoreStringEvents(),this._isStarted=!0}stop(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._isStarted=!1}get isStarted(){return this._isStarted}dispose(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._datasetMeta.clear(),this._strategies.forEach(e=>{e.dispose()}),this.datasetObservable.clear(),this.metadataObservable.clear(),this._isStarted=!1,this.datasets=null}}Ne.prototype.getPerfCollector=function(){return this._perfCollector||(this._perfCollector=new Ba(this)),this._perfCollector};function fB(o){const e=new Array,t=new Array,i=new Array,r=o.add(()=>{const n=e.length;for(let a=0;a<n;a++)Wd(e.shift(),t.shift(),i.shift())});return{scheduler:(n,a,l)=>{e.push(n),t.push(a),i.push(l)},dispose:()=>{o.remove(r)}}}Q.prototype.runCoroutineAsync=function(o){if(!this._coroutineScheduler){const e=fB(this);this._coroutineScheduler=e.scheduler,this._coroutineSchedulerDispose=e.dispose}return pT(o,this._coroutineScheduler)};Q.prototype.cancelAllCoroutines=function(){this._coroutineSchedulerDispose&&this._coroutineSchedulerDispose(),this._coroutineScheduler=void 0,this._coroutineSchedulerDispose=void 0};class Cl extends Gs{constructor(e,t={}){super(e),this.options=t,this._direction=new x(0,0,-1),this._mat=new H,this._onSelectEnabled=!1,this._origin=new x(0,0,0),this.lastNativeXRHitResults=[],this.onHitTestResultObservable=new Q,this._onHitTestResults=i=>{const r=i.map(s=>{const n=H.FromArray(s.hitMatrix);return this._xrSessionManager.scene.useRightHandedSystem||n.toggleModelMatrixHandInPlace(),this.options.worldParentNode&&n.multiplyToRef(this.options.worldParentNode.getWorldMatrix(),n),{xrHitResult:s,transformationMatrix:n}});this.lastNativeXRHitResults=i,this.onHitTestResultObservable.notifyObservers(r)},this._onSelect=i=>{this._onSelectEnabled&&Cl.XRHitTestWithSelectEvent(i,this._xrSessionManager.referenceSpace)},this.xrNativeFeatureName="hit-test",J.Warn("A newer version of this plugin is available")}static XRHitTestWithRay(e,t,i,r){return e.requestHitTest(t,i).then(s=>{const n=r||(a=>!!a.hitMatrix);return s.filter(n)})}static XRHitTestWithSelectEvent(e,t){const i=e.frame.getPose(e.inputSource.targetRaySpace,t);if(!i)return Promise.resolve([]);const r=new XRRay(i.transform);return this.XRHitTestWithRay(e.frame.session,r,t)}attach(){return super.attach()?(this.options.testOnPointerDownOnly&&this._xrSessionManager.session.addEventListener("select",this._onSelect,!1),!0):!1}detach(){return super.detach()?(this._onSelectEnabled=!1,this._xrSessionManager.session.removeEventListener("select",this._onSelect),!0):!1}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(!this.attached||this.options.testOnPointerDownOnly)return;const t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;H.FromArrayToRef(t.transform.matrix,0,this._mat),x.TransformCoordinatesFromFloatsToRef(0,0,0,this._mat,this._origin),x.TransformCoordinatesFromFloatsToRef(0,0,-1,this._mat,this._direction),this._direction.subtractInPlace(this._origin),this._direction.normalize();const i=new XRRay({x:this._origin.x,y:this._origin.y,z:this._origin.z,w:0},{x:this._direction.x,y:this._direction.y,z:this._direction.z,w:0});Cl.XRHitTestWithRay(this._xrSessionManager.session,i,this._xrSessionManager.referenceSpace).then(this._onHitTestResults)}}Cl.Name=si.HIT_TEST;Cl.Version=1;dr.AddWebXRFeature(Cl.Name,(o,e)=>()=>new Cl(o,e),Cl.Version,!1);let _B=0;class Qh extends Gs{set referenceSpaceForFrameAnchors(e){this._referenceSpaceForFrameAnchors=e}constructor(e,t={}){super(e),this._options=t,this._lastFrameDetected=new Set,this._trackedAnchors=[],this._futureAnchors=[],this.onAnchorAddedObservable=new Q,this.onAnchorRemovedObservable=new Q,this.onAnchorUpdatedObservable=new Q,this._tmpVector=new x,this._tmpQuaternion=new oe,this.xrNativeFeatureName="anchors"}_populateTmpTransformation(e,t){return this._tmpVector.copyFrom(e),this._tmpQuaternion.copyFrom(t),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpVector.z*=-1,this._tmpQuaternion.z*=-1,this._tmpQuaternion.w*=-1),{position:this._tmpVector,rotationQuaternion:this._tmpQuaternion}}async addAnchorPointUsingHitTestResultAsync(e,t=new x,i=new oe){this._populateTmpTransformation(t,i);const r=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w});if(e.xrHitResult.createAnchor)try{const s=await e.xrHitResult.createAnchor(r);return new Promise((n,a)=>{this._futureAnchors.push({nativeAnchor:s,resolved:!1,submitted:!0,xrTransformation:r,resolve:n,reject:a})})}catch(s){throw new Error(s)}else throw this.detach(),new Error("Anchors not enabled in this environment/browser")}async addAnchorAtPositionAndRotationAsync(e,t=new oe,i=!1){this._populateTmpTransformation(e,t);const r=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w}),s=i&&this.attached&&this._xrSessionManager.currentFrame?await this._createAnchorAtTransformation(r,this._xrSessionManager.currentFrame):void 0;return new Promise((n,a)=>{this._futureAnchors.push({nativeAnchor:s,resolved:!1,submitted:!1,xrTransformation:r,resolve:n,reject:a})})}get anchors(){return this._trackedAnchors}detach(){if(!super.detach())return!1;if(!this._options.doNotRemoveAnchorsOnSessionEnded)for(;this._trackedAnchors.length;){const e=this._trackedAnchors.pop();if(e){try{e.remove()}catch{}this.onAnchorRemovedObservable.notifyObservers(e)}}return!0}dispose(){this._futureAnchors.length=0,super.dispose(),this.onAnchorAddedObservable.clear(),this.onAnchorRemovedObservable.clear(),this.onAnchorUpdatedObservable.clear()}_onXRFrame(e){if(!this.attached||!e)return;const t=e.trackedAnchors;if(t){const i=this._trackedAnchors.filter(s=>!t.has(s.xrAnchor)).map(s=>this._trackedAnchors.indexOf(s));let r=0;i.forEach(s=>{const n=this._trackedAnchors.splice(s-r,1)[0];this.onAnchorRemovedObservable.notifyObservers(n),r++}),t.forEach(s=>{if(this._lastFrameDetected.has(s)){const n=this._findIndexInAnchorArray(s),a=this._trackedAnchors[n];try{this._updateAnchorWithXRFrame(s,a,e),a.attachedNode&&(a.attachedNode.rotationQuaternion=a.attachedNode.rotationQuaternion||new oe,a.transformationMatrix.decompose(a.attachedNode.scaling,a.attachedNode.rotationQuaternion,a.attachedNode.position)),this.onAnchorUpdatedObservable.notifyObservers(a)}catch{J.Warn("Anchor could not be updated")}}else{const n={id:_B++,xrAnchor:s,remove:()=>s.delete()},a=this._updateAnchorWithXRFrame(s,n,e);this._trackedAnchors.push(a),this.onAnchorAddedObservable.notifyObservers(a);const c=this._futureAnchors.filter(h=>h.nativeAnchor===s)[0];c&&(c.resolve(a),c.resolved=!0)}}),this._lastFrameDetected=t}this._futureAnchors.forEach(i=>{!i.resolved&&!i.submitted&&(this._createAnchorAtTransformation(i.xrTransformation,e).then(r=>{i.nativeAnchor=r},r=>{i.resolved=!0,i.reject(r)}),i.submitted=!0)})}_findIndexInAnchorArray(e){for(let t=0;t<this._trackedAnchors.length;++t)if(this._trackedAnchors[t].xrAnchor===e)return t;return-1}_updateAnchorWithXRFrame(e,t,i){const r=i.getPose(e.anchorSpace,this._xrSessionManager.referenceSpace);if(r){const s=t.transformationMatrix||new H;H.FromArrayToRef(r.transform.matrix,0,s),this._xrSessionManager.scene.useRightHandedSystem||s.toggleModelMatrixHandInPlace(),t.transformationMatrix=s,this._options.worldParentNode&&s.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),s)}return t}async _createAnchorAtTransformation(e,t){var i;if(t.createAnchor)try{return t.createAnchor(e,(i=this._referenceSpaceForFrameAnchors)!==null&&i!==void 0?i:this._xrSessionManager.referenceSpace)}catch(r){throw new Error(r)}else throw this.detach(),new Error("Anchors are not enabled in your browser")}}Qh.Name=si.ANCHOR_SYSTEM;Qh.Version=1;dr.AddWebXRFeature(Qh.Name,(o,e)=>()=>new Qh(o,e),Qh.Version);let pB=0;class Zh extends Gs{constructor(e,t={}){super(e),this._options=t,this._detectedPlanes=[],this._enabled=!1,this._lastFrameDetected=new Set,this.onPlaneAddedObservable=new Q,this.onPlaneRemovedObservable=new Q,this.onPlaneUpdatedObservable=new Q,this.xrNativeFeatureName="plane-detection",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){if(!super.detach())return!1;if(!this._options.doNotRemovePlanesOnSessionEnded)for(;this._detectedPlanes.length;){const e=this._detectedPlanes.pop();e&&this.onPlaneRemovedObservable.notifyObservers(e)}return!0}dispose(){super.dispose(),this.onPlaneAddedObservable.clear(),this.onPlaneRemovedObservable.clear(),this.onPlaneUpdatedObservable.clear()}isCompatible(){return typeof XRPlane<"u"}_onXRFrame(e){var t;if(!this.attached||!this._enabled||!e)return;const i=e.detectedPlanes||((t=e.worldInformation)===null||t===void 0?void 0:t.detectedPlanes);if(i){for(let r=0;r<this._detectedPlanes.length;r++){const s=this._detectedPlanes[r];i.has(s.xrPlane)||(this._detectedPlanes.splice(r--,1),this.onPlaneRemovedObservable.notifyObservers(s))}i.forEach(r=>{if(this._lastFrameDetected.has(r)){if(r.lastChangedTime===this._xrSessionManager.currentTimestamp){const s=this._findIndexInPlaneArray(r),n=this._detectedPlanes[s];this._updatePlaneWithXRPlane(r,n,e),this.onPlaneUpdatedObservable.notifyObservers(n)}}else{const s={id:pB++,xrPlane:r,polygonDefinition:[]},n=this._updatePlaneWithXRPlane(r,s,e);this._detectedPlanes.push(n),this.onPlaneAddedObservable.notifyObservers(n)}}),this._lastFrameDetected=i}}_init(){const e=()=>{this._enabled=!0,this._detectedPlanes.length&&(this._detectedPlanes.length=0)};if(this._xrSessionManager.isNative&&this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions(this._options.preferredDetectorOptions),!this._xrSessionManager.session.updateWorldTrackingState){e();return}this._xrSessionManager.session.updateWorldTrackingState({planeDetectionState:{enabled:!0}}),e()}_updatePlaneWithXRPlane(e,t,i){t.polygonDefinition=e.polygon.map(s=>{const n=this._xrSessionManager.scene.useRightHandedSystem?1:-1;return new x(s.x,s.y,s.z*n)});const r=i.getPose(e.planeSpace,this._xrSessionManager.referenceSpace);if(r){const s=t.transformationMatrix||new H;H.FromArrayToRef(r.transform.matrix,0,s),this._xrSessionManager.scene.useRightHandedSystem||s.toggleModelMatrixHandInPlace(),t.transformationMatrix=s,this._options.worldParentNode&&s.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),s)}return t}_findIndexInPlaneArray(e){for(let t=0;t<this._detectedPlanes.length;++t)if(this._detectedPlanes[t].xrPlane===e)return t;return-1}}Zh.Name=si.PLANE_DETECTION;Zh.Version=1;dr.AddWebXRFeature(Zh.Name,(o,e)=>()=>new Zh(o,e),Zh.Version);class Jh extends Gs{constructor(e,t={}){super(e),this.options=t,this.onBackgroundStateChangedObservable=new Q}attach(){return this._setBackgroundState(!1),super.attach()}detach(){return this._setBackgroundState(!0),super.detach()}dispose(){super.dispose(),this.onBackgroundStateChangedObservable.clear()}_onXRFrame(e){}_setBackgroundState(e){const t=this._xrSessionManager.scene;if(!this.options.ignoreEnvironmentHelper)if(this.options.environmentHelperRemovalFlags){if(this.options.environmentHelperRemovalFlags.skyBox){const i=t.getMeshByName("BackgroundSkybox");i&&i.setEnabled(e)}if(this.options.environmentHelperRemovalFlags.ground){const i=t.getMeshByName("BackgroundPlane");i&&i.setEnabled(e)}}else{const i=t.getMeshByName("BackgroundHelper");i&&i.setEnabled(e)}this.options.backgroundMeshes&&this.options.backgroundMeshes.forEach(i=>i.setEnabled(e)),this.onBackgroundStateChangedObservable.notifyObservers(e)}}Jh.Name=si.BACKGROUND_REMOVER;Jh.Version=1;dr.AddWebXRFeature(Jh.Name,(o,e)=>()=>new Jh(o,e),Jh.Version,!0);class eu extends Gs{_createPhysicsImpostor(e){const t=this._options.physicsProperties.impostorType||ht.SphereImpostor,i=this._options.physicsProperties.impostorSize||.1,r=jo("impostor-mesh-"+e.uniqueId,{diameterX:typeof i=="number"?i:i.width,diameterY:typeof i=="number"?i:i.height,diameterZ:typeof i=="number"?i:i.depth});r.isVisible=this._debugMode,r.isPickable=!1,r.rotationQuaternion=new oe;const s=e.grip||e.pointer;r.position.copyFrom(s.position),r.rotationQuaternion.copyFrom(s.rotationQuaternion);const n=new ht(r,t,{mass:0,...this._options.physicsProperties});this._controllers[e.uniqueId]={xrController:e,impostor:n,impostorMesh:r}}constructor(e,t){super(e),this._options=t,this._attachController=i=>{this._controllers[i.uniqueId]||(this._xrSessionManager.scene.isPhysicsEnabled()||X.Warn("physics engine not enabled, skipped. Please add this controller manually."),this._options.physicsProperties.useControllerMesh&&i.inputSource.gamepad?i.onMotionControllerInitObservable.addOnce(r=>{r._doNotLoadControllerMesh?this._createPhysicsImpostor(i):r.onModelLoadedObservable.addOnce(()=>{const s=new ht(r.rootMesh,ht.MeshImpostor,{mass:0,...this._options.physicsProperties}),n=i.grip||i.pointer;this._controllers[i.uniqueId]={xrController:i,impostor:s,oldPos:n.position.clone(),oldRotation:n.rotationQuaternion.clone()}})}):this._createPhysicsImpostor(i))},this._controllers={},this._debugMode=!1,this._delta=0,this._lastTimestamp=0,this._tmpQuaternion=new oe,this._tmpVector=new x,this._options.physicsProperties||(this._options.physicsProperties={})}_enablePhysicsDebug(){this._debugMode=!0,Object.keys(this._controllers).forEach(e=>{const t=this._controllers[e];t.impostorMesh&&(t.impostorMesh.isVisible=!0)})}addController(e){this._attachController(e)}attach(){if(!super.attach())return!1;if(!this._options.xrInput)return!0;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._options.enableHeadsetImpostor){const e=this._options.headsetImpostorParams||{impostorType:ht.SphereImpostor,restitution:.8,impostorSize:.3},t=e.impostorSize||.3;this._headsetMesh=jo("headset-mesh",{diameterX:typeof t=="number"?t:t.width,diameterY:typeof t=="number"?t:t.height,diameterZ:typeof t=="number"?t:t.depth}),this._headsetMesh.rotationQuaternion=new oe,this._headsetMesh.isVisible=!1,this._headsetImpostor=new ht(this._headsetMesh,e.impostorType,{mass:0,...e})}return!0}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._headsetMesh&&this._headsetMesh.dispose(),!0):!1}getHeadsetImpostor(){return this._headsetImpostor}getImpostorForController(e){const t=typeof e=="string"?e:e.uniqueId;return this._controllers[t]?this._controllers[t].impostor:null}setPhysicsProperties(e){this._options.physicsProperties={...this._options.physicsProperties,...e}}_onXRFrame(e){var t,i;if(this._delta=this._xrSessionManager.currentTimestamp-this._lastTimestamp,this._lastTimestamp=this._xrSessionManager.currentTimestamp,this._headsetMesh&&this._headsetImpostor){if(this._headsetMesh.position.copyFrom(this._options.xrInput.xrCamera.globalPosition),this._headsetMesh.rotationQuaternion.copyFrom(this._options.xrInput.xrCamera.absoluteRotation),!((t=this._options.xrInput.xrCamera._lastXRViewerPose)===null||t===void 0)&&t.linearVelocity){const r=this._options.xrInput.xrCamera._lastXRViewerPose.linearVelocity;this._tmpVector.set(r.x,r.y,r.z),this._headsetImpostor.setLinearVelocity(this._tmpVector)}if(!((i=this._options.xrInput.xrCamera._lastXRViewerPose)===null||i===void 0)&&i.angularVelocity){const r=this._options.xrInput.xrCamera._lastXRViewerPose.angularVelocity;this._tmpVector.set(r.x,r.y,r.z),this._headsetImpostor.setAngularVelocity(this._tmpVector)}}Object.keys(this._controllers).forEach(r=>{var s,n;const a=this._controllers[r],l=a.xrController.grip||a.xrController.pointer,c=a.oldPos||a.impostorMesh.position;if(!((s=a.xrController._lastXRPose)===null||s===void 0)&&s.linearVelocity){const u=a.xrController._lastXRPose.linearVelocity;this._tmpVector.set(u.x,u.y,u.z),a.impostor.setLinearVelocity(this._tmpVector)}else l.position.subtractToRef(c,this._tmpVector),this._tmpVector.scaleInPlace(1e3/this._delta),a.impostor.setLinearVelocity(this._tmpVector);c.copyFrom(l.position),this._debugMode&&console.log(this._tmpVector,"linear");const h=a.oldRotation||a.impostorMesh.rotationQuaternion;if(!((n=a.xrController._lastXRPose)===null||n===void 0)&&n.angularVelocity){const u=a.xrController._lastXRPose.angularVelocity;this._tmpVector.set(u.x,u.y,u.z),a.impostor.setAngularVelocity(this._tmpVector)}else if(!h.equalsWithEpsilon(l.rotationQuaternion)){h.conjugateInPlace().multiplyToRef(l.rotationQuaternion,this._tmpQuaternion);const u=Math.sqrt(this._tmpQuaternion.x*this._tmpQuaternion.x+this._tmpQuaternion.y*this._tmpQuaternion.y+this._tmpQuaternion.z*this._tmpQuaternion.z);if(this._tmpVector.set(this._tmpQuaternion.x,this._tmpQuaternion.y,this._tmpQuaternion.z),u<.001)this._tmpVector.scaleInPlace(2);else{const d=2*Math.atan2(u,this._tmpQuaternion.w);this._tmpVector.scaleInPlace(d/(u*(this._delta/1e3)))}a.impostor.setAngularVelocity(this._tmpVector)}h.copyFrom(l.rotationQuaternion),this._debugMode&&console.log(this._tmpVector,this._tmpQuaternion,"angular")})}_detachController(e){const t=this._controllers[e];t&&(t.impostorMesh&&t.impostorMesh.dispose(),delete this._controllers[e])}}eu.Name=si.PHYSICS_CONTROLLERS;eu.Version=1;dr.AddWebXRFeature(eu.Name,(o,e)=>()=>new eu(o,e),eu.Version,!0);class tu extends Gs{constructor(e,t={}){super(e),this.options=t,this._tmpMat=new H,this._tmpPos=new x,this._tmpQuat=new oe,this._initHitTestSource=i=>{if(!i)return;const r=new XRRay(this.options.offsetRay||{}),s={space:this.options.useReferenceSpace?i:this._xrSessionManager.viewerReferenceSpace,offsetRay:r};if(this.options.entityTypes&&(s.entityTypes=this.options.entityTypes),!s.space){J.Warn("waiting for viewer reference space to initialize");return}this._xrSessionManager.session.requestHitTestSource(s).then(n=>{this._xrHitTestSource&&this._xrHitTestSource.cancel(),this._xrHitTestSource=n})},this.autoCloneTransformation=!1,this.onHitTestResultObservable=new Q,this.paused=!1,this.xrNativeFeatureName="hit-test",J.Warn("Hit test is an experimental and unstable feature.")}attach(){if(!super.attach()||!this._xrSessionManager.session.requestHitTestSource)return!1;if(this.options.disablePermanentHitTest||(this._xrSessionManager.referenceSpace&&this._initHitTestSource(this._xrSessionManager.referenceSpace),this._xrSessionManager.onXRReferenceSpaceChanged.add(this._initHitTestSource)),this.options.enableTransientHitTest){const e=new XRRay(this.options.transientOffsetRay||{});this._xrSessionManager.session.requestHitTestSourceForTransientInput({profile:this.options.transientHitTestProfile||"generic-touchscreen",offsetRay:e,entityTypes:this.options.entityTypes}).then(t=>{this._transientXrHitTestSource=t})}return!0}detach(){return super.detach()?(this._xrHitTestSource&&(this._xrHitTestSource.cancel(),this._xrHitTestSource=null),this._xrSessionManager.onXRReferenceSpaceChanged.removeCallback(this._initHitTestSource),this._transientXrHitTestSource&&(this._transientXrHitTestSource.cancel(),this._transientXrHitTestSource=null),!0):!1}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(!(!this.attached||this.paused)){if(this._xrHitTestSource){const t=e.getHitTestResults(this._xrHitTestSource);this._processWebXRHitTestResult(t)}this._transientXrHitTestSource&&e.getHitTestResultsForTransientInput(this._transientXrHitTestSource).forEach(i=>{this._processWebXRHitTestResult(i.results,i.inputSource)})}}_processWebXRHitTestResult(e,t){const i=[];e.forEach(r=>{const s=r.getPose(this._xrSessionManager.referenceSpace);if(!s)return;const n=s.transform.position,a=s.transform.orientation;this._tmpPos.set(n.x,n.y,n.z),this._tmpQuat.set(a.x,a.y,a.z,a.w),H.FromFloat32ArrayToRefScaled(s.transform.matrix,0,1,this._tmpMat),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpPos.z*=-1,this._tmpQuat.z*=-1,this._tmpQuat.w*=-1,this._tmpMat.toggleModelMatrixHandInPlace());const l={position:this.autoCloneTransformation?this._tmpPos.clone():this._tmpPos,rotationQuaternion:this.autoCloneTransformation?this._tmpQuat.clone():this._tmpQuat,transformationMatrix:this.autoCloneTransformation?this._tmpMat.clone():this._tmpMat,inputSource:t,isTransient:!!t,xrHitResult:r};i.push(l)}),this.onHitTestResultObservable.notifyObservers(i)}}tu.Name=si.HIT_TEST;tu.Version=2;dr.AddWebXRFeature(tu.Name,(o,e)=>()=>new tu(o,e),tu.Version,!1);class iu extends Gs{get featurePointCloud(){return this._featurePointCloud}constructor(e){super(e),this._enabled=!1,this._featurePointCloud=[],this.onFeaturePointsAddedObservable=new Q,this.onFeaturePointsUpdatedObservable=new Q,this.xrNativeFeatureName="bjsfeature-points",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){return super.detach()?(this.featurePointCloud.length=0,!0):!1}dispose(){super.dispose(),this._featurePointCloud.length=0,this.onFeaturePointsUpdatedObservable.clear(),this.onFeaturePointsAddedObservable.clear()}_onXRFrame(e){if(!this.attached||!this._enabled||!e)return;const t=e.featurePointCloud;if(!(!t||t.length===0)){if(t.length%5!==0)throw new Error("Received malformed feature point cloud of length: "+t.length);const i=t.length/5,r=new Array,s=new Array;for(let n=0;n<i;n++){const a=n*5,l=t[a+4];this._featurePointCloud[l]?r.push(l):(this._featurePointCloud[l]={position:new x,confidenceValue:0},s.push(l)),this._featurePointCloud[l].position.x=t[a],this._featurePointCloud[l].position.y=t[a+1],this._featurePointCloud[l].position.z=t[a+2],this._featurePointCloud[l].confidenceValue=t[a+3]}s.length>0&&this.onFeaturePointsAddedObservable.notifyObservers(s),r.length>0&&this.onFeaturePointsUpdatedObservable.notifyObservers(r)}}_init(){!this._xrSessionManager.session.trySetFeaturePointCloudEnabled||!this._xrSessionManager.session.trySetFeaturePointCloudEnabled(!0)||(this._enabled=!0)}}iu.Name=si.FEATURE_POINTS;iu.Version=1;dr.AddWebXRFeature(iu.Name,o=>()=>new iu(o),iu.Version);let mB=0;class ru extends Gs{constructor(e,t={}){super(e),this._options=t,this._detectedMeshes=new Map,this.onMeshAddedObservable=new Q,this.onMeshRemovedObservable=new Q,this.onMeshUpdatedObservable=new Q,this.xrNativeFeatureName="mesh-detection",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){return super.detach()?(this._xrSessionManager.isNative&&this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!1),this._options.doNotRemoveMeshesOnSessionEnded||(this._detectedMeshes.forEach(e=>{this.onMeshRemovedObservable.notifyObservers(e)}),this._detectedMeshes.clear()),!0):!1}dispose(){super.dispose(),this.onMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onMeshUpdatedObservable.clear()}_onXRFrame(e){var t;try{if(!this.attached||!e)return;const i=(t=e.worldInformation)===null||t===void 0?void 0:t.detectedMeshes;if(i){const r=new Set;this._detectedMeshes.forEach((s,n)=>{i.has(n)||r.add(n)}),r.forEach(s=>{const n=this._detectedMeshes.get(s);n&&(this.onMeshRemovedObservable.notifyObservers(n),this._detectedMeshes.delete(s))}),i.forEach(s=>{if(this._detectedMeshes.has(s)){if(s.lastChangedTime===this._xrSessionManager.currentTimestamp){const n=this._detectedMeshes.get(s);n&&(this._updateVertexDataWithXRMesh(s,n,e),this.onMeshUpdatedObservable.notifyObservers(n))}}else{const n={id:mB++,xrMesh:s},a=this._updateVertexDataWithXRMesh(s,n,e);this._detectedMeshes.set(s,a),this.onMeshAddedObservable.notifyObservers(a)}})}}catch(i){console.log(i.stack)}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!0),this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions(this._options.preferredDetectorOptions))}_updateVertexDataWithXRMesh(e,t,i){if(t.xrMesh=e,t.worldParentNode=this._options.worldParentNode,this._options.convertCoordinateSystems){if(this._xrSessionManager.scene.useRightHandedSystem)t.positions=e.positions,t.normals=e.normals;else{t.positions=new Float32Array(e.positions.length);for(let s=0;s<e.positions.length;s+=3)t.positions[s]=e.positions[s],t.positions[s+1]=e.positions[s+1],t.positions[s+2]=-1*e.positions[s+2];if(e.normals){t.normals=new Float32Array(e.normals.length);for(let s=0;s<e.normals.length;s+=3)t.normals[s]=e.normals[s],t.normals[s+1]=e.normals[s+1],t.normals[s+2]=-1*e.normals[s+2]}}t.indices=e.indices;const r=i.getPose(e.meshSpace,this._xrSessionManager.referenceSpace);if(r){const s=t.transformationMatrix||new H;H.FromArrayToRef(r.transform.matrix,0,s),this._xrSessionManager.scene.useRightHandedSystem||s.toggleModelMatrixHandInPlace(),t.transformationMatrix=s,this._options.worldParentNode&&s.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),s)}}return t}}ru.Name=si.MESH_DETECTION;ru.Version=1;dr.AddWebXRFeature(ru.Name,(o,e)=>()=>new ru(o,e),ru.Version,!1);var no;(function(o){o[o.NotReceived=0]="NotReceived",o[o.Waiting=1]="Waiting",o[o.Received=2]="Received"})(no||(no={}));class su extends Gs{constructor(e,t){super(e),this.options=t,this.onUntrackableImageFoundObservable=new Q,this.onTrackableImageFoundObservable=new Q,this.onTrackedImageUpdatedObservable=new Q,this._trackableScoreStatus=no.NotReceived,this._trackedImages=[],this.xrNativeFeatureName="image-tracking"}attach(){return super.attach()}detach(){return super.detach()}getTrackedImageById(e){return this._trackedImages[e]||null}dispose(){super.dispose(),this._trackedImages.forEach(e=>{e.originalBitmap.close()}),this._trackedImages.length=0,this.onTrackableImageFoundObservable.clear(),this.onUntrackableImageFoundObservable.clear(),this.onTrackedImageUpdatedObservable.clear()}async getXRSessionInitExtension(){if(!this.options.images||!this.options.images.length)return{};const e=this.options.images.map(t=>typeof t.src=="string"?this._xrSessionManager.scene.getEngine()._createImageBitmapFromSource(t.src):Promise.resolve(t.src));try{const t=await Promise.all(e);return this._originalTrackingRequest=t.map((i,r)=>({image:i,widthInMeters:this.options.images[r].estimatedRealWorldWidth})),{trackedImages:this._originalTrackingRequest}}catch{return J.Error("Error loading images for tracking, WebXRImageTracking disabled for this session."),{}}}_onXRFrame(e){if(!e.getImageTrackingResults||this._trackableScoreStatus===no.Waiting)return;if(this._trackableScoreStatus===no.NotReceived){this._checkScoresAsync();return}const t=e.getImageTrackingResults();for(const i of t){let r=!1;const s=i.index,n=this._trackedImages[s];if(!n)continue;n.xrTrackingResult=i,n.realWorldWidth!==i.measuredWidthInMeters&&(n.realWorldWidth=i.measuredWidthInMeters,r=!0);const a=e.getPose(i.imageSpace,this._xrSessionManager.referenceSpace);if(a){const h=n.transformationMatrix;H.FromArrayToRef(a.transform.matrix,0,h),this._xrSessionManager.scene.useRightHandedSystem||h.toggleModelMatrixHandInPlace(),r=!0}const c=i.trackingState==="emulated";n.emulated!==c&&(n.emulated=c,r=!0),r&&this.onTrackedImageUpdatedObservable.notifyObservers(n)}}async _checkScoresAsync(){if(!this._xrSessionManager.session.getTrackedImageScores||this._trackableScoreStatus!==no.NotReceived)return;this._trackableScoreStatus=no.Waiting;const e=await this._xrSessionManager.session.getTrackedImageScores();if(!e||e.length===0){this._trackableScoreStatus=no.NotReceived;return}for(let t=0;t<e.length;++t)if(e[t]=="untrackable")this.onUntrackableImageFoundObservable.notifyObservers(t);else{const i=this._originalTrackingRequest[t].image,r={id:t,originalBitmap:i,transformationMatrix:new H,ratio:i.width/i.height};this._trackedImages[t]=r,this.onTrackableImageFoundObservable.notifyObservers(r)}this._trackableScoreStatus=e.length>0?no.Received:no.NotReceived}}su.Name=si.IMAGE_TRACKING;su.Version=1;dr.AddWebXRFeature(su.Name,(o,e)=>()=>new su(o,e),su.Version,!1);class nu extends Gs{constructor(e,t){super(e),this.options=t,this._domOverlayType=null,this._beforeXRSelectListener=null,this._element=null,this.xrNativeFeatureName="dom-overlay",J.Warn("dom-overlay is an experimental and unstable feature.")}attach(){return!super.attach()||!this._xrSessionManager.session.domOverlayState||this._xrSessionManager.session.domOverlayState.type===null?!1:(this._domOverlayType=this._xrSessionManager.session.domOverlayState.type,this._element!==null&&this.options.supressXRSelectEvents===!0&&(this._beforeXRSelectListener=e=>{e.preventDefault()},this._element.addEventListener("beforexrselect",this._beforeXRSelectListener)),!0)}get domOverlayType(){return this._domOverlayType}dispose(){super.dispose(),this._element!==null&&this._beforeXRSelectListener&&this._element.removeEventListener("beforexrselect",this._beforeXRSelectListener)}_onXRFrame(e){}async getXRSessionInitExtension(){if(this.options.element===void 0)return J.Warn('"element" option must be provided to attach xr-dom-overlay feature.'),{};if(typeof this.options.element=="string"){const e=document.querySelector(this.options.element);if(e===null)return J.Warn(`element not found '${this.options.element}' (not requesting xr-dom-overlay)`),{};this._element=e}else this._element=this.options.element;return{domOverlay:{root:this._element}}}}nu.Name=si.DOM_OVERLAY;nu.Version=1;dr.AddWebXRFeature(nu.Name,(o,e)=>()=>new nu(o,e),nu.Version,!1);class Al extends Gs{get movementDirection(){return this._movementDirection}get movementEnabled(){return this._featureContext.movementEnabled}set movementEnabled(e){this._featureContext.movementEnabled=e}get movementOrientationFollowsViewerPose(){return this._featureContext.movementOrientationFollowsViewerPose}set movementOrientationFollowsViewerPose(e){this._featureContext.movementOrientationFollowsViewerPose=e}get movementSpeed(){return this._featureContext.movementSpeed}set movementSpeed(e){this._featureContext.movementSpeed=e}get movementThreshold(){return this._featureContext.movementThreshold}set movementThreshold(e){this._featureContext.movementThreshold=e}get rotationEnabled(){return this._featureContext.rotationEnabled}set rotationEnabled(e){this._featureContext.rotationEnabled=e}get rotationSpeed(){return this._featureContext.rotationSpeed}set rotationSpeed(e){this._featureContext.rotationSpeed=e}get rotationThreshold(){return this._featureContext.rotationThreshold}set rotationThreshold(e){this._featureContext.rotationThreshold=e}constructor(e,t){var i,r,s,n,a,l;if(super(e),this._controllers={},this._currentRegistrationConfigurations=[],this._movementDirection=null,this._tmpRotationMatrix=H.Identity(),this._tmpTranslationDirection=new x,this._tmpMovementTranslation=new x,this._attachController=c=>{if(this._controllers[c.uniqueId])return;this._controllers[c.uniqueId]={xrController:c,registeredComponents:[]};const h=this._controllers[c.uniqueId];if(h.xrController.inputSource.targetRayMode==="tracked-pointer"&&h.xrController.inputSource.gamepad){const u=()=>{if(c.motionController)for(const d of this._currentRegistrationConfigurations){let f=null;if(d.allowedComponentTypes)for(const p of d.allowedComponentTypes){const m=c.motionController.getComponentOfType(p);if(m!==null){f=m;break}}if(d.mainComponentOnly){const p=c.motionController.getMainComponent();if(p===null)continue;f=p}if(typeof d.componentSelectionPredicate=="function"&&(f=d.componentSelectionPredicate(c)),f&&d.forceHandedness&&c.inputSource.handedness!==d.forceHandedness||f===null)continue;const _={registrationConfiguration:d,component:f};h.registeredComponents.push(_),"axisChangedHandler"in d&&(_.onAxisChangedObserver=f.onAxisValueChangedObservable.add(p=>{d.axisChangedHandler(p,this._movementState,this._featureContext,this._xrInput)})),"buttonChangedhandler"in d&&(_.onButtonChangedObserver=f.onButtonStateChangedObservable.add(()=>{f.changes.pressed&&d.buttonChangedhandler(f.changes.pressed,this._movementState,this._featureContext,this._xrInput)}))}};c.motionController?u():c.onMotionControllerInitObservable.addOnce(()=>{u()})}},!t||t.xrInput===void 0){J.Error('WebXRControllerMovement feature requires "xrInput" option.');return}Array.isArray(t.customRegistrationConfigurations)?this._currentRegistrationConfigurations=t.customRegistrationConfigurations:this._currentRegistrationConfigurations=Al.REGISTRATIONS.default,this._featureContext={movementEnabled:t.movementEnabled||!0,movementOrientationFollowsViewerPose:(i=t.movementOrientationFollowsViewerPose)!==null&&i!==void 0?i:!0,movementSpeed:(r=t.movementSpeed)!==null&&r!==void 0?r:1,movementThreshold:(s=t.movementThreshold)!==null&&s!==void 0?s:.25,rotationEnabled:(n=t.rotationEnabled)!==null&&n!==void 0?n:!0,rotationSpeed:(a=t.rotationSpeed)!==null&&a!==void 0?a:1,rotationThreshold:(l=t.rotationThreshold)!==null&&l!==void 0?l:.25},this._movementState={moveX:0,moveY:0,rotateX:0,rotateY:0},this._xrInput=t.xrInput}attach(){return super.attach()?(this._xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0):!1}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._controllers={},!0):!1}_onXRFrame(e){if(this.attach){if(this._movementDirection===null&&(this._movementDirection=this._xrInput.xrCamera.rotationQuaternion.clone()),this._movementState.rotateX!==0&&this._featureContext.rotationEnabled){const i=this._xrSessionManager.scene.getEngine().getDeltaTime()*.001*this._featureContext.rotationSpeed*this._movementState.rotateX*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);this._featureContext.movementOrientationFollowsViewerPose===!0?(this._xrInput.xrCamera.cameraRotation.y+=i,this._movementDirection=this._xrInput.xrCamera.rotationQuaternion.multiply(oe.RotationYawPitchRoll(i,0,0))):this._movementDirection.multiplyInPlace(oe.RotationYawPitchRoll(i*3,0,0))}else this._featureContext.movementOrientationFollowsViewerPose===!0&&this._movementDirection.copyFrom(this._xrInput.xrCamera.rotationQuaternion);(this._movementState.moveX!==0||this._movementState.moveY!==0)&&this._featureContext.movementEnabled&&(H.FromQuaternionToRef(this._movementDirection,this._tmpRotationMatrix),this._tmpTranslationDirection.set(this._movementState.moveX,0,this._movementState.moveY*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),x.TransformCoordinatesToRef(this._tmpTranslationDirection,this._tmpRotationMatrix,this._tmpMovementTranslation),this._tmpMovementTranslation.scaleInPlace(this._xrInput.xrCamera._computeLocalCameraSpeed()*this._featureContext.movementSpeed),this._xrInput.xrCamera.cameraDirection.addInPlace(this._tmpMovementTranslation))}}_detachController(e){const t=this._controllers[e];if(t){for(const i of t.registeredComponents)i.onAxisChangedObserver&&i.component.onAxisValueChangedObservable.remove(i.onAxisChangedObserver),i.onButtonChangedObserver&&i.component.onButtonStateChangedObservable.remove(i.onButtonChangedObserver);delete this._controllers[e]}}}Al.Name=si.MOVEMENT;Al.REGISTRATIONS={default:[{allowedComponentTypes:[qn.THUMBSTICK_TYPE,qn.TOUCHPAD_TYPE],forceHandedness:"left",axisChangedHandler:(o,e,t)=>{e.rotateX=Math.abs(o.x)>t.rotationThreshold?o.x:0,e.rotateY=Math.abs(o.y)>t.rotationThreshold?o.y:0}},{allowedComponentTypes:[qn.THUMBSTICK_TYPE,qn.TOUCHPAD_TYPE],forceHandedness:"right",axisChangedHandler:(o,e,t)=>{e.moveX=Math.abs(o.x)>t.movementThreshold?o.x:0,e.moveY=Math.abs(o.y)>t.movementThreshold?o.y:0}}]};Al.Version=1;dr.AddWebXRFeature(Al.Name,(o,e)=>()=>new Al(o,e),Al.Version,!0);class au extends Gs{constructor(e,t){super(e),this.options=t,this._canvasContext=null,this._reflectionCubeMap=null,this._xrLightEstimate=null,this._xrLightProbe=null,this._xrWebGLBinding=null,this._lightDirection=x.Up().negateInPlace(),this._lightColor=ge.White(),this._intensity=1,this._sphericalHarmonics=new dc,this._cubeMapPollTime=Date.now(),this._lightEstimationPollTime=Date.now(),this._reflectionCubeMapTextureSize=16,this.directionalLight=null,this.onReflectionCubeMapUpdatedObservable=new Q,this._updateReflectionCubeMap=()=>{var i;if(!this._xrLightProbe)return;if(this.options.cubeMapPollInterval){const s=Date.now();if(s-this._cubeMapPollTime<this.options.cubeMapPollInterval)return;this._cubeMapPollTime=s}const r=this._getXRGLBinding().getReflectionCubeMap(this._xrLightProbe);if(r&&this._reflectionCubeMap){if(this._reflectionCubeMap._texture)(i=this._reflectionCubeMap._texture._hardwareTexture)===null||i===void 0||i.set(r),this._reflectionCubeMap._texture.getEngine().resetTextureCache();else{const s=new hi(this._xrSessionManager.scene.getEngine(),bt.Unknown);s.isCube=!0,s.invertY=!1,s._useSRGBBuffer=this.options.reflectionFormat==="srgba8",s.format=5,s.generateMipMaps=!0,s.type=this.options.reflectionFormat!=="srgba8"?2:0,s.samplingMode=3,s.width=this._reflectionCubeMapTextureSize,s.height=this._reflectionCubeMapTextureSize,s._cachedWrapU=1,s._cachedWrapV=1,s._hardwareTexture=new hf(r,this._getCanvasContext()),this._reflectionCubeMap._texture=s}this._reflectionCubeMap._texture.isReady=!0,this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap)}},this.xrNativeFeatureName="light-estimation",this.options.createDirectionalLightSource&&(this.directionalLight=new Bn("light estimation directional",this._lightDirection,this._xrSessionManager.scene),this.directionalLight.position=new x(0,8,0),this.directionalLight.intensity=0,this.directionalLight.falloffType=fi.FALLOFF_GLTF),J.Warn("light-estimation is an experimental and unstable feature.")}get reflectionCubeMapTexture(){return this._reflectionCubeMap}get xrLightingEstimate(){return this._xrLightEstimate?{lightColor:this._lightColor,lightDirection:this._lightDirection,lightIntensity:this._intensity,sphericalHarmonics:this._sphericalHarmonics}:this._xrLightEstimate}_getCanvasContext(){return this._canvasContext===null&&(this._canvasContext=this._xrSessionManager.scene.getEngine()._gl),this._canvasContext}_getXRGLBinding(){if(this._xrWebGLBinding===null){const e=this._getCanvasContext();this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,e)}return this._xrWebGLBinding}attach(){var e;if(!super.attach())return!1;const t=(e=this.options.reflectionFormat)!==null&&e!==void 0?e:this._xrSessionManager.session.preferredReflectionFormat||"srgba8";return this.options.reflectionFormat=t,this._xrSessionManager.session.requestLightProbe({reflectionFormat:t}).then(i=>{this._xrLightProbe=i,this.options.disableCubeMapReflection||(this._reflectionCubeMap||(this._reflectionCubeMap=new ni(this._xrSessionManager.scene),this._reflectionCubeMap._isCube=!0,this._reflectionCubeMap.coordinatesMode=3,this.options.setSceneEnvironmentTexture&&(this._xrSessionManager.scene.environmentTexture=this._reflectionCubeMap)),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap))}),!0}detach(){const e=super.detach();return this._xrLightProbe!==null&&!this.options.disableCubeMapReflection&&(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._xrLightProbe=null),this._canvasContext=null,this._xrLightEstimate=null,this._xrWebGLBinding=null,e}dispose(){super.dispose(),this.onReflectionCubeMapUpdatedObservable.clear(),this.directionalLight&&(this.directionalLight.dispose(),this.directionalLight=null),this._reflectionCubeMap!==null&&(this._reflectionCubeMap._texture&&this._reflectionCubeMap._texture.dispose(),this._reflectionCubeMap.dispose(),this._reflectionCubeMap=null)}_onXRFrame(e){var t;if(this._xrLightProbe!==null){if(this.options.lightEstimationPollInterval){const i=Date.now();if(i-this._lightEstimationPollTime<this.options.lightEstimationPollInterval)return;this._lightEstimationPollTime=i}if(this._xrLightEstimate=e.getLightEstimate(this._xrLightProbe),this._xrLightEstimate){this._intensity=Math.max(1,this._xrLightEstimate.primaryLightIntensity.x,this._xrLightEstimate.primaryLightIntensity.y,this._xrLightEstimate.primaryLightIntensity.z);const i=this._xrSessionManager.scene.useRightHandedSystem?1:-1;this.options.disableVectorReuse&&(this._lightDirection=new x,this._lightColor=new ge,this.directionalLight&&(this.directionalLight.direction=this._lightDirection,this.directionalLight.diffuse=this._lightColor)),this._lightDirection.copyFromFloats(this._xrLightEstimate.primaryLightDirection.x,this._xrLightEstimate.primaryLightDirection.y,this._xrLightEstimate.primaryLightDirection.z*i),this._lightColor.copyFromFloats(this._xrLightEstimate.primaryLightIntensity.x/this._intensity,this._xrLightEstimate.primaryLightIntensity.y/this._intensity,this._xrLightEstimate.primaryLightIntensity.z/this._intensity),this._sphericalHarmonics.updateFromFloatsArray(this._xrLightEstimate.sphericalHarmonicsCoefficients),this._reflectionCubeMap&&!this.options.disableSphericalPolynomial&&(this._reflectionCubeMap.sphericalPolynomial=this._reflectionCubeMap.sphericalPolynomial||new Ko,(t=this._reflectionCubeMap.sphericalPolynomial)===null||t===void 0||t.updateFromHarmonics(this._sphericalHarmonics)),this._lightDirection.negateInPlace(),this.directionalLight&&(this.directionalLight.direction.copyFrom(this._lightDirection),this.directionalLight.intensity=Math.min(this._intensity,1),this.directionalLight.diffuse.copyFrom(this._lightColor))}}}}au.Name=si.LIGHT_ESTIMATION;au.Version=1;dr.AddWebXRFeature(au.Name,(o,e)=>()=>new au(o,e),au.Version,!1);class ou extends Gs{constructor(e){super(e),this.onEyeTrackingStartedObservable=new Q,this.onEyeTrackingEndedObservable=new Q,this.onEyeTrackingFrameUpdateObservable=new Q,this._eyeTrackingStartListener=t=>{this._latestEyeSpace=t.gazeSpace,this._gazeRay=new Pt(x.Zero(),x.Forward()),this.onEyeTrackingStartedObservable.notifyObservers(this._gazeRay)},this._eyeTrackingEndListener=()=>{this._latestEyeSpace=null,this._gazeRay=null,this.onEyeTrackingEndedObservable.notifyObservers()},this.xrNativeFeatureName="eye-tracking",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}dispose(){super.dispose(),this._xrSessionManager.session.removeEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.removeEventListener("eyetrackingend",this._eyeTrackingEndListener),this.onEyeTrackingStartedObservable.clear(),this.onEyeTrackingEndedObservable.clear(),this.onEyeTrackingFrameUpdateObservable.clear()}get isEyeGazeValid(){return!!this._gazeRay}getEyeGaze(){return this._gazeRay}_onXRFrame(e){if(!(!this.attached||!e)&&this._latestEyeSpace&&this._gazeRay){const t=e.getPose(this._latestEyeSpace,this._xrSessionManager.referenceSpace);if(t){this._gazeRay.origin.set(t.transform.position.x,t.transform.position.y,t.transform.position.z);const i=t.transform.orientation;j.Quaternion[0].set(i.x,i.y,i.z,i.w),this._xrSessionManager.scene.useRightHandedSystem?x.RightHandedForwardReadOnly.rotateByQuaternionToRef(j.Quaternion[0],this._gazeRay.direction):(this._gazeRay.origin.z*=-1,j.Quaternion[0].z*=-1,j.Quaternion[0].w*=-1,x.LeftHandedForwardReadOnly.rotateByQuaternionToRef(j.Quaternion[0],this._gazeRay.direction)),this.onEyeTrackingFrameUpdateObservable.notifyObservers(this._gazeRay)}}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.addEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.addEventListener("eyetrackingend",this._eyeTrackingEndListener))}}ou.Name=si.EYE_TRACKING;ou.Version=1;dr.AddWebXRFeature(ou.Name,o=>()=>new ou(o),ou.Version,!1);class gB{constructor(e,t){this._samples=[],this._idx=0;for(let i=0;i<e;++i)this._samples.push(t?t():Ie.Zero())}get length(){return this._samples.length}push(e,t){this._idx=(this._idx+this._samples.length-1)%this._samples.length,this.at(0).copyFromFloats(e,t)}at(e){if(e>=this._samples.length)throw new Error("Index out of bounds");return this._samples[(this._idx+e)%this._samples.length]}}class vB{constructor(){this._samples=new gB(20),this._entropy=0,this.onFirstStepDetected=new Q}update(e,t,i,r){this._samples.push(e,t);const s=this._samples.at(0);if(this._entropy*=this._entropyDecayFactor,this._entropy+=Ie.Distance(s,this._samples.at(1)),this._entropy>this._entropyThreshold)return;let n;for(n=this._samePointCheckStartIdx;n<this._samples.length&&!(Ie.DistanceSquared(s,this._samples.at(n))<this._samePointSquaredDistanceThreshold);++n);if(n===this._samples.length)return;let a=-1,l=0;for(let S,C=1;C<n;++C)S=Ie.DistanceSquared(s,this._samples.at(C)),S>a&&(l=C,a=S);if(a<this._apexSquaredDistanceThreshold)return;const c=this._samples.at(l),h=c.subtract(s);h.normalize();const u=j.Vector2[0];let d,f,_=0;for(let S=1;S<n;++S)f=this._samples.at(S),f.subtractToRef(s,u),d=Ie.Dot(h,u),_+=u.lengthSquared()-d*d;if(_>n*this._squaredProjectionDistanceThreshold)return;const p=j.Vector3[0];p.set(i,r,0);const m=j.Vector3[1];m.set(h.x,h.y,0);const T=x.Cross(p,m).z>0,b=s.clone(),y=s.clone();c.subtractToRef(s,h),T?(h.scaleAndAddToRef(this._axisToApexShrinkFactor,b),h.scaleAndAddToRef(this._axisToApexExtendFactor,y)):(h.scaleAndAddToRef(this._axisToApexExtendFactor,b),h.scaleAndAddToRef(this._axisToApexShrinkFactor,y)),this.onFirstStepDetected.notifyObservers({leftApex:b,rightApex:y,currentPosition:s,currentStepDirection:T?"right":"left"})}reset(){for(let e=0;e<this._samples.length;++e)this._samples.at(e).copyFromFloats(0,0)}get _samePointCheckStartIdx(){return Math.floor(this._samples.length/3)}get _samePointSquaredDistanceThreshold(){return .03*.03}get _apexSquaredDistanceThreshold(){return .09*.09}get _squaredProjectionDistanceThreshold(){return .03*.03}get _axisToApexShrinkFactor(){return .8}get _axisToApexExtendFactor(){return-1.6}get _entropyDecayFactor(){return .93}get _entropyThreshold(){return .4}}class xB{constructor(e,t,i,r){this._leftApex=new Ie,this._rightApex=new Ie,this._currentPosition=new Ie,this._axis=new Ie,this._axisLength=-1,this._forward=new Ie,this._steppingLeft=!1,this._t=-1,this._maxT=-1,this._maxTPosition=new Ie,this._vitality=0,this.onMovement=new Q,this.onFootfall=new Q,this._reset(e,t,i,r==="left")}_reset(e,t,i,r){this._leftApex.copyFrom(e),this._rightApex.copyFrom(t),this._steppingLeft=r,this._steppingLeft?(this._leftApex.subtractToRef(this._rightApex,this._axis),this._forward.copyFromFloats(-this._axis.y,this._axis.x)):(this._rightApex.subtractToRef(this._leftApex,this._axis),this._forward.copyFromFloats(this._axis.y,-this._axis.x)),this._axisLength=this._axis.length(),this._forward.scaleInPlace(1/this._axisLength),this._updateTAndVitality(i.x,i.y),this._maxT=this._t,this._maxTPosition.copyFrom(i),this._vitality=1}_updateTAndVitality(e,t){this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._currentPosition.subtractInPlace(this._rightApex):this._currentPosition.subtractInPlace(this._leftApex);const i=this._t,r=Ie.Dot(this._currentPosition,this._axis);this._t=r/(this._axisLength*this._axisLength);const s=this._currentPosition.lengthSquared()-r/this._axisLength*(r/this._axisLength);this._vitality*=.92-100*Math.max(s-.0016,0)+Math.max(this._t-i,0)}update(e,t){if(this._vitality<this._vitalityThreshold)return!1;const i=this._t;return this._updateTAndVitality(e,t),this._t>this._maxT&&(this._maxT=this._t,this._maxTPosition.copyFromFloats(e,t)),!(this._vitality<this._vitalityThreshold||(this._t>i&&(this.onMovement.notifyObservers({deltaT:this._t-i}),i<.5&&this._t>=.5&&this.onFootfall.notifyObservers({foot:this._steppingLeft?"left":"right"})),this._t<.95*this._maxT&&(this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._leftApex.copyFrom(this._maxTPosition):this._rightApex.copyFrom(this._maxTPosition),this._reset(this._leftApex,this._rightApex,this._currentPosition,!this._steppingLeft)),this._axisLength<.03))}get _vitalityThreshold(){return .1}get forward(){return this._forward}}class lu{static get _MillisecondsPerUpdate(){return 1e3/15}constructor(e){this._detector=new vB,this._walker=null,this._movement=new Ie,this._millisecondsSinceLastUpdate=lu._MillisecondsPerUpdate,this.movementThisFrame=x.Zero(),this._engine=e,this._detector.onFirstStepDetected.add(t=>{this._walker||(this._walker=new xB(t.leftApex,t.rightApex,t.currentPosition,t.currentStepDirection),this._walker.onFootfall.add(()=>{console.log("Footfall!")}),this._walker.onMovement.add(i=>{this._walker.forward.scaleAndAddToRef(.024*i.deltaT,this._movement)}))})}update(e,t){t.y=0,t.normalize(),this._millisecondsSinceLastUpdate+=this._engine.getDeltaTime(),this._millisecondsSinceLastUpdate>=lu._MillisecondsPerUpdate&&(this._millisecondsSinceLastUpdate-=lu._MillisecondsPerUpdate,this._detector.update(e.x,e.z,t.x,t.z),this._walker&&(this._walker.update(e.x,e.z)||(this._walker=null)),this._movement.scaleInPlace(.85)),this.movementThisFrame.set(this._movement.x,0,this._movement.y)}}class F_ extends Gs{static get Name(){return si.WALKING_LOCOMOTION}static get Version(){return 1}get locomotionTarget(){return this._locomotionTarget}set locomotionTarget(e){this._locomotionTarget=e,this._isLocomotionTargetWebXRCamera=this._locomotionTarget.getClassName()==="WebXRCamera"}constructor(e,t){super(e),this._up=new x,this._forward=new x,this._position=new x,this._movement=new x,this._sessionManager=e,this.locomotionTarget=t.locomotionTarget,this._isLocomotionTargetWebXRCamera&&X.Warn("Using walking locomotion directly on a WebXRCamera may have unintended interactions with other XR techniques. Using an XR space parent is highly recommended")}isCompatible(){return this._sessionManager.sessionMode===void 0||this._sessionManager.sessionMode==="immersive-vr"}attach(){return!this.isCompatible||!super.attach()?!1:(this._walker=new lu(this._sessionManager.scene.getEngine()),!0)}detach(){return super.detach()?(this._walker=null,!0):!1}_onXRFrame(e){const t=e.getViewerPose(this._sessionManager.baseReferenceSpace);if(!t)return;const i=this.locomotionTarget.getScene().useRightHandedSystem?1:-1,r=t.transform.matrix;this._up.copyFromFloats(r[4],r[5],i*r[6]),this._forward.copyFromFloats(r[8],r[9],i*r[10]),this._position.copyFromFloats(r[12],r[13],i*r[14]),this._forward.scaleAndAddToRef(.05,this._position),this._up.scaleAndAddToRef(-.05,this._position),this._walker.update(this._position,this._forward),this._movement.copyFrom(this._walker.movementThisFrame),this._isLocomotionTargetWebXRCamera||x.TransformNormalToRef(this._movement,this.locomotionTarget.getWorldMatrix(),this._movement),this.locomotionTarget.position.addInPlace(this._movement)}}dr.AddWebXRFeature(F_.Name,(o,e)=>()=>new F_(o,e),F_.Version,!1);class TB extends gm{constructor(e,t,i,r,s,n){super(e,t,i,r,n),this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this.isMultiview=s,this.createRTTProvider=n}}class EB extends vm{constructor(e,t,i){super(e.scene,i),this._xrSessionManager=e,this._xrWebGLBinding=t,this.layerWrapper=i,this._lastSubImages=new Map,this._compositionLayer=i.layer}_getRenderTargetForSubImage(e,t){const i=this._lastSubImages.get(t),r=t=="left"?0:1;return(!this._renderTargetTextures[r]||(i==null?void 0:i.textureWidth)!==e.textureWidth||(i==null?void 0:i.textureHeight)!=e.textureHeight)&&(this._renderTargetTextures[r]=this._createRenderTargetTexture(e.textureWidth,e.textureHeight,null,e.colorTexture,e.depthStencilTexture,this.layerWrapper.isMultiview),this._framebufferDimensions={framebufferWidth:e.textureWidth,framebufferHeight:e.textureHeight}),this._lastSubImages.set(t,e),this._renderTargetTextures[r]}_getSubImageForEye(e){const t=this._xrSessionManager.currentFrame;return t?this._xrWebGLBinding.getSubImage(this._compositionLayer,t,e):null}getRenderTargetTextureForEye(e){const t=this._getSubImageForEye(e);return t?this._getRenderTargetForSubImage(t,e):null}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}_setViewportForSubImage(e,t){const i=t.textureWidth,r=t.textureHeight,s=t.viewport;e.x=s.x/i,e.y=s.y/r,e.width=s.width/i,e.height=s.height/r}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForEye(t.eye);return i?(this._setViewportForSubImage(e,i),!0):!1}}class bB extends TB{constructor(e,t,i){super(()=>e.textureWidth,()=>e.textureHeight,e,"XRProjectionLayer",t,r=>new SB(r,i,this)),this.layer=e}}class SB extends EB{constructor(e,t,i){super(e,t,i),this.layerWrapper=i,this._projectionLayer=i.layer}_getSubImageForView(e){return this._xrWebGLBinding.getViewSubImage(this._projectionLayer,e)}getRenderTargetTextureForView(e){return this._getRenderTargetForSubImage(this._getSubImageForView(e),e.eye)}getRenderTargetTextureForEye(e){const t=this._lastSubImages.get(e);return t?this._getRenderTargetForSubImage(t,e):null}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForView(t);return i?(this._setViewportForSubImage(e,i),!0):!1}}const yB={},Ox={textureType:"texture",colorFormat:6408,depthFormat:35056,scaleFactor:1};class cu extends Gs{constructor(e,t={}){super(e),this._options=t,this._existingLayers=[],this.xrNativeFeatureName="layers"}attach(){if(!super.attach())return!1;const e=this._xrSessionManager.scene.getEngine();this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this._existingLayers.length=0;const t={...Ox},i=this._options.preferMultiviewOnInit&&e.getCaps().multiview;return i&&(t.textureType="texture-array"),this.addXRSessionLayer(this.createProjectionLayer(t,i)),!0}detach(){return super.detach()?(this._existingLayers.length=0,!0):!1}createXRWebGLLayer(e=yB){const t=new XRWebGLLayer(this._xrSessionManager.session,this._glContext,e);return new xm(t)}createProjectionLayer(e=Ox,t=!1){if(t&&e.textureType!=="texture-array")throw new Error("Projection layers can only be made multiview if they use texture arrays. Set the textureType parameter to 'texture-array'.");if(!t&&e.textureType==="texture-array")throw new Error("We currently only support multiview rendering when the textureType parameter is set to 'texture-array'.");const i=this._xrWebGLBinding.createProjectionLayer(e);return new bB(i,t,this._xrWebGLBinding)}addXRSessionLayer(e){this.setXRSessionLayers([...this._existingLayers,e])}setXRSessionLayers(e){this._existingLayers=e;const t={...this._xrSessionManager.session.renderState};t.baseLayer=void 0,t.layers=e.map(i=>i.layer),this._xrSessionManager.updateRenderState(t),this._xrSessionManager._setBaseLayerWrapper(e.length>0?e[0]:null)}isCompatible(){return!this._xrSessionManager.isNative&&typeof XRWebGLBinding<"u"&&!!XRWebGLBinding.prototype.createProjectionLayer}dispose(){super.dispose()}_onXRFrame(e){}}cu.Name=si.LAYERS;cu.Version=1;dr.AddWebXRFeature(cu.Name,(o,e)=>()=>new cu(o,e),cu.Version,!1);class CB extends Eh{constructor(e,t,i){super(e,AB[i],t,i,!0),this.profileId="generic-hand-select-grasp"}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){}_updateModel(){}}rs.RegisterController("generic-hand-select-grasp",(o,e)=>new CB(e,o.gamepad,o.handedness));const AB={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-none",assetPath:"none.glb"}};class Rl extends Eh{constructor(e,t,i){super(e,RB["left-right"],t,i),this._mapping={defaultButton:{valueNodeName:"VALUE",unpressedNodeName:"UNPRESSED",pressedNodeName:"PRESSED"},defaultAxis:{valueNodeName:"VALUE",minNodeName:"MIN",maxNodeName:"MAX"},buttons:{"xr-standard-trigger":{rootNodeName:"SELECT",componentProperty:"button",states:["default","touched","pressed"]},"xr-standard-squeeze":{rootNodeName:"GRASP",componentProperty:"state",states:["pressed"]},"xr-standard-touchpad":{rootNodeName:"TOUCHPAD_PRESS",labelAnchorNodeName:"squeeze-label",touchPointNodeName:"TOUCH"},"xr-standard-thumbstick":{rootNodeName:"THUMBSTICK_PRESS",componentProperty:"state",states:["pressed"]}},axes:{"xr-standard-touchpad":{"x-axis":{rootNodeName:"TOUCHPAD_TOUCH_X"},"y-axis":{rootNodeName:"TOUCHPAD_TOUCH_Y"}},"xr-standard-thumbstick":{"x-axis":{rootNodeName:"THUMBSTICK_X"},"y-axis":{rootNodeName:"THUMBSTICK_Y"}}}},this.profileId="microsoft-mixed-reality"}_getFilenameAndPath(){let e="";this.handedness==="left"?e=Rl.MODEL_LEFT_FILENAME:e=Rl.MODEL_RIGHT_FILENAME;const t="default",i=Rl.MODEL_BASE_URL+t+"/";return{filename:e,path:i}}_getModelLoadingConstraints(){const e=ft.IsPluginForExtensionAvailable(".glb");return e||X.Warn("glTF / glb loaded was not registered, using generic controller instead"),e}_processLoadedModel(e){this.rootMesh&&(this.getComponentIds().forEach((t,i)=>{if(!this.disableAnimation&&t&&this.rootMesh){const r=this._mapping.buttons[t],s=r.rootNodeName;if(!s){X.Log("Skipping unknown button at index: "+i+" with mapped name: "+t);return}const n=this._getChildByName(this.rootMesh,s);if(!n){X.Warn("Missing button mesh with name: "+s);return}if(r.valueMesh=this._getImmediateChildByName(n,this._mapping.defaultButton.valueNodeName),r.pressedMesh=this._getImmediateChildByName(n,this._mapping.defaultButton.pressedNodeName),r.unpressedMesh=this._getImmediateChildByName(n,this._mapping.defaultButton.unpressedNodeName),r.valueMesh&&r.pressedMesh&&r.unpressedMesh){const a=this.getComponent(t);a&&a.onButtonStateChangedObservable.add(l=>{this._lerpTransform(r,l.value)},void 0,!0)}else X.Warn("Missing button submesh under mesh with name: "+s)}}),this.getComponentIds().forEach(t=>{const i=this.getComponent(t);i.isAxes()&&["x-axis","y-axis"].forEach(r=>{if(!this.rootMesh)return;const s=this._mapping.axes[t][r],n=this._getChildByName(this.rootMesh,s.rootNodeName);if(!n){X.Warn("Missing axis mesh with name: "+s.rootNodeName);return}s.valueMesh=this._getImmediateChildByName(n,this._mapping.defaultAxis.valueNodeName),s.minMesh=this._getImmediateChildByName(n,this._mapping.defaultAxis.minNodeName),s.maxMesh=this._getImmediateChildByName(n,this._mapping.defaultAxis.maxNodeName),s.valueMesh&&s.minMesh&&s.maxMesh?i&&i.onAxisValueChangedObservable.add(a=>{const l=r==="x-axis"?a.x:a.y;this._lerpTransform(s,l,!0)},void 0,!0):X.Warn("Missing axis submesh under mesh with name: "+s.rootNodeName)})}))}_setRootMesh(e){this.rootMesh=new K(this.profileId+" "+this.handedness,this.scene),this.rootMesh.isPickable=!1;let t;for(let i=0;i<e.length;i++){const r=e[i];r.isPickable=!1,r.parent||(t=r)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=oe.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}Rl.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/";Rl.MODEL_LEFT_FILENAME="left.glb";Rl.MODEL_RIGHT_FILENAME="right.glb";rs.RegisterController("windows-mixed-reality",(o,e)=>new Rl(e,o.gamepad,o.handedness));const RB={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-right",assetPath:"right.glb"}};class Ha extends Eh{constructor(e,t,i,r=!1,s=!1){super(e,IB[i],t,i),this._forceLegacyControllers=s,this.profileId="oculus-touch"}_getFilenameAndPath(){let e="";this.handedness==="left"?e=Ha.MODEL_LEFT_FILENAME:e=Ha.MODEL_RIGHT_FILENAME;const t=this._isQuest()?Ha.QUEST_MODEL_BASE_URL:Ha.MODEL_BASE_URL;return{filename:e,path:t}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){const t=this._isQuest(),i=this.handedness==="right"?-1:1;this.getComponentIds().forEach(r=>{const s=r&&this.getComponent(r);s&&s.onButtonStateChangedObservable.add(n=>{if(!(!this.rootMesh||this.disableAnimation))switch(r){case"xr-standard-trigger":t||(this._modelRootNode.getChildren()[3].rotation.x=-n.value*.2,this._modelRootNode.getChildren()[3].position.y=-n.value*.005,this._modelRootNode.getChildren()[3].position.z=-n.value*.005);return;case"xr-standard-squeeze":t||(this._modelRootNode.getChildren()[4].position.x=i*n.value*.0035);return;case"xr-standard-thumbstick":return;case"a-button":case"x-button":t||(n.pressed?this._modelRootNode.getChildren()[1].position.y=-.001:this._modelRootNode.getChildren()[1].position.y=0);return;case"b-button":case"y-button":t||(n.pressed?this._modelRootNode.getChildren()[2].position.y=-.001:this._modelRootNode.getChildren()[2].position.y=0);return}},void 0,!0)})}_setRootMesh(e){this.rootMesh=new K(this.profileId+" "+this.handedness,this.scene),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=oe.FromEulerAngles(0,Math.PI,0)),e.forEach(t=>{t.isPickable=!1}),this._isQuest()?this._modelRootNode=e[0]:(this._modelRootNode=e[1],this.rootMesh.position.y=.034,this.rootMesh.position.z=.052),this._modelRootNode.parent=this.rootMesh}_updateModel(){}_isQuest(){return!!navigator.userAgent.match(/Quest/gi)&&!this._forceLegacyControllers}}Ha.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/";Ha.MODEL_LEFT_FILENAME="left.babylon";Ha.MODEL_RIGHT_FILENAME="right.babylon";Ha.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/";rs.RegisterController("oculus-touch",(o,e)=>new Ha(e,o.gamepad,o.handedness));rs.RegisterController("oculus-touch-legacy",(o,e)=>new Ha(e,o.gamepad,o.handedness,!0));const IB={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"x-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"x_button",visualResponses:{}},"y-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"y_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"a-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"a_button",visualResponses:{}},"b-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"b_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-right",assetPath:"right.glb"}};class mh extends Eh{constructor(e,t,i){super(e,PB[i],t,i),this.profileId="htc-vive"}_getFilenameAndPath(){const e=mh.MODEL_FILENAME,t=mh.MODEL_BASE_URL;return{filename:e,path:t}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){this.getComponentIds().forEach(t=>{const i=t&&this.getComponent(t);i&&i.onButtonStateChangedObservable.add(r=>{if(!(!this.rootMesh||this.disableAnimation))switch(t){case"xr-standard-trigger":this._modelRootNode.getChildren()[6].rotation.x=-r.value*.15;return;case"xr-standard-touchpad":return;case"xr-standard-squeeze":return}},void 0,!0)})}_setRootMesh(e){this.rootMesh=new K(this.profileId+" "+this.handedness,this.scene),e.forEach(t=>{t.isPickable=!1}),this._modelRootNode=e[1],this._modelRootNode.parent=this.rootMesh,this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=oe.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}mh.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/";mh.MODEL_FILENAME="wand.babylon";rs.RegisterController("htc-vive",(o,e)=>new mh(e,o.gamepad,o.handedness));const PB={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc-vive-none",assetPath:"none.glb"}};class MB{get session(){return this._nativeImpl.session}constructor(e){this._nativeImpl=e,this._xrTransform=new XRRigidTransform,this._xrPose={transform:this._xrTransform,emulatedPosition:!1},this._xrPoseVectorData=new Float32Array(4+4),this.fillPoses=this._nativeImpl.fillPoses.bind(this._nativeImpl),this.getViewerPose=this._nativeImpl.getViewerPose.bind(this._nativeImpl),this.getHitTestResults=this._nativeImpl.getHitTestResults.bind(this._nativeImpl),this.getHitTestResultsForTransientInput=()=>{throw new Error("XRFrame.getHitTestResultsForTransientInput not supported on native.")},this.createAnchor=this._nativeImpl.createAnchor.bind(this._nativeImpl),this.getJointPose=this._nativeImpl.getJointPose.bind(this._nativeImpl),this.fillJointRadii=this._nativeImpl.fillJointRadii.bind(this._nativeImpl),this.getLightEstimate=()=>{throw new Error("XRFrame.getLightEstimate not supported on native.")},this.getImageTrackingResults=()=>{var t;return(t=this._nativeImpl._imageTrackingResults)!==null&&t!==void 0?t:[]}}getPose(e,t){if(!this._nativeImpl.getPoseData(e,t,this._xrPoseVectorData.buffer,this._xrTransform.matrix.buffer))return;const i=this._xrTransform.position;i.x=this._xrPoseVectorData[0],i.y=this._xrPoseVectorData[1],i.z=this._xrPoseVectorData[2],i.w=this._xrPoseVectorData[3];const r=this._xrTransform.orientation;return r.x=this._xrPoseVectorData[4],r.y=this._xrPoseVectorData[5],r.z=this._xrPoseVectorData[6],r.w=this._xrPoseVectorData[7],this._xrPose}get trackedAnchors(){return this._nativeImpl.trackedAnchors}get worldInformation(){return this._nativeImpl.worldInformation}get detectedPlanes(){return this._nativeImpl.detectedPlanes}get featurePointCloud(){return this._nativeImpl.featurePointCloud}}RR("NativeXRFrame",MB);class Vt{static _CreateBufferView(e,t,i,r,s){const n={buffer:e,byteLength:i};return t&&(n.byteOffset=t),s&&(n.name=s),r&&(n.byteStride=r),n}static _CreateAccessor(e,t,i,r,s,n,a,l){const c={name:t,bufferView:e,componentType:r,count:s,type:i};return a!=null&&(c.min=a),l!=null&&(c.max=l),n!=null&&(c.byteOffset=n),c}static _CalculateMinMaxPositions(e,t,i,r){const s=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0],a=3;let l,c,h;if(i)for(let u=t,d=t+i;u<d;++u){l=a*u,c=x.FromArray(e,l),r&&Vt._GetRightHandedPositionVector3FromRef(c),h=c.asArray();for(let f=0;f<a;++f){const _=h[f];_<s[f]&&(s[f]=_),_>n[f]&&(n[f]=_),++l}}return{min:s,max:n}}static _GetRightHandedPositionVector3(e){return new x(e.x,e.y,-e.z)}static _GetRightHandedPositionVector3FromRef(e){e.z*=-1}static _GetRightHandedPositionArray3FromRef(e){e[2]*=-1}static _GetRightHandedNormalVector3(e){return new x(e.x,e.y,-e.z)}static _GetRightHandedNormalVector3FromRef(e){e.z*=-1}static _GetRightHandedNormalArray3FromRef(e){e[2]*=-1}static _GetRightHandedVector4FromRef(e){e.z*=-1,e.w*=-1}static _GetRightHandedArray4FromRef(e){e[2]*=-1,e[3]*=-1}static _GetRightHandedQuaternionFromRef(e){e.x*=-1,e.y*=-1}static _GetRightHandedQuaternionArrayFromRef(e){e[0]*=-1,e[1]*=-1}static _NormalizeTangentFromRef(e){const t=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);t>0&&(e.x/=t,e.y/=t,e.z/=t)}static _GetDataAccessorElementCount(e){switch(e){case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4}}}var hu;(function(o){o[o.INTANGENT=0]="INTANGENT",o[o.OUTTANGENT=1]="OUTTANGENT"})(hu||(hu={}));class hr{static _IsTransformable(e){return e&&(e instanceof gt||e instanceof Ve||e instanceof St)}static _CreateNodeAnimation(e,t,i,r,s,n){if(this._IsTransformable(e)){const a=[],l=[],c=t.getKeys(),h=hr._CalculateMinMaxKeyFrames(c),u=hr._DeduceInterpolation(c,i,s),d=h.max-h.min,f=u.interpolationType,_=u.shouldBakeAnimation;if(_?hr._CreateBakedAnimation(e,t,i,h.min,h.max,t.framePerSecond,n,a,l,h,r,s):f==="LINEAR"||f==="STEP"?hr._CreateLinearOrStepAnimation(e,t,i,d,a,l,r,s):f==="CUBICSPLINE"?hr._CreateCubicSplineAnimation(e,t,i,d,a,l,r,s):hr._CreateBakedAnimation(e,t,i,h.min,h.max,t.framePerSecond,n,a,l,h,r,s),a.length&&l.length)return{inputs:a,outputs:l,samplerInterpolation:f,inputsMin:_?h.min:J.FloatRound(h.min/t.framePerSecond),inputsMax:_?h.max:J.FloatRound(h.max/t.framePerSecond)}}return null}static _DeduceAnimationInfo(e){let t=null,i="VEC3",r=!1;const s=e.targetProperty.split(".");switch(s[0]){case"scaling":{t="scale";break}case"position":{t="translation";break}case"rotation":{i="VEC4",t="rotation";break}case"rotationQuaternion":{i="VEC4",r=!0,t="rotation";break}case"influence":{i="SCALAR",t="weights";break}default:J.Error(`Unsupported animatable property ${s[0]}`)}return t?{animationChannelTargetPath:t,dataAccessorType:i,useQuaternion:r}:(J.Error("animation channel target path and data accessor type could be deduced"),null)}static _CreateNodeAnimationFromNodeAnimations(e,t,i,r,s,n,a,l,c,h){let u;if(hr._IsTransformable(e)&&e.animations)for(const d of e.animations){const f=hr._DeduceAnimationInfo(d);f&&(u={name:d.name,samplers:[],channels:[]},hr._AddAnimation(`${d.name}`,d.hasRunningRuntimeAnimations?t:u,e,d,f.dataAccessorType,f.animationChannelTargetPath,r,n,a,l,c,f.useQuaternion,h),u.samplers.length&&u.channels.length&&i.push(u))}}static _CreateMorphTargetAnimationFromMorphTargetAnimations(e,t,i,r,s,n,a,l,c,h){let u;if(e instanceof K){const d=e.morphTargetManager;if(d)for(let f=0;f<d.numTargets;++f){const _=d.getTarget(f);for(const p of _.animations){const m=new ae(`${p.name}`,"influence",p.framePerSecond,p.dataType,p.loopMode,p.enableBlending),T=[],b=p.getKeys();for(let S=0;S<b.length;++S){const C=b[S];for(let I=0;I<d.numTargets;++I)I==f?T.push(C):T.push({frame:C.frame,value:0})}m.setKeys(T);const y=hr._DeduceAnimationInfo(m);y&&(u={name:m.name,samplers:[],channels:[]},hr._AddAnimation(p.name,p.hasRunningRuntimeAnimations?t:u,e,m,y.dataAccessorType,y.animationChannelTargetPath,r,n,a,l,c,y.useQuaternion,h,d.numTargets),u.samplers.length&&u.channels.length&&i.push(u))}}}}static _CreateNodeAndMorphAnimationFromAnimationGroups(e,t,i,r,s,n,a,l,c){var h;let u;if(e.animationGroups){const d=e.animationGroups;for(const f of d){const _=new Map,p=new Map,m=new Set,T=f.to-f.from;u={name:f.name,channels:[],samplers:[]};for(let b=0;b<f.targetedAnimations.length;++b){const y=f.targetedAnimations[b],S=y.target,C=y.animation;if(this._IsTransformable(S)||S.length===1&&this._IsTransformable(S[0])){const I=hr._DeduceAnimationInfo(y.animation);if(I){const P=this._IsTransformable(S)?S:this._IsTransformable(S[0])?S[0]:null;if(P){const D=l[P.uniqueId];hr._AddAnimation(`${C.name}`,u,P,C,I.dataAccessorType,I.animationChannelTargetPath,i,s,n,a,D,I.useQuaternion,c)}}}else if((S instanceof xo||S.length===1&&S[0]instanceof xo)&&hr._DeduceAnimationInfo(y.animation)){const P=S instanceof xo?S:S[0];if(P){const D=e.morphTargetManagers.find(w=>{for(let L=0;L<w.numTargets;++L)if(w.getTarget(L)===P)return!0;return!1});if(D){const w=e.meshes.find(L=>L.morphTargetManager===D);w&&(_.has(w)||_.set(w,new Map),(h=_.get(w))===null||h===void 0||h.set(P,C),m.add(w),p.set(w,C))}}}}m.forEach(b=>{const y=b.morphTargetManager;let S=null;const C=[],P=p.get(b).getKeys(),D=P.length;for(let L=0;L<D;++L)for(let U=0;U<y.numTargets;++U){const G=y.getTarget(U),Z=_.get(b);if(Z){const he=Z.get(G);he?(S||(S=new ae(`${f.name}_${b.name}_MorphWeightAnimation`,"influence",he.framePerSecond,ae.ANIMATIONTYPE_FLOAT,he.loopMode,he.enableBlending)),C.push(he.getKeys()[L])):C.push({frame:f.from+T/D*L,value:G.influence,inTangent:P[0].inTangent?0:void 0,outTangent:P[0].outTangent?0:void 0})}}S.setKeys(C);const w=hr._DeduceAnimationInfo(S);w&&hr._AddAnimation(`${f.name}_${b.name}_MorphWeightAnimation`,u,b,S,w.dataAccessorType,w.animationChannelTargetPath,i,s,n,a,!1,w.useQuaternion,c,y==null?void 0:y.numTargets)}),u.channels.length&&u.samplers.length&&t.push(u)}}}static _AddAnimation(e,t,i,r,s,n,a,l,c,h,u,d,f,_){const p=hr._CreateNodeAnimation(i,r,n,u,d,f);let m,T,b,y,S,C,I;if(p){if(_){let w=0,L=0;const U=[];for(;p.inputs.length>0;)L=p.inputs.shift(),w%_==0&&U.push(L),w++;p.inputs=U}const P=a[i.uniqueId];let D=p.inputs.length*4;m=Vt._CreateBufferView(0,l.getByteOffset(),D,void 0,`${e}  keyframe data view`),c.push(m),p.inputs.forEach(function(w){l.setFloat32(w)}),T=Vt._CreateAccessor(c.length-1,`${e}  keyframes`,"SCALAR",5126,p.inputs.length,null,[p.inputsMin],[p.inputsMax]),h.push(T),b=h.length-1,S=p.outputs.length,D=Vt._GetDataAccessorElementCount(s)*4*p.outputs.length,m=Vt._CreateBufferView(0,l.getByteOffset(),D,void 0,`${e}  data view`),c.push(m),p.outputs.forEach(function(w){w.forEach(function(L){l.setFloat32(L)})}),T=Vt._CreateAccessor(c.length-1,`${e}  data`,s,5126,S,null,null,null),h.push(T),y=h.length-1,C={interpolation:p.samplerInterpolation,input:b,output:y},t.samplers.push(C),I={sampler:t.samplers.length-1,target:{node:P,path:n}},t.channels.push(I)}}static _CreateBakedAnimation(e,t,i,r,s,n,a,l,c,h,u,d){let f;const _=oe.Identity();let p=null,m,T=null,b=null,y=null,S=null,C=null;h.min=J.FloatRound(r/n);const I=t.getKeys();for(let P=0,D=I.length;P<D;++P){if(C=null,b=I[P],P+1<D)if(y=I[P+1],b.value.equals&&b.value.equals(y.value)||b.value===y.value)if(P===0)C=b.frame;else continue;else C=y.frame;else{if(S=I[P-1],b.value.equals&&b.value.equals(S.value)||b.value===S.value)continue;C=s}if(C)for(let w=b.frame;w<=C;w+=a){if(m=J.FloatRound(w/n),m===p)continue;p=m,T=m;const L={key:0,repeatCount:0,loopMode:t.loopMode};f=t._interpolate(w,L),hr._SetInterpolatedValue(e,f,m,t,i,_,l,c,u,d)}}T&&(h.max=T)}static _ConvertFactorToVector3OrQuaternion(e,t,i,r,s,n){const a=hr._GetBasePositionRotationOrScale(t,r,s,n),l=i.targetProperty.split("."),c=l?l[1]:"",h=n?oe.FromArray(a).normalize():x.FromArray(a);switch(c){case"x":{h[c]=s&&n&&r!=="scale"?-e:e;break}case"y":{h[c]=s&&n&&r!=="scale"?-e:e;break}case"z":{h[c]=s&&!n&&r!=="scale"?-e:e;break}case"w":{h.w=e;break}default:J.Error(`glTFAnimation: Unsupported component name "${c}"!`)}return h}static _SetInterpolatedValue(e,t,i,r,s,n,a,l,c,h){let u;if(a.push(i),s==="weights"){l.push([t]);return}r.dataType===ae.ANIMATIONTYPE_FLOAT&&(t=this._ConvertFactorToVector3OrQuaternion(t,e,r,s,c,h)),s==="rotation"?(h?n=t:(u=t,oe.RotationYawPitchRollToRef(u.y,u.x,u.z,n)),c&&(Vt._GetRightHandedQuaternionFromRef(n),e.parent||(n=oe.FromArray([0,1,0,0]).multiply(n))),l.push(n.asArray())):(u=t,c&&s!=="scale"&&(Vt._GetRightHandedPositionVector3FromRef(u),e.parent||(u.x*=-1,u.z*=-1)),l.push(u.asArray()))}static _CreateLinearOrStepAnimation(e,t,i,r,s,n,a,l){for(const c of t.getKeys())s.push(c.frame/t.framePerSecond),hr._AddKeyframeValue(c,t,n,i,e,a,l)}static _CreateCubicSplineAnimation(e,t,i,r,s,n,a,l){t.getKeys().forEach(function(c){s.push(c.frame/t.framePerSecond),hr._AddSplineTangent(e,hu.INTANGENT,n,i,"CUBICSPLINE",c,r,l,a),hr._AddKeyframeValue(c,t,n,i,e,a,l),hr._AddSplineTangent(e,hu.OUTTANGENT,n,i,"CUBICSPLINE",c,r,l,a)})}static _GetBasePositionRotationOrScale(e,t,i,r){let s;if(t==="rotation")if(r){const n=e.rotationQuaternion;s=(n??oe.Identity()).asArray(),i&&(Vt._GetRightHandedQuaternionArrayFromRef(s),e.parent||(s=oe.FromArray([0,1,0,0]).multiply(oe.FromArray(s)).asArray()))}else{const n=e.rotation;s=(n??x.Zero()).asArray(),Vt._GetRightHandedNormalArray3FromRef(s)}else if(t==="translation"){const n=e.position;s=(n??x.Zero()).asArray(),i&&Vt._GetRightHandedPositionArray3FromRef(s)}else{const n=e.scaling;s=(n??x.One()).asArray()}return s}static _AddKeyframeValue(e,t,i,r,s,n,a){let l,c;const h=t.dataType;if(h===ae.ANIMATIONTYPE_VECTOR3){if(l=e.value.asArray(),r==="rotation"){const u=x.FromArray(l);let d=oe.RotationYawPitchRoll(u.y,u.x,u.z);n&&(Vt._GetRightHandedQuaternionFromRef(d),s.parent||(d=oe.FromArray([0,1,0,0]).multiply(d))),l=d.asArray()}else r==="translation"&&n&&(Vt._GetRightHandedNormalArray3FromRef(l),s.parent||(l[0]*=-1,l[2]*=-1));i.push(l)}else if(h===ae.ANIMATIONTYPE_FLOAT){if(r==="weights")i.push([e.value]);else if(c=this._ConvertFactorToVector3OrQuaternion(e.value,s,t,r,n,a),c){if(r==="rotation"){let u=a?c:oe.RotationYawPitchRoll(c.y,c.x,c.z).normalize();n&&(Vt._GetRightHandedQuaternionFromRef(u),s.parent||(u=oe.FromArray([0,1,0,0]).multiply(u))),i.push(u.asArray())}else r==="translation"&&n&&(Vt._GetRightHandedNormalVector3FromRef(c),s.parent||(c.x*=-1,c.z*=-1));i.push(c.asArray())}}else h===ae.ANIMATIONTYPE_QUATERNION?(l=e.value.normalize().asArray(),n&&(Vt._GetRightHandedQuaternionArrayFromRef(l),s.parent||(l=oe.FromArray([0,1,0,0]).multiply(oe.FromArray(l)).asArray())),i.push(l)):J.Error("glTFAnimation: Unsupported key frame values for animation!")}static _DeduceInterpolation(e,t,i){let r,s=!1,n;if(t==="rotation"&&!i)return{interpolationType:"LINEAR",shouldBakeAnimation:!0};for(let a=0,l=e.length;a<l;++a)if(n=e[a],n.inTangent||n.outTangent)if(r){if(r!=="CUBICSPLINE"){r="LINEAR",s=!0;break}}else r="CUBICSPLINE";else if(r){if(r==="CUBICSPLINE"||n.interpolation&&n.interpolation===th.STEP&&r!=="STEP"){r="LINEAR",s=!0;break}}else n.interpolation&&n.interpolation===th.STEP?r="STEP":r="LINEAR";return r||(r="LINEAR"),{interpolationType:r,shouldBakeAnimation:s}}static _AddSplineTangent(e,t,i,r,s,n,a,l,c){let h;const u=t===hu.INTANGENT?n.inTangent:n.outTangent;if(s==="CUBICSPLINE"){if(r==="rotation")if(u){if(l)h=u.asArray();else{const d=u;h=oe.RotationYawPitchRoll(d.y,d.x,d.z).asArray()}c&&(Vt._GetRightHandedQuaternionArrayFromRef(h),e.parent||(h=oe.FromArray([0,1,0,0]).multiply(oe.FromArray(h)).asArray()))}else h=[0,0,0,0];else r==="weights"?u?h=[u]:h=[0]:u?(h=u.asArray(),c&&r==="translation"&&(Vt._GetRightHandedPositionArray3FromRef(h),e.parent||(h[0]*=-1,h[2]*=-1))):h=[0,0,0];i.push(h)}}static _CalculateMinMaxKeyFrames(e){let t=1/0,i=-1/0;return e.forEach(function(r){t=Math.min(t,r.frame),i=Math.max(i,r.frame)}),{min:t,max:i}}}class Dx{constructor(){this.glTFFiles={}}downloadFiles(){function e(t,i){return t.indexOf(i,t.length-i.length)!==-1}for(const t in this.glTFFiles){const i=document.createElement("a");document.body.appendChild(i),i.setAttribute("type","hidden"),i.download=t;const r=this.glTFFiles[t];let s;e(t,".glb")?s={type:"model/gltf-binary"}:e(t,".bin")?s={type:"application/octet-stream"}:e(t,".gltf")?s={type:"model/gltf+json"}:e(t,".jpeg")||e(t,".jpg")?s={type:"image/jpeg"}:e(t,".png")&&(s={type:"image/png"}),i.href=window.URL.createObjectURL(new Blob([r],s)),i.click()}}}function OB(o){switch(o){case"image/jpeg":return".jpg";case"image/png":return".png";case"image/webp":return".webp"}}class Ki{constructor(e){this._textureMap={},this._internalTextureToImage={},this._textureMap={},this._exporter=e}static _FuzzyEquals(e,t,i){return Ee.WithinEpsilon(e.r,t.r,i)&&Ee.WithinEpsilon(e.g,t.g,i)&&Ee.WithinEpsilon(e.b,t.b,i)}_convertMaterialsToGLTFAsync(e,t,i){const r=[];return e.forEach(s=>{s.getClassName()==="StandardMaterial"?r.push(this._convertStandardMaterialAsync(s,t,i)):s.getClassName().indexOf("PBR")!==-1?r.push(this._convertPBRMaterialAsync(s,t,i)):J.Warn(`Unsupported material type: ${s.name}`)}),Promise.all(r).then(()=>{})}_stripTexturesFromMaterial(e){const t={};if(e){t.name=e.name,t.doubleSided=e.doubleSided,t.alphaMode=e.alphaMode,t.alphaCutoff=e.alphaCutoff,t.emissiveFactor=e.emissiveFactor;const i=e.pbrMetallicRoughness;i&&(t.pbrMetallicRoughness={},t.pbrMetallicRoughness.baseColorFactor=i.baseColorFactor,t.pbrMetallicRoughness.metallicFactor=i.metallicFactor,t.pbrMetallicRoughness.roughnessFactor=i.roughnessFactor)}return t}_hasTexturesPresent(e){var t;if(e.emissiveTexture||e.normalTexture||e.occlusionTexture)return!0;const i=e.pbrMetallicRoughness;if(i&&(i.baseColorTexture||i.metallicRoughnessTexture))return!0;if(e.extensions)for(const r in e.extensions){const s=e.extensions[r];if(s)return(t=s.hasTextures)===null||t===void 0?void 0:t.call(s)}return!1}_getTextureInfo(e){if(e){const t=e.uid;if(t in this._textureMap)return this._textureMap[t]}return null}_convertToGLTFPBRMetallicRoughness(e){const t=new Ie(0,1),i=new Ie(0,.1),r=new Ie(0,.1),s=new Ie(1300,.1);function n(f,_,p,m,T){return(1-f)*(1-f)*(1-f)*_+3*(1-f)*(1-f)*f*p+3*(1-f)*f*f*m+f*f*f*T}function a(f){const _=Math.pow(f/s.x,.333333);return n(_,t.y,i.y,r.y,s.y)}const l=e.diffuseColor.toLinearSpace().scale(.5),c=e.alpha,h=Ee.Clamp(e.specularPower,0,Ki._MaxSpecularPower),u=a(h);return{baseColorFactor:[l.r,l.g,l.b,c],metallicFactor:0,roughnessFactor:u}}static _SolveMetallic(e,t,i){if(t<this._DielectricSpecular.r)return this._DielectricSpecular,0;const r=this._DielectricSpecular.r,s=e*i/(1-this._DielectricSpecular.r)+t-2*this._DielectricSpecular.r,n=this._DielectricSpecular.r-t,a=s*s-4*r*n;return Ee.Clamp((-s+Math.sqrt(a))/(2*r),0,1)}static _SetAlphaMode(e,t){t.needAlphaBlending()?e.alphaMode="BLEND":t.needAlphaTesting()&&(e.alphaMode="MASK",e.alphaCutoff=t.alphaCutOff)}_convertStandardMaterialAsync(e,t,i){const r=this._exporter._materialMap,s=this._exporter._materials,n=[],a=this._convertToGLTFPBRMetallicRoughness(e),l={name:e.name};if(e.backFaceCulling!=null&&!e.backFaceCulling&&(e.twoSidedLighting||J.Warn(e.name+": Back-face culling disabled and two-sided lighting disabled is not supported in glTF."),l.doubleSided=!0),i){e.diffuseTexture&&n.push(this._exportTextureAsync(e.diffuseTexture,t).then(h=>{h&&(a.baseColorTexture=h)}));const c=e.bumpTexture;c&&n.push(this._exportTextureAsync(c,t).then(h=>{h&&(l.normalTexture=h,c.level!==1&&(l.normalTexture.scale=c.level))})),e.emissiveTexture&&(l.emissiveFactor=[1,1,1],n.push(this._exportTextureAsync(e.emissiveTexture,t).then(h=>{h&&(l.emissiveTexture=h)}))),e.ambientTexture&&n.push(this._exportTextureAsync(e.ambientTexture,t).then(h=>{if(h){const u={index:h.index};l.occlusionTexture=u}}))}return(e.alpha<1||e.opacityTexture)&&(e.alphaMode===ie.ALPHA_COMBINE?l.alphaMode="BLEND":J.Warn(e.name+": glTF 2.0 does not support alpha mode: "+e.alphaMode.toString())),e.emissiveColor&&!Ki._FuzzyEquals(e.emissiveColor,ge.Black(),Ki._Epsilon)&&(l.emissiveFactor=e.emissiveColor.asArray()),l.pbrMetallicRoughness=a,Ki._SetAlphaMode(l,e),s.push(l),r[e.uniqueId]=s.length-1,this._finishMaterial(n,l,e,t)}_finishMaterial(e,t,i,r){return Promise.all(e).then(()=>{const s=this._exporter._extensionsPostExportMaterialAdditionalTextures("exportMaterial",t,i);let n=null;for(const a of s)n||(n=[]),n.push(this._exportTextureAsync(a,r));return n||(n=[Promise.resolve(null)]),Promise.all(n).then(()=>{const a=this._exporter._extensionsPostExportMaterialAsync("exportMaterial",t,i);return a?a.then(()=>t):t})})}async _getImageDataAsync(e,t,i,r){const s=ie.TEXTURETYPE_UNSIGNED_INT,n=this._exporter._babylonScene,a=n.getEngine(),l=a.createRawTexture(e,t,i,ie.TEXTUREFORMAT_RGBA,!1,!0,Y.NEAREST_SAMPLINGMODE,null,s);await b_.ApplyPostProcess("pass",l,n,s,ie.TEXTURE_NEAREST_SAMPLINGMODE,ie.TEXTUREFORMAT_RGBA);const c=await a._readTexturePixels(l,t,i);return await Ys.DumpDataAsync(t,i,c,r,void 0,!0,!0)}_createWhiteTexture(e,t,i){const r=new Uint8Array(e*t*4);for(let n=0;n<r.length;n=n+4)r[n]=r[n+1]=r[n+2]=r[n+3]=255;return an.CreateRGBATexture(r,e,t,i)}_resizeTexturesToSameDimensions(e,t,i){const r=e?e.getSize():{width:0,height:0},s=t?t.getSize():{width:0,height:0};let n,a;return r.width<s.width?(e&&e instanceof Y?n=b_.CreateResizedCopy(e,s.width,s.height,!0):n=this._createWhiteTexture(s.width,s.height,i),a=t):r.width>s.width?(t&&t instanceof Y?a=b_.CreateResizedCopy(t,r.width,r.height,!0):a=this._createWhiteTexture(r.width,r.height,i),n=e):(n=e,a=t),{texture1:n,texture2:a}}_convertPixelArrayToFloat32(e){if(e instanceof Uint8Array){const t=e.length,i=new Float32Array(e.length);for(let r=0;r<t;++r)i[r]=e[r]/255;return i}else{if(e instanceof Float32Array)return e;throw new Error("Unsupported pixel format!")}}async _convertSpecularGlossinessTexturesToMetallicRoughnessAsync(e,t,i,r){var s;const n=new Array;if(!(e||t))return Promise.reject("_ConvertSpecularGlosinessTexturesToMetallicRoughness: diffuse and specular glossiness textures are not defined!");const a=e?e.getScene():t?t.getScene():null;if(a){const l=this._resizeTexturesToSameDimensions(e,t,a),c=(s=l.texture1)===null||s===void 0?void 0:s.getSize();let h,u;const d=c.width,f=c.height,_=await l.texture1.readPixels(),p=await l.texture2.readPixels();if(_)h=this._convertPixelArrayToFloat32(_);else return Promise.reject("Failed to retrieve pixels from diffuse texture!");if(p)u=this._convertPixelArrayToFloat32(p);else return Promise.reject("Failed to retrieve pixels from specular glossiness texture!");const m=u.byteLength,T=new Uint8Array(m),b=new Uint8Array(m),y=4,S=ge.Black();let C=0,I=0;for(let L=0;L<f;++L)for(let U=0;U<d;++U){const G=(d*L+U)*y,Z=new ge(h[G],h[G+1],h[G+2]).toLinearSpace().multiply(i.diffuseColor),he=new ge(u[G],u[G+1],u[G+2]).toLinearSpace().multiply(i.specularColor),_e=u[G+3]*i.glossiness,ne={diffuseColor:Z,specularColor:he,glossiness:_e},Pe=this._convertSpecularGlossinessToMetallicRoughness(ne);S.r=Math.max(S.r,Pe.baseColor.r),S.g=Math.max(S.g,Pe.baseColor.g),S.b=Math.max(S.b,Pe.baseColor.b),C=Math.max(C,Pe.metallic),I=Math.max(I,Pe.roughness),b[G]=Pe.baseColor.r*255,b[G+1]=Pe.baseColor.g*255,b[G+2]=Pe.baseColor.b*255,b[G+3]=l.texture1.hasAlpha?h[G+3]*255:255,T[G]=0,T[G+1]=Pe.roughness*255,T[G+2]=Pe.metallic*255,T[G+3]=255}const P={baseColor:S,metallic:C,roughness:I};let D=!1,w=!1;for(let L=0;L<f;++L)for(let U=0;U<d;++U){const G=(d*L+U)*y;b[G]/=P.baseColor.r>Ki._Epsilon?P.baseColor.r:1,b[G+1]/=P.baseColor.g>Ki._Epsilon?P.baseColor.g:1,b[G+2]/=P.baseColor.b>Ki._Epsilon?P.baseColor.b:1;const he=ge.FromInts(b[G],b[G+1],b[G+2]).toGammaSpace();b[G]=he.r*255,b[G+1]=he.g*255,b[G+2]=he.b*255,Ki._FuzzyEquals(he,ge.White(),Ki._Epsilon)||(w=!0),T[G+1]/=P.roughness>Ki._Epsilon?P.roughness:1,T[G+2]/=P.metallic>Ki._Epsilon?P.metallic:1;const _e=ge.FromInts(255,T[G+1],T[G+2]);Ki._FuzzyEquals(_e,ge.White(),Ki._Epsilon)||(D=!0)}return D&&n.push(this._getImageDataAsync(T,d,f,r).then(L=>{P.metallicRoughnessTextureData=L})),w&&n.push(this._getImageDataAsync(b,d,f,r).then(L=>{P.baseColorTextureData=L})),Promise.all(n).then(()=>P)}else return Promise.reject("_ConvertSpecularGlossinessTexturesToMetallicRoughness: Scene from textures is missing!")}_convertSpecularGlossinessToMetallicRoughness(e){const t=this._getPerceivedBrightness(e.diffuseColor),i=this._getPerceivedBrightness(e.specularColor),r=1-this._getMaxComponent(e.specularColor),s=Ki._SolveMetallic(t,i,r),n=e.diffuseColor.scale(r/(1-Ki._DielectricSpecular.r)/Math.max(1-s,Ki._Epsilon)),a=e.specularColor.subtract(Ki._DielectricSpecular.scale(1-s)).scale(1/Math.max(s,Ki._Epsilon));let l=ge.Lerp(n,a,s*s);return l=l.clampToRef(0,1,l),{baseColor:l,metallic:s,roughness:1-e.glossiness}}_getPerceivedBrightness(e){return e?Math.sqrt(.299*e.r*e.r+.587*e.g*e.g+.114*e.b*e.b):0}_getMaxComponent(e){return e?Math.max(e.r,Math.max(e.g,e.b)):0}_convertMetalRoughFactorsToMetallicRoughnessAsync(e,t,i,r){const s=[],n=e._albedoColor,a=e._metallic,l=e._roughness,c={baseColor:n,metallic:a,roughness:l};if(r){e._albedoTexture&&s.push(this._exportTextureAsync(e._albedoTexture,t).then(d=>{d&&(i.baseColorTexture=d)}));const u=e._metallicTexture;u&&s.push(this._exportTextureAsync(u,t).then(d=>{d&&(i.metallicRoughnessTexture=d)}))}return Promise.all(s).then(()=>c)}_getTextureSampler(e){const t={};if(!e||!(e instanceof Y))return t;const i=this._getGLTFTextureWrapMode(e.wrapU);i!==10497&&(t.wrapS=i);const r=this._getGLTFTextureWrapMode(e.wrapV);switch(r!==10497&&(t.wrapT=r),e.samplingMode){case Y.LINEAR_LINEAR:{t.magFilter=9729,t.minFilter=9729;break}case Y.LINEAR_NEAREST:{t.magFilter=9729,t.minFilter=9728;break}case Y.NEAREST_LINEAR:{t.magFilter=9728,t.minFilter=9729;break}case Y.NEAREST_LINEAR_MIPLINEAR:{t.magFilter=9728,t.minFilter=9987;break}case Y.NEAREST_NEAREST:{t.magFilter=9728,t.minFilter=9728;break}case Y.NEAREST_LINEAR_MIPNEAREST:{t.magFilter=9728,t.minFilter=9985;break}case Y.LINEAR_NEAREST_MIPNEAREST:{t.magFilter=9729,t.minFilter=9984;break}case Y.LINEAR_NEAREST_MIPLINEAR:{t.magFilter=9729,t.minFilter=9986;break}case Y.NEAREST_NEAREST_MIPLINEAR:{t.magFilter=9728,t.minFilter=9986;break}case Y.LINEAR_LINEAR_MIPLINEAR:{t.magFilter=9729,t.minFilter=9987;break}case Y.LINEAR_LINEAR_MIPNEAREST:{t.magFilter=9729,t.minFilter=9985;break}case Y.NEAREST_NEAREST_MIPNEAREST:{t.magFilter=9728,t.minFilter=9984;break}}return t}_getGLTFTextureWrapMode(e){switch(e){case Y.WRAP_ADDRESSMODE:return 10497;case Y.CLAMP_ADDRESSMODE:return 33071;case Y.MIRROR_ADDRESSMODE:return 33648;default:return J.Error(`Unsupported Texture Wrap Mode ${e}!`),10497}}_convertSpecGlossFactorsToMetallicRoughnessAsync(e,t,i,r){return Promise.resolve().then(()=>{const s={diffuseColor:e._albedoColor,specularColor:e._reflectivityColor,glossiness:e._microSurface},n=e._albedoTexture,a=e._reflectivityTexture,l=e._useMicroSurfaceFromReflectivityMapAlpha;if(a&&!l)return Promise.reject("_ConvertPBRMaterial: Glossiness values not included in the reflectivity texture are currently not supported");if((n||a)&&r){const c=this._exportTextureSampler(n||a);return this._convertSpecularGlossinessTexturesToMetallicRoughnessAsync(n,a,s,t).then(h=>{const u=this._exporter._textures;if(h.baseColorTextureData){const d=this._exportImage(`baseColor${u.length}`,t,h.baseColorTextureData);i.baseColorTexture=this._exportTextureInfo(d,c,n==null?void 0:n.coordinatesIndex)}if(h.metallicRoughnessTextureData){const d=this._exportImage(`metallicRoughness${u.length}`,t,h.metallicRoughnessTextureData);i.metallicRoughnessTexture=this._exportTextureInfo(d,c,a==null?void 0:a.coordinatesIndex)}return h})}else return this._convertSpecularGlossinessToMetallicRoughness(s)})}_convertPBRMaterialAsync(e,t,i){const r={},s={name:e.name};if(e.isMetallicWorkflow()){const a=e._albedoColor,l=e.alpha;return a&&(r.baseColorFactor=[a.r,a.g,a.b,l]),this._convertMetalRoughFactorsToMetallicRoughnessAsync(e,t,r,i).then(c=>this._setMetallicRoughnessPbrMaterial(c,e,s,r,t,i))}else return this._convertSpecGlossFactorsToMetallicRoughnessAsync(e,t,r,i).then(a=>this._setMetallicRoughnessPbrMaterial(a,e,s,r,t,i))}_setMetallicRoughnessPbrMaterial(e,t,i,r,s,n){const a=this._exporter._materialMap,l=this._exporter._materials,c=[];if(e){if(Ki._SetAlphaMode(i,t),Ki._FuzzyEquals(e.baseColor,ge.White(),Ki._Epsilon)&&t.alpha>=Ki._Epsilon||(r.baseColorFactor=[e.baseColor.r,e.baseColor.g,e.baseColor.b,t.alpha]),e.metallic!=null&&e.metallic!==1&&(r.metallicFactor=e.metallic),e.roughness!=null&&e.roughness!==1&&(r.roughnessFactor=e.roughness),t.backFaceCulling!=null&&!t.backFaceCulling&&(t._twoSidedLighting||J.Warn(t.name+": Back-face culling disabled and two-sided lighting disabled is not supported in glTF."),i.doubleSided=!0),n){const u=t._bumpTexture;if(u){const _=this._exportTextureAsync(u,s).then(p=>{p&&(i.normalTexture=p,u.level!==1&&(i.normalTexture.scale=u.level))});c.push(_)}const d=t._ambientTexture;if(d){const _=this._exportTextureAsync(d,s).then(p=>{if(p){const m={index:p.index,texCoord:p.texCoord};i.occlusionTexture=m;const T=t._ambientTextureStrength;T&&(m.strength=T)}});c.push(_)}const f=t._emissiveTexture;if(f){const _=this._exportTextureAsync(f,s).then(p=>{p&&(i.emissiveTexture=p)});c.push(_)}}const h=t._emissiveColor;Ki._FuzzyEquals(h,ge.Black(),Ki._Epsilon)||(i.emissiveFactor=h.asArray()),i.pbrMetallicRoughness=r,l.push(i),a[t.uniqueId]=l.length-1}return this._finishMaterial(c,i,t,s)}_getPixelsFromTexture(e){return e.textureType===ie.TEXTURETYPE_UNSIGNED_INT,e.readPixels()}_exportTextureAsync(e,t){const i=this._exporter._extensionsPreExportTextureAsync("exporter",e,t);return i?i.then(r=>r?this._exportTextureInfoAsync(r,t):this._exportTextureInfoAsync(e,t)):this._exportTextureInfoAsync(e,t)}async _exportTextureInfoAsync(e,t){const i=e.uid;if(!(i in this._textureMap)){const r=await this._getPixelsFromTexture(e);if(!r)return null;const s=this._exportTextureSampler(e),n=e.mimeType;if(n)switch(n){case"image/jpeg":case"image/png":case"image/webp":t=n;break;default:J.Warn("Unsupported media type: ${textureMimeType}");break}const a=this._internalTextureToImage,l=e.getInternalTexture().uniqueId;a[l]||(a[l]={});let c=a[l][t];if(c===void 0){const u=e.getSize();c=(async()=>{const d=await this._getImageDataAsync(r,u.width,u.height,t);return this._exportImage(e.name,t,d)})(),a[l][t]=c}const h=this._exportTextureInfo(await c,s,e.coordinatesIndex);this._textureMap[i]=h,this._exporter._extensionsPostExportTextures("exporter",this._textureMap[i],e)}return this._textureMap[i]}_exportImage(e,t,i){const r=this._exporter._imageData,s=e.replace(/\.\/|\/|\.\\|\\/g,"_"),n=OB(t);let a=s+n;a in r&&(a=`${s}_${J.RandomId()}${n}`),r[a]={data:i,mimeType:t};const l=this._exporter._images;return l.push({name:e,uri:a}),l.length-1}_exportTextureInfo(e,t,i){const r=this._exporter._textures;let s=r.findIndex(a=>a.sampler==t&&a.source===e);s===-1&&(s=r.length,r.push({source:e,sampler:t}));const n={index:s};return i&&(n.texCoord=i),n}_exportTextureSampler(e){const t=this._getTextureSampler(e),i=this._exporter._samplers,r=i.findIndex(s=>s.minFilter===t.minFilter&&s.magFilter===t.magFilter&&s.wrapS===t.wrapS&&s.wrapT===t.wrapT);return r!==-1?r:(i.push(t),i.length-1)}}Ki._DielectricSpecular=new ge(.04,.04,.04);Ki._MaxSpecularPower=1024;Ki._Epsilon=1e-6;const DB=H.Compose(new x(-1,1,1),oe.Identity(),x.Zero());class $i{_applyExtension(e,t,i,r){if(i>=t.length)return Promise.resolve(e);const s=r(t[i],e);return s?s.then(n=>this._applyExtension(n,t,i+1,r)):this._applyExtension(e,t,i+1,r)}_applyExtensions(e,t){const i=[];for(const r of $i._ExtensionNames)i.push(this._extensions[r]);return this._applyExtension(e,i,0,t)}_extensionsPreExportTextureAsync(e,t,i){return this._applyExtensions(t,(r,s)=>r.preExportTextureAsync&&r.preExportTextureAsync(e,s,i))}_extensionsPostExportMeshPrimitiveAsync(e,t,i,r){return this._applyExtensions(t,(s,n)=>s.postExportMeshPrimitiveAsync&&s.postExportMeshPrimitiveAsync(e,n,i,r))}_extensionsPostExportNodeAsync(e,t,i,r,s){return this._applyExtensions(t,(n,a)=>n.postExportNodeAsync&&n.postExportNodeAsync(e,a,i,r,s))}_extensionsPostExportMaterialAsync(e,t,i){return this._applyExtensions(t,(r,s)=>r.postExportMaterialAsync&&r.postExportMaterialAsync(e,s,i))}_extensionsPostExportMaterialAdditionalTextures(e,t,i){const r=[];for(const s of $i._ExtensionNames){const n=this._extensions[s];n.postExportMaterialAdditionalTextures&&r.push(...n.postExportMaterialAdditionalTextures(e,t,i))}return r}_extensionsPostExportTextures(e,t,i){for(const r of $i._ExtensionNames){const s=this._extensions[r];s.postExportTexture&&s.postExportTexture(e,t,i)}}_forEachExtensions(e){for(const t of $i._ExtensionNames){const i=this._extensions[t];i.enabled&&e(i)}}_extensionsOnExporting(){this._forEachExtensions(e=>{e.wasUsed&&(this._glTF.extensionsUsed==null&&(this._glTF.extensionsUsed=[]),this._glTF.extensionsUsed.indexOf(e.name)===-1&&this._glTF.extensionsUsed.push(e.name),e.required&&(this._glTF.extensionsRequired==null&&(this._glTF.extensionsRequired=[]),this._glTF.extensionsRequired.indexOf(e.name)===-1&&this._glTF.extensionsRequired.push(e.name)),this._glTF.extensions==null&&(this._glTF.extensions={}),e.onExporting&&e.onExporting())})}_loadExtensions(){for(const e of $i._ExtensionNames){const t=$i._ExtensionFactories[e](this);this._extensions[e]=t}}constructor(e,t){this._includeCoordinateSystemConversionNodes=!1,this._extensions={},this._glTF={asset:{generator:`Babylon.js v${q.Version}`,version:"2.0"}},e=e||qe.LastCreatedScene,e&&(this._babylonScene=e,this._bufferViews=[],this._accessors=[],this._meshes=[],this._scenes=[],this._cameras=[],this._nodes=[],this._images=[],this._materials=[],this._materialMap=[],this._textures=[],this._samplers=[],this._skins=[],this._animations=[],this._imageData={},this._orderedImageData=[],this._options=t||{},this._animationSampleRate=t&&t.animationSampleRate?t.animationSampleRate:1/60,this._includeCoordinateSystemConversionNodes=!!(t&&t.includeCoordinateSystemConversionNodes),this._glTFMaterialExporter=new Ki(this),this._loadExtensions())}dispose(){for(const e in this._extensions)this._extensions[e].dispose()}get options(){return this._options}static RegisterExtension(e,t){$i.UnregisterExtension(e)&&J.Warn(`Extension with the name ${e} already exists`),$i._ExtensionFactories[e]=t,$i._ExtensionNames.push(e)}static UnregisterExtension(e){if(!$i._ExtensionFactories[e])return!1;delete $i._ExtensionFactories[e];const t=$i._ExtensionNames.indexOf(e);return t!==-1&&$i._ExtensionNames.splice(t,1),!0}_reorderIndicesBasedOnPrimitiveMode(e,t,i,r,s){switch(t){case me.TriangleFillMode:{r||(r=0);for(let n=e.indexStart,a=e.indexStart+e.indexCount;n<a;n=n+3){const l=r+n*4,c=s.getUInt32(l+4),h=s.getUInt32(l+8);s.setUInt32(h,l+4),s.setUInt32(c,l+8)}break}case me.TriangleFanDrawMode:{for(let n=e.indexStart+e.indexCount-1,a=e.indexStart;n>=a;--n)s.setUInt32(i[n],r),r+=4;break}case me.TriangleStripDrawMode:{e.indexCount>=3&&(s.setUInt32(i[e.indexStart+2],r+4),s.setUInt32(i[e.indexStart+1],r+8));break}}}_reorderVertexAttributeDataBasedOnPrimitiveMode(e,t,i,r,s,n,a,l){if(l&&i===me.ClockWiseSideOrientation)switch(t){case me.TriangleFillMode:{this._reorderTriangleFillMode(e,t,i,r,s,n,a,l);break}case me.TriangleStripDrawMode:{this._reorderTriangleStripDrawMode(e,t,i,r,s,n,a,l);break}case me.TriangleFanDrawMode:{this._reorderTriangleFanMode(e,t,i,r,s,n,a,l);break}}}_reorderTriangleFillMode(e,t,i,r,s,n,a,l){const c=this._getVertexBufferFromMesh(r,e.getMesh());if(c){const h=c.byteStride/O.GetTypeByteLength(c.type);if(e.verticesCount%3!==0)J.Error("The submesh vertices for the triangle fill mode is not divisible by 3!");else{const u=[];let d=0;switch(r){case O.PositionKind:case O.NormalKind:{for(let f=e.verticesStart;f<e.verticesStart+e.verticesCount;f=f+3)d=f*h,u.push(x.FromArray(s,d)),u.push(x.FromArray(s,d+2*h)),u.push(x.FromArray(s,d+h));break}case O.TangentKind:{for(let f=e.verticesStart;f<e.verticesStart+e.verticesCount;f=f+3)d=f*h,u.push(Tt.FromArray(s,d)),u.push(Tt.FromArray(s,d+2*h)),u.push(Tt.FromArray(s,d+h));break}case O.ColorKind:{const f=c.getSize();for(let _=e.verticesStart;_<e.verticesStart+e.verticesCount;_=_+f)d=_*h,f===4?(u.push(Tt.FromArray(s,d)),u.push(Tt.FromArray(s,d+2*h)),u.push(Tt.FromArray(s,d+h))):(u.push(x.FromArray(s,d)),u.push(x.FromArray(s,d+2*h)),u.push(x.FromArray(s,d+h)));break}case O.UVKind:case O.UV2Kind:{for(let f=e.verticesStart;f<e.verticesStart+e.verticesCount;f=f+3)d=f*h,u.push(Ie.FromArray(s,d)),u.push(Ie.FromArray(s,d+2*h)),u.push(Ie.FromArray(s,d+h));break}default:J.Error(`Unsupported Vertex Buffer type: ${r}`)}this._writeVertexAttributeData(u,n,r,s,a,l)}}else J.Warn(`reorderTriangleFillMode: Vertex Buffer Kind ${r} not present!`)}_reorderTriangleStripDrawMode(e,t,i,r,s,n,a,l){const c=this._getVertexBufferFromMesh(r,e.getMesh());if(c){const h=c.byteStride/O.GetTypeByteLength(c.type),u=[];let d=0;switch(r){case O.PositionKind:case O.NormalKind:{d=e.verticesStart,u.push(x.FromArray(s,d+2*h)),u.push(x.FromArray(s,d+h));break}case O.TangentKind:{for(let f=e.verticesStart+e.verticesCount-1;f>=e.verticesStart;--f)d=f*h,u.push(Tt.FromArray(s,d));break}case O.ColorKind:{for(let f=e.verticesStart+e.verticesCount-1;f>=e.verticesStart;--f)d=f*h,c.getSize()===4?u.push(Tt.FromArray(s,d)):u.push(x.FromArray(s,d));break}case O.UVKind:case O.UV2Kind:{for(let f=e.verticesStart+e.verticesCount-1;f>=e.verticesStart;--f)d=f*h,u.push(Ie.FromArray(s,d));break}default:J.Error(`Unsupported Vertex Buffer type: ${r}`)}this._writeVertexAttributeData(u,n+12,r,s,a,l)}else J.Warn(`reorderTriangleStripDrawMode: Vertex buffer kind ${r} not present!`)}_reorderTriangleFanMode(e,t,i,r,s,n,a,l){const c=this._getVertexBufferFromMesh(r,e.getMesh());if(c){const h=c.byteStride/O.GetTypeByteLength(c.type),u=[];let d=0;switch(r){case O.PositionKind:case O.NormalKind:{for(let f=e.verticesStart+e.verticesCount-1;f>=e.verticesStart;--f)d=f*h,u.push(x.FromArray(s,d));break}case O.TangentKind:{for(let f=e.verticesStart+e.verticesCount-1;f>=e.verticesStart;--f)d=f*h,u.push(Tt.FromArray(s,d));break}case O.ColorKind:{for(let f=e.verticesStart+e.verticesCount-1;f>=e.verticesStart;--f)d=f*h,u.push(Tt.FromArray(s,d)),c.getSize()===4?u.push(Tt.FromArray(s,d)):u.push(x.FromArray(s,d));break}case O.UVKind:case O.UV2Kind:{for(let f=e.verticesStart+e.verticesCount-1;f>=e.verticesStart;--f)d=f*h,u.push(Ie.FromArray(s,d));break}default:J.Error(`Unsupported Vertex Buffer type: ${r}`)}this._writeVertexAttributeData(u,n,r,s,a,l)}else J.Warn(`reorderTriangleFanMode: Vertex buffer kind ${r} not present!`)}_writeVertexAttributeData(e,t,i,r,s,n){for(const a of e){n&&i!==O.ColorKind&&!(a instanceof Ie)&&(a instanceof x?i===O.NormalKind?Vt._GetRightHandedNormalVector3FromRef(a):i===O.PositionKind?Vt._GetRightHandedPositionVector3FromRef(a):J.Error("Unsupported vertex attribute kind!"):Vt._GetRightHandedVector4FromRef(a)),i===O.NormalKind?a.normalize():i===O.TangentKind&&a instanceof Tt&&Vt._NormalizeTangentFromRef(a);for(const l of a.asArray())s.setFloat32(l,t),t+=4}}_writeAttributeData(e,t,i,r,s,n,a){let l=[],c;switch(e){case O.PositionKind:{for(let u=0,d=i.length/r;u<d;++u){c=u*r;const f=x.FromArray(i,c);n&&Vt._GetRightHandedPositionVector3FromRef(f),l.push(f.asArray())}break}case O.NormalKind:{for(let u=0,d=i.length/r;u<d;++u){c=u*r;const f=x.FromArray(i,c);n&&Vt._GetRightHandedNormalVector3FromRef(f),f.normalize(),l.push(f.asArray())}break}case O.TangentKind:{for(let u=0,d=i.length/r;u<d;++u){c=u*r;const f=Tt.FromArray(i,c);n&&Vt._GetRightHandedVector4FromRef(f),Vt._NormalizeTangentFromRef(f),l.push(f.asArray())}break}case O.ColorKind:{const u=a.material,d=u?u.getClassName()==="StandardMaterial":!0,f=r===3?new ge:new Ye;for(let _=0,p=i.length/r;_<p;++_)c=_*r,r===3?(ge.FromArrayToRef(i,c,f),d&&f.toLinearSpaceToRef(f)):(Ye.FromArrayToRef(i,c,f),d&&f.toLinearSpaceToRef(f)),l.push(f.asArray());break}case O.UVKind:case O.UV2Kind:{for(let u=0,d=i.length/r;u<d;++u)c=u*r,l.push(n?[i[c],i[c+1]]:[i[c],i[c+1]]);break}case O.MatricesIndicesKind:case O.MatricesIndicesExtraKind:{for(let u=0,d=i.length/r;u<d;++u){c=u*r;const f=Tt.FromArray(i,c);l.push(f.asArray())}break}case O.MatricesWeightsKind:case O.MatricesWeightsExtraKind:{for(let u=0,d=i.length/r;u<d;++u){c=u*r;const f=Tt.FromArray(i,c);l.push(f.asArray())}break}default:J.Warn("Unsupported Vertex Buffer Type: "+e),l=[]}let h;switch(t){case 5121:{h=s.setUInt8.bind(s);break}case 5123:{h=s.setUInt16.bind(s);break}case 5125:{h=s.setUInt32.bind(s);break}case 5126:{h=s.setFloat32.bind(s);break}default:{J.Warn("Unsupported Attribute Component kind: "+t);return}}for(const u of l)for(const d of u)h(d)}writeMorphTargetAttributeData(e,t,i,r,s,n,a,l,c,h){let u=[],d,f=new x,_=new Tt(0,0,0,0);switch(e){case O.PositionKind:{for(let m=i.verticesStart;m<i.verticesCount;++m){d=i.indexStart+m*a;const T=x.FromArray(s,d);f=x.FromArray(n,d).subtractToRef(T,f),c&&Vt._GetRightHandedPositionVector3FromRef(f),h&&(h.min.copyFromFloats(Math.min(f.x,h.min.x),Math.min(f.y,h.min.y),Math.min(f.z,h.min.z)),h.max.copyFromFloats(Math.max(f.x,h.max.x),Math.max(f.y,h.max.y),Math.max(f.z,h.max.z))),u.push(f.asArray())}break}case O.NormalKind:{for(let m=i.verticesStart;m<i.verticesCount;++m){d=i.indexStart+m*a;const T=x.FromArray(s,d);T.normalize();const b=x.FromArray(n,d);b.normalize(),f=b.subtractToRef(T,f),c&&Vt._GetRightHandedNormalVector3FromRef(f),u.push(f.asArray())}break}case O.TangentKind:{for(let m=i.verticesStart;m<i.verticesCount;++m){d=i.indexStart+m*(a+1);const T=Tt.FromArray(s,d);Vt._NormalizeTangentFromRef(T);const b=Tt.FromArray(n,d);Vt._NormalizeTangentFromRef(b),_=b.subtractToRef(T,_),c&&Vt._GetRightHandedVector4FromRef(_),u.push([_.x,_.y,_.z])}break}default:J.Warn("Unsupported Vertex Buffer Type: "+e),u=[]}let p;switch(t){case 5121:{p=l.setUInt8.bind(l);break}case 5123:{p=l.setUInt16.bind(l);break}case 5125:{p=l.setUInt32.bind(l);break}case 5126:{p=l.setFloat32.bind(l);break}default:{J.Warn("Unsupported Attribute Component kind: "+t);return}}for(const m of u)for(const T of m)p(T)}_generateJSON(e,t,i){const r={byteLength:this._totalByteLength};let s,n,a,l=this._totalByteLength;return r.byteLength&&(this._glTF.buffers=[r]),this._nodes&&this._nodes.length&&(this._glTF.nodes=this._nodes),this._meshes&&this._meshes.length&&(this._glTF.meshes=this._meshes),this._scenes&&this._scenes.length&&(this._glTF.scenes=this._scenes,this._glTF.scene=0),this._cameras&&this._cameras.length&&(this._glTF.cameras=this._cameras),this._bufferViews&&this._bufferViews.length&&(this._glTF.bufferViews=this._bufferViews),this._accessors&&this._accessors.length&&(this._glTF.accessors=this._accessors),this._animations&&this._animations.length&&(this._glTF.animations=this._animations),this._materials&&this._materials.length&&(this._glTF.materials=this._materials),this._textures&&this._textures.length&&(this._glTF.textures=this._textures),this._samplers&&this._samplers.length&&(this._glTF.samplers=this._samplers),this._skins&&this._skins.length&&(this._glTF.skins=this._skins),this._images&&this._images.length&&(e?(this._glTF.images=[],this._images.forEach(h=>{h.uri&&(n=this._imageData[h.uri],this._orderedImageData.push(n),s=h.uri.split(".")[0]+" image",a=Vt._CreateBufferView(0,l,n.data.byteLength,void 0,s),l+=n.data.byteLength,this._bufferViews.push(a),h.bufferView=this._bufferViews.length-1,h.name=s,h.mimeType=n.mimeType,h.uri=void 0,this._glTF.images||(this._glTF.images=[]),this._glTF.images.push(h))}),r.byteLength=l):this._glTF.images=this._images),e||(r.uri=t+".bin"),i?JSON.stringify(this._glTF,null,2):JSON.stringify(this._glTF)}_generateGLTFAsync(e,t=!0){return this._generateBinaryAsync().then(i=>{this._extensionsOnExporting();const r=this._generateJSON(!1,e,!0),s=new Blob([i],{type:"application/octet-stream"}),n=e+".gltf",a=e+".bin",l=new Dx;if(l.glTFFiles[n]=r,l.glTFFiles[a]=s,this._imageData)for(const c in this._imageData)l.glTFFiles[c]=new Blob([this._imageData[c].data],{type:this._imageData[c].mimeType});return t&&this.dispose(),l})}_generateBinaryAsync(){const e=new NB(4);return this._createSceneAsync(this._babylonScene,e).then(()=>(this._localEngine&&this._localEngine.dispose(),e.getArrayBuffer()))}_getPadding(e){const t=e%4;return t===0?t:4-t}_generateGLBAsync(e,t=!0){return this._generateBinaryAsync().then(i=>{this._extensionsOnExporting();const r=this._generateJSON(!0),s=e+".glb",n=12,a=8;let l=r.length,c,h=0;typeof TextEncoder<"u"&&(c=new TextEncoder().encode(r),l=c.length);for(let he=0;he<this._orderedImageData.length;++he)h+=this._orderedImageData[he].data.byteLength;const u=this._getPadding(l),d=this._getPadding(i.byteLength),f=this._getPadding(h),_=n+2*a+l+u+i.byteLength+d+h+f,p=new ArrayBuffer(n),m=new DataView(p);m.setUint32(0,1179937895,!0),m.setUint32(4,2,!0),m.setUint32(8,_,!0);const T=new ArrayBuffer(a+l+u),b=new DataView(T);b.setUint32(0,l+u,!0),b.setUint32(4,1313821514,!0);const y=new Uint8Array(T,a);if(c)y.set(c);else{const he="_".charCodeAt(0);for(let _e=0;_e<l;++_e){const ne=r.charCodeAt(_e);ne!=r.codePointAt(_e)?y[_e]=he:y[_e]=ne}}const S=new Uint8Array(T,a+l);for(let he=0;he<u;++he)S[he]=32;const C=new ArrayBuffer(a),I=new DataView(C);I.setUint32(0,i.byteLength+h+f,!0),I.setUint32(4,5130562,!0);const P=new ArrayBuffer(d),D=new Uint8Array(P);for(let he=0;he<d;++he)D[he]=0;const w=new ArrayBuffer(f),L=new Uint8Array(w);for(let he=0;he<f;++he)L[he]=0;const U=[p,T,C,i];for(let he=0;he<this._orderedImageData.length;++he)U.push(this._orderedImageData[he].data);U.push(P),U.push(w);const G=new Blob(U,{type:"application/octet-stream"}),Z=new Dx;return Z.glTFFiles[s]=G,this._localEngine!=null&&this._localEngine.dispose(),t&&this.dispose(),Z})}_setNodeTransformation(e,t,i){t.getPivotPoint().equalsToFloats(0,0,0)||J.Warn("Pivot points are not supported in the glTF serializer"),t.position.equalsToFloats(0,0,0)||(e.translation=i?Vt._GetRightHandedPositionVector3(t.position).asArray():t.position.asArray()),t.scaling.equalsToFloats(1,1,1)||(e.scale=t.scaling.asArray());const r=oe.RotationYawPitchRoll(t.rotation.y,t.rotation.x,t.rotation.z);t.rotationQuaternion&&r.multiplyInPlace(t.rotationQuaternion),oe.IsIdentity(r)||(i&&Vt._GetRightHandedQuaternionFromRef(r),e.rotation=r.normalize().asArray())}_setCameraTransformation(e,t,i){t.position.equalsToFloats(0,0,0)||(e.translation=i?Vt._GetRightHandedPositionVector3(t.position).asArray():t.position.asArray());const r=t.rotationQuaternion;r&&!oe.IsIdentity(r)&&(i&&Vt._GetRightHandedQuaternionFromRef(r),e.rotation=r.normalize().asArray())}_getVertexBufferFromMesh(e,t){if(t.isVerticesDataPresent(e)){const i=t.getVertexBuffer(e);if(i)return i}return null}_createBufferViewKind(e,t,i,r,s,n){const a=i instanceof K?i:i instanceof $c?i.sourceMesh:null;if(a){const l=a.getVertexBuffer(e),c=a.getVerticesData(e);if(l&&c){const h=O.GetTypeByteLength(t),u=c.length*h,d=Vt._CreateBufferView(0,r.getByteOffset(),u,s,e+" - "+a.name);this._bufferViews.push(d),this._writeAttributeData(e,t,c,s/h,r,n,i)}}}_setMorphTargetAttributes(e,t,i,r,s){if(i){t.targets||(t.targets=[]);const n={};if(i.hasNormals){const a=e.getMesh().getVerticesData(O.NormalKind),l=i.getNormals(),c=e.verticesCount,h=12,u=c*h,d=Vt._CreateBufferView(0,r.getByteOffset(),u,h,i.name+"_NORMAL");this._bufferViews.push(d);const f=this._bufferViews.length-1,_=Vt._CreateAccessor(f,i.name+" - NORMAL","VEC3",5126,c,0,null,null);this._accessors.push(_),n.NORMAL=this._accessors.length-1,this.writeMorphTargetAttributeData(O.NormalKind,5126,e,i,a,l,h/4,r,s)}if(i.hasPositions){const a=e.getMesh().getVerticesData(O.PositionKind),l=i.getPositions(),c=e.verticesCount,h=12,u=c*h,d=Vt._CreateBufferView(0,r.getByteOffset(),u,h,i.name+"_POSITION");this._bufferViews.push(d);const f=this._bufferViews.length-1,_={min:new x(1/0,1/0,1/0),max:new x(-1/0,-1/0,-1/0)},p=Vt._CreateAccessor(f,i.name+" - POSITION","VEC3",5126,c,0,null,null);this._accessors.push(p),n.POSITION=this._accessors.length-1,this.writeMorphTargetAttributeData(O.PositionKind,5126,e,i,a,l,h/4,r,s,_),p.min=_.min.asArray(),p.max=_.max.asArray()}if(i.hasTangents){const a=e.getMesh().getVerticesData(O.TangentKind),l=i.getTangents(),c=e.verticesCount,h=12,u=c*h,d=Vt._CreateBufferView(0,r.getByteOffset(),u,h,i.name+"_NORMAL");this._bufferViews.push(d);const f=this._bufferViews.length-1,_=Vt._CreateAccessor(f,i.name+" - TANGENT","VEC3",5126,c,0,null,null);this._accessors.push(_),n.TANGENT=this._accessors.length-1,this.writeMorphTargetAttributeData(O.TangentKind,5126,e,i,a,l,h/4,r,s)}t.targets.push(n)}}_getMeshPrimitiveMode(e){return e instanceof Eo?me.LineListDrawMode:e.material?e.material.fillMode:me.TriangleFillMode}_setPrimitiveMode(e,t){switch(t){case me.TriangleFillMode:break;case me.TriangleStripDrawMode:{e.mode=5;break}case me.TriangleFanDrawMode:{e.mode=6;break}case me.PointListDrawMode:{e.mode=0;break}case me.PointFillMode:{e.mode=0;break}case me.LineLoopDrawMode:{e.mode=2;break}case me.LineListDrawMode:{e.mode=1;break}case me.LineStripDrawMode:{e.mode=3;break}}}_setAttributeKind(e,t){switch(t){case O.PositionKind:{e.attributes.POSITION=this._accessors.length-1;break}case O.NormalKind:{e.attributes.NORMAL=this._accessors.length-1;break}case O.ColorKind:{e.attributes.COLOR_0=this._accessors.length-1;break}case O.TangentKind:{e.attributes.TANGENT=this._accessors.length-1;break}case O.UVKind:{e.attributes.TEXCOORD_0=this._accessors.length-1;break}case O.UV2Kind:{e.attributes.TEXCOORD_1=this._accessors.length-1;break}case O.MatricesIndicesKind:{e.attributes.JOINTS_0=this._accessors.length-1;break}case O.MatricesIndicesExtraKind:{e.attributes.JOINTS_1=this._accessors.length-1;break}case O.MatricesWeightsKind:{e.attributes.WEIGHTS_0=this._accessors.length-1;break}case O.MatricesWeightsExtraKind:{e.attributes.WEIGHTS_1=this._accessors.length-1;break}default:J.Warn("Unsupported Vertex Buffer Type: "+t)}}_setPrimitiveAttributesAsync(e,t,i,r){var s;const n=[];let a=null,l,c;t instanceof K?a=t:t instanceof $c&&(a=t.sourceMesh);const h=[{kind:O.PositionKind,accessorType:"VEC3",accessorComponentType:5126,byteStride:12},{kind:O.NormalKind,accessorType:"VEC3",accessorComponentType:5126,byteStride:12},{kind:O.ColorKind,accessorType:"VEC4",accessorComponentType:5126,byteStride:16},{kind:O.TangentKind,accessorType:"VEC4",accessorComponentType:5126,byteStride:16},{kind:O.UVKind,accessorType:"VEC2",accessorComponentType:5126,byteStride:8},{kind:O.UV2Kind,accessorType:"VEC2",accessorComponentType:5126,byteStride:8},{kind:O.MatricesIndicesKind,accessorType:"VEC4",accessorComponentType:5123,byteStride:8},{kind:O.MatricesIndicesExtraKind,accessorType:"VEC4",accessorComponentType:5123,byteStride:8},{kind:O.MatricesWeightsKind,accessorType:"VEC4",accessorComponentType:5126,byteStride:16},{kind:O.MatricesWeightsExtraKind,accessorType:"VEC4",accessorComponentType:5126,byteStride:16}];if(a){let u=null;const d=this._getMeshPrimitiveMode(a),f={},_=a.morphTargetManager;for(const p of h){const m=p.kind,T=p.accessorComponentType;if(a.isVerticesDataPresent(m)){const b=this._getVertexBufferFromMesh(m,a);p.byteStride=b?b.getSize()*O.GetTypeByteLength(p.accessorComponentType):O.DeduceStride(m)*4,p.byteStride===12&&(p.accessorType="VEC3"),this._createBufferViewKind(m,T,t,i,p.byteStride,r),p.bufferViewIndex=this._bufferViews.length-1,f[m]=p.bufferViewIndex}}if(a.getTotalIndices()){const p=a.getIndices();if(p){const m=p.length*4;l=Vt._CreateBufferView(0,i.getByteOffset(),m,void 0,"Indices - "+a.name),this._bufferViews.push(l),u=this._bufferViews.length-1;for(let T=0,b=p.length;T<b;++T)i.setUInt32(p[T])}}if(a.subMeshes)for(const p of a.subMeshes){let m=p.getMaterial()||a.getScene().defaultMaterial,T=null;if(m)if(a instanceof Eo){const S={name:a.name+" material"};(!a.color.equals(ge.White())||a.alpha<1)&&(S.pbrMetallicRoughness={baseColorFactor:a.color.asArray().concat([a.alpha])}),this._materials.push(S),T=this._materials.length-1}else if(m instanceof $a){const S=m.subMaterials[p.materialIndex];S&&(m=S,T=this._materialMap[m.uniqueId])}else T=this._materialMap[m.uniqueId];const b=T!=null?this._materials[T]:null,y={attributes:{}};this._setPrimitiveMode(y,d);for(const S of h){const C=S.kind;if((C===O.UVKind||C===O.UV2Kind)&&!this._options.exportUnusedUVs&&(!b||!this._glTFMaterialExporter._hasTexturesPresent(b)))continue;const I=a.getVerticesData(C);if(I){const P=this._getVertexBufferFromMesh(C,a);if(P){const D=P.getSize(),w=S.bufferViewIndex;if(w!=null){c={min:null,max:null},C==O.PositionKind&&(c=Vt._CalculateMinMaxPositions(I,0,I.length/D,r));const L=Vt._CreateAccessor(w,C+" - "+t.name,S.accessorType,S.accessorComponentType,I.length/D,0,c.min,c.max);this._accessors.push(L),this._setAttributeKind(y,C)}}}}if(u){const S=Vt._CreateAccessor(u,"indices - "+t.name,"SCALAR",5125,p.indexCount,p.indexStart*4,null,null);this._accessors.push(S),y.indices=this._accessors.length-1}if(T!=null&&Object.keys(y.attributes).length>0){const S=a.overrideMaterialSideOrientation!==null?a.overrideMaterialSideOrientation:m.sideOrientation;if(S==me.ClockWiseSideOrientation&&this._babylonScene.useRightHandedSystem||S==me.ClockWiseSideOrientation&&r&&a.overrideMaterialSideOrientation!==((s=a.material)===null||s===void 0?void 0:s.sideOrientation)){let C=u!=null?this._bufferViews[u].byteOffset:null;C==null&&(C=0);let I=null;if(u!=null&&(I=a.getIndices()),I)this._reorderIndicesBasedOnPrimitiveMode(p,d,I,C,i);else for(const P of h){const D=a.getVerticesData(P.kind);if(D){let w=this._bufferViews[f[P.kind]].byteOffset;w||(w=0),this._reorderVertexAttributeDataBasedOnPrimitiveMode(p,d,S,P.kind,D,w,i,r)}}}y.material=T}if(_){let S;for(let C=0;C<_.numTargets;++C)S=_.getTarget(C),this._setMorphTargetAttributes(p,y,S,i,r)}e.primitives.push(y),this._extensionsPostExportMeshPrimitiveAsync("postExport",y,p,i),n.push()}}return Promise.all(n).then(()=>{})}_isBabylonCoordinateSystemConvertingNode(e){return e instanceof gt?!(!e.getWorldMatrix().multiplyToRef(DB,j.Matrix[0]).isIdentity()||e instanceof K&&e.geometry!==null||e instanceof $c&&e.sourceMesh.geometry!==null):!1}_createSceneAsync(e,t){const i={nodes:[]};let r,s,n;const a=[...e.transformNodes,...e.meshes,...e.lights,...e.cameras],l=[];this._convertToRightHandedSystem=!e.useRightHandedSystem,this._convertToRightHandedSystemMap={},e.metadata&&(this._options.metadataSelector?i.extras=this._options.metadataSelector(e.metadata):e.metadata.gltf&&(i.extras=e.metadata.gltf.extras)),e.rootNodes.forEach(d=>{this._convertToRightHandedSystemMap[d.uniqueId]=this._convertToRightHandedSystem,d.getDescendants(!1).forEach(f=>{this._convertToRightHandedSystemMap[f.uniqueId]=this._convertToRightHandedSystem})}),e.rootNodes.forEach(d=>{if(!this._includeCoordinateSystemConversionNodes&&this._isBabylonCoordinateSystemConvertingNode(d)){l.push(d);const f=a.indexOf(d);f!==-1&&a.splice(f,1),d.getDescendants(!1).forEach(_=>{this._convertToRightHandedSystemMap[_.uniqueId]=!1})}});const c=new Map;e.cameras.forEach(d=>{if(!this._options.shouldExportNode||this._options.shouldExportNode(d)){const f={type:d.mode===Ve.PERSPECTIVE_CAMERA?"perspective":"orthographic"};if(d.name&&(f.name=d.name),f.type==="perspective")f.perspective={aspectRatio:d.getEngine().getAspectRatio(d),yfov:d.fovMode===Ve.FOVMODE_VERTICAL_FIXED?d.fov:d.fov*d.getEngine().getAspectRatio(d),znear:d.minZ,zfar:d.maxZ};else if(f.type==="orthographic"){const _=d.orthoLeft&&d.orthoRight?.5*(d.orthoRight-d.orthoLeft):d.getEngine().getRenderWidth()*.5,p=d.orthoBottom&&d.orthoTop?.5*(d.orthoTop-d.orthoBottom):d.getEngine().getRenderHeight()*.5;f.orthographic={xmag:_,ymag:p,znear:d.minZ,zfar:d.maxZ}}c.set(d,this._cameras.length),this._cameras.push(f)}});const[h,u]=this._getExportNodes(a);return this._glTFMaterialExporter._convertMaterialsToGLTFAsync(u,"image/png",!0).then(()=>this._createNodeMapAndAnimationsAsync(e,h,t).then(d=>this._createSkinsAsync(e,d,t).then(f=>{if(this._nodeMap=d,this._totalByteLength=t.getByteOffset(),this._totalByteLength==null)throw new Error("undefined byte length!");for(const _ of a)if(r=this._nodeMap[_.uniqueId],r!==void 0){if(s=this._nodes[r],_.metadata&&(this._options.metadataSelector?s.extras=this._options.metadataSelector(_.metadata):_.metadata.gltf&&(s.extras=_.metadata.gltf.extras)),_ instanceof Ve&&(s.camera=c.get(_)),(!_.parent||l.indexOf(_.parent)!==-1)&&(this._options.shouldExportNode&&!this._options.shouldExportNode(_)?J.Log("Omitting "+_.name+" from scene."):(this._convertToRightHandedSystemMap[_.uniqueId]&&(s.translation&&(s.translation[2]*=-1,s.translation[0]*=-1),s.rotation=s.rotation?oe.FromArray([0,1,0,0]).multiply(oe.FromArray(s.rotation)).asArray():oe.FromArray([0,1,0,0]).asArray()),i.nodes.push(r))),_ instanceof K){const p=_;p.skeleton&&(s.skin=f[p.skeleton.uniqueId])}if(n=_.getDescendants(!0),!s.children&&n&&n.length){const p=[];for(const m of n)this._nodeMap[m.uniqueId]!=null&&p.push(this._nodeMap[m.uniqueId]);p.length&&(s.children=p)}}i.nodes.length&&this._scenes.push(i)})))}_getExportNodes(e){const t=[],i=new Set;for(const r of e)if(!this._options.shouldExportNode||this._options.shouldExportNode(r)){t.push(r);const s=r;if(s.subMeshes&&s.subMeshes.length>0){const n=s.material||s.getScene().defaultMaterial;if(n instanceof $a)for(const a of n.subMaterials)a&&i.add(a);else i.add(n)}}else`${r.name}`;return[t,i]}_createNodeMapAndAnimationsAsync(e,t,i){let r=Promise.resolve();const s={};let n;const a={name:"runtime animations",channels:[],samplers:[]},l=[];for(const c of t)r=r.then(()=>{const h=this._convertToRightHandedSystemMap[c.uniqueId];return this._createNodeAsync(c,i,h).then(u=>{const d=this._extensionsPostExportNodeAsync("createNodeAsync",u,c,s,i);return d==null?(J.Warn(`Not exporting node ${c.name}`),Promise.resolve()):d.then(f=>{f&&(this._nodes.push(f),n=this._nodes.length-1,s[c.uniqueId]=n,e.animationGroups.length||(hr._CreateMorphTargetAnimationFromMorphTargetAnimations(c,a,l,s,this._nodes,i,this._bufferViews,this._accessors,h,this._animationSampleRate),c.animations.length&&hr._CreateNodeAnimationFromNodeAnimations(c,a,l,s,this._nodes,i,this._bufferViews,this._accessors,h,this._animationSampleRate)))})})});return r.then(()=>(a.channels.length&&a.samplers.length&&this._animations.push(a),l.forEach(c=>{c.channels.length&&c.samplers.length&&this._animations.push(c)}),e.animationGroups.length&&hr._CreateNodeAndMorphAnimationFromAnimationGroups(e,this._animations,s,this._nodes,i,this._bufferViews,this._accessors,this._convertToRightHandedSystemMap,this._animationSampleRate),s))}_createNodeAsync(e,t,i){return Promise.resolve().then(()=>{const r={},s={primitives:[]};if(e.name&&(r.name=e.name),e instanceof gt){if(this._setNodeTransformation(r,e,i),e instanceof K){const n=e.morphTargetManager;if(n&&n.numTargets>0){s.weights=[];for(let a=0;a<n.numTargets;++a)s.weights.push(n.getTarget(a).influence)}}return this._setPrimitiveAttributesAsync(s,e,t,i).then(()=>(s.primitives.length&&(this._meshes.push(s),r.mesh=this._meshes.length-1),r))}else return e instanceof Ve&&this._setCameraTransformation(r,e,i),r})}_createSkinsAsync(e,t,i){var r;const s=Promise.resolve(),n={};for(const a of e.skeletons){if(a.bones.length<=0)continue;const l={joints:[]},c=[],h={};let u=-1;for(let y=0;y<a.bones.length;++y){const S=a.bones[y],C=(r=S.getIndex())!==null&&r!==void 0?r:y;C!==-1&&(h[C]=S,C>u&&(u=C))}for(let y=0;y<=u;++y){const S=h[y];c.push(S.getInvertedAbsoluteTransform());const C=S.getTransformNode();C?l.joints.push(t[C.uniqueId]):J.Warn("Exporting a bone without a linked transform node is currently unsupported")}const d=64,f=c.length*d,_=i.getByteOffset(),p=Vt._CreateBufferView(0,_,f,void 0,"InverseBindMatrices - "+a.name);this._bufferViews.push(p);const m=this._bufferViews.length-1,T=Vt._CreateAccessor(m,"InverseBindMatrices - "+a.name,"MAT4",5126,c.length,null,null,null),b=this._accessors.push(T)-1;l.inverseBindMatrices=b,this._skins.push(l),n[a.uniqueId]=this._skins.length-1,c.forEach(y=>{y.m.forEach(S=>{i.setFloat32(S)})})}return s.then(()=>n)}}$i._ExtensionNames=new Array;$i._ExtensionFactories={};class NB{constructor(e){this._arrayBuffer=new ArrayBuffer(e),this._dataView=new DataView(this._arrayBuffer),this._byteOffset=0}_resizeBuffer(e){const t=new ArrayBuffer(e),i=Math.min(this._arrayBuffer.byteLength,e),r=new Uint8Array(this._arrayBuffer,0,i);return new Uint8Array(t).set(r,0),this._arrayBuffer=t,this._dataView=new DataView(this._arrayBuffer),t}getArrayBuffer(){return this._resizeBuffer(this.getByteOffset())}getByteOffset(){if(this._byteOffset==null)throw new Error("Byte offset is undefined!");return this._byteOffset}setUInt8(e,t){t!=null?t<this._byteOffset?this._dataView.setUint8(t,e):J.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+1>this._arrayBuffer.byteLength&&this._resizeBuffer(this._arrayBuffer.byteLength*2),this._dataView.setUint8(this._byteOffset,e),this._byteOffset+=1)}setUInt16(e,t){t!=null?t<this._byteOffset?this._dataView.setUint16(t,e,!0):J.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+2>this._arrayBuffer.byteLength&&this._resizeBuffer(this._arrayBuffer.byteLength*2),this._dataView.setUint16(this._byteOffset,e,!0),this._byteOffset+=2)}getUInt32(e){if(e<this._byteOffset)return this._dataView.getUint32(e,!0);throw J.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"),new Error("BinaryWriter: byteoffset is greater than the current binary buffer length!")}getVector3Float32FromRef(e,t){t+8>this._byteOffset?J.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(e.x=this._dataView.getFloat32(t,!0),e.y=this._dataView.getFloat32(t+4,!0),e.z=this._dataView.getFloat32(t+8,!0))}setVector3Float32FromRef(e,t){t+8>this._byteOffset?J.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._dataView.setFloat32(t,e.x,!0),this._dataView.setFloat32(t+4,e.y,!0),this._dataView.setFloat32(t+8,e.z,!0))}getVector4Float32FromRef(e,t){t+12>this._byteOffset?J.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(e.x=this._dataView.getFloat32(t,!0),e.y=this._dataView.getFloat32(t+4,!0),e.z=this._dataView.getFloat32(t+8,!0),e.w=this._dataView.getFloat32(t+12,!0))}setVector4Float32FromRef(e,t){t+12>this._byteOffset?J.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._dataView.setFloat32(t,e.x,!0),this._dataView.setFloat32(t+4,e.y,!0),this._dataView.setFloat32(t+8,e.z,!0),this._dataView.setFloat32(t+12,e.w,!0))}setFloat32(e,t){isNaN(e)&&J.Error("Invalid data being written!"),t!=null&&(t<this._byteOffset?this._dataView.setFloat32(t,e,!0):J.Error("BinaryWriter: byteoffset is greater than the current binary length!")),this._byteOffset+4>this._arrayBuffer.byteLength&&this._resizeBuffer(this._arrayBuffer.byteLength*2),this._dataView.setFloat32(this._byteOffset,e,!0),this._byteOffset+=4}setUInt32(e,t){t!=null?t<this._byteOffset?this._dataView.setUint32(t,e,!0):J.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+4>this._arrayBuffer.byteLength&&this._resizeBuffer(this._arrayBuffer.byteLength*2),this._dataView.setUint32(this._byteOffset,e,!0),this._byteOffset+=4)}setInt16(e,t){t!=null?t<this._byteOffset?this._dataView.setInt16(t,e,!0):J.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+2>this._arrayBuffer.byteLength&&this._resizeBuffer(this._arrayBuffer.byteLength*2),this._dataView.setInt16(this._byteOffset,e,!0),this._byteOffset+=2)}setByte(e,t){t!=null?t<this._byteOffset?this._dataView.setInt8(t,e):J.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+1>this._arrayBuffer.byteLength&&this._resizeBuffer(this._arrayBuffer.byteLength*2),this._dataView.setInt8(this._byteOffset,e),this._byteOffset++)}}class wB{static GLTFAsync(e,t,i){return e.whenReadyAsync().then(()=>{const r=t.replace(/\.[^/.]+$/,"");return new $i(e,i)._generateGLTFAsync(r)})}static _PreExportAsync(e,t){return Promise.resolve().then(()=>t&&t.exportWithoutWaitingForScene?Promise.resolve():e.whenReadyAsync())}static _PostExportAsync(e,t,i){return Promise.resolve().then(()=>(i&&i.exportWithoutWaitingForScene,t))}static GLBAsync(e,t,i){return this._PreExportAsync(e,i).then(()=>{const r=t.replace(/\.[^/.]+$/,"");return new $i(e,i)._generateGLBAsync(r).then(n=>this._PostExportAsync(e,n,i))})}}const kd="KHR_texture_transform";let FB=class{constructor(){this.name=kd,this.enabled=!0,this.required=!1,this._wasUsed=!1}dispose(){}get wasUsed(){return this._wasUsed}postExportTexture(e,t,i){if(i&&(i.uAng===0&&i.wAng===0&&i.vAng===0||i.uRotationCenter===0&&i.vRotationCenter===0)){const s={};let n=!1;if((i.uOffset!==0||i.vOffset!==0)&&(s.offset=[i.uOffset,i.vOffset],n=!0),(i.uScale!==1||i.vScale!==1)&&(s.scale=[i.uScale,i.vScale],n=!0),i.wAng!==0&&(s.rotation=-i.wAng,n=!0),i.coordinatesIndex!==0&&(s.texCoord=i.coordinatesIndex,n=!0),!n)return;this._wasUsed=!0,t.extensions||(t.extensions={}),t.extensions[kd]=s}}preExportTextureAsync(e,t){return new Promise((i,r)=>{if(!t.getScene()){r(`${e}: "scene" is not defined for Babylon texture ${t.name}!`);return}t.uAng!==0||t.vAng!==0?(J.Warn(`${e}: Texture ${t.name} with rotation in the u or v axis is not supported in glTF.`),i(null)):t.wAng!==0&&(t.uRotationCenter!==0||t.vRotationCenter!==0)?(J.Warn(`${e}: Texture ${t.name} with rotation not centered at the origin cannot be exported with ${kd}`),i(null)):i(t)})}};$i.RegisterExtension(kd,()=>new FB);const ql="KHR_lights_punctual";class LB{constructor(e){this.name=ql,this.enabled=!0,this.required=!1,this._exporter=e}dispose(){this._lights=null}get wasUsed(){return!!this._lights}onExporting(){this._exporter._glTF.extensions[ql]=this._lights}postExportNodeAsync(e,t,i,r){return new Promise(s=>{if(t&&i instanceof zl){const n=i;let a;const l=n.getTypeID()==St.LIGHTTYPEID_POINTLIGHT?"point":n.getTypeID()==St.LIGHTTYPEID_DIRECTIONALLIGHT?"directional":n.getTypeID()==St.LIGHTTYPEID_SPOTLIGHT?"spot":null;if(l==null)X.Warn(`${e}: Light ${n.name} is not supported in ${ql}`);else{const c=n.position.clone(),h=this._exporter._convertToRightHandedSystemMap[i.uniqueId];if(c.equals(x.Zero())||(h&&Vt._GetRightHandedPositionVector3FromRef(c),t.translation=c.asArray()),l!=="point"){const f=n.direction,_=-Math.atan2(f.z*(this._exporter._babylonScene.useRightHandedSystem?-1:1),f.x)+Math.PI/2,p=Math.sqrt(f.x*f.x+f.z*f.z),m=-Math.atan2(f.y,p),T=oe.RotationYawPitchRoll(_,m,0);h&&Vt._GetRightHandedQuaternionFromRef(T),T.equals(oe.Identity())||(t.rotation=T.asArray())}if(n.falloffType!==St.FALLOFF_GLTF&&X.Warn(`${e}: Light falloff for ${n.name} does not match the ${ql} specification!`),a={type:l},n.diffuse.equals(ge.White())||(a.color=n.diffuse.asArray()),n.intensity!==1&&(a.intensity=n.intensity),n.range!==Number.MAX_VALUE&&(a.range=n.range),l==="spot"){const f=n;f.angle!==Math.PI/2&&(a.spot==null&&(a.spot={}),a.spot.outerConeAngle=f.angle/2),f.innerAngle!==0&&(a.spot==null&&(a.spot={}),a.spot.innerConeAngle=f.innerAngle/2)}this._lights==null&&(this._lights={lights:[]}),this._lights.lights.push(a);const u={light:this._lights.lights.length-1},d=i.parent;if(d&&d.getChildren().length==1){const f=this._exporter._nodes[r[d.uniqueId]];if(f){const _=j.Matrix[0],p=j.Matrix[1],m=f.translation?new x(f.translation[0],f.translation[1],f.translation[2]):x.Zero(),T=f.rotation?new oe(f.rotation[0],f.rotation[1],f.rotation[2],f.rotation[3]):oe.Identity(),b=f.scale?new x(f.scale[0],f.scale[1],f.scale[2]):x.One();H.ComposeToRef(b,T,m,_),_.invertToRef(p);const y=j.Matrix[2],S=t.translation?new x(t.translation[0],t.translation[1],t.translation[2]):x.Zero();n instanceof Bn&&S.subtractInPlace(this._exporter._babylonScene.useRightHandedSystem?n.direction:Vt._GetRightHandedPositionVector3(n.direction));const C=this._exporter._babylonScene.useRightHandedSystem?oe.Identity():new oe(0,1,0,0);t.rotation&&C.multiplyInPlace(new oe(t.rotation[0],t.rotation[1],t.rotation[2],t.rotation[3]));const I=t.scale?new x(t.scale[0],t.scale[1],t.scale[2]):x.One();H.ComposeToRef(I,C,S,y),y.multiplyToRef(p,y);const P=j.Vector3[0],D=j.Quaternion[0],w=j.Vector3[1];y.decompose(P,D,w),f.scale=P.asArray(),f.rotation=D.asArray(),f.translation=w.asArray(),f.extensions==null&&(f.extensions={}),f.extensions[ql]=u,s(null);return}}t.extensions==null&&(t.extensions={}),t.extensions[ql]=u}}s(t)})}}$i.RegisterExtension(ql,o=>new LB(o));const op="KHR_materials_clearcoat";let BB=class{constructor(e){this.name=op,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}dispose(){}get wasUsed(){return this._wasUsed}postExportMaterialAdditionalTextures(e,t,i){const r=[];return i instanceof ei&&i.clearCoat.isEnabled?(i.clearCoat.texture&&r.push(i.clearCoat.texture),!i.clearCoat.useRoughnessFromMainTexture&&i.clearCoat.textureRoughness&&r.push(i.clearCoat.textureRoughness),i.clearCoat.bumpTexture&&r.push(i.clearCoat.bumpTexture),r):[]}postExportMaterialAsync(e,t,i){return new Promise(r=>{if(i instanceof ei){if(!i.clearCoat.isEnabled){r(t);return}this._wasUsed=!0,t.extensions=t.extensions||{};const s=this._exporter._glTFMaterialExporter._getTextureInfo(i.clearCoat.texture);let n;i.clearCoat.useRoughnessFromMainTexture?n=this._exporter._glTFMaterialExporter._getTextureInfo(i.clearCoat.texture):n=this._exporter._glTFMaterialExporter._getTextureInfo(i.clearCoat.textureRoughness),i.clearCoat.isTintEnabled&&J.Warn(`Clear Color tint is not supported for glTF export. Ignoring for: ${i.name}`),i.clearCoat.remapF0OnInterfaceChange&&J.Warn(`Clear Color F0 remapping is not supported for glTF export. Ignoring for: ${i.name}`);const a=this._exporter._glTFMaterialExporter._getTextureInfo(i.clearCoat.bumpTexture),l={clearcoatFactor:i.clearCoat.intensity,clearcoatTexture:s??void 0,clearcoatRoughnessFactor:i.clearCoat.roughness,clearcoatRoughnessTexture:n??void 0,clearcoatNormalTexture:a??void 0,hasTextures:()=>l.clearcoatTexture!==null||l.clearcoatRoughnessTexture!==null||l.clearcoatRoughnessTexture!==null};t.extensions[op]=l}r(t)})}};$i.RegisterExtension(op,o=>new BB(o));const lp="KHR_materials_iridescence";let UB=class{constructor(e){this.name=lp,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}dispose(){}get wasUsed(){return this._wasUsed}postExportMaterialAdditionalTextures(e,t,i){const r=[];return i instanceof ei&&i.iridescence.isEnabled?(i.iridescence.texture&&r.push(i.iridescence.texture),i.iridescence.thicknessTexture&&i.iridescence.thicknessTexture!==i.iridescence.texture&&r.push(i.iridescence.thicknessTexture),r):[]}postExportMaterialAsync(e,t,i){return new Promise(r=>{if(i instanceof ei){if(!i.iridescence.isEnabled){r(t);return}this._wasUsed=!0,t.extensions=t.extensions||{};const s=this._exporter._glTFMaterialExporter._getTextureInfo(i.iridescence.texture),n=this._exporter._glTFMaterialExporter._getTextureInfo(i.iridescence.thicknessTexture),a={iridescenceFactor:i.iridescence.intensity,iridescenceIor:i.iridescence.indexOfRefraction,iridescenceThicknessMinimum:i.iridescence.minimumThickness,iridescenceThicknessMaximum:i.iridescence.maximumThickness,iridescenceTexture:s??void 0,iridescenceThicknessTexture:n??void 0,hasTextures:()=>a.iridescenceTexture!==null||a.iridescenceThicknessTexture!==null};t.extensions[lp]=a}r(t)})}};$i.RegisterExtension(lp,o=>new UB(o));const cp="KHR_materials_sheen";let VB=class{constructor(e){this.name=cp,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}dispose(){}get wasUsed(){return this._wasUsed}postExportMaterialAdditionalTextures(e,t,i){return i instanceof He&&i.sheen.isEnabled&&i.sheen.texture?[i.sheen.texture]:[]}postExportMaterialAsync(e,t,i){return new Promise(r=>{var s,n,a,l;if(i instanceof He){if(!i.sheen.isEnabled){r(t);return}this._wasUsed=!0,t.extensions==null&&(t.extensions={});const c={sheenColorFactor:i.sheen.color.asArray(),sheenRoughnessFactor:(s=i.sheen.roughness)!==null&&s!==void 0?s:0,hasTextures:()=>c.sheenColorTexture!==null||c.sheenRoughnessTexture!==null};i.sheen.texture&&(c.sheenColorTexture=(n=this._exporter._glTFMaterialExporter._getTextureInfo(i.sheen.texture))!==null&&n!==void 0?n:void 0),i.sheen.textureRoughness&&!i.sheen.useRoughnessFromMainTexture?c.sheenRoughnessTexture=(a=this._exporter._glTFMaterialExporter._getTextureInfo(i.sheen.textureRoughness))!==null&&a!==void 0?a:void 0:i.sheen.texture&&i.sheen.useRoughnessFromMainTexture&&(c.sheenRoughnessTexture=(l=this._exporter._glTFMaterialExporter._getTextureInfo(i.sheen.texture))!==null&&l!==void 0?l:void 0),t.extensions[cp]=c}r(t)})}};$i.RegisterExtension(cp,o=>new VB(o));const hp="KHR_materials_unlit";let kB=class{constructor(){this.name=hp,this.enabled=!0,this.required=!1,this._wasUsed=!1}get wasUsed(){return this._wasUsed}dispose(){}postExportMaterialAsync(e,t,i){return new Promise(r=>{let s=!1;i instanceof He?s=i.unlit:i instanceof Be&&(s=i.disableLighting),s&&(this._wasUsed=!0,t.extensions==null&&(t.extensions={}),t.extensions[hp]={}),r(t)})}};$i.RegisterExtension(hp,()=>new kB);const up="KHR_materials_ior";let GB=class{constructor(){this.name=up,this.enabled=!0,this.required=!1,this._wasUsed=!1}dispose(){}get wasUsed(){return this._wasUsed}_isExtensionEnabled(e){return e.unlit?!1:e.indexOfRefraction!=null&&e.indexOfRefraction!=1.5}postExportMaterialAsync(e,t,i){return new Promise(r=>{if(i instanceof He&&this._isExtensionEnabled(i)){this._wasUsed=!0;const s={ior:i.indexOfRefraction};t.extensions=t.extensions||{},t.extensions[up]=s}r(t)})}};$i.RegisterExtension(up,o=>new GB);const dp="KHR_materials_specular";let zB=class{constructor(e){this.name=dp,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}dispose(){}get wasUsed(){return this._wasUsed}postExportMaterialAdditionalTextures(e,t,i){const r=[];return i instanceof He&&this._isExtensionEnabled(i)&&(i.metallicReflectanceTexture&&r.push(i.metallicReflectanceTexture),i.reflectanceTexture&&r.push(i.reflectanceTexture)),r}_isExtensionEnabled(e){return e.unlit?!1:e.metallicF0Factor!=null&&e.metallicF0Factor!=1||e.metallicReflectanceColor!=null&&!e.metallicReflectanceColor.equalsFloats(1,1,1)||this._hasTexturesExtension(e)}_hasTexturesExtension(e){return e.metallicReflectanceTexture!=null||e.reflectanceTexture!=null}postExportMaterialAsync(e,t,i){return new Promise(r=>{var s,n;if(i instanceof He&&this._isExtensionEnabled(i)){this._wasUsed=!0,t.extensions=t.extensions||{};const a=(s=this._exporter._glTFMaterialExporter._getTextureInfo(i.metallicReflectanceTexture))!==null&&s!==void 0?s:void 0,l=(n=this._exporter._glTFMaterialExporter._getTextureInfo(i.reflectanceTexture))!==null&&n!==void 0?n:void 0,c=i.metallicF0Factor==1?void 0:i.metallicF0Factor,h=i.metallicReflectanceColor.equalsFloats(1,1,1)?void 0:i.metallicReflectanceColor.asArray(),u={specularFactor:c,specularTexture:a,specularColorFactor:h,specularColorTexture:l,hasTextures:()=>this._hasTexturesExtension(i)};t.extensions[dp]=u}r(t)})}};$i.RegisterExtension(dp,o=>new zB(o));const fp="KHR_materials_volume";let HB=class{constructor(e){this.name=fp,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}dispose(){}get wasUsed(){return this._wasUsed}postExportMaterialAdditionalTextures(e,t,i){const r=[];return i instanceof He&&this._isExtensionEnabled(i)&&i.subSurface.thicknessTexture&&r.push(i.subSurface.thicknessTexture),r}_isExtensionEnabled(e){if(e.unlit)return!1;const t=e.subSurface;return!t.isRefractionEnabled&&!t.isTranslucencyEnabled?!1:t.maximumThickness!=null&&t.maximumThickness!=0||t.tintColorAtDistance!=null&&t.tintColorAtDistance!=Number.POSITIVE_INFINITY||t.tintColor!=null&&t.tintColor!=ge.White()||this._hasTexturesExtension(e)}_hasTexturesExtension(e){return e.subSurface.thicknessTexture!=null}postExportMaterialAsync(e,t,i){return new Promise(r=>{var s;if(i instanceof He&&this._isExtensionEnabled(i)){this._wasUsed=!0;const n=i.subSurface,a=n.maximumThickness==0?void 0:n.maximumThickness,l=(s=this._exporter._glTFMaterialExporter._getTextureInfo(n.thicknessTexture))!==null&&s!==void 0?s:void 0,c=n.tintColorAtDistance==Number.POSITIVE_INFINITY?void 0:n.tintColorAtDistance,h=n.tintColor.equalsFloats(1,1,1)?void 0:n.tintColor.asArray(),u={thicknessFactor:a,thicknessTexture:l,attenuationDistance:c,attenuationColor:h,hasTextures:()=>this._hasTexturesExtension(i)};t.extensions=t.extensions||{},t.extensions[fp]=u}r(t)})}};$i.RegisterExtension(fp,o=>new HB(o));const _p="KHR_materials_transmission";let WB=class{constructor(e){this.name=_p,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}dispose(){}get wasUsed(){return this._wasUsed}postExportMaterialAdditionalTextures(e,t,i){const r=[];return i instanceof He&&this._isExtensionEnabled(i)&&i.subSurface.thicknessTexture&&r.push(i.subSurface.thicknessTexture),r}_isExtensionEnabled(e){if(e.unlit)return!1;const t=e.subSurface;return t.isRefractionEnabled&&t.refractionIntensity!=null&&t.refractionIntensity!=0||this._hasTexturesExtension(e)}_hasTexturesExtension(e){return e.subSurface.refractionIntensityTexture!=null}postExportMaterialAsync(e,t,i){return new Promise(r=>{var s;if(i instanceof He&&this._isExtensionEnabled(i)){this._wasUsed=!0;const n=i.subSurface,a=n.refractionIntensity===0?void 0:n.refractionIntensity,l=(s=this._exporter._glTFMaterialExporter._getTextureInfo(n.refractionIntensityTexture))!==null&&s!==void 0?s:void 0,c={transmissionFactor:a,transmissionTexture:l,hasTextures:()=>this._hasTexturesExtension(i)};t.extensions=t.extensions||{},t.extensions[_p]=c}r(t)})}};$i.RegisterExtension(_p,o=>new WB(o));const pp="EXT_mesh_gpu_instancing";let XB=class{constructor(e){this.name=pp,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}dispose(){}get wasUsed(){return this._wasUsed}postExportNodeAsync(e,t,i,r,s){return new Promise(n=>{if(t&&i instanceof K&&i.hasThinInstances&&s){this._wasUsed=!0;const a=x.Zero(),l=oe.Identity(),c=x.One(),h=i.thinInstanceGetWorldMatrices(),u=j.Vector3[2],d=j.Quaternion[1],f=j.Vector3[3];let _=!1,p=!1,m=!1;const T=new Float32Array(i.thinInstanceCount*3),b=new Float32Array(i.thinInstanceCount*4),y=new Float32Array(i.thinInstanceCount*3);let S=0;for(const I of h)I.decompose(f,d,u),T.set(u.asArray(),S*3),b.set(d.normalize().asArray(),S*4),y.set(f.asArray(),S*3),_=_||!u.equalsWithEpsilon(a),p=p||!d.equalsWithEpsilon(l),m=m||!f.equalsWithEpsilon(c),S++;const C={attributes:{}};_&&(C.attributes.TRANSLATION=this._buildAccessor(T,"VEC3",i.thinInstanceCount,s,5126)),p&&(C.attributes.ROTATION=this._buildAccessor(b,"VEC4",i.thinInstanceCount,s,5126)),m&&(C.attributes.SCALE=this._buildAccessor(y,"VEC3",i.thinInstanceCount,s,5126)),t.extensions=t.extensions||{},t.extensions[pp]=C}n(t)})}_buildAccessor(e,t,i,r,s){const n=r.getByteOffset();switch(s){case 5126:{for(let u=0;u!=e.length;u++)r.setFloat32(e[u]);break}case 5120:{for(let u=0;u!=e.length;u++)r.setByte(e[u]*127);break}case 5122:{for(let u=0;u!=e.length;u++)r.setInt16(e[u]*32767);break}}const a={buffer:0,byteOffset:n,byteLength:e.length*O.GetTypeByteLength(s)},l=this._exporter._bufferViews.length;this._exporter._bufferViews.push(a);const c=this._exporter._accessors.length,h={bufferView:l,componentType:s,count:i,type:t,normalized:s==5120||s==5122};return this._exporter._accessors.push(h),c}};$i.RegisterExtension(pp,o=>new XB(o));const mp="KHR_materials_emissive_strength";let $B=class{constructor(){this.name=mp,this.enabled=!0,this.required=!1,this._wasUsed=!1}dispose(){}get wasUsed(){return this._wasUsed}postExportMaterialAsync(e,t,i){return new Promise(r=>{if(!(i instanceof He))return r(t);const s=i.emissiveColor.asArray(),n=Math.max(...s);if(n>1){this._wasUsed=!0,t.extensions||(t.extensions={});const a={emissiveStrength:n},l=i.emissiveColor.scale(1/a.emissiveStrength);t.emissiveFactor=l.asArray(),t.extensions[mp]=a}return r(t)})}};$i.RegisterExtension(mp,o=>new $B);function gp(o,e,t,i){const r={externalResourceFunction:s=>i(s).then(n=>new Uint8Array(n))};return t&&(r.uri=e==="file:"?t:e+t),o instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(o),r):GLTFValidator.validateString(o,r)}function YB(){const o=[];onmessage=e=>{const t=e.data;switch(t.id){case"init":{importScripts(t.url);break}case"validate":{gp(t.data,t.rootUrl,t.fileName,i=>new Promise((r,s)=>{const n=o.length;o.push({resolve:r,reject:s}),postMessage({id:"getExternalResource",index:n,uri:i})})).then(i=>{postMessage({id:"validate.resolve",value:i})},i=>{postMessage({id:"validate.reject",reason:i})});break}case"getExternalResource.resolve":{o[t.index].resolve(t.value);break}case"getExternalResource.reject":{o[t.index].reject(t.reason);break}}}}class LE{static ValidateAsync(e,t,i,r){return typeof Worker=="function"?new Promise((s,n)=>{const a=`${gp}(${YB})()`,l=URL.createObjectURL(new Blob([a],{type:"application/javascript"})),c=new Worker(l),h=d=>{c.removeEventListener("error",h),c.removeEventListener("message",u),n(d)},u=d=>{const f=d.data;switch(f.id){case"getExternalResource":{r(f.uri).then(_=>{c.postMessage({id:"getExternalResource.resolve",index:f.index,value:_},[_])},_=>{c.postMessage({id:"getExternalResource.reject",index:f.index,reason:_})});break}case"validate.resolve":{c.removeEventListener("error",h),c.removeEventListener("message",u),s(f.value),c.terminate();break}case"validate.reject":c.removeEventListener("error",h),c.removeEventListener("message",u),n(f.reason),c.terminate()}};c.addEventListener("error",h),c.addEventListener("message",u),c.postMessage({id:"init",url:this.Configuration.url}),c.postMessage({id:"validate",data:e,rootUrl:t,fileName:i})}):(this._LoadScriptPromise||(this._LoadScriptPromise=J.LoadScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>gp(e,t,i,r)))}}LE.Configuration={url:"https://preview.babylonjs.com/gltf_validator.js"};function Nx(o,e,t){try{return Promise.resolve(new Uint8Array(o,e,t))}catch(i){return Promise.reject(i)}}var Pu;(function(o){o[o.AUTO=0]="AUTO",o[o.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(Pu||(Pu={}));var Qc;(function(o){o[o.NONE=0]="NONE",o[o.FIRST=1]="FIRST",o[o.ALL=2]="ALL"})(Qc||(Qc={}));var Wn;(function(o){o[o.LOADING=0]="LOADING",o[o.READY=1]="READY",o[o.COMPLETE=2]="COMPLETE"})(Wn||(Wn={}));class rr{constructor(){this.onParsedObservable=new Q,this.coordinateSystemMode=Pu.AUTO,this.animationStartMode=Qc.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable=new Q,this.onSkinLoadedObservable=new Q,this.onTextureLoadedObservable=new Q,this.onMaterialLoadedObservable=new Q,this.onCameraLoadedObservable=new Q,this.onCompleteObservable=new Q,this.onErrorObservable=new Q,this.onDisposeObservable=new Q,this.onExtensionLoadedObservable=new Q,this.validate=!1,this.onValidatedObservable=new Q,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new Q,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(e)}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e)}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e)}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e)}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e)}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,i,r,s,n){this._progressCallback=r;const a=t.name?"file:":J.GetFolderPath(t),l=t.name||J.GetFilename(t);if(s){if(this.useRangeRequests){this.validate&&X.Warn("glTF validation is not supported when range requests are enabled");const c={abort:()=>{},onCompleteObservable:new Q},h={readAsync:(u,d)=>new Promise((f,_)=>{this._loadFile(e,t,p=>{f(new Uint8Array(p))},!0,p=>{_(p)},p=>{p.setRequestHeader("Range",`bytes=${u}-${u+d-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new N_(h)).then(u=>{c.onCompleteObservable.notifyObservers(c),i(u)},n?u=>n(void 0,u):void 0),c}return this._loadFile(e,t,c=>{this._validate(e,c,a,l),this._unpackBinaryAsync(new N_({readAsync:(h,u)=>Nx(c,h,u),byteLength:c.byteLength})).then(h=>{i(h)},n?h=>n(void 0,h):void 0)},!0,n)}return this._loadFile(e,t,c=>{this._validate(e,c,a,l),i({json:this._parseJson(c)})},s,n)}importMeshAsync(e,t,i,r,s,n){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(i),this.onParsedObservable.clear(),this._log(`Loading ${n||""}`),this._loader=this._getLoader(i),this._loader.importMeshAsync(e,t,null,i,r,s,n)))}loadAsync(e,t,i,r,s){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${s||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,i,r,s)))}loadAssetContainerAsync(e,t,i,r,s){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${s||""}`),this._loader=this._getLoader(t);const n=new vT(e),a=[];this.onMaterialLoadedObservable.add(h=>{a.push(h)});const l=[];this.onTextureLoadedObservable.add(h=>{l.push(h)});const c=[];return this.onCameraLoadedObservable.add(h=>{c.push(h)}),this._loader.importMeshAsync(null,e,n,t,i,r,s).then(h=>(Array.prototype.push.apply(n.geometries,h.geometries),Array.prototype.push.apply(n.meshes,h.meshes),Array.prototype.push.apply(n.particleSystems,h.particleSystems),Array.prototype.push.apply(n.skeletons,h.skeletons),Array.prototype.push.apply(n.animationGroups,h.animationGroups),Array.prototype.push.apply(n.materials,a),Array.prototype.push.apply(n.textures,l),Array.prototype.push.apply(n.lights,h.lights),Array.prototype.push.apply(n.transformNodes,h.transformNodes),Array.prototype.push.apply(n.cameras,c),n))})}canDirectLoad(e){return e.indexOf("asset")!==-1&&e.indexOf("version")!==-1||e.startsWith("data:base64,"+rr._MagicBase64Encoded)||e.startsWith("data:;base64,"+rr._MagicBase64Encoded)||e.startsWith("data:application/octet-stream;base64,"+rr._MagicBase64Encoded)||e.startsWith("data:model/gltf-binary;base64,"+rr._MagicBase64Encoded)}directLoad(e,t){if(t.startsWith("base64,"+rr._MagicBase64Encoded)||t.startsWith(";base64,"+rr._MagicBase64Encoded)||t.startsWith("application/octet-stream;base64,"+rr._MagicBase64Encoded)||t.startsWith("model/gltf-binary;base64,"+rr._MagicBase64Encoded)){const i=wu(t);return this._validate(e,i),this._unpackBinaryAsync(new N_({readAsync:(r,s)=>Nx(i,r,s),byteLength:i.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(){return new rr}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((e,t)=>{this.onCompleteObservable.addOnce(()=>{e()}),this.onErrorObservable.addOnce(i=>{t(i)})})}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(Wn[this._state]))}_loadFile(e,t,i,r,s,n){const a=e._loadFile(t,i,l=>{this._onProgress(l,a)},!0,r,s,n);return a.onCompleteObservable.add(l=>{this._requests.splice(this._requests.indexOf(l),1)}),this._requests.push(a),a}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let i=!0,r=0,s=0;for(const n of this._requests){if(n._lengthComputable===void 0||n._loaded===void 0||n._total===void 0)return;i=i&&n._lengthComputable,r+=n._loaded,s+=n._total}this._progressCallback({lengthComputable:i,loaded:r,total:i?s:0})}_validate(e,t,i="",r=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),LE.ValidateAsync(t,i,r,s=>this.preprocessUrlAsync(i+s).then(n=>e._loadFileAsync(n,void 0,!0,!0))).then(s=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(s),this.onValidatedObservable.clear()},s=>{this._endPerformanceCounter("Validate JSON"),J.Warn(`Failed to validate: ${s.message}`),this.onValidatedObservable.clear()}))}_getLoader(e){const t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);const i=rr._parseVersion(t.version);if(!i)throw new Error("Invalid version: "+t.version);if(t.minVersion!==void 0){const n=rr._parseVersion(t.minVersion);if(!n)throw new Error("Invalid minimum version: "+t.minVersion);if(rr._compareVersion(n,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const s={1:rr._CreateGLTF1Loader,2:rr._CreateGLTF2Loader}[i.major];if(!s)throw new Error("Unsupported version: "+t.version);return s(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(()=>{const t={Magic:1179937895},i=e.readUint32();if(i!==t.Magic)throw new Wa("Unexpected magic: "+i,Wo.GLTFLoaderUnexpectedMagicError);const r=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${r}`);const s=e.readUint32();!this.useRangeRequests&&s!==e.buffer.byteLength&&X.Warn(`Length in header does not match actual data length: ${s} != ${e.buffer.byteLength}`);let n;switch(r){case 1:{n=this._unpackBinaryV1Async(e,s);break}case 2:{n=this._unpackBinaryV2Async(e,s);break}default:throw new Error("Unsupported version: "+r)}return this._endPerformanceCounter("Unpack Binary"),n})}_unpackBinaryV1Async(e,t){const i={JSON:0},r=e.readUint32(),s=e.readUint32();if(s!==i.JSON)throw new Error(`Unexpected content format: ${s}`);const n=t-e.byteOffset,a={json:this._parseJson(e.readString(r)),bin:null};if(n!==0){const l=e.byteOffset;a.bin={readAsync:(c,h)=>e.buffer.readAsync(l+c,h),byteLength:n}}return Promise.resolve(a)}_unpackBinaryV2Async(e,t){const i={JSON:1313821514,BIN:5130562},r=e.readUint32();if(e.readUint32()!==i.JSON)throw new Error("First chunk format is not JSON");return e.byteOffset+r===t?e.loadAsync(r).then(()=>({json:this._parseJson(e.readString(r)),bin:null})):e.loadAsync(r+8).then(()=>{const n={json:this._parseJson(e.readString(r)),bin:null},a=()=>{const l=e.readUint32();switch(e.readUint32()){case i.JSON:throw new Error("Unexpected JSON chunk");case i.BIN:{const h=e.byteOffset;n.bin={readAsync:(u,d)=>e.buffer.readAsync(h+u,d),byteLength:l},e.skipBytes(l);break}default:{e.skipBytes(l);break}}return e.byteOffset!==t?e.loadAsync(8).then(a):Promise.resolve(n)};return a()})}static _parseVersion(e){if(e==="1.0"||e==="1.0.1")return{major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const t=rr._logSpaces.substr(0,this._logIndentLevel*2);X.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){J.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){J.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}rr.IncrementalLoading=!0;rr.HomogeneousCoordinates=!1;rr._MagicBase64Encoded="Z2xURg";rr._logSpaces="                                ";ft&&ft.RegisterPlugin(new rr);var El;(function(o){o[o.BYTE=5120]="BYTE",o[o.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",o[o.SHORT=5122]="SHORT",o[o.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",o[o.FLOAT=5126]="FLOAT"})(El||(El={}));var vp;(function(o){o[o.FRAGMENT=35632]="FRAGMENT",o[o.VERTEX=35633]="VERTEX"})(vp||(vp={}));var Mn;(function(o){o[o.BYTE=5120]="BYTE",o[o.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",o[o.SHORT=5122]="SHORT",o[o.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",o[o.INT=5124]="INT",o[o.UNSIGNED_INT=5125]="UNSIGNED_INT",o[o.FLOAT=5126]="FLOAT",o[o.FLOAT_VEC2=35664]="FLOAT_VEC2",o[o.FLOAT_VEC3=35665]="FLOAT_VEC3",o[o.FLOAT_VEC4=35666]="FLOAT_VEC4",o[o.INT_VEC2=35667]="INT_VEC2",o[o.INT_VEC3=35668]="INT_VEC3",o[o.INT_VEC4=35669]="INT_VEC4",o[o.BOOL=35670]="BOOL",o[o.BOOL_VEC2=35671]="BOOL_VEC2",o[o.BOOL_VEC3=35672]="BOOL_VEC3",o[o.BOOL_VEC4=35673]="BOOL_VEC4",o[o.FLOAT_MAT2=35674]="FLOAT_MAT2",o[o.FLOAT_MAT3=35675]="FLOAT_MAT3",o[o.FLOAT_MAT4=35676]="FLOAT_MAT4",o[o.SAMPLER_2D=35678]="SAMPLER_2D"})(Mn||(Mn={}));var uu;(function(o){o[o.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",o[o.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",o[o.REPEAT=10497]="REPEAT"})(uu||(uu={}));var ka;(function(o){o[o.NEAREST=9728]="NEAREST",o[o.LINEAR=9728]="LINEAR",o[o.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",o[o.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",o[o.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",o[o.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(ka||(ka={}));var wx;(function(o){o[o.ALPHA=6406]="ALPHA",o[o.RGB=6407]="RGB",o[o.RGBA=6408]="RGBA",o[o.LUMINANCE=6409]="LUMINANCE",o[o.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"})(wx||(wx={}));var xp;(function(o){o[o.FRONT=1028]="FRONT",o[o.BACK=1029]="BACK",o[o.FRONT_AND_BACK=1032]="FRONT_AND_BACK"})(xp||(xp={}));var gr;(function(o){o[o.ZERO=0]="ZERO",o[o.ONE=1]="ONE",o[o.SRC_COLOR=768]="SRC_COLOR",o[o.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",o[o.DST_COLOR=774]="DST_COLOR",o[o.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",o[o.SRC_ALPHA=770]="SRC_ALPHA",o[o.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",o[o.DST_ALPHA=772]="DST_ALPHA",o[o.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",o[o.CONSTANT_COLOR=32769]="CONSTANT_COLOR",o[o.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",o[o.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",o[o.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",o[o.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"})(gr||(gr={}));class ss{static SetMatrix(e,t,i,r,s){let n=null;if(i.semantic==="MODEL"?n=t.getWorldMatrix():i.semantic==="PROJECTION"?n=e.getProjectionMatrix():i.semantic==="VIEW"?n=e.getViewMatrix():i.semantic==="MODELVIEWINVERSETRANSPOSE"?n=H.Transpose(t.getWorldMatrix().multiply(e.getViewMatrix()).invert()):i.semantic==="MODELVIEW"?n=t.getWorldMatrix().multiply(e.getViewMatrix()):i.semantic==="MODELVIEWPROJECTION"?n=t.getWorldMatrix().multiply(e.getTransformMatrix()):i.semantic==="MODELINVERSE"?n=t.getWorldMatrix().invert():i.semantic==="VIEWINVERSE"?n=e.getViewMatrix().invert():i.semantic==="PROJECTIONINVERSE"?n=e.getProjectionMatrix().invert():i.semantic==="MODELVIEWINVERSE"?n=t.getWorldMatrix().multiply(e.getViewMatrix()).invert():i.semantic==="MODELVIEWPROJECTIONINVERSE"?n=t.getWorldMatrix().multiply(e.getTransformMatrix()).invert():i.semantic==="MODELINVERSETRANSPOSE"&&(n=H.Transpose(t.getWorldMatrix().invert())),n)switch(i.type){case Mn.FLOAT_MAT2:s.setMatrix2x2(r,H.GetAsMatrix2x2(n));break;case Mn.FLOAT_MAT3:s.setMatrix3x3(r,H.GetAsMatrix3x3(n));break;case Mn.FLOAT_MAT4:s.setMatrix(r,n);break}}static SetUniform(e,t,i,r){switch(r){case Mn.FLOAT:return e.setFloat(t,i),!0;case Mn.FLOAT_VEC2:return e.setVector2(t,Ie.FromArray(i)),!0;case Mn.FLOAT_VEC3:return e.setVector3(t,x.FromArray(i)),!0;case Mn.FLOAT_VEC4:return e.setVector4(t,Tt.FromArray(i)),!0;default:return!1}}static GetWrapMode(e){switch(e){case uu.CLAMP_TO_EDGE:return Y.CLAMP_ADDRESSMODE;case uu.MIRRORED_REPEAT:return Y.MIRROR_ADDRESSMODE;case uu.REPEAT:return Y.WRAP_ADDRESSMODE;default:return Y.WRAP_ADDRESSMODE}}static GetByteStrideFromType(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(e){switch(e){case ka.LINEAR:case ka.LINEAR_MIPMAP_NEAREST:case ka.LINEAR_MIPMAP_LINEAR:return Y.TRILINEAR_SAMPLINGMODE;case ka.NEAREST:case ka.NEAREST_MIPMAP_NEAREST:return Y.NEAREST_SAMPLINGMODE;default:return Y.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(e,t,i,r,s){i=t.byteOffset+i;const n=e.loadedBufferViews[t.buffer];if(i+r>n.byteLength)throw new Error("Buffer access is out of range");const a=n.buffer;switch(i+=n.byteOffset,s){case El.BYTE:return new Int8Array(a,i,r);case El.UNSIGNED_BYTE:return new Uint8Array(a,i,r);case El.SHORT:return new Int16Array(a,i,r);case El.UNSIGNED_SHORT:return new Uint16Array(a,i,r);default:return new Float32Array(a,i,r)}}static GetBufferFromAccessor(e,t){const i=e.bufferViews[t.bufferView],r=t.count*ss.GetByteStrideFromType(t);return ss.GetBufferFromBufferView(e,i,t.byteOffset,r,t.componentType)}static DecodeBufferToText(e){let t="";const i=e.byteLength;for(let r=0;r<i;++r)t+=String.fromCharCode(e[r]);return t}static GetDefaultMaterial(e){if(!ss._DefaultMaterial){ri.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),ri.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);const t={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},i={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};ss._DefaultMaterial=new da("GLTFDefaultMaterial",e,t,i),ss._DefaultMaterial.setColor4("u_emission",new Ye(.5,.5,.5,1))}return ss._DefaultMaterial}}ss._DefaultMaterial=null;var bl;(function(o){o[o.IDENTIFIER=1]="IDENTIFIER",o[o.UNKNOWN=2]="UNKNOWN",o[o.END_OF_INPUT=3]="END_OF_INPUT"})(bl||(bl={}));class Fx{constructor(e){this._pos=0,this.currentToken=bl.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return bl.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=bl.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=bl.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}}const BE=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],UE=["world","view","projection","worldView","worldViewProjection","mBones"],jB=["translation","rotation","scale"],KB=["position","rotationQuaternion","scaling"],qB=(o,e)=>{for(const t in o){const i=o[t];e.buffers[t]=i,e.buffersCount++}},QB=(o,e)=>{for(const t in o){const i=o[t];e.shaders[t]=i,e.shaderscount++}},gn=(o,e,t)=>{for(const i in o){const r=o[i];t[e][i]=r}},ZB=o=>{if(o)for(let e=0;e<o.length/2;e++)o[e*2+1]=1-o[e*2+1]},Lx=o=>{if(o.semantic==="NORMAL")return"normal";if(o.semantic==="POSITION")return"position";if(o.semantic==="JOINT")return"matricesIndices";if(o.semantic==="WEIGHT")return"matricesWeights";if(o.semantic==="COLOR")return"color";if(o.semantic&&o.semantic.indexOf("TEXCOORD_")!==-1){const e=Number(o.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},JB=o=>{for(const e in o.animations){const t=o.animations[e];if(!t.channels||!t.samplers)continue;let i=null;for(let r=0;r<t.channels.length;r++){const s=t.channels[r],n=t.samplers[s.sampler];if(!n)continue;let a=null,l=null;t.parameters?(a=t.parameters[n.input],l=t.parameters[n.output]):(a=n.input,l=n.output);const c=ss.GetBufferFromAccessor(o,o.accessors[a]),h=ss.GetBufferFromAccessor(o,o.accessors[l]),u=s.target.id;let d=o.scene.getNodeById(u);if(d===null&&(d=o.scene.getNodeByName(u)),d===null){J.Warn("Creating animation named "+e+". But cannot find node named "+u+" to attach to");continue}const f=d instanceof di;let _=s.target.path;const p=jB.indexOf(_);p!==-1&&(_=KB[p]);let m=ae.ANIMATIONTYPE_MATRIX;f||(_==="rotationQuaternion"?(m=ae.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new oe):m=ae.ANIMATIONTYPE_VECTOR3);let T=null;const b=[];let y=0,S=!1;f&&i&&i.getKeys().length===c.length&&(T=i,S=!0),S||(o.scene._blockEntityCollection=!!o.assetContainer,T=new ae(e,f?"_matrix":_,1,m,ae.ANIMATIONLOOPMODE_CYCLE),o.scene._blockEntityCollection=!1);for(let C=0;C<c.length;C++){let I=null;if(_==="rotationQuaternion"?(I=oe.FromArray([h[y],h[y+1],h[y+2],h[y+3]]),y+=4):(I=x.FromArray([h[y],h[y+1],h[y+2]]),y+=3),f){const P=d;let D=x.Zero(),w=new oe,L=x.Zero(),U=P.getBaseMatrix();S&&i&&(U=i.getKeys()[C].value),U.decompose(L,w,D),_==="position"?D=I:_==="rotationQuaternion"?w=I:L=I,I=H.Compose(L,w,D)}S?i&&(i.getKeys()[C].value=I):b.push({frame:c[C],value:I})}!S&&T&&(T.setKeys(b),d.animations.push(T)),i=T,o.scene.stopAnimation(d),o.scene.beginAnimation(d,0,c[c.length-1],!0,1)}}},qm=o=>{let e=null;if(o.translation||o.rotation||o.scale){const t=x.FromArray(o.scale||[1,1,1]),i=oe.FromArray(o.rotation||[0,0,0,1]),r=x.FromArray(o.translation||[0,0,0]);e=H.Compose(t,i,r)}else e=H.FromArray(o.matrix);return e},VE=(o,e,t,i)=>{for(let s=0;s<i.bones.length;s++)if(i.bones[s].name===t)return i.bones[s];const r=o.nodes;for(const s in r){const n=r[s];if(!n.jointName)continue;const a=n.children;for(let l=0;l<a.length;l++){const c=o.nodes[a[l]];if(c.jointName&&c.jointName===t){const h=qm(n),u=new di(n.name||"",i,VE(o,e,n.jointName,i),h);return u.id=s,u}}}return null},e2=(o,e)=>{for(let t=0;t<o.length;t++){const i=o[t];for(let r=0;r<i.node.children.length;r++)if(i.node.children[r]===e)return i.bone}return null},L_=(o,e)=>{const t=o.nodes;let i=t[e];if(i)return{node:i,id:e};for(const r in t)if(i=t[r],i.jointName===e)return{node:i,id:r};return null},t2=(o,e)=>{for(let t=0;t<o.jointNames.length;t++)if(o.jointNames[t]===e)return!0;return!1},i2=(o,e,t,i)=>{for(const r in o.nodes){const s=o.nodes[r],n=r;if(!s.jointName||t2(t,s.jointName))continue;const a=qm(s),l=new di(s.name||"",e,null,a);l.id=n,i.push({bone:l,node:s,id:n})}for(let r=0;r<i.length;r++){const s=i[r],n=s.node.children;for(let a=0;a<n.length;a++){let l=null;for(let c=0;c<i.length;c++)if(i[c].id===n[a]){l=i[c];break}l&&(l.bone._parent=s.bone,s.bone.children.push(l.bone))}}},r2=(o,e,t,i)=>{if(i||(i=new Ol(e.name||"","",o.scene)),!e.babylonSkeleton)return i;const r=[],s=[];i2(o,i,e,r),i.bones=[];for(let a=0;a<e.jointNames.length;a++){const l=L_(o,e.jointNames[a]);if(!l)continue;const c=l.node;if(!c){J.Warn("Joint named "+e.jointNames[a]+" does not exist");continue}const h=l.id,u=o.scene.getBoneById(h);if(u){i.bones.push(u);continue}let d=!1,f=null;for(let m=0;m<a;m++){const T=L_(o,e.jointNames[m]);if(!T)continue;const b=T.node;if(!b){J.Warn("Joint named "+e.jointNames[m]+" does not exist when looking for parent");continue}const y=b.children;if(y){d=!1;for(let S=0;S<y.length;S++)if(y[S]===h){f=VE(o,e,e.jointNames[m],i),d=!0;break}if(d)break}}const _=qm(c);!f&&r.length>0&&(f=e2(r,h),f&&s.indexOf(f)===-1&&s.push(f));const p=new di(c.jointName||"",i,f,_);p.id=h}const n=i.bones;i.bones=[];for(let a=0;a<e.jointNames.length;a++){const l=L_(o,e.jointNames[a]);if(l){for(let c=0;c<n.length;c++)if(n[c].id===l.id){i.bones.push(n[c]);break}}}i.prepare();for(let a=0;a<s.length;a++)i.bones.push(s[a]);return i},Bx=(o,e,t,i,r)=>{if(r||(o.scene._blockEntityCollection=!!o.assetContainer,r=new K(e.name||"",o.scene),r._parentContainer=o.assetContainer,o.scene._blockEntityCollection=!1,r.id=i),!e.babylonNode)return r;const s=[];let n=null;const a=new Array,l=new Array,c=new Array,h=new Array;for(let f=0;f<t.length;f++){const _=t[f],p=o.meshes[_];if(p)for(let m=0;m<p.primitives.length;m++){const T=new Oe,b=p.primitives[m];b.mode;const y=b.attributes;let S=null,C=null;for(const P in y)if(S=o.accessors[y[P]],C=ss.GetBufferFromAccessor(o,S),P==="NORMAL")T.normals=new Float32Array(C.length),T.normals.set(C);else if(P==="POSITION"){if(rr.HomogeneousCoordinates){T.positions=new Float32Array(C.length-C.length/4);for(let D=0;D<C.length;D+=4)T.positions[D]=C[D],T.positions[D+1]=C[D+1],T.positions[D+2]=C[D+2]}else T.positions=new Float32Array(C.length),T.positions.set(C);l.push(T.positions.length)}else if(P.indexOf("TEXCOORD_")!==-1){const D=Number(P.split("_")[1]),w=O.UVKind+(D===0?"":D+1),L=new Float32Array(C.length);L.set(C),ZB(L),T.set(L,w)}else P==="JOINT"?(T.matricesIndices=new Float32Array(C.length),T.matricesIndices.set(C)):P==="WEIGHT"?(T.matricesWeights=new Float32Array(C.length),T.matricesWeights.set(C)):P==="COLOR"&&(T.colors=new Float32Array(C.length),T.colors.set(C));if(S=o.accessors[b.indices],S)C=ss.GetBufferFromAccessor(o,S),T.indices=new Int32Array(C.length),T.indices.set(C),h.push(T.indices.length);else{const P=[];for(let D=0;D<T.positions.length/3;D++)P.push(D);T.indices=new Int32Array(P),h.push(T.indices.length)}n?n.merge(T):n=T;const I=o.scene.getMaterialById(b.material);s.push(I===null?ss.GetDefaultMaterial(o.scene):I),a.push(a.length===0?0:a[a.length-1]+l[l.length-2]),c.push(c.length===0?0:c[c.length-1]+h[h.length-2])}}let u;o.scene._blockEntityCollection=!!o.assetContainer,s.length>1?(u=new $a("multimat"+i,o.scene),u.subMaterials=s):u=new Be("multimat"+i,o.scene),s.length===1&&(u=s[0]),u._parentContainer=o.assetContainer,r.material||(r.material=u),new Bs(i,o.scene,n,!1,r),r.computeWorldMatrix(!0),o.scene._blockEntityCollection=!1,r.subMeshes=[];let d=0;for(let f=0;f<t.length;f++){const _=t[f],p=o.meshes[_];if(p)for(let m=0;m<p.primitives.length;m++)p.primitives[m].mode,qs.AddToMesh(d,a[d],l[d],c[d],h[d],r,r,!0),d++}return r},Tp=(o,e,t,i)=>{o.position&&(o.position=e),(o.rotationQuaternion||o.rotation)&&(o.rotationQuaternion=t),o.scaling&&(o.scaling=i)},s2=(o,e)=>{if(e.matrix){const t=new x(0,0,0),i=new oe,r=new x(0,0,0);H.FromArray(e.matrix).decompose(r,i,t),Tp(o,t,i,r)}else e.translation&&e.rotation&&e.scale&&Tp(o,x.FromArray(e.translation),oe.FromArray(e.rotation),x.FromArray(e.scale));o.computeWorldMatrix(!0)},n2=(o,e,t)=>{let i=null;if(o.importOnlyMeshes&&(e.skin||e.meshes)&&o.importMeshesNames&&o.importMeshesNames.length>0&&o.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){const r=o.skins[e.skin],s=Bx(o,e,e.meshes,t,e.babylonNode);s.skeleton=o.scene.getLastSkeletonById(e.skin),s.skeleton===null&&(s.skeleton=r2(o,r,s,r.babylonSkeleton),r.babylonSkeleton||(r.babylonSkeleton=s.skeleton)),i=s}}else if(e.meshes)i=Bx(o,e,e.mesh?[e.mesh]:e.meshes,t,e.babylonNode);else if(e.light&&!e.babylonNode&&!o.importOnlyMeshes){const r=o.lights[e.light];if(r){if(r.type==="ambient"){const s=r[r.type],n=new kl(e.light,x.Zero(),o.scene);n.name=e.name||"",s.color&&(n.diffuse=ge.FromArray(s.color)),i=n}else if(r.type==="directional"){const s=r[r.type],n=new Bn(e.light,x.Zero(),o.scene);n.name=e.name||"",s.color&&(n.diffuse=ge.FromArray(s.color)),i=n}else if(r.type==="point"){const s=r[r.type],n=new Bl(e.light,x.Zero(),o.scene);n.name=e.name||"",s.color&&(n.diffuse=ge.FromArray(s.color)),i=n}else if(r.type==="spot"){const s=r[r.type],n=new wn(e.light,x.Zero(),x.Zero(),0,0,o.scene);n.name=e.name||"",s.color&&(n.diffuse=ge.FromArray(s.color)),s.fallOfAngle&&(n.angle=s.fallOfAngle),s.fallOffExponent&&(n.exponent=s.fallOffExponent),i=n}}}else if(e.camera&&!e.babylonNode&&!o.importOnlyMeshes){const r=o.cameras[e.camera];if(r){if(o.scene._blockEntityCollection=!!o.assetContainer,r.type==="orthographic"){const s=new Qs(e.camera,x.Zero(),o.scene,!1);s.name=e.name||"",s.mode=Ve.ORTHOGRAPHIC_CAMERA,s.attachControl(),i=s,s._parentContainer=o.assetContainer}else if(r.type==="perspective"){const s=r[r.type],n=new Qs(e.camera,x.Zero(),o.scene,!1);n.name=e.name||"",n.attachControl(),s.aspectRatio||(s.aspectRatio=o.scene.getEngine().getRenderWidth()/o.scene.getEngine().getRenderHeight()),s.znear&&s.zfar&&(n.maxZ=s.zfar,n.minZ=s.znear),i=n,n._parentContainer=o.assetContainer}o.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(i===null){o.scene._blockEntityCollection=!!o.assetContainer;const r=new K(e.name||"",o.scene);r._parentContainer=o.assetContainer,o.scene._blockEntityCollection=!1,e.babylonNode=r,i=r}}if(i!==null){if(e.matrix&&i instanceof K)s2(i,e);else{const r=e.translation||[0,0,0],s=e.rotation||[0,0,0,1],n=e.scale||[1,1,1];Tp(i,x.FromArray(r),oe.FromArray(s),x.FromArray(n))}i.updateCache(!0),e.babylonNode=i}return i},Mu=(o,e,t,i=!1)=>{const r=o.nodes[e];let s=null;if(o.importOnlyMeshes&&!i&&o.importMeshesNames?o.importMeshesNames.indexOf(r.name||"")!==-1||o.importMeshesNames.length===0?i=!0:i=!1:i=!0,!r.jointName&&i&&(s=n2(o,r,e),s!==null&&(s.id=e,s.parent=t)),r.children)for(let n=0;n<r.children.length;n++)Mu(o,r.children[n],s,i)},Ux=o=>{let e=o.currentScene;if(e)for(let t=0;t<e.nodes.length;t++)Mu(o,e.nodes[t],null);else for(const t in o.scenes){e=o.scenes[t];for(let i=0;i<e.nodes.length;i++)Mu(o,e.nodes[i],null)}JB(o);for(let t=0;t<o.scene.skeletons.length;t++){const i=o.scene.skeletons[t];o.scene.beginAnimation(i,0,Number.MAX_VALUE,!0,1)}},a2=(o,e,t,i,r,s,n)=>{const a=s.values||r.parameters;for(const l in t){const c=t[l],h=c.type;if(h===Mn.FLOAT_MAT2||h===Mn.FLOAT_MAT3||h===Mn.FLOAT_MAT4){if(c.semantic&&!c.source&&!c.node)ss.SetMatrix(e.scene,o,c,l,i.getEffect());else if(c.semantic&&(c.source||c.node)){let u=e.scene.getNodeByName(c.source||c.node||"");if(u===null&&(u=e.scene.getNodeById(c.source||c.node||"")),u===null)continue;ss.SetMatrix(e.scene,u,c,l,i.getEffect())}}else{const u=a[r.uniforms[l]];if(!u)continue;if(h===Mn.SAMPLER_2D){const d=e.textures[s.values?u:c.value].babylonTexture;if(d==null)continue;i.getEffect().setTexture(l,d)}else ss.SetUniform(i.getEffect(),l,u,h)}}n(i)},o2=(o,e,t,i,r)=>{const s=i.values||t.parameters,n=t.uniforms;for(const a in r){const l=r[a],c=l.type;let h=s[n[a]];if(h===void 0&&(h=l.value),!h)continue;const u=d=>f=>{l.value&&d&&(e.setTexture(d,f),delete r[d])};c===Mn.SAMPLER_2D?Fs.LoadTextureAsync(o,i.values?h:l.value,u(a),()=>u(null)):l.value&&ss.SetUniform(e,a,i.values?h:l.value,c)&&delete r[a]}},l2=(o,e,t)=>(i,r)=>{e.dispose(!0),t("Cannot compile program named "+o.name+". Error: "+r+". Default material will be applied")},c2=(o,e,t,i,r,s)=>n=>{o2(o,e,t,i,r),e.onBind=a=>{a2(a,o,r,e,t,i,s)}},Vx=(o,e,t)=>{for(const i in e.uniforms){const r=e.uniforms[i],s=e.parameters[r];if(o.currentIdentifier===i&&s.semantic&&!s.source&&!s.node){const n=BE.indexOf(s.semantic);if(n!==-1)return delete t[i],UE[n]}}return o.currentIdentifier},kx=o=>{for(const e in o.materials)Fs.LoadMaterialAsync(o,e,()=>{},()=>{})};class Uo{static CreateRuntime(e,t,i){const r={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:i,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&gn(e.extensions,"extensions",r),e.extensionsUsed&&gn(e.extensionsUsed,"extensionsUsed",r),e.buffers&&qB(e.buffers,r),e.bufferViews&&gn(e.bufferViews,"bufferViews",r),e.accessors&&gn(e.accessors,"accessors",r),e.meshes&&gn(e.meshes,"meshes",r),e.lights&&gn(e.lights,"lights",r),e.cameras&&gn(e.cameras,"cameras",r),e.nodes&&gn(e.nodes,"nodes",r),e.images&&gn(e.images,"images",r),e.textures&&gn(e.textures,"textures",r),e.shaders&&QB(e.shaders,r),e.programs&&gn(e.programs,"programs",r),e.samplers&&gn(e.samplers,"samplers",r),e.techniques&&gn(e.techniques,"techniques",r),e.materials&&gn(e.materials,"materials",r),e.animations&&gn(e.animations,"animations",r),e.skins&&gn(e.skins,"skins",r),e.scenes&&(r.scenes=e.scenes),e.scene&&e.scenes&&(r.currentScene=e.scenes[e.scene]),r}static LoadBufferAsync(e,t,i,r,s){const n=e.buffers[t];J.IsBase64(n.uri)?setTimeout(()=>i(new Uint8Array(J.DecodeBase64(n.uri)))):J.LoadFile(e.rootUrl+n.uri,a=>i(new Uint8Array(a)),s,void 0,!0,a=>{a&&r(a.status+" "+a.statusText)})}static LoadTextureBufferAsync(e,t,i,r){const s=e.textures[t];if(!s||!s.source){r("");return}if(s.babylonTexture){i(null);return}const n=e.images[s.source];J.IsBase64(n.uri)?setTimeout(()=>i(new Uint8Array(J.DecodeBase64(n.uri)))):J.LoadFile(e.rootUrl+n.uri,a=>i(new Uint8Array(a)),void 0,void 0,!0,a=>{a&&r(a.status+" "+a.statusText)})}static CreateTextureAsync(e,t,i,r){const s=e.textures[t];if(s.babylonTexture){r(s.babylonTexture);return}const n=e.samplers[s.sampler],a=n.minFilter===ka.NEAREST_MIPMAP_NEAREST||n.minFilter===ka.NEAREST_MIPMAP_LINEAR||n.minFilter===ka.LINEAR_MIPMAP_NEAREST||n.minFilter===ka.LINEAR_MIPMAP_LINEAR,l=Y.BILINEAR_SAMPLINGMODE,c=i==null?new Blob:new Blob([i]),h=URL.createObjectURL(c),u=()=>URL.revokeObjectURL(h),d=new Y(h,e.scene,!a,!0,l,u,u);n.wrapS!==void 0&&(d.wrapU=ss.GetWrapMode(n.wrapS)),n.wrapT!==void 0&&(d.wrapV=ss.GetWrapMode(n.wrapT)),d.name=t,s.babylonTexture=d,r(d)}static LoadShaderStringAsync(e,t,i,r){const s=e.shaders[t];if(J.IsBase64(s.uri)){const n=atob(s.uri.split(",")[1]);i&&i(n)}else J.LoadFile(e.rootUrl+s.uri,i,void 0,void 0,!1,n=>{n&&r&&r(n.status+" "+n.statusText)})}static LoadMaterialAsync(e,t,i,r){const s=e.materials[t];if(!s.technique){r&&r("No technique found.");return}const n=e.techniques[s.technique];if(!n){e.scene._blockEntityCollection=!!e.assetContainer;const I=new Be(t,e.scene);I._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,I.diffuseColor=new ge(.5,.5,.5),I.sideOrientation=me.CounterClockWiseSideOrientation,i(I);return}const a=e.programs[n.program],l=n.states,c=ri.ShadersStore[a.vertexShader+"VertexShader"],h=ri.ShadersStore[a.fragmentShader+"PixelShader"];let u="",d="";const f=new Fx(c),_=new Fx(h),p={},m=[],T=[],b=[];for(const I in n.uniforms){const P=n.uniforms[I],D=n.parameters[P];if(p[I]=D,D.semantic&&!D.node&&!D.source){const w=BE.indexOf(D.semantic);w!==-1?(m.push(UE[w]),delete p[I]):m.push(I)}else D.type===Mn.SAMPLER_2D?b.push(I):m.push(I)}for(const I in n.attributes){const P=n.attributes[I],D=n.parameters[P];if(D.semantic){const w=Lx(D);w&&T.push(w)}}for(;!f.isEnd()&&f.getNextToken();){if(f.currentToken!==bl.IDENTIFIER){u+=f.currentString;continue}let P=!1;for(const D in n.attributes){const w=n.attributes[D],L=n.parameters[w];if(f.currentIdentifier===D&&L.semantic){u+=Lx(L),P=!0;break}}P||(u+=Vx(f,n,p))}for(;!_.isEnd()&&_.getNextToken();){if(_.currentToken!==bl.IDENTIFIER){d+=_.currentString;continue}d+=Vx(_,n,p)}const y={vertex:a.vertexShader+t,fragment:a.fragmentShader+t},S={attributes:T,uniforms:m,samplers:b,needAlphaBlending:l&&l.enable&&l.enable.indexOf(3042)!==-1};ri.ShadersStore[a.vertexShader+t+"VertexShader"]=u,ri.ShadersStore[a.fragmentShader+t+"PixelShader"]=d;const C=new da(t,e.scene,y,S);if(C.onError=l2(a,C,r),C.onCompiled=c2(e,C,n,s,p,i),C.sideOrientation=me.CounterClockWiseSideOrientation,l&&l.functions){const I=l.functions;I.cullFace&&I.cullFace[0]!==xp.BACK&&(C.backFaceCulling=!1);const P=I.blendFuncSeparate;P&&(P[0]===gr.SRC_ALPHA&&P[1]===gr.ONE_MINUS_SRC_ALPHA&&P[2]===gr.ONE&&P[3]===gr.ONE?C.alphaMode=ie.ALPHA_COMBINE:P[0]===gr.ONE&&P[1]===gr.ONE&&P[2]===gr.ZERO&&P[3]===gr.ONE?C.alphaMode=ie.ALPHA_ONEONE:P[0]===gr.SRC_ALPHA&&P[1]===gr.ONE&&P[2]===gr.ZERO&&P[3]===gr.ONE?C.alphaMode=ie.ALPHA_ADD:P[0]===gr.ZERO&&P[1]===gr.ONE_MINUS_SRC_COLOR&&P[2]===gr.ONE&&P[3]===gr.ONE?C.alphaMode=ie.ALPHA_SUBTRACT:P[0]===gr.DST_COLOR&&P[1]===gr.ZERO&&P[2]===gr.ONE&&P[3]===gr.ONE?C.alphaMode=ie.ALPHA_MULTIPLY:P[0]===gr.SRC_ALPHA&&P[1]===gr.ONE_MINUS_SRC_COLOR&&P[2]===gr.ONE&&P[3]===gr.ONE&&(C.alphaMode=ie.ALPHA_MAXIMIZED))}}}let gh=class Ep{static RegisterExtension(e){if(Ep.Extensions[e.name]){J.Error('Tool with the same name "'+e.name+'" already exists');return}Ep.Extensions[e.name]=e}dispose(){}_importMeshAsync(e,t,i,r,s,n,a,l){return t.useRightHandedSystem=!0,Fs.LoadRuntimeAsync(t,i,r,c=>{c.assetContainer=s,c.importOnlyMeshes=!0,e===""?c.importMeshesNames=[]:typeof e=="string"?c.importMeshesNames=[e]:e&&!(e instanceof Array)?c.importMeshesNames=[e]:(c.importMeshesNames=[],J.Warn("Argument meshesNames must be of type string or string[]")),this._createNodes(c);const h=new Array,u=new Array;for(const d in c.nodes){const f=c.nodes[d];f.babylonNode instanceof Qt&&h.push(f.babylonNode)}for(const d in c.skins){const f=c.skins[d];f.babylonSkeleton instanceof Ol&&u.push(f.babylonSkeleton)}this._loadBuffersAsync(c,()=>{this._loadShadersAsync(c,()=>{kx(c),Ux(c),!rr.IncrementalLoading&&n&&n(h,u)})}),rr.IncrementalLoading&&n&&n(h,u)},l),!0}importMeshAsync(e,t,i,r,s,n){return new Promise((a,l)=>{this._importMeshAsync(e,t,r,s,i,(c,h)=>{a({meshes:c,particleSystems:[],skeletons:h,animationGroups:[],lights:[],transformNodes:[],geometries:[]})},n,c=>{l(new Error(c))})})}_loadAsync(e,t,i,r,s,n){e.useRightHandedSystem=!0,Fs.LoadRuntimeAsync(e,t,i,a=>{Fs.LoadRuntimeExtensionsAsync(a,()=>{this._createNodes(a),this._loadBuffersAsync(a,()=>{this._loadShadersAsync(a,()=>{kx(a),Ux(a),rr.IncrementalLoading||r()})}),rr.IncrementalLoading&&r()},n)},n)}loadAsync(e,t,i,r){return new Promise((s,n)=>{this._loadAsync(e,t,i,()=>{s()},r,a=>{n(new Error(a))})})}_loadShadersAsync(e,t){let i=!1;const r=(s,n)=>{Fs.LoadShaderStringAsync(e,s,a=>{a instanceof ArrayBuffer||(e.loadedShaderCount++,a&&(ri.ShadersStore[s+(n.type===vp.VERTEX?"VertexShader":"PixelShader")]=a),e.loadedShaderCount===e.shaderscount&&t())},()=>{J.Error("Error when loading shader program named "+s+" located at "+n.uri)})};for(const s in e.shaders){i=!0;const n=e.shaders[s];n?r.bind(this,s,n)():J.Error("No shader named: "+s)}i||t()}_loadBuffersAsync(e,t){let i=!1;const r=(s,n)=>{Fs.LoadBufferAsync(e,s,a=>{e.loadedBufferCount++,a&&(a.byteLength!=e.buffers[s].byteLength&&J.Error("Buffer named "+s+" is length "+a.byteLength+". Expected: "+n.byteLength),e.loadedBufferViews[s]=a),e.loadedBufferCount===e.buffersCount&&t()},()=>{J.Error("Error when loading buffer named "+s+" located at "+n.uri)})};for(const s in e.buffers){i=!0;const n=e.buffers[s];n?r.bind(this,s,n)():J.Error("No buffer named: "+s)}i||t()}_createNodes(e){let t=e.currentScene;if(t)for(let i=0;i<t.nodes.length;i++)Mu(e,t.nodes[i],null);else for(const i in e.scenes){t=e.scenes[i];for(let r=0;r<t.nodes.length;r++)Mu(e,t.nodes[r],null)}}};gh.Extensions={};class Fs{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,i,r,s){return!1}loadRuntimeExtensionsAsync(e,t,i){return!1}loadBufferAsync(e,t,i,r,s){return!1}loadTextureBufferAsync(e,t,i,r){return!1}createTextureAsync(e,t,i,r,s){return!1}loadShaderStringAsync(e,t,i,r){return!1}loadMaterialAsync(e,t,i,r){return!1}static LoadRuntimeAsync(e,t,i,r,s){Fs._ApplyExtensions(n=>n.loadRuntimeAsync(e,t,i,r,s),()=>{setTimeout(()=>{r&&r(Uo.CreateRuntime(t.json,e,i))})})}static LoadRuntimeExtensionsAsync(e,t,i){Fs._ApplyExtensions(r=>r.loadRuntimeExtensionsAsync(e,t,i),()=>{setTimeout(()=>{t()})})}static LoadBufferAsync(e,t,i,r,s){Fs._ApplyExtensions(n=>n.loadBufferAsync(e,t,i,r,s),()=>{Uo.LoadBufferAsync(e,t,i,r,s)})}static LoadTextureAsync(e,t,i,r){Fs._LoadTextureBufferAsync(e,t,s=>{s&&Fs._CreateTextureAsync(e,t,s,i,r)},r)}static LoadShaderStringAsync(e,t,i,r){Fs._ApplyExtensions(s=>s.loadShaderStringAsync(e,t,i,r),()=>{Uo.LoadShaderStringAsync(e,t,i,r)})}static LoadMaterialAsync(e,t,i,r){Fs._ApplyExtensions(s=>s.loadMaterialAsync(e,t,i,r),()=>{Uo.LoadMaterialAsync(e,t,i,r)})}static _LoadTextureBufferAsync(e,t,i,r){Fs._ApplyExtensions(s=>s.loadTextureBufferAsync(e,t,i,r),()=>{Uo.LoadTextureBufferAsync(e,t,i,r)})}static _CreateTextureAsync(e,t,i,r,s){Fs._ApplyExtensions(n=>n.createTextureAsync(e,t,i,r,s),()=>{Uo.CreateTextureAsync(e,t,i,r)})}static _ApplyExtensions(e,t){for(const i in gh.Extensions){const r=gh.Extensions[i];if(e(r))return}t()}}rr._CreateGLTF1Loader=()=>new gh;const h2="binary_glTF";class u2 extends Fs{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,i,r){const s=t.json.extensionsUsed;return!s||s.indexOf(this.name)===-1||!t.bin?!1:(this._bin=t.bin,r(Uo.CreateRuntime(t.json,e,i)),!0)}loadBufferAsync(e,t,i,r){return e.extensionsUsed.indexOf(this.name)===-1||t!==h2?!1:(this._bin.readAsync(0,this._bin.byteLength).then(i,s=>r(s.message)),!0)}loadTextureBufferAsync(e,t,i){const r=e.textures[t],s=e.images[r.source];if(!s.extensions||!(this.name in s.extensions))return!1;const n=s.extensions[this.name],a=e.bufferViews[n.bufferView],l=ss.GetBufferFromBufferView(e,a,0,a.byteLength,El.UNSIGNED_BYTE);return i(l),!0}loadShaderStringAsync(e,t,i){const r=e.shaders[t];if(!r.extensions||!(this.name in r.extensions))return!1;const s=r.extensions[this.name],n=e.bufferViews[s.bufferView],a=ss.GetBufferFromBufferView(e,n,0,n.byteLength,El.UNSIGNED_BYTE);return setTimeout(()=>{const l=ss.DecodeBufferToText(a);i(l)}),!0}}gh.RegisterExtension(new u2);class d2 extends Fs{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;const t=e.extensions[this.name];if(!t)return!1;const i=t.lights;if(i)for(const r in i){const s=i[r];switch(s.type){case"ambient":{const n=new kl(s.name,new x(0,1,0),e.scene),a=s.ambient;a&&(n.diffuse=ge.FromArray(a.color||[1,1,1]));break}case"point":{const n=new Bl(s.name,new x(10,10,10),e.scene),a=s.point;a&&(n.diffuse=ge.FromArray(a.color||[1,1,1]));break}case"directional":{const n=new Bn(s.name,new x(0,-1,0),e.scene),a=s.directional;a&&(n.diffuse=ge.FromArray(a.color||[1,1,1]));break}case"spot":{const n=s.spot;if(n){const a=new wn(s.name,new x(0,10,0),new x(0,-1,0),n.fallOffAngle||Math.PI,n.fallOffExponent||0,e.scene);a.diffuse=ge.FromArray(n.color||[1,1,1])}break}default:J.Warn('GLTF Material Common extension: light type "'+s.type+"” not supported");break}}return!1}loadMaterialAsync(e,t,i,r){const s=e.materials[t];if(!s||!s.extensions)return!1;const n=s.extensions[this.name];if(!n)return!1;const a=new Be(t,e.scene);return a.sideOrientation=me.CounterClockWiseSideOrientation,n.technique==="CONSTANT"&&(a.disableLighting=!0),a.backFaceCulling=n.doubleSided===void 0?!1:!n.doubleSided,a.alpha=n.values.transparency===void 0?1:n.values.transparency,a.specularPower=n.values.shininess===void 0?0:n.values.shininess,typeof n.values.ambient=="string"?this._loadTexture(e,n.values.ambient,a,"ambientTexture",r):a.ambientColor=ge.FromArray(n.values.ambient||[0,0,0]),typeof n.values.diffuse=="string"?this._loadTexture(e,n.values.diffuse,a,"diffuseTexture",r):a.diffuseColor=ge.FromArray(n.values.diffuse||[0,0,0]),typeof n.values.emission=="string"?this._loadTexture(e,n.values.emission,a,"emissiveTexture",r):a.emissiveColor=ge.FromArray(n.values.emission||[0,0,0]),typeof n.values.specular=="string"?this._loadTexture(e,n.values.specular,a,"specularTexture",r):a.specularColor=ge.FromArray(n.values.specular||[0,0,0]),!0}_loadTexture(e,t,i,r,s){Uo.LoadTextureBufferAsync(e,t,n=>{Uo.CreateTextureAsync(e,t,n,a=>i[r]=a)},s)}}gh.RegisterExtension(new d2);function Gx(o,e,t,i){return x.FromArray(e,t).scaleInPlace(i)}function f2(o,e,t,i){return oe.FromArray(e,t).scaleInPlace(i)}function _2(o,e,t,i){const r=new Array(o._numMorphTargets);for(let s=0;s<r.length;s++)r[s]=e[t++]*i;return r}class qu{constructor(e,t,i,r){this.type=e,this.name=t,this.getValue=i,this.getStride=r}_buildAnimation(e,t,i){const r=new ae(e,this.name,t,this.type);return r.setKeys(i),r}}class B_ extends qu{buildAnimations(e,t,i,r,s){s(e._babylonTransformNode,this._buildAnimation(t,i,r))}}class p2 extends qu{buildAnimations(e,t,i,r,s){if(e._numMorphTargets)for(let n=0;n<e._numMorphTargets;n++){const a=new ae(`${t}_${n}`,this.name,i,this.type);if(a.setKeys(r.map(l=>({frame:l.frame,inTangent:l.inTangent?l.inTangent[n]:void 0,value:l.value[n],outTangent:l.outTangent?l.outTangent[n]:void 0,interpolation:l.interpolation}))),e._primitiveBabylonMeshes){for(const l of e._primitiveBabylonMeshes)if(l.morphTargetManager){const c=l.morphTargetManager.getTarget(n),h=a.clone();c.animations.push(h),s(c,h)}}}}}const zh={translation:[new B_(ae.ANIMATIONTYPE_VECTOR3,"position",Gx,()=>3)],rotation:[new B_(ae.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",f2,()=>4)],scale:[new B_(ae.ANIMATIONTYPE_VECTOR3,"scaling",Gx,()=>3)],weights:[new p2(ae.ANIMATIONTYPE_FLOAT,"influence",_2,o=>o._numMorphTargets)]};function kE(...o){const e=t=>t&&typeof t=="object";return o.reduce((t,i)=>(Object.keys(i).forEach(r=>{const s=t[r],n=i[r];Array.isArray(s)&&Array.isArray(n)?t[r]=s.concat(...n):e(s)&&e(n)?t[r]=kE(s,n):t[r]=n}),t),{})}class xt{static Get(e,t,i){if(!t||i==null||!t[i])throw new Error(`${e}: Failed to find index (${i})`);return t[i]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}class it{static RegisterExtension(e,t){it.UnregisterExtension(e)&&X.Warn(`Extension with the name '${e}' already exists`),it._RegisteredExtensions[e]={factory:t}}static UnregisterExtension(e){return it._RegisteredExtensions[e]?(delete it._RegisteredExtensions[e],!0):!1}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(e=>e.dispose&&e.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(e,t,i,r,s,n,a=""){return Promise.resolve().then(()=>{this._babylonScene=t,this._assetContainer=i,this._loadData(r);let l=null;if(e){const c={};if(this._gltf.nodes)for(const u of this._gltf.nodes)u.name&&(c[u.name]=u.index);l=(e instanceof Array?e:[e]).map(u=>{const d=c[u];if(d===void 0)throw new Error(`Failed to find node '${u}'`);return d})}return this._loadAsync(s,a,l,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries()}))})}loadAsync(e,t,i,r,s=""){return Promise.resolve().then(()=>(this._babylonScene=e,this._loadData(t),this._loadAsync(i,s,null,()=>{})))}_loadAsync(e,t,i,r){return Promise.resolve().then(()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._loadExtensions(),this._checkExtensions();const s=`${Wn[Wn.LOADING]} => ${Wn[Wn.READY]}`,n=`${Wn[Wn.LOADING]} => ${Wn[Wn.COMPLETE]}`;this._parent._startPerformanceCounter(s),this._parent._startPerformanceCounter(n),this._parent._setState(Wn.LOADING),this._extensionsOnLoading();const a=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(i)a.push(this.loadSceneAsync("/nodes",{nodes:i,index:-1}));else if(this._gltf.scene!=null||this._gltf.scenes&&this._gltf.scenes[0]){const h=xt.Get("/scene",this._gltf.scenes,this._gltf.scene||0);a.push(this.loadSceneAsync(`/scenes/${h.index}`,h))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let h=0;h<this._gltf.materials.length;++h){const u=this._gltf.materials[h],d="/materials/"+h,f=me.TriangleFillMode;a.push(this._loadMaterialAsync(d,u,null,f,()=>{}))}return this._babylonScene.blockMaterialDirtyMechanism=l,this._parent.compileMaterials&&a.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&a.push(this._compileShadowGeneratorsAsync()),Promise.all(a).then(()=>(this._rootBabylonMesh&&this._rootBabylonMesh.setEnabled(!0),this._extensionsOnReady(),this._parent._setState(Wn.READY),this._startAnimations(),r())).then(h=>(this._parent._endPerformanceCounter(s),J.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(n),this._parent._setState(Wn.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},u=>{this._parent.onErrorObservable.notifyObservers(u),this._parent.onErrorObservable.clear(),this.dispose()})}),h))}).catch(s=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(s),this._parent.onErrorObservable.clear(),this.dispose()),s})}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const i=t[0];(i.byteLength<e.bin.byteLength-3||i.byteLength>e.bin.byteLength)&&X.Warn(`Binary buffer length (${i.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else X.Warn("Unexpected BIN chunk")}}_setupData(){if(xt.Assign(this._gltf.accessors),xt.Assign(this._gltf.animations),xt.Assign(this._gltf.buffers),xt.Assign(this._gltf.bufferViews),xt.Assign(this._gltf.cameras),xt.Assign(this._gltf.images),xt.Assign(this._gltf.materials),xt.Assign(this._gltf.meshes),xt.Assign(this._gltf.nodes),xt.Assign(this._gltf.samplers),xt.Assign(this._gltf.scenes),xt.Assign(this._gltf.skins),xt.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const i of this._gltf.nodes)if(i.children)for(const r of i.children)e[r]=i.index;const t=this._createRootNode();for(const i of this._gltf.nodes){const r=e[i.index];i.parent=r===void 0?t:this._gltf.nodes[r]}}}_loadExtensions(){for(const e in it._RegisteredExtensions){const t=it._RegisteredExtensions[e].factory(this);t.name!==e&&X.Warn(`The name of the glTF loader extension instance does not match the registered name: ${t.name} !== ${e}`),this._extensions.push(t),this._parent.onExtensionLoadedObservable.notifyObservers(t)}this._extensions.sort((e,t)=>(e.order||Number.MAX_VALUE)-(t.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear()}_checkExtensions(){if(this._gltf.extensionsRequired){for(const e of this._gltf.extensionsRequired)if(!this._extensions.some(i=>i.name===e&&i.enabled))throw new Error(`Require extension ${e} is not available`)}}_createRootNode(){this._babylonScene._blockEntityCollection=!!this._assetContainer,this._rootBabylonMesh=new K("__root__",this._babylonScene),this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const e={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case Pu.AUTO:{this._babylonScene.useRightHandedSystem||(e.rotation=[0,1,0,0],e.scale=[1,1,-1],it._LoadTransform(e,this._rootBabylonMesh));break}case Pu.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),e}loadSceneAsync(e,t){const i=this._extensionsLoadSceneAsync(e,t);if(i)return i;const r=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const s of t.nodes){const n=xt.Get(`${e}/nodes/${s}`,this._gltf.nodes,s);r.push(this.loadNodeAsync(`/nodes/${n.index}`,n,a=>{a.parent=this._rootBabylonMesh}))}for(const s of this._postSceneLoadActions)s();return r.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(r).then(()=>{})}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const i of e._primitiveBabylonMeshes)t(i)}_getGeometries(){const e=new Array,t=this._gltf.nodes;if(t)for(const i of t)this._forEachPrimitive(i,r=>{const s=r.geometry;s&&e.indexOf(s)===-1&&e.push(s)});return e}_getMeshes(){const e=new Array;this._rootBabylonMesh&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const i of t)this._forEachPrimitive(i,r=>{e.push(r)});return e}_getTransformNodes(){const e=new Array,t=this._gltf.nodes;if(t)for(const i of t)i._babylonTransformNode&&i._babylonTransformNode.getClassName()==="TransformNode"&&e.push(i._babylonTransformNode),i._babylonTransformNodeForSkin&&e.push(i._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=new Array,t=this._gltf.skins;if(t)for(const i of t)i._data&&e.push(i._data.babylonSkeleton);return e}_getAnimationGroups(){const e=new Array,t=this._gltf.animations;if(t)for(const i of t)i._babylonAnimationGroup&&e.push(i._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case Qc.NONE:break;case Qc.FIRST:{const e=this._getAnimationGroups();e.length!==0&&e[0].start(!0);break}case Qc.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(!0);break}default:{X.Error(`Invalid animation start mode (${this._parent.animationStartMode})`);return}}}loadNodeAsync(e,t,i=()=>{}){const r=this._extensionsLoadNodeAsync(e,t,i);if(r)return r;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const s=new Array;this.logOpen(`${e} ${t.name||""}`);const n=a=>{if(it.AddPointerMetadata(a,e),it._LoadTransform(t,a),t.camera!=null){const l=xt.Get(`${e}/camera`,this._gltf.cameras,t.camera);s.push(this.loadCameraAsync(`/cameras/${l.index}`,l,c=>{c.parent=a}))}if(t.children)for(const l of t.children){const c=xt.Get(`${e}/children/${l}`,this._gltf.nodes,l);s.push(this.loadNodeAsync(`/nodes/${c.index}`,c,h=>{h.parent=a}))}i(a)};if(t.mesh==null||t.skin!=null){const a=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const l=new gt(a,this._babylonScene);l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t.mesh==null?t._babylonTransformNode=l:t._babylonTransformNodeForSkin=l,n(l)}if(t.mesh!=null)if(t.skin==null){const a=xt.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);s.push(this._loadMeshAsync(`/meshes/${a.index}`,t,a,n))}else{const a=xt.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);s.push(this._loadMeshAsync(`/meshes/${a.index}`,t,a,l=>{const c=t._babylonTransformNodeForSkin;l.metadata=kE(c.metadata,l.metadata||{});const h=xt.Get(`${e}/skin`,this._gltf.skins,t.skin);s.push(this._loadSkinAsync(`/skins/${h.index}`,t,h,u=>{this._forEachPrimitive(t,d=>{d.skeleton=u}),this._postSceneLoadActions.push(()=>{if(h.skeleton!=null){const d=xt.Get(`/skins/${h.index}/skeleton`,this._gltf.nodes,h.skeleton).parent;t.index===d.index?l.parent=c.parent:l.parent=d._babylonTransformNode}else l.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:c,skinnedNode:l})})}))}))}return this.logClose(),Promise.all(s).then(()=>(this._forEachPrimitive(t,a=>{a.geometry&&a.geometry.useBoundingInfoFromGeometry?a._updateBoundingInfo():a.refreshBoundingInfo(!0)}),t._babylonTransformNode))}_loadMeshAsync(e,t,i,r){const s=i.primitives;if(!s||!s.length)throw new Error(`${e}: Primitives are missing`);s[0].index==null&&xt.Assign(s);const n=new Array;this.logOpen(`${e} ${i.name||""}`);const a=t.name||`node${t.index}`;if(s.length===1){const l=i.primitives[0];n.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,a,t,i,l,c=>{t._babylonTransformNode=c,t._primitiveBabylonMeshes=[c]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new gt(a,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(const l of s)n.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,`${a}_primitive${l.index}`,t,i,l,c=>{c.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(c)}))}return r(t._babylonTransformNode),this.logClose(),Promise.all(n).then(()=>t._babylonTransformNode)}_loadMeshPrimitiveAsync(e,t,i,r,s,n){const a=this._extensionsLoadMeshPrimitiveAsync(e,t,i,r,s,n);if(a)return a;this.logOpen(`${e}`);const l=this._disableInstancedMesh===0&&this._parent.createInstances&&i.skin==null&&!r.primitives[0].targets;let c,h;if(l&&s._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,c=s._instanceData.babylonSourceMesh.createInstance(t),c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,h=s._instanceData.promise;else{const u=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const d=new K(t,this._babylonScene);d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,d.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?me.CounterClockWiseSideOrientation:me.ClockWiseSideOrientation,this._createMorphTargets(e,i,r,s,d),u.push(this._loadVertexDataAsync(e,s,d).then(_=>this._loadMorphTargetsAsync(e,s,d,_).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,_.applyToMesh(d),_._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})));const f=it._GetDrawMode(e,s.mode);if(s.material==null){let _=this._defaultBabylonMaterialData[f];_||(_=this._createDefaultMaterial("__GLTFLoader._default",f),this._parent.onMaterialLoadedObservable.notifyObservers(_),this._defaultBabylonMaterialData[f]=_),d.material=_}else if(!this.parent.skipMaterials){const _=xt.Get(`${e}/material`,this._gltf.materials,s.material);u.push(this._loadMaterialAsync(`/materials/${_.index}`,_,d,f,p=>{d.material=p}))}h=Promise.all(u),l&&(s._instanceData={babylonSourceMesh:d,promise:h}),c=d}return it.AddPointerMetadata(c,e),this._parent.onMeshLoadedObservable.notifyObservers(c),n(c),this.logClose(),h.then(()=>c)}_loadVertexDataAsync(e,t,i){const r=this._extensionsLoadVertexDataAsync(e,t,i);if(r)return r;const s=t.attributes;if(!s)throw new Error(`${e}: Attributes are missing`);const n=new Array,a=new Bs(i.name,this._babylonScene);if(t.indices==null)i.isUnIndexed=!0;else{const c=xt.Get(`${e}/indices`,this._gltf.accessors,t.indices);n.push(this._loadIndicesAccessorAsync(`/accessors/${c.index}`,c).then(h=>{a.setIndices(h)}))}const l=(c,h,u)=>{if(s[c]==null)return;i._delayInfo=i._delayInfo||[],i._delayInfo.indexOf(h)===-1&&i._delayInfo.push(h);const d=xt.Get(`${e}/attributes/${c}`,this._gltf.accessors,s[c]);n.push(this._loadVertexAccessorAsync(`/accessors/${d.index}`,d,h).then(f=>{if(f.getKind()===O.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!i.skeleton){const _=d.min,p=d.max;if(_!==void 0&&p!==void 0){if(d.normalized&&d.componentType!==5126){let b=1;switch(d.componentType){case 5120:b=127;break;case 5121:b=255;break;case 5122:b=32767;break;case 5123:b=65535;break}for(let y=0;y<3;++y)_[y]=Math.max(_[y]/b,-1),p[y]=Math.max(p[y]/b,-1)}const m=j.Vector3[0],T=j.Vector3[1];m.copyFromFloats(..._),T.copyFromFloats(...p),a._boundingInfo=new Qn(m,T),a.useBoundingInfoFromGeometry=!0}}a.setVerticesBuffer(f,d.count)})),h==O.MatricesIndicesExtraKind&&(i.numBoneInfluencers=8),u&&u(d)};return l("POSITION",O.PositionKind),l("NORMAL",O.NormalKind),l("TANGENT",O.TangentKind),l("TEXCOORD_0",O.UVKind),l("TEXCOORD_1",O.UV2Kind),l("TEXCOORD_2",O.UV3Kind),l("TEXCOORD_3",O.UV4Kind),l("TEXCOORD_4",O.UV5Kind),l("TEXCOORD_5",O.UV6Kind),l("JOINTS_0",O.MatricesIndicesKind),l("WEIGHTS_0",O.MatricesWeightsKind),l("JOINTS_1",O.MatricesIndicesExtraKind),l("WEIGHTS_1",O.MatricesWeightsExtraKind),l("COLOR_0",O.ColorKind,c=>{c.type==="VEC4"&&(i.hasVertexAlpha=!0)}),Promise.all(n).then(()=>a)}_createMorphTargets(e,t,i,r,s){if(!r.targets)return;if(t._numMorphTargets==null)t._numMorphTargets=r.targets.length;else if(r.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const n=i.extras?i.extras.targetNames:null;s.morphTargetManager=new _o(s.getScene()),s.morphTargetManager.areUpdatesFrozen=!0;for(let a=0;a<r.targets.length;a++){const l=t.weights?t.weights[a]:i.weights?i.weights[a]:0,c=n?n[a]:`morphTarget${a}`;s.morphTargetManager.addTarget(new xo(c,l,s.getScene()))}}_loadMorphTargetsAsync(e,t,i,r){if(!t.targets)return Promise.resolve();const s=new Array,n=i.morphTargetManager;for(let a=0;a<n.numTargets;a++){const l=n.getTarget(a);s.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${a}`,r,t.targets[a],l))}return Promise.all(s).then(()=>{n.areUpdatesFrozen=!1})}_loadMorphTargetVertexDataAsync(e,t,i,r){const s=new Array,n=(a,l,c)=>{if(i[a]==null)return;const h=t.getVertexBuffer(l);if(!h)return;const u=xt.Get(`${e}/${a}`,this._gltf.accessors,i[a]);s.push(this._loadFloatAccessorAsync(`/accessors/${u.index}`,u).then(d=>{c(h,d)}))};return n("POSITION",O.PositionKind,(a,l)=>{const c=new Float32Array(l.length);a.forEach(l.length,(h,u)=>{c[u]=l[u]+h}),r.setPositions(c)}),n("NORMAL",O.NormalKind,(a,l)=>{const c=new Float32Array(l.length);a.forEach(c.length,(h,u)=>{c[u]=l[u]+h}),r.setNormals(c)}),n("TANGENT",O.TangentKind,(a,l)=>{const c=new Float32Array(l.length/3*4);let h=0;a.forEach(l.length/3*4,(u,d)=>{(d+1)%4!==0&&(c[h]=l[h]+u,h++)}),r.setTangents(c)}),Promise.all(s).then(()=>{})}static _LoadTransform(e,t){if(e.skin!=null)return;let i=x.Zero(),r=oe.Identity(),s=x.One();e.matrix?H.FromArray(e.matrix).decompose(s,r,i):(e.translation&&(i=x.FromArray(e.translation)),e.rotation&&(r=oe.FromArray(e.rotation)),e.scale&&(s=x.FromArray(e.scale))),t.position=i,t.rotationQuaternion=r,t.scaling=s}_loadSkinAsync(e,t,i,r){const s=this._extensionsLoadSkinAsync(e,t,i);if(s)return s;if(i._data)return r(i._data.babylonSkeleton),i._data.promise;const n=`skeleton${i.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new Ol(i.name||n,n,this._babylonScene);a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,i,a);const l=this._loadSkinInverseBindMatricesDataAsync(e,i).then(c=>{this._updateBoneMatrices(a,c)});return i._data={babylonSkeleton:a,promise:l},r(a),l}_loadBones(e,t,i){if(t.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){const s=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(s)if(t.skeleton===void 0)t.skeleton=s.index;else{const n=(l,c)=>{for(;c.parent;c=c.parent)if(c.parent===l)return!0;return!1},a=xt.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);a!==s&&!n(a,s)&&(X.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=s.index)}else X.Warn(`${e}: Failed to find common root`)}const r={};for(const s of t.joints){const n=xt.Get(`${e}/joints/${s}`,this._gltf.nodes,s);this._loadBone(n,t,i,r)}}_findSkeletonRootNode(e,t){if(t.length===0)return null;const i={};for(const s of t){const n=new Array;let a=xt.Get(`${e}/${s}`,this._gltf.nodes,s);for(;a.index!==-1;)n.unshift(a),a=a.parent;i[s]=n}let r=null;for(let s=0;;++s){let n=i[t[0]];if(s>=n.length)return r;const a=n[s];for(let l=1;l<t.length;++l)if(n=i[t[l]],s>=n.length||a!==n[s])return r;r=a}}_loadBone(e,t,i,r){let s=r[e.index];if(s)return s;let n=null;e.index!==t.skeleton&&(e.parent&&e.parent.index!==-1?n=this._loadBone(e.parent,t,i,r):t.skeleton!==void 0&&X.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const a=t.joints.indexOf(e.index);return s=new di(e.name||`joint${e.index}`,i,n,this._getNodeMatrix(e),null,null,a),r[e.index]=s,this._postSceneLoadActions.push(()=>{s.linkTransformNode(e._babylonTransformNode)}),s}_loadSkinInverseBindMatricesDataAsync(e,t){if(t.inverseBindMatrices==null)return Promise.resolve(null);const i=xt.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${i.index}`,i)}_updateBoneMatrices(e,t){for(const i of e.bones){const r=H.Identity(),s=i._index;t&&s!==-1&&(H.FromArrayToRef(t,s*16,r),r.invertToRef(r));const n=i.getParent();n&&r.multiplyToRef(n.getInvertedAbsoluteTransform(),r),i.updateMatrix(r,!1,!1),i._updateDifferenceMatrix(void 0,!1)}}_getNodeMatrix(e){return e.matrix?H.FromArray(e.matrix):H.Compose(e.scale?x.FromArray(e.scale):x.One(),e.rotation?oe.FromArray(e.rotation):oe.Identity(),e.translation?x.FromArray(e.translation):x.Zero())}loadCameraAsync(e,t,i=()=>{}){const r=this._extensionsLoadCameraAsync(e,t,i);if(r)return r;const s=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new Qs(t.name||`camera${t.index}`,x.Zero(),this._babylonScene,!1);switch(n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n.ignoreParentScaling=!0,t._babylonCamera=n,n.rotation=new x(0,Math.PI,0),t.type){case"perspective":{const a=t.perspective;if(!a)throw new Error(`${e}: Camera perspective properties are missing`);n.fov=a.yfov,n.minZ=a.znear,n.maxZ=a.zfar||0;break}case"orthographic":{if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);n.mode=Ve.ORTHOGRAPHIC_CAMERA,n.orthoLeft=-t.orthographic.xmag,n.orthoRight=t.orthographic.xmag,n.orthoBottom=-t.orthographic.ymag,n.orthoTop=t.orthographic.ymag,n.minZ=t.orthographic.znear,n.maxZ=t.orthographic.zfar;break}default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return it.AddPointerMetadata(n,e),this._parent.onCameraLoadedObservable.notifyObservers(n),i(n),this.logClose(),Promise.all(s).then(()=>n)}_loadAnimationsAsync(){const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let i=0;i<e.length;i++){const r=e[i];t.push(this.loadAnimationAsync(`/animations/${r.index}`,r).then(s=>{s.targetedAnimations.length===0&&s.dispose()}))}return Promise.all(t).then(()=>{})}loadAnimationAsync(e,t){const i=this._extensionsLoadAnimationAsync(e,t);if(i)return i;this._babylonScene._blockEntityCollection=!!this._assetContainer;const r=new vu(t.name||`animation${t.index}`,this._babylonScene);r._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=r;const s=new Array;xt.Assign(t.channels),xt.Assign(t.samplers);for(const n of t.channels)s.push(this._loadAnimationChannelAsync(`${e}/channels/${n.index}`,e,t,n,(a,l)=>{a.animations=a.animations||[],a.animations.push(l),r.addTargetedAnimation(l,a)}));return Promise.all(s).then(()=>(r.normalize(0),r))}_loadAnimationChannelAsync(e,t,i,r,s){const n=this._extensionsLoadAnimationChannelAsync(e,t,i,r,s);if(n)return n;if(r.target.node==null)return Promise.resolve();const a=xt.Get(`${e}/target/node`,this._gltf.nodes,r.target.node);if(r.target.path==="weights"&&!a._numMorphTargets||r.target.path!=="weights"&&!a._babylonTransformNode)return Promise.resolve();let l;switch(r.target.path){case"translation":{l=zh.translation;break}case"rotation":{l=zh.rotation;break}case"scale":{l=zh.scale;break}case"weights":{l=zh.weights;break}default:throw new Error(`${e}/target/path: Invalid value (${r.target.path})`)}const c={target:a,properties:l};return this._loadAnimationChannelFromTargetInfoAsync(e,t,i,r,c,s)}_loadAnimationChannelFromTargetInfoAsync(e,t,i,r,s,n){const a=this.parent.targetFps,l=1/a,c=xt.Get(`${e}/sampler`,i.samplers,r.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${r.sampler}`,c).then(h=>{let u=0;for(const d of s.properties){const f=d.getStride(s.target),_=h.input,p=h.output,m=new Array(_.length);let T=0;switch(h.interpolation){case"STEP":{for(let b=0;b<_.length;b++){const y=d.getValue(s.target,p,T,1);T+=f,m[b]={frame:_[b]*a,value:y,interpolation:th.STEP}}break}case"CUBICSPLINE":{for(let b=0;b<_.length;b++){const y=d.getValue(s.target,p,T,l);T+=f;const S=d.getValue(s.target,p,T,1);T+=f;const C=d.getValue(s.target,p,T,l);T+=f,m[b]={frame:_[b]*a,inTangent:y,value:S,outTangent:C}}break}case"LINEAR":{for(let b=0;b<_.length;b++){const y=d.getValue(s.target,p,T,1);T+=f,m[b]={frame:_[b]*a,value:y}}break}}if(T>0){const b=`${i.name||`animation${i.index}`}_channel${r.index}_${u}`;d.buildAnimations(s.target,b,a,m,(y,S)=>{++u,n(y,S)})}}})}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const i=t.interpolation||"LINEAR";switch(i){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const r=xt.Get(`${e}/input`,this._gltf.accessors,t.input),s=xt.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${r.index}`,r),this._loadFloatAccessorAsync(`/accessors/${s.index}`,s)]).then(([n,a])=>({input:n,interpolation:i,output:a})),t._data}loadBufferAsync(e,t,i,r){const s=this._extensionsLoadBufferAsync(e,t,i,r);if(s)return s;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then(n=>{try{return new Uint8Array(n.buffer,n.byteOffset+i,r)}catch(a){throw new Error(`${e}: ${a.message}`)}})}loadBufferViewAsync(e,t){const i=this._extensionsLoadBufferViewAsync(e,t);if(i)return i;if(t._data)return t._data;const r=xt.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${r.index}`,r,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,i){if(t._data)return t._data;const r=it._GetNumComponents(e,t.type),s=r*O.GetTypeByteLength(t.componentType),n=r*t.count;if(t.bufferView==null)t._data=Promise.resolve(new i(n));else{const a=xt.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${a.index}`,a).then(l=>{if(t.componentType===5126&&!t.normalized&&(!a.byteStride||a.byteStride===s))return it._GetTypedArray(e,t.componentType,l,t.byteOffset,n);{const c=new i(n);return O.ForEach(l,t.byteOffset||0,a.byteStride||s,r,t.componentType,c.length,t.normalized||!1,(h,u)=>{c[u]=h}),c}})}if(t.sparse){const a=t.sparse;t._data=t._data.then(l=>{const c=l,h=xt.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,a.indices.bufferView),u=xt.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,a.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${h.index}`,h),this.loadBufferViewAsync(`/bufferViews/${u.index}`,u)]).then(([d,f])=>{const _=it._GetTypedArray(`${e}/sparse/indices`,a.indices.componentType,d,a.indices.byteOffset,a.count),p=r*a.count;let m;if(t.componentType===5126&&!t.normalized)m=it._GetTypedArray(`${e}/sparse/values`,t.componentType,f,a.values.byteOffset,p);else{const b=it._GetTypedArray(`${e}/sparse/values`,t.componentType,f,a.values.byteOffset,p);m=new i(p),O.ForEach(b,0,s,r,t.componentType,m.length,t.normalized||!1,(y,S)=>{m[S]=y})}let T=0;for(let b=0;b<_.length;b++){let y=_[b]*r;for(let S=0;S<r;S++)c[y++]=m[T++]}return c})})}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if(t.type!=="SCALAR")throw new Error(`${e}/type: Invalid value ${t.type}`);if(t.componentType!==5121&&t.componentType!==5123&&t.componentType!==5125)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const i=it._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,i)}else{const i=xt.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${i.index}`,i).then(r=>it._GetTypedArray(e,t.componentType,r,t.byteOffset,t.count))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then(i=>new Xa(t,i,!1)),e._babylonBuffer}_loadVertexAccessorAsync(e,t,i){var r;if(!((r=t._babylonVertexBuffer)===null||r===void 0)&&r[i])return t._babylonVertexBuffer[i];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const s=this._babylonScene.getEngine();if(t.sparse)t._babylonVertexBuffer[i]=this._loadFloatAccessorAsync(e,t).then(n=>new O(s,n,i,!1));else if(i===O.MatricesIndicesKind||i===O.MatricesIndicesExtraKind)t._babylonVertexBuffer[i]=this._loadFloatAccessorAsync(e,t).then(n=>new O(s,n,i,!1));else{const n=xt.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[i]=this._loadVertexBufferViewAsync(n).then(a=>{const l=it._GetNumComponents(e,t.type);return new O(s,a,i,!1,!1,n.byteStride,!1,t.byteOffset,l,t.componentType,t.normalized,!0,1,!0)})}return t._babylonVertexBuffer[i]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,i){if(!(i instanceof He))throw new Error(`${e}: Material type not supported`);const r=new Array;return t&&(t.baseColorFactor?(i.albedoColor=ge.FromArray(t.baseColorFactor),i.alpha=t.baseColorFactor[3]):i.albedoColor=ge.White(),i.metallic=t.metallicFactor==null?1:t.metallicFactor,i.roughness=t.roughnessFactor==null?1:t.roughnessFactor,t.baseColorTexture&&r.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,s=>{s.name=`${i.name} (Base Color)`,i.albedoTexture=s})),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,s=>{s.name=`${i.name} (Metallic Roughness)`,i.metallicTexture=s})),i.useMetallnessFromMetallicTextureBlue=!0,i.useRoughnessFromMetallicTextureGreen=!0,i.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(r).then(()=>{})}_loadMaterialAsync(e,t,i,r,s=()=>{}){const n=this._extensionsLoadMaterialAsync(e,t,i,r,s);if(n)return n;t._data=t._data||{};let a=t._data[r];if(!a){this.logOpen(`${e} ${t.name||""}`);const l=this.createMaterial(e,t,r);a={babylonMaterial:l,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,l)},t._data[r]=a,it.AddPointerMetadata(l,e),this._parent.onMaterialLoadedObservable.notifyObservers(l),this.logClose()}return i&&(a.babylonMeshes.push(i),i.onDisposeObservable.addOnce(()=>{const l=a.babylonMeshes.indexOf(i);l!==-1&&a.babylonMeshes.splice(l,1)})),s(a.babylonMaterial),a.promise.then(()=>a.babylonMaterial)}_createDefaultMaterial(e,t){this._babylonScene._blockEntityCollection=!!this._assetContainer;const i=new He(e,this._babylonScene);return i._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i.fillMode=t,i.enableSpecularAntiAliasing=!0,i.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,i.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,i.transparencyMode=He.PBRMATERIAL_OPAQUE,i.metallic=1,i.roughness=1,i}createMaterial(e,t,i){const r=this._extensionsCreateMaterial(e,t,i);if(r)return r;const s=t.name||`material${t.index}`;return this._createDefaultMaterial(s,i)}loadMaterialPropertiesAsync(e,t,i){const r=this._extensionsLoadMaterialPropertiesAsync(e,t,i);if(r)return r;const s=new Array;return s.push(this.loadMaterialBasePropertiesAsync(e,t,i)),t.pbrMetallicRoughness&&s.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,i)),this.loadMaterialAlphaProperties(e,t,i),Promise.all(s).then(()=>{})}loadMaterialBasePropertiesAsync(e,t,i){if(!(i instanceof He))throw new Error(`${e}: Material type not supported`);const r=new Array;return i.emissiveColor=t.emissiveFactor?ge.FromArray(t.emissiveFactor):new ge(0,0,0),t.doubleSided&&(i.backFaceCulling=!1,i.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,s=>{s.name=`${i.name} (Normal)`,i.bumpTexture=s})),i.invertNormalMapX=!this._babylonScene.useRightHandedSystem,i.invertNormalMapY=this._babylonScene.useRightHandedSystem,t.normalTexture.scale!=null&&i.bumpTexture&&(i.bumpTexture.level=t.normalTexture.scale),i.forceIrradianceInFragment=!0),t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,s=>{s.name=`${i.name} (Occlusion)`,i.ambientTexture=s})),i.useAmbientInGrayScale=!0,t.occlusionTexture.strength!=null&&(i.ambientTextureStrength=t.occlusionTexture.strength)),t.emissiveTexture&&r.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,s=>{s.name=`${i.name} (Emissive)`,i.emissiveTexture=s})),Promise.all(r).then(()=>{})}loadMaterialAlphaProperties(e,t,i){if(!(i instanceof He))throw new Error(`${e}: Material type not supported`);switch(t.alphaMode||"OPAQUE"){case"OPAQUE":{i.transparencyMode=He.PBRMATERIAL_OPAQUE;break}case"MASK":{i.transparencyMode=He.PBRMATERIAL_ALPHATEST,i.alphaCutOff=t.alphaCutoff==null?.5:t.alphaCutoff,i.albedoTexture&&(i.albedoTexture.hasAlpha=!0);break}case"BLEND":{i.transparencyMode=He.PBRMATERIAL_ALPHABLEND,i.albedoTexture&&(i.albedoTexture.hasAlpha=!0,i.useAlphaFromAlbedoTexture=!0);break}default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,i=()=>{}){const r=this._extensionsLoadTextureInfoAsync(e,t,i);if(r)return r;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const s=xt.Get(`${e}/index`,this._gltf.textures,t.index);s._textureInfo=t;const n=this._loadTextureAsync(`/textures/${t.index}`,s,a=>{a.coordinatesIndex=t.texCoord||0,it.AddPointerMetadata(a,e),this._parent.onTextureLoadedObservable.notifyObservers(a),i(a)});return this.logClose(),n}_loadTextureAsync(e,t,i=()=>{}){const r=this._extensionsLoadTextureAsync(e,t,i);if(r)return r;this.logOpen(`${e} ${t.name||""}`);const s=t.sampler==null?it.DefaultSampler:xt.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),n=xt.Get(`${e}/source`,this._gltf.images,t.source),a=this._createTextureAsync(e,s,n,i,void 0,!t._textureInfo.nonColorData);return this.logClose(),a}_createTextureAsync(e,t,i,r=()=>{},s,n){const a=this._loadSampler(`/samplers/${t.index}`,t),l=new Array,c=new Gh;this._babylonScene._blockEntityCollection=!!this._assetContainer;const h={noMipmap:a.noMipMaps,invertY:!1,samplingMode:a.samplingMode,onLoad:()=>{this._disposed||c.resolve()},onError:(d,f)=>{this._disposed||c.reject(new Error(`${e}: ${f&&f.message?f.message:d||"Failed to load texture"}`))},mimeType:i.mimeType,loaderOptions:s,useSRGBBuffer:!!n&&this._parent.useSRGBBuffers},u=new Y(null,this._babylonScene,h);return u._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.push(c.promise),l.push(this.loadImageAsync(`/images/${i.index}`,i).then(d=>{const f=i.uri||`${this._fileName}#image${i.index}`,_=`data:${this._uniqueRootUrl}${f}`;u.updateURL(_,d)})),u.wrapU=a.wrapU,u.wrapV=a.wrapV,r(u),Promise.all(l).then(()=>u)}_loadSampler(e,t){return t._data||(t._data={noMipMaps:t.minFilter===9728||t.minFilter===9729,samplingMode:it._GetTextureSamplingMode(e,t),wrapU:it._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:it._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{const i=xt.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${i.index}`,i)}this.logClose()}return t._data}loadUriAsync(e,t,i){const r=this._extensionsLoadUriAsync(e,t,i);if(r)return r;if(!it._ValidateUri(i))throw new Error(`${e}: '${i}' is invalid`);if(uf(i)){const s=new Uint8Array(wu(i));return this.log(`${e}: Decoded ${i.substr(0,64)}... (${s.length} bytes)`),Promise.resolve(s)}return this.log(`${e}: Loading ${i}`),this._parent.preprocessUrlAsync(this._rootUrl+i).then(s=>new Promise((n,a)=>{this._parent._loadFile(this._babylonScene,s,l=>{this._disposed||(this.log(`${e}: Loaded ${i} (${l.byteLength} bytes)`),n(new Uint8Array(l)))},!0,l=>{a(new pu(`${e}: Failed to load '${i}'${l?": "+l.status+" "+l.statusText:""}`,l))})}))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};const i=e._internalMetadata=e._internalMetadata||{},r=i.gltf=i.gltf||{};(r.pointers=r.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=t??10497,t){case 33071:return Y.CLAMP_ADDRESSMODE;case 33648:return Y.MIRROR_ADDRESSMODE;case 10497:return Y.WRAP_ADDRESSMODE;default:return X.Warn(`${e}: Invalid value (${t})`),Y.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const i=t.magFilter==null?9729:t.magFilter,r=t.minFilter==null?9987:t.minFilter;if(i===9729)switch(r){case 9728:return Y.LINEAR_NEAREST;case 9729:return Y.LINEAR_LINEAR;case 9984:return Y.LINEAR_NEAREST_MIPNEAREST;case 9985:return Y.LINEAR_LINEAR_MIPNEAREST;case 9986:return Y.LINEAR_NEAREST_MIPLINEAR;case 9987:return Y.LINEAR_LINEAR_MIPLINEAR;default:return X.Warn(`${e}/minFilter: Invalid value (${r})`),Y.LINEAR_LINEAR_MIPLINEAR}else switch(i!==9728&&X.Warn(`${e}/magFilter: Invalid value (${i})`),r){case 9728:return Y.NEAREST_NEAREST;case 9729:return Y.NEAREST_LINEAR;case 9984:return Y.NEAREST_NEAREST_MIPNEAREST;case 9985:return Y.NEAREST_LINEAR_MIPNEAREST;case 9986:return Y.NEAREST_NEAREST_MIPLINEAR;case 9987:return Y.NEAREST_LINEAR_MIPLINEAR;default:return X.Warn(`${e}/minFilter: Invalid value (${r})`),Y.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`${e}: Invalid component type ${t}`)}}static _GetTypedArray(e,t,i,r,s){const n=i.buffer;r=i.byteOffset+(r||0);const a=it._GetTypedArrayConstructor(`${e}/componentType`,t),l=O.GetTypeByteLength(t);return r%l!==0?(X.Warn(`${e}: Copying buffer as byte offset (${r}) is not a multiple of component type byte length (${l})`),new a(n.slice(r,r+s*l),0)):new a(n,r,s)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return J.IsBase64(e)||e.indexOf("..")===-1}static _GetDrawMode(e,t){switch(t==null&&(t=4),t){case 0:return me.PointListDrawMode;case 1:return me.LineListDrawMode;case 2:return me.LineLoopDrawMode;case 3:return me.LineStripDrawMode;case 4:return me.TriangleFillMode;case 5:return me.TriangleStripDrawMode;case 6:return me.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials){for(const t of this._gltf.materials)if(t._data)for(const i in t._data){const r=t._data[i];for(const s of r.babylonMeshes){s.computeWorldMatrix(!0);const n=r.babylonMaterial;e.push(n.forceCompilationAsync(s)),e.push(n.forceCompilationAsync(s,{useInstances:!0})),this._parent.useClipPlane&&(e.push(n.forceCompilationAsync(s,{clipPlane:!0})),e.push(n.forceCompilationAsync(s,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const i of t){const r=i.getShadowGenerator();r&&e.push(r.forceCompilationAsync())}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,i){for(const r of this._extensions)if(r.enabled){const s=`${r.name}.${t}`,n=e;n._activeLoaderExtensionFunctions=n._activeLoaderExtensionFunctions||{};const a=n._activeLoaderExtensionFunctions;if(!a[s]){a[s]=!0;try{const l=i(r);if(l)return l}finally{delete a[s]}}}return null}_extensionsOnLoading(){this._forEachExtensions(e=>e.onLoading&&e.onLoading())}_extensionsOnReady(){this._forEachExtensions(e=>e.onReady&&e.onReady())}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",i=>i.loadSceneAsync&&i.loadSceneAsync(e,t))}_extensionsLoadNodeAsync(e,t,i){return this._applyExtensions(t,"loadNode",r=>r.loadNodeAsync&&r.loadNodeAsync(e,t,i))}_extensionsLoadCameraAsync(e,t,i){return this._applyExtensions(t,"loadCamera",r=>r.loadCameraAsync&&r.loadCameraAsync(e,t,i))}_extensionsLoadVertexDataAsync(e,t,i){return this._applyExtensions(t,"loadVertexData",r=>r._loadVertexDataAsync&&r._loadVertexDataAsync(e,t,i))}_extensionsLoadMeshPrimitiveAsync(e,t,i,r,s,n){return this._applyExtensions(s,"loadMeshPrimitive",a=>a._loadMeshPrimitiveAsync&&a._loadMeshPrimitiveAsync(e,t,i,r,s,n))}_extensionsLoadMaterialAsync(e,t,i,r,s){return this._applyExtensions(t,"loadMaterial",n=>n._loadMaterialAsync&&n._loadMaterialAsync(e,t,i,r,s))}_extensionsCreateMaterial(e,t,i){return this._applyExtensions(t,"createMaterial",r=>r.createMaterial&&r.createMaterial(e,t,i))}_extensionsLoadMaterialPropertiesAsync(e,t,i){return this._applyExtensions(t,"loadMaterialProperties",r=>r.loadMaterialPropertiesAsync&&r.loadMaterialPropertiesAsync(e,t,i))}_extensionsLoadTextureInfoAsync(e,t,i){return this._applyExtensions(t,"loadTextureInfo",r=>r.loadTextureInfoAsync&&r.loadTextureInfoAsync(e,t,i))}_extensionsLoadTextureAsync(e,t,i){return this._applyExtensions(t,"loadTexture",r=>r._loadTextureAsync&&r._loadTextureAsync(e,t,i))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",i=>i.loadAnimationAsync&&i.loadAnimationAsync(e,t))}_extensionsLoadAnimationChannelAsync(e,t,i,r,s){return this._applyExtensions(i,"loadAnimationChannel",n=>n._loadAnimationChannelAsync&&n._loadAnimationChannelAsync(e,t,i,r,s))}_extensionsLoadSkinAsync(e,t,i){return this._applyExtensions(i,"loadSkin",r=>r._loadSkinAsync&&r._loadSkinAsync(e,t,i))}_extensionsLoadUriAsync(e,t,i){return this._applyExtensions(t,"loadUri",r=>r._loadUriAsync&&r._loadUriAsync(e,t,i))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",i=>i.loadBufferViewAsync&&i.loadBufferViewAsync(e,t))}_extensionsLoadBufferAsync(e,t,i,r){return this._applyExtensions(t,"loadBuffer",s=>s.loadBufferAsync&&s.loadBufferAsync(e,t,i,r))}static LoadExtensionAsync(e,t,i,r){if(!t.extensions)return null;const n=t.extensions[i];return n?r(`${e}/extensions/${i}`,n):null}static LoadExtraAsync(e,t,i,r){if(!t.extras)return null;const n=t.extras[i];return n?r(`${e}/extras/${i}`,n):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(e)!==-1}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}it._RegisteredExtensions={};it.DefaultSampler={index:-1};rr._CreateGLTF2Loader=o=>new it(o);const bp="EXT_lights_image_based";class m2{constructor(e){this.name=bp,this._loader=e,this.enabled=this._loader.isExtensionUsed(bp)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return it.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=new Array;s.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${i}`);const n=xt.Get(`${i}/light`,this._lights,r.light);return s.push(this._loadLightAsync(`/extensions/${this.name}/lights/${r.light}`,n).then(a=>{this._loader.babylonScene.environmentTexture=a})),this._loader.logClose(),Promise.all(s).then(()=>{})})}_loadLightAsync(e,t){if(!t._loaded){const i=new Array;this._loader.logOpen(`${e}`);const r=new Array(t.specularImages.length);for(let s=0;s<t.specularImages.length;s++){const n=t.specularImages[s];r[s]=new Array(n.length);for(let a=0;a<n.length;a++){const l=`${e}/specularImages/${s}/${a}`;this._loader.logOpen(`${l}`);const c=n[a],h=xt.Get(l,this._loader.gltf.images,c);i.push(this._loader.loadImageAsync(`/images/${c}`,h).then(u=>{r[s][a]=u})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(i).then(()=>{const s=new km(this._loader.babylonScene,null,t.specularImageSize);if(s.name=t.name||"environment",t._babylonTexture=s,t.intensity!=null&&(s.level=t.intensity),t.rotation){let c=oe.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(c=oe.Inverse(c)),H.FromQuaternionToRef(c,s.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const n=dc.FromArray(t.irradianceCoefficients);n.scaleInPlace(t.intensity),n.convertIrradianceToLambertianRadiance();const a=Ko.FromHarmonics(n),l=(r.length-1)/Ee.Log2(t.specularImageSize);return s.updateRGBDAsync(r,a,l)})}return t._loaded.then(()=>t._babylonTexture)}}it.RegisterExtension(bp,o=>new m2(o));const Sp="EXT_mesh_gpu_instancing";class g2{constructor(e){this.name=Sp,this._loader=e,this.enabled=this._loader.isExtensionUsed(Sp)}dispose(){this._loader=null}loadNodeAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>{this._loader._disableInstancedMesh++;const n=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,i);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return n;const a=new Array;let l=0;const c=h=>{if(s.attributes[h]==null){a.push(Promise.resolve(null));return}const u=xt.Get(`${r}/attributes/${h}`,this._loader.gltf.accessors,s.attributes[h]);if(a.push(this._loader._loadFloatAccessorAsync(`/accessors/${u.bufferView}`,u)),l===0)l=u.count;else if(l!==u.count)throw new Error(`${r}/attributes: Instance buffer accessors do not have the same count.`)};return c("TRANSLATION"),c("ROTATION"),c("SCALE"),n.then(h=>Promise.all(a).then(([u,d,f])=>{const _=new Float32Array(l*16);j.Vector3[0].copyFromFloats(0,0,0),j.Quaternion[0].copyFromFloats(0,0,0,1),j.Vector3[1].copyFromFloats(1,1,1);for(let p=0;p<l;++p)u&&x.FromArrayToRef(u,p*3,j.Vector3[0]),d&&oe.FromArrayToRef(d,p*4,j.Quaternion[0]),f&&x.FromArrayToRef(f,p*3,j.Vector3[1]),H.ComposeToRef(j.Vector3[1],j.Quaternion[0],j.Vector3[0],j.Matrix[0]),j.Matrix[0].copyToArray(_,p*16);for(const p of t._primitiveBabylonMeshes)p.thinInstanceSetBuffer("matrix",_,16,!0);return h}))})}}it.RegisterExtension(Sp,o=>new g2(o));const yp="EXT_meshopt_compression";class v2{constructor(e){this.name=yp,this.enabled=e.isExtensionUsed(yp),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return it.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=t;if(s._meshOptData)return s._meshOptData;const n=xt.Get(`${e}/buffer`,this._loader.gltf.buffers,r.buffer);return s._meshOptData=this._loader.loadBufferAsync(`/buffers/${n.index}`,n,r.byteOffset||0,r.byteLength).then(a=>ko.Default.decodeGltfBufferAsync(a,r.count,r.byteStride,r.mode,r.filter)),s._meshOptData})}}it.RegisterExtension(yp,o=>new v2(o));const Cp="EXT_texture_webp";class x2{constructor(e){this.name=Cp,this._loader=e,this.enabled=e.isExtensionUsed(Cp)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>{const n=t.sampler==null?it.DefaultSampler:xt.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=xt.Get(`${r}/source`,this._loader.gltf.images,s.source);return this._loader._createTextureAsync(e,n,a,l=>{i(l)},void 0,!t._textureInfo.nonColorData)})}}it.RegisterExtension(Cp,o=>new x2(o));const Ap="KHR_draco_mesh_compression";class T2{constructor(e){this.name=Ap,this._loader=e,this.enabled=Yn.DecoderAvailable&&this._loader.isExtensionUsed(Ap)}dispose(){delete this.dracoCompression,this._loader=null}_loadVertexDataAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>{if(t.mode!=null){if(t.mode!==5&&t.mode!==4)throw new Error(`${e}: Unsupported mode ${t.mode}`);if(t.mode===5)throw new Error(`${e}: Mode ${t.mode} is not currently supported`)}const n={},a={},l=(h,u)=>{const d=s.attributes[h];if(d===void 0||t.attributes[h]===void 0)return;n[u]=d;const f=xt.Get(`${e}/attributes/${h}`,this._loader.gltf.accessors,t.attributes[h]);if(f.normalized&&f.componentType!==5126){let _=1;switch(f.componentType){case 5120:_=127;break;case 5121:_=255;break;case 5122:_=32767;break;case 5123:_=65535;break}a[u]=_}i._delayInfo=i._delayInfo||[],i._delayInfo.indexOf(u)===-1&&i._delayInfo.push(u)};l("POSITION",O.PositionKind),l("NORMAL",O.NormalKind),l("TANGENT",O.TangentKind),l("TEXCOORD_0",O.UVKind),l("TEXCOORD_1",O.UV2Kind),l("TEXCOORD_2",O.UV3Kind),l("TEXCOORD_3",O.UV4Kind),l("TEXCOORD_4",O.UV5Kind),l("TEXCOORD_5",O.UV6Kind),l("JOINTS_0",O.MatricesIndicesKind),l("WEIGHTS_0",O.MatricesWeightsKind),l("COLOR_0",O.ColorKind);const c=xt.Get(r,this._loader.gltf.bufferViews,s.bufferView);return c._dracoBabylonGeometry||(c._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${c.index}`,c).then(h=>(this.dracoCompression||Yn.Default).decodeMeshAsync(h,n,a).then(d=>{const f=new Bs(i.name,this._loader.babylonScene);return d.applyToGeometry(f),f}).catch(d=>{throw new Error(`${e}: ${d.message}`)}))),c._dracoBabylonGeometry})}}it.RegisterExtension(Ap,o=>new T2(o));const Rp="KHR_lights_punctual";class E2{constructor(e){this.name=Rp,this._loader=e,this.enabled=this._loader.isExtensionUsed(Rp)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,xt.Assign(this._lights)}}loadNodeAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>this._loader.loadNodeAsync(e,t,n=>{let a;const l=xt.Get(r,this._lights,s.light),c=l.name||n.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l.type){case"directional":{a=new Bn(c,x.Backward(),this._loader.babylonScene);break}case"point":{a=new Bl(c,x.Zero(),this._loader.babylonScene);break}case"spot":{const h=new wn(c,x.Zero(),x.Backward(),0,1,this._loader.babylonScene);h.angle=(l.spot&&l.spot.outerConeAngle||Math.PI/4)*2,h.innerAngle=(l.spot&&l.spot.innerConeAngle||0)*2,a=h;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${r}: Invalid light type (${l.type})`)}a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=a,a.falloffType=St.FALLOFF_GLTF,a.diffuse=l.color?ge.FromArray(l.color):ge.White(),a.intensity=l.intensity==null?1:l.intensity,a.range=l.range==null?Number.MAX_VALUE:l.range,a.parent=n,this._loader._babylonLights.push(a),it.AddPointerMetadata(a,r),i(n)}))}}it.RegisterExtension(Rp,o=>new E2(o));const Ip="KHR_materials_pbrSpecularGlossiness";class b2{constructor(e){this.name=Ip,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ip)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>{const n=new Array;return n.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),n.push(this._loadSpecularGlossinessPropertiesAsync(r,t,s,i)),this._loader.loadMaterialAlphaProperties(e,t,i),Promise.all(n).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,t,i,r){if(!(r instanceof He))throw new Error(`${e}: Material type not supported`);const s=new Array;return r.metallic=null,r.roughness=null,i.diffuseFactor?(r.albedoColor=ge.FromArray(i.diffuseFactor),r.alpha=i.diffuseFactor[3]):r.albedoColor=ge.White(),r.reflectivityColor=i.specularFactor?ge.FromArray(i.specularFactor):ge.White(),r.microSurface=i.glossinessFactor==null?1:i.glossinessFactor,i.diffuseTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,i.diffuseTexture,n=>{n.name=`${r.name} (Diffuse)`,r.albedoTexture=n})),i.specularGlossinessTexture&&(s.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,i.specularGlossinessTexture,n=>{n.name=`${r.name} (Specular Glossiness)`,r.reflectivityTexture=n,r.reflectivityTexture.hasAlpha=!0})),r.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(s).then(()=>{})}}it.RegisterExtension(Ip,o=>new b2(o));const Pp="KHR_materials_unlit";class S2{constructor(e){this.name=Pp,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(Pp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,()=>this._loadUnlitPropertiesAsync(e,t,i))}_loadUnlitPropertiesAsync(e,t,i){if(!(i instanceof He))throw new Error(`${e}: Material type not supported`);const r=new Array;i.unlit=!0;const s=t.pbrMetallicRoughness;return s&&(s.baseColorFactor?(i.albedoColor=ge.FromArray(s.baseColorFactor),i.alpha=s.baseColorFactor[3]):i.albedoColor=ge.White(),s.baseColorTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,s.baseColorTexture,n=>{n.name=`${i.name} (Base Color)`,i.albedoTexture=n}))),t.doubleSided&&(i.backFaceCulling=!1,i.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,i),Promise.all(r).then(()=>{})}}it.RegisterExtension(Pp,o=>new S2(o));const Mp="KHR_materials_clearcoat";class y2{constructor(e){this.name=Mp,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Mp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadClearCoatPropertiesAsync(r,s,i)),Promise.all(n).then(()=>{})})}_loadClearCoatPropertiesAsync(e,t,i){if(!(i instanceof He))throw new Error(`${e}: Material type not supported`);const r=new Array;return i.clearCoat.isEnabled=!0,i.clearCoat.useRoughnessFromMainTexture=!1,i.clearCoat.remapF0OnInterfaceChange=!1,t.clearcoatFactor!=null?i.clearCoat.intensity=t.clearcoatFactor:i.clearCoat.intensity=0,t.clearcoatTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,s=>{s.name=`${i.name} (ClearCoat Intensity)`,i.clearCoat.texture=s})),t.clearcoatRoughnessFactor!=null?i.clearCoat.roughness=t.clearcoatRoughnessFactor:i.clearCoat.roughness=0,t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,s=>{s.name=`${i.name} (ClearCoat Roughness)`,i.clearCoat.textureRoughness=s}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,s=>{s.name=`${i.name} (ClearCoat Normal)`,i.clearCoat.bumpTexture=s})),i.invertNormalMapX=!i.getScene().useRightHandedSystem,i.invertNormalMapY=i.getScene().useRightHandedSystem,t.clearcoatNormalTexture.scale!=null&&(i.clearCoat.bumpTexture.level=t.clearcoatNormalTexture.scale)),Promise.all(r).then(()=>{})}}it.RegisterExtension(Mp,o=>new y2(o));const Op="KHR_materials_iridescence";class C2{constructor(e){this.name=Op,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(Op)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadIridescencePropertiesAsync(r,s,i)),Promise.all(n).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,i){var r,s,n,a,l;if(!(i instanceof He))throw new Error(`${e}: Material type not supported`);const c=new Array;return i.iridescence.isEnabled=!0,i.iridescence.intensity=(r=t.iridescenceFactor)!==null&&r!==void 0?r:0,i.iridescence.indexOfRefraction=(n=(s=t.iridescenceIor)!==null&&s!==void 0?s:t.iridescenceIOR)!==null&&n!==void 0?n:1.3,i.iridescence.minimumThickness=(a=t.iridescenceThicknessMinimum)!==null&&a!==void 0?a:100,i.iridescence.maximumThickness=(l=t.iridescenceThicknessMaximum)!==null&&l!==void 0?l:400,t.iridescenceTexture&&c.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,h=>{h.name=`${i.name} (Iridescence Intensity)`,i.iridescence.texture=h})),t.iridescenceThicknessTexture&&c.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,h=>{h.name=`${i.name} (Iridescence Thickness)`,i.iridescence.thicknessTexture=h})),Promise.all(c).then(()=>{})}}it.RegisterExtension(Op,o=>new C2(o));const Dp="KHR_materials_emissive_strength";class A2{constructor(e){this.name=Dp,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(Dp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>this._loader.loadMaterialPropertiesAsync(e,t,i).then(()=>{this._loadEmissiveProperties(r,s,i)}))}_loadEmissiveProperties(e,t,i){if(!(i instanceof He))throw new Error(`${e}: Material type not supported`);t.emissiveStrength!==void 0&&i.emissiveColor.scaleToRef(t.emissiveStrength,i.emissiveColor)}}it.RegisterExtension(Dp,o=>new A2(o));const Np="KHR_materials_sheen";class R2{constructor(e){this.name=Np,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Np)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadSheenPropertiesAsync(r,s,i)),Promise.all(n).then(()=>{})})}_loadSheenPropertiesAsync(e,t,i){if(!(i instanceof He))throw new Error(`${e}: Material type not supported`);const r=new Array;return i.sheen.isEnabled=!0,i.sheen.intensity=1,t.sheenColorFactor!=null?i.sheen.color=ge.FromArray(t.sheenColorFactor):i.sheen.color=ge.Black(),t.sheenColorTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,s=>{s.name=`${i.name} (Sheen Color)`,i.sheen.texture=s})),t.sheenRoughnessFactor!==void 0?i.sheen.roughness=t.sheenRoughnessFactor:i.sheen.roughness=0,t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,s=>{s.name=`${i.name} (Sheen Roughness)`,i.sheen.textureRoughness=s}))),i.sheen.albedoScaling=!0,i.sheen.useRoughnessFromMainTexture=!1,Promise.all(r).then(()=>{})}}it.RegisterExtension(Np,o=>new R2(o));const wp="KHR_materials_specular";class I2{constructor(e){this.name=wp,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(wp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadSpecularPropertiesAsync(r,s,i)),Promise.all(n).then(()=>{})})}_loadSpecularPropertiesAsync(e,t,i){if(!(i instanceof He))throw new Error(`${e}: Material type not supported`);const r=new Array;return t.specularFactor!==void 0&&(i.metallicF0Factor=t.specularFactor),t.specularColorFactor!==void 0&&(i.metallicReflectanceColor=ge.FromArray(t.specularColorFactor)),t.specularTexture&&(t.specularTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,s=>{s.name=`${i.name} (Specular F0 Strength)`,i.metallicReflectanceTexture=s,i.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),t.specularColorTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,s=>{s.name=`${i.name} (Specular F0 Color)`,i.reflectanceTexture=s})),Promise.all(r).then(()=>{})}}it.RegisterExtension(wp,o=>new I2(o));const Fp="KHR_materials_ior";class e_{constructor(e){this.name=Fp,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(Fp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadIorPropertiesAsync(r,s,i)),Promise.all(n).then(()=>{})})}_loadIorPropertiesAsync(e,t,i){if(!(i instanceof He))throw new Error(`${e}: Material type not supported`);return t.ior!==void 0?i.indexOfRefraction=t.ior:i.indexOfRefraction=e_._DEFAULT_IOR,Promise.resolve()}}e_._DEFAULT_IOR=1.5;it.RegisterExtension(Fp,o=>new e_(o));const Rn="KHR_materials_variants";class pl{constructor(e){this.name=Rn,this._loader=e,this.enabled=this._loader.isExtensionUsed(Rn)}dispose(){this._loader=null}static GetAvailableVariants(e){const t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return pl.GetAvailableVariants(e)}static SelectVariant(e,t){const i=this._GetExtensionMetadata(e);if(!i)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${Rn} extension`);const r=s=>{const n=i.variants[s];if(n)for(const a of n)a.mesh.material=a.material};if(t instanceof Array)for(const s of t)r(s);else r(t);i.lastSelected=t}selectVariant(e,t){return pl.SelectVariant(e,t)}static Reset(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot reset on a glTF mesh that does not have the ${Rn} extension`);for(const i of t.original)i.mesh.material=i.material;t.lastSelected=null}reset(e){return pl.Reset(e)}static GetLastSelectedVariant(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${Rn} extension`);return t.lastSelected}getLastSelectedVariant(e){return pl.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){var t,i;return((i=(t=e==null?void 0:e._internalMetadata)===null||t===void 0?void 0:t.gltf)===null||i===void 0?void 0:i[Rn])||null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._variants=t.variants}}_loadMeshPrimitiveAsync(e,t,i,r,s,n){return it.LoadExtensionAsync(e,s,this.name,(a,l)=>{const c=new Array;return c.push(this._loader._loadMeshPrimitiveAsync(e,t,i,r,s,h=>{if(n(h),h instanceof K){const u=it._GetDrawMode(e,s.mode),d=this._loader.rootBabylonMesh,f=d?d._internalMetadata=d._internalMetadata||{}:{},_=f.gltf=f.gltf||{},p=_[Rn]=_[Rn]||{lastSelected:null,original:[],variants:{}};p.original.push({mesh:h,material:h.material});for(let m=0;m<l.mappings.length;++m){const T=l.mappings[m],b=xt.Get(`${a}/mappings/${m}/material`,this._loader.gltf.materials,T.material);c.push(this._loader._loadMaterialAsync(`#/materials/${T.material}`,b,h,u,y=>{for(let S=0;S<T.variants.length;++S){const C=T.variants[S],I=xt.Get(`/extensions/${Rn}/variants/${C}`,this._variants,C);p.variants[I.name]=p.variants[I.name]||[],p.variants[I.name].push({mesh:h,material:y}),h.onClonedObservable.add(P=>{const D=P;let w=null,L=D;do{if(L=L.parent,!L)return;w=pl._GetExtensionMetadata(L)}while(w===null);if(d&&w===pl._GetExtensionMetadata(d)){L._internalMetadata={};for(const U in d._internalMetadata)L._internalMetadata[U]=d._internalMetadata[U];L._internalMetadata.gltf=[];for(const U in d._internalMetadata.gltf)L._internalMetadata.gltf[U]=d._internalMetadata.gltf[U];L._internalMetadata.gltf[Rn]={lastSelected:null,original:[],variants:{}};for(const U of w.original)L._internalMetadata.gltf[Rn].original.push({mesh:U.mesh,material:U.material});for(const U in w.variants)if(Object.prototype.hasOwnProperty.call(w.variants,U)){L._internalMetadata.gltf[Rn].variants[U]=[];for(const G of w.variants[U])L._internalMetadata.gltf[Rn].variants[U].push({mesh:G.mesh,material:G.material})}w=L._internalMetadata.gltf[Rn]}for(const U of w.original)U.mesh===h&&(U.mesh=D);for(const U of w.variants[I.name])U.mesh===h&&(U.mesh=D)})}}))}}})),Promise.all(c).then(([h])=>h)})}}it.RegisterExtension(Rn,o=>new pl(o));class Qm{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:ie.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...Qm._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new Q,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(s=>this._options[s]!==e[s]).length)return;const i={...this._options,...e},r=this._options;this._options=i,i.renderSize!==r.renderSize||i.renderTargetTextureType!==r.renderTargetTextureType||i.generateMipmaps!==r.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=i.samples,this._opaqueRenderTarget.lodGenerationScale=i.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=i.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return e?!!(e instanceof He&&e.subSurface.isRefractionEnabled):!1}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),J.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);t!==-1&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),t!==-1&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const t=this._transparentMeshesCache.indexOf(e),i=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof He&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),i!==-1?(this._opaqueMeshesCache.splice(i,1),this._transparentMeshesCache.push(e)):t===-1&&this._transparentMeshesCache.push(e)):t!==-1?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):i===-1&&this._opaqueMeshesCache.push(e)}_setupRenderTargets(){var e,t;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new Zi("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=(t=(e=this._options.clearColor)===null||e===void 0?void 0:e.clone())!==null&&t!==void 0?t:this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples;let i,r;this._opaqueRenderTarget.onBeforeBindObservable.add(s=>{r=this._scene.environmentIntensity,this._scene.environmentIntensity=1,i=this._scene.imageProcessingConfiguration.applyByPostProcess,this._options.clearColor?s.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(s.clearColor),this._scene.imageProcessingConfiguration._applyByPostProcess=!0}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=r,this._scene.imageProcessingConfiguration._applyByPostProcess=i}),this._transparentMeshesCache.forEach(s=>{this._shouldRenderAsTransmission(s.material)&&(s.material.refractionTexture=this._opaqueRenderTarget)})}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const Lp="KHR_materials_transmission";class P2{constructor(e){this.name=Lp,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(Lp),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>{const n=new Array;return n.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadTransparentPropertiesAsync(r,t,i,s)),Promise.all(n).then(()=>{})})}_loadTransparentPropertiesAsync(e,t,i,r){if(!(i instanceof He))throw new Error(`${e}: Material type not supported`);const s=i;if(s.subSurface.isRefractionEnabled=!0,s.subSurface.volumeIndexOfRefraction=1,s.subSurface.useAlbedoToTintRefraction=!0,r.transmissionFactor!==void 0){s.subSurface.refractionIntensity=r.transmissionFactor;const n=s.getScene();s.subSurface.refractionIntensity&&!n._transmissionHelper&&new Qm({},s.getScene())}else return s.subSurface.refractionIntensity=0,s.subSurface.isRefractionEnabled=!1,Promise.resolve();return s.subSurface.minimumThickness=0,s.subSurface.maximumThickness=0,r.transmissionTexture?(r.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,r.transmissionTexture,void 0).then(n=>{s.subSurface.refractionIntensityTexture=n,s.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}it.RegisterExtension(Lp,o=>new P2(o));const Bp="KHR_materials_translucency";class M2{constructor(e){this.name=Bp,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(Bp),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>{const n=new Array;return n.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadTranslucentPropertiesAsync(r,t,i,s)),Promise.all(n).then(()=>{})})}_loadTranslucentPropertiesAsync(e,t,i,r){if(!(i instanceof He))throw new Error(`${e}: Material type not supported`);const s=i;if(s.subSurface.isTranslucencyEnabled=!0,s.subSurface.volumeIndexOfRefraction=1,s.subSurface.minimumThickness=0,s.subSurface.maximumThickness=0,s.subSurface.useAlbedoToTintTranslucency=!0,r.translucencyFactor!==void 0)s.subSurface.translucencyIntensity=r.translucencyFactor;else return s.subSurface.translucencyIntensity=0,s.subSurface.isTranslucencyEnabled=!1,Promise.resolve();return r.translucencyTexture?(r.translucencyTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/translucencyTexture`,r.translucencyTexture).then(n=>{s.subSurface.translucencyIntensityTexture=n})):Promise.resolve()}}it.RegisterExtension(Bp,o=>new M2(o));const Up="KHR_materials_volume";class O2{constructor(e){this.name=Up,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(Up),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>{const n=new Array;return n.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadVolumePropertiesAsync(r,t,i,s)),Promise.all(n).then(()=>{})})}_loadVolumePropertiesAsync(e,t,i,r){if(!(i instanceof He))throw new Error(`${e}: Material type not supported`);if(!i.subSurface.isRefractionEnabled&&!i.subSurface.isTranslucencyEnabled||!r.thicknessFactor)return Promise.resolve();i.subSurface.volumeIndexOfRefraction=i.indexOfRefraction;const s=r.attenuationDistance!==void 0?r.attenuationDistance:Number.MAX_VALUE;return i.subSurface.tintColorAtDistance=s,r.attenuationColor!==void 0&&r.attenuationColor.length==3&&i.subSurface.tintColor.copyFromFloats(r.attenuationColor[0],r.attenuationColor[1],r.attenuationColor[2]),i.subSurface.minimumThickness=0,i.subSurface.maximumThickness=r.thicknessFactor,i.subSurface.useThicknessAsDepth=!0,r.thicknessTexture?(r.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,r.thicknessTexture).then(n=>{i.subSurface.thicknessTexture=n,i.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}it.RegisterExtension(Up,o=>new O2(o));const Vp="KHR_mesh_quantization";class D2{constructor(e){this.name=Vp,this.enabled=e.isExtensionUsed(Vp)}dispose(){}}it.RegisterExtension(Vp,o=>new D2(o));const kp="KHR_texture_basisu";class N2{constructor(e){this.name=kp,this._loader=e,this.enabled=e.isExtensionUsed(kp)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>{const n=t.sampler==null?it.DefaultSampler:xt.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=xt.Get(`${r}/source`,this._loader.gltf.images,s.source);return this._loader._createTextureAsync(e,n,a,l=>{i(l)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)})}}it.RegisterExtension(kp,o=>new N2(o));const Gp="KHR_texture_transform";class w2{constructor(e){this.name=Gp,this._loader=e,this.enabled=this._loader.isExtensionUsed(Gp)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>this._loader.loadTextureInfoAsync(e,t,n=>{if(!(n instanceof Y))throw new Error(`${r}: Texture type not supported`);s.offset&&(n.uOffset=s.offset[0],n.vOffset=s.offset[1]),n.uRotationCenter=0,n.vRotationCenter=0,s.rotation&&(n.wAng=-s.rotation),s.scale&&(n.uScale=s.scale[0],n.vScale=s.scale[1]),s.texCoord!=null&&(n.coordinatesIndex=s.texCoord),i(n)}))}}it.RegisterExtension(Gp,o=>new w2(o));const zp="KHR_xmp_json_ld";class F2{constructor(e){this.name=zp,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(zp)}dispose(){this._loader=null}onLoading(){var e,t,i;if(this._loader.rootBabylonMesh===null)return;const r=(e=this._loader.gltf.extensions)===null||e===void 0?void 0:e.KHR_xmp_json_ld,s=(i=(t=this._loader.gltf.asset)===null||t===void 0?void 0:t.extensions)===null||i===void 0?void 0:i.KHR_xmp_json_ld;if(r&&s){const n=+s.packet;r.packets&&n<r.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=r.packets[n])}}}it.RegisterExtension(zp,o=>new F2(o));function Lc(o,e,t,i){return ge.FromArray(e,t).scale(i)}function L2(o,e,t,i){return e[t+3]*i}function vr(o,e,t,i){return e[t]*i}function Hp(o,e,t,i){return-e[t]*i}function of(o,e,t,i){return e[t+1]*i}function zx(o,e,t,i){return e[t]*i*2}function U_(o){return{scale:[new tr(ae.ANIMATIONTYPE_FLOAT,`${o}.uScale`,vr,()=>2),new tr(ae.ANIMATIONTYPE_FLOAT,`${o}.vScale`,of,()=>2)],offset:[new tr(ae.ANIMATIONTYPE_FLOAT,`${o}.uOffset`,vr,()=>2),new tr(ae.ANIMATIONTYPE_FLOAT,`${o}.vOffset`,of,()=>2)],rotation:[new tr(ae.ANIMATIONTYPE_FLOAT,`${o}.wAng`,Hp,()=>1)]}}class Fo extends qu{buildAnimations(e,t,i,r,s){s(e._babylonCamera,this._buildAnimation(t,i,r))}}class tr extends qu{buildAnimations(e,t,i,r,s){for(const n in e._data)s(e._data[n].babylonMaterial,this._buildAnimation(t,i,r))}}class Vh extends qu{buildAnimations(e,t,i,r,s){s(e._babylonLight,this._buildAnimation(t,i,r))}}const B2={__array__:{__target__:!0,...zh}},U2={__array__:{__target__:!0,orthographic:{xmag:[new Fo(ae.ANIMATIONTYPE_FLOAT,"orthoLeft",Hp,()=>1),new Fo(ae.ANIMATIONTYPE_FLOAT,"orthoRight",of,()=>1)],ymag:[new Fo(ae.ANIMATIONTYPE_FLOAT,"orthoBottom",Hp,()=>1),new Fo(ae.ANIMATIONTYPE_FLOAT,"orthoTop",of,()=>1)],zfar:[new Fo(ae.ANIMATIONTYPE_FLOAT,"maxZ",vr,()=>1)],znear:[new Fo(ae.ANIMATIONTYPE_FLOAT,"minZ",vr,()=>1)]},perspective:{yfov:[new Fo(ae.ANIMATIONTYPE_FLOAT,"fov",vr,()=>1)],zfar:[new Fo(ae.ANIMATIONTYPE_FLOAT,"maxZ",vr,()=>1)],znear:[new Fo(ae.ANIMATIONTYPE_FLOAT,"minZ",vr,()=>1)]}}},V2={__array__:{__target__:!0,pbrMetallicRoughness:{baseColorFactor:[new tr(ae.ANIMATIONTYPE_COLOR3,"albedoColor",Lc,()=>4),new tr(ae.ANIMATIONTYPE_FLOAT,"alpha",L2,()=>4)],metallicFactor:[new tr(ae.ANIMATIONTYPE_FLOAT,"metallic",vr,()=>1)],roughnessFactor:[new tr(ae.ANIMATIONTYPE_FLOAT,"roughness",vr,()=>1)],baseColorTexture:{extensions:{KHR_texture_transform:U_("albedoTexture")}}},emissiveFactor:[new tr(ae.ANIMATIONTYPE_COLOR3,"emissiveColor",Lc,()=>3)],normalTexture:{scale:[new tr(ae.ANIMATIONTYPE_FLOAT,"bumpTexture.level",vr,()=>1)]},occlusionTexture:{strength:[new tr(ae.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",vr,()=>1)],extensions:{KHR_texture_transform:U_("ambientTexture")}},emissiveTexture:{extensions:{KHR_texture_transform:U_("emissiveTexture")}},extensions:{KHR_materials_ior:{ior:[new tr(ae.ANIMATIONTYPE_FLOAT,"indexOfRefraction",vr,()=>1)]},KHR_materials_clearcoat:{clearcoatFactor:[new tr(ae.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",vr,()=>1)],clearcoatRoughnessFactor:[new tr(ae.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",vr,()=>1)]},KHR_materials_sheen:{sheenColorFactor:[new tr(ae.ANIMATIONTYPE_COLOR3,"sheen.color",Lc,()=>3)],sheenRoughnessFactor:[new tr(ae.ANIMATIONTYPE_FLOAT,"sheen.roughness",vr,()=>1)]},KHR_materials_specular:{specularFactor:[new tr(ae.ANIMATIONTYPE_FLOAT,"metallicF0Factor",vr,()=>1)],specularColorFactor:[new tr(ae.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",Lc,()=>3)]},KHR_materials_emissive_strength:{emissiveStrength:[new tr(ae.ANIMATIONTYPE_FLOAT,"emissiveIntensity",vr,()=>1)]},KHR_materials_transmission:{transmissionFactor:[new tr(ae.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",vr,()=>1)]},KHR_materials_volume:{attenuationColor:[new tr(ae.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",Lc,()=>3)],attenuationDistance:[new tr(ae.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",vr,()=>1)],thicknessFactor:[new tr(ae.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",vr,()=>1)]},KHR_materials_iridescence:{iridescenceFactor:[new tr(ae.ANIMATIONTYPE_FLOAT,"iridescence.intensity",vr,()=>1)],iridescenceIor:[new tr(ae.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",vr,()=>1)],iridescenceThicknessMinimum:[new tr(ae.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",vr,()=>1)],iridescenceThicknessMaximum:[new tr(ae.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",vr,()=>1)]}}}},k2={KHR_lights_punctual:{lights:{__array__:{__target__:!0,color:[new Vh(ae.ANIMATIONTYPE_COLOR3,"diffuse",Lc,()=>3)],intensity:[new Vh(ae.ANIMATIONTYPE_FLOAT,"intensity",vr,()=>1)],range:[new Vh(ae.ANIMATIONTYPE_FLOAT,"range",vr,()=>1)],spot:{innerConeAngle:[new Vh(ae.ANIMATIONTYPE_FLOAT,"innerAngle",zx,()=>1)],outerConeAngle:[new Vh(ae.ANIMATIONTYPE_FLOAT,"angle",zx,()=>1)]}}}}},G2={nodes:B2,materials:V2,cameras:U2,extensions:k2},Wp="KHR_animation_pointer";class z2{constructor(e){this.name=Wp,this._loader=e}get enabled(){return this._loader.isExtensionUsed(Wp)}dispose(){this._loader=null}_loadAnimationChannelAsync(e,t,i,r,s){var n;const a=(n=r.target.extensions)===null||n===void 0?void 0:n.KHR_animation_pointer;if(!a)return null;r.target.path!=="pointer"&&X.Warn(`${e}/target/path: Value (${r.target.path}) must be (pointer) when using the ${this.name} extension`),r.target.node!=null&&X.Warn(`${e}/target/node: Value (${r.target.node}) must not be present when using the ${this.name} extension`);const l=`${e}/extensions/${this.name}`,c=a.pointer;if(!c)throw new Error(`${l}: Pointer is missing`);const h=this._parseAnimationPointer(`${l}/pointer`,c);return h?this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,i,r,h,s):(X.Warn(`${l}/pointer: Invalid pointer (${c}) skipped`),null)}_parseAnimationPointer(e,t){if(!t.startsWith("/"))return X.Warn(`${e}: Value (${t}) must start with a slash`),null;const i=t.split("/");i.shift();let r=G2,s=this._loader.gltf,n;for(const a of i){if(r.__array__)r=r.__array__;else if(r=r[a],!r)return null;s=s&&s[a],r.__target__&&(n=s)}return!n||!Array.isArray(r)?null:{target:n,properties:r}}}it.RegisterExtension(Wp,o=>new z2(o));const Xp="MSFT_audio_emitter";class H2{constructor(e){this.name=Xp,this._loader=e,this.enabled=this._loader.isExtensionUsed(Xp)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,xt.Assign(this._clips),xt.Assign(this._emitters)}}loadSceneAsync(e,t){return it.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=new Array;s.push(this._loader.loadSceneAsync(e,t));for(const n of r.emitters){const a=xt.Get(`${i}/emitters`,this._emitters,n);if(a.refDistance!=null||a.maxDistance!=null||a.rolloffFactor!=null||a.distanceModel!=null||a.innerAngle!=null||a.outerAngle!=null)throw new Error(`${i}: Direction or Distance properties are not allowed on emitters attached to a scene`);s.push(this._loadEmitterAsync(`${i}/emitters/${a.index}`,a))}return Promise.all(s).then(()=>{})})}loadNodeAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>{const n=new Array;return this._loader.loadNodeAsync(r,t,a=>{for(const l of s.emitters){const c=xt.Get(`${r}/emitters`,this._emitters,l);n.push(this._loadEmitterAsync(`${r}/emitters/${c.index}`,c).then(()=>{for(const h of c._babylonSounds)h.attachToMesh(a),(c.innerAngle!=null||c.outerAngle!=null)&&(h.setLocalDirectionToMesh(x.Forward()),h.setDirectionalCone(2*J.ToDegrees(c.innerAngle==null?Math.PI:c.innerAngle),2*J.ToDegrees(c.outerAngle==null?Math.PI:c.outerAngle),0))}))}i(a)}).then(a=>Promise.all(n).then(()=>a))})}loadAnimationAsync(e,t){return it.LoadExtensionAsync(e,t,this.name,(i,r)=>this._loader.loadAnimationAsync(e,t).then(s=>{const n=new Array;xt.Assign(r.events);for(const a of r.events)n.push(this._loadAnimationEventAsync(`${i}/events/${a.index}`,e,t,a,s));return Promise.all(n).then(()=>s)}))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let i;if(t.uri)i=this._loader.loadUriAsync(e,t,t.uri);else{const r=xt.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);i=this._loader.loadBufferViewAsync(`/bufferViews/${r.index}`,r)}return t._objectURL=i.then(r=>URL.createObjectURL(new Blob([r],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const i=new Array,r=t.name||`emitter${t.index}`,s={loop:!1,autoplay:!1,volume:t.volume==null?1:t.volume};for(let a=0;a<t.clips.length;a++){const l=`/extensions/${this.name}/clips`,c=xt.Get(l,this._clips,t.clips[a].clip);i.push(this._loadClipAsync(`${l}/${t.clips[a].clip}`,c).then(h=>{const u=t._babylonSounds[a]=new Ga(r,h,this._loader.babylonScene,null,s);u.refDistance=t.refDistance||1,u.maxDistance=t.maxDistance||256,u.rolloffFactor=t.rolloffFactor||1,u.distanceModel=t.distanceModel||"exponential"}))}const n=Promise.all(i).then(()=>{const a=t.clips.map(c=>c.weight||1),l=new FS(t.loop||!1,t._babylonSounds,a);t.innerAngle&&(l.directionalConeInnerAngle=2*J.ToDegrees(t.innerAngle)),t.outerAngle&&(l.directionalConeOuterAngle=2*J.ToDegrees(t.outerAngle)),t.volume&&(l.volume=t.volume),t._babylonData.sound=l});t._babylonData={loaded:n}}return t._babylonData.loaded}_getEventAction(e,t,i,r,s){switch(i){case"play":return n=>{const a=(s||0)+(n-r);t.play(a)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${i}`)}}_loadAnimationEventAsync(e,t,i,r,s){if(s.targetedAnimations.length==0)return Promise.resolve();const n=s.targetedAnimations[0],a=r.emitter,l=xt.Get(`/extensions/${this.name}/emitters`,this._emitters,a);return this._loadEmitterAsync(e,l).then(()=>{const c=l._babylonData.sound;if(c){const h=new nm(r.time,this._getEventAction(e,c,r.action,r.time,r.startOffset));n.animation.addEvent(h),s.onAnimationGroupEndObservable.add(()=>{c.stop()}),s.onAnimationGroupPauseObservable.add(()=>{c.pause()})}})}}it.RegisterExtension(Xp,o=>new H2(o));const $p="MSFT_lod";class W2{constructor(e){this.name=$p,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new Q,this.onMaterialLODsLoadedObservable=new Q,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed($p)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const t=Promise.all(this._nodePromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){const t=Promise.all(this._materialPromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){const i=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),i}loadNodeAsync(e,t,i){return it.LoadExtensionAsync(e,t,this.name,(r,s)=>{let n;const a=this._getLODs(r,t,this._loader.gltf.nodes,s.ids);this._loader.logOpen(`${r}`);for(let l=0;l<a.length;l++){const c=a[l];l!==0&&(this._nodeIndexLOD=l,this._nodeSignalLODs[l]=this._nodeSignalLODs[l]||new Gh);const h=d=>{i(d),d.setEnabled(!1)},u=this._loader.loadNodeAsync(`/nodes/${c.index}`,c,h).then(d=>{if(l!==0){const f=a[l-1];f._babylonTransformNode&&(this._disposeTransformNode(f._babylonTransformNode),delete f._babylonTransformNode)}return d.setEnabled(!0),d});this._nodePromiseLODs[l]=this._nodePromiseLODs[l]||[],l===0?n=u:(this._nodeIndexLOD=null,this._nodePromiseLODs[l].push(u))}return this._loader.logClose(),n})}_loadMaterialAsync(e,t,i,r,s){return this._nodeIndexLOD?null:it.LoadExtensionAsync(e,t,this.name,(n,a)=>{let l;const c=this._getLODs(n,t,this._loader.gltf.materials,a.ids);this._loader.logOpen(`${n}`);for(let h=0;h<c.length;h++){const u=c[h];h!==0&&(this._materialIndexLOD=h);const d=this._loader._loadMaterialAsync(`/materials/${u.index}`,u,i,r,f=>{h===0&&s(f)}).then(f=>{if(h!==0){s(f);const _=c[h-1]._data;_[r]&&(this._disposeMaterials([_[r].babylonMaterial]),delete _[r])}return f});this._materialPromiseLODs[h]=this._materialPromiseLODs[h]||[],h===0?l=d:(this._materialIndexLOD=null,this._materialPromiseLODs[h].push(d))}return this._loader.logClose(),l})}_loadUriAsync(e,t,i){if(this._nodeIndexLOD!==null){this._loader.log("deferred");const r=this._nodeIndexLOD-1;return this._nodeSignalLODs[r]=this._nodeSignalLODs[r]||new Gh,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(()=>this._loader.loadUriAsync(e,t,i))}else if(this._materialIndexLOD!==null){this._loader.log("deferred");const r=this._materialIndexLOD-1;return this._materialSignalLODs[r]=this._materialSignalLODs[r]||new Gh,this._materialSignalLODs[r].promise.then(()=>this._loader.loadUriAsync(e,t,i))}return null}loadBufferAsync(e,t,i,r){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const s=(n,a)=>{const l=i,c=l+r-1;let h=n[a];return h?(h.start=Math.min(h.start,l),h.end=Math.max(h.end,c)):(h={start:l,end:c,loaded:new Gh},n[a]=h),h.loaded.promise.then(u=>new Uint8Array(u.buffer,u.byteOffset+i-h.start,r))};return this._loader.log("deferred"),this._nodeIndexLOD!==null?s(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?s(this._materialBufferLODs,this._materialIndexLOD):s(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){const i=e[t];i&&(this._loader.log(`Loading buffer range [${i.start}-${i.end}]`),this._loader.bin.readAsync(i.start,i.end-i.start+1).then(r=>{i.loaded.resolve(r)},r=>{i.loaded.reject(r)}))}_getLODs(e,t,i,r){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const s=new Array;for(let n=r.length-1;n>=0;n--)if(s.push(xt.Get(`${e}/ids/${r[n]}`,i,r[n])),s.length===this.maxLODsToLoad)return s;return s.push(t),s}_disposeTransformNode(e){const t=new Array,i=e.material;i&&t.push(i);for(const s of e.getChildMeshes())s.material&&t.push(s.material);e.dispose();const r=t.filter(s=>this._loader.babylonScene.meshes.every(n=>n.material!=s));this._disposeMaterials(r)}_disposeMaterials(e){const t={};for(const i of e){for(const r of i.getActiveTextures())t[r.uniqueId]=r;i.dispose()}for(const i in t)for(const r of this._loader.babylonScene.materials)r.hasTexture(t[i])&&delete t[i];for(const i in t)t[i].dispose()}}it.RegisterExtension($p,o=>new W2(o));const Yp="MSFT_minecraftMesh";class X2{constructor(e){this.name=Yp,this._loader=e,this.enabled=this._loader.isExtensionUsed(Yp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return it.LoadExtraAsync(e,t,this.name,(r,s)=>{if(s){if(!(i instanceof He))throw new Error(`${r}: Material type not supported`);const n=this._loader.loadMaterialPropertiesAsync(e,t,i);return i.needAlphaBlending()&&(i.forceDepthWrite=!0,i.separateCullingPass=!0),i.backFaceCulling=i.forceDepthWrite,i.twoSidedLighting=!0,n}return null})}}it.RegisterExtension(Yp,o=>new X2(o));const jp="MSFT_sRGBFactors";class $2{constructor(e){this.name=jp,this._loader=e,this.enabled=this._loader.isExtensionUsed(jp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return it.LoadExtraAsync(e,t,this.name,(r,s)=>{if(s){if(!(i instanceof He))throw new Error(`${r}: Material type not supported`);const n=this._loader.loadMaterialPropertiesAsync(e,t,i);return i.albedoTexture||i.albedoColor.toLinearSpaceToRef(i.albedoColor),i.reflectivityTexture||i.reflectivityColor.toLinearSpaceToRef(i.reflectivityColor),n}return null})}}it.RegisterExtension(jp,o=>new $2(o));const GE="ExtrasAsMetadata";class Y2{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){const i=e.metadata=e.metadata||{},r=i.gltf=i.gltf||{};r.extras=t.extras}}constructor(e){this.name=GE,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,i){return this._loader.loadNodeAsync(e,t,r=>{this._assignExtras(r,t),i(r)})}loadCameraAsync(e,t,i){return this._loader.loadCameraAsync(e,t,r=>{this._assignExtras(r,t),i(r)})}createMaterial(e,t,i){const r=this._loader.createMaterial(e,t,i);return this._assignExtras(r,t),r}}it.RegisterExtension(GE,o=>new Y2(o));var Kp=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function zE(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var HE={exports:{}};(function(o,e){(function(t,i){o.exports=i()})(Kp,function(){function t(R,E){var v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"rgba(0, 0, 0, 0)";return Array.isArray(R)&&(R={r:R[0],g:R[1],b:R[2],a:R[3]}),E=="hex"?i(R):E=="rgb"?r(R,v):E=="hsl"?s(R):R}function i(R){Array.isArray(R)&&(R={r:R[0],g:R[1],b:R[2],a:R[3]});var E=R.r.toString(16);R.r<16&&(E="0"+E);var v=R.g.toString(16);R.g<16&&(v="0"+v);var g=R.b.toString(16);R.b<16&&(g="0"+g);var A="";if(R.a<1){var B=Math.floor(R.a*255),A=B.toString(16);B<16&&(A="0"+A)}return"#"+E+v+g+A}function r(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"rgba(0, 0, 0, 0)";if(Array.isArray(R)&&(R={r:R[0],g:R[1],b:R[2],a:R[3]}),!(typeof R>"u"))return R.a==1||typeof R.a>"u"?isNaN(R.r)?E:"rgb("+R.r+","+R.g+","+R.b+")":"rgba("+R.r+","+R.g+","+R.b+","+R.a+")"}function s(R){return Array.isArray(R)&&(R={r:R[0],g:R[1],b:R[2],a:R[3]}),R.a==1||typeof R.a>"u"?"hsl("+R.h+","+R.s+"%,"+R.l+"%)":"hsla("+R.h+","+R.s+"%,"+R.l+"%,"+R.a+")"}var n={format:t,rgb:r,hsl:s,hex:i};function a(R,E){return E=typeof E>"u"?1:E,Math.round(R*E)/E}function l(R){return R*Math.PI/180}function c(R){var E=R*180/Math.PI;return E<0&&(E=360+E),E}function h(R,E){var v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;return v+E*Math.cos(l(R))}function u(R,E){var v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;return v+E*Math.sin(l(R))}function d(R,E){var v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,g=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0;return{x:h(R,E,v),y:u(R,E,g)}}function f(R,E){return c(Math.atan2(E,R))}var _={round:a,radianToDegree:c,degreeToRadian:l,getXInCircle:h,getYInCircle:u,caculateAngle:f},p={aliceblue:"rgb(240, 248, 255)",antiquewhite:"rgb(250, 235, 215)",aqua:"rgb(0, 255, 255)",aquamarine:"rgb(127, 255, 212)",azure:"rgb(240, 255, 255)",beige:"rgb(245, 245, 220)",bisque:"rgb(255, 228, 196)",black:"rgb(0, 0, 0)",blanchedalmond:"rgb(255, 235, 205)",blue:"rgb(0, 0, 255)",blueviolet:"rgb(138, 43, 226)",brown:"rgb(165, 42, 42)",burlywood:"rgb(222, 184, 135)",cadetblue:"rgb(95, 158, 160)",chartreuse:"rgb(127, 255, 0)",chocolate:"rgb(210, 105, 30)",coral:"rgb(255, 127, 80)",cornflowerblue:"rgb(100, 149, 237)",cornsilk:"rgb(255, 248, 220)",crimson:"rgb(237, 20, 61)",cyan:"rgb(0, 255, 255)",darkblue:"rgb(0, 0, 139)",darkcyan:"rgb(0, 139, 139)",darkgoldenrod:"rgb(184, 134, 11)",darkgray:"rgb(169, 169, 169)",darkgrey:"rgb(169, 169, 169)",darkgreen:"rgb(0, 100, 0)",darkkhaki:"rgb(189, 183, 107)",darkmagenta:"rgb(139, 0, 139)",darkolivegreen:"rgb(85, 107, 47)",darkorange:"rgb(255, 140, 0)",darkorchid:"rgb(153, 50, 204)",darkred:"rgb(139, 0, 0)",darksalmon:"rgb(233, 150, 122)",darkseagreen:"rgb(143, 188, 143)",darkslateblue:"rgb(72, 61, 139)",darkslategray:"rgb(47, 79, 79)",darkslategrey:"rgb(47, 79, 79)",darkturquoise:"rgb(0, 206, 209)",darkviolet:"rgb(148, 0, 211)",deeppink:"rgb(255, 20, 147)",deepskyblue:"rgb(0, 191, 255)",dimgray:"rgb(105, 105, 105)",dimgrey:"rgb(105, 105, 105)",dodgerblue:"rgb(30, 144, 255)",firebrick:"rgb(178, 34, 34)",floralwhite:"rgb(255, 250, 240)",forestgreen:"rgb(34, 139, 34)",fuchsia:"rgb(255, 0, 255)",gainsboro:"rgb(220, 220, 220)",ghostwhite:"rgb(248, 248, 255)",gold:"rgb(255, 215, 0)",goldenrod:"rgb(218, 165, 32)",gray:"rgb(128, 128, 128)",grey:"rgb(128, 128, 128)",green:"rgb(0, 128, 0)",greenyellow:"rgb(173, 255, 47)",honeydew:"rgb(240, 255, 240)",hotpink:"rgb(255, 105, 180)",indianred:"rgb(205, 92, 92)",indigo:"rgb(75, 0, 130)",ivory:"rgb(255, 255, 240)",khaki:"rgb(240, 230, 140)",lavender:"rgb(230, 230, 250)",lavenderblush:"rgb(255, 240, 245)",lawngreen:"rgb(124, 252, 0)",lemonchiffon:"rgb(255, 250, 205)",lightblue:"rgb(173, 216, 230)",lightcoral:"rgb(240, 128, 128)",lightcyan:"rgb(224, 255, 255)",lightgoldenrodyellow:"rgb(250, 250, 210)",lightgreen:"rgb(144, 238, 144)",lightgray:"rgb(211, 211, 211)",lightgrey:"rgb(211, 211, 211)",lightpink:"rgb(255, 182, 193)",lightsalmon:"rgb(255, 160, 122)",lightseagreen:"rgb(32, 178, 170)",lightskyblue:"rgb(135, 206, 250)",lightslategray:"rgb(119, 136, 153)",lightslategrey:"rgb(119, 136, 153)",lightsteelblue:"rgb(176, 196, 222)",lightyellow:"rgb(255, 255, 224)",lime:"rgb(0, 255, 0)",limegreen:"rgb(50, 205, 50)",linen:"rgb(250, 240, 230)",magenta:"rgb(255, 0, 255)",maroon:"rgb(128, 0, 0)",mediumaquamarine:"rgb(102, 205, 170)",mediumblue:"rgb(0, 0, 205)",mediumorchid:"rgb(186, 85, 211)",mediumpurple:"rgb(147, 112, 219)",mediumseagreen:"rgb(60, 179, 113)",mediumslateblue:"rgb(123, 104, 238)",mediumspringgreen:"rgb(0, 250, 154)",mediumturquoise:"rgb(72, 209, 204)",mediumvioletred:"rgb(199, 21, 133)",midnightblue:"rgb(25, 25, 112)",mintcream:"rgb(245, 255, 250)",mistyrose:"rgb(255, 228, 225)",moccasin:"rgb(255, 228, 181)",navajowhite:"rgb(255, 222, 173)",navy:"rgb(0, 0, 128)",oldlace:"rgb(253, 245, 230)",olive:"rgb(128, 128, 0)",olivedrab:"rgb(107, 142, 35)",orange:"rgb(255, 165, 0)",orangered:"rgb(255, 69, 0)",orchid:"rgb(218, 112, 214)",palegoldenrod:"rgb(238, 232, 170)",palegreen:"rgb(152, 251, 152)",paleturquoise:"rgb(175, 238, 238)",palevioletred:"rgb(219, 112, 147)",papayawhip:"rgb(255, 239, 213)",peachpuff:"rgb(255, 218, 185)",peru:"rgb(205, 133, 63)",pink:"rgb(255, 192, 203)",plum:"rgb(221, 160, 221)",powderblue:"rgb(176, 224, 230)",purple:"rgb(128, 0, 128)",rebeccapurple:"rgb(102, 51, 153)",red:"rgb(255, 0, 0)",rosybrown:"rgb(188, 143, 143)",royalblue:"rgb(65, 105, 225)",saddlebrown:"rgb(139, 69, 19)",salmon:"rgb(250, 128, 114)",sandybrown:"rgb(244, 164, 96)",seagreen:"rgb(46, 139, 87)",seashell:"rgb(255, 245, 238)",sienna:"rgb(160, 82, 45)",silver:"rgb(192, 192, 192)",skyblue:"rgb(135, 206, 235)",slateblue:"rgb(106, 90, 205)",slategray:"rgb(112, 128, 144)",slategrey:"rgb(112, 128, 144)",snow:"rgb(255, 250, 250)",springgreen:"rgb(0, 255, 127)",steelblue:"rgb(70, 130, 180)",tan:"rgb(210, 180, 140)",teal:"rgb(0, 128, 128)",thistle:"rgb(216, 191, 216)",tomato:"rgb(255, 99, 71)",turquoise:"rgb(64, 224, 208)",violet:"rgb(238, 130, 238)",wheat:"rgb(245, 222, 179)",white:"rgb(255, 255, 255)",whitesmoke:"rgb(245, 245, 245)",yellow:"rgb(255, 255, 0)",yellowgreen:"rgb(154, 205, 50)",transparent:"rgba(0, 0, 0, 0)"};function m(R){return!!p[R]}function T(R){return p[R]}var b={isColorName:m,getColorByName:T};function y(R,E,v){return v<0&&(v+=1),v>1&&(v-=1),v<1/6?R+(E-R)*6*v:v<1/2?E:v<2/3?R+(E-R)*(2/3-v)*6:R}function S(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.h,E=g.s,v=g.l;var A=C(R,E,v);return be(A.r,A.g,A.b)}function C(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.h,E=g.s,v=g.l;var A,B,V;if(R/=360,E/=100,v/=100,E==0)A=B=V=v;else{var $=v<.5?v*(1+E):v+E-v*E,ee=2*v-$;A=y(ee,$,R+1/3),B=y(ee,$,R),V=y(ee,$,R-1/3)}return{r:a(A*255),g:a(B*255),b:a(V*255)}}var I={HUEtoRGB:y,HSLtoHSV:S,HSLtoRGB:C},P=function(R,E){if(!(R instanceof E))throw new TypeError("Cannot call a class as a function")},D=function(){function R(E,v){for(var g=0;g<v.length;g++){var A=v[g];A.enumerable=A.enumerable||!1,A.configurable=!0,"value"in A&&(A.writable=!0),Object.defineProperty(E,A.key,A)}}return function(E,v,g){return v&&R(E.prototype,v),g&&R(E,g),E}}(),w=function(R,E,v){return E in R?Object.defineProperty(R,E,{value:v,enumerable:!0,configurable:!0,writable:!0}):R[E]=v,R},L=Object.assign||function(R){for(var E=1;E<arguments.length;E++){var v=arguments[E];for(var g in v)Object.prototype.hasOwnProperty.call(v,g)&&(R[g]=v[g])}return R},U=function R(E,v,g){E===null&&(E=Function.prototype);var A=Object.getOwnPropertyDescriptor(E,v);if(A===void 0){var B=Object.getPrototypeOf(E);return B===null?void 0:R(B,v,g)}else{if("value"in A)return A.value;var V=A.get;return V===void 0?void 0:V.call(g)}},G=function(R,E){if(typeof E!="function"&&E!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof E);R.prototype=Object.create(E&&E.prototype,{constructor:{value:R,enumerable:!1,writable:!0,configurable:!0}}),E&&(Object.setPrototypeOf?Object.setPrototypeOf(R,E):R.__proto__=E)},Z=function(R,E){if(!R)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return E&&(typeof E=="object"||typeof E=="function")?E:R},he=function(){function R(E,v){var g=[],A=!0,B=!1,V=void 0;try{for(var $=E[Symbol.iterator](),ee;!(A=(ee=$.next()).done)&&(g.push(ee.value),!(v&&g.length===v));A=!0);}catch(fe){B=!0,V=fe}finally{try{!A&&$.return&&$.return()}finally{if(B)throw V}}return g}return function(E,v){if(Array.isArray(E))return E;if(Symbol.iterator in Object(E))return R(E,v);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_e=function(R){return Array.isArray(R)?R:Array.from(R)},ne=function(R){if(Array.isArray(R)){for(var E=0,v=Array(R.length);E<R.length;E++)v[E]=R[E];return v}else return Array.from(R)},Pe=/(#(?:[\da-f]{3}){1,2}|#(?:[\da-f]{8})|rgb\((?:\s*\d{1,3},\s*){2}\d{1,3}\s*\)|rgba\((?:\s*\d{1,3},\s*){3}\d*\.?\d+\s*\)|hsl\(\s*\d{1,3}(?:,\s*\d{1,3}%){2}\s*\)|hsla\(\s*\d{1,3}(?:,\s*\d{1,3}%){2},\s*\d*\.?\d+\s*\)|([\w_\-]+))/gi,Se=",";function ce(R){var E=R.match(Pe),v=[];if(!E)return v;for(var g=0,A=E.length;g<A;g++)if(E[g].indexOf("#")>-1||E[g].indexOf("rgb")>-1||E[g].indexOf("hsl")>-1)v.push({color:E[g]});else{var B=b.getColorByName(E[g]);B&&v.push({color:E[g],nameColor:B})}var V={next:0};return v.forEach(function($){var ee=R.indexOf($.color,V.next);$.startIndex=ee,$.endIndex=ee+$.color.length,V.next=$.endIndex}),v}function de(R){var E=ce(R);return E.forEach(function(v,g){R=R.replace(v.color,"@"+g)}),{str:R,matches:E}}function k(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:",",v=de(R);return v.str.split(E).map(function(g,A){return g=xe(g),v.matches[A]&&(g=g.replace("@"+A,v.matches[A].color)),g})}function se(R,E){return E.forEach(function(v,g){R=R.replace("@"+g,v.color)}),R}function xe(R){return R.replace(/^\s+|\s+$/g,"")}function le(R){if(typeof R=="string"){if(b.isColorName(R)&&(R=b.getColorByName(R)),R.indexOf("rgb(")>-1){for(var E=R.replace("rgb(","").replace(")","").split(","),v=0,g=E.length;v<g;v++)E[v]=parseInt(xe(E[v]),10);var A={type:"rgb",r:E[0],g:E[1],b:E[2],a:1};return A=Object.assign(A,Ct(A)),A}else if(R.indexOf("rgba(")>-1){for(var E=R.replace("rgba(","").replace(")","").split(","),v=0,g=E.length;v<g;v++)g-1==v?E[v]=parseFloat(xe(E[v])):E[v]=parseInt(xe(E[v]),10);var A={type:"rgb",r:E[0],g:E[1],b:E[2],a:E[3]};return A=Object.assign(A,Ct(A)),A}else if(R.indexOf("hsl(")>-1){for(var E=R.replace("hsl(","").replace(")","").split(","),v=0,g=E.length;v<g;v++)E[v]=parseFloat(xe(E[v]));var A={type:"hsl",h:E[0],s:E[1],l:E[2],a:1};return A=Object.assign(A,C(A)),A}else if(R.indexOf("hsla(")>-1){for(var E=R.replace("hsla(","").replace(")","").split(","),v=0,g=E.length;v<g;v++)g-1==v?E[v]=parseFloat(xe(E[v])):E[v]=parseInt(xe(E[v]),10);var A={type:"hsl",h:E[0],s:E[1],l:E[2],a:E[3]};return A=Object.assign(A,C(A)),A}else if(R.indexOf("#")==0){R=R.replace("#","");var E=[],B=1;if(R.length==3)for(var v=0,g=R.length;v<g;v++){var V=R.substr(v,1);E.push(parseInt(V+V,16))}else if(R.length===8){for(var v=0,g=R.length;v<g;v+=2)E.push(parseInt(R.substr(v,2),16));B=E.pop()/255}else for(var v=0,g=R.length;v<g;v+=2)E.push(parseInt(R.substr(v,2),16));var A={type:"hex",r:E[0],g:E[1],b:E[2],a:B};return A=Object.assign(A,Ct(A)),A}}else if(typeof R=="number"){if(0<=R&&R<=16777215){var $=(R&16711680)>>16,ee=(R&65280)>>8,fe=(R&255)>>0,A={type:"hex",r:$,g:ee,b:fe,a:1};return A=Object.assign(A,Ct(A)),A}else if(0<=R&&R<=4294967295){var pe=(R&4278190080)>>24,Ae=(R&16711680)>>16,we=(R&65280)>>8,ct=(R&255)/255,A={type:"hex",r:pe,g:Ae,b:we,a:ct};return A=Object.assign(A,Ct(A)),A}}return R}function je(R){typeof R=="string"&&(R=k(R)),R=R.map(function(A){if(typeof A=="string"){var B=de(A),V=xe(B.str).split(" ");return V[1]?V[1].includes("%")?V[1]=parseFloat(V[1].replace(/%/,""))/100:V[1]=parseFloat(V[1]):V[1]="*",V[0]=se(V[0],B.matches),V}else if(Array.isArray(A))return A[1]?typeof A[1]=="string"&&(A[1].includes("%")?A[1]=parseFloat(A[1].replace(/%/,""))/100:A[1]=+A[1]):A[1]="*",[].concat(ne(A))});var E=R.filter(function(A){return A[1]==="*"}).length;if(E>0){var v=R.filter(function(A){return A[1]!="*"&&A[1]!=1}).map(function(A){return A[1]}).reduce(function(A,B){return A+B},0),g=(1-v)/E;R.forEach(function(A,B){A[1]=="*"&&B>0&&(R.length-1==B||(A[1]=g))})}return R}var st={matches:ce,convertMatches:de,convertMatchesArray:k,reverseMatches:se,parse:le,parseGradient:je,trim:xe,color_regexp:Pe,color_split:Se};function be(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.r,E=g.g,v=g.b;var A=R/255,B=E/255,V=v/255,$=Math.max(A,B,V),ee=Math.min(A,B,V),fe=$-ee,pe=0;fe==0?pe=0:$==A?pe=60*((B-V)/fe%6):$==B?pe=60*((V-A)/fe+2):$==V&&(pe=60*((A-B)/fe+4)),pe<0&&(pe=360+pe);var Ae=0;$==0?Ae=0:Ae=fe/$;var we=$;return{h:pe,s:Ae,v:we}}function We(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.r,E=g.g,v=g.b;var A=R/255,B=E/255,V=v/255,$=1-Math.max(A,B,V),ee=(1-A-$)/(1-$),fe=(1-B-$)/(1-$),pe=(1-V-$)/(1-$);return{c:ee,m:fe,y:pe,k:$}}function Ct(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.r,E=g.g,v=g.b;R/=255,E/=255,v/=255;var A=Math.max(R,E,v),B=Math.min(R,E,v),V,$,ee=(A+B)/2;if(A==B)V=$=0;else{var fe=A-B;switch($=ee>.5?fe/(2-A-B):fe/(A+B),A){case R:V=(E-v)/fe+(E<v?6:0);break;case E:V=(v-R)/fe+2;break;case v:V=(R-E)/fe+4;break}V/=6}return{h:a(V*360),s:a($*100),l:a(ee*100)}}function _t(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.r,E=g.g,v=g.b;return mt((R+E+v)/3>90?0:255)}function mt(R){return{r:R,g:R,b:R}}function Ge(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.r,E=g.g,v=g.b;return mt(Math.ceil((R+E+v)/3))}function Ut(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.r,E=g.g,v=g.b;return mt(Zt(R,E,v).y)}function Ft(R,E,v){return Math.ceil(R*.2126+E*.7152+v*.0722)}function Zt(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.r,E=g.g,v=g.b;var A=Ft(R,E,v),B=.564*(v-A),V=.713*(R-A);return{y:A,cr:V,cb:B}}function $t(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:.04045;return(R>E?Math.pow((R+.055)/1.055,2.4):R/12.92)*100}function Di(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.r,E=g.g,v=g.b;var A=R/255,B=E/255,V=v/255;A=$t(A),B=$t(B),V=$t(V);var $=A*.4124+B*.3576+V*.1805,ee=A*.2126+B*.7152+V*.0722,fe=A*.0193+B*.1192+V*.9505;return{x:$,y:ee,z:fe}}function Ui(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.r,E=g.g,v=g.b;return XYZtoLAB(Di(R,E,v))}var ar={RGBtoCMYK:We,RGBtoGray:Ut,RGBtoHSL:Ct,RGBtoHSV:be,RGBtoLAB:Ui,RGBtoSimpleGray:Ge,RGBtoXYZ:Di,RGBtoYCrCb:Zt,c:_t,brightness:Ft,gray:mt};function ti(R,E,v,g){if(arguments.length==1)var A=arguments[0],R=A.c,E=A.m,v=A.y,g=A.k;var B=255*(1-R)*(1-g),V=255*(1-E)*(1-g),$=255*(1-v)*(1-g);return{r:B,g:V,b:$}}var or={CMYKtoRGB:ti};function pi(R){return Math.pow(R,3)>.008856?Math.pow(R,3):(R-16/116)/7.787}function Si(R){return R>.0031308?1.055*Math.pow(R,1/2.4)-.055:12.92*R}function mi(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.x,E=g.y,v=g.z;var A=R/100,B=E/100,V=v/100,$=A*3.2406+B*-1.5372+V*-.4986,ee=A*-.9689+B*1.8758+V*.0415,fe=A*.0557+B*-.204+V*1.057;$=Si($),ee=Si(ee),fe=Si(fe);var pe=a($*255),Ae=a(ee*255),we=a(fe*255);return{r:pe,g:Ae,b:we}}function Is(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.l,E=g.a,v=g.b;var A=(R+16)/116,B=E/500+A,V=A-v/200;A=pi(A),B=pi(B),V=pi(V);var $=B*95.047,ee=A*100,fe=V*108.883;return{x:$,y:ee,z:fe}}function cn(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.l,E=g.a,v=g.b;return mi(Is(R,E,v))}var Js={XYZtoRGB:mi,LABtoRGB:cn,LABtoXYZ:Is};function Ur(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.h,E=g.s,v=g.v;var A=R,B=E,V=v;A>=360&&(A=0);var $=B*V,ee=$*(1-Math.abs(A/60%2-1)),fe=V-$,pe=[];return 0<=A&&A<60?pe=[$,ee,0]:60<=A&&A<120?pe=[ee,$,0]:120<=A&&A<180?pe=[0,$,ee]:180<=A&&A<240?pe=[0,ee,$]:240<=A&&A<300?pe=[ee,0,$]:300<=A&&A<360&&(pe=[$,0,ee]),{r:a((pe[0]+fe)*255),g:a((pe[1]+fe)*255),b:a((pe[2]+fe)*255)}}function Zn(R,E,v){if(arguments.length==1)var g=arguments[0],R=g.h,E=g.s,v=g.v;var A=Ur(R,E,v);return Ct(A.r,A.g,A.b)}var Un={HSVtoHSL:Zn,HSVtoRGB:Ur};function Es(R,E,v,g){if(arguments.length==1){var A=arguments[0],R=A.y,E=A.cr,v=A.cb,g=A.bit;g=g||0}var B=R+1.402*(E-g),V=R-.344*(v-g)-.714*(E-g),$=R+1.772*(v-g);return{r:Math.ceil(B),g:Math.ceil(V),b:Math.ceil($)}}var Ps={YCrCbtoRGB:Es};function en(R,E){var v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:.5,g=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"hex",A={r:a(R.r+(E.r-R.r)*v),g:a(R.g+(E.g-R.g)*v),b:a(R.b+(E.b-R.b)*v),a:a(R.a+(E.a-R.a)*v,100)};return t(A,A.a<1?"rgb":g)}function zi(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5;if(!R)return[];typeof R=="string"&&(R=k(R)),R=R||[];for(var v=R.length,g=[],A=0;A<v-1;A++)for(var B=0;B<E;B++)g.push(os(R[A],R[A+1],B/E));return g}function os(R,E){var v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:.5,g=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"hex",A=le(R),B=le(E);return en(A,B,v,g)}function ls(R,E){var v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:.5,g=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"hex";return os(R,E,v,g)}function Ir(R){return R=le(R),(Math.round(R.r*299)+Math.round(R.g*587)+Math.round(R.b*114))/1e3}function zs(R){return Ir(R)>=128?"black":"white"}function Vr(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:10;R=je(R);for(var v=[],g=E-(R.length-1),A=g,B=1,V=R.length;B<V;B++){var $=R[B-1][0],ee=R[B][0],fe=B==1?R[B][1]:R[B][1]-R[B-1][1],pe=B==R.length-1?A:Math.floor(fe*g);v=v.concat(zi([$,ee],pe),[ee]),A-=pe}return v}function Ni(R){for(var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"h",v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:9,g=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"rgb",A=arguments.length>4&&arguments[4]!==void 0?arguments[4]:0,B=arguments.length>5&&arguments[5]!==void 0?arguments[5]:1,V=arguments.length>6&&arguments[6]!==void 0?arguments[6]:100,$=le(R),ee=be($),fe=(B-A)*V/v,pe=[],Ae=1;Ae<=v;Ae++)ee[E]=Math.abs((V-fe*Ae)/V),pe.push(t(Ur(ee),g));return pe}function Ms(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:9,v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"rgb",g=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0,A=arguments.length>4&&arguments[4]!==void 0?arguments[4]:360;return Ni(R,"h",E,v,g,A,1)}function fr(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:9,v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"rgb",g=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0,A=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1;return Ni(R,"s",E,v,g,A,100)}function hn(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:9,v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"rgb",g=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0,A=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1;return Ni(R,"v",E,v,g,A,100)}zi.parula=function(R){return zi(["#352a87","#0f5cdd","#00b5a6","#ffc337","#fdff00"],R)},zi.jet=function(R){return zi(["#00008f","#0020ff","#00ffff","#51ff77","#fdff00","#ff0000","#800000"],R)},zi.hsv=function(R){return zi(["#ff0000","#ffff00","#00ff00","#00ffff","#0000ff","#ff00ff","#ff0000"],R)},zi.hot=function(R){return zi(["#0b0000","#ff0000","#ffff00","#ffffff"],R)},zi.pink=function(R){return zi(["#1e0000","#bd7b7b","#e7e5b2","#ffffff"],R)},zi.bone=function(R){return zi(["#000000","#4a4a68","#a6c6c6","#ffffff"],R)},zi.copper=function(R){return zi(["#000000","#3d2618","#9d623e","#ffa167","#ffc77f"],R)};var Ii={interpolateRGB:en,blend:os,mix:ls,scale:zi,contrast:Ir,contrastColor:zs,gradient:Vr,scaleHSV:Ni,scaleH:Ms,scaleS:fr,scaleV:hn};function re(R,E){if(R.length!==E.length)return!1;for(var v=0,g=R.length;v<g;++v)if(R[v]!==E[v])return!1;return!0}function Fe(R,E){for(var v=0,g=0,A=R.length;g<A;g++)v+=Math.pow(E[g]-R[g],2);return Math.sqrt(v)}function De(R,E){for(var v=0,g=0,A=R.length;g<A;g++)v+=Math.abs(E[g]-R[g]);return v}function At(R,E){for(var v=0,g=0,A=R.length;g<A;g++)v=Math.max(v,Math.abs(E[g]-R[g]));return v}var un={euclidean:Fe,manhattan:De,max:At},tn={linear:function(E,v){var g=[],A=Math.round(Math.random()*E),B=Math.floor(E/v);do g.push(A),A=(A+B)%E;while(g.length<v);return g},shuffle:function(E,v){for(var g=[];g.length<v;){var A=Math.round(Math.random()*E);g.indexOf(A)==-1&&g.push(A)}return g}};function Qu(R,E){var v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"linear",g=tn[v](R.length,E);return g.map(function(A){return R[A]})}function Pa(R,E,v){var g=1/0,A=0;return E.forEach(function(B,V){var $=v(R,B);$<g&&(g=$,A=V)}),A}function Zu(R){if(!R.length)return[];for(var E=new Array(R[0].length),v=0,g=E.length;v<g;v++)E[v]=0;for(var A=0,g=R.length;A<g;A++)for(var B=R[A],V=A+1,$=0,ee=B.length;$<ee;$++)E[$]+=(B[$]-E[$])/V;return E=E.map(function(fe){return Math.floor(fe)}),E}function Za(R){return R}function Ju(R,E,v,g){for(var A=new Array(R),B=0;B<R;B++)A[B]=[];for(var V=0,$=E.length;V<$;V++){var ee=E[V],fe=Pa(ee,v,g);A[fe].push(ee)}return A}function Ma(R,E,v,g,A,B){for(var V=0;V<R;V++){var $=v[V],ee=g[V],fe=new Array(ee.length);if($.length>0)fe=Zu($);else{var pe=Math.floor(B()*E.length);fe=E[pe]}re(fe,ee)?A=!1:A=!0,g[V]=fe}return A}function Mh(R,E,v){var g=arguments.length>3&&arguments[3]!==void 0?arguments[3]:10,A=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"linear";R=R,E=E||Math.max(2,Math.ceil(Math.sqrt(R.length/2)));var B=v||"euclidean";typeof B=="string"&&(B=un[B]);for(var V=0,$=function(){return V=(V*9301+49297)%233280,V/233280},ee=Qu(R,E,A),fe=!0,pe=0;fe;){var Ae=Ju(E,R,ee,B);if(fe=Ma(E,R,Ae,ee,!1,$),pe++,pe%g==0)break}return ee}function Oh(R,E){for(var v=0;v<R;v+=4)E(v)}function Mt(R,E){Oh(R.pixels.length,function(v){E(R.pixels,v)})}var ga={create:function(E,v){var g=document.createElement("canvas");return g.width=E||0,g.height=v||0,g},drawPixels:function(E){var v=this.create(E.width,E.height),g=v.getContext("2d"),A=g.getImageData(0,0,v.width,v.height);return A.data.set(E.pixels),g.putImageData(A,0,0),v},createHistogram:function(E,v,g,A){var B=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{black:!0,red:!1,green:!1,blue:!1},V=this.create(E,v),$=V.getContext("2d");$.clearRect(0,0,E,v),$.fillStyle="white",$.fillRect(0,0,E,v),$.globalAlpha=.7;var ee={black:!1};B.black?ee.black=!1:ee.black=!0,B.red?ee.red=!1:ee.red=!0,B.green?ee.green=!1:ee.green=!0,B.blue?ee.blue=!1:ee.blue=!0,Object.keys(g).forEach(function(fe){if(!ee[fe]){var pe=g[fe],Ae=Math.max.apply(Math,pe),we=E/pe.length;$.fillStyle=fe,pe.forEach(function(ct,at){var ot=v*(ct/Ae),Dt=at*we;$.fillRect(Dt,v-ot,we,ot)})}}),typeof A=="function"&&A(V)},getHistogram:function(E){for(var v=new Array(256),g=new Array(256),A=new Array(256),B=new Array(256),V=0;V<256;V++)v[V]=0,g[V]=0,A[V]=0,B[V]=0;return Mt(E,function($,ee){var fe=Math.round(gi.brightness($[ee],$[ee+1],$[ee+2]));v[fe]++,g[$[ee]]++,A[$[ee+1]]++,B[$[ee+2]]++}),{black:v,red:g,green:A,blue:B}},getBitmap:function(E,v){var g=this.drawPixels(E),A=g.getContext("2d"),B=A.getImageData(v.x||0,v.y||0,v.width||g.width,v.height||g.height).data;return{pixels:B,width:v.width,height:v.height}},putBitmap:function(E,v,g){var A=this.drawPixels(E),B=this.drawPixels(v),V=A.getContext("2d");return V.drawImage(B,g.x,g.y),E.pixels=V.getImageData(0,0,E.width,E.height).data,E}},Io=function(){function R(E){var v=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};P(this,R),this.isLoaded=!1,this.imageUrl=E,this.opt=v,this.initialize()}return D(R,[{key:"initialize",value:function(){this.canvas=this.createCanvas(),this.context=this.canvas.getContext("2d")}},{key:"createCanvas",value:function(){return document.createElement("canvas")}},{key:"load",value:function(v){this.loadImage(v)}},{key:"loadImage",value:function(v){var g=this,A=this.context;this.newImage=new Image;var B=this.newImage;B.onload=function(){var V=B.height/B.width;g.opt.canvasWidth&&g.opt.canvasHeight?(g.canvas.width=g.opt.canvasWidth,g.canvas.height=g.opt.canvasHeight):(g.canvas.width=g.opt.maxWidth?g.opt.maxWidth:B.width,g.canvas.height=g.canvas.width*V),A.drawImage(B,0,0,B.width,B.height,0,0,g.canvas.width,g.canvas.height),g.isLoaded=!0,v&&v()},this.getImageUrl(function(V){B.src=V})}},{key:"load",value:function(v){var g=this;this.newImage=new Image;var A=this.newImage;A.onload=function(){g.isLoaded=!0,v&&v()},this.getImageUrl(function(B){A.src=B})}},{key:"getImageUrl",value:function(v){if(typeof this.imageUrl=="string")return v(this.imageUrl);if(this.imageUrl instanceof Blob){var g=new FileReader;g.onload=function(A){v(A.target.result)},g.readAsDataURL(this.imageUrl)}}},{key:"getRGBA",value:function(v,g,A,B){return[v,g,A,B]}},{key:"toArray",value:function(v,g){var A=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},B=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),V=B.width,$=B.height,ee=new Uint8ClampedArray(B.data),fe={pixels:ee,width:V,height:$};v||(v=function(){return function(pe,Ae){Ae(pe)}}()),v(fe,function(pe){var Ae=ga.drawPixels(pe);A.returnTo=="canvas"?g(Ae):g(Ae.toDataURL(A.outputFormat||"image/png"))},A)}},{key:"toHistogram",value:function(v){var g=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),A=g.width,B=g.height,V=new Uint8ClampedArray(g.data),$={pixels:V,width:A,height:B};return ga.getHistogram($)}},{key:"toRGB",value:function(){for(var v=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),g=v.data,A=[],B=0,V=g.length;B<V;B+=4)A[A.length]=[g[B+0],g[B+1],g[B+2],g[B+3]];return A}}]),R}();function Jn(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:6,v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"hex";return R.length>E&&(R=Mh(R,E)),R.map(function(g){return t(g,v)})}function ea(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},v=arguments[2];if(v){if(v){var g=new Io(R,E);g.loadImage(function(){typeof v=="function"&&v(g.toRGB())})}}else{var g=new Io(R);g.loadImage(function(){typeof E=="function"&&E(g.toRGB())})}}function t_(R,E,v){var g=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{frameTimer:"full"};Sc(R,E,v,Object.assign({returnTo:"canvas"},g))}function Sc(R,E,v){var g=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{frameTimer:"full"},A=new Io(R);A.loadImage(function(){A.toArray(E,function(B){typeof v=="function"&&v(B)},g)})}function i_(R,E){var v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},g=new Io(R);g.loadImage(function(){typeof E=="function"&&E(g.toHistogram(v))})}function Dh(R){for(var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:.2,v=[],g=0;g<R.length;g++){var A=R[g];if(g==0){v[g]=[];continue}if(g==R.length-1){v[g]=[];continue}var B=R[g-1],V=R[g+1];(V[1]-B[1])/(V[0]-B[0]);var $=[B[0]+(V[0]-B[0])*E,B[1]+(V[1]-B[1])*E],ee=[[].concat(ne(B)),[].concat($)],fe=Math.sqrt(Math.pow(A[0]-B[0],2)+Math.pow(A[1]-B[1],2)),pe=Math.sqrt(Math.pow(V[0]-A[0],2)+Math.pow(V[1]-A[1],2)),Ae=fe/pe,we=ee[0][0]+(ee[1][0]-ee[0][0])*Ae,ct=ee[0][1]+(ee[1][1]-ee[0][1])*Ae;ee[0][0]+=A[0]-we,ee[0][1]+=A[1]-ct,ee[1][0]+=A[0]-we,ee[1][1]+=A[1]-ct,v[g]=ee}return v}function r_(R,E){var v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{width:200,height:100},g=new Io(R);g.loadImage(function(){ga.createHistogram(v.width||200,v.height||100,g.toHistogram(v),function(A){typeof E=="function"&&E(A.toDataURL("image/png"))},v)})}var ed={palette:Jn,ImageToCanvas:t_,ImageToHistogram:r_,ImageToRGB:ea,ImageToURL:Sc,histogram:i_,histogramToPoints:Dh},gi=L({},n,_,Ii,st,Ps,ar,or,Un,I,Js,ed);function Oa(R){return typeof R>"u"||R===null}function cs(R){return Oa(R)===!1}function Po(R){return typeof R=="string"}function yc(R){return typeof R=="function"}function Cc(R){return typeof R=="number"}var dn=[{rgb:"#ff0000",start:0},{rgb:"#ffff00",start:.17},{rgb:"#00ff00",start:.33},{rgb:"#00ffff",start:.5},{rgb:"#0000ff",start:.67},{rgb:"#ff00ff",start:.83},{rgb:"#ff0000",start:1}];function tl(R){for(var E,v,g=0;g<dn.length;g++)if(dn[g].start>=R){E=dn[g-1],v=dn[g];break}return E&&v?gi.mix(E.rgb,v.rgb,(R-E.start)/(v.start-E.start)):dn[0].rgb}function ve(R){for(var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:.1,v=arguments[2],g=Oa(v)?R-E:E,A=Oa(v)?R+scale:v,B=[],V=0;V<dn.length;V++){var $=dn[V];g<=$.start&&$.start<A?B.push({rgb:$.rgb,start:$.start}):dn[V+1]&&$.start<g&&g<dn[V+1].start?B.push({rgb:tl(g),start:g}):dn[V-1]&&dn[V-1].start<A&&A<$.start?B.push({rgb:tl(A),start:A}):$.start<g||$.start>A||B.push({rgb:$.rgb,start:$.start})}return B}function Ue(){for(var R=0,E=dn.length;R<E;R++){var v=dn[R],g=gi.parse(v.rgb);v.r=g.r,v.g=g.g,v.b=g.b}}Ue();var Je={colors:dn,checkHueColor:tl,getHueScale:ve},Ke={identity:function(){return[1,0,0,0,1,0,0,0,1]},stretching:function(E){return[E,0,0,0,1,0,0,0,1]},squeezing:function(E){return[E,0,0,0,1/E,0,0,0,1]},scale:function(){var E=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1,v=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return E=E||E===0?E:1,v=v||v===0?v:1,[E,0,0,0,v,0,0,0,1]},scaleX:function(E){return this.scale(E)},scaleY:function(E){return this.scale(1,E)},translate:function(E,v){return[1,0,E,0,1,v,0,0,1]},rotate:function(E){var v=this.radian(E);return[Math.cos(v),-Math.sin(v),0,Math.sin(v),Math.cos(v),0,0,0,1]},rotate90:function(){return[0,-1,0,1,0,0,0,0,1]},rotate180:function(){return[-1,0,0,0,-1,0,0,0,1]},rotate270:function(){return[0,1,0,-1,0,0,0,0,1]},radian:function(E){return E*Math.PI/180},skew:function(E,v){var g=this.radian(E),A=this.radian(v);return[1,Math.tan(g),0,Math.tan(A),1,0,0,0,1]},skewX:function(E){var v=this.radian(E);return[1,Math.tan(v),0,0,1,0,0,0,1]},skewY:function(E){var v=this.radian(E);return[1,0,0,Math.tan(v),1,0,0,0,1]},shear1:function(E){return[1,-Math.tan(this.radian(E)/2),0,0,1,0,0,0,1]},shear2:function(E){return[1,0,0,Math.sin(this.radian(E)),1,0,0,0,1]}},Xe={CONSTANT:Ke,radian:function(E){return Ke.radian(E)},multiply:function(E,v){return[E[0]*v[0]+E[1]*v[1]+E[2]*v[2],E[3]*v[0]+E[4]*v[1]+E[5]*v[2],E[6]*v[0]+E[7]*v[1]+E[8]*v[2]]},identity:function(E){return this.multiply(Ke.identity(),E)},translate:function(E,v,g){return this.multiply(Ke.translate(E,v),g)},rotate:function(E,v){return this.multiply(Ke.rotate(E),v)},shear1:function(E,v){return this.multiply(Ke.shear1(E),v)},shear2:function(E,v){return this.multiply(Ke.shear2(E),v)},rotateShear:function(E,v){var g=v;return g=this.shear1(E,g),g=this.shear2(E,g),g=this.shear1(E,g),g}};function Nt(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,v=arguments[2],g=arguments[3],A=$l(v*g*4,v,g);return function(B,V){for(var $=E,ee=0;$<g;$++,ee++)for(var fe=R,pe=0;fe<v;fe++,pe++)A.pixels[ee*v*pe]=B.pixels[$*v*fe];V(A)}}function wi(R,E){return function(v,g){var A=ga.drawPixels(v),B=A.getContext("2d");A.width=R,A.height=E,g({pixels:new Uint8ClampedArray(B.getImageData(0,0,R,E).data),width:R,height:E})}}function _i(){return function(R,E){for(var v=R.width,g=R.height,A=g%2==1?1:0,B=A?Math.floor(g/2):g/2,V=0;V<B;V++)for(var $=0;$<v;$++){var ee=V*v+$<<2,fe=(g-1-V)*v+$<<2;mg(R.pixels,ee,fe)}E(R)}}function Pr(){return function(R,E){for(var v=R.width,g=R.height,A=v%2==1?1:0,B=A?Math.floor(v/2):v/2,V=0;V<g;V++)for(var $=0;$<B;$++){var ee=V*v+$<<2,fe=V*v+(v-1-$)<<2;mg(R.pixels,ee,fe)}E(R)}}function Ji(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"center",v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"center";return function(g,A){var B=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},V=$l(g.pixels.length,g.width,g.height),$=g.width,ee=g.height;E=="center"&&(E=Math.floor($/2)),v=="center"&&(v=Math.floor(ee/2));var fe=Xe.CONSTANT.translate(-E,-v),pe=Xe.CONSTANT.translate(E,v),Ae=Xe.CONSTANT.shear1(R),we=Xe.CONSTANT.shear2(R);n_(function(ct,at,ot,Dt){var Ht=Xe.multiply(fe,[ot,Dt,1]);Ht=Xe.multiply(Ae,Ht).map(Math.round),Ht=Xe.multiply(we,Ht).map(Math.round),Ht=Xe.multiply(Ae,Ht).map(Math.round),Ht=Xe.multiply(pe,Ht);var bi=Ht,Vi=he(bi,2),_r=Vi[0],lr=Vi[1];if(!(_r<0)&&!(lr<0)&&!(_r>$-1)&&!(lr>ee-1)){var ds=lr*$+_r<<2;o_(ct,ds,g.pixels,at)}})(V,function(){A(V)},B)}}function yi(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return R=ui(R),R=R%360,function(E,v){var g=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(R==0)return E;if(R==90||R==270)var A=$l(E.pixels.length,E.height,E.width);else if(R==180)var A=$l(E.pixels.length,E.width,E.height);else return Ji(R)(E,v,g);n_(function(B,V,$,ee){if(R==90)var fe=$*A.width+(A.width-1-ee)<<2;else if(R==270)var fe=(A.height-1-$)*A.width+ee<<2;else if(R==180)var fe=(A.height-1-ee)*A.width+(A.width-1-$)<<2;o_(A.pixels,fe,E.pixels,V)})(E,function(){v(A)},g)}}function Ci(){for(var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"gray",E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[],v=[],g=0;g<E.length-1;g++)for(var A=E[g],B=E[g+1],V=B[0]-A[0],$=B[1]-A[1],ee=$/V,fe=0,pe=A[0];fe<V;fe++,pe++)v[pe]=A[1]+fe*ee;return v[255]=255,R==="red"?er(function(){$r=v[$r]},{},{$realPoints:v}):R==="green"?er(function(){$g=v[$g]},{},{$realPoints:v}):R==="blue"?er(function(){$b=v[$b]},{},{$realPoints:v}):er(function(){var Ae=Color.RGBtoYCrCb($r,$g,$b),we=Color.YCrCbtoRGB(clamp(v[clamp(Ae.y)]),Ae.cr,Ae.cb,0);$r=we.r,$g=we.g,$b=we.b},{},{$realPoints:v})}var Mr={crop:Nt,resize:wi,flipH:Pr,flipV:_i,rotate:yi,rotateDegree:Ji,histogram:Ci,"rotate-degree":Ji};function Os(R,E){var v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:100,g=gi.parse(R),A=gi.parse(E),B=v;return er(`        
        const thresholdColor = ( $r + $g + $b ) <= $threshold ? $darkColor : $lightColor

        $r = thresholdColor.r;
        $g = thresholdColor.g;
        $b = thresholdColor.b; 
    `,{$threshold:B},{$darkColor:g,$lightColor:A})}function hs(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;R=ui(R);var E=Math.floor(255*(R/100));return er(`
        $r += $C;
        $g += $C;
        $b += $C;
    `,{$C:E})}function Hs(){var R=[.5997023498159715,.34553243048391263,-.2708298674538042,0,-.037703249837783157,.8609577587992641,.15059552388459913,0,.24113635128153335,-.07441037908422492,.44972182064877153,0,0,0,0,1];return er(`
        $r = $matrix[0] * $r + $matrix[1] * $g + $matrix[2] * $b + $matrix[3] * $a;
        $g = $matrix[4] * $r + $matrix[5] * $g + $matrix[6] * $b + $matrix[7] * $a;
        $b = $matrix[8] * $r + $matrix[9] * $g + $matrix[10] * $b + $matrix[11] * $a;
        $a = $matrix[12] * $r + $matrix[13] * $g + $matrix[14] * $b + $matrix[15] * $a;        
    `,{$matrix:R})}function Ws(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;R=ui(R);var E=Math.abs(R)*2.55;return er(`

        $r = ($r > 255 - $C) ? 255 : 0;
        $g = ($g > 255 - $C) ? 255 : 0;
        $b = ($b > 255 - $C) ? 255 : 0;

    `,{$C:E})}function rn(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;R=ui(R);var E=Math.max((128+R)/128,0);return er(`
        $r *= $C;
        $g *= $C;
        $b *= $C;
    `,{$C:E})}function sn(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1,E=ui(R);return er(`
        $r = Math.pow($r / 255, $C) * 255;
        $g = Math.pow($g / 255, $C) * 255;
        $b = Math.pow($b / 255, $C) * 255;
    `,{$C:E})}function qr(){var R=[].concat(Array.prototype.slice.call(arguments));R.length===1&&typeof R[0]=="string"&&(R=gi.convertMatchesArray(R[0])),R=R.map(function(g){var A=gi.matches(g);return A.length?{type:"param",value:g}:{type:"scale",value:g}});var E=R.filter(function(g){return g.type=="scale"})[0];E=E?+E.value:256,R=R.filter(function(g){return g.type=="param"}).map(function(g){return g.value}).join(",");var v=gi.gradient(R,E).map(function(g){var A=gi.parse(g),B=A.r,V=A.g,$=A.b,ee=A.a;return{r:B,g:V,b:$,a:ee}});return er(`
        const colorIndex = clamp(Math.ceil($r * 0.2126 + $g * 0.7152 + $b * 0.0722));
        const newColorIndex = clamp(Math.floor(colorIndex * ($scale / 256)));
        const color = $colors[newColorIndex];

        $r = color.r; 
        $g = color.g; 
        $b = color.b; 
        $a = clamp(Math.floor(color.a * 256));
    `,{},{$colors:v,$scale:E})}function Qr(R){R=ui(R);var E=R/100;E>1&&(E=1);var v=[.2126+.7874*(1-E),.7152-.7152*(1-E),.0722-.0722*(1-E),0,.2126-.2126*(1-E),.7152+.2848*(1-E),.0722-.0722*(1-E),0,.2126-.2126*(1-E),.7152-.7152*(1-E),.0722+.9278*(1-E),0,0,0,0,1];return er(`
        $r = $matrix[0] * $r + $matrix[1] * $g + $matrix[2] * $b + $matrix[3] * $a;
        $g = $matrix[4] * $r + $matrix[5] * $g + $matrix[6] * $b + $matrix[7] * $a;
        $b = $matrix[8] * $r + $matrix[9] * $g + $matrix[10] * $b + $matrix[11] * $a;
        $a = $matrix[12] * $r + $matrix[13] * $g + $matrix[14] * $b + $matrix[15] * $a;
    `,{$matrix:v})}function Xs(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:360,E=ui(R);return er(`
        var hsv = Color.RGBtoHSV($r, $g, $b);

        // 0 ~ 360 
        var h = hsv.h;
        h += Math.abs($C);
        h = h % 360;
        hsv.h = h;

        var rgb = Color.HSVtoRGB(hsv);

        $r = rgb.r;
        $g = rgb.g;
        $b = rgb.b;
    `,{$C:E})}function fn(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;R=ui(R);var E=R/100;return er(`
        $r = (255 - $r) * $C;
        $g = (255 - $g) * $C;
        $b = (255 - $b) * $C;
    `,{$C:E})}function _n(){var R=[1.1285582396593525,-.3967382283601348,-.03992559172921793,0,-.16404339962244616,1.0835251566291304,-.05498805115633132,0,-.16786010706155763,-.5603416277695248,1.6014850761964943,0,0,0,0,1];return er(`
        $r = $matrix[0] * $r + $matrix[1] * $g + $matrix[2] * $b + $matrix[3] * $a;
        $g = $matrix[4] * $r + $matrix[5] * $g + $matrix[6] * $b + $matrix[7] * $a;
        $b = $matrix[8] * $r + $matrix[9] * $g + $matrix[10] * $b + $matrix[11] * $a;
        $a = $matrix[12] * $r + $matrix[13] * $g + $matrix[14] * $b + $matrix[15] * $a;
    `,{$matrix:R})}function Da(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,g=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0,A=arguments.length>4&&arguments[4]!==void 0?arguments[4]:0,B=arguments.length>5&&arguments[5]!==void 0?arguments[5]:0,V=arguments.length>6&&arguments[6]!==void 0?arguments[6]:0,$=arguments.length>7&&arguments[7]!==void 0?arguments[7]:0,ee=arguments.length>8&&arguments[8]!==void 0?arguments[8]:0,fe=arguments.length>9&&arguments[9]!==void 0?arguments[9]:0,pe=arguments.length>10&&arguments[10]!==void 0?arguments[10]:0,Ae=arguments.length>11&&arguments[11]!==void 0?arguments[11]:0,we=arguments.length>12&&arguments[12]!==void 0?arguments[12]:0,ct=arguments.length>13&&arguments[13]!==void 0?arguments[13]:0,at=arguments.length>14&&arguments[14]!==void 0?arguments[14]:0,ot=arguments.length>15&&arguments[15]!==void 0?arguments[15]:0,Dt=[R,E,v,g,A,B,V,$,ee,fe,pe,Ae,we,ct,at,ot];return er(`
        $r = $matrix[0] * $r + $matrix[1] * $g + $matrix[2] * $b + $matrix[3] * $a;
        $g = $matrix[4] * $r + $matrix[5] * $g + $matrix[6] * $b + $matrix[7] * $a;
        $b = $matrix[8] * $r + $matrix[9] * $g + $matrix[10] * $b + $matrix[11] * $a;
        $a = $matrix[12] * $r + $matrix[13] * $g + $matrix[14] * $b + $matrix[15] * $a;
    `,{$matrix:Dt})}function ta(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1,E=ui(R);return er(`
        const C = Math.abs($C) * 5;
        const min = -C;
        const max = C;
        const noiseValue = Math.round(min + (Math.random() * (max - min)));

        $r += noiseValue;
        $g += noiseValue;
        $b += noiseValue;
    `,{$C:E})}function Cn(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;R=ui(R);var E=R/100;return er(`
        $a *= $C; 
    `,{$C:E})}function Ja(){var R=[1.438,-.062,-.062,0,-.122,1.378,-.122,0,-.016,-.016,1.483,0,0,0,0,1];return er(`
        $r = $matrix[0] * $r + $matrix[1] * $g + $matrix[2] * $b + $matrix[3] * $a;
        $g = $matrix[4] * $r + $matrix[5] * $g + $matrix[6] * $b + $matrix[7] * $a;
        $b = $matrix[8] * $r + $matrix[9] * $g + $matrix[10] * $b + $matrix[11] * $a;
        $a = $matrix[12] * $r + $matrix[13] * $g + $matrix[14] * $b + $matrix[15] * $a;
    `,{$matrix:R})}function Wl(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;R=ui(R);var E=R/100,v=1-Math.abs(E),g=[v,0,0,0,0,v,0,0,0,0,v,0,0,0,0,v];return er(`
        $r = $matrix[0] * $r + $matrix[1] * $g + $matrix[2] * $b + $matrix[3] * $a;
        $g = $matrix[4] * $r + $matrix[5] * $g + $matrix[6] * $b + $matrix[7] * $a;
        $b = $matrix[8] * $r + $matrix[9] * $g + $matrix[10] * $b + $matrix[11] * $a;
        $a = $matrix[12] * $r + $matrix[13] * $g + $matrix[14] * $b + $matrix[15] * $a;        
    `,{$matrix:g})}function Na(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1,E=ui(R);E>1&&(E=1);var v=[.393+.607*(1-E),.769-.769*(1-E),.189-.189*(1-E),0,.349-.349*(1-E),.686+.314*(1-E),.168-.168*(1-E),0,.272-.272*(1-E),.534-.534*(1-E),.131+.869*(1-E),0,0,0,0,1];return er(`
        $r = $matrix[0] * $r + $matrix[1] * $g + $matrix[2] * $b + $matrix[3] * $a;
        $g = $matrix[4] * $r + $matrix[5] * $g + $matrix[6] * $b + $matrix[7] * $a;
        $b = $matrix[8] * $r + $matrix[9] * $g + $matrix[10] * $b + $matrix[11] * $a;
        $a = $matrix[12] * $r + $matrix[13] * $g + $matrix[14] * $b + $matrix[15] * $a;        
    `,{$matrix:v})}function ue(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1,E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,g=ui(R),A=ui(E),B=ui(v);return er(`
        $r *= $redValue;
        $g *= $greenValue;
        $b *= $blueValue;
    `,{$redValue:g,$greenValue:A,$blueValue:B})}function Le(){var R=[1.438,-.062,-.062,0,-.122,1.378,-.122,0,-.016,-.016,1.483,0,0,0,0,1];return er(`
        $r = $matrix[0] * $r + $matrix[1] * $g + $matrix[2] * $b + $matrix[3] * $a;
        $g = $matrix[4] * $r + $matrix[5] * $g + $matrix[6] * $b + $matrix[7] * $a;
        $b = $matrix[8] * $r + $matrix[9] * $g + $matrix[10] * $b + $matrix[11] * $a;
        $a = $matrix[12] * $r + $matrix[13] * $g + $matrix[14] * $b + $matrix[15] * $a;        
    `,{$matrix:R})}function Ot(R,E,v){var g=ui(R),A=ui(E),B=ui(v);return er(`
        $r = ($r < $redValue) ? 255 - $r: $r;
        $g = ($g < $greenValue) ? 255 - $g: $g;
        $b = ($b < $blueValue) ? 255 - $b: $b;
    `,{$redValue:g,$greenValue:A,$blueValue:B})}function va(){var R=[1.9125277891456083,-.8545344976951645,-.09155508482755585,0,-.3087833385928097,1.7658908555458428,-.10601743074722245,0,-.231103377548616,-.7501899197440212,1.847597816108189,0,0,0,0,1];return er(`
        $r = $matrix[0] * $r + $matrix[1] * $g + $matrix[2] * $b + $matrix[3] * $a;
        $g = $matrix[4] * $r + $matrix[5] * $g + $matrix[6] * $b + $matrix[7] * $a;
        $b = $matrix[8] * $r + $matrix[9] * $g + $matrix[10] * $b + $matrix[11] * $a;
        $a = $matrix[12] * $r + $matrix[13] * $g + $matrix[14] * $b + $matrix[15] * $a;
    `,{$matrix:R})}function oi(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:200,E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:100,v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,g=ui(R);E=ui(E);var A=E/100,B=v;return er(`
        // refer to Color.brightness 
        const v = ($C * Math.ceil($r * 0.2126 + $g * 0.7152 + $b * 0.0722) ) >= $scale ? 255 : 0;

        if ($hasColor) {

            if (v == 0) {
                $r = 0; 
                $g = 0; 
                $b = 0;
            }
            
        } else {
            const value = Math.round(v);
            $r = value; 
            $g = value;
            $b = value; 
        }
        
    `,{$C:A,$scale:g,$hasColor:B})}function Zr(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:200,E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:100;return oi(R,E,!1)}function eo(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1,E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,g=ui(R),A=ui(E),B=ui(v);return er(`

        $r += (255 - $r) * $redTint;
        $g += (255 - $g) * $greenTint;
        $b += (255 - $b) * $blueTint;

    `,{$redTint:g,$greenTint:A,$blueTint:B})}var Mo={bitonal:Os,brightness:hs,brownie:Hs,clip:Ws,contrast:rn,gamma:sn,gradient:qr,grayscale:Qr,hue:Xs,invert:fn,kodachrome:_n,matrix:Da,noise:ta,opacity:Cn,polaroid:Ja,saturation:Wl,sepia:Na,shade:ue,shift:Le,solarize:Ot,technicolor:va,threshold:Zr,"threshold-color":oi,tint:eo};function xa(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:3;return R=ui(R),us(gg(R))}function td(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:4;return R=ui(R),us([R*-2,-R,0,-R,1,R,0,R,R*2])}function id(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;R=ui(R);var E=R/100;return us(Vn([1,2,1,2,4,2,1,2,1],1/16*E))}function rd(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;R=ui(R);var E=R/100;return us(Vn([1,4,6,4,1,4,16,24,16,4,6,24,36,24,6,4,16,24,16,4,1,4,6,4,1],1/256*E))}function sd(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;return R=ui(R),us(Vn([.3,.3,.3,0,0,.59,.59,.59,0,0,.11,.11,.11,0,0,0,0,0,0,0,0,0,0,0,0],R/100))}function nd(){return us([0,0,0,0,1,0,0,0,0])}function Nh(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;return R=ui(R),us([5,5,5,-3,0,-3,-3,-3,-3])}function wh(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;return R=ui(R),us([5,-3,-3,5,0,-3,5,-3,-3])}function ad(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;return R=ui(R),us(Vn([-1,-1,-1,-1,8,-1,-1,-1,-1],R/100))}function s_(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;return R=ui(R),us(Vn([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,24,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],R/100))}function Ac(){return us(Vn([1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1],1/9))}function od(){return us(Vn([1,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,1],1/9))}function Fh(){return us(Vn([1,0,0,0,1,0,0,0,1,0,1,0,0,1,0,0,1,0,0,0,1,0,1,0,1,0,0,0,0,0,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,0,0,0,0,0,1,0,1,0,1,0,0,0,1,0,0,1,0,0,1,0,1,0,0,0,1,0,0,0,1],1/9))}function Ze(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;return R=ui(R),us(Vn([-1,0,0,0,0,0,-1,0,0,0,0,0,-1,0,0,0,0,0,1,0,1,1,1,1,1],R/100))}function Lt(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;return R=ui(R),us(Vn([.393,.349,.272,0,0,.769,.686,.534,0,0,.189,.168,.131,0,0,0,0,0,0,0,0,0,0,0,0],R/100))}function Yi(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;return R=ui(R),us(Vn([0,-1,0,-1,5,-1,0,-1,0],R/100))}function Jm(){return us([-1,-2,-1,0,0,0,1,2,1])}function eg(){return us([-1,0,1,-2,0,2,-1,0,1])}var tg=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],ig=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function ld(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}function qE(R,E,v){return v?rg(R,0,0,E):stackBlurCanvasRGB(R,0,0,E)}function rg(R,E,v,g){if(isNaN(g)||g<1)return R;g|=0;var A=R.pixels,B=R.width,V=R.height,$,ee,fe,pe,Ae,we,ct,at,ot,Dt,Ht,bi,Vi,_r,lr,ds,Or,Dr,Nr,fs,mn=g+g+1,Ds=B-1,Fi=V-1,wr=g+1,rl=wr*(wr+1)/2,wa=new ld,Hi=wa;for(fe=1;fe<mn;fe++)if(Hi=Hi.next=new ld,fe==wr)var bs=Hi;Hi.next=wa;var cr=null,Ns=null;ct=we=0;var vi=tg[g],Oo=ig[g];for(ee=0;ee<V;ee++){for(_r=lr=ds=at=ot=Dt=0,Ht=wr*(Or=A[we]),bi=wr*(Dr=A[we+1]),Vi=wr*(Nr=A[we+2]),at+=rl*Or,ot+=rl*Dr,Dt+=rl*Nr,Hi=wa,fe=0;fe<wr;fe++)Hi.r=Or,Hi.g=Dr,Hi.b=Nr,Hi=Hi.next;for(fe=1;fe<wr;fe++)pe=we+((Ds<fe?Ds:fe)<<2),at+=(Hi.r=Or=A[pe])*(fs=wr-fe),ot+=(Hi.g=Dr=A[pe+1])*fs,Dt+=(Hi.b=Nr=A[pe+2])*fs,_r+=Or,lr+=Dr,ds+=Nr,Hi=Hi.next;for(cr=wa,Ns=bs,$=0;$<B;$++)A[we]=at*vi>>Oo,A[we+1]=ot*vi>>Oo,A[we+2]=Dt*vi>>Oo,at-=Ht,ot-=bi,Dt-=Vi,Ht-=cr.r,bi-=cr.g,Vi-=cr.b,pe=ct+((pe=$+g+1)<Ds?pe:Ds)<<2,_r+=cr.r=A[pe],lr+=cr.g=A[pe+1],ds+=cr.b=A[pe+2],at+=_r,ot+=lr,Dt+=ds,cr=cr.next,Ht+=Or=Ns.r,bi+=Dr=Ns.g,Vi+=Nr=Ns.b,_r-=Or,lr-=Dr,ds-=Nr,Ns=Ns.next,we+=4;ct+=B}for($=0;$<B;$++){for(lr=ds=_r=ot=Dt=at=0,we=$<<2,Ht=wr*(Or=A[we]),bi=wr*(Dr=A[we+1]),Vi=wr*(Nr=A[we+2]),at+=rl*Or,ot+=rl*Dr,Dt+=rl*Nr,Hi=wa,fe=0;fe<wr;fe++)Hi.r=Or,Hi.g=Dr,Hi.b=Nr,Hi=Hi.next;for(Ae=B,fe=1;fe<=g;fe++)we=Ae+$<<2,at+=(Hi.r=Or=A[we])*(fs=wr-fe),ot+=(Hi.g=Dr=A[we+1])*fs,Dt+=(Hi.b=Nr=A[we+2])*fs,_r+=Or,lr+=Dr,ds+=Nr,Hi=Hi.next,fe<Fi&&(Ae+=B);for(we=$,cr=wa,Ns=bs,ee=0;ee<V;ee++)pe=we<<2,A[pe]=at*vi>>Oo,A[pe+1]=ot*vi>>Oo,A[pe+2]=Dt*vi>>Oo,at-=Ht,ot-=bi,Dt-=Vi,Ht-=cr.r,bi-=cr.g,Vi-=cr.b,pe=$+((pe=ee+wr)<Fi?pe:Fi)*B<<2,at+=_r+=cr.r=A[pe],ot+=lr+=cr.g=A[pe+1],Dt+=ds+=cr.b=A[pe+2],cr=cr.next,Ht+=Or=Ns.r,bi+=Dr=Ns.g,Vi+=Nr=Ns.b,_r-=Or,lr-=Dr,ds-=Nr,Ns=Ns.next,we+=B}return R}function sg(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:10,E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return R=ui(R),function(v,g){var A=qE(v,R,E);g(A)}}function QE(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;return R=ui(R),us(Vn([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,.3,0,0,0,0,0,1],R/100))}function ng(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:256;return R=ui(R),us(Vn([1,4,6,4,1,4,16,24,16,4,6,24,-476,24,6,4,16,24,16,4,1,4,6,4,1],-1/R))}var ZE={blur:xa,emboss:td,gaussianBlur:id,"gaussian-blur":id,gaussianBlur5x:rd,"gaussian-blur-5x":rd,grayscale2:sd,normal:nd,kirschHorizontal:Nh,"kirsch-horizontal":Nh,kirschVertical:wh,"kirsch-vertical":wh,laplacian:ad,laplacian5x:s_,"laplacian-5x":s_,motionBlur:Ac,"motion-blur":Ac,motionBlur2:od,"motion-blur-2":od,motionBlur3:Fh,"motion-blur-3":Fh,negative:Ze,sepia2:Lt,sharpen:Yi,sobelHorizontal:Jm,"sobel-horizontal":Jm,sobelVertical:eg,"sobel-vertical":eg,stackBlur:sg,"stack-blur":sg,transparency:QE,unsharpMasking:ng,"unsharp-masking":ng};function JE(){return Lh("kirsch-horizontal kirsch-vertical")}function e0(){return Lh("sobel-horizontal sobel-vertical")}function t0(){return Lh("brightness(15) saturation(-20) gamma(1.8)")}var i0={kirsch:JE,sobel:e0,vintage:t0},ag=L({},Mr,Mo,ZE,i0),Xl,og=0,lg=(Xl={partial:Eg,multi:l_,merge:cd,weight:Vn,repeat:cg,colorMatrix:s0,each:ug,eachXY:dg,createRandomCount:o0,createRandRange:a0,createBitmap:$l,createBlurMatrix:gg,pack:u0,packXY:n_,pixel:er,getBitmap:fg,putBitmap:_g,radian:m0,convolution:us,parseParamNumber:ui,filter:Lh,clamp:Tg,fillColor:a_,fillPixelColor:o_},w(Xl,"multi",l_),w(Xl,"merge",cd),w(Xl,"matches",vg),w(Xl,"parseFilter",xg),w(Xl,"partial",Eg),Xl),r0=lg;function Vn(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return R.map(function(v){return v*E})}function cg(R,E){for(var v=new Array(E),g=0;g<E;g++)v[g]=R;return v}function s0(R,E,v){var g=R[E],A=R[E+1],B=R[E+2],V=R[E+3];a_(R,E,v[0]*g+v[1]*A+v[2]*B+v[3]*V,v[4]*g+v[5]*A+v[6]*B+v[7]*V,v[8]*g+v[9]*A+v[10]*B+v[11]*V,v[12]*g+v[13]*A+v[14]*B+v[15]*V)}function n0(R){if(typeof R=="function")return R;typeof R=="string"&&(R=[R]),R=R.slice(0);var E=R.shift();if(typeof E=="function")return E;var v=R,g=ag[E]||r0[E];if(!g)throw new Error(E+" is not filter. please check filter name.");return g.apply(g,v)}function hg(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,g=arguments[3],A=arguments[4],B=arguments.length>5&&arguments[5]!==void 0?arguments[5]:1e4,V=arguments.length>6&&arguments[6]!==void 0?arguments[6]:"full",$=arguments.length>7&&arguments[7]!==void 0?arguments[7]:50,ee=E,fe=function(at){setTimeout(at,0)};V=="requestAnimationFrame"&&(fe=requestAnimationFrame,B=1e3),V=="full"&&(fe=null,B=R);function pe(){var ct=arguments.length>0&&arguments[0]!==void 0?arguments[0]:50,at=[].concat(ne(Array(ct))),ot=at.map(function(Ht){return"cri = ri + i * s; if (cri >= mx) return {currentRunIndex: cri, i: null}; c(cri); i++;"}).join(`
`),Dt=new Function("ri","i","s","mx","c",`
            let cri = ri;
            
            `+ot+`
            
            return {currentRunIndex: cri, i: i} 
        `);return Dt}function Ae(){for(var ct=pe($),at=ee,ot={},Dt=0;Dt<B;){if(ot=ct(ee,Dt,v,R,g),ot.i==null){at=ot.currentRunIndex;break}Dt=ot.i,at=ot.currentRunIndex}we(at)}function we(ct){if(ct?ee=ct:ee+=v,ee>=R){A();return}fe?fe(Ae):Ae()}Ae()}function ug(R,E,v){var g=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};hg(R,0,4,function(A){E(A,A>>2)},function(){v()},g.functionDumpCount,g.frameTimer,g.loopCount)}function dg(R,E,v,g){var A=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{};hg(R,0,4,function(B){var V=B>>2;v(B,V%E,Math.floor(V/E))},function(){g()},A.functionDumpCount,A.frameTimer,A.loopCount)}function a0(R,E,v){for(var g=[],A=1;A<=v;A++){var B=Math.random()*(E-R)+R,V=Math.floor(Math.random()*10)%2==0?-1:1;g.push(V*B)}g.sort();var $=Math.floor(v>>1),ee=g[$];return g[$]=g[0],g[0]=ee,g}function o0(){return[3*3,4*4,5*5,6*6,7*7,8*8,9*9,10*10].sort(function(R,E){return .5-Math.random()})[0]}function $l(R,E,v){return{pixels:new Uint8ClampedArray(R),width:E,height:v}}function l0(R,E,v,g){for(var A=E.pixels.length/4,B=0,V=0,$=0,ee=0,fe=0,pe=0,Ae=0;Ae<A;Ae++)$=Ae%E.width,ee=Math.floor(Ae/E.width),B=v+$,V=g+ee,!(B>R.width)&&(V>R.height||(fe=ee*E.width+$<<2,pe=V*R.width+B<<2,R.pixels[pe]=E.pixels[fe],R.pixels[pe+1]=E.pixels[fe+1],R.pixels[pe+2]=E.pixels[fe+2],R.pixels[pe+3]=E.pixels[fe+3]))}function c0(R,E,v,g){for(var A=E.pixels.length>>2,B=0,V=0,$=0,ee=0,fe=0,pe=0,Ae=0;Ae<A;Ae++){var $=Ae%E.width,ee=Math.floor(Ae/E.width);B=v+$,V=g+ee,!(B>R.width)&&(V>R.height||(fe=V*R.width+B<<2,pe=ee*E.width+$<<2,E.pixels[pe]=R.pixels[fe],E.pixels[pe+1]=R.pixels[fe+1],E.pixels[pe+2]=R.pixels[fe+2],E.pixels[pe+3]=R.pixels[fe+3]))}}function h0(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,v=R.width+E,g=R.height+E,A={pixels:new Uint8ClampedArray(v*g*4),width:v,height:g};return A}function fg(R,E){return ga.getBitmap(R,E)}function _g(R,E,v){return ga.putBitmap(R,E,v)}function ui(R){return typeof R=="string"&&(R=R.replace(/deg/,""),R=R.replace(/px/,"")),+R}var pg=/(([\w_\-]+)(\(([^\)]*)\))?)+/gi;function u0(R){return function(E,v){ug(E.pixels.length,function(g,A){R(E.pixels,g,A,E.pixels[g],E.pixels[g+1],E.pixels[g+2],E.pixels[g+3])},function(){v(E)})}}function d0(R){var E=R.map(function(V){return` 
            `+V.userFunction.$preContext+`

            `+V.userFunction.$preCallbackString+`

            $r = clamp($r); $g = clamp($g); $b = clamp($b); $a = clamp($a);
        `}).join(`

`),v={clamp:Tg,Color:gi};R.forEach(function(V){Object.assign(v,V.userFunction.rootContextObject)});var g="const "+Object.keys(v).map(function(V){return" "+V+" = $rc."+V+" "}).join(","),A=` 
    let $r = $p[$pi], $g = $p[$pi+1], $b = $p[$pi+2], $a = $p[$pi+3];
    
    `+g+`

    `+E+`
    
    $p[$pi] = $r; $p[$pi+1] = $g; $p[$pi+2] = $b; $p[$pi+3] = $a;
    `,B=new Function("$p","$pi","$rc",A);return function(V,$){B(V,$,v)}}function f0(R){var E={},v=R.map(function($){var ee=[];Object.keys($.context).forEach(function(Ae,we){ee[Ae]="n$"+og+++Ae+"$"}),Object.keys($.rootContext).forEach(function(Ae,we){ee[Ae]="r$"+og+++Ae+"$",E[ee[Ae]]=$.rootContext[Ae]});var fe=Object.keys($.context).filter(function(Ae){return typeof $.context[Ae]=="number"||typeof $.context[Ae]=="string"?!1:!(Array.isArray($.context[Ae])&&(typeof $.context[Ae][0]=="number"||typeof $.context[Ae][0]=="string"))}).map(function(Ae,we){return[ee[Ae],JSON.stringify($.context[Ae])].join(" = ")}),pe=$.callback;return typeof $.callback=="function"&&(pe=$.callback.toString().split("{"),pe.shift(),pe=pe.join("{"),pe=pe.split("}"),pe.pop(),pe=pe.join("}")),Object.keys(ee).forEach(function(Ae){var we=ee[Ae];typeof $.context[Ae]=="number"||typeof $.context[Ae]=="string"?pe=pe.replace(new RegExp("\\"+Ae,"g"),$.context[Ae]):Array.isArray($.context[Ae])?typeof $.context[Ae][0]=="number"||typeof $.context[Ae][0]=="string"?$.context[Ae].forEach(function(ct,at){pe=pe.replace(new RegExp("\\"+Ae+"\\["+at+"\\]","g"),ct)}):pe=pe.replace(new RegExp("\\"+Ae,"g"),we):pe=pe.replace(new RegExp("\\"+Ae,"g"),we)}),{preCallbackString:pe,preContext:fe}}),g=v.map(function($,ee){return $.preContext.length?"const "+$.preContext+";":""}).join(`

`),A=v.map(function($){return $.preCallbackString}).join(`

`),B=` 
    let $r = $pixels[$pixelIndex], $g = $pixels[$pixelIndex+1], $b = $pixels[$pixelIndex+2], $a = $pixels[$pixelIndex+3];

    `+g+`

    `+A+`
    
    $pixels[$pixelIndex] = $r
    $pixels[$pixelIndex+1] = $g 
    $pixels[$pixelIndex+2] = $b   
    $pixels[$pixelIndex+3] = $a   
    `,V=new Function("$pixels","$pixelIndex","$clamp","$Color",B);return V.$preCallbackString=A,V.$preContext=g,V.rootContextObject=E,V}function _0(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return f0([{callback:R,context:E,rootContext:v}])}function er(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},g=_0(R,E,v),A=function(V,$){};return A.userFunction=g,A}var p0=[0,1,2,3];function mg(R,E,v){p0.forEach(function(g){var A=R[E+g];R[E+g]=R[v+g],R[v+g]=A})}function n_(R){return function(E,v){var g=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};dg(E.pixels.length,E.width,function(A,B,V){R(E.pixels,A,B,V)},function(){v(E)},g)}}function m0(R){return Xe.CONSTANT.radian(R)}function gg(){var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:3,E=Math.pow(R,2),v=1/E;return cg(v,E)}function a_(R,E,v,g,A,B){if(arguments.length==3)var V=arguments[2],v=V.r,g=V.g,A=V.b,B=V.a;typeof v=="number"&&(R[E]=v),typeof g=="number"&&(R[E+1]=g),typeof A=="number"&&(R[E+2]=A),typeof B=="number"&&(R[E+3]=B)}function o_(R,E,v,g){a_(R,E,v[g],v[g+1],v[g+2],v[g+3])}function g0(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,g=[];return g=R.map(function(A,B){return[]}),R.forEach(function(A,B){if(A!=0)for(var V=g[B],B=E;B<=v;B++)V[B]=A*B}),g}function v0(R,E,v,g,A){var B=Math.round(Math.sqrt(R.length)),V=Math.floor(B/2),$=A?1:0,ee="let r = 0, g = 0, b = 0, a = 0, scy = 0, scx =0, si = 0; ",fe=[],pe=[],Ae=[],we=[];R.forEach(function(at,ot){var Dt=Math.floor(ot/B),Ht=ot%B,bi=Dt-V,Vi=Ht-V;at!=0&&(fe.push("$t["+ot+"][$sp[(($sy + ("+bi+")) * "+v+" + ($sx + ("+Vi+"))) * 4]]"),pe.push("$t["+ot+"][$sp[(($sy + ("+bi+")) * "+v+" + ($sx + ("+Vi+"))) * 4 + 1]]"),Ae.push("$t["+ot+"][$sp[(($sy + ("+bi+")) * "+v+" + ($sx + ("+Vi+"))) * 4 + 2]]"),we.push("$t["+ot+"][$sp[(($sy + ("+bi+")) * "+v+" + ($sx + ("+Vi+"))) * 4 + 3]]"))}),ee+="r = "+fe.join(" + ")+"; g = "+pe.join(" + ")+"; b = "+Ae.join(" + ")+"; a = "+we.join(" + ")+";",ee+="$dp[$di] = r; $dp[$di+1] = g;$dp[$di+2] = b;$dp[$di+3] = a + ("+$+")*(255-a); ";var ct=new Function("$dp","$sp","$di","$sx","$sy","$t",ee);return function(at,ot,Dt,Ht,bi){ct(at,ot,Dt,Ht,bi,E)}}function us(R){var E=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,v=g0(R);return function(g,A){var B=Math.round(Math.sqrt(R.length)),V=B*2,$=h0(g,V);l0($,g,B,B);for(var ee=$l($.pixels.length,$.width,$.height),fe=$l(g.pixels.length,g.width,g.height),pe=v0(R,v,$.width,$.height,E),Ae=g.pixels.length/4,we=0;we<Ae;we++){var ct=we,at=ct%g.width+B,ot=Math.floor(ct/g.width)+B;pe(ee.pixels,$.pixels,(ot*$.width+at)*4,at,ot)}c0(ee,fe,B,B),A(fe)}}function vg(R){var E=gi.convertMatches(R),v=E.str.match(pg),g=[];if(!v)return g;g=v.map(function(B){return{filter:B,origin:gi.reverseMatches(B,E.matches)}});var A={next:0};return g=g.map(function(B){var V=R.indexOf(B.origin,A.next);return B.startIndex=V,B.endIndex=V+B.origin.length,B.arr=xg(B.origin),A.next=B.endIndex,B}).filter(function(B){return!!B.arr.length}),g}function xg(R){var E=gi.convertMatches(R),v=E.str.match(pg);if(!v[0])return[];var g=v[0].split("("),A=g.shift(),B=[];g.length&&(B=g.shift().split(")")[0].split(",").map(function($){return gi.reverseMatches($,E.matches)}));var V=[A].concat(ne(B)).map(gi.trim);return V}function Tg(R){return Math.min(255,R)}function Lh(R){return cd(vg(R).map(function(E){return E.arr}))}function x0(){for(var R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],E=[],v=[],g=0,A=R.length;g<A;g++){var B=R[g];B.userFunction?v.push(B):(v.length&&E.push([].concat(ne(v))),E.push(B),v=[])}return v.length&&E.push([].concat(ne(v))),E.forEach(function(V,$){Array.isArray(V)&&(E[$]=function(){var ee=d0(V);return function(fe,pe){for(var Ae=0,we=fe.pixels.length;Ae<we;Ae+=4)ee(fe.pixels,Ae);pe(fe)}}())}),E}function l_(){for(var R=arguments.length,E=Array(R),v=0;v<R;v++)E[v]=arguments[v];E=E.map(function(A){return n0(A)}).filter(function(A){return A}),E=x0(E);var g=E.length;return function(A,B){var V=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},$=A,ee=0;function fe(){E[ee].call(null,$,function(Ae){$=Ae,pe()},V)}function pe(){if(ee++,ee>=g){B($);return}fe()}fe()}}function cd(R){return l_.apply(void 0,ne(R))}function Eg(R){for(var E=null,v=arguments.length,g=Array(v>1?v-1:0),A=1;A<v;A++)g[A-1]=arguments[A];return g.length==1&&typeof g[0]=="string"?E=Lh(g[0]):E=cd(g),function(B,V){var $=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};E(fg(B,R),function(ee){V(_g(B,ee,R))},$)}}var T0=L({},ag,lg),E0={Color:gi,HueColor:Je,ColorNames:b,ImageFilter:T0,Canvas:ga,ImageLoader:Io};gi.color;var b0=0,hd=[],kn=function(){function R(E,v,g){if(P(this,R),typeof E!="string")this.el=E;else{var A=document.createElement(E);this.uniqId=b0++,v&&(A.className=v),g=g||{};for(var B in g)A.setAttribute(B,g[B]);this.el=A}}return D(R,[{key:"attr",value:function(v,g){return arguments.length==1?this.el.getAttribute(v):(this.el.setAttribute(v,g),this)}},{key:"closest",value:function(v){for(var g=this,A=!1;!(A=g.hasClass(v));)if(g.el.parentNode)g=new R(g.el.parentNode);else return null;return A?g:null}},{key:"checked",value:function(){return this.el.checked}},{key:"removeClass",value:function(v){return this.el.className=(" "+this.el.className+" ").replace(" "+v+" "," ").trim(),this}},{key:"hasClass",value:function(v){if(this.el.className){var g=" "+this.el.className+" ";return g.indexOf(" "+v+" ")>-1}else return!1}},{key:"addClass",value:function(v){return this.hasClass(v)||(this.el.className=this.el.className+" "+v),this}},{key:"toggleClass",value:function(v){this.hasClass(v)?this.removeClass(v):this.addClass(v)}},{key:"html",value:function(v){try{typeof v=="string"?this.el.innerHTML=v:this.empty().append(v)}catch{console.log(v)}return this}},{key:"find",value:function(v){return this.el.querySelector(v)}},{key:"$",value:function(v){return new R(this.find(v))}},{key:"findAll",value:function(v){return this.el.querySelectorAll(v)}},{key:"$$",value:function(v){return[].concat(ne(this.findAll(v))).map(function(g){return new R(g)})}},{key:"empty",value:function(){return this.html("")}},{key:"append",value:function(v){return typeof v=="string"?this.el.appendChild(document.createTextNode(v)):this.el.appendChild(v.el||v),this}},{key:"appendTo",value:function(v){var g=v.el?v.el:v;return g.appendChild(this.el),this}},{key:"remove",value:function(){return this.el.parentNode&&this.el.parentNode.removeChild(this.el),this}},{key:"text",value:function(){return this.el.textContent}},{key:"css",value:function(v,g){var A=this;if(arguments.length==2)this.el.style[v]=g;else if(arguments.length==1){if(typeof v=="string")return getComputedStyle(this.el)[v];var B=v||{};Object.keys(B).forEach(function(V){A.el.style[V]=B[V]})}return this}},{key:"cssFloat",value:function(v){return parseFloat(this.css(v))}},{key:"cssInt",value:function(v){return parseInt(this.css(v))}},{key:"px",value:function(v,g){return this.css(v,g+"px")}},{key:"offset",value:function(){var v=this.el.getBoundingClientRect();return{top:v.top+R.getScrollTop(),left:v.left+R.getScrollLeft()}}},{key:"rect",value:function(){return this.el.getBoundingClientRect()}},{key:"position",value:function(){return this.el.style.top?{top:parseFloat(this.css("top")),left:parseFloat(this.css("left"))}:this.el.getBoundingClientRect()}},{key:"size",value:function(){return[this.width(),this.height()]}},{key:"width",value:function(){return this.el.offsetWidth||this.el.getBoundingClientRect().width}},{key:"contentWidth",value:function(){return this.width()-this.cssFloat("padding-left")-this.cssFloat("padding-right")}},{key:"height",value:function(){return this.el.offsetHeight||this.el.getBoundingClientRect().height}},{key:"contentHeight",value:function(){return this.height()-this.cssFloat("padding-top")-this.cssFloat("padding-bottom")}},{key:"dataKey",value:function(v){return this.uniqId+"."+v}},{key:"data",value:function(v,g){if(arguments.length==2)hd[this.dataKey(v)]=g;else{if(arguments.length==1)return hd[this.dataKey(v)];var A=Object.keys(hd),B=this.uniqId+".";return A.filter(function(V){return V.indexOf(B)==0}).map(function(V){return hd[V]})}return this}},{key:"val",value:function(v){return arguments.length==0?this.el.value:(arguments.length==1&&(this.el.value=v),this)}},{key:"int",value:function(){return parseInt(this.val(),10)}},{key:"float",value:function(){return parseFloat(this.val())}},{key:"show",value:function(){return this.css("display","block")}},{key:"hide",value:function(){return this.css("display","none")}},{key:"toggle",value:function(){return this.css("display")=="none"?this.show():this.hide()}},{key:"scrollTop",value:function(){return this.el===document.body?R.getScrollTop():this.el.scrollTop}},{key:"scrollLeft",value:function(){return this.el===document.body?R.getScrollLeft():this.el.scrollLeft}},{key:"on",value:function(v,g,A,B){return this.el.addEventListener(v,g,A,B),this}},{key:"off",value:function(v,g){return this.el.removeEventListener(v,g),this}},{key:"getElement",value:function(){return this.el}},{key:"createChild",value:function(v){var g=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",A=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},B=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{},V=new R(v,g,A);return V.css(B),this.append(V),V}},{key:"firstChild",value:function(){return new R(this.el.firstElementChild)}},{key:"replace",value:function(v,g){return this.el.replaceChild(g,v),this}}],[{key:"getScrollTop",value:function(){return Math.max(window.pageYOffset,document.documentElement.scrollTop,document.body.scrollTop)}},{key:"getScrollLeft",value:function(){return Math.max(window.pageXOffset,document.documentElement.scrollLeft,document.body.scrollLeft)}}]),R}(),bg=function(){function R(E){P(this,R),this.$store=E,this.initialize()}return D(R,[{key:"initialize",value:function(){var v=this;this.filterProps().forEach(function(g){v.$store.action(g,v)})}},{key:"filterProps",value:function(){var v=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"/";return Object.getOwnPropertyNames(this.__proto__).filter(function(g){return g.startsWith(v)})}}]),R}(),S0=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"initialize",value:function(){U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"initialize",this).call(this),this.$store.colorSetsList=[{name:"Material",colors:["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#FF5722","#795548","#9E9E9E","#607D8B"],edit:!0},{name:"Custom",edit:!0,colors:[]},{name:"Color Scale",scale:["red","yellow","black"],count:5}],this.$store.currentColorSets={}}},{key:"/list",value:function(g){return Array.isArray(g.userList)&&g.userList.length?g.userList:g.colorSetsList}},{key:"/setUserPalette",value:function(g,A){g.userList=A,g.dispatch("/resetUserPalette"),g.dispatch("/setCurrentColorSets")}},{key:"/resetUserPalette",value:function(g){g.userList&&g.userList.length&&(g.userList=g.userList.map(function(A,B){if(typeof A.colors=="function"){var V=A.colors;A.colors=V(g),A._colors=V}return Object.assign({name:"color-"+B,colors:[]},A)}),g.emit("changeUserList"))}},{key:"/setCurrentColorSets",value:function(g,A){var B=g.dispatch("/list");typeof A>"u"?g.currentColorSets=B[0]:typeof A=="number"?g.currentColorSets=B[A]:g.currentColorSets=B.filter(function(V){return V.name==A})[0],g.emit("changeCurrentColorSets")}},{key:"/getCurrentColorSets",value:function(g){return g.currentColorSets}},{key:"/addCurrentColor",value:function(g,A){Array.isArray(g.currentColorSets.colors)&&(g.currentColorSets.colors.push(A),g.emit("changeCurrentColorSets"),g.emit("addCurrentColor",A))}},{key:"/setCurrentColorAll",value:function(g){var A=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];g.currentColorSets.colors=A,g.emit("changeCurrentColorSets")}},{key:"/removeCurrentColor",value:function(g,A){g.currentColorSets.colors[A]&&(g.currentColorSets.colors.splice(A,1),g.emit("changeCurrentColorSets"))}},{key:"/removeCurrentColorToTheRight",value:function(g,A){g.currentColorSets.colors[A]&&(g.currentColorSets.colors.splice(A,Number.MAX_VALUE),g.emit("changeCurrentColorSets"))}},{key:"/clearPalette",value:function(g){g.currentColorSets.colors&&(g.currentColorSets.colors=[],g.emit("changeCurrentColorSets"))}},{key:"/getCurrentColors",value:function(g){return g.dispatch("/getColors",g.currentColorSets)}},{key:"/getColors",value:function(g,A){return A.scale?gi.scale(A.scale,A.count):A.colors||[]}},{key:"/getColorSetsList",value:function(g){return g.dispatch("/list").map(function(A){return{name:A.name,edit:A.edit,colors:g.dispatch("/getColors",A)}})}}]),E}(bg),to={addEvent:function(E,v,g,A){E&&E.addEventListener(v,g,A)},removeEvent:function(E,v,g){E&&E.removeEventListener(v,g)},pos:function(E){return E.touches&&E.touches[0]?E.touches[0]:E},posXY:function(E){var v=this.pos(E);return{x:v.pageX,y:v.pageY}}},y0=".",C0=function(){function R(E){var v=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};P(this,R),this.masterObj=E,this.settingObj=v}return D(R,[{key:"set",value:function(v,g){var A=arguments.length>2&&arguments[2]!==void 0?arguments[2]:void 0;this.settingObj[v]=g||A}},{key:"init",value:function(v){if(!this.has(v)||!this.settingObj[v]){var g=v.split(y0),A=this.masterObj.refs[g[0]]||this.masterObj[g[0]]||this.masterObj,B=g.pop();if(A[B]){for(var V=arguments.length,$=Array(V>1?V-1:0),ee=1;ee<V;ee++)$[ee-1]=arguments[ee];var fe=A[B].apply(A,$);this.set(v,fe)}}}},{key:"get",value:function(v){var g=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";return this.init(v,g),this.settingObj[v]||g}},{key:"has",value:function(v){return!!this.settingObj[v]}}]),R}(),A0=/^(click|mouse(down|up|move|enter|leave)|touch(start|move|end)|key(down|up|press)|contextmenu|change|input)/ig,R0=/^load (.*)/ig,Sg=" ",I0=["Control","Shift","Alt","Meta"],P0=function(){function R(){P(this,R),this.state=new C0(this),this.refs={},this.childComponents=this.components()}return D(R,[{key:"newChildComponents",value:function(){var v=this,g=Object.keys(this.childComponents);g.forEach(function(A){var B=v.childComponents[A];v[A]=new B(v)})}},{key:"render",value:function(){this.$el=this.parseTemplate(this.template()),this.refs.$el=this.$el,this.parseTarget(),this.load(),this.afterRender()}},{key:"afterRender",value:function(){}},{key:"components",value:function(){return{}}},{key:"parseTemplate",value:function(v){var g=this,A=new kn("div").html(v).firstChild(),B=A.findAll("[ref]");return[].concat(ne(B)).forEach(function(V){var $=V.getAttribute("ref");g.refs[$]=new kn(V)}),A}},{key:"parseTarget",value:function(){var v=this,g=this.$el,A=g.findAll("[target]");[].concat(ne(A)).forEach(function(B){var V=B.getAttribute("target"),$=B.getAttribute("ref")||V,ee=v.childComponents[V],fe=new ee(v);if(v[$]=fe,v.refs[$]=fe.$el,fe){fe.render();var pe=new kn(B.parentNode);pe.replace(B,fe.$el.el)}})}},{key:"load",value:function(){var v=this;this.filterProps(R0).forEach(function(g){var A=g.split("load ")[1];v.refs[A]&&v.refs[A].html(v.parseTemplate(v[g].call(v)))})}},{key:"template",value:function(){return"<div></div>"}},{key:"initialize",value:function(){}},{key:"initializeEvent",value:function(){var v=this;this.initializeEventMachin(),Object.keys(this.childComponents).forEach(function(g){v[g]&&v[g].initializeEvent()})}},{key:"destroy",value:function(){var v=this;this.destroyEventMachin(),Object.keys(this.childComponents).forEach(function(g){v[g]&&v[g].destroy()})}},{key:"destroyEventMachin",value:function(){this.removeEventAll()}},{key:"initializeEventMachin",value:function(){this.filterProps(A0).forEach(this.parseEvent.bind(this))}},{key:"collectProps",value:function(){if(!this.collapsedProps){var v=this.__proto__,g=[];do g.push.apply(g,ne(Object.getOwnPropertyNames(v))),v=v.__proto__;while(v);this.collapsedProps=g}return this.collapsedProps}},{key:"filterProps",value:function(v){return this.collectProps().filter(function(g){return g.match(v)})}},{key:"parseEvent",value:function(v){var g=v.split(Sg);this.bindingEvent(g,this[v].bind(this))}},{key:"getDefaultDomElement",value:function(v){var g=void 0;return v?g=this.refs[v]||this[v]||window[v]:g=this.el||this.$el||this.$root,g instanceof kn?g.getElement():g}},{key:"getDefaultEventObject",value:function(v){var g=this,A=v.split("."),B=A.shift(),V=A.includes("Control"),$=A.includes("Shift"),ee=A.includes("Alt"),fe=A.includes("Meta");A=A.filter(function(Ae){return I0.includes(Ae)===!1});var pe=A.filter(function(Ae){return!!g[Ae]});return A=A.filter(function(Ae){return pe.includes(Ae)===!1}).map(function(Ae){return Ae.toLowerCase()}),{eventName:B,isControl:V,isShift:$,isAlt:ee,isMeta:fe,codes:A,checkMethodList:pe}}},{key:"bindingEvent",value:function(v,g){var A=_e(v),B=A[0],V=A[1],$=A.slice(2);V=this.getDefaultDomElement(V);var ee=this.getDefaultEventObject(B);ee.dom=V,ee.delegate=$.join(Sg),this.addEvent(ee,g)}},{key:"matchPath",value:function(v,g){return v?v.matches(g)?v:this.matchPath(v.parentElement,g):null}},{key:"getBindings",value:function(){return this._bindings||this.initBindings(),this._bindings}},{key:"addBinding",value:function(v){this.getBindings().push(v)}},{key:"initBindings",value:function(){this._bindings=[]}},{key:"checkEventType",value:function(v,g){var A=this,B=g.isControl?v.ctrlKey:!0,V=g.isShift?v.shiftKey:!0,$=g.isAlt?v.altKey:!0,ee=g.isMeta?v.metaKey:!0,fe=!0;g.codes.length&&(fe=g.codes.includes(v.code.toLowerCase())||g.codes.includes(v.key.toLowerCase()));var pe=!0;return g.checkMethodList.length&&(pe=g.checkMethodList.every(function(Ae){return A[Ae].call(A,v)})),B&&$&&V&&ee&&fe&&pe}},{key:"makeCallback",value:function(v,g){var A=this;return v.delegate?function(B){if(B.xy=to.posXY(B),A.checkEventType(B,v)){var V=A.matchPath(B.target||B.srcElement,v.delegate);if(V)return B.delegateTarget=V,B.$delegateTarget=new kn(V),g(B)}}:function(B){if(B.xy=to.posXY(B),A.checkEventType(B,v))return g(B)}}},{key:"addEvent",value:function(v,g){v.callback=this.makeCallback(v,g),this.addBinding(v);var A=!0;v.eventName==="touchstart"&&(A={passive:!0}),to.addEvent(v.dom,v.eventName,v.callback,A)}},{key:"removeEventAll",value:function(){var v=this;this.getBindings().forEach(function(g){v.removeEvent(g)}),this.initBindings()}},{key:"removeEvent",value:function(v){var g=v.eventName,A=v.dom,B=v.callback;to.removeEvent(A,g,B)}}]),R}(),M0=/^@/,nn=function(R){G(E,R);function E(v){P(this,E);var g=Z(this,(E.__proto__||Object.getPrototypeOf(E)).call(this,v));return g.opt=v||{},v&&v.$store&&(g.$store=v.$store),g.initialize(),g.initializeStoreEvent(),g}return D(E,[{key:"initializeStoreEvent",value:function(){var g=this;this.storeEvents={},this.filterProps(M0).forEach(function(A){var B=A.split("@");B.shift();var V=B.join("@");g.storeEvents[V]=g[A].bind(g),g.$store.on(V,g.storeEvents[V])})}},{key:"destoryStoreEvent",value:function(){var g=this;Object.keys(this.storeEvents).forEach(function(A){g.$store.off(A,g.storeEvents[A])})}}]),E}(P0);function O0(R){return typeof R>"u"||R==null}var D0=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"initialize",value:function(){U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"initialize",this).call(this),this.$store.rgb={},this.$store.hsl={},this.$store.hsv={},this.$store.alpha=1,this.$store.format="hex"}},{key:"/changeFormat",value:function(g,A){g.format=A,g.emit("changeFormat")}},{key:"/initColor",value:function(g,A,B){g.dispatch("/changeColor",A,B,!0),g.emit("initColor")}},{key:"/changeColor",value:function(g,A,B,V){A=A||"#FF0000",typeof A=="string"&&(A=gi.parse(A)),A.source=A.source||B,g.alpha=O0(A.a)?g.alpha:A.a,g.format=A.type!="hsv"&&A.type||g.format,A.type=="hsl"?(g.hsl=Object.assign(g.hsl,A),g.rgb=gi.HSLtoRGB(g.hsl),g.hsv=gi.HSLtoHSV(A)):A.type=="hex"||A.type=="rgb"?(g.rgb=Object.assign(g.rgb,A),g.hsl=gi.RGBtoHSL(g.rgb),g.hsv=gi.RGBtoHSV(A)):A.type=="hsv"&&(g.hsv=Object.assign(g.hsv,A),g.rgb=gi.HSVtoRGB(g.hsv),g.hsl=gi.HSVtoHSL(g.hsv)),V||g.emit("changeColor",A.source)}},{key:"/getHueColor",value:function(g){return Je.checkHueColor(g.hsv.h/360)}},{key:"/toString",value:function(g,A){A=A||g.format;var B=g[A]||g.rgb;return gi.format(L({},B,{a:g.alpha}),A)}},{key:"/toColor",value:function(g,A){return A=A||g.format,A=="rgb"?g.dispatch("/toRGB"):A=="hsl"?g.dispatch("/toHSL"):A=="hex"?g.dispatch("/toHEX"):g.dispatch("/toString",A)}},{key:"/toRGB",value:function(g){return g.dispatch("/toString","rgb")}},{key:"/toHSL",value:function(g){return g.dispatch("/toString","hsl")}},{key:"/toHEX",value:function(g){return g.dispatch("/toString","hex").toUpperCase()}}]),E}(bg),N0=function(){function R(E){P(this,R),this.callbacks=[],this.actions=[],this.modules=E.modules||[],this.initialize()}return D(R,[{key:"initialize",value:function(){this.initializeModule()}},{key:"initializeModule",value:function(){var v=this;this.modules.forEach(function(g){new g(v)})}},{key:"action",value:function(v,g){this.actions[v]={context:g,callback:g[v]}}},{key:"dispatch",value:function(A){var g=[].concat(Array.prototype.slice.call(arguments)),A=g.shift(),B=this.actions[A];if(B)return B.callback.apply(B.context,[this].concat(ne(g)))}},{key:"module",value:function(v){}},{key:"on",value:function(v,g){this.callbacks.push({event:v,callback:g})}},{key:"off",value:function(v,g){arguments.length==0?this.callbacks=[]:arguments.length==1?this.callbacks=this.callbacks.filter(function(A){return A.event!=v}):arguments.length==2&&(this.callbacks=this.callbacks.filter(function(A){return A.event!=v&&A.callback!=g}))}},{key:"emit",value:function(){var v=[].concat(Array.prototype.slice.call(arguments)),g=v.shift();this.callbacks.filter(function(A){return A.event==g}).forEach(function(A){A&&typeof A.callback=="function"&&A.callback.apply(A,ne(v))})}}]),R}(),il=function(R){G(E,R);function E(v){P(this,E);var g=Z(this,(E.__proto__||Object.getPrototypeOf(E)).call(this,v));return g.isColorPickerShow=!1,g.isShortCut=!1,g.hideDelay=+(typeof g.opt.hideDeplay>"u"?2e3:g.opt.hideDelay),g.timerCloseColorPicker,g.autoHide=g.opt.autoHide||!0,g.outputFormat=g.opt.outputFormat,g.$checkColorPickerClass=g.checkColorPickerClass.bind(g),g}return D(E,[{key:"initialize",value:function(){var g=this;this.$body=null,this.$root=null,this.$store=new N0({modules:[D0,S0]}),this.callbackChange=function(){g.callbackColorValue()},this.callbackLastUpdate=function(){g.callbackLastUpdateColorValue()},this.callbackAddCurrentColor=function(A){g.callbackAddCurrentColorValue(A)},this.colorpickerShowCallback=function(){},this.colorpickerHideCallback=function(){},this.colorpickerLastUpdateCallback=function(){},this.colorpickerAddCurrentColorCallback=function(){},this.$body=new kn(this.getContainer()),this.$root=new kn("div","easylogic-colorpicker",{tabIndex:-1}),this.opt.position=="inline"&&this.$body.append(this.$root),this.opt.type&&this.$root.addClass(this.opt.type),this.opt.hideInformation&&this.$root.addClass("hide-information"),this.opt.hideColorsets&&this.$root.addClass("hide-colorsets"),this.$arrow=new kn("div","arrow"),this.$root.append(this.$arrow),this.opt.colorSets?this.$store.dispatch("/setUserPalette",this.opt.colorSet):yc(this.opt.onRetrievePreset)?this.$store.dispatch("/setUserPalette",this.opt.onRetrievePreset()):this.$store.dispatch("/setUserPalette",[]),this.render(),this.$root.append(this.$el),this.initColorWithoutChangeEvent(this.opt.color),this.initializeEvent()}},{key:"initColorWithoutChangeEvent",value:function(g){this.$store.dispatch("/initColor",g)}},{key:"show",value:function(g,A,B,V,$,ee){this.colorpickerShowCallback=B,this.colorpickerHideCallback=V,this.colorpickerLastUpdateCallback=$,this.colorpickerAddCurrentColorCallback=ee,this.$root.css(this.getInitalizePosition()).show(),this.isColorPickerShow=!0,this.isShortCut=g.isShortCut||!1,this.outputFormat=g.outputFormat,this.hideDelay=+(typeof g.hideDelay>"u"?2e3:g.hideDelay),this.hideDelay>0&&this.setHideDelay(this.hideDelay),this.$root.appendTo(this.$body),this.definePosition(g),this.initColorWithoutChangeEvent(A)}},{key:"initColor",value:function(g,A){this.$store.dispatch("/changeColor",g,A)}},{key:"hide",value:function(){this.isColorPickerShow&&(this.$root.hide(),this.$root.remove(),this.isColorPickerShow=!1,this.callbackHideColorValue())}},{key:"setColorsInPalette",value:function(){var g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];this.$store.dispatch("/setCurrentColorAll",g)}},{key:"setUserPalette",value:function(){var g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];this.$store.dispatch("/setUserPalette",g)}},{key:"getOption",value:function(g){return this.opt[g]}},{key:"setOption",value:function(g,A){this.opt[g]=A}},{key:"isType",value:function(g){return this.getOption("type")==g}},{key:"isPaletteType",value:function(){return this.isType("palette")}},{key:"isSketchType",value:function(){return this.isType("sketch")}},{key:"getContainer",value:function(){return this.opt.container||document.body}},{key:"getColor",value:function(g){return this.$store.dispatch("/toColor",g)}},{key:"definePositionForArrow",value:function(g,A,B){}},{key:"definePosition",value:function(g){var A=this.$root.width(),B=this.$root.height(),V=g.left-this.$body.scrollLeft();A+V>window.innerWidth&&(V-=A+V-window.innerWidth),V<0&&(V=0);var $=g.top-this.$body.scrollTop();B+$>window.innerHeight&&($-=B+$-window.innerHeight),$<0&&($=0),this.$root.css({left:V+"px",top:$+"px"})}},{key:"getInitalizePosition",value:function(){return this.opt.position=="inline"?{position:"relative",left:"auto",top:"auto",display:"inline-block"}:{position:"fixed",left:"-10000px",top:"-10000px"}}},{key:"isAbsolute",value:function(){return this.opt.position!=="inline"}},{key:"mouseup.isAbsolute document",value:function(g){this.__isMouseDown=!1,this.checkInHtml(g.target)||(this.checkColorPickerClass(g.target)==!1?this.hide():this.__isMouseIn||(clearTimeout(this.timerCloseColorPicker),this.timerCloseColorPicker=setTimeout(this.hide.bind(this),this.delayTime||this.hideDelay)))}},{key:"keyup.isAbsolute.escape $root",value:function(g){this.hide()}},{key:"mouseover.isAbsolute $root",value:function(g){clearTimeout(this.timerCloseColorPicker)}},{key:"mousemove.isAbsolute $root",value:function(g){clearTimeout(this.timerCloseColorPicker)}},{key:"mouseenter.isAbsolute $root",value:function(g){clearTimeout(this.timerCloseColorPicker),this.__isMouseIn=!0}},{key:"mouseleave.isAbsolute $root",value:function(g){this.__isMouseIn=!1,this.__isMouseDown||(clearTimeout(this.timerCloseColorPicker),this.timerCloseColorPicker=setTimeout(this.hide.bind(this),this.delayTime||this.hideDelay))}},{key:"mousedown.isAbsolute $root",value:function(g){this.__isMouseDown=!0}},{key:"setHideDelay",value:function(g){this.delayTime=g||0}},{key:"runHideDelay",value:function(){this.isColorPickerShow&&this.setHideDelay()}},{key:"callbackColorValue",value:function(g){g=g||this.getCurrentColor(),typeof this.opt.onChange=="function"&&this.opt.onChange.call(this,g),typeof this.colorpickerShowCallback=="function"&&this.colorpickerShowCallback(g)}},{key:"callbackLastUpdateColorValue",value:function(g){g=g||this.getCurrentColor(),typeof this.opt.onLastUpdate=="function"&&this.opt.onLastUpdate.call(this,g),typeof this.colorpickerLastUpdateCallback=="function"&&this.colorpickerLastUpdateCallback(g)}},{key:"callbackAddCurrentColorValue",value:function(g){typeof this.opt.onLastUpdate=="function"&&this.opt.onAddPreset.call(this,g),typeof this.colorpickerAddCurrentColorCallback=="function"&&this.colorpickerAddCurrentColorCallback(g)}},{key:"callbackHideColorValue",value:function(g){g=g||this.getCurrentColor(),typeof this.opt.onHide=="function"&&this.opt.onHide.call(this,g),typeof this.colorpickerHideCallback=="function"&&this.colorpickerHideCallback(g)}},{key:"getCurrentColor",value:function(){return this.$store.dispatch("/toColor",this.outputFormat)}},{key:"checkColorPickerClass",value:function(g){var A=new kn(g).closest("codemirror-colorview"),B=new kn(g).closest("easylogic-colorpicker"),V=new kn(g).closest("CodeMirror");return g.nodeName=="HTML",!!(B||A||V)}},{key:"checkInHtml",value:function(g){var A=g.nodeName=="HTML";return A}},{key:"initializeStoreEvent",value:function(){U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"initializeStoreEvent",this).call(this),this.$store.on("changeColor",this.callbackChange),this.$store.on("lastUpdateColor",this.callbackLastUpdate),this.$store.on("changeFormat",this.callbackChange),this.$store.on("addCurrentColor",this.callbackAddCurrentColor)}},{key:"destroy",value:function(){U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"destroy",this).call(this),this.$store.off("changeColor",this.callbackChange),this.$store.off("lastUpdateColor",this.callbackLastUpdate),this.$store.off("changeFormat",this.callbackChange),this.$store.off("addCurrentColor",this.callbackAddCurrentColor),this.callbackChange=void 0,this.callbackLastUpdate=void 0,this.callbackAddCurrentColor=void 0,this.colorpickerShowCallback=void 0,this.colorpickerHideCallback=void 0}}]),E}(nn),w0=function(R){G(E,R);function E(v){P(this,E);var g=Z(this,(E.__proto__||Object.getPrototypeOf(E)).call(this,v));return g.source="base-box",g}return D(E,[{key:"refresh",value:function(){}},{key:"refreshColorUI",value:function(g){}},{key:"changeColor",value:function(g){this.$store.dispatch("/changeColor",Object.assign({source:this.source},g||{}))}},{key:"mouseup document",value:function(g){this.onDragEnd(g)}},{key:"mousemove document",value:function(g){this.onDragMove(g)}},{key:"mousedown $bar",value:function(g){g.preventDefault(),this.isDown=!0}},{key:"mousedown $container",value:function(g){this.isDown=!0,this.onDragStart(g)}},{key:"touchend document",value:function(g){this.onDragEnd(g)}},{key:"touchmove document",value:function(g){this.onDragMove(g)}},{key:"touchstart $bar",value:function(g){g.preventDefault(),this.isDown=!0}},{key:"touchstart $container",value:function(g){this.onDragStart(g)}},{key:"onDragStart",value:function(g){this.isDown=!0,this.refreshColorUI(g)}},{key:"onDragMove",value:function(g){this.isDown&&this.refreshColorUI(g)}},{key:"onDragEnd",value:function(g){this.isDown&&(this.$store.emit("lastUpdateColor"),this.isDown=!1)}},{key:"@changeColor",value:function(g){this.source!=g&&this.refresh()}},{key:"@initColor",value:function(){this.refresh()}}]),E}(nn),Bh=function(R){G(E,R);function E(v){P(this,E);var g=Z(this,(E.__proto__||Object.getPrototypeOf(E)).call(this,v));return g.minValue=0,g.maxValue=1,g.source="base-slider",g}return D(E,[{key:"getMinMaxPosition",value:function(){var g=this.getMinPosition(),A=this.getMaxDist(),B=g+A;return{min:g,max:B,width:A}}},{key:"getCurrent",value:function(g){return min+this.getMaxDist()*g}},{key:"getMinPosition",value:function(){return this.refs.$container.offset().left}},{key:"getMaxDist",value:function(){return this.state.get("$container.width")}},{key:"getDist",value:function(g){var A=this.getMinMaxPosition(),B=A.min,V=A.max,$;return g<B?$=0:g>V?$=100:$=(g-B)/(V-B)*100,$}},{key:"getCaculatedDist",value:function(g){var A=g?this.getMousePosition(g):this.getCurrent(this.getDefaultValue()/this.maxValue),B=this.getDist(A);return B}},{key:"getDefaultValue",value:function(){return 0}},{key:"setMousePosition",value:function(g){this.refs.$bar.css({left:g+"px"})}},{key:"getMousePosition",value:function(g){return to.pos(g).pageX}},{key:"refresh",value:function(){this.setColorUI()}},{key:"setColorUI",value:function(g){if(g=g||this.getDefaultValue(),this.lastV===g)return!0;this.lastV=g,g<=this.minValue?this.refs.$bar.addClass("first").removeClass("last"):g>=this.maxValue?this.refs.$bar.addClass("last").removeClass("first"):this.refs.$bar.removeClass("last").removeClass("first"),this.setMousePosition(this.getMaxDist()*((g||0)/this.maxValue))}}]),E}(w0),yg=function(R){G(E,R);function E(v){P(this,E);var g=Z(this,(E.__proto__||Object.getPrototypeOf(E)).call(this,v));return g.minValue=0,g.maxValue=1,g.source="value-control",g}return D(E,[{key:"template",value:function(){return`
            <div class="value">
                <div ref="$container" class="value-container">
                    <div ref="$bar" class="drag-bar"></div>
                </div>
            </div>
        `}},{key:"setBackgroundColor",value:function(){this.refs.$container.css("background-color",this.$store.dispatch("/toRGB"))}},{key:"refresh",value:function(){U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"refresh",this).call(this),this.setBackgroundColor()}},{key:"getDefaultValue",value:function(){return this.$store.hsv.v}},{key:"refreshColorUI",value:function(g){var A=this.getCaculatedDist(g);this.setColorUI(A/100*this.maxValue),this.changeColor({type:"hsv",v:A/100*this.maxValue})}}]),E}(Bh),ud=function(R){G(E,R);function E(v){P(this,E);var g=Z(this,(E.__proto__||Object.getPrototypeOf(E)).call(this,v));return g.minValue=0,g.maxValue=1,g.source="opacity-control",g}return D(E,[{key:"template",value:function(){return`
        <div class="opacity">
            <div ref="$container" class="opacity-container">
                <div ref="$colorbar" class="color-bar"></div>
                <div ref="$bar" class="drag-bar2"></div>
            </div>
        </div>
        `}},{key:"refresh",value:function(){U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"refresh",this).call(this),this.setOpacityColorBar()}},{key:"setOpacityColorBar",value:function(){var g=Object.assign({},this.$store.rgb);g.a=0;var A=gi.format(g,"rgb");g.a=1;var B=gi.format(g,"rgb");this.setOpacityColorBarBackground(A,B)}},{key:"setOpacityColorBarBackground",value:function(g,A){this.refs.$colorbar.css("background","linear-gradient(to right, "+g+", "+A+")")}},{key:"getDefaultValue",value:function(){return this.$store.alpha}},{key:"refreshColorUI",value:function(g){var A=this.getCaculatedDist(g);this.setColorUI(A/100*this.maxValue),this.changeColor({a:Math.floor(A)/100*this.maxValue})}}]),E}(Bh),F0="macos-control",L0=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"components",value:function(){return{Value:yg,Opacity:ud}}},{key:"template",value:function(){return`
        <div class="control">
            <div target="Value" ></div>
            <div target="Opacity" ></div>
            <div ref="$controlPattern" class="empty"></div>
            <div ref="$controlColor" class="color"></div>
        </div>
        `}},{key:"setBackgroundColor",value:function(){this.refs.$controlColor.css("background-color",this.$store.dispatch("/toRGB"))}},{key:"refresh",value:function(){this.setColorUI(),this.setBackgroundColor()}},{key:"setColorUI",value:function(){this.Value.setColorUI(),this.Opacity.setColorUI()}},{key:"@changeColor",value:function(g){F0!=g&&this.refresh()}},{key:"@initColor",value:function(){this.refresh()}}]),E}(nn),Cg=function(R){G(E,R);function E(v){P(this,E);var g=Z(this,(E.__proto__||Object.getPrototypeOf(E)).call(this,v));return g.width=214,g.height=214,g.thinkness=0,g.half_thinkness=0,g.source="colorwheel",g}return D(E,[{key:"template",value:function(){return`
        <div class="wheel">
            <canvas class="wheel-canvas" ref="$colorwheel" ></canvas>
            <div class="wheel-canvas" ref="$valuewheel" ></div>
            <div class="drag-pointer" ref="$drag_pointer"></div>
        </div>
        `}},{key:"refresh",value:function(g){this.setColorUI(g)}},{key:"setColorUI",value:function(g){this.renderCanvas(),this.renderValue(),this.setHueColor(null,g)}},{key:"renderValue",value:function(){var g=1-this.$store.hsv.v;this.refs.$valuewheel.css({"background-color":"rgba(0, 0, 0, "+g+")"})}},{key:"renderWheel",value:function(g,A){this.width&&!g&&(g=this.width),this.height&&!A&&(A=this.height);var B=new kn("canvas"),V=B.el.getContext("2d");B.el.width=g,B.el.height=A,B.css({width:g+"px",height:A+"px"});for(var $=V.getImageData(0,0,g,A),ee=$.data,fe=Math.floor(g/2),pe=Math.floor(A/2),Ae=g>A?pe:fe,we=fe,ct=pe,at=0;at<A;at++)for(var ot=0;ot<g;ot++){var Dt=ot-we+1,Ht=at-ct+1,bi=Dt*Dt+Ht*Ht,Vi=f(Dt,Ht),_r=gi.HSVtoRGB(Vi,Math.min(Math.sqrt(bi)/Ae,1),1),lr=(at*g+ot)*4;ee[lr]=_r.r,ee[lr+1]=_r.g,ee[lr+2]=_r.b,ee[lr+3]=255}return V.putImageData($,0,0),this.thinkness>0&&(V.globalCompositeOperation="destination-out",V.fillStyle="black",V.beginPath(),V.arc(we,ct,Ae-this.thinkness,0,Math.PI*2),V.closePath(),V.fill()),B}},{key:"renderCanvas",value:function(){if(!this.$store.createdWheelCanvas){var g=this.refs.$colorwheel,A=g.el.getContext("2d"),B=g.size(),V=he(B,2),$=V[0],ee=V[1];this.width&&!$&&($=this.width),this.height&&!ee&&(ee=this.height),g.el.width=$,g.el.height=ee,g.css({width:$+"px",height:ee+"px"});var fe=this.renderWheel($,ee);A.drawImage(fe.el,0,0),this.$store.createdWheelCanvas=!0}}},{key:"getDefaultValue",value:function(){return this.$store.hsv.h}},{key:"getDefaultSaturation",value:function(){return this.$store.hsv.s}},{key:"getCurrentXY",value:function(g,A,B,V,$){return g?to.posXY(g):d(A,B,V,$)}},{key:"getRectangle",value:function(){var g=this.state.get("$el.width"),A=this.state.get("$el.height"),B=this.state.get("$colorwheel.width")/2,V=this.refs.$el.offset().left,$=V+g/2,ee=this.refs.$el.offset().top,fe=ee+A/2;return{minX:V,minY:ee,width:g,height:A,radius:B,centerX:$,centerY:fe}}},{key:"setHueColor",value:function(g,A){if(this.state.get("$el.width")){var B=this.getRectangle(),V=B.minX,$=B.minY,ee=B.radius,fe=B.centerX,pe=B.centerY,Ae=this.getCurrentXY(g,this.getDefaultValue(),this.getDefaultSaturation()*ee,fe,pe),we=Ae.x,ct=Ae.y,at=we-fe,ot=ct-pe,Dt=at*at+ot*ot,Ht=f(at,ot);if(Dt>ee*ee)var bi=this.getCurrentXY(null,Ht,ee,fe,pe),we=bi.x,ct=bi.y;var Vi=Math.min(Math.sqrt(Dt)/ee,1);this.refs.$drag_pointer.css({left:we-V+"px",top:ct-$+"px"}),A||this.changeColor({type:"hsv",h:Ht,s:Vi})}}},{key:"changeColor",value:function(g){this.$store.dispatch("/changeColor",Object.assign({source:this.source},g||{}))}},{key:"@changeColor",value:function(g){this.source!=g&&this.refresh(!0)}},{key:"@initColor",value:function(){this.refresh(!0)}},{key:"mouseup document",value:function(g){this.isDown&&(this.isDown=!1,this.$store.emit("lastUpdateColor"))}},{key:"mousemove document",value:function(g){this.isDown&&this.setHueColor(g)}},{key:"mousedown $drag_pointer",value:function(g){g.preventDefault(),this.isDown=!0}},{key:"mousedown $el",value:function(g){this.isDown=!0,this.setHueColor(g)}},{key:"touchend document",value:function(g){this.isDown&&(this.isDown=!1,this.$store.emit("lastUpdateColor"))}},{key:"touchmove document",value:function(g){this.isDown&&this.setHueColor(g)}},{key:"touchstart $drag_pointer",value:function(g){g.preventDefault(),this.isDown=!0}},{key:"touchstart $el",value:function(g){g.preventDefault(),this.isDown=!0,this.setHueColor(g)}}]),E}(nn),dd="chromedevtool-information",fd=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"template",value:function(){return`
        <div class="information hex">
            <div ref="$informationChange" class="information-change">
                <button ref="$formatChangeButton" type="button" class="format-change-button arrow-button"></button>
            </div>
            <div class="information-item hex">
                <div class="input-field hex">
                    <input ref="$hexCode" class="input" type="text" />
                    <div class="title">HEX</div>
                </div>
            </div>
            <div class="information-item rgb">
                <div class="input-field rgb-r">
                    <input ref="$rgb_r" class="input" type="number" step="1" min="0" max="255" />
                    <div class="title">R</div>
                </div>
                <div class="input-field rgb-g">
                    <input ref="$rgb_g" class="input" type="number" step="1" min="0" max="255" />
                    <div class="title">G</div>
                </div>
                <div class="input-field rgb-b">
                    <input ref="$rgb_b" class="input" type="number" step="1" min="0" max="255" />
                    <div class="title">B</div>
                </div>          
                <div class="input-field rgb-a">
                    <input ref="$rgb_a" class="input" type="number" step="0.01" min="0" max="1" />
                    <div class="title">A</div>
                </div>                                                            
            </div>
            <div class="information-item hsl">
                <div class="input-field hsl-h">
                    <input ref="$hsl_h" class="input" type="number" step="1" min="0" max="360" />
                    <div class="title">H</div>
                </div>
                <div class="input-field hsl-s">
                    <input ref="$hsl_s" class="input" type="number" step="1" min="0" max="100" />
                    <div class="postfix">%</div>
                    <div class="title">S</div>
                </div>
                <div class="input-field hsl-l">
                    <input ref="$hsl_l" class="input" type="number" step="1" min="0" max="100" />
                    <div class="postfix">%</div>                        
                    <div class="title">L</div>
                </div>
                <div class="input-field hsl-a">
                    <input ref="$hsl_a" class="input" type="number" step="0.01" min="0" max="1" />
                    <div class="title">A</div>
                </div>
            </div>
        </div>
        `}},{key:"setCurrentFormat",value:function(g){this.format=g,this.initFormat()}},{key:"initFormat",value:function(){var g=this,A=this.format||"hex";["hex","rgb","hsl"].filter(function(B){return B!==A}).forEach(function(B){g.$el.removeClass(B)}),this.$el.addClass(A)}},{key:"nextFormat",value:function(){var g=this.format||"hex",A="hex";g=="hex"?A="rgb":g=="rgb"?A="hsl":g=="hsl"&&(A="hex"),this.format=A,this.initFormat(),this.$store.dispatch("/changeFormat",this.format),this.$store.emit("lastUpdateColor")}},{key:"goToFormat",value:function(g){this.format=g,(g==="rgb"||g==="hsl")&&this.initFormat(),this.$store.dispatch("/changeFormat",this.format)}},{key:"getFormat",value:function(){return this.format||"hex"}},{key:"checkNumberKey",value:function(g){var A=g.which,B=!1;return(A==37||A==39||A==8||A==46||A==9)&&(B=!0),!(!B&&(A<48||A>57))}},{key:"checkNotNumberKey",value:function(g){return!this.checkNumberKey(g)}},{key:"changeRgbColor",value:function(){this.$store.dispatch("/changeColor",{type:"rgb",r:this.refs.$rgb_r.int(),g:this.refs.$rgb_g.int(),b:this.refs.$rgb_b.int(),a:this.refs.$rgb_a.float(),source:dd}),this.$store.emit("lastUpdateColor")}},{key:"changeHslColor",value:function(){this.$store.dispatch("/changeColor",{type:"hsl",h:this.refs.$hsl_h.int(),s:this.refs.$hsl_s.int(),l:this.refs.$hsl_l.int(),a:this.refs.$hsl_a.float(),source:dd}),this.$store.emit("lastUpdateColor")}},{key:"@changeColor",value:function(g){dd!=g&&this.refresh()}},{key:"@initColor",value:function(){this.refresh()}},{key:"input $rgb_r",value:function(g){this.changeRgbColor()}},{key:"input $rgb_g",value:function(g){this.changeRgbColor()}},{key:"input $rgb_b",value:function(g){this.changeRgbColor()}},{key:"input $rgb_a",value:function(g){this.changeRgbColor()}},{key:"input $hsl_h",value:function(g){this.changeHslColor()}},{key:"input $hsl_s",value:function(g){this.changeHslColor()}},{key:"input $hsl_l",value:function(g){this.changeHslColor()}},{key:"input $hsl_a",value:function(g){this.changeHslColor()}},{key:"keyup $hexCode",value:function(g){var A=this.refs.$hexCode.val();A.charAt(0)=="#"&&(A.length==7||A.length===9)&&(this.$store.dispatch("/changeColor",A,dd),this.$store.emit("lastUpdateColor"))}},{key:"click $formatChangeButton",value:function(g){this.nextFormat()}},{key:"click $el .information-item.hex .input-field .title",value:function(g){this.goToFormat("hex")}},{key:"click $el .information-item.rgb .input-field .title",value:function(g){this.goToFormat("hsl")}},{key:"click $el .information-item.hsl .input-field .title",value:function(g){this.goToFormat("rgb")}},{key:"setRGBInput",value:function(){this.refs.$rgb_r.val(this.$store.rgb.r),this.refs.$rgb_g.val(this.$store.rgb.g),this.refs.$rgb_b.val(this.$store.rgb.b),this.refs.$rgb_a.val(this.$store.alpha)}},{key:"setHSLInput",value:function(){this.refs.$hsl_h.val(this.$store.hsl.h),this.refs.$hsl_s.val(this.$store.hsl.s),this.refs.$hsl_l.val(this.$store.hsl.l),this.refs.$hsl_a.val(this.$store.alpha)}},{key:"setHexInput",value:function(){this.refs.$hexCode.val(this.$store.dispatch("/toHEX"))}},{key:"refresh",value:function(){this.setCurrentFormat(this.$store.format),this.setRGBInput(),this.setHSLInput(),this.setHexInput()}}]),E}(nn),B0="data-colorsets-index",_d=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"template",value:function(){return`
            <div class="color-chooser">
                <div class="color-chooser-container">
                    <div class="colorsets-item colorsets-item-header">
                        <h1 class="title">Color Palettes</h1>
                        <span ref="$toggleButton" class="items">&times;</span>
                    </div>
                    <div ref="$colorsetsList" class="colorsets-list"></div>
                </div>
            </div>
        `}},{key:"refresh",value:function(){this.load()}},{key:"@changeCurrentColorSets",value:function(){this.refresh()}},{key:"@toggleColorChooser",value:function(){this.toggle()}},{key:"load $colorsetsList",value:function(){var g=this.$store.dispatch("/getColorSetsList");return`
            <div>
                `+g.map(function(A,B){return`
                        <div class="colorsets-item" data-colorsets-index="`+B+`" >
                            <h1 class="title">`+A.name+`</h1>
                            <div class="items">
                                <div>
                                    `+A.colors.filter(function(V,$){return $<5}).map(function(V){return V=V||"rgba(255, 255, 255, 1)",'<div class="color-item" title="'+V+`">
                                                <div class="color-view" style="background-color: `+V+`"></div>
                                            </div>`}).join("")+`
                                </div>
                            </div>
                        </div>`}).join("")+`
            </div>
        `}},{key:"show",value:function(){this.$el.addClass("open")}},{key:"hide",value:function(){this.$el.removeClass("open")}},{key:"toggle",value:function(){this.$el.toggleClass("open")}},{key:"click $toggleButton",value:function(g){this.toggle()}},{key:"click $colorsetsList .colorsets-item",value:function(g){var A=g.$delegateTarget;if(A){var B=parseInt(A.attr(B0));this.$store.dispatch("/setCurrentColorSets",B),this.hide()}}},{key:"destroy",value:function(){U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"destroy",this).call(this),this.hide()}}]),E}(nn),pd=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"template",value:function(){return`
            <div class="colorsets">
                <div class="menu" title="Open Color Palettes">
                    <button ref="$colorSetsChooseButton" type="button" class="color-sets-choose-btn arrow-button"></button>
                </div>
                <div ref="$colorSetsColorList" class="color-list"></div>
            </div>
        `}},{key:"load $colorSetsColorList",value:function(){var g=this.$store.dispatch("/getCurrentColorSets"),A=this.$store.dispatch("/getCurrentColors");return`
            <div>
                <h6>`+g.name+`</h6>
                <div class="current-color-sets">
                `+A.map(function(B,V){return'<div class="color-item" title="'+B+'" data-index="'+V+'" data-color="'+B+`">
                        <div class="empty"></div>
                        <div class="color-view" style="background-color: `+B+`"></div>
                    </div>`}).join("")+`   
                `+(g.edit?'<div class="add-color-item">+</div>':"")+`         
                </div>
            </div>
            
        `}},{key:"refresh",value:function(){this.load()}},{key:"addColor",value:function(g){this.$store.dispatch("/addCurrentColor",g)}},{key:"@changeCurrentColorSets",value:function(){this.refresh()}},{key:"click $colorSetsChooseButton",value:function(g){this.$store.emit("toggleColorChooser")}},{key:"contextmenu $colorSetsColorList",value:function(g){g.preventDefault();var A=this.$store.dispatch("/getCurrentColorSets");if(A.edit){var B=new kn(g.target),V=B.closest("color-item");if(V){var $=parseInt(V.attr("data-index"));this.$store.emit("showContextMenu",g,$)}else this.$store.emit("showContextMenu",g)}}},{key:"click $colorSetsColorList .add-color-item",value:function(g){this.addColor(this.$store.dispatch("/toColor"))}},{key:"click $colorSetsColorList .color-item",value:function(g){this.$store.dispatch("/changeColor",g.$delegateTarget.attr("data-color")),this.$store.emit("lastUpdateColor")}}]),E}(nn),md=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"template",value:function(){return`
            <ul class="colorsets-contextmenu">
                <li class="menu-item small-hide" data-type="remove-color">Remove color</li>
                <li class="menu-item small-hide" data-type="remove-all-to-the-right">Remove all to the right</li>
                <li class="menu-item" data-type="clear-palette">Clear palette</li>
            </ul>
        `}},{key:"show",value:function(g,A){var B=to.pos(g);this.$el.css({top:B.clientY-10+"px",left:B.clientX+"px"}),this.$el.addClass("show"),this.selectedColorIndex=A,typeof this.selectedColorIndex>"u"?this.$el.addClass("small"):this.$el.removeClass("small")}},{key:"hide",value:function(){this.$el.removeClass("show")}},{key:"runCommand",value:function(g){switch(g){case"remove-color":this.$store.dispatch("/removeCurrentColor",this.selectedColorIndex);break;case"remove-all-to-the-right":this.$store.dispatch("/removeCurrentColorToTheRight",this.selectedColorIndex);break;case"clear-palette":this.$store.dispatch("/clearPalette");break}}},{key:"@showContextMenu",value:function(g,A){this.show(g,A)}},{key:"click $el .menu-item",value:function(g){g.preventDefault(),this.runCommand(g.$delegateTarget.attr("data-type")),this.hide()}}]),E}(nn),Ag=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"template",value:function(){return`
            <div class='colorpicker-body'>
                <div target="colorwheel"></div>
                <div target="control"></div>
                <div target="information"></div>
                <div target="currentColorSets"></div>
                <div target="colorSetsChooser"></div>
                <div target="contextMenu"></div>                
            </div>
        `}},{key:"components",value:function(){return{colorwheel:Cg,control:L0,information:fd,currentColorSets:pd,colorSetsChooser:_d,contextMenu:md}}}]),E}(il),Rg=function(R){G(E,R);function E(v){P(this,E);var g=Z(this,(E.__proto__||Object.getPrototypeOf(E)).call(this,v));return g.minValue=0,g.maxValue=360,g.source="hue-control",g}return D(E,[{key:"template",value:function(){return`
            <div class="hue"> 
                <div ref="$container" class="hue-container">
                    <div ref="$bar" class="drag-bar"></div>
                </div>
            </div>
        `}},{key:"getDefaultValue",value:function(){return this.$store.hsv.h}},{key:"refreshColorUI",value:function(g){var A=this.getCaculatedDist(g),B=this.setColorUI(A/100*this.maxValue);B!==!0&&this.changeColor({h:A/100*this.maxValue,type:"hsv"})}}]),E}(Bh),U0=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"initialize",value:function(){U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"initialize",this).call(this),this.minValue=0,this.maxValue=360,this.hueScaleDist=.05}},{key:"template",value:function(){return`
            <div class="hue-scale">
                <div ref="$container" class="hue-scale-container">
                    <div ref="$bar" class="drag-bar"></div>
                </div>
            </div>
        `}},{key:"getDefaultValue",value:function(){return this.$store.hsv.h}},{key:"getCalculatedDist",value:function(g){var A=g?this.getMousePosition(g):this.getCurrent(this.getDefaultValue()/this.maxValue),B=this.getDist(A);return B}},{key:"refreshColorUI",value:function(g){var A=this.getCalculatedDist(g),B=this.setColorUI(A/100);B!==!0&&this.changeColor({h:(this.minValue+this.fullDist*(A/100))*360,type:"hsv"})}},{key:"setColorUI",value:function(g){var A=void 0;if(g){if(A=this.minValue+g*this.fullDist,this.lastP===A)return!0;this.lastP=A}else{if(A=this.getDefaultValue()/360,this.lastP===A)return!0;this.lastP=A;var B=A+.05,V=A-.05;if(B>1)B=1,V=1-this.hueScaleDist*2;else if(V<0){var $=Math.abs(V);V=0,B=B+$}var ee=Je.getHueScale(A,V,B);this.list=ee;var fe=ee[0].start,pe=ee[ee.length-1].start;this.minValue=fe,this.maxValue=pe;var Ae=this.maxValue-this.minValue;this.fullDist=Ae;var we=ee.map(function(ct){return{color:ct.rgb,percent:(ct.start-fe)/Ae*100,unit:"%"}});this.refs.$container.css("background-image","linear-gradient(to right, "+we.map(function(ct){return ct.color+" "+ct.percent+ct.unit}).join(",")+")")}A<=this.minValue?(A=this.minValue,this.refs.$bar.addClass("first").removeClass("last")):A>=this.maxValue?(A=this.maxValue,this.refs.$bar.addClass("last").removeClass("first")):this.refs.$bar.removeClass("last").removeClass("first"),this.setMousePosition(this.getMaxDist()*((A-this.minValue)/this.fullDist))}}]),E}(Bh),Ig="chromedevtool-control",V0=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"components",value:function(){return{Hue:Rg,Opacity:ud,HueScale:U0}}},{key:"template",value:function(){return`
        <div class="control">
            <div target="Hue" ></div>
            <div target="HueScale" ></div>
            <div target="Opacity" ></div>
            <div ref="$controlPattern" class="empty"></div>
            <div ref="$controlColor" class="color"></div>
            <div ref="$controlPattern2" class="empty2"></div>
            <div ref="$controlColor2" class="color2"></div>            
        </div>
        `}},{key:"setBackgroundColor",value:function(){this.refs.$controlColor.css("background-color",this.$store.dispatch("/toRGB"))}},{key:"setLastUpdateColor",value:function(){this.refs.$controlColor2.css("background-color",this.$store.dispatch("/toRGB"))}},{key:"refresh",value:function(){this.setColorUI(),this.setBackgroundColor()}},{key:"setColorUI",value:function(){this.Hue.setColorUI(),this.Opacity.setColorUI()}},{key:"@changeColor",value:function(g){Ig!=g&&this.refresh()}},{key:"@lastUpdateColor",value:function(g){Ig!=g&&this.setLastUpdateColor()}},{key:"@initColor",value:function(){this.refresh()}}]),E}(nn),Pg="chromedevtool-palette",Rc=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"template",value:function(){return`
        <div class="color">
            <div ref="$saturation" class="saturation">
                <div ref="$value" class="value">
                    <div ref="$drag_pointer" class="drag-pointer" data-axis-value="all">
                        <div ref="$left_saturation" class="left-saturation" data-axis-value="saturation"></div>
                        <div ref="$right_saturation" class="right-saturation" data-axis-value="saturation"></div>
                        <div ref="$top_value" class="top-value" data-axis-value="value"></div>
                        <div ref="$bottom_value" class="bottom-value" data-axis-value="value"></div>
                    </div>
                </div>
            </div>        
        </div>        
        `}},{key:"setBackgroundColor",value:function(g){this.$el.css("background-color",g)}},{key:"refresh",value:function(){this.cacheSize(),this.setColorUI()}},{key:"calculateSV",value:function(){var g=this.drag_pointer_pos||{x:0,y:0},A=this.state.get("$el.width"),B=this.state.get("$el.height"),V=g.x/A,$=(B-g.y)/B;this.$store.dispatch("/changeColor",{type:"hsv",s:V,v:$,source:Pg})}},{key:"setColorUI",value:function(){var g=this.w*this.$store.hsv.s,A=this.h*(1-this.$store.hsv.v);this.refs.$drag_pointer.css({left:g+"px",top:A+"px"}),this.drag_pointer_pos={x:g,y:A},this.setBackgroundColor(this.$store.dispatch("/getHueColor"))}},{key:"setSubColor",value:function(g){var A=g.pageX,B=g.pageY,V=A-this.x,$=B-this.y,ee=this.$el.contentWidth(),fe=this.$el.contentHeight(),pe=this.refs.$drag_pointer.cssFloat("left"),Ae=this.refs.$drag_pointer.cssFloat("top");this.axis==="saturation"?pe+=V:this.axis==="value"&&(Ae+=$),pe<0?pe=0:pe>ee&&(pe=ee),Ae<0?Ae=0:Ae>fe&&(Ae=fe),this.refs.$drag_pointer.px("left",pe),this.refs.$drag_pointer.px("top",Ae),this.drag_pointer_pos={x:pe,y:Ae},this.x=A,this.y=B,this.calculateSV()}},{key:"setMainColor",value:function(g){var A=this.$el.offset(),B=this.w,V=this.h,$=to.pos(g).pageX-A.left,ee=to.pos(g).pageY-A.top;$<0?$=0:$>B&&($=B),ee<0?ee=0:ee>V&&(ee=V),this.refs.$drag_pointer.css({left:$+"px",top:ee+"px"}),this.drag_pointer_pos={x:$,y:ee},this.calculateSV()}},{key:"@changeColor",value:function(g){Pg!=g&&this.refresh()}},{key:"@initColor",value:function(){this.refresh()}},{key:"mouseup document",value:function(g){this.isDown&&(this.isDown=!1,this.$store.emit("lastUpdateColor"))}},{key:"mousemove document",value:function(g){this.isDown&&(this.cacheSize(),this.axis==="saturation"||this.axis==="value"?this.setSubColor(g):this.setMainColor(g))}},{key:"mousedown",value:function(g){this.isDown=!0,this.cacheSize(),this.axis=new kn(g.target).attr("data-axis-value"),this.x=g.pageX,this.y=g.pageY,this.axis==="saturation"||this.axis==="value"?this.setSubColor(g):this.setMainColor(g)}},{key:"touchend document",value:function(g){this.isDown&&(this.isDown=!1,this.$store.emit("lastUpdateColor"))}},{key:"touchmove document",value:function(g){this.isDown&&this.setMainColor(g)}},{key:"touchstart",value:function(g){g.preventDefault(),this.isDown=!0,this.cacheSize(),this.setMainColor(g)}},{key:"cacheSize",value:function(){this.w=this.state.get("$el.contentWidth"),this.h=this.state.get("$el.contentHeight")}}]),E}(nn),c_=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"template",value:function(){return`
            <div class='colorpicker-body'>
                <div target="palette"></div> 
                <div target="control"></div>
                <div target="information"></div>
                <div target="currentColorSets"></div>
                <div target="colorSetsChooser"></div>
                <div target="contextMenu"></div>
            </div>
        `}},{key:"components",value:function(){return{palette:Rc,control:V0,information:fd,currentColorSets:pd,colorSetsChooser:_d,contextMenu:md}}}]),E}(il),k0="mini-control",G0=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"components",value:function(){return{Hue:Rg,Opacity:ud}}},{key:"template",value:function(){return`
        <div class="control">
            <div target="Hue" ></div>
            <div target="Opacity" ></div>
        </div>
        `}},{key:"refresh",value:function(){this.setColorUI()}},{key:"setColorUI",value:function(){this.Hue.setColorUI(),this.Opacity.setColorUI()}},{key:"@changeColor",value:function(g){k0!=g&&this.refresh()}},{key:"@initColor",value:function(){this.refresh()}}]),E}(nn),Mg=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"template",value:function(){return`
            <div class='colorpicker-body'>
                <div target="palette"></div>
                <div target="control"></div>
            </div>
        `}},{key:"components",value:function(){return{palette:Rc,control:G0}}}]),E}(il),Og=function(R){G(E,R);function E(v){P(this,E);var g=Z(this,(E.__proto__||Object.getPrototypeOf(E)).call(this,v));return g.source="vertical-slider",g}return D(E,[{key:"getMaxDist",value:function(){return this.state.get("$container.height")}},{key:"setMousePosition",value:function(g){this.refs.$bar.css({top:g+"px"})}},{key:"getMousePosition",value:function(g){return to.pos(g).pageY}},{key:"getMinPosition",value:function(){return this.refs.$container.offset().top}},{key:"getCaculatedDist",value:function(g){var A=g?this.getMousePosition(g):this.getCurrent(this.getDefaultValue()/this.maxValue),B=100-this.getDist(A);return B}},{key:"setColorUI",value:function(g){g=g||this.getDefaultValue(),g<=this.minValue?this.refs.$bar.addClass("first").removeClass("last"):g>=this.maxValue?this.refs.$bar.addClass("last").removeClass("first"):this.refs.$bar.removeClass("last").removeClass("first");var A=1-(g||0)/this.maxValue;this.setMousePosition(this.getMaxDist()*A)}}]),E}(Bh),h_=function(R){G(E,R);function E(v){P(this,E);var g=Z(this,(E.__proto__||Object.getPrototypeOf(E)).call(this,v));return g.minValue=0,g.maxValue=360,g.source="vertical-hue-control",g}return D(E,[{key:"template",value:function(){return`
            <div class="hue">
                <div ref="$container" class="hue-container">
                    <div ref="$bar" class="drag-bar"></div>
                </div>
            </div>
        `}},{key:"getDefaultValue",value:function(){return this.$store.hsv.h}},{key:"refreshColorUI",value:function(g){var A=this.getCaculatedDist(g);this.setColorUI(A/100*this.maxValue),this.changeColor({h:A/100*this.maxValue,type:"hsv"})}}]),E}(Og),u_=function(R){G(E,R);function E(v){P(this,E);var g=Z(this,(E.__proto__||Object.getPrototypeOf(E)).call(this,v));return g.source="vertical-opacity-control",g}return D(E,[{key:"template",value:function(){return`
        <div class="opacity">
            <div ref="$container" class="opacity-container">
                <div ref="$colorbar" class="color-bar"></div>
                <div ref="$bar" class="drag-bar2"></div>
            </div>
        </div>
        `}},{key:"refresh",value:function(){U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"refresh",this).call(this),this.setOpacityColorBar()}},{key:"setOpacityColorBar",value:function(){var g=Object.assign({},this.$store.rgb);g.a=0;var A=gi.format(g,"rgb");g.a=1;var B=gi.format(g,"rgb");this.refs.$colorbar.css("background","linear-gradient(to top, "+A+", "+B+")")}},{key:"getDefaultValue",value:function(){return this.$store.alpha}},{key:"refreshColorUI",value:function(g){var A=this.getCaculatedDist(g);this.setColorUI(A/100*this.maxValue),this.changeColor({a:Math.floor(A)/100*this.maxValue})}}]),E}(Og),z0="mini-control",H0=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"components",value:function(){return{Hue:h_,Opacity:u_}}},{key:"template",value:function(){return'<div class="control"><div target="Hue" ></div><div target="Opacity" ></div></div>'}},{key:"refresh",value:function(){this.setColorUI()}},{key:"setColorUI",value:function(){this.Hue.setColorUI(),this.Opacity.setColorUI()}},{key:"@changeColor",value:function(g){z0!=g&&this.refresh()}},{key:"@initColor",value:function(){this.refresh()}}]),E}(nn),Dg=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"template",value:function(){return`
            <div class='colorpicker-body'>
                <div target="palette"></div><div target="control"></div>
            </div>
        `}},{key:"components",value:function(){return{palette:Rc,control:H0}}}]),E}(il),W0="macos-control",X0=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"components",value:function(){return{Value:yg,Opacity:ud}}},{key:"template",value:function(){return`
        <div class="control">
            <div target="Value" ></div>
            <div target="Opacity" ></div>
            <div ref="$controlPattern" class="empty"></div>
            <div ref="$controlColor" class="color"></div>
        </div>
        `}},{key:"setBackgroundColor",value:function(){this.refs.$controlColor.css("background-color",this.$store.dispatch("/toRGB"))}},{key:"refresh",value:function(){this.setColorUI(),this.setBackgroundColor()}},{key:"setColorUI",value:function(){this.Value.setColorUI(),this.Opacity.setColorUI()}},{key:"@changeColor",value:function(g){W0!=g&&this.refresh()}},{key:"@initColor",value:function(){this.refresh()}}]),E}(nn),$0=function(R){G(E,R);function E(v){P(this,E);var g=Z(this,(E.__proto__||Object.getPrototypeOf(E)).call(this,v));return g.width=214,g.height=214,g.thinkness=16,g.half_thinkness=g.thinkness/2,g.source="colorring",g}return D(E,[{key:"template",value:function(){return`
        <div class="wheel" data-type="ring">
            <canvas class="wheel-canvas" ref="$colorwheel" ></canvas>
            <div class="drag-pointer" ref="$drag_pointer"></div>
        </div>
        `}},{key:"setColorUI",value:function(g){this.renderCanvas(),this.setHueColor(null,g)}},{key:"getDefaultValue",value:function(){return this.$store.hsv.h}},{key:"setHueColor",value:function(g,A){if(this.state.get("$el.width")){var B=this.getRectangle(),V=B.minX,$=B.minY,ee=B.radius,fe=B.centerX,pe=B.centerY,Ae=this.getCurrentXY(g,this.getDefaultValue(),ee,fe,pe),we=Ae.x,ct=Ae.y,at=we-fe,ot=ct-pe,Dt=f(at,ot),Ht=this.getCurrentXY(null,Dt,ee-this.half_thinkness,fe,pe),we=Ht.x,ct=Ht.y;this.refs.$drag_pointer.css({left:we-V+"px",top:ct-$+"px"}),A||this.changeColor({type:"hsv",h:Dt})}}}]),E}(Cg),Ng=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"template",value:function(){return`
            <div class='colorpicker-body'>
                <div target="colorring"></div>
                <div target="palette"></div> 
                <div target="control"></div>
                <div target="information"></div>
                <div target="currentColorSets"></div>
                <div target="colorSetsChooser"></div>
                <div target="contextMenu"></div>
            </div>
        `}},{key:"components",value:function(){return{colorring:$0,palette:Rc,control:X0,information:fd,currentColorSets:pd,colorSetsChooser:_d,contextMenu:md}}}]),E}(il),Y0=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"components",value:function(){return{Hue:h_,Opacity:u_}}},{key:"template",value:function(){return`
        <div class="control">
            <div target="Hue" ></div>
            <div target="Opacity" ></div>
        </div>
        `}},{key:"refresh",value:function(){this.setColorUI()}},{key:"setColorUI",value:function(){this.Hue.setColorUI(),this.Opacity.setColorUI()}},{key:"@changeColor",value:function(){this.refresh()}},{key:"@initColor",value:function(){this.refresh()}}]),E}(nn),j0=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"template",value:function(){return`
            <div class='colorpicker-body'>
                <div target="palette"></div> 
                <div target="control"></div>
                <div target="information"></div>
                <div target="currentColorSets"></div>
                <div target="colorSetsChooser"></div>
                <div target="contextMenu"></div>
            </div>
        `}},{key:"components",value:function(){return{palette:Rc,control:Y0,information:fd,currentColorSets:pd,colorSetsChooser:_d,contextMenu:md}}}]),E}(il),K0="mini-control",q0=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"components",value:function(){return{Hue:h_,Opacity:u_}}},{key:"template",value:function(){return`
            <div class="control">
                <div target="Opacity" ></div>            
                <div target="Hue" ></div>
            </div>
        `}},{key:"refresh",value:function(){this.setColorUI()}},{key:"setColorUI",value:function(){this.Hue.setColorUI(),this.Opacity.setColorUI()}},{key:"@changeColor",value:function(g){K0!=g&&this.refresh()}},{key:"@initColor",value:function(){this.refresh()}}]),E}(nn),wg=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"template",value:function(){return`
            <div class='colorpicker-body'>
                <div class='color-view'>
                    <div class='color-view-container'  ref="$colorview"></div>
                </div>
                <div class='color-tool'>
                    <div target="palette"></div>
                    <div target="control"></div>
                </div>
            </div>
        `}},{key:"components",value:function(){return{palette:Rc,control:q0}}},{key:"initColorWithoutChangeEvent",value:function(g){this.$store.dispatch("/initColor",g),this.refresh()}},{key:"setBackgroundColor",value:function(){var g=this.$store.dispatch("/toColor"),A=this.$store.rgb,B=gi.brightness(A.r,A.g,A.b);this.refs.$colorview.css({"background-color":g,color:B>127?"black":"white"}),this.refs.$colorview.html(g)}},{key:"click $colorview",value:function(g){this.nextFormat()}},{key:"nextFormat",value:function(){var g=this.$store.format||"hex",A="hex";g=="hex"?A="rgb":g=="rgb"?A="hsl":g=="hsl"&&(A="hex"),this.$store.dispatch("/changeFormat",A),this.$store.emit("lastUpdateColor"),this.refresh()}},{key:"refresh",value:function(){this.setBackgroundColor()}},{key:"@changeColor",value:function(){this.refresh()}},{key:"@initColor",value:function(){this.refresh()}}]),E}(il),Fg={create:function(E){switch(E.type){case"macos":return new Ag(E);case"xd":return new j0(E);case"ring":return new Ng(E);case"mini":return new Mg(E);case"vscode":return new wg(E);case"mini-vertical":return new Dg(E);case"sketch":case"palette":default:return new c_(E)}},ColorPicker:c_,ChromeDevToolColorPicker:c_,MacOSColorPicker:Ag,RingColorPicker:Ng,MiniColorPicker:Mg,VSCodePicker:wg,MiniVerticalColorPicker:Dg},Q0=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"afterRender",value:function(){var g=this,A=this.opt,B=A.opt.colorpickerOptions||{type:"sketch"};this.colorPicker=Fg.create(L({position:"inline",container:this.refs.$el.el,onChange:function($){g.changeColor($)},onLastUpdate:function($){g.changeColor($,!0)}},B))}},{key:"template",value:function(){return'<div ref="$color"></div>'}},{key:"changeColor",value:function(g){var A=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.$store.emit("changeEmbedColorPicker",g,A)}},{key:"setValue",value:function(g){this.colorPicker.initColorWithoutChangeEvent(g)}}]),E}(nn);function Lg(R){var E=[];return R.layers.length&&R.layers.forEach(function(v){E.push.apply(E,ne(Lg(v)))}),E.push(R),E}var Bg=function(){function R(){var E=this,v=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return P(this,R),v instanceof R&&(v=v.toJSON()),this.json=this.convert(L({},this.getDefaultObject(),v)),this.ref=new Proxy(this,{get:function(A,B){var V=A[B];return yc(V)?function(){for(var $=arguments.length,ee=Array($),fe=0;fe<$;fe++)ee[fe]=arguments[fe];return V.apply(A,ee)}:V||A.json[B]},set:function(A,B,V){if(V&&V.realVal&&yc(V.realVal)&&(V=V.realVal()),E.checkField(B,V))A.json[B]=V;else throw new Error(V+" is invalid as "+B+" property value.");return!0}}),this.ref}return D(R,[{key:"getDefaultTitle",value:function(){return"Item"}},{key:"isAttribute",value:function(){return!1}},{key:"is",value:function(){if(!this.json)return!1;for(var v=arguments.length,g=Array(v),A=0;A<v;A++)g[A]=arguments[A];return g.indexOf(this.json.itemType)>-1}},{key:"convert",value:function(v){return v}},{key:"checkField",value:function(v,g){return!0}},{key:"toCloneObject",value:function(){var v={itemType:this.json.itemType,type:this.json.type,selected:this.json.selected};return v}},{key:"clone",value:function(){var v=this.constructor,g=new v(this.toCloneObject());return g.parent=this.json.parent,g}},{key:"reset",value:function(v){v instanceof R&&(v=v.toJSON()),this.json=this.convert(L({},this.json,v))}},{key:"getDefaultObject",value:function(){var v=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return L({selected:!1,type:"",itemType:""},v)}},{key:"add",value:function(v){return this.json.layers.push(v),v.parent=this.ref,v}},{key:"toggle",value:function(v,g){Oa(g)?this.json[v]=!this.json[v]:this.json[v]=!!g}},{key:"toJSON",value:function(){return this.json}},{key:"resize",value:function(){}},{key:"copy",value:function(){this.json.parent.copyItem(this.ref)}},{key:"copyItem",value:function(v){var g=v.clone();g.width.add(10),g.width.add(10);for(var A=this.json.layers,B=-1,V=0,$=A.length;V<$;V++)if(A[V]===v){B=V;break}B>-1&&this.json.layers.splice(B,0,g)}},{key:"remove",value:function(){this.json.parent.removeItem(this.ref)}},{key:"removeItem",value:function(v){for(var g=this.json.layers,A=-1,B=0,V=g.length;B<V;B++)if(g[B]===v){A=B;break}A>-1&&this.json.layers.splice(A,1)}},{key:"title",get:function(){return this.json.name||this.getDefaultTitle()}},{key:"id",get:function(){return this.json.id}},{key:"layers",get:function(){return this.json.layers}},{key:"parent",get:function(){return this.json.parent}},{key:"html",get:function(){var v=this.json,g=v.elementType,A=v.id,B=v.layers,V=v.itemType,$=g||"div";return`
    <`+$+" class='element-item "+V+`' data-id="`+A+`">
      `+B.map(function(ee){return ee.html}).join("")+`
    </`+$+`>
    `}},{key:"allLayers",get:function(){return[].concat(ne(Lg(this.ref)))}}]),R}(),Z0=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"getDefaultObject",value:function(){var g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"getDefaultObject",this).call(this,L({itemType:"image-resource",type:"image"},g))}},{key:"isGradient",value:function(){return!1}},{key:"isLinear",value:function(){return!1}},{key:"isRadial",value:function(){return!1}},{key:"isConic",value:function(){return!1}},{key:"isStatic",value:function(){return!1}},{key:"isImage",value:function(){return!1}},{key:"hasAngle",value:function(){return!1}},{key:"isUrl",value:function(){return!1}},{key:"isFile",value:function(){return!1}},{key:"isAttribute",value:function(){return!0}},{key:"toString",value:function(){return"none"}}]),E}(Bg),Ug={center:50,top:0,left:0,right:100,bottom:100},pn=function R(){P(this,R)};pn.CENTER="center",pn.TOP="top",pn.RIGHT="right",pn.LEFT="left",pn.BOTTOM="bottom";var J0=/([\d.]+)(px|pt|fr|r?em|deg|vh|vw|m?s|%|g?rad|turn)/gi,jt=function(){function R(){var E=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"",v=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";P(this,R),this.value=E,this.unit=v}return D(R,[{key:Symbol.toPrimitive,value:function(v){return v=="number"?this.value:this.toString()}},{key:"toString",value:function(){switch(this.unit){case"string":case"number":return this.value+"";case"var":return"var(--"+this.value+")";case"calc":return"calc("+this.value+")";default:return this.value+this.unit}}},{key:"isUnitType",value:function(v){return this.unit===v}},{key:"isCalc",value:function(){return this.isUnitType("calc")}},{key:"isFr",value:function(){return this.isUnitType("fr")}},{key:"isPercent",value:function(){return this.isUnitType("%")}},{key:"isPx",value:function(){return this.isUnitType("px")}},{key:"isEm",value:function(){return this.isUnitType("em")}},{key:"isDeg",value:function(){return this.isUnitType("deg")}},{key:"isSecond",value:function(){return this.isUnitType("s")}},{key:"isMs",value:function(){return this.isUnitType("ms")}},{key:"isNumber",value:function(){return this.isUnitType("number")}},{key:"isString",value:function(){return this.isUnitType("")}},{key:"isVar",value:function(){return this.isUnitType("--")}},{key:"set",value:function(v){return this.value=v,this}},{key:"add",value:function(v){return this.value+=+v,this}},{key:"sub",value:function(v){return this.add(-1*v)}},{key:"mul",value:function(v){return this.value*=+v,this}},{key:"div",value:function(v){return this.value/=+v,this}},{key:"mod",value:function(v){return this.value%=+v,this}},{key:"clone",value:function(){return new R(this.value,this.unit)}},{key:"getUnitName",value:function(){return this.unit==="%"?"percent":this.unit}},{key:"toJSON",value:function(){return{value:this.value,unit:this.unit}}},{key:"rate",value:function(v){return v/this.value}},{key:"stringToPercent",value:function(){return cs(Ug[this.value])?R.percent(Ug[this.value]):R.percent(0)}},{key:"stringToEm",value:function(v){return this.stringToPercent().toEm(v)}},{key:"stringToPx",value:function(v){return this.stringToPercent().toPx(v)}},{key:"toPercent",value:function(v){var g=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16;if(this.isPercent())return this;if(this.isPx())return R.percent(this.value*100/v);if(this.isEm())return R.percent(this.value*g*100/v);if(this.isString())return this.stringToPercent(v);if(this.isDeg())return R.percent(this.value/360*100)}},{key:"toEm",value:function(v){var g=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16;if(this.isPercent())return R.em(this.value/100*v/g);if(this.isPx())return R.em(this.value/g);if(this.isEm())return this;if(this.isString())return this.stringToEm(v)}},{key:"toPx",value:function(v){if(this.isPercent())return R.px(this.value/100*v);if(this.isPx())return this;if(this.isEm())return R.px(this.value/100*v/16);if(this.isString())return this.stringToPx(v)}},{key:"toSecond",value:function(){if(this.isSecond())return this;if(this.isMs())return R.second(this.value/1e3)}},{key:"toMs",value:function(){if(this.isSecond())return R.ms(this.value*1e3);if(this.isMs())return this}},{key:"to",value:function(v,g){var A=arguments.length>2&&arguments[2]!==void 0?arguments[2]:16;if(v==="px")return this.toPx(g,A);if(v==="%"||v==="percent")return this.toPercent(g,A);if(v==="em")return this.toEm(g,A)}},{key:"toUnit",value:function(v){return new R(this.value,v)}},{key:"calculate",value:function(v,g){var A=this[v];return A?A.call(this,g):this}},{key:"includes",value:function(){for(var v=arguments.length,g=Array(v),A=0;A<v;A++)g[A]=arguments[A];return g.includes(this.value)}},{key:"round",value:function(v){return new R(a(this.value,v),this.unit)}},{key:"equals",value:function(v){return this.value===v.value&&this.unit===v.unit}}],[{key:"min",value:function(){for(var v=arguments.length,g=Array(v),A=0;A<v;A++)g[A]=arguments[A];for(var B=g.shift(),V=0,$=g.length;V<$;V++)B.value>g[V].value&&(B=g[V]);return B}},{key:"max",value:function(){for(var v=arguments.length,g=Array(v),A=0;A<v;A++)g[A]=arguments[A];for(var B=g.shift(),V=0,$=g.length;V<$;V++)B.value<g[V].value&&(B=g[V]);return B}},{key:"string",value:function(v){return new R(v+"","")}},{key:"number",value:function(v){return new R(+v,"number")}},{key:"px",value:function(v){return new R(+v,"px")}},{key:"em",value:function(v){return new R(+v,"em")}},{key:"percent",value:function(v){return new R(+v,"%")}},{key:"deg",value:function(v){return new R(+v,"deg")}},{key:"fr",value:function(v){return new R(+v,"fr")}},{key:"second",value:function(v){return new R(+v,"s")}},{key:"ms",value:function(v){return new R(+v,"ms")}},{key:"var",value:function(v){return new R(v+"","--")}},{key:"calc",value:function(v){return new R(v,"calc")}},{key:"parse",value:function(v){if(Po(v)){if(v.indexOf("calc(")>-1)return new R(v.split("calc(")[1].split(")")[0],"calc");var g=v.replace(J0,"$1 $2").split(" ").filter(Boolean),A=+g[0]==g[0];return A?new R(+g[0],g[1]):new R(g[0])}if(v instanceof R)return v;if(v.unit){if(v.unit=="%"||v.unit=="percent"){var B=0;return cs(v.percent)?B=v.percent:cs(v.value)&&(B=v.value),R.percent(B)}else if(v.unit=="px"){var B=0;return cs(v.px)?B=v.px:cs(v.value)&&(B=v.value),R.px(B)}else if(v.unit=="em"){var B=0;return cs(v.em)?B=v.em:cs(v.value)&&(B=v.value),R.em(B)}else if(v.unit=="deg"){var B=0;return cs(v.deg)?B=v.deg:cs(v.value)&&(B=v.value),R.deg(B)}else if(v.unit=="s"){var B=0;return cs(v.second)?B=v.second:cs(v.value)&&(B=v.value),R.second(B)}else if(v.unit=="ms"){var B=0;return cs(v.ms)?B=v.ms:cs(v.value)&&(B=v.value),R.ms(B)}else if(v.unit=="number"){var B=0;return cs(v.value)&&(B=v.value),R.number(B)}else if(v.unit=="--"){var B=0;return cs(v.value)&&(B=v.value),R.var(B)}else if(v.unit===""||v.unit==="string"){var B="";return cs(v.str)?B=v.str:cs(v.value)&&(B=v.value),R.string(B)}}return R.string(v)}}]),R}();jt.auto=jt.string("auto");var io=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"getDefaultObject",value:function(){return U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"getDefaultObject",this).call(this,{cut:!1,percent:0,unit:"%",px:0,em:0,color:"rgba(0, 0, 0, 0)",prevColorStep:null})}},{key:"toCloneObject",value:function(){return L({},U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"toCloneObject",this).call(this),{cut:this.json.cut,percent:this.json.percent,unit:this.json.unit,px:this.json.px,em:this.json.em,color:this.json.color})}},{key:"on",value:function(){this.json.cut=!0}},{key:"off",value:function(){this.json.cut=!1}},{key:"toggle",value:function(){this.json.cut=!this.json.cut}},{key:"getUnit",value:function(){return this.json.unit=="%"?"percent":this.json.unit}},{key:"add",value:function(g){var A=this.getUnit();return this.json[A]+=+g,this}},{key:"sub",value:function(g){var A=this.getUnit();return this.json[A]-=+g,this}},{key:"mul",value:function(g){var A=this.getUnit();return this.json[A]*=+g,this}},{key:"div",value:function(g){var A=this.getUnit();return this.json[A]/=+g,this}},{key:"mod",value:function(g){var A=this.getUnit();return this.json[A]%=+g,this}},{key:"toLength",value:function(g){return jt.parse(this.json).round(1e3)}},{key:"getPrevLength",value:function(){return this.json.prevColorStep?this.json.prevColorStep.toLength():""}},{key:"toString",value:function(){var g=this.json.cut?this.getPrevLength():"";return this.json.color+" "+g+" "+this.toLength()}},{key:"reset",value:function(g){U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"reset",this).call(this,g),this.parent()&&this.parent().sortColorStep()}},{key:"isPx",get:function(){return this.json.unit=="px"}},{key:"isPercent",get:function(){return this.json.unit=="%"||this.json.unit==="percent"}},{key:"isEm",get:function(){return this.json.unit=="em"}}],[{key:"parse",value:function(g){var A=[],B=de(g),V=B.str.split(" ").filter(function(Ae){return Ae.trim()}),$=+V[0].replace("@",""),ee=B.matches[$].color;if(V.length===1)A.push(new E({color:ee,unit:"%",percent:0}));else if(V.length===2){var fe=jt.parse(V[1]),pe={unit:fe.unit};fe.isPercent()?pe.percent=fe.value:fe.isPx()?pe.px=fe.value:fe.isEm()&&(pe.em=fe.value),A.push(new E(L({color:ee},pe)))}else V.length===3&&[1,2].forEach(function(Ae){var we=jt.parse(V[Ae]),ct={unit:we.unit};we.isPercent()?ct.percent=we.value:we.isPx()?ct.px=we.value:we.isEm()&&(ct.em=we.value),A.push(new E(L({color:ee},ct)))});return A}}]),E}(Bg),Vg={"to top":0,"to top right":45,"to right":90,"to bottom right":135,"to bottom":180,"to bottom left":225,"to left":270,"to top left":315},gd=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"isGradient",value:function(){return!0}},{key:"toString",value:function(){return"none"}},{key:"getDefaultObject",value:function(){var g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"getDefaultObject",this).call(this,L({type:"gradient",colorsteps:[]},g))}},{key:"toCloneObject",value:function(){return L({},U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"toCloneObject",this).call(this),{colorsteps:this.json.colorsteps.map(function(g){return g.clone()})})}},{key:"convert",value:function(g){return g.colorsteps=g.colorsteps.map(function(A){return new io(A)}),g}},{key:"calculateAngle",value:function(){var g=this.json.angle;return Oa(Vg[g])?g:Vg[g]||0}},{key:"addColorStep",value:function(g){var A=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return this.json.colorsteps.push(g),A&&this.sortColorStep(),g}},{key:"insertColorStep",value:function(g){var A=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"rgba(216,216,216,0)",B=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"rgba(216,216,216,1)",V=this.colorsteps;if(!V.length){this.addColorStepList([new io({color:A,percent:g,index:0}),new io({color:B,percent:100,index:100})]);return}if(g<V[0].percent){V[0].index=1,this.addColorStep(new io({index:0,color:V[0].color,percent:g}));return}var $=V.length-1;if(V[$].percent<g){var ee=V[$].color,fe=V[$].index+1;this.addColorStep(new io({index:fe,color:ee,percent:g}));return}for(var pe=0,Ae=V.length-1;pe<Ae;pe++){var we=V[pe],ct=V[pe+1];if(we.percent<=g&&g<=ct.percent){var ee=Color.mix(we.color,ct.color,(g-we.percent)/(ct.percent-we.percent),"rgb");this.addColorStep(new io({index:we.index+1,color:ee,percent:g}));return}}}},{key:"sortColorStep",value:function(){var g=this.colorsteps;g.sort(function(A,B){if(A.percent>B.percent)return 1;if(A.percent<B.percent)return-1;if(A.percent==B.percent)return A.index===B.index?0:A.index>B.index?1:-1}),g.forEach(function(A,B){A.index=B*100})}},{key:"addColorStepList",value:function(){var g=this,A=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];A.forEach(function(B){g.addColorStep(B,!1)}),this.sortColorStep()}},{key:"getColorStep",value:function(g){return this.json.colorsteps.filter(function(A){return A.id==g})[0]}},{key:"clear",value:function(){arguments.length?this.json.colorsteps.splice(+(arguments.length<=0?void 0:arguments[0]),1):this.json.colorsteps=[]}},{key:"getColorString",value:function(){var g=this.colorsteps;if(!g.length)return"";var A=g.map(function(B,V){return B.prevColorStep=B.cut&&V>0?g[V-1]:null,B});return A.map(function(B){return""+B}).join(",")}},{key:"colorsteps",get:function(){return this.json.colorsteps}}],[{key:"random",value:function(){var g=Math.floor(Math.random()*1e3)%360;return"linear-gradient("+g+"deg, "+Color.random()+" 0%, "+Color.random()+" 100%)"}}]),E}(Z0),eb=["circle","circle closest-side","circle closest-corner","circle farthest-side","circle farthest-corner","ellipse","ellipse closest-side","ellipse closest-corner","ellipse farthest-side","ellipse farthest-corner"],tb=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"initialize",value:function(){U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"initialize",this).call(this);var g=[{offset:jt.percent(0),cut:!1,color:"yellow"},{offset:jt.percent(100),cut:!1,color:"red"}];this.type="linear-gradient",this.index=0,this.colorsteps=g,this.radialPosition=[jt.percent(50),jt.percent(50)],this.radialType="ellipse"}},{key:"@changeRadialPosition",value:function(g,A){this["@changeKeyValue"]("radialPosition",[g,A]),this.reloadInputValue()}},{key:"@setGradientEditor",value:function(g){var A=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,B=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"linear-gradient",V=arguments[3],$=arguments[4],ee=arguments[5],fe=de(g),pe=fe.str.split(",").map(function(Ae){return Ae.trim()}).map(function(Ae){var we=Ae.split(" ").filter(function(Vi){return Vi.length}),ct=he(we,3),at=ct[0],ot=ct[1],Dt=ct[2];at=se(at,fe.matches);var Ht=!1;Dt&&(Ht=!0);var bi=Ht?jt.parse(Dt):jt.parse(ot);return bi.isDeg()&&(bi=jt.percent(bi.value/360*100)),{color:at,offset:bi,cut:Ht}});pe.length==1&&pe.push({color:pe[0].color,offset:jt.percent(100),cut:!1}),this.cachedStepListRect=null,this.colorsteps=pe,this.index=A,this.type=B,this.angle=jt.parse(V||"90deg"),this.radialPosition=$||[jt.percent(50),jt.percent(50)],this.radialType=ee,this.refresh(),this.selectStep(A),this.reloadInputValue()}},{key:"template",value:function(){var g=this;return`
        <div class='gradient-editor' data-selected-editor='`+this.type+`'>
            <div class='gradient-steps' data-editor='gradient'>
                <div class="hue-container" ref="$back"></div>            
                <div class="hue" ref="$steps">
                    <div class='step-list' ref="$stepList" ></div>
                </div>
            </div>
            <div class='tools' data-editor='tools'>
              <label>Offset <input type='checkbox' ref='$cut' checked />  connected</label> <div class="right-menu" ><button type="button" ref="$remove" style="float:right;" title="Remove color stop">&times; Remove</button></div>
              <div class='unit'>
                <div><input type='range' data-key='length' min='0' max="100" step='0.1' ref='$offset' /></div>
                <div><input type='number' data-key='length' min='0' max="100" step='0.1' ref='$offsetNumber' /></div>              
                <div><select ref='$offsetSelect'>
                  <option value='%'>%</option>
                  <option value='px'>px</option>
                  <option value='em'>em</option>
                </select></div>
              </div>
            </div>
            <div class='sub-editor' ref='$subEditor'> 
              <div data-editor='angle'>
                <label>Angle</label>
                <div class='unit'>                
                  <div><input type='range' data-key='angle' min='-720' max="720" step='0.1' ref='$angle' /> </div>
                  <div><input type='number' data-key='angle' min='-720' max="720" step='0.1' ref='$angleNumber' /></div> 
                  <span>deg</span>
                </div>
              </div>
              <div data-editor='centerX'>
                <label>Center X</label>
                <div class='unit'>
                  <div><input type='range' data-key='centerX' min='-100' max="100" step='0.1' ref='$centerX' /></div>
                  <div><input type='number' data-key='centerX' min='-100' max="100" step='0.1' ref='$centerXNumber' /></div>
                  <div><select ref='$centerXSelect'>
                      <option value='%'>%</option>
                      <option value='px'>px</option>
                      <option value='em'>em</option>
                    </select></div>
                </div>
              </div>                
              <div data-editor='centerY'>           
                <label>Center Y</label>                 
                <div class='unit'>
                  <div><input type='range' data-key='centerY' min='-100' max="100" step='0.1' ref='$centerY' /></div>
                  <div><input type='number' data-key='centerX' min='-100' max="100" step='0.1' ref='$centerYNumber' /></div>
                  <div><select ref='$centerYSelect'>
                      <option value='%'>%</option>
                      <option value='px'>px</option>
                      <option value='em'>em</option>
                    </select></div>
                </div>
              </div>                
              <div data-editor='radialType'>       
                <label>Radial Type</label>              
                <div><select ref='$radialType'>
                  `+eb.map(function(A){var B=g.radialType===A?"selected":"";return'<option value="'+A+'" '+B+">"+A+"</option>"}).join("")+`
                </select></div>
              </div>
            </div>            
        </div>
      `}},{key:"input $offset",value:function(g){this.refs.$offsetNumber.val(this.refs.$offset.val()),this["@changeColorStepOffset"]("offset",new jt(this.refs.$offset.val(),this.refs.$offsetSelect.val()))}},{key:"mouseup $offset",value:function(g){this["@changeColorStepOffset"]("offset",new jt(this.refs.$offset.val(),this.refs.$offsetSelect.val()),!0)}},{key:"input $offsetNumber",value:function(g){this.refs.$offset.val(this.refs.$offsetNumber.val()),this["@changeColorStepOffset"]("offset",new jt(this.refs.$offset.val(),this.refs.$offsetSelect.val()),!0)}},{key:"input $angle",value:function(g){this.refs.$angleNumber.val(this.refs.$angle.val()),this["@changeKeyValue"]("angle",jt.deg(this.refs.$angle.val()))}},{key:"mouseup $angle",value:function(g){this["@changeKeyValue"]("angle",jt.deg(this.refs.$angle.val()),!0)}},{key:"input $angleNumber",value:function(g){this.refs.$angle.val(this.refs.$angleNumber.val()),this["@changeKeyValue"]("angle",jt.deg(this.refs.$angle.val()),!0)}},{key:"input $centerX",value:function(g){this.refs.$centerXNumber.val(this.refs.$centerX.val()),this["@changeKeyValue"]("radialPositionX")}},{key:"mouseup $centerX",value:function(g){this["@changeKeyValue"]("radialPositionX",null,!0)}},{key:"input $centerXNumber",value:function(g){this.refs.$centerX.val(this.refs.$centerXNumber.val()),this["@changeKeyValue"]("radialPositionX")}},{key:"input $centerY",value:function(g){this.refs.$centerYNumber.val(this.refs.$centerY.val()),this["@changeKeyValue"]("radialPositionY")}},{key:"mouseup $centerY",value:function(g){this["@changeKeyValue"]("radialPositionY",null,!0)}},{key:"input $centerYNumber",value:function(g){this.refs.$centerY.val(this.refs.$centerYNumber.val()),this["@changeKeyValue"]("radialPositionX")}},{key:"change $centerXSelect",value:function(g){this["@changeKeyValue"]("radialPositionX",null,!0)}},{key:"change $centerYSelect",value:function(g){this["@changeKeyValue"]("radialPositionY",null,!0)}},{key:"change $radialType",value:function(g){this["@changeKeyValue"]("radialType",this.refs.$radialType.val(),!0)}},{key:"@changeKeyValue",value:function(g,A){var B=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;g==="angle"&&(A=A.value),g==="radialPositionX"||g==="radialPositionY"?this.radialPosition=[this.radialPositionX,this.radialPositionY]:this[g]=A,this.updateData(B)}},{key:"@changeColorStepOffset",value:function(g,A){var B=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;this.currentStep&&(this.currentStep.offset=A.clone(),this.$currentStep.css({left:this.currentStep.offset}),this.setColorUI(),this.updateData(B))}},{key:"click $back",value:function(g){if(!this.startXY){var A=this.refs.$stepList.rect(),B=A.x,V=A.right,$=g.xy.x;$<B?$=B:$>V&&($=V);var ee=($-B)/A.width*100,fe=this.colorsteps.map(function(ot,Dt){return{index:Dt,color:ot.color,offset:ot.offset}}),pe=fe.filter(function(ot){return ot.offset.value<=ee}).pop(),Ae=fe.filter(function(ot){return ot.offset.value>ee}).shift(),we=0;if(pe&&Ae){if(pe.offset.value===ee)return;this.colorsteps.splice(Ae.index,0,{cut:!1,offset:jt.percent(ee),color:gi.mix(pe.color,Ae.color,(ee-pe.offset.value)/(Ae.offset.value-pe.offset.value))}),we=pe.index+1}else if(pe){var ct={cut:!1,offset:jt.percent(ee),color:pe.color};this.colorsteps.length-1===pe.index?this.colorsteps.push(ct):this.colorsteps.splice(pe.index+1,0,ct),we=pe.index+1}else if(Ae){var at={cut:!1,offset:jt.percent(ee),color:Ae.color};Ae.index===0?(this.colorsteps.unshift(at),we=0):(this.colorsteps.splice(Ae.index-1,0,at),we=Ae.index)}else this.colorsteps.push({cut:!1,offset:jt.percent(0),color:"rgba(0, 0, 0, 1)"}),we=0;this.refresh(),this.updateData(!0),this.selectStep(we)}}},{key:"reloadStepList",value:function(){this.refs.$stepList.html(this.colorsteps.map(function(g,A){return"<div class='step' data-index='"+A+"' data-cut='"+g.cut+"' style='left: "+g.offset+`;'>
        <div class='color-view' style="background-color: `+g.color+`"></div>
        <div class='arrow' style="background-color: `+g.color+`"></div>
      </div>`}).join(""))}},{key:"click $cut",value:function(){this.currentStep&&(this.currentStep.cut=this.refs.$cut.checked(),this.$currentStep.attr("data-cut",this.currentStep.cut),this.setColorUI(),this.updateData(!0))}},{key:"click $remove",value:function(){this.removeStep(this.index)}},{key:"removeStep",value:function(g){this.colorsteps.splice(g,1);var A=this.colorsteps[g],B=g;A||(A=this.colorsteps[g-1],B=g-1),A&&this.selectStep(B),this.refresh(),this.updateData(!0)}},{key:"selectStep",value:function(g){this.index=g,this.currentStep=this.colorsteps[g],this.refs.$stepList.attr("data-selected-index",g),this.$currentStep=this.refs.$stepList.$('[data-index="'+g.toString()+'"]'),this.$currentStep&&(this.$colorView=this.$currentStep.$(".color-view"),this.$arrow=this.$currentStep.$(".arrow"),this.refs.$cut.el.checked=this.currentStep.cut),this.prev=this.colorsteps[g-1],this.next=this.colorsteps[g+1]}},{key:"mousedown $stepList .step",value:function(g){var A=+g.$delegateTarget.attr("data-index");g.altKey?this.removeStep(A):(this.selectStep(A),this.startXY=g.xy,this.$store.emit("selectColorStep",this.currentStep.color),this.refs.$cut.checked(this.currentStep.cut),this.refs.$offset.val(this.currentStep.offset.value),this.refs.$stepList.attr("data-selected-index",A),this.cachedStepListRect=this.refs.$stepList.rect())}},{key:"getStepListRect",value:function(){return this.cachedStepListRect}},{key:"mouseup document",value:function(g){this.startXY&&(this.startXY=null,this.updateData(!0))}},{key:"mousemove document",value:function(g){if(this.startXY){var A=g.xy.x-this.startXY.x;g.xy.y-this.startXY.y;var B=this.getStepListRect(),V=B.x,$=B.right,ee=this.startXY.x+A;ee<V?ee=V:ee>$&&(ee=$);var fe=(ee-V)/B.width*100;this.prev&&this.prev.offset.value>fe&&(fe=this.prev.offset.value),this.next&&this.next.offset.value<fe&&(fe=this.next.offset.value),this.currentStep.offset.set(a(fe,100)),this.$currentStep.css({left:jt.percent(fe)}),this.refs.$offset.val(this.currentStep.offset.value),this.setColorUI(),this.updateData()}}},{key:"refresh",value:function(){this.reloadStepList(),this.setColorUI()}},{key:"getLinearGradient",value:function(){var g=this;if(this.colorsteps.length===0)return"";if(this.colorsteps.length===1){var A=this.colorsteps[0];return"linear-gradient(to right, "+A.color+" "+A.offset+", "+A.color+" 100%)"}return"linear-gradient(to right, "+this.colorsteps.map(function(B,V){if(B.cut){var $=g.colorsteps[V-1];return $?B.color+" "+$.offset+" "+B.offset:B.color+" "+B.offset}else return B.color+" "+B.offset}).join(",")+")"}},{key:"setColorUI",value:function(){this.refs.$stepList.css("background-image",this.getLinearGradient()),this.refs.$el.attr("data-selected-editor",this.type)}},{key:"reloadInputValue",value:function(){this.refs.$offset.val(this.currentStep.offset.value),this.refs.$offsetNumber.val(this.currentStep.offset.value),this.refs.$offsetSelect.val(this.currentStep.offset.unit),this.refs.$angle.val(this.angle.value),this.refs.$angleNumber.val(this.angle.value);var g=this.radialPosition.map(function(A){return A==="center"?jt.percent(50):A});this.refs.$centerX.val(g[0].value),this.refs.$centerXNumber.val(g[0].value),this.refs.$centerXSelect.val(g[0].unit),this.refs.$centerY.val(g[1].value),this.refs.$centerYNumber.val(g[1].value),this.refs.$centerYSelect.val(g[1].unit),this.refs.$radialType.val(this.radialType)}},{key:"@setColorStepColor",value:function(g){var A=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.currentStep&&(this.currentStep.color=g,this.$colorView.css({"background-color":g}),this.$arrow.css({"background-color":g}),this.setColorUI(),this.updateData(A))}},{key:"updateData",value:function(){var g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;this.$store.emit("changeGradientEditor",{type:this.type,index:this.index,angle:this.angle,colorsteps:this.colorsteps,radialPosition:this.radialPosition,radialType:this.radialType},g)}},{key:"radialPositionX",get:function(){return new jt(+this.refs.$centerX.val(),this.refs.$centerXSelect.val()).round(1e3)}},{key:"radialPositionY",get:function(){return new jt(+this.refs.$centerY.val(),this.refs.$centerYSelect.val()).round(1e3)}}]),E}(nn),ib={0:"to top",45:"to top right",90:"to right",135:"to bottom right",180:"to bottom",225:"to bottom left",270:"to left",315:"to top left"},kg={"to top":"0","to top right":"45","to right":"90","to bottom right":"135","to bottom":"180","to bottom left":"225","to left":"270","to top left":"315"},vd=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"getDefaultObject",value:function(){var g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"getDefaultObject",this).call(this,L({type:"linear-gradient",angle:0},g))}},{key:"toCloneObject",value:function(){return L({},U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"toCloneObject",this).call(this),{angle:this.json.angle})}},{key:"isLinear",value:function(){return!0}},{key:"hasAngle",value:function(){return!0}},{key:"toString",value:function(){if(this.colorsteps.length===0)return"";var g=this.getColorString(),A="",B=this.json.angle||0;A=B,Cc(A)&&(A=ib[""+A]||A),Cc(A)&&(A=A>360?A%360:A,A=A+"deg");var V=this.json.type+"("+A+", "+g+")";return V}}],[{key:"toLinearGradient",value:function(g){if(g.length===0)return"none";var A=new E({angle:"to right",colorsteps:g});return A+""}},{key:"parse",value:function(g){var A=de(g),B=0,V=[];return A.str.split("(")[1].split(")")[0].split(",").map(function($){return $.trim()}).forEach(function($,ee){$.includes("@")?($=se($,A.matches),V.push.apply(V,ne(io.parse($)))):B=Oa(kg[$])?jt.parse($):jt.deg(+kg[$])}),new E({angle:B,colorsteps:V})}}]),E}(gd),Gg=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"getDefaultObject",value:function(){return U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"getDefaultObject",this).call(this,{type:"repeating-linear-gradient",angle:0})}}],[{key:"parse",value:function(g){var A=vd.parse(g);return new E({angle:A.angle,colorsteps:A.colorsteps})}}]),E}(vd),Yl,rb=(Yl={},w(Yl,"center",!0),w(Yl,"top",!0),w(Yl,"left",!0),w(Yl,"right",!0),w(Yl,"bottom",!0),Yl),xd=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"getDefaultObject",value:function(){var g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"getDefaultObject",this).call(this,L({type:"radial-gradient",radialType:"ellipse",radialPosition:[pn.CENTER,pn.CENTER]},g))}},{key:"toCloneObject",value:function(){var g=this.json.radialPosition||[jt.percent(50),jt.percent(50)];return L({},U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"toCloneObject",this).call(this),{radialType:this.json.radialType||"ellipse",radialPosition:JSON.parse(JSON.stringify(g))})}},{key:"isRadial",value:function(){return!0}},{key:"toString",value:function(){if(this.colorsteps.length===0)return"";var g=this.getColorString(),A=this.json,B="",V=A.radialType,$=A.radialPosition||["center","center"];return rb[$]||typeof $=="string"||($=$.map(function(ee){return typeof ee=="string"?ee:ee.isString()?ee.value:ee.round(1e3)}).join(" ")),B=$?V+" at "+$:V,(A.type||"radial-gradient")+"("+B+", "+g+")"}}],[{key:"parse",value:function(g){var A=de(g),B="ellipse",V=[pn.CENTER,pn.CENTER],$=[];return A.str.split("(")[1].split(")")[0].split(",").map(function(ee){return ee.trim()}).forEach(function(ee,fe){if(ee.includes("@"))ee=se(ee,A.matches),$.push.apply($,ne(io.parse(ee)));else{if(ee.includes("at")){var pe=ee.split("at").map(function(at){return at.trim()}),Ae=he(pe,2);B=Ae[0],V=Ae[1]}else B=ee;if(Po(V)){var we=V.split(" ");if(we.length===1){var ct=jt.parse(we[0]);ct.isString()?V=[ct.value,ct.value]:V=[ct.clone(),ct.clone()]}else we.length===2&&(V=we.map(function(at){var ot=jt.parse(at);return ot.isString()?ot.value:ot}))}}}),new E({radialType:B,colorsteps:$})}}]),E}(gd),zg=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"getDefaultObject",value:function(){return U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"getDefaultObject",this).call(this,{type:"repeating-radial-gradient"})}}],[{key:"parse",value:function(g){var A=xd.parse(g);return new E({radialType:A.radialType,radialPosition:A.radialPosition,colorsteps:A.colorsteps})}}]),E}(xd),jl,sb=(jl={},w(jl,"center",!0),w(jl,"top",!0),w(jl,"left",!0),w(jl,"right",!0),w(jl,"bottom",!0),jl),d_={"to top":0,"to top right":45,"to right":90,"to bottom right":135,"to bottom":180,"to bottom left":225,"to left":270,"to top left":315},Td=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"getDefaultObject",value:function(){var g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"getDefaultObject",this).call(this,L({type:"conic-gradient",angle:0,radialPosition:[pn.CENTER,pn.CENTER]},g))}},{key:"toCloneObject",value:function(){return L({},U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"toCloneObject",this).call(this),{angle:this.json.angle,radialPosition:JSON.parse(JSON.stringify(this.json.radialPosition))})}},{key:"isConic",value:function(){return!0}},{key:"hasAngle",value:function(){return!0}},{key:"getColorString",value:function(){if(this.colorsteps.length===0)return"";var g=this.colorsteps;if(!g)return"";g.sort(function(B,V){return B.percent==V.percent?0:B.percent>V.percent?1:-1});var A=g.map(function(B,V){return B.prevColorStep=B.cut&&V>0?g[V-1]:null,B});return A.map(function(B){var V=Math.floor(B.percent*3.6),$="";if(B.cut&&B.prevColorStep){var ee=Math.floor(B.prevColorStep.percent*3.6);$=ee+"deg"}return B.color+" "+$+" "+V+"deg"}).join(",")}},{key:"toString",value:function(){var g=this.getColorString(),A=[],B=this.json,V=B.angle,$=B.radialPosition||pn.CENTER;$=sb[$]?$:$.join(" "),cs(V)&&(V=+(d_[V]||V),A.push("from "+V+"deg")),$&&A.push("at "+$);var ee=A.length?A.join(" ")+",":"";return B.type+"("+ee+" "+g+")"}}],[{key:"parse",value:function(g){var A=de(g),B="0deg",V=[pn.CENTER,pn.CENTER],$=[];return A.str.split("(")[1].split(")")[0].split(",").map(function(ee){return ee.trim()}).forEach(function(ee,fe){if(ee.includes("@"))ee=ee.split(" ").map(function(at){return at.trim()}).map(function(at){return at.includes("deg")?jt.parse(at).toPercent():at}).join(" "),ee=se(ee,A.matches),$.push.apply($,ne(io.parse(ee)));else{if(ee.includes("at")){var pe=ee.split("at").map(function(at){return at.trim()}),Ae=he(pe,2);B=Ae[0],V=Ae[1]}else B=ee;if(Po(V)){var we=V.split(" ");if(we.length===1){var ct=jt.parse(we[0]);ct.isString()?V=[ct.value,ct.value]:V=[ct.clone(),ct.clone()]}else we.length===2&&(V=we.map(function(at){var ot=jt.parse(at);return ot.isString()?ot.value:ot}))}Po(B)&&B.includes("from")&&(B=B.split("from")[1],B=Oa(d_[B])?jt.parse(B):jt.deg(+d_[B]))}}),new E({angle:B,radialPosition:V,colorsteps:$})}}]),E}(gd),Hg=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"getDefaultObject",value:function(){return U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"getDefaultObject",this).call(this,{type:"repeating-conic-gradient",angle:0,radialPosition:[pn.CENTER,pn.CENTER]})}}],[{key:"parse",value:function(g){var A=Td.parse(g);return new E({angle:A.angle,radialPosition:A.radialPosition,colorsteps:A.colorsteps})}}]),E}(Td),nb=[{type:"linear-gradient",title:"Linear Gradient"},{type:"repeating-linear-gradient",title:"Repeating Linear Gradient"},{type:"radial-gradient",title:"Radial Gradient"},{type:"repeating-radial-gradient",title:"Repeating Radial Gradient"},{type:"conic-gradient",title:"Conic Gradient"},{type:"repeating-conic-gradient",title:"Repeating Conic Gradient"}],ab=/((linear\-gradient|repeating\-linear\-gradient|radial\-gradient|repeating\-radial\-gradient|conic\-gradient|repeating\-conic\-gradient|url)\(([^\)]*)\))/gi,ob=function(R){G(E,R);function E(){return P(this,E),Z(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}return D(E,[{key:"components",value:function(){return{EmbedColorPicker:Q0,gradientEditor:tb}}},{key:"parseImage",value:function(g){var A=de(g),B=null;return A.str.match(ab).forEach(function(V,$){V=se(V,A.matches),V.includes("repeating-linear-gradient")?B=Gg.parse(V):V.includes("linear-gradient")?B=vd.parse(V):V.includes("repeating-radial-gradient")?B=zg.parse(V):V.includes("radial")?B=xd.parse(V):V.includes("repeating-conic-gradient")?B=Hg.parse(V):V.includes("conic")&&(B=Td.parse(V))}),B}},{key:"callbackColorValue",value:function(g){var A=this.image.toString();typeof this.opt.onChange=="function"&&this.opt.onChange.call(this,A,this.image),typeof this.colorpickerShowCallback=="function"&&this.colorpickerShowCallback(A,this.image)}},{key:"callbackLastUpdateColorValue",value:function(g){var A=this.image.toString();typeof this.opt.onLastUpdate=="function"&&this.opt.onLastUpdate.call(this,A,this.image)}},{key:"callbackHideColorValue",value:function(g){var A=this.image.toString();typeof this.opt.onHide=="function"&&this.opt.onHide.call(this,A,this.image),typeof this.colorpickerHideCallback=="function"&&this.colorpickerHideCallback(A,this.image)}},{key:"initialize",value:function(){U(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"initialize",this).call(this),this.$root.addClass("gradient-picker"),this.selectedTab="linear-gradient",this.setValue(this.opt.gradient||"linear-gradient(to right, red 0%, yellow 100%)")}},{key:"setValue",value:function(g){this.gradient=g,this.image=this.parseImage(this.gradient),this.selectTabContent(this.image.type)}},{key:"getValue",value:function(){return this.image.toString()}},{key:"template",value:function(){return`
      <div class="gradient-body">

        <div class='box'>
          <div class='gradient-preview'>
            <div class='gradient-view' ref='$gradientView'></div>
          </div>
          <div class="picker-tab">
            <div class="picker-tab-list" ref="$tab" data-value="static-gradient" data-is-image-hidden="false">
              `+nb.map(function(g){return`
                  <span 
                    class='picker-tab-item `+(g.selected?"selected":"")+`' 
                    data-selected-value='`+g.type+`'
                    title='`+g.title+`'
                  > 
                  <div class='icon'></div>
                  </span>`}).join("")+`
            </div>
          </div>
          <div target='gradientEditor'></div>

        </div>
        <div class='box'>
          <div target="EmbedColorPicker"></div>
        </div>
      </div>
     
    `}},{key:"getColorString",value:function(){if(!this.image)return"";var g=this.image.getColorString();return g}},{key:"getCurrentStepColor",value:function(){var g=this.image.colorsteps[this.selectColorStepIndex||0]||{color:"rgba(0, 0, 0, 1)"};return g.color}},{key:"@changeGradientEditor",value:function(g){var A=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,B=g.colorsteps.map(function(V,$){return new io({color:V.color,percent:V.offset.value,cut:V.cut,index:($+1)*100})});g=L({},g,{type:this.selectedTab,colorsteps:B}),this.image.reset(g),this.updateGradientPreview(A)}},{key:"click $tab .picker-tab-item",value:function(g){var A=g.$delegateTarget.attr("data-selected-value");this.selectTabContent(A)}},{key:"selectTabContent",value:function(g){this.selectedTab=g,this.refs.$tab.attr("data-value",g),this.image=this.createGradient({type:g},this.image),this.$store.emit("setGradientEditor",this.getColorString(),this.selectColorStepIndex,this.image.type,this.image.angle,this.image.radialPosition,this.image.radialType);var A=this.getCurrentStepColor();this["@selectColorStep"](A),this.updateGradientPreview(!0)}},{key:"createGradient",value:function(g,A){var B=g.colorsteps||A.colorsteps,V=g.angle||A.angle,$=g.radialType||A.radialType||"ellipse",ee=g.radialPosition||A.radialPosition||[jt.percent(50),jt.percent(50)],fe=A.clone().toJSON();switch(delete fe.itemType,delete fe.type,g.type){case"linear-gradient":return new vd({colorsteps:B,angle:V});case"repeating-linear-gradient":return new Gg({colorsteps:B,angle:V});case"radial-gradient":return new xd({colorsteps:B,radialType:$,radialPosition:ee});case"repeating-radial-gradient":return new zg({colorsteps:B,radialType:$,radialPosition:ee});case"conic-gradient":return new Td({colorsteps:B,angle:V,radialPosition:ee});case"repeating-conic-gradient":return new Hg({colorsteps:B,angle:V,radialPosition:ee})}return new gd}},{key:"@changeEmbedColorPicker",value:function(g){var A=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.$store.emit("setColorStepColor",g,A)}},{key:"@selectColorStep",value:function(g){this.EmbedColorPicker.setValue(g)}},{key:"@changeColorStep",value:function(){var g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.image.reset(L({},g)),this.updateGradientPreview()}},{key:"updateGradientPreview",value:function(){var g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;this.image&&(this.refs.$gradientView.css("background-image",this.image.toString()),this.updateData(g))}},{key:"mousedown $gradientView",value:function(g){this.mouseDown=!0,this.mouseDownX=g.clientX,this.mouseDownY=g.clientY,this.rect=this.refs.$gradientView.rect()}},{key:"mousemove document",value:function(g){if(this.mouseDown){var A=this.rect.left,B=this.rect.right,V=this.rect.top,$=this.rect.bottom,ee=Math.min(Math.max(A,g.clientX),B),fe=Math.min(Math.max(V,g.clientY),$),pe=jt.percent((ee-A)/(B-A)*100),Ae=jt.percent((fe-V)/($-V)*100);this.$store.emit("changeRadialPosition",pe,Ae)}}},{key:"mouseup document",value:function(g){this.mouseDown&&(this.mouseDown=!1,this.updateData(!0))}},{key:"updateData",value:function(){var g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;this.callbackChange(),g&&this.callbackLastUpdate()}}]),E}(il),lb={createGradientPicker:function(E){return new ob(E)}},cb=L({},E0,Fg,lb);return cb})})(HE);var j2=HE.exports;const K2=zE(j2);function q2(o,e,t,i,r,s,n,a,l,c,h,u,d,f,_){c.getMaterialByName("m_tops_base_1").albedoTexture=i,c.getMaterialByName("m_tops_base_1").albedoColor=r.FromHexString("#C6C6C6").toLinearSpace();let p=s.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerTopsBaseContainer"),color:"#ffffff",onChange:I=>{colorPickerHolderTopsBase.style.backgroundColor=I,t.set({backgroundColor:I}),t.renderAll(),l(m,"activeTextures",0),d.forEach(P=>{P.forEach(D=>{D.material.name!="m_tops_base_2"&&D.material.name!="m_tops_base_buttons_1"&&(D.material=c.getMaterialByName("m_tops_base_1"))})}),f.forEach(P=>{P.forEach(D=>{D.material.name!="m_tops_base_2"&&D.material.name!="m_tops_base_buttons_1"&&(D.material=c.getMaterialByName("m_tops_base_1"))})})}});_.colorPickerTopsBase=p,colorPickerHolderTopsBase.onclick=()=>{colorPickerTopsBaseContainer.classList.toggle("color-picker-visible")},n("colorPickerHolderTopsBase","colorPickerTopsBaseContainer");let m=document.getElementsByClassName("topsBaseTextureHolder");baseTexture.onclick=()=>{l(m,"activeTextures",0),d.forEach(I=>{I.forEach(P=>{P.material.name!="m_tops_base_2"&&P.material.name!="m_tops_base_buttons_1"&&(P.material=c.getMaterialByName("m_tops_base_1"))})}),f.forEach(I=>{I.forEach(P=>{P.material.name!="m_tops_base_2"&&P.material.name!="m_tops_base_buttons_1"&&(P.material=c.getMaterialByName("m_tops_base_1"))})})},stripedBaseTexture.onclick=()=>{l(m,"activeTextures",1),d.forEach(I=>{I.forEach(P=>{P.material.name!="m_tops_base_2"&&P.material.name!="m_tops_base_buttons_1"&&(P.material=c.getMaterialByName("m_tops_base_striped_1"))})}),f.forEach(I=>{I.forEach(P=>{P.material.name!="m_tops_base_2"&&P.material.name!="m_tops_base_buttons_1"&&(P.material=c.getMaterialByName("m_tops_base_striped_1"))})})},stripedBaseTexture2.onclick=()=>{l(m,"activeTextures",2),d.forEach(I=>{I.forEach(P=>{P.material.name!="m_tops_base_2"&&P.material.name!="m_tops_base_buttons_1"&&(P.material=c.getMaterialByName("m_tops_base_striped_2"))})}),f.forEach(I=>{I.forEach(P=>{P.material.name!="m_tops_base_2"&&P.material.name!="m_tops_base_buttons_1"&&(P.material=c.getMaterialByName("m_tops_base_striped_2"))})})},document.getElementById("upload").onchange=function(P){let D=new FileReader;D.onload=function(w){u[0]&&(t.setActiveObject(u[0]),t.remove(t.getActiveObject(u[0])),u.length=0,h.length=0);let L=new Image;L.src=w.target.result,L.onload=function(){u[0]=new fabric.Image(L),u[0].set({padding:0,borderColor:"lightBlue",cornerColor:"lightBlue",cornerSize:50,rotatingPointOffset:100,borderScaleFactor:5}),u[0].scaleToHeight(o*.1),u[0].scaleToWidth(o*.1),t.add(u[0]),y=="left"&&T(.34,.48),y=="center"&&T(.25,.48),y=="right"&&T(.16,.48),t.discardActiveObject().renderAll(),t.renderAll(),h.length=0,h.push(u[0])}},D.readAsDataURL(P.target.files[0]),document.getElementById("upload").reset()};let T=(I,P)=>{u[0].set({left:o*I,top:e*P}),u[0].scaleToHeight(o*.1),u[0].scaleToWidth(o*.1),t.renderAll()};removelogo.onclick=()=>{u[0]&&(t.setActiveObject(u[0]),t.remove(t.getActiveObject(u[0])),u.length=0,h.length=0)};let b=document.getElementsByClassName("logo-side"),y="left";a(b,"conf-button-act"),b[0].onclick=()=>{u[0]&&T(.34,.48),y="left"},b[1].onclick=()=>{u[0]&&T(.25,.48),y="center"},b[2].onclick=()=>{u[0]&&T(.16,.48),y="right"},c.getMaterialByName("m_tops_base_2").albedoColor=r.FromHexString("#ffffff").toLinearSpace();let S=s.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerTopsBaseSecondContainer"),color:"#ffffff",onChange:I=>{c.getMaterialByName("m_tops_base_2").albedoColor=r.FromHexString(I).toLinearSpace(),colorPickerHolderTopsBaseSecond.style.backgroundColor=I}});_.colorPickerTopsBaseSecond=S,colorPickerHolderTopsBaseSecond.onclick=()=>{colorPickerTopsBaseSecondContainer.classList.toggle("color-picker-visible")},n("colorPickerHolderTopsBaseSecond","colorPickerTopsBaseSecondContainer"),c.getMaterialByName("m_tops_base_buttons_1").albedoColor=r.FromHexString("#ffffff").toLinearSpace();let C=s.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerTopsBaseBtnsContainer"),color:"#ffffff",onChange:I=>{c.getMaterialByName("m_tops_base_buttons_1").albedoColor=r.FromHexString(I).toLinearSpace(),colorPickerHolderTopsBaseBtns.style.backgroundColor=I}});_.colorPickerTopsBaseBtns=C,colorPickerHolderTopsBaseBtns.onclick=()=>{colorPickerTopsBaseBtnsContainer.classList.toggle("color-picker-visible")},n("colorPickerHolderTopsBaseBtns","colorPickerTopsBaseBtnsContainer")}function Q2(o,e,t,i,r,s,n,a,l,c,h,u){l.getMaterialByName("m_tops_top_1").albedoTexture=i,l.getMaterialByName("m_tops_top_1").albedoColor=r.FromHexString("#C6C6C6").toLinearSpace();let d=s.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerTopsTopContainer"),color:"#ffffff",onChange:b=>{colorPickerHolderTopsTop.style.backgroundColor=b,t.set({backgroundColor:b}),t.renderAll()}});u.colorPickerTopsTop=d,colorPickerHolderTopsTop.onclick=()=>{colorPickerTopsTopContainer.classList.toggle("color-picker-visible")},n("colorPickerHolderTopsTop","colorPickerTopsTopContainer"),document.getElementById("uploadLogoTopsTop").onchange=function(y){let S=new FileReader;S.onload=function(C){c[0]&&(t.setActiveObject(c[0]),t.remove(t.getActiveObject(c[0])),c.length=0,h.length=0);let I=new Image;I.src=C.target.result,I.onload=function(){c[0]=new fabric.Image(I),c[0].set({padding:0,borderColor:"lightBlue",cornerColor:"lightBlue",cornerSize:50,rotatingPointOffset:100,borderScaleFactor:5}),c[0].scaleToHeight(o*.1),c[0].scaleToWidth(o*.1),t.add(c[0]),p=="left"&&f(.5,.38),p=="center"&&f(.35,.38),p=="right"&&f(.2,.38),t.discardActiveObject().renderAll(),t.renderAll(),h.length=0,h.push(c[0])}},S.readAsDataURL(y.target.files[0]),document.getElementById("uploadLogoTopsTop").reset()};let f=(b,y)=>{c[0].set({left:o*b,top:e*y,angle:0}),c[0].scaleToHeight(o*.1),c[0].scaleToWidth(o*.1),t.renderAll()};removelogoTopsTop.onclick=()=>{c[0]&&(t.setActiveObject(c[0]),t.remove(t.getActiveObject(c[0]))),c.length=0,h.length=0};let _=document.getElementsByClassName("logo-side-topsTop"),p="left";a(_,"conf-button-act"),_[0].onclick=()=>{c[0]&&f(.5,.38),p="left"},_[1].onclick=()=>{c[0]&&f(.35,.38),p="center"},_[2].onclick=()=>{c[0]&&f(.2,.38),p="right"},l.getMaterialByName("m_tops_top_2").albedoColor=r.FromHexString("#ffffff").toLinearSpace();let m=s.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerTopsTopSecondContainer"),color:"#ffffff",onChange:b=>{l.getMaterialByName("m_tops_top_2").albedoColor=r.FromHexString(b).toLinearSpace(),colorPickerHolderTopsTopSecond.style.backgroundColor=b}});u.colorPickerTopsTopSecond=m,colorPickerHolderTopsTopSecond.onclick=()=>{colorPickerTopsTopSecondContainer.classList.toggle("color-picker-visible")},n("colorPickerHolderTopsTopSecond","colorPickerTopsTopSecondContainer"),l.getMaterialByName("m_tops_top_buttons_1").albedoColor=r.FromHexString("#ffffff").toLinearSpace();let T=s.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerTopsTopBtnsContainer"),color:"#ffffff",onChange:b=>{l.getMaterialByName("m_tops_top_buttons_1").albedoColor=r.FromHexString(b).toLinearSpace(),colorPickerHolderTopsTopBtns.style.backgroundColor=b}});u.colorPickerTopsTopBtns=T,colorPickerHolderTopsTopBtns.onclick=()=>{colorPickerTopsTopBtnsContainer.classList.toggle("color-picker-visible")},n("colorPickerHolderTopsTopBtns","colorPickerTopsTopBtnsContainer")}function Z2(o,e,t,i,r,s,n,a,l,c,h,u){l.getMaterialByName("m_tops_mid_1").albedoTexture=i,l.getMaterialByName("m_tops_mid_1").albedoColor=r.FromHexString("#C6C6C6").toLinearSpace();let d=s.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerTopsMiddleContainer"),color:"#ffffff",onChange:T=>{colorPickerHolderTopsMiddle.style.backgroundColor=T,t.set({backgroundColor:T}),t.renderAll()}});u.colorPickerTopsMiddle=d,colorPickerHolderTopsMiddle.onclick=()=>{colorPickerTopsMiddleContainer.classList.toggle("color-picker-visible")},n("colorPickerHolderTopsMiddle","colorPickerTopsMiddleContainer"),document.getElementById("uploadLogoTopsMiddle").onchange=function(b){let y=new FileReader;y.onload=function(S){c[0]&&(t.setActiveObject(c[0]),t.remove(t.getActiveObject(c[0])),c.length=0,h.length=0);let C=new Image;C.src=S.target.result,C.onload=function(){c[0]=new fabric.Image(C),c[0].set({angle:0,padding:0,borderColor:"lightBlue",cornerColor:"lightBlue",cornerSize:50,rotatingPointOffset:100,borderScaleFactor:5}),c[0].scaleToHeight(o*.1),c[0].scaleToWidth(o*.1),t.add(c[0]),p=="left"&&f(.39,.48),p=="center"&&f(.25,.48),p=="right"&&f(.16,.48),t.discardActiveObject().renderAll(),t.renderAll(),h.length=0,h.push(c[0])}},y.readAsDataURL(b.target.files[0]),document.getElementById("uploadLogoTopsMiddle").reset()};let f=(T,b)=>{c[0].set({left:o*T,top:e*b,angle:0}),c[0].scaleToHeight(o*.1),c[0].scaleToWidth(o*.1),t.renderAll()};removelogoTopsMiddle.onclick=()=>{c[0]&&(t.setActiveObject(c[0]),t.remove(t.getActiveObject(c[0])),c.length=0,h.length=0)};let _=document.getElementsByClassName("logo-side-topsMiddle"),p="left";a(_,"conf-button-act"),_[0].onclick=()=>{c[0]&&f(.39,.48),p="left"},_[1].onclick=()=>{c[0]&&f(.27,.48),p="center"},_[2].onclick=()=>{c[0]&&f(.1,.48),p="right"},l.getMaterialByName("m_tops_mid_buttons_1").albedoColor=r.FromHexString("#ffffff").toLinearSpace();let m=s.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerTopsMiddleBtnsContainer"),color:"#ffffff",onChange:T=>{l.getMaterialByName("m_tops_mid_buttons_1").albedoColor=r.FromHexString(T).toLinearSpace(),colorPickerHolderTopsMiddleBtns.style.backgroundColor=T}});u.colorPickerTopsMiddleBtns=m,colorPickerHolderTopsMiddleBtns.onclick=()=>{colorPickerTopsMiddleBtnsContainer.classList.toggle("color-picker-visible")},n("colorPickerHolderTopsMiddleBtns","colorPickerTopsMiddleBtnsContainer")}function J2(o,e,t,i,r,s,n,a,l,c,h,u){l.getMaterialByName("m_fullbody_1").albedoTexture=i,l.getMaterialByName("m_fullbody_1").albedoColor=r.FromHexString("#C6C6C6").toLinearSpace();let d=s.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerFullBodyContainer"),color:"#ffffff",onChange:b=>{colorPickerHolderFullBody.style.backgroundColor=b,t.set({backgroundColor:b}),t.renderAll()}});u.colorPickerFullBody=d,colorPickerHolderFullBody.onclick=()=>{colorPickerFullBodyContainer.classList.toggle("color-picker-visible")},n("colorPickerHolderFullBody","colorPickerFullBodyContainer"),document.getElementById("uploadLogoFullBody").onchange=function(y){let S=new FileReader;S.onload=function(C){c[0]&&(t.setActiveObject(c[0]),t.remove(t.getActiveObject(c[0])),c.length=0,h.length=0);let I=new Image;I.src=C.target.result,I.onload=function(){c[0]=new fabric.Image(I),c[0].set({angle:0,padding:0,borderColor:"lightBlue",cornerColor:"lightBlue",cornerSize:50,rotatingPointOffset:100,borderScaleFactor:5}),c[0].scaleToHeight(o*.1),c[0].scaleToWidth(o*.1),t.add(c[0]),p=="left"&&f(.34,.48),p=="center"&&f(.25,.48),p=="right"&&f(.16,.48),t.discardActiveObject().renderAll(),t.renderAll(),h.length=0,h.push(c[0])}},S.readAsDataURL(y.target.files[0]),document.getElementById("uploadLogoFullBody").reset()};let f=(b,y)=>{c[0].set({left:o*b,top:e*y,angle:0}),c[0].scaleToHeight(o*.1),c[0].scaleToWidth(o*.1),t.renderAll()};removelogoFullBody.onclick=()=>{c[0]&&(t.setActiveObject(c[0]),t.remove(t.getActiveObject(c[0])),c.length=0,h.length=0)};let _=document.getElementsByClassName("logo-side-fullbody"),p="left";a(_,"conf-button-act"),_[0].onclick=()=>{c[0]&&f(.34,.48),p="left"},_[1].onclick=()=>{c[0]&&f(.25,.48),p="center"},_[2].onclick=()=>{c[0]&&f(.16,.48),p="right"},l.getMaterialByName("m_fullbody_2").albedoColor=r.FromHexString("#ffffff").toLinearSpace();let m=s.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerFullBodySecondContainer"),color:"#ffffff",onChange:b=>{l.getMaterialByName("m_fullbody_2").albedoColor=r.FromHexString(b).toLinearSpace(),colorPickerHolderFullBodySecond.style.backgroundColor=b}});u.colorPickerFullBodySecond=m,colorPickerHolderFullBodySecond.onclick=()=>{colorPickerFullBodySecondContainer.classList.toggle("color-picker-visible")},n("colorPickerHolderFullBodySecond","colorPickerFullBodySecondContainer"),l.getMaterialByName("m_fullbody_buttons").albedoColor=r.FromHexString("#ffffff").toLinearSpace();let T=s.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerFullBodyBtnsContainer"),color:"#ffffff",onChange:b=>{l.getMaterialByName("m_fullbody_buttons").albedoColor=r.FromHexString(b).toLinearSpace(),colorPickerHolderFullBodyBtns.style.backgroundColor=b}});u.colorPickerFullBodyBtns=T,colorPickerHolderFullBodyBtns.onclick=()=>{colorPickerFullBodyBtnsContainer.classList.toggle("color-picker-visible")},n("colorPickerHolderFullBodyBtns","colorPickerFullBodyBtnsContainer")}function eU(o,e,t,i,r,s,n,a,l,c,h,u,d,f,_,p,m,T,b,y,S,C,I,P,D,w,L,U,G,Z,he,_e){function ne(le,je){document.addEventListener("click",function(be){let We=document.getElementById(le),Ct=document.getElementById(je);!Ct.contains(be.target)&&!We.contains(be.target)&&Ct.classList.remove("color-picker-visible")})}let Pe=e.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerHairContainer"),color:"#ffffff",onChange:le=>{colorPickerHolderHair.style.backgroundColor=le,o.getMaterialByName("m_hair").albedoColor=o.getMaterialByName("m_hair_mousy").albedoColor=o.getMaterialByName("m_hair_platina").albedoColor=o.getMaterialByName("m_hair_darkblonde").albedoColor=t.FromHexString(le).toLinearSpace()}});_e.colorPickerHair=Pe,colorPickerHolderHair.onclick=()=>{colorPickerHairContainer.classList.toggle("color-picker-visible")},ne("colorPickerHolderHair","colorPickerHairContainer");let Se=document.getElementsByClassName("hairTextures");r(Se,"activeTextures"),hairTextureOne.onclick=()=>{m.forEach(le=>{le.forEach(je=>{je.material=o.getMaterialByName("m_hair")})});for(let le=0;le<T.length;le++)T[le][0].material=o.getMaterialByName("m_hair");for(let le=0;le<b.length;le++)b[le][0].material=o.getMaterialByName("m_hair");for(let le=0;le<y.length;le++)y[le][0].material=o.getMaterialByName("m_hair");o.getMaterialByName("m_hair").albedoColor=o.getMaterialByName("m_hair_mousy").albedoColor=o.getMaterialByName("m_hair_platina").albedoColor=o.getMaterialByName("m_hair_darkblonde").albedoColor=t.FromHexString("#ffffff").toLinearSpace(),colorPickerHolderHair.style.backgroundColor="#ffffff"},hairTextureTwo.onclick=()=>{m.forEach(le=>{le.forEach(je=>{je.material=o.getMaterialByName("m_hair_mousy")})});for(let le=0;le<T.length;le++)T[le][0].material=o.getMaterialByName("m_hair_mousy");for(let le=0;le<b.length;le++)b[le][0].material=o.getMaterialByName("m_hair_mousy");for(let le=0;le<y.length;le++)y[le][0].material=o.getMaterialByName("m_hair_mousy");o.getMaterialByName("m_hair").albedoColor=o.getMaterialByName("m_hair_mousy").albedoColor=o.getMaterialByName("m_hair_platina").albedoColor=o.getMaterialByName("m_hair_darkblonde").albedoColor=t.FromHexString("#ffffff").toLinearSpace(),colorPickerHolderHair.style.backgroundColor="#ffffff"},hairTextureThree.onclick=()=>{m.forEach(le=>{le.forEach(je=>{je.material=o.getMaterialByName("m_hair_platina")})});for(let le=0;le<T.length;le++)T[le][0].material=o.getMaterialByName("m_hair_platina");for(let le=0;le<b.length;le++)b[le][0].material=o.getMaterialByName("m_hair_platina");for(let le=0;le<y.length;le++)y[le][0].material=o.getMaterialByName("m_hair_platina");o.getMaterialByName("m_hair").albedoColor=o.getMaterialByName("m_hair_mousy").albedoColor=o.getMaterialByName("m_hair_platina").albedoColor=o.getMaterialByName("m_hair_darkblonde").albedoColor=t.FromHexString("#ffffff").toLinearSpace(),colorPickerHolderHair.style.backgroundColor="#ffffff"},hairTextureFour.onclick=()=>{m.forEach(le=>{le.forEach(je=>{je.material=o.getMaterialByName("m_hair_darkblonde")})});for(let le=0;le<T.length;le++)T[le][0].material=o.getMaterialByName("m_hair_darkblonde");for(let le=0;le<b.length;le++)b[le][0].material=o.getMaterialByName("m_hair_darkblonde");for(let le=0;le<y.length;le++)y[le][0].material=o.getMaterialByName("m_hair_darkblonde");o.getMaterialByName("m_hair").albedoColor=o.getMaterialByName("m_hair_mousy").albedoColor=o.getMaterialByName("m_hair_platina").albedoColor=o.getMaterialByName("m_hair_darkblonde").albedoColor=t.FromHexString("#ffffff").toLinearSpace(),colorPickerHolderHair.style.backgroundColor="#ffffff"},o.getMaterialByName("m_bottoms_1").albedoColor=t.FromHexString("#ffffff").toLinearSpace();let ce=e.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerBottomsContainer"),color:"#ffffff",onChange:le=>{o.getMaterialByName("m_bottoms_1").albedoColor=t.FromHexString(le).toLinearSpace(),colorPickerHolderBottoms.style.backgroundColor=le}});_e.colorPickerBottoms=ce,colorPickerHolderBottoms.onclick=()=>{colorPickerBottomsContainer.classList.toggle("color-picker-visible")},ne("colorPickerHolderBottoms","colorPickerBottomsContainer"),J2(n,a,h,u,t,e,ne,r,o,U,G,_e),i.forEach(le=>{le.forEach(je=>{je.material.albedoColor=t.FromHexString("#ffffff").toLinearSpace()})});let de=e.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerHatsContainer"),color:"#ffffff",onChange:le=>{o.getMeshByName("male_keffiyeh_geo_primitive1").material=o.getMaterialByName("m_hat_1"),headwearTextureArabicPattern.classList.remove("activeTextures"),i.forEach(je=>{je.forEach(st=>{st.material.albedoColor=t.FromHexString(le).toLinearSpace()})}),colorPickerHolderHats.style.backgroundColor=le}});_e.colorPickerHats=de,colorPickerHolderHats.onclick=()=>{colorPickerHatsContainer.classList.toggle("color-picker-visible")},ne("colorPickerHolderHats","colorPickerHatsContainer"),headwearTextureArabicPattern.onclick=()=>{headwearTextureArabicPattern.classList.contains("activeTextures")?o.getMeshByName("male_keffiyeh_geo_primitive1").material=o.getMaterialByName("m_hat_1"):o.getMeshByName("male_keffiyeh_geo_primitive1").material=o.getMaterialByName("m_hat_arabic_pattern"),headwearTextureArabicPattern.classList.toggle("activeTextures")},o.getMaterialByName("m_belt_1").albedoColor=t.FromHexString("#ffffff").toLinearSpace();let k=e.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerBeltsContainer"),color:"#ffffff",onChange:le=>{o.getMaterialByName("m_belt_1").albedoColor=t.FromHexString(le).toLinearSpace(),colorPickerHolderBelts.style.backgroundColor=le}});_e.colorPickerBelts=k,colorPickerHolderBelts.onclick=()=>{colorPickerBeltsContainer.classList.toggle("color-picker-visible")},ne("colorPickerHolderBelts","colorPickerBeltsContainer");let se=document.getElementsByClassName("beltMetalTextures");r(se,"activeTextures"),beltMetalTextureSteel.onclick=()=>{S.forEach(le=>{le[1].material=o.getMaterialByName("m_metal_steel")})},beltMetalTextureSilver.onclick=()=>{S.forEach(le=>{le[1].material=o.getMaterialByName("m_metal_silver")})},beltMetalTextureGold.onclick=()=>{S.forEach(le=>{le[1].material=o.getMaterialByName("m_metal_gold")})},o.getMaterialByName("m_accessories_1").albedoColor=t.FromHexString("#ffffff").toLinearSpace();let xe=e.create({type:"chromedeveltool",position:"inline",container:document.getElementById("colorPickerAccessoriesContainer"),color:"#ffffff",onChange:le=>{o.getMaterialByName("m_accessories_1").albedoColor=t.FromHexString(le).toLinearSpace(),colorPickerHolderAccessories.style.backgroundColor=le}});_e.colorPickerAccessories=xe,colorPickerHolderAccessories.onclick=()=>{colorPickerAccessoriesContainer.classList.toggle("color-picker-visible")},ne("colorPickerHolderAccessories","colorPickerAccessoriesContainer"),q2(n,a,l,c,t,e,ne,r,s,o,C,I,Z,he,_e),Z2(n,a,_,p,t,e,ne,r,o,P,D,_e),Q2(n,a,d,f,t,e,ne,r,o,w,L,_e)}function tU(){let o=document.getElementsByClassName("change-tops-part"),e=document.getElementsByClassName("tops-nav-btn");o[0].style.display="block",e[0].classList.add("conf-button-act"),topsNavBtnBase.onclick=()=>{for(let t=0;t<o.length;t++)o[t].style.display="none",e[t].classList.remove("conf-button-act");o[0].style.display="block",e[0].classList.add("conf-button-act")},topsNavBtnMiddle.onclick=()=>{for(let t=0;t<o.length;t++)o[t].style.display="none",e[t].classList.remove("conf-button-act");o[1].style.display="block",e[1].classList.add("conf-button-act"),paintCanvasTopsMiddleParent.scrollLeft=35,paintCanvasTopsMiddleParent.scrollTop=223},topsNavBtnTop.onclick=()=>{for(let t=0;t<o.length;t++)o[t].style.display="none",e[t].classList.remove("conf-button-act");o[2].style.display="block",e[2].classList.add("conf-button-act"),paintCanvasTopsTopParent.scrollLeft=36,paintCanvasTopsTopParent.scrollTop=134}}function iU(o,e,t,i,r,s,n,a,l,c,h,u,d,f,_,p,m,T,b,y,S,C,I,P,D,w,L,U,G,Z,he,_e,ne,Pe,Se,ce,de,k,se,xe,le,je,st,be,We,Ct,_t,mt,Ge,Ut,Ft,Zt,$t,Di,Ui,ar,ti,or,pi,Si,mi,Is,cn,Js,Ur,Zn,Un,Es,Ps,en,zi,os,ls,Ir,zs,Vr,Ni,Ms,fr,hn,Ii){if(o.gender=="female"&&(r(0),s(n,"conf-button-act",0)),o.gender=="male"&&(r(1),s(n,"conf-button-act",1)),o.face_style_detected){if(o.gender=="female")for(let re=0;re<a.length;re++)a[re][0].name.startsWith(o.face_style)&&(i(a,re),s(l,"conf-button-act",re));if(o.gender=="male")for(let re=0;re<c.length;re++)c[re][0].name.startsWith(o.face_style)&&(i(c,re),s(h,"conf-button-act",re))}if(o.skin_color_detected){if(o.gender=="female"){for(let re=0;re<u.length;re++)if(o.skin_color_style==u[re].name){for(let Fe=0;Fe<a.length;Fe++)a[Fe][a[Fe].length-1].material=u[re];d[4].material=u[re],s(f,"conf-button-act",re)}}if(o.gender=="male"){for(let re=0;re<_.length;re++)if(o.skin_color_style==_[re].name){for(let Fe=0;Fe<c.length;Fe++)c[Fe][c[Fe].length-1].material=_[re];p[4].material=_[re],s(m,"conf-button-act",re)}}}if(o.eye_color_detected)for(let re=0;re<T.length;re++)o.eye_color==T[re].name&&(d[1].material=d[3].material=T[re],s(b,"conf-button-act",re));if(o.hair_style_detected||(y.forEach(re=>{re.forEach(Fe=>{Fe.isVisible=!1})}),s(S,"conf-button-act",S.length-1)),o.hair_style_detected){for(let re=0;re<y.length;re++)if(y[re][0].material=e.getMaterialByName(o.hair_texture),y[re][0].name.startsWith(o.hair_style)){i(y,re),s(S,"conf-button-act",re);for(let Fe=0;Fe<y[re].length;Fe++)y[re][Fe].material.albedoColor=t.FromHexString(o.hair_color_hex[Fe]).toLinearSpace()}}for(let re=0;re<a.length;re++)a[re][0].material=e.getMaterialByName(o.hair_texture);for(let re=0;re<c.length;re++)c[re][0].material=e.getMaterialByName(o.hair_texture);for(let re=0;re<C.length;re++)C[re][0].material=e.getMaterialByName(o.hair_texture);if(o.hair_color_detected&&(Zn.style.backgroundColor=o.hair_color_hex[0],Ii.colorPickerHair.initColor(o.hair_color_hex[0])),o.facial_hair_detected)for(let re=0;re<C.length;re++)C[re][0].name.startsWith(o.facial_hair_style)&&(i(C,re),s(I,"conf-button-act",re));else C.forEach(re=>{re.forEach(Fe=>{Fe.isVisible=!1})}),s(I,"conf-button-act",I.length-1);if(o.top_detected){if(o.gender=="female"){for(let Fe=0;Fe<P.length;Fe++){P[Fe].forEach(De=>{De.isVisible=!1});for(let De=0;De<w.length;De++)w[De].classList.remove("conf-button-act");for(let De=0;De<U.length;De++)U[De].classList.remove("conf-button-act");for(let De=0;De<Z.length;De++)Z[De].classList.remove("conf-button-act")}let re=document.getElementsByClassName("topsBaseTextureHolder");o.top_base_mat!=null?(D.forEach(Fe=>{Fe.forEach(De=>{De.material.name!="m_tops_base_2"&&De.material.name!="m_tops_base_buttons_1"&&(De.material=e.getMaterialByName(o.top_base_mat))})}),o.top_base_mat==="m_tops_base_1"&&s(re,"activeTextures",0),o.top_base_mat==="m_tops_base_striped_1"&&s(re,"activeTextures",1),o.top_base_mat==="m_tops_base_striped_2"&&s(re,"activeTextures",2)):o.top_base_stripe_mat?(s(re,"activeTextures",1),D.forEach(Fe=>{Fe.forEach(De=>{De.material.name!="m_tops_base_2"&&De.material.name!="m_tops_base_buttons_1"&&(De.material=e.getMaterialByName("m_tops_base_striped_1"))})})):(s(re,"activeTextures",0),D.forEach(Fe=>{Fe.forEach(De=>{De.material.name!="m_tops_base_2"&&De.material.name!="m_tops_base_buttons_1"&&(De.material=e.getMaterialByName("m_tops_base_1"))})}));for(let Fe=0;Fe<o.top_style.length;Fe++){for(let De=0;De<P.length;De++)if(P[De][0].name.startsWith(o.top_style[Fe]))for(let At=0;At<P[De].length;At++)P[De][At].isVisible=!0,P[De][At].material.name==="m_tops_base_1"?(colorPickerHolderTopsBase.style.backgroundColor=o.tops_color_hex[Fe][At],Ii.colorPickerTopsBase.initColor(o.tops_color_hex[Fe][At])):P[De][At].material.name==="m_tops_mid_1"?(colorPickerHolderTopsMiddle.style.backgroundColor=o.tops_color_hex[Fe][At],Ii.colorPickerTopsMiddle.initColor(o.tops_color_hex[Fe][At])):P[De][At].material.name==="m_tops_top_1"?(colorPickerHolderTopsTop.style.backgroundColor=o.tops_color_hex[Fe][At],Ii.colorPickerTopsTop.initColor(o.tops_color_hex[Fe][At])):P[De][At].material.albedoColor=t.FromHexString(o.tops_color_hex[Fe][At]).toLinearSpace();if(D.length>0)for(let De=0;De<D.length;De++)D[De][0].name.startsWith(o.top_style[Fe])&&w[De].classList.add("conf-button-act");if(L.length>0)for(let De=0;De<L.length;De++)L[De][0].name.startsWith(o.top_style[Fe])&&U[De].classList.add("conf-button-act");if(G.length>0)for(let De=0;De<G.length;De++)G[De][0].name.startsWith(o.top_style[Fe])&&Z[De].classList.add("conf-button-act")}}if(o.gender=="male"){for(let Fe=0;Fe<he.length;Fe++){he[Fe].forEach(De=>{De.isVisible=!1});for(let De=0;De<ne.length;De++)ne[De].classList.remove("conf-button-act");for(let De=0;De<Se.length;De++)Se[De].classList.remove("conf-button-act");for(let De=0;De<de.length;De++)de[De].classList.remove("conf-button-act")}let re=document.getElementsByClassName("topsBaseTextureHolder");o.top_base_mat!=null?(_e.forEach(Fe=>{Fe.forEach(De=>{De.material.name!="m_tops_base_2"&&De.material.name!="m_tops_base_buttons_1"&&(De.material=e.getMaterialByName(o.top_base_mat))})}),o.top_base_mat==="m_tops_base_1"&&s(re,"activeTextures",0),o.top_base_mat==="m_tops_base_striped_1"&&s(re,"activeTextures",1),o.top_base_mat==="m_tops_base_striped_2"&&s(re,"activeTextures",2)):o.top_base_stripe_mat?(s(re,"activeTextures",1),_e.forEach(Fe=>{Fe.forEach(De=>{De.material.name!="m_tops_base_2"&&De.material.name!="m_tops_base_buttons_1"&&(De.material=e.getMaterialByName("m_tops_base_striped_1"))})})):(s(re,"activeTextures",0),_e.forEach(Fe=>{Fe.forEach(De=>{De.material.name!="m_tops_base_2"&&De.material.name!="m_tops_base_buttons_1"&&(De.material=e.getMaterialByName("m_tops_base_1"))})}));for(let Fe=0;Fe<o.top_style.length;Fe++){for(let De=0;De<he.length;De++)if(he[De][0].name.startsWith(o.top_style[Fe]))for(let At=0;At<he[De].length;At++)he[De][At].isVisible=!0,he[De][At].material.name==="m_tops_base_1"?(colorPickerHolderTopsBase.style.backgroundColor=o.tops_color_hex[Fe][At],Ii.colorPickerTopsBase.initColor(o.tops_color_hex[Fe][At])):he[De][At].material.name==="m_tops_mid_1"?(colorPickerHolderTopsMiddle.style.backgroundColor=o.tops_color_hex[Fe][At],Ii.colorPickerTopsMiddle.initColor(o.tops_color_hex[Fe][At])):he[De][At].material.name==="m_tops_top_1"?(colorPickerHolderTopsTop.style.backgroundColor=o.tops_color_hex[Fe][At],Ii.colorPickerTopsTop.initColor(o.tops_color_hex[Fe][At])):he[De][At].material.albedoColor=t.FromHexString(o.tops_color_hex[Fe][At]).toLinearSpace();if(_e.length>0)for(let De=0;De<_e.length;De++)_e[De][0].name.startsWith(o.top_style[Fe])&&ne[De].classList.add("conf-button-act");if(Pe.length>0)for(let De=0;De<Pe.length;De++)Pe[De][0].name.startsWith(o.top_style[Fe])&&Se[De].classList.add("conf-button-act");if(ce.length>0)for(let De=0;De<ce.length;De++)ce[De][0].name.startsWith(o.top_style[Fe])&&de[De].classList.add("conf-button-act")}}}else{if(Ct[0]=!0,o.gender=="female"){P.forEach(re=>{re.forEach(Fe=>{Fe.isVisible=!1})});for(let re=0;re<w.length;re++)w[re].classList.remove("conf-button-act");for(let re=0;re<U.length;re++)U[re].classList.remove("conf-button-act");for(let re=0;re<Z.length;re++)Z[re].classList.remove("conf-button-act")}if(o.gender=="male"){he.forEach(re=>{re.forEach(Fe=>{Fe.isVisible=!1})});for(let re=0;re<ne.length;re++)ne[re].classList.remove("conf-button-act");for(let re=0;re<Se.length;re++)Se[re].classList.remove("conf-button-act");for(let re=0;re<de.length;re++)de[re].classList.remove("conf-button-act")}}if(Ir[0]&&(k.setActiveObject(Ir[0]),k.remove(k.getActiveObject(Ir[0])),Ir.length=0,ls.length=0),o.tops_base_logo_detected){let re=new Image;re.src=o.tops_base_logo_data.image_URL,re.onload=function(){Ir[0]=new fabric.Image(re),Ir[0].set({angle:0,left:o.tops_base_logo_data.image_left,top:o.tops_base_logo_data.image_top,padding:0,borderColor:"lightBlue",cornerColor:"lightBlue",cornerSize:50,rotatingPointOffset:100,borderScaleFactor:5}),Ir[0].angle=o.tops_base_logo_data.image_angle,k.add(Ir[0]),k.discardActiveObject().renderAll(),k.renderAll(),ls.length=0,ls.push(Ir[0])}}if(zs[0]&&(se.setActiveObject(zs[0]),se.remove(se.getActiveObject(zs[0])),zs.length=0,Vr.length=0),o.tops_middle_logo_detected){let re=new Image;re.src=o.tops_middle_logo_data.image_URL,re.onload=function(){zs[0]=new fabric.Image(re),zs[0].set({angle:0,left:o.tops_middle_logo_data.image_left,top:o.tops_middle_logo_data.image_top,padding:0,borderColor:"lightBlue",cornerColor:"lightBlue",cornerSize:50,rotatingPointOffset:100,borderScaleFactor:5}),zs[0].angle=o.tops_middle_logo_data.image_angle,se.add(zs[0]),se.discardActiveObject().renderAll(),se.renderAll(),Vr.length=0,Vr.push(zs[0])}}if(Ni[0]&&(xe.setActiveObject(Ni[0]),xe.remove(xe.getActiveObject(Ni[0])),Ni.length=0,Ms.length=0),o.tops_top_logo_detected){let re=new Image;re.src=o.tops_top_logo_data.image_URL,re.onload=function(){Ni[0]=new fabric.Image(re),Ni[0].set({angle:0,left:o.tops_top_logo_data.image_left,top:o.tops_top_logo_data.image_top,padding:0,borderColor:"lightBlue",cornerColor:"lightBlue",cornerSize:50,rotatingPointOffset:100,borderScaleFactor:5}),Ni[0].angle=o.tops_top_logo_data.image_angle,xe.add(Ni[0]),xe.discardActiveObject().renderAll(),xe.renderAll(),Ms.length=0,Ms.push(Ni[0])}}if(o.top_color_detected&&(colorPickerHolderTopsBaseSecond.style.backgroundColor=e.getMaterialByName("m_tops_base_2").albedoColor.toHexString(),Ii.colorPickerTopsBaseSecond.initColor(e.getMaterialByName("m_tops_base_2").albedoColor.toGammaSpace().toHexString()),colorPickerHolderTopsBaseBtns.style.backgroundColor=e.getMaterialByName("m_tops_base_buttons_1").albedoColor.toHexString(),Ii.colorPickerTopsBaseBtns.initColor(e.getMaterialByName("m_tops_base_buttons_1").albedoColor.toGammaSpace().toHexString()),colorPickerHolderTopsMiddleBtns.style.backgroundColor=e.getMaterialByName("m_tops_mid_buttons_1").albedoColor.toHexString(),Ii.colorPickerTopsMiddleBtns.initColor(e.getMaterialByName("m_tops_mid_buttons_1").albedoColor.toGammaSpace().toHexString()),colorPickerHolderTopsTopBtns.style.backgroundColor=e.getMaterialByName("m_tops_top_buttons_1").albedoColor.toHexString(),Ii.colorPickerTopsTopBtns.initColor(e.getMaterialByName("m_tops_top_buttons_1").albedoColor.toGammaSpace().toHexString()),colorPickerHolderTopsTopSecond.style.backgroundColor=e.getMaterialByName("m_tops_top_2").albedoColor.toHexString(),Ii.colorPickerTopsTopSecond.initColor(e.getMaterialByName("m_tops_top_2").albedoColor.toGammaSpace().toHexString())),o.bottom_detected){if(o.gender=="female"){for(let re=0;re<je.length;re++)if(je[re][0].name.startsWith(o.bottom_style)){i(je,re),s(st,"conf-button-act",re);for(let Fe=0;Fe<je[re].length;Fe++)je[re][Fe].material.albedoColor=t.FromHexString(o.bottom_color_hex[Fe]).toLinearSpace()}}if(o.gender=="male"){for(let re=0;re<be.length;re++)if(be[re][0].name.startsWith(o.bottom_style)){i(be,re),s(We,"conf-button-act",re);for(let Fe=0;Fe<be[re].length;Fe++)be[re][Fe].material.albedoColor=t.FromHexString(o.bottom_color_hex[Fe]).toLinearSpace()}}}else{if(Ct[0]=!0,o.gender=="female"){je.forEach(re=>{re.forEach(Fe=>{Fe.isVisible=!1})});for(let re=0;re<st.length;re++)st[re].classList.remove("conf-button-act")}if(o.gender=="male"){be.forEach(re=>{re.forEach(Fe=>{Fe.isVisible=!1})});for(let re=0;re<We.length;re++)We[re].classList.remove("conf-button-act")}}if(o.bottom_color_detected&&(Un.style.backgroundColor=o.bottom_color_hex[0],Ii.colorPickerBottoms.initColor(o.bottom_color_hex[0])),o.full_body_detected){if(o.gender=="female"){for(let re=0;re<_t.length;re++)if(_t[re][0].name.startsWith(o.full_body_style)){i(_t,re),s(mt,"conf-button-act",re);for(let Fe=0;Fe<_t[re].length;Fe++)_t[re][Fe].material.name!=="m_fullbody_1"?_t[re][Fe].material.albedoColor=t.FromHexString(o.full_body_color_hex[Fe]).toLinearSpace():(Es.style.backgroundColor=o.full_body_color_hex[Fe],Ii.colorPickerFullBody.initColor(o.full_body_color_hex[Fe]))}}if(o.gender=="male"){for(let re=0;re<Ge.length;re++)if(Ge[re][0].name.startsWith(o.full_body_style)){i(Ge,re),s(Ut,"conf-button-act",re);for(let Fe=0;Fe<Ge[re].length;Fe++)Ge[re][Fe].material.name!=="m_fullbody_1"?Ge[re][Fe].material.albedoColor=t.FromHexString(o.full_body_color_hex[Fe]).toLinearSpace():(Es.style.backgroundColor=o.full_body_color_hex[Fe],Ii.colorPickerFullBody.initColor(o.full_body_color_hex[Fe]))}}}if(fr[0]&&(le.setActiveObject(fr[0]),le.remove(le.getActiveObject(fr[0])),fr.length=0,hn.length=0),o.full_body_logo_detected){let re=new Image;re.src=o.full_body_logo_data.image_URL,re.onload=function(){fr[0]=new fabric.Image(re),fr[0].set({angle:0,left:o.full_body_logo_data.image_left,top:o.full_body_logo_data.image_top,padding:0,borderColor:"lightBlue",cornerColor:"lightBlue",cornerSize:50,rotatingPointOffset:100,borderScaleFactor:5}),fr[0].angle=o.full_body_logo_data.image_angle,le.add(fr[0]),le.discardActiveObject().renderAll(),le.renderAll(),hn.length=0,hn.push(fr[0])}}if(o.full_body_color_detected&&(Ps.style.backgroundColor=e.getMaterialByName("m_fullbody_buttons").albedoColor.toHexString(),Ii.colorPickerFullBodyBtns.initColor(e.getMaterialByName("m_fullbody_buttons").albedoColor.toGammaSpace().toHexString()),en.style.backgroundColor=e.getMaterialByName("m_fullbody_2").albedoColor.toHexString(),Ii.colorPickerFullBodySecond.initColor(e.getMaterialByName("m_fullbody_2").albedoColor.toGammaSpace().toHexString())),o.shoes_detected)for(let re=0;re<Ft.length;re++)Ft[re][0].name.startsWith(o.shoes_style)&&(i(Ft,re),s(Zt,"conf-button-act",re));if(o.hat_detected){if(o.gender=="female")for(let re=0;re<Di.length;re++)Di[re][0].name.startsWith(o.hat_style)&&s(ar,"conf-button-act",re);if(o.gender=="male")for(let re=0;re<Ui.length;re++)Ui[re][0].name.startsWith(o.hat_style)&&(Ui[re][0].name==="male_keffiyeh_geo_primitive0"&&(Ui[re][1].material=e.getMaterialByName(o.keffiyeh_texture)),s(ti,"conf-button-act",re));for(let re=0;re<$t.length;re++)if($t[re][0].name.startsWith(o.hat_style)){i($t,re);for(let Fe=0;Fe<$t[re].length;Fe++)o.keffiyeh_texture!=="m_hat_arabic_pattern"&&($t[re][Fe].material.albedoColor=t.FromHexString(o.hats_hex_color[Fe]).toLinearSpace())}o.hats_color_detected&&(zi.style.backgroundColor=o.hats_hex_color[0],Ii.colorPickerHats.initColor(o.hats_hex_color[0]))}else{for(let re=0;re<ar.length;re++)ar[re].classList.remove("conf-button-act");for(let re=0;re<ti.length;re++)ti[re].classList.remove("conf-button-act")}if(o.belt_detected){for(let Fe=0;Fe<o.belt_style.length;Fe++)for(let De=0;De<or.length;De++)or[De][0].name.startsWith(o.belt_style[Fe])&&(or[De].forEach(At=>{At.isVisible=!0}),pi[De].classList.add("conf-button-act"));for(let Fe=0;Fe<or.length;Fe++)or[Fe].forEach(De=>{De.material.name.startsWith("m_metal")&&(De.material=e.getMaterialByName(o.belt_metal_material[0]))});let re=document.getElementsByClassName("beltMetalTextures");o.belt_metal_material[0]==="m_metal_steel"&&s(re,"activeTextures",0),o.belt_metal_material[0]==="m_metal_silver"&&s(re,"activeTextures",1),o.belt_metal_material[0]==="m_metal_gold"&&s(re,"activeTextures",2),e.getMaterialByName("m_belt_1").albedoColor=t.FromHexString(o.belt_hex_color[0]).toLinearSpace(),os.style.backgroundColor=o.belt_hex_color[0],Ii.colorPickerBelts.initColor(o.belt_hex_color[0])}else for(let re=0;re<pi.length;re++)pi[re].classList.remove("conf-button-act");if(o.glasses_detected)for(let re=0;re<Si.length;re++)Si[re][0].name.startsWith(o.glasses_style)&&(i(Si,re),s(mi,"conf-button-act",re));else for(let re=0;re<mi.length;re++)mi[re].classList.remove("conf-button-act");if(o.sunglasses_detected)for(let re=0;re<Si.length;re++)Si[re][0].name.startsWith(o.sunglasses_style)&&(i(Si,re),s(mi,"conf-button-act",re));if(o.jewelery_detected)for(let re=0;re<Is.length;re++)Is[re][0].name.startsWith(o.jewelery_style)&&(i(Is,re),s(cn,"conf-button-act",re));else for(let re=0;re<cn.length;re++)cn[re].classList.remove("conf-button-act");if(o.accessories_detected){for(let re=0;re<o.accessories.length;re++)for(let Fe=0;Fe<Js.length;Fe++)if(Js[Fe][0].name.startsWith(o.accessories[re])){Ur[Fe].classList.add("conf-button-act");for(let De=0;De<Js[Fe].length;De++)Js[Fe][De].isVisible=!0,Js[Fe][De].material.albedoColor=t.FromHexString(o.accessories_hex_color[re][De]).toLinearSpace()}o.accessories_color_detected&&(colorPickerHolderAccessories.style.backgroundColor=e.getMaterialByName("m_accessories_1").albedoColor.toHexString(),Ii.colorPickerAccessories.initColor(e.getMaterialByName("m_accessories_1").albedoColor.toGammaSpace().toHexString()))}else for(let re=0;re<Ur.length;re++)Ur[re].classList.remove("conf-button-act")}function Od(o){throw new Error('Could not dynamically require "'+o+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var WE={exports:{}};(function(o,e){(function(t){o.exports=t()})(function(){return function(){function t(i,r,s){function n(c,h){if(!r[c]){if(!i[c]){var u=typeof Od=="function"&&Od;if(!h&&u)return u(c,!0);if(a)return a(c,!0);var d=new Error("Cannot find module '"+c+"'");throw d.code="MODULE_NOT_FOUND",d}var f=r[c]={exports:{}};i[c][0].call(f.exports,function(_){var p=i[c][1][_];return n(p||_)},f,f.exports,t,i,r,s)}return r[c].exports}for(var a=typeof Od=="function"&&Od,l=0;l<s.length;l++)n(s[l]);return n}return t}()({1:[function(t,i,r){var s,n=typeof window<"u"?window:typeof self<"u"?self:null;if(!n)s=t("abort-controller");else if("signal"in new Request(""))s=n.AbortController;else{var a=t("abortcontroller-polyfill/dist/cjs-ponyfill");s=a.AbortController}i.exports=s},{"abort-controller":20,"abortcontroller-polyfill/dist/cjs-ponyfill":19}],2:[function(t,i,r){var s=function(){function n(a,l,c){this.error=a,this.message=l,this.statusCode=c}return n.prototype.toString=function(){return[this.message,"(",this.error,")",this.statusCode?"[Http code "+this.statusCode+"]":""].join("")},n}();i.exports=s},{}],3:[function(t,i,r){var s=this&&this.__assign||function(){return s=Object.assign||function(P){for(var D,w=1,L=arguments.length;w<L;w++){D=arguments[w];for(var U in D)Object.prototype.hasOwnProperty.call(D,U)&&(P[U]=D[U])}return P},s.apply(this,arguments)},n=this&&this.__importDefault||function(P){return P&&P.__esModule?P:{default:P}},a=n(t("lodash/get")),l=n(t("lodash/isPlainObject")),c=n(t("lodash/keys")),h=n(t("./fetch")),u=n(t("./abort-controller")),d=n(t("./object_to_query_param_string")),f=n(t("./airtable_error")),_=n(t("./table")),p=n(t("./http_headers")),m=n(t("./run_action")),T=n(t("./package_version")),b=n(t("./exponential_backoff_with_jitter")),y="Airtable.js/"+T.default,S=function(){function P(D,w){this._airtable=D,this._id=w}return P.prototype.table=function(D){return new _.default(this,null,D)},P.prototype.makeRequest=function(D){var w=this,L;D===void 0&&(D={});var U=a.default(D,"method","GET").toUpperCase(),G=this._airtable._endpointUrl+"/v"+this._airtable._apiVersionMajor+"/"+this._id+a.default(D,"path","/")+"?"+d.default(a.default(D,"qs",{})),Z=new u.default,he=this._getRequestHeaders(Object.assign({},this._airtable._customHeaders,(L=D.headers)!==null&&L!==void 0?L:{})),_e={method:U,headers:he,signal:Z.signal};"body"in D&&C(U)&&(_e.body=JSON.stringify(D.body));var ne=setTimeout(function(){Z.abort()},this._airtable._requestTimeout);return new Promise(function(Pe,Se){h.default(G,_e).then(function(ce){if(clearTimeout(ne),ce.status===429&&!w._airtable._noRetryIfRateLimited){var de=a.default(D,"_numAttempts",0),k=b.default(de);setTimeout(function(){var se=s(s({},D),{_numAttempts:de+1});w.makeRequest(se).then(Pe).catch(Se)},k)}else ce.json().then(function(se){var xe=w._checkStatusForError(ce.status,se)||I(ce.status,se);xe?Se(xe):Pe({statusCode:ce.status,headers:ce.headers,body:se})}).catch(function(){var se=I(ce.status);Se(se)})}).catch(function(ce){clearTimeout(ne),ce=new f.default("CONNECTION_ERROR",ce.message,null),Se(ce)})})},P.prototype.runAction=function(D,w,L,U,G){m.default(this,D,w,L,U,G,0)},P.prototype._getRequestHeaders=function(D){var w=new p.default;w.set("Authorization","Bearer "+this._airtable._apiKey),w.set("User-Agent",y),w.set("Content-Type","application/json");for(var L=0,U=c.default(D);L<U.length;L++){var G=U[L];w.set(G,D[G])}return w.toJSON()},P.prototype._checkStatusForError=function(D,w){var L=(w??{error:{}}).error,U=L===void 0?{}:L,G=U.type,Z=U.message;return D===401?new f.default("AUTHENTICATION_REQUIRED","You should provide valid api key to perform this operation",D):D===403?new f.default("NOT_AUTHORIZED","You are not authorized to perform this operation",D):D===404?new f.default("NOT_FOUND",Z??"Could not find what you are looking for",D):D===413?new f.default("REQUEST_TOO_LARGE","Request body is too large",D):D===422?new f.default(G??"UNPROCESSABLE_ENTITY",Z??"The operation cannot be processed",D):D===429?new f.default("TOO_MANY_REQUESTS","You have made too many requests in a short period of time. Please retry your request later",D):D===500?new f.default("SERVER_ERROR","Try again. If the problem persists, contact support.",D):D===503?new f.default("SERVICE_UNAVAILABLE","The service is temporarily unavailable. Please retry shortly.",D):D>=400?new f.default(G??"UNEXPECTED_ERROR",Z??"An unexpected error occurred",D):null},P.prototype.doCall=function(D){return this.table(D)},P.prototype.getId=function(){return this._id},P.createFunctor=function(D,w){var L=new P(D,w),U=function(G){return L.doCall(G)};return U._base=L,U.table=L.table.bind(L),U.makeRequest=L.makeRequest.bind(L),U.runAction=L.runAction.bind(L),U.getId=L.getId.bind(L),U},P}();function C(P){return P!=="GET"&&P!=="DELETE"}function I(P,D){return l.default(D)?null:new f.default("UNEXPECTED_ERROR","The response from Airtable was invalid JSON. Please try again soon.",P)}i.exports=S},{"./abort-controller":1,"./airtable_error":2,"./exponential_backoff_with_jitter":6,"./fetch":7,"./http_headers":9,"./object_to_query_param_string":11,"./package_version":12,"./run_action":16,"./table":17,"lodash/get":77,"lodash/isPlainObject":89,"lodash/keys":93}],4:[function(t,i,r){function s(n,a,l){return l===void 0&&(l=void 0),function(){for(var c=[],h=0;h<arguments.length;h++)c[h]=arguments[h];var u;l===void 0?u=c.length>0?c.length-1:0:u=l;var d=c[u];if(typeof d=="function"){n.apply(a,c);return}else{for(var f=[],_=Math.max(c.length,u),p=0;p<_;p++)f.push(c[p]);return new Promise(function(m,T){f.push(function(b,y){b?T(b):m(y)}),n.apply(a,f)})}}}i.exports=s},{}],5:[function(t,i,r){var s={};function n(a,l,c){return function(){for(var h=[],u=0;u<arguments.length;u++)h[u]=arguments[u];s[l]||(s[l]=!0,console.warn(c)),a.apply(this,h)}}i.exports=n},{}],6:[function(t,i,r){var s=this&&this.__importDefault||function(l){return l&&l.__esModule?l:{default:l}},n=s(t("./internal_config.json"));function a(l){var c=n.default.INITIAL_RETRY_DELAY_IF_RATE_LIMITED*Math.pow(2,l),h=Math.min(n.default.MAX_RETRY_DELAY_IF_RATE_LIMITED,c),u=Math.random()*h;return u}i.exports=a},{"./internal_config.json":10}],7:[function(t,i,r){var s=this&&this.__importDefault||function(l){return l&&l.__esModule?l:{default:l}},n=s(t("node-fetch")),a=typeof window<"u"?window:typeof self<"u"?self:null;i.exports=a?a.fetch.bind(a):n.default},{"node-fetch":20}],8:[function(t,i,r){function s(n,a){return Object.prototype.hasOwnProperty.call(n,a)}i.exports=s},{}],9:[function(t,i,r){var s=this&&this.__importDefault||function(c){return c&&c.__esModule?c:{default:c}},n=s(t("lodash/keys")),a=typeof window<"u",l=function(){function c(){this._headersByLowercasedKey={}}return c.prototype.set=function(h,u){var d=h.toLowerCase();d==="x-airtable-user-agent"&&(d="user-agent",h="User-Agent"),this._headersByLowercasedKey[d]={headerKey:h,headerValue:u}},c.prototype.toJSON=function(){for(var h={},u=0,d=n.default(this._headersByLowercasedKey);u<d.length;u++){var f=d[u],_=this._headersByLowercasedKey[f],p=void 0;a&&f==="user-agent"?p="X-Airtable-User-Agent":p=_.headerKey,h[p]=_.headerValue}return h},c}();i.exports=l},{"lodash/keys":93}],10:[function(t,i,r){i.exports={INITIAL_RETRY_DELAY_IF_RATE_LIMITED:5e3,MAX_RETRY_DELAY_IF_RATE_LIMITED:6e5}},{}],11:[function(t,i,r){var s=this&&this.__importDefault||function(u){return u&&u.__esModule?u:{default:u}},n=s(t("lodash/isArray")),a=s(t("lodash/isNil")),l=s(t("lodash/keys"));function c(u,d,f){if(n.default(d))for(var _=0;_<d.length;_++){var p=d[_];/\[\]$/.test(u)?f(u,p):c(u+"["+(typeof p=="object"&&p!==null?_:"")+"]",p,f)}else if(typeof d=="object")for(var m=0,T=l.default(d);m<T.length;m++){var b=T[m],p=d[b];c(u+"["+b+"]",p,f)}else f(u,d)}function h(u){for(var d=[],f=function(b,y){y=a.default(y)?"":y,d.push(encodeURIComponent(b)+"="+encodeURIComponent(y))},_=0,p=l.default(u);_<p.length;_++){var m=p[_],T=u[m];c(m,T,f)}return d.join("&").replace(/%20/g,"+")}i.exports=h},{"lodash/isArray":79,"lodash/isNil":85,"lodash/keys":93}],12:[function(t,i,r){i.exports="0.11.6"},{}],13:[function(t,i,r){var s=this&&this.__assign||function(){return s=Object.assign||function(b){for(var y,S=1,C=arguments.length;S<C;S++){y=arguments[S];for(var I in y)Object.prototype.hasOwnProperty.call(y,I)&&(b[I]=y[I])}return b},s.apply(this,arguments)},n=this&&this.__importDefault||function(b){return b&&b.__esModule?b:{default:b}},a=n(t("lodash/isFunction")),l=n(t("lodash/keys")),c=n(t("./record")),h=n(t("./callback_to_promise")),u=n(t("./has")),d=t("./query_params"),f=n(t("./object_to_query_param_string")),_=function(){function b(y,S){this._table=y,this._params=S,this.firstPage=h.default(p,this),this.eachPage=h.default(m,this,1),this.all=h.default(T,this)}return b.validateParams=function(y){for(var S={},C=[],I=[],P=0,D=l.default(y);P<D.length;P++){var w=D[P],L=y[w];if(u.default(b.paramValidators,w)){var U=b.paramValidators[w],G=U(L);G.pass?S[w]=L:I.push(G.error)}else C.push(w)}return{validParams:S,ignoredKeys:C,errors:I}},b.paramValidators=d.paramValidators,b}();function p(b){if(!a.default(b))throw new Error("The first parameter to `firstPage` must be a function");this.eachPage(function(y){b(null,y)},function(y){b(y,null)})}function m(b,y){var S=this;if(!a.default(b))throw new Error("The first parameter to `eachPage` must be a function");if(!a.default(y)&&y!==void 0)throw new Error("The second parameter to `eachPage` must be a function or undefined");var C=s({},this._params),I="/"+this._table._urlEncodedNameOrId()+"?"+f.default(C),P={},D=null,w,L;if(C.method==="post"||I.length>d.URL_CHARACTER_LENGTH_LIMIT){D=C,w="post",L="/"+this._table._urlEncodedNameOrId()+"/listRecords";for(var U=Object.keys(C),G=0,Z=U;G<Z.length;G++){var he=Z[G];d.shouldListRecordsParamBePassedAsParameter(he)?P[he]=C[he]:D[he]=C[he]}}else w="get",P=C,L="/"+this._table._urlEncodedNameOrId();var _e=function(){S._table._base.runAction(w,L,P,D,function(ne,Pe,Se){if(ne)y(ne,null);else{var ce=void 0;Se.offset?(C.offset=Se.offset,ce=_e):ce=function(){y(null)};var de=Se.records.map(function(k){return new c.default(S._table,null,k)});b(de,ce)}})};_e()}function T(b){if(!a.default(b))throw new Error("The first parameter to `all` must be a function");var y=[];this.eachPage(function(S,C){y.push.apply(y,S),C()},function(S){S?b(S,null):b(null,y)})}i.exports=_},{"./callback_to_promise":4,"./has":8,"./object_to_query_param_string":11,"./query_params":14,"./record":15,"lodash/isFunction":83,"lodash/keys":93}],14:[function(t,i,r){var s=this&&this.__importDefault||function(u){return u&&u.__esModule?u:{default:u}};Object.defineProperty(r,"__esModule",{value:!0}),r.shouldListRecordsParamBePassedAsParameter=r.URL_CHARACTER_LENGTH_LIMIT=r.paramValidators=void 0;var n=s(t("./typecheck")),a=s(t("lodash/isString")),l=s(t("lodash/isNumber")),c=s(t("lodash/isPlainObject")),h=s(t("lodash/isBoolean"));r.paramValidators={fields:n.default(n.default.isArrayOf(a.default),"the value for `fields` should be an array of strings"),filterByFormula:n.default(a.default,"the value for `filterByFormula` should be a string"),maxRecords:n.default(l.default,"the value for `maxRecords` should be a number"),pageSize:n.default(l.default,"the value for `pageSize` should be a number"),offset:n.default(l.default,"the value for `offset` should be a number"),sort:n.default(n.default.isArrayOf(function(u){return c.default(u)&&a.default(u.field)&&(u.direction===void 0||["asc","desc"].includes(u.direction))}),'the value for `sort` should be an array of sort objects. Each sort object must have a string `field` value, and an optional `direction` value that is "asc" or "desc".'),view:n.default(a.default,"the value for `view` should be a string"),cellFormat:n.default(function(u){return a.default(u)&&["json","string"].includes(u)},'the value for `cellFormat` should be "json" or "string"'),timeZone:n.default(a.default,"the value for `timeZone` should be a string"),userLocale:n.default(a.default,"the value for `userLocale` should be a string"),method:n.default(function(u){return a.default(u)&&["get","post"].includes(u)},'the value for `method` should be "get" or "post"'),returnFieldsByFieldId:n.default(h.default,"the value for `returnFieldsByFieldId` should be a boolean")},r.URL_CHARACTER_LENGTH_LIMIT=15e3,r.shouldListRecordsParamBePassedAsParameter=function(u){return u==="timeZone"||u==="userLocale"}},{"./typecheck":18,"lodash/isBoolean":81,"lodash/isNumber":86,"lodash/isPlainObject":89,"lodash/isString":90}],15:[function(t,i,r){var s=this&&this.__assign||function(){return s=Object.assign||function(_){for(var p,m=1,T=arguments.length;m<T;m++){p=arguments[m];for(var b in p)Object.prototype.hasOwnProperty.call(p,b)&&(_[b]=p[b])}return _},s.apply(this,arguments)},n=this&&this.__importDefault||function(_){return _&&_.__esModule?_:{default:_}},a=n(t("./callback_to_promise")),l=function(){function _(p,m,T){this._table=p,this.id=m||T.id,this.setRawJson(T),this.save=a.default(c,this),this.patchUpdate=a.default(h,this),this.putUpdate=a.default(u,this),this.destroy=a.default(d,this),this.fetch=a.default(f,this),this.updateFields=this.patchUpdate,this.replaceFields=this.putUpdate}return _.prototype.getId=function(){return this.id},_.prototype.get=function(p){return this.fields[p]},_.prototype.set=function(p,m){this.fields[p]=m},_.prototype.setRawJson=function(p){this._rawJson=p,this.fields=this._rawJson&&this._rawJson.fields||{}},_}();function c(_){this.putUpdate(this.fields,_)}function h(_,p,m){var T=this;m||(m=p,p={});var b=s({fields:_},p);this._table._base.runAction("patch","/"+this._table._urlEncodedNameOrId()+"/"+this.id,{},b,function(y,S,C){if(y){m(y);return}T.setRawJson(C),m(null,T)})}function u(_,p,m){var T=this;m||(m=p,p={});var b=s({fields:_},p);this._table._base.runAction("put","/"+this._table._urlEncodedNameOrId()+"/"+this.id,{},b,function(y,S,C){if(y){m(y);return}T.setRawJson(C),m(null,T)})}function d(_){var p=this;this._table._base.runAction("delete","/"+this._table._urlEncodedNameOrId()+"/"+this.id,{},null,function(m){if(m){_(m);return}_(null,p)})}function f(_){var p=this;this._table._base.runAction("get","/"+this._table._urlEncodedNameOrId()+"/"+this.id,{},null,function(m,T,b){if(m){_(m);return}p.setRawJson(b),_(null,p)})}i.exports=l},{"./callback_to_promise":4}],16:[function(t,i,r){var s=this&&this.__importDefault||function(f){return f&&f.__esModule?f:{default:f}},n=s(t("./exponential_backoff_with_jitter")),a=s(t("./object_to_query_param_string")),l=s(t("./package_version")),c=s(t("./fetch")),h=s(t("./abort-controller")),u="Airtable.js/"+l.default;function d(f,_,p,m,T,b,y){var S=f._airtable._endpointUrl+"/v"+f._airtable._apiVersionMajor+"/"+f._id+p+"?"+a.default(m),C={authorization:"Bearer "+f._airtable._apiKey,"x-api-version":f._airtable._apiVersion,"x-airtable-application-id":f.getId(),"content-type":"application/json"},I=typeof window<"u";I?C["x-airtable-user-agent"]=u:C["User-Agent"]=u;var P=new h.default,D=_.toUpperCase(),w={method:D,headers:C,signal:P.signal};T!==null&&(D==="GET"||D==="HEAD"?console.warn("body argument to runAction are ignored with GET or HEAD requests"):w.body=JSON.stringify(T));var L=setTimeout(function(){P.abort()},f._airtable._requestTimeout);c.default(S,w).then(function(U){if(clearTimeout(L),U.status===429&&!f._airtable._noRetryIfRateLimited){var G=n.default(y);setTimeout(function(){d(f,_,p,m,T,b,y+1)},G)}else U.json().then(function(Z){var he=f._checkStatusForError(U.status,Z),_e={};Object.keys(U).forEach(function(ne){_e[ne]=U[ne]}),_e.body=Z,_e.statusCode=U.status,b(he,_e,Z)}).catch(function(){b(f._checkStatusForError(U.status))})}).catch(function(U){clearTimeout(L),b(U)})}i.exports=d},{"./abort-controller":1,"./exponential_backoff_with_jitter":6,"./fetch":7,"./object_to_query_param_string":11,"./package_version":12}],17:[function(t,i,r){var s=this&&this.__assign||function(){return s=Object.assign||function(p){for(var m,T=1,b=arguments.length;T<b;T++){m=arguments[T];for(var y in m)Object.prototype.hasOwnProperty.call(m,y)&&(p[y]=m[y])}return p},s.apply(this,arguments)},n=this&&this.__importDefault||function(p){return p&&p.__esModule?p:{default:p}},a=n(t("lodash/isPlainObject")),l=n(t("./deprecate")),c=n(t("./query")),h=t("./query_params"),u=n(t("./object_to_query_param_string")),d=n(t("./record")),f=n(t("./callback_to_promise")),_=function(){function p(m,T,b){if(!T&&!b)throw new Error("Table name or table ID is required");this._base=m,this.id=T,this.name=b,this.find=f.default(this._findRecordById,this),this.select=this._selectRecords.bind(this),this.create=f.default(this._createRecords,this),this.update=f.default(this._updateRecords.bind(this,!1),this),this.replace=f.default(this._updateRecords.bind(this,!0),this),this.destroy=f.default(this._destroyRecord,this),this.list=l.default(this._listRecords.bind(this),"table.list","Airtable: `list()` is deprecated. Use `select()` instead."),this.forEach=l.default(this._forEachRecord.bind(this),"table.forEach","Airtable: `forEach()` is deprecated. Use `select()` instead.")}return p.prototype._findRecordById=function(m,T){var b=new d.default(this,m);b.fetch(T)},p.prototype._selectRecords=function(m){if(m===void 0&&(m={}),arguments.length>1&&console.warn("Airtable: `select` takes only one parameter, but it was given "+arguments.length+" parameters. Use `eachPage` or `firstPage` to fetch records."),a.default(m)){var T=c.default.validateParams(m);if(T.errors.length){var b=T.errors.map(function(y){return"  * "+y});throw new Error("Airtable: invalid parameters for `select`:\n"+b.join(`
`))}return T.ignoredKeys.length&&console.warn("Airtable: the following parameters to `select` will be ignored: "+T.ignoredKeys.join(", ")),new c.default(this,T.validParams)}else throw new Error("Airtable: the parameter for `select` should be a plain object or undefined.")},p.prototype._urlEncodedNameOrId=function(){return this.id||encodeURIComponent(this.name)},p.prototype._createRecords=function(m,T,b){var y=this,S=Array.isArray(m);b||(b=T,T={});var C;S?C=s({records:m},T):C=s({fields:m},T),this._base.runAction("post","/"+this._urlEncodedNameOrId()+"/",{},C,function(I,P,D){if(I){b(I);return}var w;S?w=D.records.map(function(L){return new d.default(y,L.id,L)}):w=new d.default(y,D.id,D),b(null,w)})},p.prototype._updateRecords=function(m,T,b,y,S){var C=this,I;if(Array.isArray(T)){var P=T;I=a.default(b)?b:{},S=y||b;var D=m?"put":"patch",w=s({records:P},I);this._base.runAction(D,"/"+this._urlEncodedNameOrId()+"/",{},w,function(Z,he,_e){if(Z){S(Z);return}var ne=_e.records.map(function(Pe){return new d.default(C,Pe.id,Pe)});S(null,ne)})}else{var L=T,U=b;I=a.default(y)?y:{},S=S||y;var G=new d.default(this,L);m?G.putUpdate(U,I,S):G.patchUpdate(U,I,S)}},p.prototype._destroyRecord=function(m,T){var b=this;if(Array.isArray(m)){var y={records:m};this._base.runAction("delete","/"+this._urlEncodedNameOrId(),y,null,function(C,I,P){if(C){T(C);return}var D=P.records.map(function(w){var L=w.id;return new d.default(b,L,null)});T(null,D)})}else{var S=new d.default(this,m);S.destroy(T)}},p.prototype._listRecords=function(m,T,b,y){var S=this;y||(y=b,b={});var C="/"+this._urlEncodedNameOrId()+"?"+u.default(b),I,P={},D=null,w;if(typeof b!="function"&&b.method==="post"||C.length>h.URL_CHARACTER_LENGTH_LIMIT){I="/"+this._urlEncodedNameOrId()+"/listRecords",D=s(s({},m&&{pageSize:m}),T&&{offset:T}),w="post";for(var L=Object.keys(b),U=0,G=L;U<G.length;U++){var Z=G[U];h.shouldListRecordsParamBePassedAsParameter(Z)?P[Z]=b[Z]:D[Z]=b[Z]}}else w="get",I="/"+this._urlEncodedNameOrId()+"/",P=s({limit:m,offset:T},b);this._base.runAction(w,I,P,D,function(he,_e,ne){if(he){y(he);return}var Pe=ne.records.map(function(Se){return new d.default(S,null,Se)});y(null,Pe,ne.offset)})},p.prototype._forEachRecord=function(m,T,b){var y=this;arguments.length===2&&(b=T,T=m,m={});var S=p.__recordsPerPageForIteration||100,C=null,I=function(){y._listRecords(S,C,m,function(P,D,w){if(P){b(P);return}for(var L=0;L<D.length;L++)T(D[L]);w?(C=w,I()):b()})};I()},p}();i.exports=_},{"./callback_to_promise":4,"./deprecate":5,"./object_to_query_param_string":11,"./query":13,"./query_params":14,"./record":15,"lodash/isPlainObject":89}],18:[function(t,i,r){function s(n,a){return function(l){return n(l)?{pass:!0}:{pass:!1,error:a}}}s.isOneOf=function(a){return a.includes.bind(a)},s.isArrayOf=function(n){return function(a){return Array.isArray(a)&&a.every(n)}},i.exports=s},{}],19:[function(t,i,r){Object.defineProperty(r,"__esModule",{value:!0});function s(S,C){if(!(S instanceof C))throw new TypeError("Cannot call a class as a function")}function n(S,C){for(var I=0;I<C.length;I++){var P=C[I];P.enumerable=P.enumerable||!1,P.configurable=!0,"value"in P&&(P.writable=!0),Object.defineProperty(S,P.key,P)}}function a(S,C,I){return C&&n(S.prototype,C),I&&n(S,I),S}function l(S,C){if(typeof C!="function"&&C!==null)throw new TypeError("Super expression must either be null or a function");S.prototype=Object.create(C&&C.prototype,{constructor:{value:S,writable:!0,configurable:!0}}),C&&h(S,C)}function c(S){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(I){return I.__proto__||Object.getPrototypeOf(I)},c(S)}function h(S,C){return h=Object.setPrototypeOf||function(P,D){return P.__proto__=D,P},h(S,C)}function u(S){if(S===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return S}function d(S,C){return C&&(typeof C=="object"||typeof C=="function")?C:u(S)}function f(S,C){for(;!Object.prototype.hasOwnProperty.call(S,C)&&(S=c(S),S!==null););return S}function _(S,C,I){return typeof Reflect<"u"&&Reflect.get?_=Reflect.get:_=function(D,w,L){var U=f(D,w);if(U){var G=Object.getOwnPropertyDescriptor(U,w);return G.get?G.get.call(L):G.value}},_(S,C,I||S)}var p=function(){function S(){s(this,S),Object.defineProperty(this,"listeners",{value:{},writable:!0,configurable:!0})}return a(S,[{key:"addEventListener",value:function(I,P){I in this.listeners||(this.listeners[I]=[]),this.listeners[I].push(P)}},{key:"removeEventListener",value:function(I,P){if(I in this.listeners){for(var D=this.listeners[I],w=0,L=D.length;w<L;w++)if(D[w]===P){D.splice(w,1);return}}}},{key:"dispatchEvent",value:function(I){var P=this;if(I.type in this.listeners){for(var D=function(Z){setTimeout(function(){return Z.call(P,I)})},w=this.listeners[I.type],L=0,U=w.length;L<U;L++)D(w[L]);return!I.defaultPrevented}}}]),S}(),m=function(S){l(C,S);function C(){var I;return s(this,C),I=d(this,c(C).call(this)),I.listeners||p.call(u(I)),Object.defineProperty(u(I),"aborted",{value:!1,writable:!0,configurable:!0}),Object.defineProperty(u(I),"onabort",{value:null,writable:!0,configurable:!0}),I}return a(C,[{key:"toString",value:function(){return"[object AbortSignal]"}},{key:"dispatchEvent",value:function(P){P.type==="abort"&&(this.aborted=!0,typeof this.onabort=="function"&&this.onabort.call(this,P)),_(c(C.prototype),"dispatchEvent",this).call(this,P)}}]),C}(p),T=function(){function S(){s(this,S),Object.defineProperty(this,"signal",{value:new m,writable:!0,configurable:!0})}return a(S,[{key:"abort",value:function(){var I;try{I=new Event("abort")}catch{typeof document<"u"?document.createEvent?(I=document.createEvent("Event"),I.initEvent("abort",!1,!1)):(I=document.createEventObject(),I.type="abort"):I={type:"abort",bubbles:!1,cancelable:!1}}this.signal.dispatchEvent(I)}},{key:"toString",value:function(){return"[object AbortController]"}}]),S}();typeof Symbol<"u"&&Symbol.toStringTag&&(T.prototype[Symbol.toStringTag]="AbortController",m.prototype[Symbol.toStringTag]="AbortSignal");function b(S){return S.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL?(console.log("__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL=true is set, will force install polyfill"),!0):typeof S.Request=="function"&&!S.Request.prototype.hasOwnProperty("signal")||!S.AbortController}function y(S){typeof S=="function"&&(S={fetch:S});var C=S,I=C.fetch,P=C.Request,D=P===void 0?I.Request:P,w=C.AbortController,L=C.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL,U=L===void 0?!1:L;if(!b({fetch:I,Request:D,AbortController:w,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:U}))return{fetch:I,Request:G};var G=D;(G&&!G.prototype.hasOwnProperty("signal")||U)&&(G=function(ne,Pe){var Se;Pe&&Pe.signal&&(Se=Pe.signal,delete Pe.signal);var ce=new D(ne,Pe);return Se&&Object.defineProperty(ce,"signal",{writable:!1,enumerable:!1,configurable:!0,value:Se}),ce},G.prototype=D.prototype);var Z=I,he=function(ne,Pe){var Se=G&&G.prototype.isPrototypeOf(ne)?ne.signal:Pe?Pe.signal:void 0;if(Se){var ce;try{ce=new DOMException("Aborted","AbortError")}catch{ce=new Error("Aborted"),ce.name="AbortError"}if(Se.aborted)return Promise.reject(ce);var de=new Promise(function(k,se){Se.addEventListener("abort",function(){return se(ce)},{once:!0})});return Pe&&Pe.signal&&delete Pe.signal,Promise.race([de,Z(ne,Pe)])}return Z(ne,Pe)};return{fetch:he,Request:G}}r.AbortController=T,r.AbortSignal=m,r.abortableFetch=y},{}],20:[function(t,i,r){},{}],21:[function(t,i,r){var s=t("./_hashClear"),n=t("./_hashDelete"),a=t("./_hashGet"),l=t("./_hashHas"),c=t("./_hashSet");function h(u){var d=-1,f=u==null?0:u.length;for(this.clear();++d<f;){var _=u[d];this.set(_[0],_[1])}}h.prototype.clear=s,h.prototype.delete=n,h.prototype.get=a,h.prototype.has=l,h.prototype.set=c,i.exports=h},{"./_hashClear":46,"./_hashDelete":47,"./_hashGet":48,"./_hashHas":49,"./_hashSet":50}],22:[function(t,i,r){var s=t("./_listCacheClear"),n=t("./_listCacheDelete"),a=t("./_listCacheGet"),l=t("./_listCacheHas"),c=t("./_listCacheSet");function h(u){var d=-1,f=u==null?0:u.length;for(this.clear();++d<f;){var _=u[d];this.set(_[0],_[1])}}h.prototype.clear=s,h.prototype.delete=n,h.prototype.get=a,h.prototype.has=l,h.prototype.set=c,i.exports=h},{"./_listCacheClear":56,"./_listCacheDelete":57,"./_listCacheGet":58,"./_listCacheHas":59,"./_listCacheSet":60}],23:[function(t,i,r){var s=t("./_getNative"),n=t("./_root"),a=s(n,"Map");i.exports=a},{"./_getNative":42,"./_root":72}],24:[function(t,i,r){var s=t("./_mapCacheClear"),n=t("./_mapCacheDelete"),a=t("./_mapCacheGet"),l=t("./_mapCacheHas"),c=t("./_mapCacheSet");function h(u){var d=-1,f=u==null?0:u.length;for(this.clear();++d<f;){var _=u[d];this.set(_[0],_[1])}}h.prototype.clear=s,h.prototype.delete=n,h.prototype.get=a,h.prototype.has=l,h.prototype.set=c,i.exports=h},{"./_mapCacheClear":61,"./_mapCacheDelete":62,"./_mapCacheGet":63,"./_mapCacheHas":64,"./_mapCacheSet":65}],25:[function(t,i,r){var s=t("./_root"),n=s.Symbol;i.exports=n},{"./_root":72}],26:[function(t,i,r){var s=t("./_baseTimes"),n=t("./isArguments"),a=t("./isArray"),l=t("./isBuffer"),c=t("./_isIndex"),h=t("./isTypedArray"),u=Object.prototype,d=u.hasOwnProperty;function f(_,p){var m=a(_),T=!m&&n(_),b=!m&&!T&&l(_),y=!m&&!T&&!b&&h(_),S=m||T||b||y,C=S?s(_.length,String):[],I=C.length;for(var P in _)(p||d.call(_,P))&&!(S&&(P=="length"||b&&(P=="offset"||P=="parent")||y&&(P=="buffer"||P=="byteLength"||P=="byteOffset")||c(P,I)))&&C.push(P);return C}i.exports=f},{"./_baseTimes":35,"./_isIndex":51,"./isArguments":78,"./isArray":79,"./isBuffer":82,"./isTypedArray":92}],27:[function(t,i,r){function s(n,a){for(var l=-1,c=n==null?0:n.length,h=Array(c);++l<c;)h[l]=a(n[l],l,n);return h}i.exports=s},{}],28:[function(t,i,r){var s=t("./eq");function n(a,l){for(var c=a.length;c--;)if(s(a[c][0],l))return c;return-1}i.exports=n},{"./eq":76}],29:[function(t,i,r){var s=t("./_castPath"),n=t("./_toKey");function a(l,c){c=s(c,l);for(var h=0,u=c.length;l!=null&&h<u;)l=l[n(c[h++])];return h&&h==u?l:void 0}i.exports=a},{"./_castPath":38,"./_toKey":74}],30:[function(t,i,r){var s=t("./_Symbol"),n=t("./_getRawTag"),a=t("./_objectToString"),l="[object Null]",c="[object Undefined]",h=s?s.toStringTag:void 0;function u(d){return d==null?d===void 0?c:l:h&&h in Object(d)?n(d):a(d)}i.exports=u},{"./_Symbol":25,"./_getRawTag":44,"./_objectToString":70}],31:[function(t,i,r){var s=t("./_baseGetTag"),n=t("./isObjectLike"),a="[object Arguments]";function l(c){return n(c)&&s(c)==a}i.exports=l},{"./_baseGetTag":30,"./isObjectLike":88}],32:[function(t,i,r){var s=t("./isFunction"),n=t("./_isMasked"),a=t("./isObject"),l=t("./_toSource"),c=/[\\^$.*+?()[\]{}|]/g,h=/^\[object .+?Constructor\]$/,u=Function.prototype,d=Object.prototype,f=u.toString,_=d.hasOwnProperty,p=RegExp("^"+f.call(_).replace(c,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function m(T){if(!a(T)||n(T))return!1;var b=s(T)?p:h;return b.test(l(T))}i.exports=m},{"./_isMasked":54,"./_toSource":75,"./isFunction":83,"./isObject":87}],33:[function(t,i,r){var s=t("./_baseGetTag"),n=t("./isLength"),a=t("./isObjectLike"),l="[object Arguments]",c="[object Array]",h="[object Boolean]",u="[object Date]",d="[object Error]",f="[object Function]",_="[object Map]",p="[object Number]",m="[object Object]",T="[object RegExp]",b="[object Set]",y="[object String]",S="[object WeakMap]",C="[object ArrayBuffer]",I="[object DataView]",P="[object Float32Array]",D="[object Float64Array]",w="[object Int8Array]",L="[object Int16Array]",U="[object Int32Array]",G="[object Uint8Array]",Z="[object Uint8ClampedArray]",he="[object Uint16Array]",_e="[object Uint32Array]",ne={};ne[P]=ne[D]=ne[w]=ne[L]=ne[U]=ne[G]=ne[Z]=ne[he]=ne[_e]=!0,ne[l]=ne[c]=ne[C]=ne[h]=ne[I]=ne[u]=ne[d]=ne[f]=ne[_]=ne[p]=ne[m]=ne[T]=ne[b]=ne[y]=ne[S]=!1;function Pe(Se){return a(Se)&&n(Se.length)&&!!ne[s(Se)]}i.exports=Pe},{"./_baseGetTag":30,"./isLength":84,"./isObjectLike":88}],34:[function(t,i,r){var s=t("./_isPrototype"),n=t("./_nativeKeys"),a=Object.prototype,l=a.hasOwnProperty;function c(h){if(!s(h))return n(h);var u=[];for(var d in Object(h))l.call(h,d)&&d!="constructor"&&u.push(d);return u}i.exports=c},{"./_isPrototype":55,"./_nativeKeys":68}],35:[function(t,i,r){function s(n,a){for(var l=-1,c=Array(n);++l<n;)c[l]=a(l);return c}i.exports=s},{}],36:[function(t,i,r){var s=t("./_Symbol"),n=t("./_arrayMap"),a=t("./isArray"),l=t("./isSymbol"),c=1/0,h=s?s.prototype:void 0,u=h?h.toString:void 0;function d(f){if(typeof f=="string")return f;if(a(f))return n(f,d)+"";if(l(f))return u?u.call(f):"";var _=f+"";return _=="0"&&1/f==-c?"-0":_}i.exports=d},{"./_Symbol":25,"./_arrayMap":27,"./isArray":79,"./isSymbol":91}],37:[function(t,i,r){function s(n){return function(a){return n(a)}}i.exports=s},{}],38:[function(t,i,r){var s=t("./isArray"),n=t("./_isKey"),a=t("./_stringToPath"),l=t("./toString");function c(h,u){return s(h)?h:n(h,u)?[h]:a(l(h))}i.exports=c},{"./_isKey":52,"./_stringToPath":73,"./isArray":79,"./toString":96}],39:[function(t,i,r){var s=t("./_root"),n=s["__core-js_shared__"];i.exports=n},{"./_root":72}],40:[function(t,i,r){(function(s){var n=typeof s=="object"&&s&&s.Object===Object&&s;i.exports=n}).call(this,typeof Kp<"u"?Kp:typeof self<"u"?self:typeof window<"u"?window:{})},{}],41:[function(t,i,r){var s=t("./_isKeyable");function n(a,l){var c=a.__data__;return s(l)?c[typeof l=="string"?"string":"hash"]:c.map}i.exports=n},{"./_isKeyable":53}],42:[function(t,i,r){var s=t("./_baseIsNative"),n=t("./_getValue");function a(l,c){var h=n(l,c);return s(h)?h:void 0}i.exports=a},{"./_baseIsNative":32,"./_getValue":45}],43:[function(t,i,r){var s=t("./_overArg"),n=s(Object.getPrototypeOf,Object);i.exports=n},{"./_overArg":71}],44:[function(t,i,r){var s=t("./_Symbol"),n=Object.prototype,a=n.hasOwnProperty,l=n.toString,c=s?s.toStringTag:void 0;function h(u){var d=a.call(u,c),f=u[c];try{u[c]=void 0;var _=!0}catch{}var p=l.call(u);return _&&(d?u[c]=f:delete u[c]),p}i.exports=h},{"./_Symbol":25}],45:[function(t,i,r){function s(n,a){return n==null?void 0:n[a]}i.exports=s},{}],46:[function(t,i,r){var s=t("./_nativeCreate");function n(){this.__data__=s?s(null):{},this.size=0}i.exports=n},{"./_nativeCreate":67}],47:[function(t,i,r){function s(n){var a=this.has(n)&&delete this.__data__[n];return this.size-=a?1:0,a}i.exports=s},{}],48:[function(t,i,r){var s=t("./_nativeCreate"),n="__lodash_hash_undefined__",a=Object.prototype,l=a.hasOwnProperty;function c(h){var u=this.__data__;if(s){var d=u[h];return d===n?void 0:d}return l.call(u,h)?u[h]:void 0}i.exports=c},{"./_nativeCreate":67}],49:[function(t,i,r){var s=t("./_nativeCreate"),n=Object.prototype,a=n.hasOwnProperty;function l(c){var h=this.__data__;return s?h[c]!==void 0:a.call(h,c)}i.exports=l},{"./_nativeCreate":67}],50:[function(t,i,r){var s=t("./_nativeCreate"),n="__lodash_hash_undefined__";function a(l,c){var h=this.__data__;return this.size+=this.has(l)?0:1,h[l]=s&&c===void 0?n:c,this}i.exports=a},{"./_nativeCreate":67}],51:[function(t,i,r){var s=9007199254740991,n=/^(?:0|[1-9]\d*)$/;function a(l,c){var h=typeof l;return c=c??s,!!c&&(h=="number"||h!="symbol"&&n.test(l))&&l>-1&&l%1==0&&l<c}i.exports=a},{}],52:[function(t,i,r){var s=t("./isArray"),n=t("./isSymbol"),a=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,l=/^\w*$/;function c(h,u){if(s(h))return!1;var d=typeof h;return d=="number"||d=="symbol"||d=="boolean"||h==null||n(h)?!0:l.test(h)||!a.test(h)||u!=null&&h in Object(u)}i.exports=c},{"./isArray":79,"./isSymbol":91}],53:[function(t,i,r){function s(n){var a=typeof n;return a=="string"||a=="number"||a=="symbol"||a=="boolean"?n!=="__proto__":n===null}i.exports=s},{}],54:[function(t,i,r){var s=t("./_coreJsData"),n=function(){var l=/[^.]+$/.exec(s&&s.keys&&s.keys.IE_PROTO||"");return l?"Symbol(src)_1."+l:""}();function a(l){return!!n&&n in l}i.exports=a},{"./_coreJsData":39}],55:[function(t,i,r){var s=Object.prototype;function n(a){var l=a&&a.constructor,c=typeof l=="function"&&l.prototype||s;return a===c}i.exports=n},{}],56:[function(t,i,r){function s(){this.__data__=[],this.size=0}i.exports=s},{}],57:[function(t,i,r){var s=t("./_assocIndexOf"),n=Array.prototype,a=n.splice;function l(c){var h=this.__data__,u=s(h,c);if(u<0)return!1;var d=h.length-1;return u==d?h.pop():a.call(h,u,1),--this.size,!0}i.exports=l},{"./_assocIndexOf":28}],58:[function(t,i,r){var s=t("./_assocIndexOf");function n(a){var l=this.__data__,c=s(l,a);return c<0?void 0:l[c][1]}i.exports=n},{"./_assocIndexOf":28}],59:[function(t,i,r){var s=t("./_assocIndexOf");function n(a){return s(this.__data__,a)>-1}i.exports=n},{"./_assocIndexOf":28}],60:[function(t,i,r){var s=t("./_assocIndexOf");function n(a,l){var c=this.__data__,h=s(c,a);return h<0?(++this.size,c.push([a,l])):c[h][1]=l,this}i.exports=n},{"./_assocIndexOf":28}],61:[function(t,i,r){var s=t("./_Hash"),n=t("./_ListCache"),a=t("./_Map");function l(){this.size=0,this.__data__={hash:new s,map:new(a||n),string:new s}}i.exports=l},{"./_Hash":21,"./_ListCache":22,"./_Map":23}],62:[function(t,i,r){var s=t("./_getMapData");function n(a){var l=s(this,a).delete(a);return this.size-=l?1:0,l}i.exports=n},{"./_getMapData":41}],63:[function(t,i,r){var s=t("./_getMapData");function n(a){return s(this,a).get(a)}i.exports=n},{"./_getMapData":41}],64:[function(t,i,r){var s=t("./_getMapData");function n(a){return s(this,a).has(a)}i.exports=n},{"./_getMapData":41}],65:[function(t,i,r){var s=t("./_getMapData");function n(a,l){var c=s(this,a),h=c.size;return c.set(a,l),this.size+=c.size==h?0:1,this}i.exports=n},{"./_getMapData":41}],66:[function(t,i,r){var s=t("./memoize"),n=500;function a(l){var c=s(l,function(u){return h.size===n&&h.clear(),u}),h=c.cache;return c}i.exports=a},{"./memoize":94}],67:[function(t,i,r){var s=t("./_getNative"),n=s(Object,"create");i.exports=n},{"./_getNative":42}],68:[function(t,i,r){var s=t("./_overArg"),n=s(Object.keys,Object);i.exports=n},{"./_overArg":71}],69:[function(t,i,r){var s=t("./_freeGlobal"),n=typeof r=="object"&&r&&!r.nodeType&&r,a=n&&typeof i=="object"&&i&&!i.nodeType&&i,l=a&&a.exports===n,c=l&&s.process,h=function(){try{var u=a&&a.require&&a.require("util").types;return u||c&&c.binding&&c.binding("util")}catch{}}();i.exports=h},{"./_freeGlobal":40}],70:[function(t,i,r){var s=Object.prototype,n=s.toString;function a(l){return n.call(l)}i.exports=a},{}],71:[function(t,i,r){function s(n,a){return function(l){return n(a(l))}}i.exports=s},{}],72:[function(t,i,r){var s=t("./_freeGlobal"),n=typeof self=="object"&&self&&self.Object===Object&&self,a=s||n||Function("return this")();i.exports=a},{"./_freeGlobal":40}],73:[function(t,i,r){var s=t("./_memoizeCapped"),n=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,a=/\\(\\)?/g,l=s(function(c){var h=[];return c.charCodeAt(0)===46&&h.push(""),c.replace(n,function(u,d,f,_){h.push(f?_.replace(a,"$1"):d||u)}),h});i.exports=l},{"./_memoizeCapped":66}],74:[function(t,i,r){var s=t("./isSymbol"),n=1/0;function a(l){if(typeof l=="string"||s(l))return l;var c=l+"";return c=="0"&&1/l==-n?"-0":c}i.exports=a},{"./isSymbol":91}],75:[function(t,i,r){var s=Function.prototype,n=s.toString;function a(l){if(l!=null){try{return n.call(l)}catch{}try{return l+""}catch{}}return""}i.exports=a},{}],76:[function(t,i,r){function s(n,a){return n===a||n!==n&&a!==a}i.exports=s},{}],77:[function(t,i,r){var s=t("./_baseGet");function n(a,l,c){var h=a==null?void 0:s(a,l);return h===void 0?c:h}i.exports=n},{"./_baseGet":29}],78:[function(t,i,r){var s=t("./_baseIsArguments"),n=t("./isObjectLike"),a=Object.prototype,l=a.hasOwnProperty,c=a.propertyIsEnumerable,h=s(function(){return arguments}())?s:function(u){return n(u)&&l.call(u,"callee")&&!c.call(u,"callee")};i.exports=h},{"./_baseIsArguments":31,"./isObjectLike":88}],79:[function(t,i,r){var s=Array.isArray;i.exports=s},{}],80:[function(t,i,r){var s=t("./isFunction"),n=t("./isLength");function a(l){return l!=null&&n(l.length)&&!s(l)}i.exports=a},{"./isFunction":83,"./isLength":84}],81:[function(t,i,r){var s=t("./_baseGetTag"),n=t("./isObjectLike"),a="[object Boolean]";function l(c){return c===!0||c===!1||n(c)&&s(c)==a}i.exports=l},{"./_baseGetTag":30,"./isObjectLike":88}],82:[function(t,i,r){var s=t("./_root"),n=t("./stubFalse"),a=typeof r=="object"&&r&&!r.nodeType&&r,l=a&&typeof i=="object"&&i&&!i.nodeType&&i,c=l&&l.exports===a,h=c?s.Buffer:void 0,u=h?h.isBuffer:void 0,d=u||n;i.exports=d},{"./_root":72,"./stubFalse":95}],83:[function(t,i,r){var s=t("./_baseGetTag"),n=t("./isObject"),a="[object AsyncFunction]",l="[object Function]",c="[object GeneratorFunction]",h="[object Proxy]";function u(d){if(!n(d))return!1;var f=s(d);return f==l||f==c||f==a||f==h}i.exports=u},{"./_baseGetTag":30,"./isObject":87}],84:[function(t,i,r){var s=9007199254740991;function n(a){return typeof a=="number"&&a>-1&&a%1==0&&a<=s}i.exports=n},{}],85:[function(t,i,r){function s(n){return n==null}i.exports=s},{}],86:[function(t,i,r){var s=t("./_baseGetTag"),n=t("./isObjectLike"),a="[object Number]";function l(c){return typeof c=="number"||n(c)&&s(c)==a}i.exports=l},{"./_baseGetTag":30,"./isObjectLike":88}],87:[function(t,i,r){function s(n){var a=typeof n;return n!=null&&(a=="object"||a=="function")}i.exports=s},{}],88:[function(t,i,r){function s(n){return n!=null&&typeof n=="object"}i.exports=s},{}],89:[function(t,i,r){var s=t("./_baseGetTag"),n=t("./_getPrototype"),a=t("./isObjectLike"),l="[object Object]",c=Function.prototype,h=Object.prototype,u=c.toString,d=h.hasOwnProperty,f=u.call(Object);function _(p){if(!a(p)||s(p)!=l)return!1;var m=n(p);if(m===null)return!0;var T=d.call(m,"constructor")&&m.constructor;return typeof T=="function"&&T instanceof T&&u.call(T)==f}i.exports=_},{"./_baseGetTag":30,"./_getPrototype":43,"./isObjectLike":88}],90:[function(t,i,r){var s=t("./_baseGetTag"),n=t("./isArray"),a=t("./isObjectLike"),l="[object String]";function c(h){return typeof h=="string"||!n(h)&&a(h)&&s(h)==l}i.exports=c},{"./_baseGetTag":30,"./isArray":79,"./isObjectLike":88}],91:[function(t,i,r){var s=t("./_baseGetTag"),n=t("./isObjectLike"),a="[object Symbol]";function l(c){return typeof c=="symbol"||n(c)&&s(c)==a}i.exports=l},{"./_baseGetTag":30,"./isObjectLike":88}],92:[function(t,i,r){var s=t("./_baseIsTypedArray"),n=t("./_baseUnary"),a=t("./_nodeUtil"),l=a&&a.isTypedArray,c=l?n(l):s;i.exports=c},{"./_baseIsTypedArray":33,"./_baseUnary":37,"./_nodeUtil":69}],93:[function(t,i,r){var s=t("./_arrayLikeKeys"),n=t("./_baseKeys"),a=t("./isArrayLike");function l(c){return a(c)?s(c):n(c)}i.exports=l},{"./_arrayLikeKeys":26,"./_baseKeys":34,"./isArrayLike":80}],94:[function(t,i,r){var s=t("./_MapCache"),n="Expected a function";function a(l,c){if(typeof l!="function"||c!=null&&typeof c!="function")throw new TypeError(n);var h=function(){var u=arguments,d=c?c.apply(this,u):u[0],f=h.cache;if(f.has(d))return f.get(d);var _=l.apply(this,u);return h.cache=f.set(d,_)||f,_};return h.cache=new(a.Cache||s),h}a.Cache=s,i.exports=a},{"./_MapCache":24}],95:[function(t,i,r){function s(){return!1}i.exports=s},{}],96:[function(t,i,r){var s=t("./_baseToString");function n(a){return a==null?"":s(a)}i.exports=n},{"./_baseToString":36}],airtable:[function(t,i,r){var s=this&&this.__importDefault||function(u){return u&&u.__esModule?u:{default:u}},n=s(t("./base")),a=s(t("./record")),l=s(t("./table")),c=s(t("./airtable_error")),h=function(){function u(d){d===void 0&&(d={});var f=u.default_config(),_=d.apiVersion||u.apiVersion||f.apiVersion;if(Object.defineProperties(this,{_apiKey:{value:d.apiKey||u.apiKey||f.apiKey},_apiVersion:{value:_},_apiVersionMajor:{value:_.split(".")[0]},_customHeaders:{value:d.customHeaders||{}},_endpointUrl:{value:d.endpointUrl||u.endpointUrl||f.endpointUrl},_noRetryIfRateLimited:{value:d.noRetryIfRateLimited||u.noRetryIfRateLimited||f.noRetryIfRateLimited},_requestTimeout:{value:d.requestTimeout||u.requestTimeout||f.requestTimeout}}),!this._apiKey)throw new Error("An API key is required to connect to Airtable")}return u.prototype.base=function(d){return n.default.createFunctor(this,d)},u.default_config=function(){return{endpointUrl:"https://api.airtable.com",apiVersion:"0.1.0",apiKey:"",noRetryIfRateLimited:!1,requestTimeout:300*1e3}},u.configure=function(d){var f=d.apiKey,_=d.endpointUrl,p=d.apiVersion,m=d.noRetryIfRateLimited,T=d.requestTimeout;u.apiKey=f,u.endpointUrl=_,u.apiVersion=p,u.noRetryIfRateLimited=m,u.requestTimeout=T},u.base=function(d){return new u().base(d)},u.Base=n.default,u.Record=a.default,u.Table=l.default,u.Error=c.default,u}();i.exports=h},{"./airtable_error":2,"./base":3,"./record":15,"./table":17}]},{},["airtable"])("airtable")})})(WE);var rU=WE.exports;const sU=zE(rU),nU="appg2Xvh66cswcER5",aU="patHKCwKls2fxnxnr.b589eaa90a90425e99c72d15487c2c062da1f3f9decddc4b127dec7aae22128d",Zm=new sU({apiKey:aU}).base(nU);let Hx=[];function XE(o,e,t){return new Promise((i,r)=>{Zm(o).select(e).eachPage(function(n,a){n.forEach(t),a()},function(n){n&&r(n),i()})})}async function oU(){return await XE("Avatar Assets",{view:"all_presets"},function(o){if(o.get("showInBuilder")===!0){let e=JSON.parse(o.get("JSON"));e.headImage=o.get("headImage"),Hx.push(e)}}),Hx}function lU(o){return new Promise((e,t)=>{Zm("AVB_Built_Avatars").create(o,(i,r)=>{i?(console.error(i),t(i)):e(r)})})}function cU(o,e){return new Promise((t,i)=>{Zm("AVB_Built_Avatars").update(o,e,(r,s)=>{r?(console.error(r),i(r)):t(s)})})}async function hU(o){let e;return await XE("AVB_Built_Avatars",{view:"all_built_avatars",filterByFormula:`({createdAvatarId}='${o}')`},function(t){e=t.getId()}),e}function qp(o,e){const t={success:{text:"SUCCESS! ",color:"#3cb043",icon:"fa-check-circle"},error:{text:"ERROR! ",color:"#ff0000",icon:"fa-times-circle"}},{text:i,color:r,icon:s}=t[o];let n=i+e,a=r,l=s;const c=document.createElement("style");c.textContent=`
    *, *::before, *::after {
      box-sizing: border-box;
    }
    .container {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      min-height: 100vh;
    }
    .toast {
      position: fixed;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%) translateY(calc(100% + 25px));
      width: fit-content;
      background: #FFF;
      padding: 0px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 12px;
      border-left: 3px solid ${a};
      overflow: hidden;
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.35);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
    }
    .toast.active {
      transform: translateX(-50%) translateY(0);
    }
  `,document.head.appendChild(c);const h=document.createElement("div");h.classList.add("container");const u=document.createElement("div");u.classList.add("toast"),u.id="toast";const d=document.createElement("i");d.classList.add("fas",l),d.style.color=a,d.style.marginRight="10px",u.appendChild(d);const f=document.createElement("p");f.classList.add("toast-text"),f.textContent=n,u.appendChild(f),h.appendChild(u),document.body.appendChild(h),u.classList.add("active"),setTimeout(()=>{u.classList.remove("active"),setTimeout(()=>{document.body.removeChild(h),document.head.removeChild(c)},500)},5e3)}function Wx(o,e,t,i){const r=(T,b,y,S)=>{const C=document.createElement("button"),I=document.createElement("span");I.textContent=T;const P=document.createElement("span");return P.style.display="none",C.appendChild(I),C.appendChild(P),C.style.cssText=`align-items:center;display:inline-flex;flex-direction:row;justify-content:center;font-weight:500;line-height:1.715em;text-align:center;text-decoration:none;vertical-align:middle;cursor:pointer;text-transform:none;user-select:none!important;outline:0!important;border:2px solid #0000;color:#fff!important;min-height:32px;opacity:1!important;transition:background .3s ease;width:200px;border-radius:8px;font-size:16px;height:48px;padding:0 16px;background:${b}!important;border-color:${b};margin-left:16px;position:absolute;${y}:20px;`,C.onclick=()=>S(I,P),C};let s;switch(o){case"save":s="Do you want to upload this Avatar into your organisation?";break;case"update":s="Do you want to update this Avatar in your organisation?";break;case"delete":s="Do you want to delete this Avatar from your organisation?";break;default:s="Do you want to upload this Avatar into your organisation?"}const n=document.createElement("div");n.style.cssText="z-index:10;direction:ltr;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased;font-family:Roboto,-apple-system,Helvetica Neue,Helvetica,Arial,sans-serif;font-size:14px;line-height:1.5;color:#2a3746;--q-transition-duration:300ms;-webkit-tap-highlight-color:transparent;box-sizing:inherit;text-align:center;background:#fff;border:1px solid #e1e6ec;box-shadow:0 8px 24px -6px #00000029,0 0 1px #0006;min-width:620px;border-radius:4px;overflow:auto;pointer-events:all;will-change:scroll-position;max-height:calc(100vh - 48px);max-width:560px;padding:60px 78px;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);";const a=document.createElement("button");a.innerHTML="&times;",a.style.cssText="position:absolute;top:10px;right:10px;font-size:20px;border:none;background:transparent;color:#2a3746;cursor:pointer;",a.onclick=()=>n.remove(),n.appendChild(a);const l=document.createElement("h2");l.textContent=s,l.style.fontWeight="bold",n.appendChild(l);const c=document.createElement("div");n.appendChild(c);const h=document.createElement("label");h.textContent="Name:",c.appendChild(h);const u=document.createElement("span");u.textContent=e,c.appendChild(u);const d=document.createElement("br");c.appendChild(d);const f=document.createElement("br");c.appendChild(f);const _=document.createElement("img");_.style.maxHeight="35vh",_.src=t,c.appendChild(_);const p=r("Cancel","#ff1900","left",()=>n.remove());n.appendChild(p);const m=r("Save","#1e58f2","right",async(T,b)=>{T.style.display="none",b.style.display="inline-block",b.innerHTML='<i class="fas fa-spinner fa-spin" style="font-size: 16px;"></i>';try{i().then(()=>{b.style.display="none",T.style.display="inline-block",n.remove(),qp("success","You saved your avatar. Please reload Plural to see your new Avatar.")})}catch(y){console.error("Error saving avatar:",y),b.style.display="none",T.style.display="inline-block",qp("error","Something went wrong while trying to save your Avatar into our database.")}});n.appendChild(m),document.body.appendChild(n)}function uU(o){return new Promise(async(e,t)=>{let i=new Headers;i.append("Authorization","Bearer "+o.token);let r={method:"GET",headers:i,redirect:"follow"};try{const n=await(await fetch("https://"+o.env+"/api/v6/avatars",r)).json(),a=[];for(let l=0;l<n.items.length;l++){const c=JSON.parse(n.items[l].jsonFile);c!==null&&typeof c=="object"&&(c.name=n.items[l].name,c.headImage=n.items[l].headImageUri,c.savedAvatarId=n.items[l].id,a.push(c))}e(a)}catch(s){console.log("error",s),t(s)}})}async function Zc(o,e,t,i){let r=new Headers;r.append("Authorization","Bearer "+o.token);let s=new FormData;const n=t==="glb"?"application/octet-stream":"image/png",a=new File([e],`${i}.${t}`,{type:n});s.append("file",a);let l={method:"POST",headers:r,body:s,redirect:"follow"},c="/api/v2/media/upload";t==="glb"&&(c=`/api/v6/avatars/media?id=${i}`);try{const u=await(await fetch("https://"+o.env+c,l)).text();return console.log(JSON.parse(u).url),JSON.parse(u).url}catch(h){console.log("error",h)}}async function dU(o,e,t,i,r,s){let n=new Headers;n.append("Authorization","Bearer "+o.token),n.append("Content-Type","application/json");let a=JSON.parse(r).name,l=JSON.parse(r).preset.gender,c=JSON.stringify({id:s,name:a,glbUri:i,headImageUri:e,bodyImageUri:t,voiceModel:l.toUpperCase(),jsonFile:r}),h={method:"POST",headers:n,body:c,redirect:"follow"};try{const d=await(await fetch("https://"+o.env+"/api/v6/avatars",h)).json();return console.log(d),d.creationId}catch(u){console.log("error",u)}}async function fU(o,e,t,i,r,s){console.log("Updating avatar: "+s);let n=new Headers;n.append("Authorization","Bearer "+o.token),n.append("Content-Type","application/json");let a=JSON.parse(r).name,l=JSON.parse(r).preset.gender,c=JSON.stringify({id:s,name:a,glbUri:i,headImageUri:e,bodyImageUri:t,voiceModel:l.toUpperCase(),jsonFile:r}),h={method:"PATCH",headers:n,body:c,redirect:"follow"};try{const d=await(await fetch("https://"+o.env+"/api/v6/avatars/"+s,h)).json();return console.log(d),d.creationId}catch(u){console.log("error",u)}}function _U(o,e,t,i,r){return new Promise(async(s,n)=>{try{const a=crypto.randomUUID(),l=await Zc(o,e,"png",a),c=await Zc(o,t,"png",a),h=await Zc(o,i,"glb",a),u=await dU(o,l,c,h,r,a);console.log("ID of the created avatar is: "+u),lU([{fields:{Name:JSON.parse(r).name,JSON:r,"User-ID":o.customerMail,"Orga-ID":o.orgId,headImageUri:l,bodyImageUri:c,glbFileUri:h,createdAvatarId:u}}]),s(u)}catch(a){n(a)}})}function pU(o,e,t,i,r,s){return new Promise(async(n,a)=>{try{const l=await Zc(o,e,"png",s),c=await Zc(o,t,"png",s),h=await Zc(o,i,"glb",s),u=await fU(o,l,c,h,r,s);console.log("ID of the created avatar is: "+u);const d=await hU(s);cU([{id:d,fields:{Name:JSON.parse(r).name,JSON:r,"User-ID":o.customerMail,"Orga-ID":o.orgId,headImageUri:l,bodyImageUri:c,glbFileUri:h,createdAvatarId:u}}]),n(u)}catch(l){a(l)}})}const mU=()=>Object.fromEntries(new URLSearchParams(window.location.search));let lf;window.location.href.indexOf("localhost")>-1?lf=!0:lf=!1;const Yo=mU();let Jc="plural-dev.azureedge.net";Yo.env==="dev.plural.io"||lf?Jc="plural-dev.azureedge.net":Yo.env==="staging.plural.io"?Jc="plural-staging.azureedge.net":Yo.env==="go.plural.io"&&(Jc="plural.azureedge.net");let $E=[];async function gU(){$E=(await(await fetch(`https://${Jc}/avatars/assets/animations/AnimationList.json`)).json()).animations}gU();var Qp=document.getElementById("renderCanvas"),co=null,YE=null,Dd=null,Xx=function(){return new q(Qp,!0,{preserveDrawingBuffer:!0,stencil:!0,disableWebGL2Support:!1})};Yo.su==="nao"&&(console.log(Yo.su),document.querySelectorAll(".advanced").forEach(e=>{e.classList.remove("advanced")}));let eh=null;function vU(){const o=new URLSearchParams(window.location.search);navigator.clipboard.writeText("?"+o)}document.getElementById("copyAuthToken").onclick=vU;fo.prototype.displayLoadingUI=function(){if(document.getElementById("customLoadingScreenDiv")){document.getElementById("customLoadingScreenDiv").style.display="initial";return}};fo.prototype.hideLoadingUI=function(){document.getElementById("loadingSpinner").remove()};var xU=function(){co.displayLoadingUI();var o=new Ne(co);const e=new Bl("light1",new x(1.2,1,-1.2),o);e.diffuse=new ge(0,4,12),e.specular=new ge(0,4,12),e.intensity=0;const t=new Bl("light2",new x(-1,1.2,1.5),o);t.diffuse=new ge(17,16,14),t.specular=new ge(15,15,15),t.intensity=0;var i=new Bn("light3",new x(0,-.5,-1),o);i.position=new x(0,5,5),i.intensity=0;var r=new lt(1024,i);r.useBlurExponentialShadowMap=!0,r.blurKernel=32;var s=o.createDefaultEnvironment({enableGroundShadow:!0});s.setMainColor(ge.White()),s.ground.position.y+=.01,o.environmentTexture=new ns("environment.env",o),o.environmentTexture.rotationY=1.3,o.environmentIntensity=1;var n=new Ei("camera1",Math.PI/2,Math.PI/2,3,new x(0,1,0),o);n.attachControl(Qp,!0),n.setPosition(new x(0,1,8)),n.minZ=.1,n.lowerRadiusLimit=.8,n.upperRadiusLimit=5,n.wheelDeltaPercentage=.01,n.upperBetaLimit=1.8;let a=(ve,Ue,Je)=>{var Ke=new ae("myAnimationcamera","position",60,ae.ANIMATIONTYPE_VECTOR3,ae.ANIMATIONLOOPMODE_CONSTANT);const Xe=[];Xe.push({frame:0,value:n.position.clone()}),Xe.push({frame:60,value:new x(ve,Ue,Je)}),Ke.setKeys(Xe);const Nt=new sv;Nt.setEasingMode(xs.EASINGMODE_EASEOUT),Ke.setEasingFunction(Nt),n.animations.push(Ke),o.beginAnimation(n,0,60,!1)};function l(ve,Ue,Je){var Ke=new ae("lookcam","target",60,ae.ANIMATIONTYPE_VECTOR3,ae.ANIMATIONLOOPMODE_CONSTANT);const Xe=[];Xe.push({frame:0,value:n.target.clone()}),Xe.push({frame:60,value:new x(ve,Ue,Je)}),Ke.setKeys(Xe);const Nt=new sv;Nt.setEasingMode(xs.EASINGMODE_EASEOUT),Ke.setEasingFunction(Nt),n.animations.push(Ke),o.beginAnimation(n,0,60,!1)}let c=(ve,Ue,Je)=>{for(let Ke=0;Ke<ve.length;Ke++)ve[Ke].classList.remove(Ue);ve[Je].classList.add(Ue)};function h(ve){const Ue=Ke=>{document.querySelectorAll(Ke).forEach(Xe=>{Xe.style.display="none"})},Je=Ke=>{document.querySelectorAll(Ke).forEach(Xe=>{Xe.style.display="block",Xe.style.setProperty("background-color","white","important")})};Ue(".hiddenByDefault"),document.querySelectorAll(".main-conf-button").forEach(Ke=>{Ke.style.setProperty("background-color","transparent","important")}),ve.contains("head")?Je(".head"):ve.contains("clothing")?Je(".clothing"):ve.contains("accessories")&&Je(".accessories")}let u=(ve,Ue)=>{for(let Je=0;Je<ve.length;Je++)ve[Je].addEventListener("click",()=>{ve[Je].classList.contains("main-conf-button")&&(h(ve[Je].classList),ve[Je].style.setProperty("background-color","white","important")),c(ve,Ue,Je)})},d=(ve,Ue)=>{for(let Je=0;Je<ve.length;Je++)ve[Je].addEventListener("click",()=>{m||c(ve,Ue,Je)})},f=(ve,Ue)=>{for(let Je=0;Je<ve.length;Je++)ve[Je].addEventListener("click",()=>{ve[Je].classList.toggle(Ue)})};function _(ve,Ue,Je){let Ke=0;if(ve.forEach(Xe=>{Xe[0].isVisible&&Ke++}),Ke>1)Ue.forEach(Xe=>{Xe.forEach(Nt=>{Nt.isVisible=!1})});else for(let Xe=0;Xe<Ue.length;Xe++)Ue[Xe][0].isVisible&&c(Je,"conf-button-act",Xe)}let p=(ve,Ue,Je)=>{for(let Ke=0;Ke<ve.length;Ke++)if(!ve[Ke].startsWith("facial")){let Xe=document.getElementsByClassName(Ue)[0],Nt=document.createElement("div");Nt.classList.add("conf-button",Je);let wi=document.createElement("H5");wi.style.margin="20px",Nt.style.width="auto",wi.innerHTML=ve[Ke],Xe.appendChild(Nt),Nt.appendChild(wi)}},m=!1;async function T(ve,Ue){m=!0;let Je=`https://${Jc}/avatars/assets/animations/anim_`+ve+".glb",Ke=await ft.ImportMeshAsync("",Je,null,o);Ke.meshes.forEach(Nt=>{Nt.isVisible=!1});let Xe=Ke.animationGroups[0].clone(`${Ke.animationGroups[0].name}`,Nt=>Zt[0].getChildren(wi=>wi.name===Nt.name,!1)[0],!0);ve!=="facial_idle_1"?(Ge.push(Xe),Xe.pause(),Xe.setWeightForAllAnimatables(0),Xe.name=="idle_1"&&(Xe.play(!0),Xe.setWeightForAllAnimatables(1)),Xe.index=Ge.length-1,Xe._targetedAnimations.forEach(Nt=>{Nt.animation.enableBlending=!0,Nt.animation.blendingSpeed=.03})):(Ut.push(Xe),Xe.play(!0),Xe.setWeightForAllAnimatables(1)),Ke.meshes.forEach(Nt=>{Nt.dispose()}),Ke.animationGroups.forEach(Nt=>{Nt.dispose()}),ve.startsWith("facial_")?Xe.downloadable=!0:Xe.downloadable=!1,Ue=="download"&&(Xe.downloadable=!0),Ue=="play"&&L(Xe.index),m=!1}async function b(ve){let Ue=await ft.ImportMeshAsync("","avatar_poses/anim_pose_"+ve+".glb",null,o,Ke=>{});Ue.meshes.forEach(Ke=>{Ke.isVisible=!1});let Je=Ue.animationGroups[0].clone(`${Ue.animationGroups[0].name}`,Ke=>Zt[0].getChildren(Xe=>Xe.name===Ke.name,!1)[0],!0);Ft.push(Je),Je.stop(),Ue.meshes.forEach(Ke=>{Ke.dispose()}),Ue.animationGroups.forEach(Ke=>{Ke.dispose()})}function y(ve,Ue){if(ve===Ue)return ve;var Je=Math.random();return Math.round(Je*(Ue-ve)+ve)}let S=(ve,Ue,Je,Ke)=>{ve[Ke].classList.contains(Je)&&Ue[Ke].forEach(Xe=>{Xe.isVisible=!0}),ve[Ke].classList.contains(Je)||Ue[Ke].forEach(Xe=>{Xe.isVisible=!1})},C=(ve,Ue,Je,Ke,Xe)=>{let Nt=ve.getChildTransformNodes().find(wi=>wi.id===Ue);for(let wi=0;wi<Nt._children.length;wi++){let _i=ve.getChildTransformNodes().find(Pr=>Pr.id===Nt._children[wi].id);if(_i._children!=null){let Pr=[];for(let Ji=0;Ji<_i._children.length;Ji++)Pr[Ji]=_i.getChildTransformNodes().find(yi=>yi.id===_i._children[Ji].id);Xe?_i.name.startsWith("female")?Je.push(Pr):(_i.name.startsWith("male")||Je.push(Pr),Ke.push(Pr)):Je.push(Pr)}else Xe?_i.name.startsWith("female")?Je.push([_i]):_i.name.startsWith("male")?Ke.push([_i]):(Je.push([_i]),Ke.push([_i])):Je.push([_i])}},I=[],P=(ve,Ue,Je,Ke,Xe)=>{for(let Nt=0;Nt<ve.length;Nt++){let wi=document.getElementsByClassName(Ue)[0],_i=document.createElement("div");_i.classList.add("conf-button",Je),Nt==Ke&&_i.classList.add("conf-button-act",Je);let Pr=document.createElement("H5"),Ji=document.createElement("H5");if(Pr.style.margin="20px",Pr.style.color="transparent",Ji.style.color="transparent",ve[Nt].length==null){let yi=ve[Nt].name,Ci=yi.includes("_geo_primitive0")?yi.replace("_geo_primitive0",""):yi.includes("_geo2_primitive0")?yi.replace("_geo2_primitive0",""):yi.includes("_geo")?yi.replace("_geo",""):yi;Ci.includes("_eye_")?_i.style.background="url(/img/icons/thumbnails/thumbnail_"+Ci+".png) center / 110% no-repeat":_i.style.background="url(/img/icons/thumbnails/thumbnail_"+Ci+".png) center / 90% no-repeat",Pr.innerHTML=Nt+1+"<br>"+yi}else{let yi=ve[Nt][0].name,Ci=yi.includes("_geo_primitive0")?yi.replace("_geo_primitive0",""):yi.includes("_geo2_primitive0")?yi.replace("_geo2_primitive0",""):yi.includes("_geo")?yi.replace("_geo",""):yi;Ci.includes("_eye_")?_i.style.background="url(/img/icons/thumbnails/thumbnail_"+Ci+".png) center / 110% no-repeat":_i.style.background="url(/img/icons/thumbnails/thumbnail_"+Ci+".png) center / 90% no-repeat",Pr.innerHTML=Nt+1+"<br>"+yi}if(Ji.innerHTML=Nt+1,wi.appendChild(_i),_i.appendChild(Ji),_i.appendChild(Pr),I.push(_i),_i.children[1].style.display="none",Xe&&Nt==ve.length-1){let yi=document.getElementsByClassName(Ue)[0],Ci=document.createElement("div");Ci.classList.add("conf-button",Je),Ci.classList.add("conf-button-act",Je);let Mr=document.createElement("H5");yi.appendChild(Ci),Ci.appendChild(Mr)}}};showNodeNames.onchange=()=>{for(let ve=0;ve<I.length;ve++)showNodeNames.checked?(I[ve].children[0].style.display="none",I[ve].children[1].style.display="block",I[ve].children[1].style.color="#000000"):(I[ve].children[0].style.display="block",I[ve].children[1].style.display="none")};let D=(ve,Ue)=>{_t(),ve.forEach(Je=>{Je.forEach(Ke=>{Ke.isVisible=!1})}),ve[Ue].forEach(Je=>{Je.isVisible=!0})},w=(ve,Ue,Je)=>{if(mt==ve){for(let Ke=0;Ke<Ue.length;Ke++)Ue[Ke].style.display="none";for(let Ke=0;Ke<Je.length;Ke++)Je[Ke].style.display="flex"}};function L(ve){Ge[De].stop(),Ge[De].setWeightForAllAnimatables(0),De=ve,Ge[De].play(!0),Ge[De].setWeightForAllAnimatables(1)}let U=document.getElementById("conf-right-width"),G=2048,Z=2048;var he=new fabric.Canvas("paintCanvas",{width:G,height:Z,backgroundColor:"#FFFFFF",selectionColor:"transparent",selectionLineWidth:3,borderColor:"red",cornerColor:"orange",cornerSize:10}),_e=he.getElement(),je=he.upperCanvasEl,st=_e.parentNode,be=U.offsetWidth*2+"px",We=U.offsetWidth*2+"px";paintCanvasParent.style.width=paintCanvasParent.style.height=U.offsetWidth*.95+"px",_e.style.width=je.style.width=st.style.width=be,_e.style.height=je.style.height=st.style.height=We;var ne=new za("dyntex",paintCanvas,o,!0),Pe=new fabric.Canvas("paintCanvasFullBody",{width:G,height:Z,backgroundColor:"#FFFFFF",selectionColor:"transparent",selectionLineWidth:3,borderColor:"red",cornerColor:"orange",cornerSize:10}),Se=Pe.getElement(),je=Pe.upperCanvasEl,st=Se.parentNode,be=U.offsetWidth*2+"px",We=U.offsetWidth*2+"px";paintCanvasFullBodyParent.style.width=paintCanvasFullBodyParent.style.height=U.offsetWidth*.95+"px",Se.style.width=je.style.width=st.style.width=be,Se.style.height=je.style.height=st.style.height=We;var ce=new za("dyntexfullbody",paintCanvasFullBody,o,!0),de=new fabric.Canvas("paintCanvasTopsTop",{width:G,height:Z,backgroundColor:"#FFFFFF",selectionColor:"transparent",selectionLineWidth:3,borderColor:"red",cornerColor:"orange",cornerSize:10}),k=de.getElement(),je=de.upperCanvasEl,st=k.parentNode,be=U.offsetWidth*1.5+"px",We=U.offsetWidth*1.5+"px";k.style.width=je.style.width=st.style.width=be,k.style.height=je.style.height=st.style.height=We,paintCanvasTopsTopParent.style.width=paintCanvasTopsTopParent.style.height=U.offsetWidth*.95+"px";var se=new za("dyntexfullbody",paintCanvasTopsTop,o,!0),xe=new fabric.Canvas("paintCanvasTopsMiddle",{width:G,height:Z,backgroundColor:"#FFFFFF",selectionColor:"transparent",selectionLineWidth:3,borderColor:"red",cornerColor:"orange",cornerSize:10}),le=xe.getElement(),je=xe.upperCanvasEl,st=le.parentNode,be=U.offsetWidth*2+"px",We=U.offsetWidth*2+"px";le.style.width=je.style.width=st.style.width=be,le.style.height=je.style.height=st.style.height=We,paintCanvasTopsMiddleParent.style.width=paintCanvasTopsMiddleParent.style.height=U.offsetWidth*.95+"px";var Ct=new za("dyntexfullbody",paintCanvasTopsMiddle,o,!0);function _t(){he.discardActiveObject(),he.renderAll(),Pe.discardActiveObject(),Pe.renderAll(),de.discardActiveObject(),de.renderAll(),xe.discardActiveObject(),xe.renderAll()}Qp.onclick=()=>{_t()},document.addEventListener("click",function(Ue){!he.upperCanvasEl.contains(Ue.target)&&!Pe.upperCanvasEl.contains(Ue.target)&&!de.upperCanvasEl.contains(Ue.target)&&!xe.upperCanvasEl.contains(Ue.target)&&_t()});let mt="female",Ge=[],Ut=[],Ft=[],Zt=[],$t=[],Di=[],Ui=[],ar=[],ti=[],or=[],pi=[],Si=[],mi=[],Is=[],cn=[],Js=[],Ur=[],Zn=[],Un=[],Es=[],Ps=[],en=[],zi=[],os=[],ls=[],Ir=[],zs=[],Vr=[],Ni=[],Ms=[],fr=[],hn=[],Ii=[],re=[],Fe=[],De=0,At=[!1],un=[],tn=[],Qu=[],Pa=[],Zu=[],Za=[],Ju=[],Ma=[],Mh={},Oh;lf?Oh="https://raw.githubusercontent.com/veljko85/avatar_configurator/gh-pages/public/avatar_meshes.glb":Oh=`https://${Jc}/avatars/assets/avatar_meshes.glb`,ft.ImportMeshAsync("",Oh,null,o,ve=>{let Ue=0;if(ve.lengthComputable)Ue=(ve.loaded*100/ve.total).toFixed();else{const Je=ve.loaded/1048576;Ue=Math.floor(Je*100)/100}loadingPercentages.innerHTML=`${Ue}%`}).then(ve=>{for(let ue=0;ue<ve.meshes.length;ue++)Zt.push(ve.meshes[ue]),ve.meshes[ue].isVisible=!1,ue!=0&&(ve.meshes[ue].material.backFaceCulling=!1);let Ue=ve.meshes[0];r.addShadowCaster(Ue,!0),o.getMaterialByName("m_transparent").metallic=.1,generatePropsBtn.onclick=()=>{let ue=propsJson.value;ue=JSON.parse(ue),ue=ue.preset,iU(ue,o,ge,D,Ke,c,Je,Di,wi,Ur,_i,Ui,$t,Xe,Zn,Js,Nt,Fe,Pr,Vr,Ji,Un,yi,ar,ti,Ci,or,Os,pi,Hs,Es,Ps,Mr,en,hs,zi,Ws,he,xe,de,Pe,Si,rn,os,sn,At,mi,qr,ls,Qr,Ni,Xs,fr,Is,Ir,fn,_n,hn,Da,Ms,ta,Ii,Cn,re,Ja,colorPickerHolderHair,colorPickerHolderBottoms,colorPickerHolderFullBody,colorPickerHolderFullBodyBtns,colorPickerHolderFullBodySecond,colorPickerHolderHats,colorPickerHolderBelts,tn,un,Qu,Pa,Zu,Za,Ju,Ma,Mh)};let Je=document.getElementsByClassName("gender-parts");u(Je,"conf-button-act");function Ke(ue){if(ue==0){if(Zt.forEach(oi=>{oi.isVisible=!1}),cn.forEach(oi=>{oi.forEach(Zr=>{Zr.isVisible=!0})}),mt="female",w("female",_i,wi),w("female",Nt,Xe),w("female",Mr,Ci),w("female",hs,Os),w("female",Ws,Hs),w("female",sn,rn),w("female",Qr,qr),w("female",_n,fn),ti.length>0){topsNavBtnBase.style.display="flex";let oi=0,Zr=0,eo=0;ti.forEach(Mo=>{Mo.forEach(xa=>{xa.material.name==="m_tops_base_1"&&(oi+=1),xa.material.name==="m_tops_base_buttons_1"&&(Zr+=1),xa.material.name==="m_tops_base_2"&&(eo+=1)})}),oi>0?topsBaseColorOneHolderContainer.style.display="block":topsBaseColorOneHolderContainer.style.display="none",Zr>0?topsBaseColorBtnHolderContainer.style.display="block":topsBaseColorBtnHolderContainer.style.display="none",eo>0?topsBaseColorTwoHolderContainer.style.display="block":topsBaseColorTwoHolderContainer.style.display="none"}else topsNavBtnBase.style.display="none";or.length>0?topsNavBtnMiddle.style.display="flex":topsNavBtnMiddle.style.display="none",pi.length>0?topsNavBtnTop.style.display="flex":topsNavBtnTop.style.display="none";let Le=0,Ot=0,va=0;mi.forEach(oi=>{oi.forEach(Zr=>{Zr.material.name==="m_fullbody_1"&&(Le+=1),Zr.material.name==="m_fullbody_buttons"&&(Ot+=1),Zr.material.name==="m_fullbody_2"&&(va+=1)})}),Le>0?fullBodyColorOneHolderContainer.style.display="block":fullBodyColorOneHolderContainer.style.display="none",Ot>0?fullBodyColorBtnHolderContainer.style.display="block":fullBodyColorBtnHolderContainer.style.display="none",va>0?fullBodyColorTwoHolderContainer.style.display="block":fullBodyColorTwoHolderContainer.style.display="none";for(let oi=0;oi<Xs.length;oi++)Ni[oi][0].name==="shoes_fancy_1_geo"&&(Xs[oi].style.display="none"),Ni[oi][0].name==="shoes_female_heels_1_geo"&&(Xs[oi].style.display="flex");headwearTextureContainer.style.display="none"}if(ue==1){if(Zt.forEach(oi=>{oi.isVisible=!1}),zs.forEach(oi=>{oi.forEach(Zr=>{Zr.isVisible=!0})}),mt="male",w("male",wi,_i),w("male",Xe,Nt),w("male",Ci,Mr),w("male",Os,hs),w("male",Hs,Ws),w("male",rn,sn),w("male",qr,Qr),w("male",fn,_n),Ps.length>0){topsNavBtnBase.style.display="flex";let oi=0,Zr=0,eo=0;Ps.forEach(Mo=>{Mo.forEach(xa=>{xa.material.name==="m_tops_base_1"&&(oi+=1),xa.material.name==="m_tops_base_buttons_1"&&(Zr+=1),xa.material.name==="m_tops_base_2"&&(eo+=1)})}),oi>0?topsBaseColorOneHolderContainer.style.display="block":topsBaseColorOneHolderContainer.style.display="none",Zr>0?topsBaseColorBtnHolderContainer.style.display="block":topsBaseColorBtnHolderContainer.style.display="none",eo>0?topsBaseColorTwoHolderContainer.style.display="block":topsBaseColorTwoHolderContainer.style.display="none"}else topsNavBtnBase.style.display="none";en.length>0?topsNavBtnMiddle.style.display="flex":topsNavBtnMiddle.style.display="none",zi.length>0?topsNavBtnTop.style.display="flex":topsNavBtnTop.style.display="none";let Le=0,Ot=0,va=0;ls.forEach(oi=>{oi.forEach(Zr=>{Zr.material.name==="m_fullbody_1"&&(Le+=1),Zr.material.name==="m_fullbody_buttons"&&(Ot+=1),Zr.material.name==="m_fullbody_2"&&(va+=1)})}),Le>0?fullBodyColorOneHolderContainer.style.display="block":fullBodyColorOneHolderContainer.style.display="none",Ot>0?fullBodyColorBtnHolderContainer.style.display="block":fullBodyColorBtnHolderContainer.style.display="none",va>0?fullBodyColorTwoHolderContainer.style.display="block":fullBodyColorTwoHolderContainer.style.display="none";for(let oi=0;oi<Xs.length;oi++)Ni[oi][0].name==="shoes_fancy_1_geo"&&(Xs[oi].style.display="flex"),Ni[oi][0].name==="shoes_female_heels_1_geo"&&(Xs[oi].style.display="none");headwearTextureContainer.style.display="block"}}for(let ue=0;ue<Je.length;ue++)Je[ue].addEventListener("click",function(){Ke(ue)});o.materials.forEach(ue=>{ue.name.startsWith("m_skin_female")&&Ui.push(ue)}),P(Ui,"skin-parent","female-skin-parts",0,!1),o.materials.forEach(ue=>{ue.name.startsWith("m_skin_male")&&Zn.push(ue)}),P(Zn,"skin-parent","male-skin-parts",0,!1);let Xe=document.getElementsByClassName("female-skin-parts");u(Xe,"conf-button-act");for(let ue=0;ue<Xe.length;ue++)Xe[ue].addEventListener("click",function(){for(let Le=0;Le<Di.length;Le++)Di[Le][Di[Le].length-1].material=Ui[ue];$t[4].material=Ui[ue]});let Nt=document.getElementsByClassName("male-skin-parts");u(Nt,"conf-button-act");for(let ue=0;ue<Nt.length;ue++)Nt[ue].addEventListener("click",function(){for(let Le=0;Le<Ur.length;Le++)Ur[Le][Ur[Le].length-1].material=Zn[ue];Js[4].material=Zn[ue]});w("female",Nt,Xe),C(Ue,"faces",Di,Ur,!0),P(Di,"face-parent","female-face-parts",0,!1),P(Ur,"face-parent","male-face-parts",0,!1);for(let ue=0;ue<Di.length;ue++)Di[ue][Di[ue].length-1].material=Ui[0];let wi=document.getElementsByClassName("female-face-parts");u(wi,"conf-button-act");for(let ue=0;ue<wi.length;ue++)wi[ue].addEventListener("click",function(){D(Di,ue)});for(let ue=0;ue<Ur.length;ue++)Ur[ue][Ur[ue].length-1].material=Zn[0];let _i=document.getElementsByClassName("male-face-parts");u(_i,"conf-button-act");for(let ue=0;ue<_i.length;ue++)_i[ue].addEventListener("click",function(){D(Ur,ue)});w("female",_i,wi),o.materials.forEach(ue=>{ue.name.startsWith("m_eye")&&Fe.push(ue)}),P(Fe,"eyes-parent","eyes-parts",0,!1);let Pr=document.getElementsByClassName("eyes-parts");u(Pr,"conf-button-act");for(let ue=0;ue<Pr.length;ue++)Pr[ue].addEventListener("click",function(){$t[1].material=$t[3].material=Fe[ue]});C(Ue,"hair",Vr,!1),P(Vr,"hairstyles-parent","hair-parts",0,!0);let Ji=document.getElementsByClassName("hair-parts");Ji[Ji.length-1].innerHTML="Bald",Ji[Ji.length-1].style.background="url(/img/icons/thumbnails/thumbnail_bald.png) center / 90% no-repeat",Ji[Ji.length-1].style.color="transparent",c(Ji,"conf-button-act",0),u(Ji,"conf-button-act");for(let ue=0;ue<Ji.length;ue++)Ji[ue].addEventListener("click",function(){ue==Ji.length-1?Vr.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})}):D(Vr,ue)});C(Ue,"facial_hair",Un,!1),P(Un,"facial-hairstyles-parent","male-facial-hair-parts",Un.length,!0);let yi=document.getElementsByClassName("male-facial-hair-parts");yi[yi.length-1].innerHTML="None",facialhairstyle.style.display="none",u(yi,"conf-button-act");for(let ue=0;ue<yi.length;ue++)yi[ue].addEventListener("click",function(){ue==yi.length-1?Un.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})}):D(Un,ue)});tU(),C(Ue,"base",ti,Ps,!0),P(ti,"tops-base-parent","female-tops-base-parts",0,!0),P(Ps,"tops-base-parent","male-tops-base-parts",0,!0),ti.forEach(ue=>{ar.push(ue)}),Ps.forEach(ue=>{Es.push(ue)});let Ci=document.getElementsByClassName("female-tops-base-parts");ti.length>0&&(Ci[Ci.length-1].innerHTML="None"),Ci[Ci.length-1].classList.remove("conf-button-act"),u(Ci,"conf-button-act");for(let ue=0;ue<Ci.length;ue++)Ci[ue].addEventListener("click",function(){if(_t(),ue==Ci.length-1?_(ar,ti,Ci):D(ti,ue),At[0]){D(Si,0),rn[0].classList.add("conf-button-act"),mi.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})});for(let Le=0;Le<qr.length;Le++)qr[Le].classList.remove("conf-button-act")}At[0]=!1});if(ti.length>0){topsNavBtnBase.style.display="flex";let ue=0,Le=0,Ot=0;ti.forEach(va=>{va.forEach(oi=>{oi.material.name==="m_tops_base_1"&&(ue+=1),oi.material.name==="m_tops_base_buttons_1"&&(Le+=1),oi.material.name==="m_tops_base_2"&&(Ot+=1)})}),ue>0?topsBaseColorOneHolderContainer.style.display="block":topsBaseColorOneHolderContainer.style.display="none",Le>0?topsBaseColorBtnHolderContainer.style.display="block":topsBaseColorBtnHolderContainer.style.display="none",Ot>0?topsBaseColorTwoHolderContainer.style.display="block":topsBaseColorTwoHolderContainer.style.display="none"}else topsNavBtnBase.style.display="none";let Mr=document.getElementsByClassName("male-tops-base-parts");Ps.length>0&&(Mr[Mr.length-1].innerHTML="None"),Mr[Mr.length-1].classList.remove("conf-button-act"),u(Mr,"conf-button-act");for(let ue=0;ue<Mr.length;ue++)Mr[ue].addEventListener("click",function(){if(_t(),ue==Mr.length-1?_(Es,Ps,Mr):D(Ps,ue),At[0]){D(os,0),sn[0].classList.add("conf-button-act"),ls.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})});for(let Le=0;Le<Qr.length;Le++)Qr[Le].classList.remove("conf-button-act")}At[0]=!1});w("female",Mr,Ci),C(Ue,"mid",or,en,!0),P(or,"tops-middle-parent","female-tops-middle-parts",or.length,!0),or.forEach(ue=>{ar.push(ue)});let Os=document.getElementsByClassName("female-tops-middle-parts");or.length>0&&(Os[Os.length-1].innerHTML="None"),u(Os,"conf-button-act");for(let ue=0;ue<Os.length;ue++)Os[ue].addEventListener("click",function(){if(_t(),ue==Os.length-1?_(ar,or,Os):D(or,ue),At[0]){D(Si,0),rn[0].classList.add("conf-button-act"),mi.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})});for(let Le=0;Le<qr.length;Le++)qr[Le].classList.remove("conf-button-act")}At[0]=!1});or.length>0?topsNavBtnMiddle.style.display="flex":topsNavBtnMiddle.style.display="none",P(en,"tops-middle-parent","male-tops-middle-parts",en.length,!0),en.forEach(ue=>{Es.push(ue)});let hs=document.getElementsByClassName("male-tops-middle-parts");en.length>0&&(hs[hs.length-1].innerHTML="None"),u(hs,"conf-button-act");for(let ue=0;ue<hs.length;ue++)hs[ue].addEventListener("click",function(){if(_t(),ue==hs.length-1?_(Es,en,hs):D(en,ue),At[0]){D(os,0),sn[0].classList.add("conf-button-act"),ls.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})});for(let Le=0;Le<Qr.length;Le++)Qr[Le].classList.remove("conf-button-act")}At[0]=!1});w("female",hs,Os),C(Ue,"top",pi,zi,!0),P(pi,"tops-top-parent","female-tops-top-parts",pi.length,!0),pi.forEach(ue=>{ar.push(ue)});let Hs=document.getElementsByClassName("female-tops-top-parts");pi.length>0&&(Hs[Hs.length-1].innerHTML="None"),u(Hs,"conf-button-act");for(let ue=0;ue<Hs.length;ue++)Hs[ue].addEventListener("click",function(){if(_t(),ue==Hs.length-1?_(ar,pi,Hs):D(pi,ue),At[0]){D(Si,0),rn[0].classList.add("conf-button-act"),mi.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})});for(let Le=0;Le<qr.length;Le++)qr[Le].classList.remove("conf-button-act")}At[0]=!1});pi.length>0?topsNavBtnTop.style.display="flex":topsNavBtnTop.style.display="none",P(zi,"tops-top-parent","male-tops-top-parts",zi.length,!0),zi.forEach(ue=>{Es.push(ue)});let Ws=document.getElementsByClassName("male-tops-top-parts");zi.length>0&&(Ws[Ws.length-1].innerHTML="None"),u(Ws,"conf-button-act");for(let ue=0;ue<Ws.length;ue++)Ws[ue].addEventListener("click",function(){if(_t(),ue==Ws.length-1?_(Es,zi,Ws):D(zi,ue),At[0]){D(os,0),sn[0].classList.add("conf-button-act"),ls.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})});for(let Le=0;Le<Qr.length;Le++)Qr[Le].classList.remove("conf-button-act")}At[0]=!1});w("female",Ws,Hs),C(Ue,"bottoms",Si,os,!0),P(Si,"bottoms-parent","female-bottoms-parts",0,!1),P(os,"bottoms-parent","male-bottoms-parts",0,!1);let rn=document.getElementsByClassName("female-bottoms-parts");u(rn,"conf-button-act");for(let ue=0;ue<rn.length;ue++)rn[ue].addEventListener("click",function(){if(D(Si,ue),At[0]){D(ti,0),Ci[0].classList.add("conf-button-act"),mi.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})});for(let Le=0;Le<qr.length;Le++)qr[Le].classList.remove("conf-button-act")}At[0]=!1});let sn=document.getElementsByClassName("male-bottoms-parts");u(sn,"conf-button-act");for(let ue=0;ue<sn.length;ue++)sn[ue].addEventListener("click",function(){if(D(os,ue),At[0]){D(Ps,0),Mr[0].classList.add("conf-button-act"),ls.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})});for(let Le=0;Le<Qr.length;Le++)Qr[Le].classList.remove("conf-button-act")}At[0]=!1});w("female",sn,rn),C(Ue,"full_body",mi,ls,!0),P(mi,"fullbody-parent","female-fullbody-parts",3,!1),P(ls,"fullbody-parent","male-fullbody-parts",0,!1);let qr=document.getElementsByClassName("female-fullbody-parts");if(!At[0])for(let ue=0;ue<qr.length;ue++)qr[ue].classList.remove("conf-button-act");u(qr,"conf-button-act");for(let ue=0;ue<qr.length;ue++)qr[ue].addEventListener("click",function(){At[0]=!0,ar.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})});for(let Le=0;Le<Ci.length;Le++)Ci[Le].classList.remove("conf-button-act");for(let Le=0;Le<Os.length;Le++)Os[Le].classList.remove("conf-button-act");for(let Le=0;Le<Hs.length;Le++)Hs[Le].classList.remove("conf-button-act");Si.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})});for(let Le=0;Le<rn.length;Le++)rn[Le].classList.remove("conf-button-act");D(mi,ue)});let Qr=document.getElementsByClassName("male-fullbody-parts");if(!At[0])for(let ue=0;ue<Qr.length;ue++)Qr[ue].classList.remove("conf-button-act");u(Qr,"conf-button-act");for(let ue=0;ue<Qr.length;ue++)Qr[ue].addEventListener("click",function(){At[0]=!0,Es.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})});for(let Le=0;Le<Mr.length;Le++)Mr[Le].classList.remove("conf-button-act");for(let Le=0;Le<hs.length;Le++)hs[Le].classList.remove("conf-button-act");for(let Le=0;Le<Ws.length;Le++)Ws[Le].classList.remove("conf-button-act");os.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})});for(let Le=0;Le<sn.length;Le++)sn[Le].classList.remove("conf-button-act");D(ls,ue)});w("female",Qr,qr),C(Ue,"shoes",Ni,!1),P(Ni,"shoes-parent","shoes-parts",0,!1);let Xs=document.getElementsByClassName("shoes-parts");u(Xs,"conf-button-act");for(let ue=0;ue<Xs.length;ue++)Ni[ue][0].name==="shoes_fancy_1_geo"&&(Xs[ue].style.display="none"),Ni[ue][0].name==="shoes_female_heels_1_geo"&&(Xs[ue].style.display="flex"),Xs[ue].addEventListener("click",function(){D(Ni,ue)});C(Ue,"hats",Is,Ir,!0),P(Is,"hats-parent","female-hats-parts",Is.length,!0),P(Ir,"hats-parent","male-hats-parts",Ir.length,!0),Is.forEach(ue=>{fr.push(ue)}),Ir.forEach(ue=>{fr.push(ue)});let fn=document.getElementsByClassName("female-hats-parts");fn[fn.length-1].innerHTML="None",u(fn,"conf-button-act");for(let ue=0;ue<fn.length;ue++)fn[ue].addEventListener("click",function(){ue==fn.length-1?Is.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})}):D(Is,ue)});let _n=document.getElementsByClassName("male-hats-parts");_n[_n.length-1].innerHTML="None",u(_n,"conf-button-act");for(let ue=0;ue<_n.length;ue++)_n[ue].addEventListener("click",function(){ue==_n.length-1?Ir.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})}):D(Ir,ue)});w("female",_n,fn),C(Ue,"belts",hn,!1),P(hn,"belts-parent","belts-parts",hn.length,!1);let Da=document.getElementsByClassName("belts-parts");f(Da,"conf-button-act");for(let ue=0;ue<Da.length;ue++)Da[ue].addEventListener("click",function(){S(Da,hn,"conf-button-act",ue)});C(Ue,"glasses",Ms,!1),P(Ms,"glasses-parent","glasses-parts",Ms.length,!0);let ta=document.getElementsByClassName("glasses-parts");ta[ta.length-1].innerHTML="None",u(ta,"conf-button-act");for(let ue=0;ue<ta.length;ue++)ta[ue].addEventListener("click",function(){ue==ta.length-1?Ms.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})}):D(Ms,ue)});C(Ue,"jewelery",Ii,!1),P(Ii,"jewelery-parent","jewelery-parts",Ii.length,!0);let Cn=document.getElementsByClassName("jewelery-parts");Cn[Cn.length-1].innerHTML="None",u(Cn,"conf-button-act");for(let ue=0;ue<Cn.length;ue++)Cn[ue].addEventListener("click",function(){ue==Cn.length-1?Ii.forEach(Le=>{Le.forEach(Ot=>{Ot.isVisible=!1})}):D(Ii,ue)});C(Ue,"accessories",re,!1),P(re,"accessories-parent","accessories-parts",re.length,!1);let Ja=document.getElementsByClassName("accessories-parts");f(Ja,"conf-button-act");for(let ue=0;ue<Ja.length;ue++)Ja[ue].addEventListener("click",function(){S(Ja,re,"conf-button-act",ue)});$t.push(o.getMeshByName("eye_left_geo_primitive0"),o.getMeshByName("eye_left_geo_primitive1"),o.getMeshByName("eye_right_geo_primitive0"),o.getMeshByName("eye_right_geo_primitive1"),o.getMeshByName("female_body_geo"),o.getMeshByName("teeth_low_geo"),o.getMeshByName("teeth_top_geo"),o.getMeshByName("tounge_geo")),cn.push($t,Di[0],Vr[0],ti[0],Si[0],Ni[0]),$t[4].material=Ui[0],Js.push(o.getMeshByName("eye_left_geo_primitive0"),o.getMeshByName("eye_left_geo_primitive1"),o.getMeshByName("eye_right_geo_primitive0"),o.getMeshByName("eye_right_geo_primitive1"),o.getMeshByName("male_body_geo"),o.getMeshByName("teeth_low_geo"),o.getMeshByName("teeth_top_geo"),o.getMeshByName("tounge_geo")),zs.push(Js,Ur[0],Vr[0],Ps[0],os[0],Ni[0]),Js[4].material=Zn[0],cn.forEach(ue=>{ue.forEach(Le=>{Le.isVisible=!0})}),T("facial_idle_1","default"),T("idle_1","default");let Wl=[];$E.forEach(ue=>{Wl.push(ue.name)}),p(Wl,"animations-parent","animations-parts");let Na=document.getElementsByClassName("animations-parts");d(Na,"conf-button-act");for(let ue=0;ue<Na.length;ue++)Na[ue].addEventListener("click",function(){if(!m){let Le=[];if(Ge.forEach(Ot=>{Le.push(Ot.name)}),Le.includes(Na[ue].children[0].innerHTML))for(let Ot=0;Ot<Ge.length;Ot++)Na[ue].children[0].innerHTML===Ge[Ot].name&&L(Ge[Ot].index);else T(Na[ue].children[0].innerHTML,"play")}});for(let ue=1;ue<=5;ue++)b(ue);eU(o,K2,ge,fr,u,c,G,Z,he,ne,Pe,ce,de,se,xe,Ct,Vr,Di,Ur,Un,hn,tn,un,Qu,Pa,Zu,Za,Ju,Ma,ti,Ps,Mh),he.renderAll(),ne.update(!1),he.on("after:render",function(){ne.update(!1)}),Pe.renderAll(),ce.update(!1),Pe.on("after:render",function(){ce.update(!1)}),de.renderAll(),se.update(!1),de.on("after:render",function(){se.update(!1)}),xe.renderAll(),Ct.update(!1),xe.on("after:render",function(){Ct.update(!1)}),Object.values(Mh).forEach(ue=>{ue.setUserPalette([{name:"Color",colors:["#586586","#77D6FF","#88333C","#63503F","#8B6848","#792F36","#A7927F","#332B23","#746252","#191611","#715E53","#555350","#A27A68","#363432","#191919","#D13E3F","#445563","#676E80","#50616E","#CEC29F","#6E9CFA","#50616E","#E2F9FE","#EBCC6F","#9AB2FF","#DF0000","#6E2506","#8E85D3","#BCBCBC","#B23624","#315ED8"]}])}),document.getElementById("generatePropsBtn").click(),o.executeWhenReady(()=>{co.hideLoadingUI(),a(0,1,3),l(0,1,0),co.runRenderLoop(()=>{o.render()})})});let Mt=document.getElementsByClassName("conf-right-part"),ga=document.getElementsByClassName("main-conf-button");Mt[0].style.display="block",u(ga,"main-conf-button-act"),ga[0].style.setProperty("background-color","white","important");for(let ve=0;ve<ga.length;ve++)ga[ve].addEventListener("click",()=>{Ge[De].name!="idle_1"&&Ge.forEach(Ue=>{Ue.name=="idle_1"&&L(Ue.index)})});home.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[0].style.display="block",a(0,1,3),l(0,1,0)},gender.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[1].style.display="block",a(0,1,3),l(0,1,0)},face.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[2].style.display="block",a(0,1.4,1),l(0,1.4,0)},skin.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[3].style.display="block",a(0,1,1.7),l(0,1,0)},eyes.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[4].style.display="block",a(0,1.4,1),l(0,1.4,0)},hairstyle.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[5].style.display="block",a(0,1.4,1),l(0,1.4,0)},facialhairstyle.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[6].style.display="block",a(0,1.4,1),l(0,1.4,0)},tops.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[7].style.display="block",a(0,1,1.6),l(0,1,0),paintCanvasParent.scrollLeft=44,paintCanvasParent.scrollTop=215},bottoms.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[8].style.display="block",a(0,.5,1.6),l(0,.5,0)},fullbody.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[9].style.display="block",a(0,1,3),l(0,1,0),paintCanvasFullBodyParent.scrollLeft=42,paintCanvasFullBodyParent.scrollTop=214},shoes.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[10].style.display="block",a(0,.3,1.6),l(0,.3,0)},hats.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[11].style.display="block",a(0,1.4,1),l(0,1.4,0)},belts.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[12].style.display="block",a(0,.9,1),l(0,.9,0)},glasses.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[13].style.display="block",a(0,1.4,1),l(0,1.4,0)},jewelery.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[14].style.display="block",a(0,1.4,1),l(0,1.4,0)},accessories.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[15].style.display="block",a(0,1,1.6),l(0,1,0)},animations.onclick=()=>{_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";Mt[16].style.display="block",a(0,1,3),l(0,1,0)},save.onclick=()=>{document.getElementById("conf-right").insertAdjacentHTML("beforeend",`    <div id="loadingSpinner" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9999; display: flex; justify-content: center; align-items: center;">
      <div style="border: 4px solid rgba(0, 0, 0, 0.1); width: 50px; height: 50px; border-radius: 50%; border-left-color: #1e57f1; animation: spin 1s linear infinite; @keyframes spin {0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);}}"></div>
    </div>`),_t();for(let ve=0;ve<Mt.length;ve++)Mt[ve].style.display="none";a(0,1,3),l(0,1,0),setTimeout(()=>{t_(),gi(),dn()},1e3)};let Io=document.getElementsByClassName("screenshot-parts");var Jn=new Ei("cameraBodyScreenshot",Math.PI/2,Math.PI/2,3,new x(0,0,0),o);Jn.minZ=.1,Jn.fov=.35,Jn.setPosition(new x(0,1.15,2.5));var ea=new Ei("cameraHeadScreenshot",Math.PI/2,Math.PI/2,3,new x(0,0,0),o);ea.minZ=.1,ea.fov=.35,ea.setPosition(new x(.05,1.4,1.2));function t_(){Ge[De].pause(),Ut[0].setWeightForAllAnimatables(0);let ve=y(0,Ft.length-1);Ft[ve].play(!0),Ft[ve].name==="anim_pose_1"&&(Jn.setPosition(new x(0,1.17,2.8)),Jn.setTarget(new x(0,1.17,0)),ea.setPosition(new x(-.025,1.43,1.3)),ea.setTarget(new x(-.025,1.43,0))),(Ft[ve].name==="anim_pose_2"||Ft[ve].name==="anim_pose_5")&&(Jn.setPosition(new x(0,1.15,2.8)),Jn.setTarget(new x(0,1.15,0)),ea.setPosition(new x(-.025,1.43,1.2)),ea.setTarget(new x(-.025,1.43,0))),(Ft[ve].name==="anim_pose_3"||Ft[ve].name==="anim_pose_4")&&(Jn.setPosition(new x(.05,1.15,2.9)),Jn.setTarget(new x(.05,1.15,0)),ea.setPosition(new x(.05,1.43,1.32)),ea.setTarget(new x(.05,1.43,0))),o.environmentIntensity=.7,t.intensity=1.5,e.intensity=7,o.getMeshByName("BackgroundSkybox").isVisible=!1,o.getMeshByName("BackgroundPlane").isVisible=!1,setTimeout(function(){J.CreateScreenshotUsingRenderTarget(co,Jn,{width:490,height:600,precision:1},function(Ue){i_(Ue)}),J.CreateScreenshotUsingRenderTarget(co,ea,128,function(Ue){r_(Ue)}),o.environmentIntensity=1,t.intensity=0,e.intensity=0,o.getMeshByName("BackgroundSkybox").isVisible=!0,o.getMeshByName("BackgroundPlane").isVisible=!0,Ge[De].play(!0),Ut[0].setWeightForAllAnimatables(1),Ft.forEach(Ue=>{Ue.stop()})},100)}let Sc;function i_(ve){var Ue=document.createElement("canvas"),Je=new Image;Je.src=ve,Je.onload=()=>{Ue.width=Je.naturalWidth,Ue.height=Je.naturalHeight,Ue.getContext("2d").drawImage(Je,0,0)},setTimeout(()=>{Ue.toBlob(function(Ke){Sc=Ke,Ue.remove()})},100)}Io[0].onclick=()=>{let ve;document.getElementById("avatarName").value.length>0?ve=document.getElementById("avatarName").value:ve="Avatar";let Ue=document.createElement("a");Ue.download=ve+".png",Ue.href=URL.createObjectURL(Sc),Ue.click(),URL.revokeObjectURL(Ue.href),Ue.remove()};let Dh;function r_(ve){var Ue=document.createElement("canvas"),Je=new Image;Je.src=ve,Je.onload=()=>{const Ke=Math.min(Je.naturalWidth,Je.naturalHeight);Ue.width=Ke,Ue.height=Ke;const Xe=Ue.getContext("2d");Xe.drawImage(Je,0,0),Xe.globalCompositeOperation="destination-in",Xe.fillStyle="#000",Xe.beginPath(),Xe.arc(Ke*.5,Ke*.5,Ke*.5,0,2*Math.PI),Xe.fill(),Xe.globalCompositeOperation="source-over"},setTimeout(()=>{Ue.toBlob(function(Ke){Dh=Ke,Ue.remove()})},100)}Io[1].onclick=()=>{let ve;document.getElementById("avatarName").value.length>0?ve=document.getElementById("avatarName").value:ve="Avatar";let Ue=document.createElement("a");Ue.download=ve+".png",Ue.href=URL.createObjectURL(Dh),Ue.click(),URL.revokeObjectURL(Ue.href),Ue.remove()};let ed;function gi(){let ve;document.getElementById("avatarName").value.length>0?ve=document.getElementById("avatarName").value:ve="Avatar";let Ue;mt=="female"?Di.forEach(Ze=>{Ze[0].isVisible&&(Ue=Ze[0].name)}):Ur.forEach(Ze=>{Ze[0].isVisible&&(Ue=Ze[0].name)});let Je;mt=="female"?Je=$t[4].material.name:Je=Js[4].material.name;let Ke;Ke=$t[1].material.name;let Xe=!1,Nt="bold",wi=[],_i;for(let Ze=0;Ze<Vr.length;Ze++)Vr[Ze][0].isVisible&&(Nt=Vr[Ze][0].name,Xe=!0,_i=Vr[Ze][0].material.name,Vr[Ze].forEach(Lt=>{Lt.material.albedoColor=Lt.material.albedoColor.toGammaSpace(),wi.push(Lt.material.albedoColor.toHexString()),Lt.material.albedoColor=Lt.material.albedoColor.toLinearSpace()}));let Pr=!1,Ji;Un.forEach(Ze=>{Ze[0].isVisible&&(Pr=!0,Ji=Ze[0].name)});let yi=!1,Ci=[],Mr=[],Os=!1,hs="m_tops_base_1";if(mt=="female"){for(let Ze=0;Ze<ar.length;Ze++)if(ar[Ze][0].isVisible){Ci.push(ar[Ze][0].name),yi=!0;let Lt=[];ar[Ze].forEach(Yi=>{Yi.material.name==="m_tops_base_striped_1"&&(Os=!0,hs="m_tops_base_striped_1"),Yi.material.name==="m_tops_base_striped_2"&&(hs="m_tops_base_striped_2"),Yi.material.name==="m_tops_base_1"?Lt.push(he.backgroundColor):Yi.material.name==="m_tops_mid_1"?Lt.push(xe.backgroundColor):Yi.material.name==="m_tops_top_1"?Lt.push(de.backgroundColor):(Yi.material.albedoColor=Yi.material.albedoColor.toGammaSpace(),Lt.push(Yi.material.albedoColor.toHexString()),Yi.material.albedoColor=Yi.material.albedoColor.toLinearSpace())}),Mr.push(Lt)}}else for(let Ze=0;Ze<Es.length;Ze++)if(Es[Ze][0].isVisible){Ci.push(Es[Ze][0].name),yi=!0;let Lt=[];Es[Ze].forEach(Yi=>{Yi.material.name==="m_tops_base_striped_1"&&(Os=!0,hs="m_tops_base_striped_1"),Yi.material.name==="m_tops_base_striped_2"&&(hs="m_tops_base_striped_2"),Yi.material.name==="m_tops_base_1"?Lt.push(he.backgroundColor):Yi.material.name==="m_tops_mid_1"?Lt.push(xe.backgroundColor):Yi.material.name==="m_tops_top_1"?Lt.push(de.backgroundColor):(Yi.material.albedoColor=Yi.material.albedoColor.toGammaSpace(),Lt.push(Yi.material.albedoColor.toHexString()),Yi.material.albedoColor=Yi.material.albedoColor.toLinearSpace())}),Mr.push(Lt)}let Hs=!1,Ws;if(tn.length>0){Hs=!0;let Ze=tn[0].angle;tn[0].angle=0,Ws={image_URL:tn[0].toDataURL(),image_angle:Ze,image_left:tn[0].left,image_top:tn[0].top},tn[0].angle=Ze}let rn=!1,sn;if(Pa.length>0){rn=!0;let Ze=Pa[0].angle;Pa[0].angle=0,sn={image_URL:Pa[0].toDataURL(),image_angle:Ze,image_left:Pa[0].left,image_top:Pa[0].top},Pa[0].angle=Ze}let qr=!1,Qr;if(Za.length>0){qr=!0;let Ze=Za[0].angle;Za[0].angle=0,Qr={image_URL:Za[0].toDataURL(),image_angle:Ze,image_left:Za[0].left,image_top:Za[0].top},Za[0].angle=Ze}let Xs=!1,fn,_n=[];if(mt=="female")for(let Ze=0;Ze<Si.length;Ze++)Si[Ze][0].isVisible&&(fn=Si[Ze][0].name,Xs=!0,Si[Ze].forEach(Lt=>{Lt.material.albedoColor=Lt.material.albedoColor.toGammaSpace(),_n.push(Lt.material.albedoColor.toHexString()),Lt.material.albedoColor=Lt.material.albedoColor.toLinearSpace()}));else for(let Ze=0;Ze<os.length;Ze++)os[Ze][0].isVisible&&(fn=os[Ze][0].name,Xs=!0,os[Ze].forEach(Lt=>{Lt.material.albedoColor=Lt.material.albedoColor.toGammaSpace(),_n.push(Lt.material.albedoColor.toHexString()),Lt.material.albedoColor=Lt.material.albedoColor.toLinearSpace()}));let Da=!1,ta,Cn=[];if(mt=="female")for(let Ze=0;Ze<mi.length;Ze++)mi[Ze][0].isVisible&&(ta=mi[Ze][0].name,Da=!0,mi[Ze].forEach(Lt=>{Lt.material.name!=="m_fullbody_1"?(Lt.material.albedoColor=Lt.material.albedoColor.toGammaSpace(),Cn.push(Lt.material.albedoColor.toHexString()),Lt.material.albedoColor=Lt.material.albedoColor.toLinearSpace()):Cn.push(Pe.backgroundColor)}));else for(let Ze=0;Ze<ls.length;Ze++)ls[Ze][0].isVisible&&(ta=ls[Ze][0].name,Da=!0,ls[Ze].forEach(Lt=>{Lt.material.name!=="m_fullbody_1"?(Lt.material.albedoColor=Lt.material.albedoColor.toGammaSpace(),Cn.push(Lt.material.albedoColor.toHexString()),Lt.material.albedoColor=Lt.material.albedoColor.toLinearSpace()):Cn.push(Pe.backgroundColor)}));let Ja=!1,Wl;if(Ma.length>0){Ja=!0;let Ze=Ma[0].angle;Ma[0].angle=0,Wl={image_URL:Ma[0].toDataURL(),image_angle:Ze,image_left:Ma[0].left,image_top:Ma[0].top},Ma[0].angle=Ze}let Na;Ni.forEach(Ze=>{Ze[0].isVisible&&(Na=Ze[0].name)});let ue=!1,Le,Ot=[],va;for(let Ze=0;Ze<fr.length;Ze++)fr[Ze][0].isVisible&&(Le=fr[Ze][0].name,ue=!0,fr[Ze][0].name==="male_keffiyeh_geo_primitive0"&&(va=fr[Ze][1].material.name),fr[Ze].forEach(Lt=>{Lt.material.albedoColor=Lt.material.albedoColor.toGammaSpace(),Ot.push(Lt.material.albedoColor.toHexString()),Lt.material.albedoColor=Lt.material.albedoColor.toLinearSpace()}));let oi=!1,Zr=[],eo=[],Mo=[];hn.forEach(Ze=>{Ze[0].material.name!="m_belt_1"?Mo[0]=Ze[0].material.name:Mo[0]=Ze[1].material.name,Ze[0].isVisible&&(Zr.push(Ze[0].name),oi=!0)}),o.getMaterialByName("m_belt_1").albedoColor=o.getMaterialByName("m_belt_1").albedoColor.toGammaSpace(),eo.push(o.getMaterialByName("m_belt_1").albedoColor.toHexString()),o.getMaterialByName("m_belt_1").albedoColor=o.getMaterialByName("m_belt_1").albedoColor.toLinearSpace();let xa=!1,td;Ms.forEach(Ze=>{Ze[0].isVisible&&(td=Ze[0].name,xa=!0)});let id=!1,rd,sd=!1,nd;Ii.forEach(Ze=>{Ze[0].isVisible&&(nd=Ze[0].name,sd=!0)});let Nh=!1,wh=[],ad=[];for(let Ze=0;Ze<re.length;Ze++)if(re[Ze][0].isVisible){wh.push(re[Ze][0].name),Nh=!0;let Lt=[];re[Ze].forEach(Yi=>{Yi.material.albedoColor=Yi.material.albedoColor.toGammaSpace(),Lt.push(Yi.material.albedoColor.toHexString()),Yi.material.albedoColor=Yi.material.albedoColor.toLinearSpace()}),ad.push(Lt)}let Ac=JSON.stringify({name:ve,preset:{gender:mt,face_style_detected:!0,face_style:Ue,skin_color_detected:!0,skin_color_style:Je,eye_color_detected:!0,eye_color:Ke,hair_detected:!0,hair_style_detected:Xe,hair_style:Nt,hair_color_detected:!0,hair_color_hex:wi,hair_texture:_i,facial_hair_detected:Pr,facial_hair_style:Ji,top_detected:yi,top_style:Ci,top_color_detected:!0,tops_color_hex:Mr,top_base_stripe_mat:Os,top_base_mat:hs,tops_base_logo_detected:Hs,tops_base_logo_data:Ws,tops_middle_logo_detected:rn,tops_middle_logo_data:sn,tops_top_logo_detected:qr,tops_top_logo_data:Qr,bottom_detected:Xs,bottom_style:fn,bottom_color_detected:!0,bottom_color_hex:_n,full_body_detected:Da,full_body_style:ta,full_body_color_detected:!0,full_body_color_hex:Cn,full_body_logo_detected:Ja,full_body_logo_data:Wl,shoes_detected:!0,shoes_style:Na,hat_detected:ue,hat_style:Le,hats_color_detected:!0,hats_hex_color:Ot,keffiyeh_texture:va,belt_detected:oi,belt_style:Zr,belt_color_detected:!0,belt_hex_color:eo,belt_metal_material:Mo,glasses_detected:xa,glasses_style:td,sunglasses_detected:id,sunglasses_style:rd,jewelery_detected:sd,jewelery_style:nd,accessories_detected:Nh,accessories:wh,accessories_color_detected:!0,accessories_hex_color:ad,face_shape:"Pear"}});ed=Ac,document.getElementById("savedPropsJson").value=Ac;var od="data:text/json;charset=utf-8,"+encodeURIComponent(Ac),Fh=document.getElementById("saveJsonFile");Fh.setAttribute("href",od),Fh.setAttribute("download",ve+".json")}function Oa(){return ed}function cs(){return Dh}function Po(){return Sc}function yc(){return Cc}document.getElementById("btnSaveToAirtable").onclick=function(){let Ue=JSON.parse(Oa()).name;const Je=async Ke=>{const Xe=new FileReader;return new Promise(Nt=>{Xe.onloadend=()=>Nt(Xe.result),Xe.readAsDataURL(Ke)})};(async()=>{let Ke=await Je(Po());Wx("save",Ue,Ke,async()=>{await _U(Yo,cs(),Po(),yc(),Oa())})})()},document.getElementById("btnUpdateToAirtable").onclick=function(){if(eh!==null){let Ue=JSON.parse(document.getElementById("savedPropsJson").value).name;const Je=async Ke=>{const Xe=new FileReader;return new Promise(Nt=>{Xe.onloadend=()=>Nt(Xe.result),Xe.readAsDataURL(Ke)})};(async()=>{let Ke=await Je(Po());Wx("update",Ue,Ke,async()=>{console.log(eh),await pU(Yo,cs(),Po(),yc(),Oa(),eh)})})()}else qp("error",'If you want to update your avatar, you have to select one from the "Your own custom Avatars:" section first.')};let Cc;function dn(){let ve;document.getElementById("avatarName").value.length>0?ve=document.getElementById("avatarName").value:ve="Avatar";let Ue=[];Ue.push(o.getMeshByName("BackgroundSkybox"),o.getMeshByName("BackgroundPlane"),o.getMeshByName("BackgroundHelper"),o.cameras[0],o.cameras[1],o.cameras[2],o.lights[0],o.lights[1],o.lights[2],o.lights[3]),o.meshes.forEach(Xe=>{Xe.isVisible||Ue.push(Xe)});let Je={shouldExportNode:function(Xe){return Ue.indexOf(Xe)===-1}};Ge.forEach(Xe=>{o.removeAnimationGroup(Xe)}),Ft.forEach(Xe=>{o.removeAnimationGroup(Xe)}),Ut.forEach(Xe=>{o.removeAnimationGroup(Xe)}),o.animationGroups.forEach(Xe=>{o.removeAnimationGroup(Xe)});let Ke=ve+".glb";wB.GLBAsync(o,Ke,Je).then(Xe=>{Cc=Xe.glTFFiles[Ke],Mt[17].style.display="block",setTimeout(()=>{Ge.forEach(wi=>{o.addAnimationGroup(wi)}),Ft.forEach(wi=>{o.addAnimationGroup(wi)}),Ut.forEach(wi=>{o.addAnimationGroup(wi)}),document.getElementById("loadingSpinner").remove()},3e3)})}document.getElementById("downLoadModel").onclick=()=>{let ve;document.getElementById("avatarName").value.length>0?ve=document.getElementById("avatarName").value:ve="Avatar";let Ue=document.createElement("a");Ue.download=ve+".glb",Ue.href=URL.createObjectURL(Cc),Ue.click(),URL.revokeObjectURL(Ue.href),Ue.remove()};var tl=new Ts("pipeline",!0,o,[n,Jn,ea]);return tl.samples=100,tl.sharpenEnabled=!0,tl.imageProcessingEnabled=!0,tl.imageProcessing.contrast=1.65,o};async function TU(){var o=async function(){try{return Xx()}catch{return console.log("the available createEngine function failed. Creating the default engine instead"),Xx()}};if(co=await o(),!co)throw"engine should not be null.";YE=xU()}TU().then(()=>{Dd=YE,co.runRenderLoop(function(){Dd&&Dd.activeCamera&&Dd.render()})});window.addEventListener("resize",function(){co.resize()});const jE=o=>{const e=document.createElement("button");return e.classList.add("conf-button"),o.headImage&&o.headImage.endsWith(".png")?e.style.cssText=`background: url('${o.headImage}'); background-size: 55px; background-repeat: no-repeat; background-position: center;`:e.innerHTML=o.name,e.addEventListener("click",()=>{o.savedAvatarId?(eh=o.savedAvatarId,console.log("savedAvatarId",eh),document.getElementById("avatarName").value=o.name):(document.getElementById("avatarName").value=o.name+" custom",eh=null),document.getElementById("propsJson").value=JSON.stringify(o),document.getElementById("generatePropsBtn").click()}),e};oU().then(o=>{const e=document.getElementById("presetsAirtable");o.forEach(t=>{e.appendChild(jE(t))})});function KE(){uU(Yo).then(o=>{const e=document.getElementById("presetsCustomPlural");o.length>0&&(e.innerHTML=""),o.forEach(t=>{e.appendChild(jE(t))})})}Yo.orgId&&KE();function EU(o){const e=document.querySelector(o),t=document.createElement("span");t.innerHTML="&#x27F3;",t.style.cssText="font-size: inherit; cursor: pointer; margin-left: 10px; display: inline-block;";let i=0;const r=3;t.onclick=()=>{i<r&&(i++,t.style.animation="spin 1s linear infinite",KE(),setTimeout(()=>{i--,i===0&&(t.style.animation="none")},1e3))},e.appendChild(t)}EU("#customAvatarsHeadingPlural");
